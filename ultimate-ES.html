<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1, shrink-to-fit=no" />
  
  <!-- ANTI-CACH√â: Forzar recarga del navegador -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <title>Flashcards MacaLaoshi v2.0</title>
  <!-- Test push to GitHub main - 9 oct 2025 -->
  <!-- Evitar b√∫squeda autom√°tica de favicon -->
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  
  <!-- üé≠ SISTEMA DE HISTORIA - Cargado desde archivo separado -->
  <script>
    // Variables de control para el sistema de historia
    let storySystemLoaded = false;
    let pendingStoryAction = null;
    
    // Funci√≥n temporal que se ejecuta si el sistema a√∫n no est√° cargado
    window.showChapterModal = function() {
      if (storySystemLoaded) {
        // Si ya est√° cargado, ejecutar la funci√≥n real
        return window._actualShowChapterModal();
      } else {
        // Si no est√° cargado, mostrar loading y guardar la acci√≥n
        console.log('üé≠ Sistema de historia cargando... esperando...');
        pendingStoryAction = 'showChapterModal';
        
        // Mostrar modal de carga temporal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'storyLoadingModal';
        loadingModal.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
        loadingModal.style.backdropFilter = 'blur(5px)';
        
        loadingModal.innerHTML = `
          <div class="bg-gradient-to-br from-purple-900 to-indigo-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-purple-400">
            <div class="text-6xl mb-4">üìö</div>
            <h2 class="text-2xl font-bold mb-4 jersey-font-niveles">Cargando Historia...</h2>
            <div class="flex items-center justify-center gap-4">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
              <span class="jersey-font-dropdown">Preparando aventuras...</span>
            </div>
          </div>
        `;
        
        document.body.appendChild(loadingModal);
      }
    };
    
    // Crear un iframe oculto para cargar el sistema de historia
    document.addEventListener('DOMContentLoaded', function() {
      const storyFrame = document.createElement('iframe');
      storyFrame.id = 'storySystemFrame';
      storyFrame.src = 'img/story.html';
      storyFrame.style.cssText = 'position: absolute; width: 0; height: 0; border: none; visibility: hidden;';
      document.body.appendChild(storyFrame);
      
      // Una vez que se carga el iframe, transferir las funciones globales
      storyFrame.onload = function() {
        try {
          const storyWindow = storyFrame.contentWindow;
          
          // Transferir todas las funciones de historia al scope global
          if (storyWindow.storyScenes) window.storyScenes = storyWindow.storyScenes;
          if (storyWindow.showChapterModal) window._actualShowChapterModal = storyWindow.showChapterModal;
          if (storyWindow.startChapter) window.startChapter = storyWindow.startChapter;
          if (storyWindow.showStoryScene) window.showStoryScene = storyWindow.showStoryScene;
          if (storyWindow.renderStoryScene) window.renderStoryScene = storyWindow.renderStoryScene;
          if (storyWindow.processDialoguePlaceholders) window.processDialoguePlaceholders = storyWindow.processDialoguePlaceholders;
          if (storyWindow.startTypewriterEffect) window.startTypewriterEffect = storyWindow.startTypewriterEffect;
          if (storyWindow.nextScene) window.nextScene = storyWindow.nextScene;
          if (storyWindow.showStoryCompletedMessage) window.showStoryCompletedMessage = storyWindow.showStoryCompletedMessage;
          if (storyWindow.closeStoryModal) window.closeStoryModal = storyWindow.closeStoryModal;
          
          // Variables globales
          window.currentStoryData = null;
          window.currentSceneIndex = 0;
          
          // Marcar como cargado
          storySystemLoaded = true;
          
          // Reemplazar la funci√≥n temporal con la real
          window.showChapterModal = window._actualShowChapterModal;
          
          console.log('üé≠ Sistema de Historia cargado exitosamente desde story.html');
          
          // Si hay una acci√≥n pendiente, ejecutarla
          if (pendingStoryAction === 'showChapterModal') {
            // Cerrar modal de loading
            const loadingModal = document.getElementById('storyLoadingModal');
            if (loadingModal) {
              loadingModal.remove();
            }
            
            // Ejecutar la acci√≥n pendiente
            setTimeout(() => {
              window.showChapterModal();
              pendingStoryAction = null;
            }, 100);
          }
          
        } catch (error) {
          console.error('‚ùå Error cargando sistema de historia:', error);
          
          // En caso de error, mostrar mensaje de error
          const loadingModal = document.getElementById('storyLoadingModal');
          if (loadingModal) {
            loadingModal.innerHTML = `
              <div class="bg-gradient-to-br from-red-900 to-purple-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-400">
                <div class="text-6xl mb-4">‚ùå</div>
                <h2 class="text-2xl font-bold mb-4 jersey-font-niveles">Error al Cargar</h2>
                <p class="mb-4 jersey-font-dropdown">No se pudo cargar el sistema de historia.</p>
                <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-2xl font-bold transition-all duration-300 jersey-font-dropdown">
                  Cerrar
                </button>
              </div>
            `;
          }
        }
      };
    });
  </script>
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MacaFlash" />
  <!-- Prevent zoom on iOS -->
  <meta name="format-detection" content="telephone=no" />
  <!-- Prevenir zoom de accesibilidad -->
  <meta name="mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ========== REGLA ELIMINADA - PREVENIR ZOOM ========== */
  </style>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <!-- Google Fonts - Jersey 10 para estilo pixel art -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
  <style>
    /* FONT DISPLAY SWAP PARA JERSEY 10 */
    * {
      font-display: swap;
    }
    
    /* Fallback para Jersey 10 */
    @font-face {
      font-family: 'Jersey 10 Fallback';
      src: local('Jersey 10'), local('Courier New'), monospace;
      font-display: swap;
    }

    /* ========== BARRA DE EXPERIENCIA PIXEL ART ========== */
    .xp-bar-container {
      width: 100%;
      height: 18px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 50%, #020617 100%);
      border: 2px solid #334155;
      border-bottom: 3px solid #0f172a;
      border-right: 3px solid #0f172a;
      border-top: 2px solid #64748b;
      border-left: 2px solid #64748b;
      position: relative;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    .xp-bar-container::before {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      border: 1px solid #475569;
      pointer-events: none;
    }

    .xp-bar-fill {
      height: 100%;
      background: var(--xp-bar-color, #3b82f6);
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-right: 1px solid rgba(0,0,0,0.3);
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    .xp-bar-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40%;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0.1) 100%
      );
      pointer-events: none;
    }

    /* Animaci√≥n de brillo cuando sube XP */
    .xp-bar-fill.xp-gain {
      animation: xpGlow 0.8s ease-out;
    }

    @keyframes xpGlow {
      0% { 
        box-shadow: 0 0 0 rgba(96, 165, 250, 0);
        filter: brightness(1);
      }
      50% { 
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
        filter: brightness(1.3);
      }
      100% { 
        box-shadow: 0 0 0 rgba(96, 165, 250, 0);
        filter: brightness(1);
      }
    }

    /* Responsive para m√≥vil */
    @media (max-width: 640px) {
      .xp-bar-container {
        height: 16px;
      }
    }

    /* ---------- Base / flipping ---------- */
    .flip { transform: rotateY(180deg); }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotateY180 { transform: rotateY(180deg); }
    .perspective { perspective: 1000px; }
    .hidden { display: none; }

    /* ---------- Animaciones de feedback ---------- */
    @keyframes pop {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
      30%  { transform: scale(1.09);box-shadow: 0 0 45px rgba(16,185,129,.55); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-6px); }
      80%     { transform: translateX(6px); }
    }
    .popAnim   { animation: pop   420ms ease-out; }
    .shakeAnim { animation: shake 420ms ease; }

    @keyframes pulseGlow {
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
      50%  { box-shadow: 0 0 24px 8px var(--glow); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    .pulseBadge { animation: pulseGlow 700ms ease-out; }
    .pulseGreen { --glow: rgba(16,185,129,.85); } /* known */
    .pulseAmber { --glow: rgba(245,158,11,.85); } /* revise1 */
    .pulseTeal  { --glow: rgba(20,184,166,.85); } /* revise2 */

    /* ---------- Estado de opciones en QUIZ ---------- */
    .optCorrect {
      background-color: #059669 !important;
      color: #fff !important;
      box-shadow: 0 0 26px rgba(16,185,129,.75) !important;
      transform: scale(1.02);
    }
    .optWrong {
      background-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(220,38,38,.7) !important;
    }

    /* ---------- Tema ‚ÄúDesaf√≠o‚Äù ---------- */
    .challenge-stat { background-color: #6d28d9 !important; } /* morado vivo */

    /* --- Fondo con video para desaf√≠os --- */
    .challenge-bg {
      margin: 0 0 15rem 0;
      position: relative;
      /* Mantener el fondo din√°mico y agregar overlay morado sutil */
    }

    .challenge-bg::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(76, 29, 149, 0.2), rgba(109, 40, 217, 0.1));
      z-index: -1;
      pointer-events: none;
    }

    .challenge-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.8;
      pointer-events: none;
    }

    .challenge-video-bg {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      z-index: -1 !important;
      opacity: 1 !important;
      pointer-events: none !important;
    }

    /* Preloader (pantalla de carga de videos) */
    #videoPreloader {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.85);
    }

    .preloader-overlay {
      text-align: center;
      color: white;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .preloader-content {
      max-width: 400px;
      width: 90%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .preloader-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    .preloader-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-family: 'Jersey 10', monospace;
      text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.8);
      letter-spacing: 2px;
    }

    .preloader-text {
      font-size: 1.2rem;
      opacity: 0.8;
      margin-bottom: 1.5rem;
      font-family: 'Jersey 10', monospace;
      letter-spacing: 1px;
    }

    .preloader-progress {
      width: 100%;
      max-width: 350px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin: 0 auto;
    }

    .preloader-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }

    /* Estilos para cuenta regresiva */
    .countdown-content {
      text-align: center;
      color: white;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .countdown-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      font-family: 'Jersey 10', monospace;
      color: #4ade80;
      text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.8);
      letter-spacing: 3px;
    }

    .countdown-number {
      font-size: 8rem;
      font-weight: bold;
      font-family: 'Jersey 10', monospace;
      color: #ffffff;
      margin: 1rem auto;
      text-shadow: 0 0 20px rgba(74, 222, 128, 0.8), 4px 4px 0px rgba(0, 0, 0, 0.8);
      animation: countdownPulse 1s ease-in-out;
      letter-spacing: 4px;
      text-align: center;
      display: block;
      width: 100%;
      line-height: 1;
    }

    .countdown-text {
      font-size: 1.4rem;
      opacity: 0.9;
      margin-top: 1rem;
      font-family: 'Jersey 10', monospace;
      letter-spacing: 2px;
    }

    @keyframes countdownPulse {
      0% { 
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    /* --- Fondo espec√≠fico para desaf√≠os del hor√≥scopo - DESHABILITADO PARA PRUEBA --- */
    .horoscope-bg {
      margin: 0 0 15rem 0;
      background-color: #fff5d1 !important; /* Alabaster como fondo principal */
      /* ANIMACIONES DE FONDO COMENTADAS PARA PRUEBA DE RENDIMIENTO
      background-image:
        radial-gradient(transparent 1.2em, #fff5d1 0.6em),
        conic-gradient(at 2em 2em, transparent 270deg, #f5cc5c7e 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #242423c1 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #564212a1 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #f5cc5ce7 270deg) !important;
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em !important;
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear !important;
      */
    }

    /* Horizontal */
    @keyframes bpx {
      0%, 7.5%, 100% { background-position-x: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-x: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-x: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-x: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-x: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-x: 0, -6em, 0, 6em, 12em; }
    }

    /* Vertical */
    @keyframes bpy {
      0%, 7.5%, 100% { background-position-y: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-y: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-y: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-y: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-y: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-y: 0, -6em, 0, 6em, 12em; }
    }

    /* --- Fondo din√°mico N2 - Rojo - DESHABILITADO PARA PRUEBA --- */
    .challenge-n2-bg {
      margin: 0 0 5rem 0;
      background-color: #711515;
      /* ANIMACIONES DE FONDO COMENTADAS PARA PRUEBA DE RENDIMIENTO
      background-image:
        radial-gradient(transparent 1.2em, #991b1b 0.6em),
        conic-gradient(at 2em 2em, transparent 270deg, #c62e2ea5 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #640e0e95 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #9c2525a0 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #600d0d3e 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em;
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
      */
    }

    /* --- Fondo din√°mico N3 - Verde - DESHABILITADO PARA PRUEBA --- */
    .challenge-n3-bg {
      margin: 0 0 5rem 0;
      background-color: #3fb66e;
      /* ANIMACIONES DE FONDO COMENTADAS PARA PRUEBA DE RENDIMIENTO
      background-image:
        radial-gradient(transparent 1.2em, #166534 0.6em),
        conic-gradient(at 2em 2em, transparent 270deg, #21b05683 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #17a94d87 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #1f9d4d6c 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #207f4363 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em;
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
      */
    }

    /* --- Animaci√≥n para tarjeta incorrecta --- */
.cardWrong {
  box-shadow: 0 0 0 9999px rgba(220,38,38,0.3) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}
.cardWrongFade {
  box-shadow: 0 0 0 0 rgba(220,38,38,0) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}

/* --- Fade out para casillas correctas e incorrectas --- */
.optCorrectFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #05966933 !important;
  box-shadow: 0 0 0 rgba(16,185,129,0) !important;
}
.optWrongFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #dc262633 !important;
  box-shadow: 0 0 0 rgba(220,38,38,0) !important;
}

/* Transici√≥n flip hacia arriba entre tarjetas */
.card-flip-up-out {
  transform: rotateX(90deg);
  opacity: 0;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}
.card-flip-up-in {
  transform: rotateX(-90deg);
  opacity: 0;
}
.card-flip-up-in.card-flip-animate {
  transform: rotateX(0deg);
  opacity: 1;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}

/* Flip vertical transici√≥n entre tarjetas (cambio de contenido en el medio) */
.card-flip-vert {
  transition: transform 0.44s cubic-bezier(.4,0,.2,1);
  transform-style: preserve-3d;
}
.card-flip-vert.flipping {
  transform: rotateX(90deg);
}
.card-flip-vert.flipped {
  transform: rotateX(0deg);
}

  
    /* Animaci√≥n de glow dorado intensificado para tarjetas premium */
    /* @keyframes goldGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
    .premium-gold {
      background: linear-gradient(155deg, #e7d173 0%, #d4be5e 25%, #dec557 50%, #d4be5e 75%, #e7d173 100%) !important;
      border: 2px solid #f3d54f !important;
      box-shadow: 0 0 8px 2px hsla(51, 87%, 56%, 0.816), 0 0 0 2px #fffbe6; /* Estado base con glow sutil */
      animation: goldGlow 2.5s ease-in-out forwards;
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }
    @keyframes goldGlow {
      0%   { box-shadow: 0 0 8px 2px #ffd70099; }
      50%  { box-shadow: 0 0 16px 4px #f6dc4dcc; }
      70%  { box-shadow: 0 0 10px 3px #ffd70088; }
      85%  { box-shadow: 0 0 5px 1px #ffd70066; }
      100% { box-shadow: 0 0 2px 0.5px #ffd70044; }
    }

    /* Tarjeta m√≠tica violeta para desaf√≠os */
    @keyframes mythicGlow {
      0%   { box-shadow: 0 0 8px 2px #a78bfa99; }
      50%  { box-shadow: 0 0 16px 4px #a78bface; }
      70%  { box-shadow: 0 0 10px 3px #a78bfa88; }
      85%  { box-shadow: 0 0 5px 1px #a78bfa66; }
      100% { box-shadow: 0 0 2px 0.5px #a78bfa44; }
    }
    .mythic-violet {
      background: linear-gradient(145deg, #a99af5 0%, #7356cc 100%) !important;
      border: 2px solid #a78bfa !important;
      box-shadow: 0 0 8px 2px #a78bfa44, 0 0 0 2px #ede9fe; /* Estado base con glow sutil */
      animation: mythicGlow 2.2s ease-in-out forwards;
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }

    /* Tarjeta legendaria roja para desaf√≠o */
    @keyframes legendaryGlow {
      0%   { box-shadow: 0 0 8px 2px #f8717199; }
      50%  { box-shadow: 0 0 16px 4px #f87171cc; }
      70%  { box-shadow: 0 0 10px 3px #f8717188; }
      85%  { box-shadow: 0 0 5px 1px #f8717166; }
      100% { box-shadow: 0 0 2px 0.5px #f8717144; }
    }
    .legendary-red {
      background: linear-gradient(135deg, #f57f7f 0%, #fb4646 100%) !important;
      border: 4px solid #f87171 !important;
      box-shadow: 0 0 8px 2px #f8717144, 0 0 0 2px #fee2e2; /* Estado base con glow sutil */
      animation: legendaryGlow 2.2s ease-in-out forwards;
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }

    /* Clases para pausar animaciones especiales y aplicar glow verde cuando es correcto */
    .premium-gold.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .mythic-violet.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .legendary-red.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    /* üè∑Ô∏è Etiquetas de esquina para tarjetas especiales */
    .card-corner-label {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      border-radius: 6px;
      font-family: 'Jersey 10', monospace;
      font-size: 25px;
      font-weight: bold;
      text-align: center;
      z-index: 10;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      line-height: 1.2;
      max-width: 100px;
      word-wrap: break-word;
    }
    
    .card-corner-label.gold {
      background: linear-gradient(135deg, #ffeb93, #efbb37);
      color: #ffffff;
      border: 1px solid #ffd182;
    }
    
    .card-corner-label.violet {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: #ffffff;
      border: 1px solid #a78bfa;
    }
    
    .card-corner-label.red {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
      border: 1px solid #f87171;
    }
    
    /* ========== SECCI√ìN ELIMINADA - CSS FORZADO PARA M√ìVIL ========== */
    
    /* --- Mejoras para m√≥vil --- */
    @media (max-width: 640px) {
      .flip-card { min-height: 220px; }
      .text-6xl { font-size: 2.5rem !important; }
      .text-2xl { font-size: 1.3rem !important; }
      
      /* Botones m√°s grandes para m√≥vil - TAMA√ëOS FIJOS */
      #flashRow button, #quizRow button {
        min-height: 44px !important;
        font-size: 0.9rem !important;
        -webkit-text-size-adjust: none !important;
      }
      
      /* Header buttons responsive - TAMA√ëOS FIJOS */
      header .grid button {
        min-height: 44px !important;
        padding: 10px 14px !important;
        font-size: 0.8rem !important;
        -webkit-text-size-adjust: none !important;
      }
      
      /* XP Bar responsive */
      #xpBarWrap .flex {
        flex-wrap: wrap;
      }
      
      #xpToNext {
        word-break: break-word;
      }
      
      /* Evitar zoom en inputs */
      input, select, textarea {
        font-size: 16px !important;
      }
      
      /* √Årea de toque m√°s grande */
      .touch-target {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Dropdown menus responsive */
      .absolute.min-w-\[180px\] {
        min-width: 160px;
        left: 0;
        right: 0;
        margin: 0 auto;
      }
      
      /* ========== TEXTO DE DI√ÅLOGO HISTORIA - M√ìVIL M√ÅS GRANDE ========== */
      /* Sobrescribir tama√±o del texto de di√°logo en story modal para m√≥vil */
      #storyModal iframe, 
      #storyModal #dialogueText,
      iframe #dialogueText,
      iframe .story-dialogue-text {
        font-size: 1.3rem !important; /* 24px - 20% m√°s grande que text-xl (20px) */
        line-height: 1 !important;
      }
      
      /* Sobrescribir tambi√©n el nombre del speaker */
      #storyModal .speaker-name,
      iframe .speaker-name,
      iframe .text-lg {
        font-size: 1.25rem !important; /* 20px */
      }
    }
    
    /* Animaciones m√°s suaves en m√≥vil */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* FIX: Estados de botones en m√≥vil - contraste consistente */
    button:focus,
    button:active,
    button:focus-visible {
      outline: none !important;
    }
    
    /* ========== BOTONES CON EFECTOS 3D Y BORDES ========== */
    
    /* Botones nivel - con bordes 3D oscuros y colores espec√≠ficos */
    #btnNivel1 {
      background-color: #ffc853 !important;
      color: #000000 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }
    #btnNivel2 {
      background-color: #ffc853 !important;
      color: #000000 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }
    #btnNivel3 {
      background-color: #ffc853 !important;
      color: #000000 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }
    #btnNivel1:hover, #btnNivel2:hover, #btnNivel3:hover {
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Botones Conocidas, A repasar, Confirmar - Naranja #fc9766 */
    #btnKnown, #btnRevise1, #btnRevise2 {
      background-color: #fc9766 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #1f2937 !important; /* texto oscuro para mejor contraste */
      /* NO SOBREESCRIBIR font-size ni font-family - dejar que jersey-font-acciones funcione */
    }
    #btnKnown:hover, #btnRevise1:hover, #btnRevise2:hover,
    #btnKnown:focus, #btnRevise1:focus, #btnRevise2:focus,
    #btnKnown:active, #btnRevise1:active, #btnRevise2:active {
      background-color: #e7855a !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }

    /* Tama√±o de fuente espec√≠fico para m√≥vil en botones de acci√≥n */
    @media (max-width: 768px) {
      #btnKnown, #btnRevise1, #btnRevise2 {
        font-size: 16px !important; /* M√°s grande en m√≥vil */
      }
    }
    
    /* Botones Quiz Pinyin, Quiz Trad, Quiz Hanzi - Violeta claro #c8a8e9 */
    #btnQuizPinyin, #btnQuizMeaning, #btnQuizHanzi {
      background-color: #c8a8e9 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #1f2937 !important; /* texto oscuro para mejor contraste */
    }
    #btnQuizPinyin:hover, #btnQuizMeaning:hover, #btnQuizHanzi:hover,
    #btnQuizPinyin:focus, #btnQuizMeaning:focus, #btnQuizHanzi:focus,
    #btnQuizPinyin:active, #btnQuizMeaning:active, #btnQuizHanzi:active {
      background-color: #b794e3 !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n de Desaf√≠os del Hor√≥scopo - Morado como desaf√≠o */
    #btnDesafiosHoroscopo {
      background-color: #7c3aed !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #ffffff !important;
    }
    #btnDesafiosHoroscopo:hover, #btnDesafiosHoroscopo:focus, #btnDesafiosHoroscopo:active {
      background-color: #6d28d9 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Botones de los 12 desaf√≠os de animales del hor√≥scopo - Morado como desaf√≠o */
    #btnDesafioRata, #btnDesafioGallo, #btnDesafioConejo, #btnDesafioCerdo, #btnDesafioPerro, #btnDesafioCaballo,
    #btnDesafioBuey, #btnDesafioCabra, #btnDesafioSerpiente, #btnDesafioMono, #btnDesafioTigre, #btnDesafioDragon {
      background-color: #7c3aed !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #ffffff !important;
      line-height: 1.2 !important;
    }
    #btnDesafioRata:hover, #btnDesafioGallo:hover, #btnDesafioConejo:hover, #btnDesafioCerdo:hover, #btnDesafioPerro:hover, #btnDesafioCaballo:hover,
    #btnDesafioBuey:hover, #btnDesafioCabra:hover, #btnDesafioSerpiente:hover, #btnDesafioMono:hover, #btnDesafioTigre:hover, #btnDesafioDragon:hover {
      background-color: #6d28d9 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n del hor√≥scopo - Amarillo #ffc853 */
    #btnHoroscopo {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #000000 !important;
    }
    #btnHoroscopo:hover, #btnHoroscopo:focus, #btnHoroscopo:active {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Botones del hor√≥scopo bloqueados */
    #btnHoroscopo.locked, #btnDesafiosHoroscopo.locked {
      background: linear-gradient(135deg, #666666, #555555) !important;
      color: #999999 !important;
      border: 2px solid #555555 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      cursor: not-allowed !important;
      opacity: 0.7 !important;
    }
    
    #btnHoroscopo.locked:hover, #btnDesafiosHoroscopo.locked:hover {
      transform: none !important;
      background: linear-gradient(135deg, #666666, #555555) !important;
    }
    
    /* Botones de los 12 animales del hor√≥scopo - Amarillo #ffc853 */
    #btnRata, #btnGallo, #btnConejo, #btnCerdo, #btnPerro, #btnCaballo,
    #btnBuey, #btnCabra, #btnSerpiente, #btnMono, #btnTigre, #btnDragon {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #000000 !important;
      line-height: 1.2 !important;
    }
    #btnRata:hover, #btnGallo:hover, #btnConejo:hover, #btnCerdo:hover, #btnPerro:hover, #btnCaballo:hover,
    #btnBuey:hover, #btnCabra:hover, #btnSerpiente:hover, #btnMono:hover, #btnTigre:hover, #btnDragon:hover {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    #btnQuizPinyin:hover, #btnQuizMeaning:hover, #btnQuizHanzi:hover,
    #btnQuizPinyin:focus, #btnQuizMeaning:focus, #btnQuizHanzi:focus,
    #btnQuizPinyin:active, #btnQuizMeaning:active, #btnQuizHanzi:active {
      background-color: #b695df !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n Desaf√≠o - con bordes 3D oscuros */
    #btnChallenge {
      background-color: #a21caf !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 18px !important;
      font-family: 'Jersey 10', monospace !important;
      height: 50px !important;

    }
    #btnChallenge:hover, #btnChallenge:focus, #btnChallenge:active {
      background-color: #86198f !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n Tabla Conocidas - amarillo #ffc853 con bordes uniformes */
    #btnKnownTable {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 18px !important;
      font-family: 'Jersey 10', monospace !important;
      height: 50px !important;
      width: auto !important;
      max-width: none !important;
      overflow: hidden !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-sizing: border-box !important;
    }
    #btnKnownTable:hover {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Prevenir efectos webkit en m√≥vil */
    button {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ===== SOLUCI√ìN DEFINITIVA PARA EL PROBLEMA DE FOCUS EN M√ìVIL ===== */
    @media (max-width: 768px) {
      /* Eliminar TODOS los estados de focus/active en botones de quiz */
      #quizOpt button:focus,
      #quizOpt button:active,
      #quizOpt button:focus-visible,
      button.quiz-button:focus,
      button.quiz-button:active,
      button.quiz-button:focus-visible {
        background: inherit !important;
        opacity: 1 !important;
        outline: none !important;
        -webkit-tap-highlight-color: transparent !important;
        box-shadow: none !important;
        border-color: inherit !important;
      }
      
      /* Forzar estilos espec√≠ficos para cada tipo de bot√≥n */
      button.bg-blue-600\/80:focus,
      button.bg-blue-600\/80:active { 
        background: rgb(37 99 235 / 0.8) !important; 
      }
      
      button.bg-red-600\/80:focus,
      button.bg-red-600\/80:active { 
        background: rgb(220 38 38 / 0.8) !important; 
      }
      
      button.bg-yellow-600\/80:focus,
      button.bg-yellow-600\/80:active { 
        background: rgb(202 138 4 / 0.8) !important; 
      }
      
      button.bg-purple-600\/80:focus,
      button.bg-purple-600\/80:active { 
        background: rgb(147 51 234 / 0.8) !important; 
      }
      
      /* Eliminar cualquier estado residual */
      * {
        -webkit-tap-highlight-color: transparent !important;
      }

      /* Estilos para modal del hor√≥scopo */
      .horoscope-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .horoscope-modal {
        background: linear-gradient(145deg, #fbdd35, #ffc515);
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 3px solid #FFB300;
        animation: modalAppear 0.3s ease-out;
      }

      @keyframes modalAppear {
        from { opacity: 0; transform: scale(0.7) translateY(-50px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
      }

      .horoscope-modal-header h2 {
        color: #8B4513;
        margin: 0 0 20px 0;
        font-size: 24px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .horoscope-modal-content {
        text-align: center;
        margin-bottom: 25px;
      }

      .horoscope-animal-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: 15px;
        border-radius: 0;
        border: none;
        box-shadow: none;
        display: block;
        max-width: 100%;
      }

      /* Fuente Jersey 10 para botones principales */
      .jersey-font-buttons {
        font-family: 'Jersey 10', monospace !important;
        font-size: 14px; /* TAMA√ëO BASE - MODIFICA AQU√ç */
      }

      /* Tama√±os espec√≠ficos para diferentes tipos de botones */
      .jersey-font-niveles,
      button.jersey-font-niveles,
      #btnNivel1.jersey-font-niveles,
      #btnNivel2.jersey-font-niveles,
      #btnNivel3.jersey-font-niveles {
        font-family: 'Jersey 10', monospace !important;
        font-size: 24px !important; /* TAMA√ëO NIVELES - MODIFICA AQU√ç */
      }

      .jersey-font-acciones {
        font-family: 'Jersey 10', monospace !important;
        font-size: 24px !important; /* TAMA√ëO ACCIONES (Conocidas, A repasar, etc.) - MODIFICA AQU√ç */
      }

      .jersey-font-horoscopo {
        font-family: 'Jersey 10', monospace !important;
        font-size: 16px !important; /* TAMA√ëO HOR√ìSCOPO - MODIFICA AQU√ç */
      }

      .jersey-font-leaderboard {
        font-family: 'Jersey 10', monospace !important;
        font-size: 14px !important; /* TAMA√ëO LEADERBOARD - MODIFICA AQU√ç */
      }

      .jersey-font-dropdown {
        font-family: 'Jersey 10', monospace !important;
        font-size: 18px !important; /* TAMA√ëO DROPDOWN - MODIFICA AQU√ç */
      }

      /* Fuentes Jersey 10 para Mi Colecci√≥n */
      .jersey-font-coleccion-buttons {
        font-family: 'Jersey 10', monospace !important;
        font-size: 16px !important; /* TAMA√ëO BOTONES MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      .jersey-font-coleccion-filters {
        font-family: 'Jersey 10', monospace !important;
        font-size: 15px !important; /* TAMA√ëO FILTROS MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      .jersey-font-coleccion-title {
        font-family: 'Jersey 10', monospace !important;
        font-size: 20px !important; /* TAMA√ëO T√çTULO MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      .jersey-font-coleccion-counter {
        font-family: 'Jersey 10', monospace !important;
        font-size: 16px !important; /* TAMA√ëO CONTADOR MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      .jersey-font-coleccion-cards {
        font-family: 'Jersey 10', monospace !important;
        font-size: 15px !important; /* TAMA√ëO TARJETAS MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      /* SUPER OVERRIDE - Fuerza Jersey 10 en TODOS los dispositivos */
      button.jersey-font-niveles,
      button.jersey-font-acciones,
      button.jersey-font-horoscopo,
      button.jersey-font-dropdown,
      button.jersey-font-coleccion-buttons,
      button.jersey-font-coleccion-filters,
      .jersey-font-niveles,
      .jersey-font-acciones,
      .jersey-font-horoscopo,
      .jersey-font-dropdown,
      .jersey-font-coleccion-buttons,
      .jersey-font-coleccion-filters,
      .jersey-font-coleccion-title,
      .jersey-font-coleccion-counter,
      .jersey-font-coleccion-cards,
      #btnNivel1,
      #btnNivel2, 
      #btnNivel3,
      #btnAchievements,
      #btnDonation,
      #btnHoroscopo,
      #btnKnownTable,
      #btnShowHanzi,
      #btnShowPinyin,
      #btnShowMeaning,
      #btnCatAll,
      #btnCatS,
      #btnCatA,
      #btnCatV,
      #btnCatP,
      #btnCatE {
        font-family: 'Jersey 10', monospace !important;
        font-weight: normal !important;
      }

      /* Fuerza tama√±os espec√≠ficos para desktop */
      @media (min-width: 640px) {
        button.jersey-font-niveles,
        .jersey-font-niveles,
        #btnNivel1,
        #btnNivel2,
        #btnNivel3 {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-niveles */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-acciones,
        .jersey-font-acciones,
        #btnAchievements,
        #btnDonation {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-acciones */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-dropdown,
        .jersey-font-dropdown {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-dropdown */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-horoscopo,
        .jersey-font-horoscopo,
        #btnHoroscopo {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-horoscopo */
          font-family: 'Jersey 10', monospace !important;
        }
      }

      /* Responsive para badges de hor√≥scopo en m√≥vil */
      @media (max-width: 768px) {
        .horoscope-animal-image {
          width: 175px; /* 135px + 30% */
          height: 175px;
          border-radius: 0;
          border: none;
          box-shadow: none;
          margin-top: 7px;
        }
        
        /* Fuente dropdown en m√≥vil */
        button.jersey-font-dropdown,
        .jersey-font-dropdown,
        button.jersey-font-horoscopo,
        .jersey-font-horoscopo,
        button.jersey-font-acciones,
        .jersey-font-acciones,
        #btnHoroscopo,
        #btnDesafiosHoroscopo,
        #btnDesafioMenos,
        #btnDesafioMas,
        #btnDesafioClassico,
        /* Botones Todo N1, N2, N3 */
        #btnTodoN1,
        #btnTodoN2,
        #btnTodoN3,
        /* Botones Unidades Nivel 1 */
        #btnUnit2,
        #btnUnit3,
        #btnUnit4,
        #btnUnit5,
        #btnUnit6,
        #btnUnit7,
        #btnUnit8,
        #btnUnit9,
        /* Botones Unidades Nivel 2 */
        #btnUnit1N2,
        #btnUnit2N2,
        #btnUnit3N2,
        #btnUnit4N2,
        #btnUnit5N2,
        #btnUnit6N2,
        #btnUnit7N2,
        #btnUnit8N2,
        #btnUnit9N2,
        /* Botones Unidades Nivel 3 */
        #btnUnit1N3,
        #btnUnit2N3,
        #btnUnit3N3,
        #btnUnit4N3,
        #btnUnit5N3,
        #btnUnit6N3,
        #btnUnit7N3,
        #btnUnit8N3,
        #btnUnit9N3,
        /* Botones Desaf√≠o N1, N2, N3 */
        #btnDesafioN1,
        #btnDesafioN2,
        #btnDesafioN3,
        /* Botones espec√≠ficos de desaf√≠os hor√≥scopo con estilos inline */
        #btnDesafioRata,
        #btnDesafioGallo,
        #btnDesafioConejo,
        #btnDesafioCerdo,
        #btnDesafioPerro,
        #btnDesafioCaballo,
        #btnDesafioBuey,
        #btnDesafioCabra,
        #btnDesafioSerpiente,
        #btnDesafioMono,
        #btnDesafioTigre,
        #btnDesafioDragon,
        #btnDesafioFinal,
        /* Botones espec√≠ficos de los 12 animales hor√≥scopo */
        #btnRata,
        #btnGallo,
        #btnConejo,
        #btnCerdo,
        #btnPerro,
        #btnCaballo,
        #btnBuey,
        #btnCabra,
        #btnSerpiente,
        #btnMono,
        #btnTigre,
        #btnDragon {
          font-size: 16px !important;
        }
      }

      @media (max-width: 480px) {
        .horoscope-animal-image {
          width: 150px; /* 115px + 30% */
          height: 150px;
          border-radius: 0;
          border: none;
          box-shadow: none;
          margin-top: 8px;
        }
      }

      /* Ajustar tarjetas de animales del hor√≥scopo en m√≥vil - 30% m√°s grande */
      @media (max-width: 768px) {
        .card-mythic-animal .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 8px;
        }
        
        .card-mythic-animal .card-hanzi img {
          width: 175px !important; /* 135px + 30% */
          height: 175px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      @media (max-width: 480px) {
        .card-mythic-animal .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 6px;
        }
        
        .card-mythic-animal .card-hanzi img {
          width: 150px !important; /* 115px + 30% */
          height: 150px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      /* Ajustar maestro del hor√≥scopo en m√≥vil - 50% m√°s grande */
      @media (max-width: 768px) {
        .card-ultra-master .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 8px;
        }
        
        .card-ultra-master .card-hanzi img {
          width: 202px !important; /* 135px + 50% */
          height: 202px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      @media (max-width: 480px) {
        .card-ultra-master .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 6px;
        }
        
        .card-ultra-master .card-hanzi img {
          width: 172px !important; /* 115px + 50% */
          height: 172px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      .horoscope-message p {
        margin: 10px 0;
        color: #8B4513;
        font-size: 16px;
        font-weight: 600;
      }

      .progress-count {
        color: #D2691E;
        font-weight: bold;
        font-size: 18px;
      }

      .horoscope-modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .modal-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .cancel-btn {
        background: #DC3545;
        color: white;
      }

      .cancel-btn:hover {
        background: #C82333;
        transform: translateY(-2px);
      }

      .start-btn {
        background: linear-gradient(135deg, #28A745, #20C997);
        color: white;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .start-btn:hover {
        background: linear-gradient(135deg, #218838, #1E7E34);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
      }
    }
    
    /* ---------- Notificaciones de Castigo Hor√≥scopo - Estilo Pixel Art ---------- */
    .horoscope-penalty-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 20px;
      border-radius: 15px;
      border: 3px solid #ff6b6b;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
      max-width: 350px;
      font-family: 'Jersey 10', monospace;
      font-size: 16px;
      font-weight: bold;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s ease;
    }
    
    .horoscope-penalty-notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .horoscope-penalty-notification.fadeout {
      opacity: 0;
      transform: translateX(100%);
    }
    
    .penalty-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #ff6b6b;
      font-size: 20px;
      font-family: 'Jersey 10', monospace;
      text-shadow: 2px 2px 0px #8b0000;
      border-bottom: 2px solid #ff6b6b;
      padding-bottom: 10px;
    }
    
    .penalty-character {
      background: rgba(255, 107, 107, 0.1);
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 10px;
      border: 2px solid #ff6b6b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Jersey 10', monospace;
    }
    
    .penalty-hanzi {
      font-size: 20px;
      font-weight: bold;
      color: #FFD700;
      font-family: 'Jersey 10', monospace;
      text-shadow: 1px 1px 0px #b8860b;
    }
    
    .penalty-meaning {
      font-size: 14px;
      color: #ffffff;
      font-family: 'Jersey 10', monospace;
      margin-top: 4px;
    }
    
    .penalty-streak {
      font-size: 12px;
      background: rgba(255, 107, 107, 0.3);
      padding: 4px 8px;
      border-radius: 6px;
      color: #FFD700;
      font-family: 'Jersey 10', monospace;
      border: 1px solid #ff6b6b;
    }
    
    /* ---------- Notificaci√≥n de Desaf√≠o Bloqueado - Estilo Pixel Art ---------- */
    .challenge-blocked-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 25px;
      border-radius: 15px;
      border: 3px solid #ffa500;
      box-shadow: 0 10px 30px rgba(255, 165, 0, 0.4);
      max-width: 400px;
      width: 90%;
      font-family: 'Jersey 10', monospace;
      text-align: center;
      z-index: 99999;
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
      transition: all 0.3s ease-out;
    }
    
    .challenge-blocked-notification.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .challenge-blocked-notification .blocked-header {
      color: #ffa500;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 2px 2px 0px #cc8400;
      border-bottom: 2px solid #ffa500;
      padding-bottom: 10px;
    }
    
    .challenge-blocked-notification .blocked-content {
      background: rgba(255, 165, 0, 0.1);
      border: 2px solid #ffa500;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .challenge-blocked-notification .blocked-stats {
      background: rgba(255, 69, 0, 0.2);
      border: 2px solid #ff4500;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #ff4500;
      font-size: 18px;
      font-weight: bold;
    }
    
    .challenge-blocked-notification .blocked-tip {
      background: rgba(135, 206, 235, 0.1);
      border: 2px solid #87ceeb;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #87ceeb;
      font-size: 14px;
    }
    
    .challenge-blocked-notification .blocked-button {
      background: linear-gradient(135deg, #ffa500, #ff8c00);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-family: 'Jersey 10', monospace;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(255, 165, 0, 0.3);
      margin-top: 15px;
    }
    
    .challenge-blocked-notification .blocked-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 165, 0, 0.4);
    }

    @keyframes penalty-slide-in {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes penalty-fade-out {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    /* ---------- Achievements / Logros ---------- */
    .achievement-item {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
      border: none;
      border-left: 4px solid;
      padding: 12px 16px;
      margin: 4px 0;
      transition: all 0.3s ease;
      box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }
    
    .achievement-item:hover {
      transform: translateY(-1px);
      box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.4);
    }
    
    .achievement-item.completed {
      border-left-color: #22c55e;
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(21, 128, 61, 0.1) 100%);
      box-shadow: 
        2px 2px 0px rgba(0, 0, 0, 0.3),
        0 0 12px rgba(34, 197, 94, 0.2);
    }
    
    .achievement-item.completed:hover {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.25) 0%, rgba(21, 128, 61, 0.2) 100%);
      box-shadow: 
        3px 3px 0px rgba(0, 0, 0, 0.4),
        0 0 16px rgba(34, 197, 94, 0.3);
    }
    
    .achievement-item.incomplete {
      border-left-color: #6b7280;
      background: linear-gradient(90deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.05) 100%);
    }
    
    .achievement-item.incomplete:hover {
      background: linear-gradient(90deg, rgba(107, 114, 128, 0.2) 0%, rgba(75, 85, 99, 0.15) 100%);
      border-left-color: #9ca3af;
    }
    
    .achievement-icon {
      @apply text-2xl;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    
    .achievement-item.completed .achievement-icon {
      filter: grayscale(0%);
    }
    
    .achievement-status {
      @apply font-medium text-sm px-2 py-1 rounded;
    }
    
    .achievement-status.completed {
      font-family: 'Jersey 10', monospace;
      font-weight: bold;
      background: transparent;
      color: #22c55e;
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.6), 0 0 16px rgba(34, 197, 94, 0.3);
      font-size: 15px;
    }
    
    .achievement-status.incomplete {
      font-family: 'Jersey 10', monospace;
      font-weight: bold;
      background: transparent;
      color: #eab308;
      text-shadow: 0 0 8px rgba(234, 179, 8, 0.6), 0 0 16px rgba(234, 179, 8, 0.3);
      font-size: 15px;
    }
    
    /* Scrollbar personalizado para el modal */
    #achievementsModal .overflow-y-auto::-webkit-scrollbar {
      width: 8px;
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-track {
      background: rgba(30, 27, 75, 0.5);
      border-radius: 0;
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b  100%);
      border-radius: 0;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.3);
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
    }
    
    /* Aplicar Jersey 10 a todo el texto del modal */
    #achievementsModal * {
      font-family: 'Jersey 10', monospace !important;
    }

    /* FORZAR TAMA√ëOS DE FUENTE M√ÅS GRANDES - SOBRESCRIBE TAILWIND */
    #achievementsModal h3 {
      font-size: 24px !important;
    }
    
    #achievementsModal .achievement-title {
      font-size: 18px !important;
    }
    
    #achievementsModal .achievement-status {
      font-size: 16px !important;
    }
    
    #achievementsModal .achievement-icon {
      font-size: 20px !important;
    }

    /* Override espec√≠fico para todos los elementos con texto en el modal */
    #achievementsModal div, 
    #achievementsModal span, 
    #achievementsModal p {
      font-size: 24px !important;
    }
    
    /* Animaci√≥n pulse para timer cr√≠tico de desaf√≠os N */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    
    
    /* Pantalla de carga */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-family: 'Jersey 10', monospace;
    }
    
    .loading-container {
      text-align: center;
      color: white;
      max-width: 500px;
      padding: 2rem;
    }
    
    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    
    .loading-title {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #f2e5b1;
    }
    
    .loading-subtitle {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    
    .loading-progress {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #f2e5b1, #ffd700);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-screen.fade-out {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }

    /* ========== √öLTIMO OVERRIDE JERSEY 10 - M√ÅXIMA PRIORIDAD ========== */
    /* Esta regla debe ir DESPU√âS de todo para tener la m√°xima especificidad */
    button[class*="jersey-font"],
    .jersey-font-niveles,
    .jersey-font-acciones, 
    .jersey-font-horoscopo,
    .jersey-font-dropdown,
    #btnNivel1 *,
    #btnNivel2 *,
    #btnNivel3 *,
    #btnAchievements *,
    #btnDonation *,
    #btnHoroscopo *,
    #btnChallenge *,
    #btnChangeGroup * {
      font-family: 'Jersey 10', 'Courier New', monospace !important;
      font-weight: 400 !important;
      font-style: normal !important;
    }
    
    /* Desktop espec√≠fico - FUERZA ABSOLUTA */
    @media screen and (min-width: 640px) {
      button[class*="jersey-font"] *,
      .jersey-font-niveles *,
      .jersey-font-acciones *,
      .jersey-font-horoscopo *,
      .jersey-font-dropdown *,
      #btnNivel1,
      #btnNivel2, 
      #btnNivel3,
      #btnAchievements,
      #btnDonation,
      #btnHoroscopo,
      #btnChallenge,
      #btnChangeGroup {
        font-family: 'Jersey 10', 'Courier New', monospace !important;
        font-weight: 400 !important;
        text-transform: none !important;
      }
      
      /* Override espec√≠fico para contrarrestar Tailwind font-semibold */
      button#btnNivel1.font-semibold,
      button#btnNivel2.font-semibold,
      button#btnNivel3.font-semibold {
        font-family: 'Jersey 10', 'Courier New', monospace !important;
        font-weight: 400 !important;
        /* NO forzar font-size aqu√≠, usar el de .jersey-font-niveles */
      }
    }
    
    /* √öLTIMO RECURSO - Override solo font-family, NO font-size */
    button#btnNivel1,
    button#btnNivel2,
    button#btnNivel3,
    button#btnAchievements,
    button#btnDonation,
    button#btnChallenge,
    button#btnChangeGroup {
      font-family: 'Jersey 10', 'Courier New', monospace !important;
      /* NO override font-size - permitir que las clases jersey-font-* controlen el tama√±o */
    }
    
    /* ========== SECCI√ìN ELIMINADA - JERSEY FONTS M√ìVIL Y REGLAS DE MODALES ========== */
    
    /* REGLAS DESKTOP ELIMINADAS - CONTROLADAS DESDE ARRIBA */
    
    /* ========== ESTILOS DE TARJETAS ========== */
    /* Opacidad de las tarjetas principales */
    #card {
      opacity: 0.8; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* ========== ESTILOS DE CUADROS DE ESTADO ========== */
    /* Opacidad de los cuadros de estado principales */
    #statBox,
    #streakBox,
    div[style*="background-color: #2e3856"] {
      opacity: 0.8 !important; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* Opacidad de contenedores de estad√≠sticas del modal */
    .achievement-category {
      opacity: 0.8 !important; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* üîÑ Estilos para cartas clickeables en la tabla de conocidas */
    .clickable-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }
    
    .clickable-card:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
    
    .clickable-card:active {
      transform: translateY(0px) !important;
      transition: transform 0.1s ease !important;
    }
    
    /* Indicador visual removido - las cartas siguen siendo clickeables sin el s√≠mbolo */
  </style>


</head>
<body id="body" class="min-h-screen text-slate-100" style="background-color: #100e37;">
<!-- Pantalla de carga inicial -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h2 class="loading-title">Cargando Flashcards Maca Laoshi</h2>
    <p class="loading-subtitle">Preparando tu experiencia de aprendizaje...</p>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loadingProgressBar"></div>
    </div>
  </div>
</div>

<div id="gameArea" class="hidden">
  <div class="max-w-3xl mx-auto p-4 sm:p-6 px-6 sm:px-8">

    <!-- ---------- Encabezado ---------- -->
    <header class="flex flex-col gap-3">
      <!-- T√≠tulo y botones -->
      <div class="flex flex-row items-center justify-between gap-2">
        <h1 class="text-2xl md:text-4xl font-bold tracking-tight text-left leading-none" style="font-family: 'Jersey 10', monospace; text-shadow: 2px 2px 0px #777572">MacaLaoshi Flashcards</h1>        <!-- Contenedor de botones (alineado a la derecha) -->
        <div class="flex flex-row items-center gap-2">
          
          <!-- Bot√≥n de Logros -->
          <button id="btnAchievements" class="px-3 py-2 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-medium border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2 flex items-center gap-1 sm:gap-2 jersey-font-acciones" title="Ver logros y objetivos">
            <span>üèÖ</span>
            <span>Logros</span>
          </button>
          
          <!-- Bot√≥n de donaci√≥n -->
          <div class="relative">
          <button id="btnDonation" class="px-2 py-2 sm:px-3 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2 flex items-center gap-1 sm:gap-2 whitespace-nowrap jersey-font-acciones">
            <span>üíù</span>
            <span>Apoyar</span>
            <span id="donationArrow" class="inline-block transition-transform duration-300">‚ñº</span>
          </button>
          
          <!-- Modal de opciones de donaci√≥n -->
          <div id="donationModal" class="absolute right-0 mt-2 bg-gradient-to-br from-pink-300 to-rose-400 border border-pink-200 rounded-xl shadow-xl p-3 z-50 hidden min-w-[280px]">
            <div class="flex flex-col gap-2">
              <h3 class="text-sm font-semibold text-center mb-1 text-gray-800">üíù Opciones de Donaci√≥n</h3>
              
              <!-- Argentina -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üá¶üá∑</span>
                  <span class="font-medium text-xs text-gray-700">Argentina - Alias:</span>
                </div>
                <div class="bg-pink-50 rounded p-2 text-xs font-mono">
                  <span id="aliasArgentina" class="text-gray-800">shi.manuel</span>
                  <button onclick="copyToClipboard('shi.manuel', 'Alias copiado!')" class="ml-2 text-pink-600 hover:text-pink-500 text-xs">copiar</button>
                </div>
              </div>
              
              <!-- M√©xico -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üá≤üáΩ</span>
                  <span class="font-medium text-xs text-gray-700">M√©xico - CLABE BBVA:</span>
                </div>
                <div class="bg-pink-50 rounded p-2 text-xs font-mono">
                  <span id="clabeMexico" class="text-gray-800">012180015679448077</span>
                  <button onclick="copyToClipboard('012180015679448077', 'CLABE copiada!')" class="ml-2 text-pink-600 hover:text-pink-500 text-xs">copiar</button>
                </div>
              </div>
              
              <!-- Internacional - Stripe -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üåç</span>
                  <span class="font-medium text-xs text-gray-700">Internacional:</span>
                </div>
                <a href="https://buy.stripe.com/7sY3cv529eFgbp3bc2gMw1e" target="_blank" 
                   class="block bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-center py-2 px-3 rounded-lg font-medium text-xs transition-all duration-300">
                  üí≥ Tarjeta D√©b/Cr√©d
                </a>
              </div>
              
            </div>
          </div>
        </div>
        
      </div> <!-- Cierre del contenedor de botones -->
    </div> <!-- Cierre de la fila t√≠tulo/botones -->
      
      <!-- Bot√≥n Historia -->
      <div class="mb-4">
        <button id="btnHistoria" class="w-full px-4 py-3 rounded-2xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 font-bold text-white text-lg jersey-font-niveles transition-all duration-300 shadow-lg border-2 border-black/60 border-b-4 border-b-black/60 hover:translate-y-0.5 hover:border-b-2" onclick="console.log('üé≠ DIRECT CLICK: Bot√≥n Historia tocado directamente'); window.showChapterModal();">
          üìö Historia
        </button>
      </div>
      
      <!-- Fila 1: Nivel 1 y Nivel 2 lado a lado en desktop -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <!-- Columna 1: Nivel 1 -->
        <div class="relative">
          <button id="btnNivel1" class="w-full px-4 py-2 rounded-2xl bg-indigo-700 hover:bg-indigo-600 font-semibold jersey-font-niveles">
            <span>Nivel 1</span> <span id="nivel1Arrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="nivel1Box" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnUnit2" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 2</button>
            <button id="btnUnit3" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 3</button>
            <button id="btnUnit4" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 4</button>
            <button id="btnUnit5" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 5</button>
            <button id="btnUnit6" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 6</button>
            <button id="btnUnit7" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 7</button>
            <button id="btnUnit8" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 8</button>
            <button id="btnUnit9" class="px-4 py-2 rounded-2xl text-black jersey-font-dropdown" style="background-color: #ffc853;">Unidad 9</button>
            <button id="btnTodoN1" class="px-4 py-2 rounded-2xl text-black font-bold jersey-font-dropdown" style="background-color: #e6b347;">Todo N1</button>
            <button id="btnDesafioN1" class="px-4 py-2 rounded-2xl bg-fuchsia-700 hover:bg-fuchsia-600 font-bold jersey-font-acciones">Desaf√≠o N1</button>
          </div>
        </div>
        
        <!-- Columna 2: Nivel 2 (cuando est√° desbloqueado) -->
        <div class="relative" id="nivel2Wrap" style="display:none;">
          <button id="btnNivel2" class="w-full px-4 py-2 rounded-2xl bg-red-700 hover:bg-red-600 font-semibold jersey-font-niveles">
            <span>Nivel 2 ‚ñº</span> 
          </button>
          <div id="nivel2Box" class="absolute left-0 mt-2 bg-slate-800 rounded-xl shadow-lg ring-1 ring-white/10 z-50 flex flex-col min-w-[180px] opacity-0 scale-y-95 transition-all duration-300 origin-top hidden">
            <button id="btnUnit1N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 1</button>
            <button id="btnUnit2N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 2</button>
            <button id="btnUnit3N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 3</button>
            <button id="btnUnit4N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 4</button>
            <button id="btnUnit5N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 5</button>
            <button id="btnUnit6N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 6</button>
            <button id="btnUnit7N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 7</button>
            <button id="btnUnit8N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 8</button>
            <button id="btnUnit9N2" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 9</button>
            <button id="btnTodoN2" class="px-4 py-2 rounded-xl text-black font-bold m-1 jersey-font-dropdown" style="background-color: #e6b347;">Todo N2</button>
            <button id="btnDesafioN2" class="px-4 py-2 rounded-xl bg-fuchsia-700 hover:bg-fuchsia-600 font-bold m-1 jersey-font-acciones">Desaf√≠o N2</button>
          </div>
        </div>

        <!-- Columna 3: Nivel 3 (cuando est√° desbloqueado) -->
        <div class="relative" id="nivel3Wrap" style="display:none;">
          <button id="btnNivel3" class="w-full px-4 py-2 rounded-2xl bg-green-700 hover:bg-green-600 font-semibold jersey-font-niveles">
            <span>Nivel 3 ‚ñº</span> 
          </button>
          <div id="nivel3Box" class="absolute left-0 mt-2 bg-slate-800 rounded-xl shadow-lg ring-1 ring-white/10 z-50 flex flex-col min-w-[180px] opacity-0 scale-y-95 transition-all duration-300 origin-top hidden">
            <button id="btnUnit1N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 1</button>
            <button id="btnUnit2N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 2</button>
            <button id="btnUnit3N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 3</button>
            <button id="btnUnit4N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 4</button>
            <button id="btnUnit5N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 5</button>
            <button id="btnUnit6N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 6</button>
            <button id="btnUnit7N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 7</button>
            <button id="btnUnit8N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 8</button>
            <button id="btnUnit9N3" class="px-4 py-2 rounded-xl text-black m-1 jersey-font-dropdown" style="background-color: #ffc853;">Unidad 9</button>
            <button id="btnTodoN3" class="px-4 py-2 rounded-xl text-black font-bold m-1 jersey-font-dropdown" style="background-color: #e6b347;">Todo N3</button>
            <button id="btnDesafioN3" class="px-4 py-2 rounded-xl bg-emerald-700 hover:bg-emerald-600 font-bold m-1 jersey-font-acciones">Desaf√≠o N3</button>
          </div>
        </div>
        
        <!-- Columna 3: Espacio reservado para Nivel 3 -->
        <div class="hidden sm:block"></div>
      </div>
      
      <!-- Fila 2: Conocidas, A repasar, Confirmar - GRID 3 COLUMNAS FORZADO -->
      <div class="grid grid-cols-3 gap-1">
        <button id="btnKnown" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">Conocidas <span id="countKnown" class="font-bold ml-1">0</span></span>
        </button>
        <button id="btnRevise1" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">A repasar <span id="countRev1" class="ml-1">‚úÖ</span></span>
        </button>
        <button id="btnRevise2" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">Confirmar <span id="countRev2" class="ml-1">‚úÖ</span></span>
        </button>
      </div>
      

      
      <!-- Fila 4: Desaf√≠o, Tabla Conocidas - GRID 2 COLUMNAS FORZADO -->
      <div class="grid grid-cols-2 gap-1">
        <div class="relative">
          <button id="btnChallenge" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones" style="font-size: clamp(8px, 3vw, 14px);">
            <span class="whitespace-nowrap">Desaf√≠o</span> <span id="challengeArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="challengeBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnDesafioClassico" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o cl√°sico</button>
            <button id="btnDesafioMenos" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o - (nivel 0 y 1)</button>
            <button id="btnDesafioMas" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o + (nivel 2+)</button>
          </div>
        </div>
        <button id="btnKnownTable" class="px-2 py-1 rounded-2xl bg-yellow-600 hover:bg-yellow-500 text-black font-semibold ring-2 ring-yellow-700 min-h-[50px] flex items-center justify-center jersey-font-coleccion-buttons">
          <span class="whitespace-nowrap">Mi Colecci√≥n</span>
        </button>
      </div>
      
      <!-- Fila 5: Desaf√≠os del Hor√≥scopo y Los 12 animales del hor√≥scopo - GRID 2 COLUMNAS -->
      <div class="grid grid-cols-2 gap-1">
        <!-- Desaf√≠os del Hor√≥scopo -->
        <div class="relative">
          <button id="btnDesafiosHoroscopo" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-horoscopo">
            <span class="whitespace-nowrap">Desaf√≠os del Hor√≥scopo</span> <span id="desafiosHoroscopoArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="desafiosHoroscopoBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 z-40 hidden" style="width: clamp(225px, 71vw, 300px); max-width: 71vw;">
            <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(clamp(90px, 30vw, 120px), 1fr));">            
              <!-- Fila 1 -->
              <button id="btnDesafioRata" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêÅ Rata<br><span style="font-size: 0.8em;">colores</span></button>
              <button id="btnDesafioGallo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêì Gallo<br><span style="font-size: 0.8em;">fruta</span></button>
              <button id="btnDesafioConejo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêá Conejo<br><span style="font-size: 0.8em;">verdura</span></button>
              <!-- Fila 2 -->
              <button id="btnDesafioCerdo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêñ Cerdo<br><span style="font-size: 0.8em;">comidas</span></button>
              <button id="btnDesafioPerro" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêï Perro<br><span style="font-size: 0.8em;">animales</span></button>
              <button id="btnDesafioCaballo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêé Caballo<br><span style="font-size: 0.8em;">deportes</span></button>
              <!-- Fila 3 -->
              <button id="btnDesafioBuey" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêÇ Buey<br><span style="font-size: 0.8em;">hobbies</span></button>
              <button id="btnDesafioCabra" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêê Cabra<br><span style="font-size: 0.8em;">ropa</span></button>
              <button id="btnDesafioSerpiente" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêç Serpiente<br><span style="font-size: 0.8em;">casa</span></button>
              <!-- Fila 4 -->
              <button id="btnDesafioMono" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêí Mono<br><span style="font-size: 0.8em;">cuerpo</span></button>
              <button id="btnDesafioTigre" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêÖ Tigre<br><span style="font-size: 0.8em;">profesi√≥n</span></button>
              <button id="btnDesafioDragon" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); line-height: 1.2; min-height: 60px;">üêâ Drag√≥n<br><span style="font-size: 0.8em;">emociones</span></button>
              <!-- Bot√≥n Desaf√≠o Final -->
              <button id="btnDesafioFinal" class="px-3 py-2 rounded-xl font-semibold text-black" style="font-size: clamp(9px, 2.5vw, 12px); line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 2px solid #FF4500; grid-column: 1 / -1; margin-top: 8px;">üèÜ DESAF√çO FINAL üèÜ<br><span style="font-size: 0.7em; color: #8B0000;">60 tarjetas ‚Ä¢ Todas las categor√≠as</span></button>
            </div>
          </div>
        </div>
        <!-- Los 12 animales del hor√≥scopo -->
        <div class="relative">
          <button id="btnHoroscopo" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-horoscopo">
            <span class="whitespace-nowrap">Los 12 del hor√≥scopo</span> <span id="horoscopoArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
        <div id="horoscopoBox" class="absolute right-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 z-40 hidden" style="width: clamp(225px, 71vw, 300px); max-width: 71vw;">
          <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(clamp(90px, 30vw, 120px), 1fr));">          
            <!-- Fila 1 -->
            <button id="btnRata" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêÅ Rata<br><span style="font-size: 0.8em;">colores</span></button>
            <button id="btnGallo" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêì Gallo<br><span style="font-size: 0.8em;">fruta</span></button>
            <button id="btnConejo" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêá Conejo<br><span style="font-size: 0.8em;">verdura</span></button>
            <!-- Fila 2 -->
            <button id="btnCerdo" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêñ Cerdo<br><span style="font-size: 0.8em;">comidas</span></button>
            <button id="btnPerro" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêï Perro<br><span style="font-size: 0.8em;">animales</span></button>
            <button id="btnCaballo" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêé Caballo<br><span style="font-size: 0.8em;">deportes</span></button>
            <!-- Fila 3 -->
            <button id="btnBuey" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêÇ Buey<br><span style="font-size: 0.8em;">hobbies</span></button>
            <button id="btnCabra" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêê Cabra<br><span style="font-size: 0.8em;">ropa</span></button>
            <button id="btnSerpiente" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêç Serpiente<br><span style="font-size: 0.8em;">casa</span></button>
            <!-- Fila 4 -->
            <button id="btnMono" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêí Mono<br><span style="font-size: 0.8em;">cuerpo</span></button>
            <button id="btnTigre" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêÖ Tigre<br><span style="font-size: 0.8em;">profesi√≥n</span></button>
            <button id="btnDragon" class="px-3 py-2 rounded-xl font-semibold text-black jersey-font-dropdown" style="font-size: clamp(10px, 3vw, 14px); min-height: 60px;">üêâ Drag√≥n<br><span style="font-size: 0.8em;">emociones</span></button>
          </div>
        </div>
      </div>
    </header>

  <script>
  // === UTILIDADES ===
  // Funci√≥n para copiar texto al portapapeles
  function copyToClipboard(text, successMessage) {
    navigator.clipboard.writeText(text).then(() => {
      // Mostrar notificaci√≥n de √©xito
      showNotification(successMessage || 'Copiado al portapapeles!', 'success');
    }).catch(err => {
      console.error('Error al copiar:', err);
      showNotification('Error al copiar', 'error');
    });
  }
  
  // Funci√≥n para mostrar notificaciones temporales
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg font-semibold text-white transition-all duration-300 ${
      type === 'success' ? 'bg-green-600' : 
      type === 'error' ? 'bg-red-600' : 
      'bg-blue-600'
    }`;
    notification.textContent = message;
    notification.style.transform = 'translateX(100%)';
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Eliminar despu√©s de 3 segundos
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  // === SISTEMA DE LOGROS ===
  function calculateTotalScore() {
    // Puntaje: XP + (palabras conocidas * 2) + (racha * 5)
    const knownWords = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo').length;
    return xpPoints + (knownWords * 2) + (streak * 5);
  }

  function updateAchievements() {
    // Definir logros y sus condiciones
    const achievements = {
      // Desaf√≠os principales
      desafioN1: {
        completed: nivel2Unlocked,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 1',
        description: 'Completar el primer desaf√≠o'
      },
      desafioN2: {
        completed: nivel3Unlocked,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 2', 
        description: 'Completar el desaf√≠o de nivel 2'
      },
      desafioN3: {
        completed: desafioN3Completed,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 3',
        description: 'Completar el desaf√≠o de nivel 3'
      },
      
      // Ultimate Challenge
      ultimate: {
        completed: horoscopeMaster,
        icon: 'üëë',
        title: 'Ultimate Challenge',
        description: 'Completar el desaf√≠o final del hor√≥scopo'
      }
    };

    // Actualizar elementos de logros principales
    Object.keys(achievements).forEach(key => {
      const element = document.getElementById(`achievement-${key}`);
      if (element) {
        const achievement = achievements[key];
        element.className = `achievement-item ${achievement.completed ? 'completed' : 'incomplete'}`;
        
        const statusSpan = element.querySelector('.achievement-status');
        if (statusSpan) {
          statusSpan.textContent = achievement.completed ? '‚úÖ Completado' : 'Pendiente';
          statusSpan.className = `achievement-status ${achievement.completed ? 'completed' : 'incomplete'}`;
        }
      }
    });

    // Actualizar logros del hor√≥scopo
    updateHoroscopeAchievements();
    
    // Actualizar logros de caracteres conocidos
    updateCharsAchievements();
    
    // Actualizar logros de niveles
    updateLevelsAchievements();
    
    // Actualizar logros de XP
    updateXPAchievements();
    
    // Actualizar logros de Score
    updateScoreAchievements();
    
    // Actualizar estad√≠sticas del jugador
    updatePlayerStats();
  }

  function updateHoroscopeAchievements() {
    const horoscopeContainer = document.getElementById('horoscope-achievements');
    if (!horoscopeContainer) return;

    const categories = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    
    horoscopeContainer.innerHTML = '';
    
    categories.forEach(category => {
      const isCompleted = horoscopeAnimalsUnlocked.includes(category);
      const categoryNames = {
        colores: 'de la Rata (Colores)', fruta: 'del gallo (Frutas)', verduras: 'del Conejo (Verduras)', 
        comidas: 'del Cerdo (Comidas)', animales: 'del Perro (Animales)', deportes: 'del Caballo (Deportes)',
        hobbies: 'del Buey (Hobbies)', ropa: 'de la Cabra (Ropa)', casa: 'de la Serpiente (Casa)', 
        cuerpo: 'del Mono (Cuerpo)', profesiones: 'del Tigre (Profesiones)', emociones: 'del Drag√≥n(Emociones)'
      };
      
      const div = document.createElement('div');
      div.className = `achievement-item ${isCompleted ? 'completed' : 'incomplete'}`;
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center">
          <span class="achievement-icon">üê≤</span>
          <div class="flex-1 achievement-title">  Completar Desaf√≠o ${categoryNames[category]}</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : 'Pendiente'}
          </span>
        </div>
      `;
      horoscopeContainer.appendChild(div);
    });
  }

  function updateCharsAchievements() {
    const charsContainer = document.getElementById('chars-achievements');
    if (!charsContainer) return;

    const charsMilestones = [50, 100, 200, 300, 400, 500];
    const knownCharsCount = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo').length;
    charsContainer.innerHTML = '';
    
    charsMilestones.forEach(milestone => {
      const isCompleted = knownCharsCount >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item ${isCompleted ? 'completed' : 'incomplete'}`;
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üìö</span>
          <div class="flex-1 achievement-title">Conocer ${milestone} caracteres</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${knownCharsCount}/${milestone}`}
          </span>
        </div>
      `;
      charsContainer.appendChild(div);
    });
  }

  function updateLevelsAchievements() {
    const levelsContainer = document.getElementById('levels-achievements');
    if (!levelsContainer) return;

    const levelMilestones = [10, 30, 50, 100];
    levelsContainer.innerHTML = '';
    
    levelMilestones.forEach(milestone => {
      // Buscar si hay al menos un car√°cter que haya alcanzado este nivel
      const hasCharAtLevel = cards.some(c => 
        c.known && 
        !c.isHoroscopeAnimal && 
        c.unit !== 'horoscopo' && 
        (c.challengeStreak || 0) >= milestone
      );
      
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${hasCharAtLevel ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üìà</span>
          <div class="flex-1 achievement-title">Tener 1 car√°cter en nivel ${milestone}</div>
          <span class="achievement-status ${hasCharAtLevel ? 'completed' : 'incomplete'}">
            ${hasCharAtLevel ? '‚úÖ Completado' : 'Pendiente'}
          </span>
        </div>
      `;
      levelsContainer.appendChild(div);
    });
  }

  function updateXPAchievements() {
    const xpContainer = document.getElementById('xp-achievements');
    if (!xpContainer) return;

    const xpMilestones = [100, 500, 1000, 1500, 2000, 3000];
    xpContainer.innerHTML = '';
    
    xpMilestones.forEach(milestone => {
      const isCompleted = xpPoints >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item ${isCompleted ? 'completed' : 'incomplete'}`;
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">‚≠ê</span>
          <div class="flex-1 achievement-title">Alcanzar ${milestone} puntos de experiencia</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${xpPoints}/${milestone}`}
          </span>
        </div>
      `;
      xpContainer.appendChild(div);
    });
  }

  function updateScoreAchievements() {
    const scoreContainer = document.getElementById('score-achievements');
    if (!scoreContainer) return;

    const scoreMilestones = [50, 100, 500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000];
    const currentScore = calculateTotalScore();
    scoreContainer.innerHTML = '';
    
    scoreMilestones.forEach(milestone => {
      const isCompleted = currentScore >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item ${isCompleted ? 'completed' : 'incomplete'}`;
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üéñÔ∏è</span>
          <div class="flex-1 achievement-title">Alcanzar ${milestone} puntos totales</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${currentScore}/${milestone}`}
          </span>
        </div>
      `;
      scoreContainer.appendChild(div);
    });
  }

  // Funci√≥n para actualizar las estad√≠sticas del jugador
  function updatePlayerStats() {
    // Obtener datos actuales (usar las mismas variables globales del juego)
    const currentXP = xpPoints || 0;
    const knownCharacters = cards.filter(c => c.known).length;
    const totalCharacters = cards.length;
    const currentStreak = streak || 0; // usar la variable global 'streak'
    const xpLevel = getCurrentLevel(currentXP); // usar la funci√≥n real del juego
    
    // Actualizar elementos b√°sicos
    const statsXP = document.getElementById('statsXP');
    const statsCharacters = document.getElementById('statsCharacters');
    const statsStreak = document.getElementById('statsStreak');
    const statsLevel = document.getElementById('statsLevel');
    
    if (statsXP) statsXP.textContent = currentXP.toLocaleString();
    if (statsCharacters) statsCharacters.textContent = `${knownCharacters}/${totalCharacters}`;
    if (statsStreak) statsStreak.textContent = currentStreak.toLocaleString();
    if (statsLevel) statsLevel.textContent = xpLevel;
    
    // Calcular con la f√≥rmula correcta: 5% por Ê∞¥Âπ≥ y 1% por racha
    const levelMultiplier = 1 + (xpLevel * 0.05); // 5% por cada nivel Ê∞¥Âπ≥
    const streakMultiplier = 1 + (currentStreak * 0.01); // 1% por cada punto de racha
    
    // Calcular componentes del puntaje
    const totalLevels = cards.filter(c => c.known).reduce((sum, c) => sum + (c.challengeStreak || 0), 0);
    const baseScore = knownCharacters + totalLevels;
    const finalScore = Math.floor(baseScore * levelMultiplier * streakMultiplier);
    
    // Calcular porcentajes de bonificaci√≥n (sin el 100% base)
    const levelBonus = xpLevel * 5; // 5% x nivel
    const streakBonus = currentStreak * 1; // 1% x racha
    
    // Actualizar f√≥rmula
    // Actualizar elementos de la f√≥rmula
    const formulaChars = document.getElementById('formulaChars');
    const formulaLevels = document.getElementById('formulaLevels');
    const formulaLevelPercent = document.getElementById('formulaLevelPercent');
    const formulaLevelMult = document.getElementById('formulaLevelMult');
    const formulaLevelResult = document.getElementById('formulaLevelResult');
    const formulaStreakPercent = document.getElementById('formulaStreakPercent');
    const formulaStreakMult = document.getElementById('formulaStreakMult');
    const formulaStreakResult = document.getElementById('formulaStreakResult');
    const formulaResult = document.getElementById('formulaResult');
    
    // Actualizar valores y data-to para animaci√≥n
    if (formulaChars) {
      formulaChars.textContent = knownCharacters.toLocaleString();
      formulaChars.setAttribute('data-to', knownCharacters.toString());
    }
    if (formulaLevels) {
      formulaLevels.textContent = totalLevels.toLocaleString();
      formulaLevels.setAttribute('data-to', totalLevels.toString());
    }
    
    // Multiplicador de Ê∞¥Âπ≥
    if (formulaLevelPercent) {
      formulaLevelPercent.textContent = '5';
      formulaLevelPercent.setAttribute('data-from', '0');
      formulaLevelPercent.setAttribute('data-to', '5');
    }
    if (formulaLevelMult) {
      formulaLevelMult.textContent = xpLevel.toString();
      formulaLevelMult.setAttribute('data-from', '0');
      formulaLevelMult.setAttribute('data-to', xpLevel.toString());
    }
    if (formulaLevelResult) {

      formulaLevelResult.textContent = levelBonus.toString();
      formulaLevelResult.setAttribute('data-from', '0');
      formulaLevelResult.setAttribute('data-to', levelBonus.toString());
    }
    
    // Multiplicador de racha
    if (formulaStreakPercent) {
      formulaStreakPercent.textContent = '1';
      formulaStreakPercent.setAttribute('data-from', '0');
      formulaStreakPercent.setAttribute('data-to', '1');
    }
    if (formulaStreakMult) {
      formulaStreakMult.textContent = currentStreak.toString();
      formulaStreakMult.setAttribute('data-from', '0');
      formulaStreakMult.setAttribute('data-to', currentStreak.toString());
    }
    if (formulaStreakResult) {

      formulaStreakResult.textContent = streakBonus.toString();
      formulaStreakResult.setAttribute('data-from', '0');
      formulaStreakResult.setAttribute('data-to', streakBonus.toString());
    }
    
    // Resultado final
    if (formulaResult) {
      formulaResult.textContent = finalScore.toLocaleString();
      formulaResult.setAttribute('data-to', finalScore.toString());
    }
  }

  // ========= SISTEMA DE ANIMACI√ìN DE N√öMEROS EN ESTAD√çSTICAS =========
  
  // ========= AUDIO CONTEXT SIMPLE (FUNCIONA EN iOS) =========
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  async function ensureAudio(){ try { if(audioCtx.state !== 'running') await audioCtx.resume(); } catch(e){} }

  
  function createNumberTickSound() {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      // Sonido m√°s grave y satisfactorio tipo "clic" mec√°nico
      oscillator.type = 'triangle';
      oscillator.frequency.setValueAtTime(220 + Math.random() * 80, audioCtx.currentTime); // M√°s grave (220-300Hz)
      oscillator.frequency.exponentialRampToValueAtTime(180, audioCtx.currentTime + 0.02); // Baja r√°pido
      gainNode.gain.setValueAtTime(0.085, audioCtx.currentTime); // Volumen mucho m√°s alto
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
      
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.03);
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }
  
  function createNumberPopSound(isSpecial = false) {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      if (isSpecial) {
        // ÔøΩ SONIDO CHIN - Simple y satisfactorio
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1760, audioCtx.currentTime); // Agudo met√°lico
        oscillator.frequency.exponentialRampToValueAtTime(2093, audioCtx.currentTime + 0.06); // M√°s agudo
        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime); // Volumen alto para satisfacci√≥n
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.25);
      } else {
        // Usar el mismo sonido √©pico pero con menos volumen para pops normales
        
        // Oscilador principal (tono fundamental) - versi√≥n reducida
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(261.63, audioCtx.currentTime); // Do (C4)
        oscillator.frequency.exponentialRampToValueAtTime(329.63, audioCtx.currentTime + 0.1); // Mi (E4)
        oscillator.frequency.exponentialRampToValueAtTime(392.00, audioCtx.currentTime + 0.25); // Sol (G4)
        gainNode.gain.setValueAtTime(0.012, audioCtx.currentTime); // Menos volumen que especial
        gainNode.gain.exponentialRampToValueAtTime(0.02, audioCtx.currentTime + 0.08);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.35);
        
        // Oscilador de armon√≠a m√°s sutil
        const oscillator2 = audioCtx.createOscillator();
        const gainNode2 = audioCtx.createGain();
        oscillator2.connect(gainNode2);
        gainNode2.connect(audioCtx.destination);
        
        oscillator2.type = 'sine';
        oscillator2.frequency.setValueAtTime(392.00, audioCtx.currentTime); // Sol (G4)
        oscillator2.frequency.exponentialRampToValueAtTime(493.88, audioCtx.currentTime + 0.1); // Si (B4)
        oscillator2.frequency.exponentialRampToValueAtTime(523.25, audioCtx.currentTime + 0.25); // Do (C5)
        gainNode2.gain.setValueAtTime(0.008, audioCtx.currentTime);
        gainNode2.gain.exponentialRampToValueAtTime(0.015, audioCtx.currentTime + 0.08);
        gainNode2.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
        
        oscillator2.start(audioCtx.currentTime);
        oscillator2.stop(audioCtx.currentTime + 0.35);
      }
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }

  // Sonido satisfactorio para modal de resultados del desaf√≠o
  function createChallengeResultsSound() {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      
      // Crear un acorde mayor satisfactorio con progresi√≥n arm√≥nica
      const notes = [
        { freq: 261.63, delay: 0.0 },    // Do (C4)
        { freq: 329.63, delay: 0.1 },    // Mi (E4) 
        { freq: 392.00, delay: 0.15 },   // Sol (G4)
        { freq: 523.25, delay: 0.25 }    // Do agudo (C5)
      ];
      
      notes.forEach((note, index) => {
        setTimeout(() => {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(note.freq, audioCtx.currentTime);
          
          // Envelope suave y satisfactorio
          gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
          
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.8);
        }, note.delay * 1000);
      });
      
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }
  
  function animateStatsNumbers() {
    const animateElements = document.querySelectorAll('.animate-number');
    
    let currentIndex = 0;
    
    function animateNext() {
      if (currentIndex >= animateElements.length) {
        return;
      }
      
      const element = animateElements[currentIndex];
      
      // Verificar si ya se anim√≥ para evitar repetir
      if (element.getAttribute('data-animated') === 'true') {
        currentIndex++;
        setTimeout(animateNext, 100);
        return;
      }
      
      // Detectar grupos simult√°neos espec√≠ficos
      let elementsToAnimate = [element];
      let elementsToSkip = 0;
      
      // GRUPO INICIAL: Caracteres conocidos y niveles de caracteres (empiezan juntos)
      if (element.id === 'formulaChars' || element.id === 'formulaLevels') {
        console.log('üéØ Animando GRUPO INICIAL: Caracteres y Niveles juntos');
        
        // Encontrar AMBOS elementos del grupo inicial que a√∫n NO han sido animados
        const grupoInicialIDs = ['formulaChars', 'formulaLevels'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupoInicialIDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      
      // GRUPO 1: Los 4 elementos de bonificaciones (porcentajes + multiplicadores)
      else if (element.id === 'formulaLevelPercent' || element.id === 'formulaStreakPercent' || 
          element.id === 'formulaLevelMult' || element.id === 'formulaStreakMult') {
        console.log('üéØ Animando GRUPO 1: Porcentajes y Multiplicadores juntos');
        
        // Encontrar TODOS los elementos del grupo 1 que a√∫n NO han sido animados
        const grupo1IDs = ['formulaLevelPercent', 'formulaStreakPercent', 'formulaLevelMult', 'formulaStreakMult'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupo1IDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      
      // GRUPO 2: Los 2 resultados de bonificaciones
      else if (element.id === 'formulaLevelResult' || element.id === 'formulaStreakResult') {
        console.log('üéØ Animando GRUPO 2: Resultados de bonificaciones juntos');
        
        // Encontrar TODOS los elementos del grupo 2 que a√∫n NO han sido animados
        const grupo2IDs = ['formulaLevelResult', 'formulaStreakResult'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupo2IDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      

      
      // Contador para el callback
      let completedAnimations = 0;
      const totalAnimations = elementsToAnimate.length;
      
      // Funci√≥n de callback que maneja la finalizaci√≥n
      const handleAnimationComplete = () => {
        completedAnimations++;
        if (completedAnimations === totalAnimations) {
          // Marcar todos como animados
          elementsToAnimate.forEach(el => el.setAttribute('data-animated', 'true'));
          
          // Avanzar el √≠ndice hasta despu√©s de todos los elementos animados
          // Buscar el pr√≥ximo elemento no animado
          do {
            currentIndex++;
          } while (currentIndex < animateElements.length && 
                   animateElements[currentIndex].getAttribute('data-animated') === 'true');
          
          // Esperar menos tiempo para el siguiente grupo
          setTimeout(animateNext, 150);
        }
      };
      
      // Animar todos los elementos del grupo simult√°neamente
      elementsToAnimate.forEach((el, index) => {
        const fromValue = el.getAttribute('data-from') || '0';
        let toValue = el.getAttribute('data-to') || el.textContent;
        
        // Obtener valor actual real
        const currentDisplayValue = el.textContent;
        if (currentDisplayValue && currentDisplayValue !== '0') {
          toValue = currentDisplayValue;
          el.setAttribute('data-to', toValue);
        }
        

        
        // Animar seg√∫n el tipo de valor
        if (fromValue.includes('/') || toValue.includes('/')) {
          animateSlashValue(el, fromValue, toValue, handleAnimationComplete);
        } else if (fromValue.includes('%') || toValue.includes('%')) {
          animatePercentageValue(el, fromValue, toValue, handleAnimationComplete);
        } else {
          const fromNum = parseInt(fromValue) || 0;
          const toNum = parseInt(toValue) || 0;
          animateNumberValue(el, fromNum, toNum, handleAnimationComplete);
        }
      });
    }
    
    animateNext();
  }
  
  function animateNumberValue(element, from, to, callback) {
    
    // Duraciones diferentes seg√∫n el tipo de elemento
    let duration = 400; // Default
    if (element.id.includes('Percent')) {
      duration = 300; // M√°s r√°pido para porcentajes (5%, 1%)
    } else if (element.id.includes('Mult')) {
      duration = 300; // R√°pido para multiplicadores (Ê∞¥Âπ≥, ÁÅ´)
    } else if (element.id.includes('Result') && element.id !== 'formulaResult') {
      duration = 200; // Medio para resultados parciales (35%, 7%)
    } else if (element.id === 'formulaResult') {
      duration = 300; // M√°s lento para el resultado final (dram√°tico)
    }
    
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 40; // Tocar sonido cada 40ms
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing suave (ease-out)
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(from + (to - from) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente (solo si el n√∫mero est√° cambiando)
      if (elapsed - lastSoundTime > soundInterval && currentValue !== from && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      // Para n√∫meros peque√±os (sin separadores de miles en f√≥rmula)
      if (to < 1000 && element.style.minWidth) {
        element.textContent = currentValue.toString();
      } else {
        element.textContent = currentValue.toLocaleString();
      }
      

      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {

        // Para n√∫meros peque√±os (sin separadores de miles en f√≥rmula)
        if (to < 1000 && element.style.minWidth) {
          element.textContent = to.toString();
        } else {
          element.textContent = to.toLocaleString();
        }
        // Efecto "pop" al terminar
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function animateSlashValue(element, from, to, callback) {
    const fromParts = from.split('/').map(p => parseInt(p) || 0);
    const toParts = to.split('/').map(p => parseInt(p) || 0);
    
    const duration = 1200; // M√°s r√°pido para valores con "/"
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 100; // Sonidos cada 100ms para valores con slash
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentFirst = Math.floor(fromParts[0] + (toParts[0] - fromParts[0]) * easeProgress);
      const currentSecond = Math.floor(fromParts[1] + (toParts[1] - fromParts[1]) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente
      if (elapsed - lastSoundTime > soundInterval && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      element.textContent = `${currentFirst}/${currentSecond}`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        element.textContent = to;
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function animatePercentageValue(element, from, to, callback) {
    const fromNum = parseInt(from.replace('%', '')) || 100;
    const toNum = parseInt(to.replace('%', '')) || 100;
    
    const duration = 800; // M√°s r√°pido para porcentajes
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 90; // Sonido cada 90ms para porcentajes
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(fromNum + (toNum - fromNum) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente
      if (elapsed - lastSoundTime > soundInterval && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      element.textContent = `${currentValue}%`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        element.textContent = to;
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function popAnimation(element, callback) {
    // Tocar sonido especial para el resultado final, normal para otros
    const isSpecial = element.id === 'formulaResult';
    createNumberPopSound(isSpecial);
    
    // Efecto "pop" con escalado (m√°s dram√°tico para resultado final)
    const scale = isSpecial ? '1.3' : '1.2';
    element.style.transform = `scale(${scale})`;
    element.style.transition = 'transform 0.2s ease-out';
    
    // Llamar al callback ANTES de terminar la wave para solapar animaciones
    if (callback && !isSpecial) {
      setTimeout(callback, 100); // Callback temprano para solapar
    }
    
    setTimeout(() => {
      element.style.transform = 'scale(1)';
      
      // Onda d√≠gito por d√≠gito
      setTimeout(() => {
        digitWaveEffect(element, isSpecial ? callback : null); // Solo callback para especial
      }, 200);
    }, isSpecial ? 250 : 200); // Mantener el scale un poco m√°s para resultado final
  }
  
  function digitWaveEffect(element, callback) {
    const text = element.textContent;
    const chars = text.split('');
    
    // Crear spans para cada car√°cter
    element.innerHTML = chars.map(char => 
      `<span style="display: inline-block;">${char}</span>`
    ).join('');
    
    const charElements = element.querySelectorAll('span');
    
    // Animar cada car√°cter con delay secuencial
    charElements.forEach((charEl, index) => {
      setTimeout(() => {
        charEl.style.transform = 'scale(1.3)';
        charEl.style.color = '#fbbf24'; // Amarillo
        charEl.style.transition = 'all 0.15s ease-out';
        
        setTimeout(() => {
          charEl.style.transform = 'scale(1)';
          charEl.style.color = ''; // Volver al color original
        }, 150);
      }, index * 50);
    });
    
    // Callback despu√©s de completar la onda
    setTimeout(() => {
      if (callback) callback();
    }, chars.length * 50 + 300);
  }

  // Event listeners para el modal de logros
  document.addEventListener('DOMContentLoaded', () => {
    // === FUERZA JERSEY 10 V√çA JAVASCRIPT ===
    const forceJerseyFont = () => {
      const jerseyButtons = [
        'btnNivel1', 'btnNivel2', 'btnNivel3',
        'btnAchievements', 'btnDonation', 'btnHoroscopo',
        'btnChallenge', 'btnChangeGroup', 'btnKnownTable',
        'btnShowHanzi', 'btnShowPinyin', 'btnShowMeaning',
        'btnCatAll', 'btnCatS', 'btnCatA', 'btnCatV', 'btnCatP', 'btnCatE'
      ];
      
      jerseyButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          btn.style.fontWeight = "400";
          
          // Tambi√©n fuerza a todos los elementos hijos
          const children = btn.querySelectorAll('*');
          children.forEach(child => {
            child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
            child.style.fontWeight = "400";
          });
        }
      });
      
      // Fuerza tambi√©n elementos con clases jersey-font
      const jerseyElements = document.querySelectorAll('[class*="jersey-font"]');
      jerseyElements.forEach(el => {
        el.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
        el.style.fontWeight = "400";
        
        // Tambi√©n fuerza elementos hijos
        const children = el.querySelectorAll('*');
        children.forEach(child => {
          child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          child.style.fontWeight = "400";
        });
      });
      
      // Fuerza espec√≠ficamente elementos de Mi Colecci√≥n
      const knownCount = document.getElementById('knownCount');
      if (knownCount) {
        knownCount.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
      }
      
      // Fuerza elementos din√°micos en knownGrid
      const knownGrid = document.getElementById('knownGrid');
      if (knownGrid) {
        const cards = knownGrid.querySelectorAll('.card-hanzi, .trading-card, .horoscope-badge');
        cards.forEach(card => {
          card.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          const children = card.querySelectorAll('*');
          children.forEach(child => {
            child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          });
        });
      }
    };
    
    // === FUNCI√ìN PARA APLICAR ANTI-ZOOM SOLAMENTE ===
    const applyMobileAntiZoom = () => {
      // Detectar si es m√≥vil
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return;
      

      
      // Solo aplicar propiedades anti-zoom, NO cambiar font-size
      const allElements = document.querySelectorAll('*');
      allElements.forEach(el => {
        el.style.webkitTextSizeAdjust = 'none';
        el.style.textSizeAdjust = 'none';
      });
      

    };
    
    // Ejecutar funciones inmediatamente
    forceJerseyFont();
    applyMobileAntiZoom();
    
    // Y tambi√©n despu√©s de que carguen las fuentes
    document.fonts.ready.then(() => {
      setTimeout(() => {
        forceJerseyFont();
        applyMobileAntiZoom();
      }, 100);
    });
    
    // Re-aplicar en cambios de orientaci√≥n
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        applyMobileAntiZoom();
        forceJerseyFont();
      }, 300);
    });
    
    // Re-aplicar en resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        applyMobileAntiZoom();
      }, 100);
    });

    const btnAchievements = document.getElementById('btnAchievements');
    const achievementsModal = document.getElementById('achievementsModal');
    const closeAchievementsModal = document.getElementById('closeAchievementsModal');

    if (btnAchievements && achievementsModal && closeAchievementsModal) {
      btnAchievements.onclick = () => {
        // üîù PRIMERO hacer scroll al top inmediatamente
        window.scrollTo({ top: 0, behavior: 'instant' });
        document.body.scrollTop = 0; // Para Safari
        document.documentElement.scrollTop = 0; // Para otros browsers
        
        updateAchievements();
        
        // Resetear todos los n√∫meros a 0 antes de mostrar el modal
        document.querySelectorAll('.animate-number').forEach(el => {
          el.textContent = '0';
          el.removeAttribute('data-animated');
        });
        
        achievementsModal.classList.remove('hidden');
        

        
        // Iniciar animaciones de n√∫meros (dar tiempo para que el modal se muestre)
        setTimeout(() => {

          animateStatsNumbers();
        }, 100);
        
        // Asegurar que el contenido del modal est√© en el top
        setTimeout(() => {
          const modalContent = achievementsModal.querySelector('.overflow-y-auto');
          if (modalContent) {
            modalContent.scrollTop = 0;
          }
        }, 10);
      };

      closeAchievementsModal.onclick = () => {
        achievementsModal.classList.add('hidden');
      };

      // Cerrar al hacer clic fuera del modal
      achievementsModal.onclick = (e) => {
        if (e.target === achievementsModal) {
          achievementsModal.classList.add('hidden');
        }
      };
    }
  });
  
  // --- Login autom√°tico ---
  function showLoginForm() {
    // Versi√≥n documental: no hay login/registro ni conexiones a backend.
    window.username = localStorage.getItem('username') || window.username || 'ManuShi';
    jwtToken = localStorage.getItem('jwtToken') || 'documental-local-token';
    localStorage.setItem('jwtToken', jwtToken);
    localStorage.setItem('username', window.username);
    console.log('üë§ Modo documental: usuario local:', window.username);

    // Mostrar pantalla de carga mientras inicia
    const gameArea = document.getElementById('gameArea');
    const loadingScreen = document.getElementById('loadingScreen');
    if (gameArea) gameArea.classList.add('hidden');
    if (loadingScreen) loadingScreen.style.display = 'flex';

    loadAll()
      .then(() => renderLeaderboard())
      .catch((e) => console.error('‚ùå Error iniciando app (modo documental):', e));
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // Mostrar pantalla de carga al inicio
    updateLoadingProgress(5, 'Iniciando aplicaci√≥n...');
    
    // Inicializar controles
    initializeControls();
    
    // Inicializar pools de sonidos
    initCorrectSoundPool();
    initCelebrationSoundPool();
    initCongratulationSoundPool();
    
    // OCULTAR BOTONES DE QUIZ AL INICIO (no hay modo seleccionado)
    const quizModeButtons = document.getElementById('quizModeButtons');
    if (quizModeButtons) {
      quizModeButtons.classList.add('hidden');
      console.log('üéØ DEBUG: Botones de quiz ocultados al inicio');
    }
    
    // Ejecutar actualizaci√≥n inicial de botones del hor√≥scopo despu√©s de un momento
    setTimeout(() => {
      console.log('üîÑ Ejecutando updateHoroscopeButtonsState inicial en DOMContentLoaded...');
      if (typeof updateHoroscopeButtonsState === 'function') {
        updateHoroscopeButtonsState();
      }
    }, 1000);
    
    // Scroll al top al cargar la p√°gina
    window.scrollTo(0, 0);
    
    // Tambi√©n forzar scroll al top en pageshow (bot√≥n atr√°s del navegador)
    window.addEventListener('pageshow', () => {
      window.scrollTo(0, 0);
    });

    // === INICIALIZAR SISTEMA DE IM√ÅGENES OPTIMIZADO ===
    console.log('üñºÔ∏è Iniciando sistema de optimizaci√≥n de im√°genes...');
    
    // Iniciar preload cr√≠tico inmediatamente
    preloadCriticalImages();
    
    // Programar preload secundario
    setTimeout(() => {
      preloadSecondaryImages();
    }, 1000);
    
    // Configurar limpieza peri√≥dica del cache
    setInterval(() => {
      optimizeImageCache();
    }, 60000); // Cada minuto
    
    // Mostrar m√©tricas despu√©s de un tiempo
    setTimeout(() => {
      const totalImages = imageCache.size;
      const loadTimes = Array.from(imageLoadTimes.values());
      const avgLoadTime = loadTimes.reduce((sum, time) => sum + time, 0) / loadTimes.length || 0;
      
      console.log('üìä M√âTRICAS DE IM√ÅGENES:');
      console.log(`   üñºÔ∏è  Cache: ${totalImages} im√°genes`);
      console.log(`   ‚ö°  Promedio: ${avgLoadTime.toFixed(2)}ms`);
      console.log(`   üåê  Red: ${networkQuality}${isSlowConnection ? ' (lenta)' : ''}`);
      
      if (loadTimes.length > 0) {
        console.log(`   üèÉ  M√°s r√°pida: ${Math.min(...loadTimes).toFixed(2)}ms`);
        console.log(`   üêå  M√°s lenta: ${Math.max(...loadTimes).toFixed(2)}ms`);
      }
    }, 5000);
    
    // ========== MODO DOCUMENTAL: todo local ==========
    window.username = localStorage.getItem('username') || window.username || 'ManuShi';
    jwtToken = localStorage.getItem('jwtToken') || 'documental-local-token';
    localStorage.setItem('jwtToken', jwtToken);
    localStorage.setItem('username', window.username);

    // `API_BASE` ya no se usa en modo documental (sin backend)
    window.API_BASE = window.location.origin;
    console.log('üë§ Usuario hardcodeado (modo documental):', window.username);
    // ================================================

    await loadAll();
    await renderLeaderboard();

    // MODO DOCUMENTAL: siempre mostrar Nivel 2
    {
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      if(nivel2Wrap) nivel2Wrap.style.display = '';
      const btnNivel2 = document.getElementById('btnNivel2');
      if(btnNivel2) btnNivel2.style.display = '';
      console.log('‚úÖ Nivel 2 mostrado en loadAll (modo documental)');
    }

    // Forzar scroll al top despu√©s de cargar todos los datos
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 100);
  });
  </script>

        
      </div>
    </header>

    <!-- Barra de experiencia (XP) -->
    <div id="xpBarWrap" class="mt-4 mb-2 mx-8">
      <div class="flex items-center justify-between gap-2 mb-1">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <span id="xpLabel" class="font-bold text-2xl whitespace-nowrap" style="font-family: 'Jersey 10', monospace;">Ê∞¥Âπ≥ <span id="xpLevel">1</span></span>
          <span id="xpToNext" class="text-lg lg:text-base flex-1 min-w-0" style="font-family: 'Jersey 10', monospace; font-weight: bold;"></span>
        </div>
      </div>
      <div class="xp-bar-container">
        <div id="xpBar" class="xp-bar-fill" style="width:0%"></div>
      </div>
    </div>

    <!-- ---------- Estado ---------- -->
  
    <section class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2 text-lg mx-8">
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-tight">Faltan</div>
        <div id="statInSession" class="text-lg font-semibold leading-tight">0</div>
      </div>
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-tight">Revisadas</div>
        <div id="statToday" class="text-lg font-semibold leading-tight">0</div>
      </div>
      <div id="statBox" style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-tight">Modo Actual</div>
        <div id="statMission" class="text-lg font-semibold leading-tight">‚Äî</div>
      </div>
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 cursor-pointer jersey-font-leaderboard" id="streakBox">
        <div class="text-slate-400 flex items-center gap-1 text-xl leading-tight">
          Rachas <span id="streakCount" class="font-bold text-orange-400">0</span> <span style="font-size:1.1em;vertical-align:middle;">üî•</span>
        </div>
        <div id="streakStatus" class="text-sm font-semibold text-orange-300 leading-tight">‚Äî</div>
      </div>
    </section>

     <!-- ---------- Tarjeta ---------- -->
    <!-- Pantalla de precarga para videos -->
    <div id="videoPreloader" style="display: none;">
      <div class="preloader-overlay">
        <div class="preloader-content">
          <div class="preloader-spinner"></div>
          <h2 class="preloader-title">Cargando Desaf√≠o</h2>
          <p class="preloader-text">¬°Entrando a salvar este mundo!</p>
          <div class="preloader-progress">
            <div class="preloader-progress-bar" id="preloadProgress"></div>
          </div>
        </div>
        <!-- Cuenta regresiva -->
        <div class="countdown-content" id="countdownContent" style="display: none;">
          <h2 class="countdown-title">¬øEst√°s listo?</h2>
          <div class="countdown-number" id="countdownNumber">3</div>
          <p class="countdown-text">Empieza en</p>
        </div>
      </div>
    </div>

    <main class="mt-2 mx-6 sm:mx-12 lg:mx-20 xl:mx-32">
      <div id="cardWrap" class="relative h-72 sm:h-80 select-none perspective">
        <div id="card" class="absolute inset-0 rounded-3xl ring-1 ring-white/10 shadow-xl flex items-center justify-center text-center preserve-3d transition-transform duration-300 will-change-transform" style="background-color: #2e3856;">
          <div id="cardFront" class="absolute inset-0 flex items-center justify-center backface-hidden text-6xl font-bold"></div>
          <div id="cardBack" class="absolute inset-0 flex flex-col items-center justify-center rotateY180 backface-hidden text-2xl leading-relaxed whitespace-pre-line"></div>
        </div>
      </div>

      <!-- Controles modo FLASH -->
      <div id="flashRow" class="mt-4 grid grid-cols-3 gap-2 mx-2 sm:mx-4">
        <button id="btnDontKnow" class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">‚Üê No la s√©</button>
        <button id="btnFlip"     class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">Voltear</button>
        <button id="btnKnow"     class="py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">La sab√≠a ‚Üí</button>
      </div>

      <!-- Controles modo QUIZ (opciones din√°micas) -->
      <div id="quizRow" class="mt-4 grid grid-cols-2 gap-2 hidden mx-2 sm:mx-4"></div>
      
      <!-- Indicador de controles de teclado para desktop -->
      <div id="keyboardHint" class="mt-2 text-center text-xs text-gray-400 hidden">
        üíª Desktop: Usa las teclas <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">1</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">2</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">3</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">4</kbd>
      </div>
      
      <!-- Botones de Quiz - Solo aparecen en modos espec√≠ficos -->
      <div id="quizModeButtons" class="mt-4 grid grid-cols-3 gap-2 hidden mx-2 sm:mx-4">
        <button id="btnQuizPinyin" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Pinyin</span>
        </button>
        <button id="btnQuizMeaning" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Trad</span>
        </button>
        <button id="btnQuizHanzi" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Hanzi</span>
        </button>
      </div>

      <p id="gameInstructions" class="mt-3 text-slate-400 text-xs sm:text-sm">
        Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la s√©, Espacio = Voltear, Derecha = La sab√≠a.
      </p>
    </main>
  </div>

  <!-- ========= Overlay: Leaderboard y Tabla Conocidas ========= -->
  <section class="mt-16 mx-2 sm:mx-8">
    <!-- üèÜ Leaderboard primero -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-2 flex-wrap">
        
        <span class="text-lg font-bold" style="color: #FFD700; font-family: 'Jersey 10', monospace; text-shadow: 2px 2px 0px #b8860b; font-size: 20px;">üèÜ LEADERBOARD</span>
        <button id="btnReloadLeaderboard" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-semibold transition-all border-2 border-black/60 border-b-4 border-b-black/60 shadow-md hover:translate-y-0.5 hover:border-b-2 jersey-font-leaderboard" title="Actualizar leaderboard">
          Actualizar
        </button>
        <button id="btnShowMyContext" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-semibold transition-all border-2 border-black/60 border-b-4 border-b-black/60 shadow-md hover:translate-y-0.5 hover:border-b-2 jersey-font-leaderboard" title="Ver mi contexto en el ranking">
          üéØ Mi contexto
        </button>
        <select id="leaderboardCountryFilter" class="px-3 py-2 rounded-xl bg-slate-800 text-white font-semibold border border-slate-700 transition-colors hover:bg-slate-700 jersey-font-dropdown">
          <option value="">üåé Todos los pa√≠ses</option>
          <option value="Argentina">üá¶üá∑ Argentina</option>
          <option value="China">üá®üá≥ China</option>
          <option value="M√©xico">üá≤üáΩ M√©xico</option>
          <option value="Espa√±a">üá™üá∏ Espa√±a</option>
          <option value="Chile">üá®üá± Chile</option>
          <option value="Colombia">üá®üá¥ Colombia</option>
          <option value="Per√∫">üáµüá™ Per√∫</option>
          <option value="Uruguay">üá∫üáæ Uruguay</option>
          <option value="Ecuador">üá™üá® Ecuador</option>
          <option value="Bolivia">üáßüá¥ Bolivia</option>
          <option value="Venezuela">üáªüá™ Venezuela</option>
          <option value="Paraguay">üáµüáæ Paraguay</option>
          <option value="Costa Rica">üá®üá∑ Costa Rica</option>
          <option value="Panam√°">üáµüá¶ Panam√°</option>
          <option value="Estados Unidos">üá∫üá∏ Estados Unidos</option>
          <option value="Portugal">üáµüáπ Portugal</option>
          <option value="Francia">üá´üá∑ Francia</option>
          <option value="Guatemala">üá¨üáπ Guatemala</option>
          <option value="Honduras">üá≠üá≥ Honduras</option>
          <option value="El Salvador">üá∏üáª El Salvador</option>
          <option value="Nicaragua">üá≥üáÆ Nicaragua</option>
          <option value="Puerto Rico">üáµüá∑ Puerto Rico</option>
          <option value="Cuba">üá®üá∫ Cuba</option>
          <option value="Rep√∫blica Dominicana">üá©üá¥ Rep√∫blica Dominicana</option>
        </select>
        <select id="leaderboardGroupFilter" class="px-3 py-2 rounded-xl bg-slate-800 text-white font-semibold border border-slate-700 transition-colors hover:bg-slate-700 jersey-font-dropdown">
          <option value="">üë• Todos los grupos</option>
          <option value="N1">üî¥ N1</option>
          <option value="N2">üü† N2</option>
          <option value="N3">üü° N3</option>
          <option value="N4">üü¢ N4</option>
          <option value="N5">üîµ N5</option>
          <option value="S">‚≠ê S</option>
          <option value="HSK3">üèÆ HSK3</option>
          <option value="No">‚ùå No</option>
        </select>
        <div class="relative">
          <button id="btnChangeGroup" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-sm text-white font-semibold transition-colors jersey-font-acciones">
            üè∑Ô∏è Mi Grupo
          </button>
          <div id="groupSelector" class="absolute left-0 mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-2 flex-col gap-1 z-30 hidden min-w-[140px]">
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N1">üî¥ N1</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N2">üü† N2</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N3">üü° N3</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N4">üü¢ N4</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N5">üîµ N5</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="S">‚≠ê S</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="HSK3">üèÆ HSK3</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="No">‚ùå No</button>
          </div>
        </div>
      </div>
      <div id="leaderboardTable" class="overflow-x-auto"></div>
    </div>
    
    <!-- üìä Tabla de conocidas despu√©s del leaderboard -->
    <div class="mt-8">
      <div class="flex items-center gap-3 mb-2">
        <h2 class="text-lg font-bold jersey-font-coleccion-title" style="color: #FFD700; text-shadow: 2px 2px 0px #b8860b;">üìñ MI COLECCION</h2>

      </div>
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <span id="knownCount" class="text-slate-400 jersey-font-coleccion-counter">0</span>
        <div class="flex items-center gap-2">
          <button id="btnShowHanzi" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Ê±âÂ≠ó</button>
          <button id="btnShowPinyin" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Pinyin</button>
          <button id="btnShowMeaning" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Significado</button>
        </div>
        <div class="flex items-center gap-1 ml-4">
          <span class="text-slate-400 jersey-font-coleccion-filters">Filtrar:</span>
          <button id="btnCatAll" class="px-2 py-1 rounded bg-slate-700 font-bold jersey-font-coleccion-filters">Todos</button>
          <button id="btnCatS" class="px-2 py-1 rounded bg-green-700 font-bold jersey-font-coleccion-filters">S</button>
          <button id="btnCatA" class="px-2 py-1 rounded bg-orange-600 font-bold jersey-font-coleccion-filters">A</button>
          <button id="btnCatV" class="px-2 py-1 rounded bg-red-700 font-bold jersey-font-coleccion-filters">V</button>
          <button id="btnCatP" class="px-2 py-1 rounded bg-yellow-600 font-bold jersey-font-coleccion-filters">P</button>
          <button id="btnCatE" class="px-2 py-1 rounded bg-blue-700 font-bold jersey-font-coleccion-filters">E</button>
        </div>
      </div>
      <div id="knownGrid" class="w-full max-w-full overflow-hidden mb-16"></div>
    </div>
    
    <!-- Botones de administraci√≥n al final -->
    <div class="mt-16 pt-8 border-t border-slate-800">
      
      <!-- Contenedor principal de botones -->
      <div id="mainButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg mx-auto">
        <button id="btnShowResetOptions" class="px-4 py-3 rounded-2xl bg-orange-600 hover:bg-orange-500 font-semibold transition-colors text-center" style="font-family: 'Jersey 10', monospace;">
          ‚ö†Ô∏è PERDER MI PROGRESO
        </button>
        <button id="btnLogout" class="px-4 py-3 rounded-2xl bg-red-700 hover:bg-red-600 text-white font-semibold transition-colors text-center">
          Cerrar sesi√≥n
        </button>
      </div>

      <!-- Botones de reinicio (inicialmente ocultos) -->
      <div id="resetButtonsContainer" class="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-lg mx-auto mt-4" style="display: none;">
        <button id="btnResetXP" class="px-4 py-3 rounded-2xl bg-sky-600 hover:bg-sky-500 font-semibold transition-colors text-center">
          Reiniciar Ê∞¥Âπ≥ (Perder todo tu XP y nivel)
        </button>
        <button id="btnReset" class="px-4 py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 font-semibold transition-colors text-center">
          Reiniciar progreso (Perder todo y empezar de 0)
        </button>
        <button id="btnCancelReset" class="px-4 py-3 rounded-2xl bg-gray-600 hover:bg-gray-500 font-semibold transition-colors text-center">
          ‚ùå Cancelar
        </button>
      </div>
    </div>
    
    <div style="height: 70px;"></div>
  </section>

  <!-- ========= Modal: Logros y Objetivos ========= -->
  <div id="achievementsModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-2xl max-h-[80vh] overflow-y-auto" style="
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
      border: 3px solid #fbbf24;
      border-radius: 0;
      box-shadow: 
        0 0 20px rgba(251, 191, 36, 0.5),
        0 0 40px rgba(251, 191, 36, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.1);
      ">
      <!-- Header -->
      <div class="flex items-center justify-between p-4" style="
        border-bottom: 2px solid #fbbf24;
        background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
        ">
        <h2 style="
          font-family: 'Jersey 10', monospace;
          font-size: 28px;
          color: #fbbf24;
          text-shadow: 0 0 8px rgba(251, 191, 36, 0.8), 2px 2px 0px #b45309;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
          ">
          üèÖ LOGROS Y OBJETIVOS
        </h2>        
        <button id="closeAchievementsModal" class="text-yellow-400 hover:text-yellow-200 font-bold" style="
          font-family: 'Jersey 10', monospace;
          font-size: 24px;
          text-shadow: 0 0 4px rgba(251, 191, 36, 0.6);
          transition: all 0.3s ease;
          " 
          onmouseover="this.style.transform='scale(1.1) rotate(90deg)'; this.style.textShadow='0 0 8px rgba(251, 191, 36, 0.9)'"
          onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.textShadow='0 0 4px rgba(251, 191, 36, 0.6)'">‚úï</button>
      </div>
      
      <!-- Content -->
      <div class="p-6 space-y-8" style="
        background: linear-gradient(180deg, rgba(30, 27, 75, 0.8) 0%, rgba(30, 27, 75, 0.9) 100%);
        ">
        
        <!-- Mis Estad√≠sticas -->
        <div class="achievement-category">
          <h3 class="text-lg font-semibold mb-3 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.7), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            üìä MIS ESTAD√çSTICAS
          </h3>
          
          <!-- Estad√≠sticas compactas -->
          <div class="flex flex-wrap gap-x-6 gap-y-2 mb-4 text-lg jersey-font-coleccion-cards">
            <div class="flex items-center gap-1">
              <span class="text-xl">‚ö°</span>
              <span class="text-cyan-300 font-bold">XP:</span>
              <span id="statsXP" class="text-white font-bold">0</span>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-xl">üìñ</span>
              <span class="text-cyan-300 font-bold">Caracteres:</span>
              <span id="statsCharacters" class="text-white font-bold">0/0</span>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-xl">üî•</span>
              <span class="text-cyan-300 font-bold">Racha:</span>
              <span id="statsStreak" class="text-white font-bold">0</span>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-xl">üèÜ</span>
              <span class="text-cyan-300 font-bold">Ê∞¥Âπ≥:</span>
              <span id="statsLevel" class="text-white font-bold">1</span>
            </div>
          </div>
          
          <!-- F√≥rmula de Puntajes Totales -->
          <div class="bg-gradient-to-r from-slate-900/80 to-slate-800/80 rounded-lg p-2 border-2 border-yellow-500/50">
            <div class="text-xl jersey-font-coleccion-cards space-y-3">
              <!-- L√≠neas de la f√≥rmula por separado -->
              <div class="bg-slate-900/50 p-2 rounded space-y-2">
                <!-- Base: caracteres + niveles -->
                <div class="text-gray-300">
                  (<span id="formulaChars" class="text-cyan-400 font-bold animate-number" data-from="0" data-to="0" style="min-width: 1.5em; display: inline-block; text-align: right;">0</span> caracteres + 
                  <span id="formulaLevels" class="text-cyan-400 font-bold animate-number" data-from="0" data-to="0" style="min-width: 1.7em; display: inline-block; text-align: right;">0</span> niveles de caracter)
                </div>
                <!-- Multiplicador de los Ê∞¥Âπ≥ -->
                <div class="text-green-400 font-bold">
                  √ó (<span id="formulaLevelPercent" class="animate-number" data-from="0" data-to="0" style="min-width: 1.3em; display: inline-block; text-align: right;">0</span>% x <span id="formulaLevelMult" class="animate-number" data-from="0" data-to="0" style="min-width: 0.5em; display: inline-block; text-align: right;">0</span>Ê∞¥Âπ≥ = <span id="formulaLevelResult" class="animate-number" data-from="0" data-to="0" style="min-width: 1em; display: inline-block; text-align: right;">0</span>%)
                </div>
                <!-- Multiplicador de rachas -->
                <div class="text-orange-400 font-bold">
                  √ó (<span id="formulaStreakPercent" class="animate-number" data-from="0" data-to="0" style="min-width: 1.3em; display: inline-block; text-align: right;">0</span>% x <span id="formulaStreakMult" class="animate-number" data-from="0" data-to="0" style="min-width: 0.5em; display: inline-block; text-align: right;">0</span>ÁÅ´ = <span id="formulaStreakResult" class="animate-number" data-from="0" data-to="0" style="min-width: 1em; display: inline-block; text-align: right;">0</span>%)
                </div>
                <!-- Resultado final -->
                <div class="border-t border-gray-600 pt-2 mt-3">
                  <span class="text-yellow-300">PUNTAJE TOTAL = </span>
                  <span id="formulaResult" class="text-yellow-300 font-bold text-xl animate-number" data-from="0" data-to="0" style="min-width: 2em; display: inline-block; text-align: right;">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Desaf√≠os Principales -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.6), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            ‚öîÔ∏è DESAF√çOS PRINCIPALES
          </h3>
          <div class="grid gap-2">
            <div id="achievement-desafioN1" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 1</div>
                <span class="achievement-status"></span>
              </div>
            </div>
            
            <div id="achievement-desafioN2" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 2</div>


                <span class="achievement-status"></span>
              </div>
            </div>
            
            <div id="achievement-desafioN3" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 3</div>
                <span class="achievement-status"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Desaf√≠os del Hor√≥scopo -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #a855f7;
            text-shadow: 0 0 6px rgba(168, 85, 247, 0.6), 1px 1px 0px #7c3aed;
            font-size: 20px;
            ">
            üê≤ HOR√ìSCOPO CHINO
          </h3>
          <div class="grid gap-2" id="horoscope-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Ultimate Challenge -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #f87171;
            text-shadow: 0 0 6px rgba(248, 113, 113, 0.6), 1px 1px 0px #dc2626;
            font-size: 20px;
            ">
            üëë MAESTRO DEL HOR√ìSCOPO
          </h3>
          <div class="grid gap-2">
            <div id="achievement-ultimate" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üëë</span>
                <div class="flex-1 achievement-title">Completar Ultimate Challenge del Hor√≥scopo</div>
                <span class="achievement-status"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Caracteres Conocidos -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.6), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            üìö CARACTERES CONOCIDOS
          </h3>
          <div class="grid gap-2" id="chars-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Niveles de Caracteres -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #fb923c;
            text-shadow: 0 0 6px rgba(251, 146, 60, 0.6), 1px 1px 0px #ea580c;
            font-size: 20px;
            ">
            üìà NIVELES DE DOMINIO
          </h3>
          <div class="grid gap-2" id="levels-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Progreso XP -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #4ade80;
            text-shadow: 0 0 6px rgba(74, 222, 128, 0.6), 1px 1px 0px #16a34a;
            font-size: 20px;
            ">
            ‚≠ê EXPERIENCIA
          </h3>
          <div class="grid gap-2" id="xp-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Score Total -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #60a5fa;
            text-shadow: 0 0 6px rgba(96, 165, 250, 0.6), 1px 1px 0px #2563eb;
            font-size: 20px;
            ">
            üéñÔ∏è PUNTUACI√ìN TOTAL
          </h3>
          <div class="grid gap-2" id="score-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
  /* ========= SISTEMA DE HISTORIA MOVIDO A story.html ========= */
  // El sistema de historia completo ahora est√° en story.html y se carga autom√°ticamente
  // mediante iframe oculto en el head del documento.

  /* ========= Estado y setup ========= */
  // Variable para controlar el estado del leaderboard
  let showingMyContext = false;
  
  // --- Leaderboard logic (Modo Documental - Datos Ficticios) ---
  function getFakeLeaderboardData() {
    return [
      { username: 'Messi', country: 'Argentina', group: 'N1', xp: 230, knownCharsCount: 200, streak: 30, level: 5 },
      { username: 'Ronaldo', country: 'Portugal', group: 'N1', xp: 220, knownCharsCount: 180, streak: 28, level: 5 },
      { username: 'MacaLaoshi', country: 'China', group: 'N1', xp: 210, knownCharsCount: 170, streak: 25, level: 4 },
      { username: 'MrBeast', country: 'Estados Unidos', group: 'N1', xp: 200, knownCharsCount: 160, streak: 22, level: 4 },
      { username: 'JackieChan', country: 'China', group: 'N2', xp: 190, knownCharsCount: 150, streak: 20, level: 4 },
      { username: 'Yaoming', country: 'China', group: 'N2', xp: 180, knownCharsCount: 140, streak: 18, level: 4 },
      { username: 'Agustinaaprende', country: 'Argentina', group: 'N2', xp: 170, knownCharsCount: 130, streak: 15, level: 3 },
      { username: 'LeonardoDV', country: 'Estados Unidos', group: 'N2', xp: 160, knownCharsCount: 120, streak: 14, level: 3 },
      { username: 'ManuShi', country: 'Argentina', group: 'N2', xp: 120, knownCharsCount: 80, streak: 10, level: 3 },
      { username: 'Gero', country: 'Colombia', group: 'N2', xp: 110, knownCharsCount: 70, streak: 8, level: 2 },
      { username: 'Antoniobanderas', country: 'Espa√±a', group: 'N3', xp: 100, knownCharsCount: 60, streak: 7, level: 2 },
      { username: 'GuillermoBull', country: 'Chile', group: 'N3', xp: 90, knownCharsCount: 50, streak: 6, level: 2 },
      { username: 'Jermaioni', country: 'M√©xico', group: 'N3', xp: 80, knownCharsCount: 45, streak: 5, level: 2 },
      { username: 'Tomyjerry', country: 'Panam√°', group: 'N3', xp: 70, knownCharsCount: 40, streak: 4, level: 2 },
      { username: 'Joshi', country: 'M√©xico', group: 'N3', xp: 60, knownCharsCount: 30, streak: 3, level: 1 },
      { username: 'Marioelbross', country: 'Espa√±a', group: 'N3', xp: 50, knownCharsCount: 25, streak: 2, level: 1 },
      { username: 'Mikewasaoski', country: 'Estados Unidos', group: 'N3', xp: 30, knownCharsCount: 15, streak: 1, level: 1 },
      { username: 'Peterpedro', country: 'Panam√°', group: 'N3', xp: 20, knownCharsCount: 10, streak: 1, level: 1 }
    ];
  }

  async function fetchLeaderboard(groupFilter = '', countryFilter = '') {
    let data = getFakeLeaderboardData();

    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }

    data = data.map(u => {
      const score = calcScore(u);
      return { ...u, totalScore: score };
    });

    data.sort((a, b) => b.totalScore - a.totalScore);
    data.forEach((u, i) => { u.rank = i + 1; });

    console.log('üèÜ Leaderboard ficticio generado:', data.length, 'usuarios');
    return data.slice(0, 10);
  }

  async function fetchLeaderboardFull(groupFilter = '', countryFilter = '') {
    let data = getFakeLeaderboardData();

    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }

    data = data.map(u => {
      const score = calcScore(u);
      return { ...u, totalScore: score };
    });

    data.sort((a, b) => b.totalScore - a.totalScore);
    data.forEach((u, i) => { u.rank = i + 1; });
    return data;
  }

  function calcScore(user) {
    // F√≥rmula documental (igual que index): (conocidas + XP) * (1 + 0.01*racha) * (1 + 0.05*nivel)
    const xp = user.xp || 0;
    const known = Array.isArray(user.knownChars) ? user.knownChars.filter(c=>c.known).length : (user.knownCharsCount || 0);
    const streak = user.streak || 0;
    const level = user.level || 1;

    const baseScore = known + xp;
    const streakMultiplier = 1 + (0.01 * streak);
    const levelMultiplier = 1 + (0.05 * level);
    return Math.round(baseScore * streakMultiplier * levelMultiplier);
  }

  async function showMyContextInLeaderboard() {
    // Obtener filtros actuales
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    // Solicitar lista completa para poder mostrar contexto (filtros ya aplicados en backend)
    const filteredLeaderboard = await fetchLeaderboardFull(selectedGroup, selectedCountry);
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      document.getElementById('leaderboardTable').innerHTML = '<div class="text-center text-slate-400 py-4">No hay datos para mostrar contexto</div>';
      return;
    }
    
    // El backend ya se encarga de incluir al usuario actual y ordenar correctamente
    const currentUser = window.username || (window.jwtTokenUser || null);
    
    const myUserIndex = filteredLeaderboard.findIndex(u => u.username === currentUser);
    
    console.log('Debug Mi contexto:');
    console.log('Usuario actual:', currentUser);
    console.log('Mi √≠ndice:', myUserIndex);
    console.log('Total usuarios filtrados:', filteredLeaderboard.length);
    
    if (myUserIndex === -1) {
      document.getElementById('leaderboardTable').innerHTML = '<div class="text-center text-slate-400 py-4">No se encontr√≥ tu posici√≥n en el ranking actual</div>';
      return;
    }
    
    // Obtener 5 usuarios arriba y 5 abajo (o los que haya disponibles)
    const startIndex = Math.max(0, myUserIndex - 5);
    const endIndex = Math.min(filteredLeaderboard.length, myUserIndex + 6); // usuario actual + 5 abajo
    
    console.log('Start index:', startIndex);
    console.log('End index:', endIndex);
    console.log('Usuarios que se van a mostrar:', endIndex - startIndex);
    
    const contextUsers = filteredLeaderboard.slice(startIndex, endIndex);
    
    console.log('Context users length:', contextUsers.length);
    console.log('Context users:', contextUsers.map(u => `${u.username} (pos ${u.rank})`));
    
    renderLeaderboardTable(contextUsers, currentUser, true);
  }

  async function toggleLeaderboardView() {
    const btnShowMyContext = document.getElementById('btnShowMyContext');
    
    if (!showingMyContext) {
      // Cambiar a "mi contexto"
      await showMyContextInLeaderboard();
      showingMyContext = true;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üîù Ver top';
        btnShowMyContext.title = 'Volver al leaderboard completo';
      }
    } else {
      // Cambiar a "ver top"
      await renderLeaderboard();
      showingMyContext = false;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üéØ Mi contexto';
        btnShowMyContext.title = 'Ver mi contexto en el ranking';
      }
    }
  }

  async function renderLeaderboard() {
    // Obtener filtros seleccionados
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    console.log('Filtros seleccionados - Grupo:', selectedGroup, 'Pa√≠s:', selectedCountry); // Debug
    
    // Modo documental: filtros y ordenamientos se aplican localmente
    const filteredLeaderboard = await fetchLeaderboard(selectedGroup, selectedCountry);
    console.log('Leaderboard ficticio:', filteredLeaderboard); // Debug
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      let message = 'No hay usuarios';
      if (selectedGroup) message += ` en el grupo ${selectedGroup}`;
      if (selectedCountry) message += ` en ${selectedCountry}`;
      if (!selectedGroup && !selectedCountry) message = 'No recib√≠ nada';
      
      document.getElementById('leaderboardTable').innerHTML = `<div class="text-center text-slate-400 py-4">${message}<br><span class='text-xs break-all text-yellow-400'>JWT: ${jwtToken}</span></div>`;
      return;
    }
    
    // El backend ya incluye al usuario actual y maneja el ordenamiento
    const currentUser = window.username || (window.jwtTokenUser || null);
    
    renderLeaderboardTable(filteredLeaderboard, currentUser, false);
    
    // Eventos para los filtros
    const countryFilterEl2 = document.getElementById('leaderboardCountryFilter');
    if (countryFilterEl2) countryFilterEl2.onchange = renderLeaderboard;
    
    const groupFilterEl2 = document.getElementById('leaderboardGroupFilter');
    if (groupFilterEl2) groupFilterEl2.onchange = renderLeaderboard;
  }

  // Funciones utilitarias para el leaderboard
  function countryToEmoji(country) {
    switch((country||'').toLowerCase()) {
      case 'argentina': return 'üá¶üá∑';
      case 'm√©xico': return 'üá≤üáΩ';
      case 'espa√±a': return 'üá™üá∏';
      case 'chile': return 'üá®üá±';
      case 'colombia': return 'üá®üá¥';
      case 'per√∫': return 'üáµüá™';
      case 'uruguay': return 'üá∫üáæ';
      case 'ecuador': return 'üá™üá®';
      case 'bolivia': return 'üáßüá¥';
      case 'venezuela': return 'üáªüá™';
      case 'paraguay': return 'üáµüáæ';
      case 'costa rica': return 'üá®üá∑';
      case 'panam√°': return 'üáµüá¶';
      case 'estados unidos': return 'üá∫üá∏';
      case 'portugal': return 'üáµüáπ';
      case 'francia': return 'üá´üá∑';
      case 'guatemala': return 'üá¨üáπ';
      case 'honduras': return 'üá≠üá≥';
      case 'el salvador': return 'üá∏üáª';
      case 'nicaragua': return 'üá≥üáÆ';
      case 'puerto rico': return 'üáµüá∑';
      case 'cuba': return 'üá®üá∫';
      case 'rep√∫blica dominicana': return 'üá©üá¥';
      case 'china': return 'üá®üá≥';
      default: return 'üåé';
    }
  }
  
  function groupToDisplay(group) {
    switch(group || '') {
      case 'N1': return 'üî¥ N1';
      case 'N2': return 'üü† N2';
      case 'N3': return 'üü° N3';
      case 'N4': return 'üü¢ N4';
      case 'N5': return 'üîµ N5';
      case 'S': return '‚≠ê S';
      case 'HSK3': return 'üèÆ HSK3';
      case 'No': return '‚ùå No';
      default: return '‚ö´ ‚Äî';
    }
  }
  
  function renderLeaderboardTable(users, currentUser, isContextView) {
    const headerText = isContextView ? 'Mi contexto en el ranking' : 'Leaderboard completo';
    let html = `<table class="min-w-[320px] w-full text-xs sm:text-sm bg-slate-900 rounded-xl overflow-hidden" style="border: 3px solid #ffa726;">`;
    
    if (isContextView) {
      html += `<caption class="text-center text-blue-400 font-bold py-2 text-sm sm:text-base">${headerText}</caption>`;
    }
    
    html += `<thead><tr class="bg-slate-800 text-yellow-400">
      <th class="py-1 px-1 text-xs sm:text-sm">#</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Usuario</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Pa√≠s</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Grupo</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Niv</th>
      <th class="py-1 px-1 text-xs sm:text-sm">XP</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Conoc</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Racha</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Score</th>
    </tr></thead><tbody>`;
    
    users.forEach((u)=>{
      const score = calcScore(u);
      const known = Array.isArray(u.knownChars) ? u.knownChars.filter(c=>c.known).length : (u.knownCharsCount || 0);
      const lvl = u.level || (typeof getCurrentLevel==='function' ? getCurrentLevel(u.xp||0) : '-');
      
      // Resaltar usuario actual siempre en amarillo
      const isCurrentUser = u.username === currentUser;
      const highlightClass = isCurrentUser ? 'bg-yellow-100 text-black font-bold' : '';
      
      html += `<tr${highlightClass ? ` class="${highlightClass}"` : ''}>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.rank}</td>
        <td class="py-1 px-1 text-xs sm:text-sm max-w-[60px] sm:max-w-none truncate">${u.username}${isCurrentUser && isContextView ? ' üë§' : ''}</td>
        <td class="py-1 px-1 text-center text-xs">${countryToEmoji(u.country)}</td>
        <td class="py-1 px-1 text-center text-xs">${groupToDisplay(u.group)}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${lvl}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.xp||0}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${known}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.streak||0}</td>
        <td class="py-1 px-1 text-center font-bold text-xs sm:text-sm">${u.totalScore || score}</td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    
    if (isContextView) {
      html += '<div class="text-center mt-2">' +
              '<button id="btnBackToFullLeaderboard" class="px-3 py-1 rounded bg-gray-600 hover:bg-gray-500 text-white text-xs">' +
              '‚Üê Volver al leaderboard completo</button></div>';
    }
    
    document.getElementById('leaderboardTable').innerHTML = html;
    
    // Agregar evento para volver al leaderboard completo
    if (isContextView) {
      const btnBack = document.getElementById('btnBackToFullLeaderboard');
      if (btnBack) btnBack.onclick = renderLeaderboard;
    }
  }
  
  const btnReload = document.getElementById('btnReloadLeaderboard');
  if (btnReload) btnReload.onclick = renderLeaderboard;
  const btnStar = document.getElementById('btnStarLeaderboard');
  if (btnStar) btnStar.onclick = renderLeaderboard;
  
  // Agregar evento para bot√≥n de contexto
  const btnShowMyContext = document.getElementById('btnShowMyContext');
  if (btnShowMyContext) btnShowMyContext.onclick = toggleLeaderboardView;

  // --- Funcionalidad para cambiar grupo ---
  async function changeUserGroup(group) {
    // Versi√≥n documental: sin backend.
    await renderLeaderboard();
    showGroupChangeMessage(group);
  }

  function showGroupChangeMessage(group) {
    let msg = document.getElementById('groupChangeMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'groupChangeMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-2xl shadow-lg text-sm font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      document.body.appendChild(msg);
    }
    
    const groupDisplay = {
      'N1': 'üî¥ N1',
      'N2': 'üü† N2', 
      'N3': 'üü° N3',
      'N4': 'üü¢ N4',
      'N5': 'üîµ N5',
      'S': '‚≠ê S',
      'HSK3': 'üèÆ HSK3',
      'No': '‚ùå No'
    }[group] || group;
    
    msg.textContent = `Grupo cambiado a: ${groupDisplay}`;
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 2000);
  }

  // Manejar selector de grupo
  window.addEventListener('DOMContentLoaded', function() {
    const btnChangeGroup = document.getElementById('btnChangeGroup');
    const groupSelector = document.getElementById('groupSelector');
    
    if(btnChangeGroup && groupSelector) {
      btnChangeGroup.onclick = (e) => {
        e.stopPropagation();
        groupSelector.style.display = groupSelector.style.display === 'none' ? 'flex' : 'none';
      };
      
      // Cerrar selector al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!groupSelector.contains(e.target) && e.target !== btnChangeGroup) {
          groupSelector.style.display = 'none';
        }
      });
      
      // Manejar selecci√≥n de grupo
      const groupOptions = document.querySelectorAll('.group-option');
      groupOptions.forEach(option => {
        option.onclick = async (e) => {
          e.stopPropagation();
          const selectedGroup = option.getAttribute('data-group');
          await changeUserGroup(selectedGroup);
          groupSelector.style.display = 'none';
        };
      });
    }
  });
 
   // --- Logout button handler ---
   window.addEventListener('DOMContentLoaded', function() {
     var btnLogout = document.getElementById('btnLogout');
     if (btnLogout) {
       btnLogout.onclick = function() {
         localStorage.removeItem('jwtToken');
         jwtToken = null;
         location.reload();
       };
     }
     
     // Agregar evento para bot√≥n de contexto
     const btnShowMyContext = document.getElementById('btnShowMyContext');
     if (btnShowMyContext) {
       btnShowMyContext.onclick = toggleLeaderboardView;
     }
   });
  window.addEventListener('DOMContentLoaded', renderLeaderboard);
  // Backend sync system
  let xpPoints = 0;
  // ...existing code...
  let unlockedUnits = [];
  let nivel2Unlocked = false;
  let nivel3Unlocked = false;
  // MODO DOCUMENTAL: acceso total (sin requisitos ni bloqueos)
  const ALL_HOROSCOPE_CATEGORIES = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
  // MAESTRO DEL HOR√ìSCOPO - Ultimate Challenge
  let horoscopeMaster = false;
  let horoscopeMasterAt = null;
  let ultimateChallengeCompletedCount = 0;
  
  // DESAF√çO N3 COMPLETADO
  let desafioN3Completed = false;
  let desafioN3CompletedAt = null;
  let streak = 0;
  let lastChallengeAt = null;
  let jwtToken = null;
  
  // Array separado para badges del hor√≥scopo (no se mezclan con cards)
  let horoscopeBadges = [];

  // === SISTEMA AVANZADO DE OPTIMIZACI√ìN DE IM√ÅGENES ===
  const imageCache = new Map();
  const preloadQueue = new Set();
  const imageLoadTimes = new Map();
  let isSlowConnection = false;
  let networkQuality = 'good';

  // Detectar calidad de conexi√≥n
  if ('connection' in navigator) {
    const conn = navigator.connection;
    isSlowConnection = conn.effectiveType === 'slow-2g' || 
                      conn.effectiveType === '2g' ||
                      conn.saveData;
    networkQuality = conn.effectiveType || 'unknown';
    console.log(`üåê Conexi√≥n: ${networkQuality}, SaveData: ${conn.saveData}`);
  }

  // Funci√≥n optimizada de carga con cache y fallbacks
  function preloadImage(src) {
    if (imageCache.has(src)) {
      return Promise.resolve(imageCache.get(src));
    }
    
    if (preloadQueue.has(src)) {
      return new Promise((resolve) => {
        const checkCache = () => {
          if (imageCache.has(src)) {
            resolve(imageCache.get(src));
          } else {
            setTimeout(checkCache, 10);
          }
        };
        checkCache();
      });
    }
    
    preloadQueue.add(src);
    const startTime = performance.now();
    
    return new Promise((resolve, reject) => {
      const img = new Image();
      
      // Optimizaciones de carga
      img.loading = 'eager';
      img.decoding = 'async';
      img.crossOrigin = 'anonymous';
      
      img.onload = () => {
        const loadTime = performance.now() - startTime;
        imageCache.set(src, img);
        imageLoadTimes.set(src, loadTime);
        preloadQueue.delete(src);
        
        console.log(`‚ö° ${src.split('/').pop()} cargado en ${loadTime.toFixed(2)}ms`);
        resolve(img);
      };
      
      img.onerror = () => {
        preloadQueue.delete(src);
        console.warn(`‚ùå Error: ${src}`);
        
        // Fallback autom√°tico WebP ‚Üí PNG
        if (src.includes('.webp')) {
          const pngSrc = src.replace('.webp', '.png');
          console.log(`üîÑ Fallback PNG: ${pngSrc}`);
          
          const fallbackImg = new Image();
          fallbackImg.onload = () => {
            imageCache.set(src, fallbackImg);
            resolve(fallbackImg);
          };
          fallbackImg.onerror = () => reject(new Error(`Fallback failed: ${src}`));
          fallbackImg.src = pngSrc;
        } else {
          reject(new Error(`Failed: ${src}`));
        }
      };
      
      img.src = src;
    });
  }

  // Preload inteligente por prioridades
  function preloadCriticalImages() {
    const images = [
      { src: 'img/master.webp', priority: 1 },
      { src: 'img/fuerte.png', priority: 1 },
      { src: 'img/rata1.webp', priority: 2 },
      { src: 'img/gallo1.webp', priority: 2 },
      { src: 'img/conejo1.webp', priority: 2 },
      { src: 'img/cerdo1.webp', priority: 3 },
      { src: 'img/perro1.webp', priority: 3 },
      { src: 'img/caballo1.webp', priority: 3 }
    ];
    
    const maxConcurrent = isSlowConnection ? 2 : 4;
    const delay = isSlowConnection ? 200 : 50;
    
    // Agrupar por prioridad
    const groups = {};
    images.forEach(img => {
      if (!groups[img.priority]) groups[img.priority] = [];
      groups[img.priority].push(img.src);
    });
    
    // Cargar por grupos de prioridad
    Object.keys(groups).sort().forEach((priority, groupIndex) => {
      setTimeout(() => {
        const group = groups[priority];
        for (let i = 0; i < group.length; i += maxConcurrent) {
          const batch = group.slice(i, i + maxConcurrent);
          batch.forEach((src, index) => {
            setTimeout(() => {
              preloadImage(src).catch(err => console.warn('Preload failed:', err));
            }, index * 25);
          });
        }
      }, groupIndex * delay);
    });
    
    console.log(`üñºÔ∏è Iniciando preload (${networkQuality})`);
  }

  // Preload secundario diferido
  function preloadSecondaryImages() {
    const secondaryImages = [
      'img/vaca1.webp',
      'img/cabra1.webp', 
      'img/serpiente1.webp',
      'img/mono1.webp',
      'img/tigre1.webp',
      'img/dragon1.webp'
    ];
    
    setTimeout(() => {
      secondaryImages.forEach((src, index) => {
        setTimeout(() => {
          preloadImage(src).catch(err => console.warn('Secondary preload failed:', err));
        }, index * (isSlowConnection ? 200 : 100));
      });
      console.log('üñºÔ∏è Preload secundario iniciado');
    }, isSlowConnection ? 5000 : 2000);
  }

  // Funci√≥n para usar cache en asignaciones de im√°genes
  function setImageFromCache(element, src, fallbackSrc = null) {
    if (!element) return Promise.reject(new Error('Element not found'));
    
    // Usar cache si est√° disponible
    if (imageCache.has(src)) {
      const cachedImg = imageCache.get(src);
      if (element.tagName === 'DIV') {
        element.style.backgroundImage = `url(${cachedImg.src})`;
      } else {
        element.src = cachedImg.src;
      }
      return Promise.resolve(cachedImg);
    }
    
    // Cargar con optimizaciones
    return preloadImage(src).then(img => {
      if (element.tagName === 'DIV') {
        element.style.backgroundImage = `url(${img.src})`;
      } else {
        element.src = img.src;
      }
      return img;
    }).catch(err => {
      if (fallbackSrc) {
        console.log(`üîÑ Using fallback for ${src}: ${fallbackSrc}`);
        return setImageFromCache(element, fallbackSrc);
      }
      throw err;
    });
  }

  // Gesti√≥n de memoria del cache
  function optimizeImageCache() {
    const maxSize = isSlowConnection ? 10 : 20;
    
    if (imageCache.size > maxSize) {
      const keep = ['img/master.webp', 'img/fuerte.png'];
      const newCache = new Map();
      
      keep.forEach(src => {
        if (imageCache.has(src)) {
          newCache.set(src, imageCache.get(src));
        }
      });
      
      // Mantener las 5 m√°s recientes
      Array.from(imageCache.keys()).slice(-5).forEach(src => {
        if (!newCache.has(src)) {
          newCache.set(src, imageCache.get(src));
        }
      });
      
      imageCache.clear();
      newCache.forEach((value, key) => imageCache.set(key, value));
      
      console.log(`üßπ Cache optimizado: ${newCache.size}/${maxSize}`);
    }
  }
  // ========== MODO DOCUMENTAL: usuario/token local ==========
  // Siempre forzar un usuario/token ficticio (sin login, sin backend)
  window.username = localStorage.getItem('username') || window.username || 'ManuShi';
  jwtToken = localStorage.getItem('jwtToken') || 'documental-local-token';
  localStorage.setItem('jwtToken', jwtToken);
  localStorage.setItem('username', window.username);
  // ==========================================================

  // Sistema de pantalla de carga
  function updateLoadingProgress(percentage, message = null) {
    const progressBar = document.getElementById('loadingProgressBar');
    const subtitle = document.querySelector('.loading-subtitle');
    
    if (progressBar) {
      progressBar.style.width = percentage + '%';
    }
    
    if (message && subtitle) {
      subtitle.textContent = message;
    }
    
    console.log(`üìä Loading progress: ${percentage}% - ${message || 'Cargando...'}`);
  }
  
  function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const gameArea = document.getElementById('gameArea');
    
    if (loadingScreen && gameArea) {
      console.log('‚úÖ Ocultando pantalla de carga y mostrando juego');
      loadingScreen.classList.add('fade-out');
      
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        gameArea.classList.remove('hidden');
      }, 500);
    }
  }

  // Inicializaci√≥n local (modo documental): no hay backend.
  // Si el usuario no tiene progreso guardado, se usan valores por defecto.
  async function initializeCharactersIfNeeded() {
    // No-op en modo documental: el contenido (datasets) ya est√° embebido y el progreso vive en localStorage.
    return;
  }

  // Cargar estado del usuario desde localStorage (modo documental)
  async function loadUserState(token) {
    updateLoadingProgress(20, 'Cargando desde localStorage...');
    jwtToken = token;

    const savedData = localStorage.getItem('macaFlashcards_userData');
    updateLoadingProgress(40, 'Procesando datos guardados...');

    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        updateLoadingProgress(60, 'Procesando tarjetas...');

        xpPoints = data.xp || 0;
        cards = data.knownChars || [];
        unlockedUnits = data.unlockedUnits || [];
        nivel2Unlocked = !!data.nivel2Unlocked;
        nivel3Unlocked = !!data.nivel3Unlocked;

        // MAESTRO DEL HOR√ìSCOPO - Ultimate Challenge
        horoscopeMaster = !!data.horoscopeMaster;
        horoscopeMasterAt = data.horoscopeMasterAt || null;
        ultimateChallengeCompletedCount = data.ultimateChallengeCompleted || 0;

        // DESAF√çO N3 COMPLETADO
        desafioN3Completed = !!data.desafioN3Completed;
        desafioN3CompletedAt = data.desafioN3CompletedAt || null;

        // Racha
        streak = data.streak || 0;
        lastChallengeAt = data.lastChallengeAt || null;

        // Hor√≥scopo
        horoscopeAnimalsUnlocked = data.horoscopeAnimals || [];

        // ‚úÖ MODO DOCUMENTAL: TODO DESBLOQUEADO (ignorar requisitos guardados)
        nivel2Unlocked = true;
        nivel3Unlocked = true;
        horoscopeAnimalsUnlocked = [...ALL_HOROSCOPE_CATEGORIES];

        console.log('üíæ Datos cargados desde localStorage');

        // üîß INICIALIZAR ESTADO PARA EVITAR ANIMACIONES FALSAS AL ABRIR "MI COLECCI√ìN"
        initializeKnownState();
      } catch (error) {
        console.error('‚ùå Error cargando datos desde localStorage:', error);
        xpPoints = 0;
        cards = [];
        unlockedUnits = [];
        nivel2Unlocked = true;
        nivel3Unlocked = true;
        streak = 0;
        lastChallengeAt = null;
        horoscopeAnimalsUnlocked = [...ALL_HOROSCOPE_CATEGORIES];
      }
    } else {
      xpPoints = 0;
      cards = [];
      
      // INICIALIZAR CARDS CON TODOS LOS DATASETS
      const allUnits = [
        ...unit2Sample(), ...unit3Sample(), ...unit4Sample(), ...unit5Sample(),
        ...unit6Sample(), ...unit7Sample(), ...unit8Sample(), ...unit9Sample(),
        ...unit1N2Sample(), ...unit2N2Sample(), ...unit3N2Sample(), ...unit4N2Sample(),
        ...unit5N2Sample(), ...unit6N2Sample(), ...unit7N2Sample(), ...unit8N2Sample(),
        ...unit9N2Sample(), ...unit1N3Sample(), ...unit2N3Sample(), ...unit3N3Sample(),
        ...unit4N3Sample(), ...unit5N3Sample(), ...unit6N3Sample(), ...unit7N3Sample(),
        ...unit8N3Sample(), ...unit9N3Sample()
      ];
      
      cards = allUnits.map((row, idx) => ({
        id: idx + 1,
        hanzi: row[0],
        pinyin: row[1],
        meaning: row[2],
        unit: row[3],
        category: row[4],
        known: false,
        revise1: false,
        revise2: false,
        dkAddedAt: null,
        challengeStreak: 0,
        challengeBest: 0,
        lastChallengeAt: null
      }));
      
      console.log('‚úÖ Cards inicializados con', cards.length, 'caracteres desde datasets');
      
      unlockedUnits = [];
      nivel2Unlocked = true;
      nivel3Unlocked = true;
      streak = 0;
      lastChallengeAt = null;
      horoscopeAnimalsUnlocked = [...ALL_HOROSCOPE_CATEGORIES];
    }

    // Asegurar UI desbloqueada (aunque alguien cambie flags despu√©s)
    try { updateHoroscopeButtonsState(); } catch (e) {}
    try { updateUltimateChallengeButton(); } catch (e) {}
    
    // Inicializar caracteres si es necesario
    updateLoadingProgress(80, 'Inicializando contenido...');
    await initializeCharactersIfNeeded();
    
    updateLoadingProgress(90, 'Finalizando carga...');
    
    // Actualizar estad√≠sticas
    setTimeout(() => {
      updateStats();
      updateLoadingProgress(100, '¬°Listo!');
      
      // Ocultar pantalla de carga despu√©s de completar
      setTimeout(() => {
        hideLoadingScreen();
      }, 800);
    }, 200);
  }

  // Completar Ultimate Challenge y convertirse en Maestro del Hor√≥scopo (Versi√≥n Documental)
  async function completeUltimateChallenge() {
    if (!jwtToken) {
      console.error('‚ùå completeUltimateChallenge: No hay jwtToken');
      return;
    }

    console.log('üéâ Completando Ultimate Challenge (Versi√≥n Documental - localStorage)');

    const isFirstTime = !horoscopeMaster;
    horoscopeMaster = true;
    ultimateChallengeCompletedCount = (ultimateChallengeCompletedCount || 0) + 1;

    if (isFirstTime) {
      horoscopeMasterAt = new Date();
      console.log('üéä ¬°Primera vez completando Ultimate Challenge!');
    }

    await saveUserState();

    return {
      success: true,
      horoscopeMaster,
      ultimateChallengeCompleted: ultimateChallengeCompletedCount,
      horoscopeMasterAt,
      isFirstTime
    };
  }

  async function saveUserState() {
    if (!jwtToken) {
      console.error('‚ùå saveUserState: No hay jwtToken');
      return;
    }

    try {
      const payload = {
        xp: xpPoints,
        knownChars: cards,
        unlockedUnits,
        nivel2Unlocked,
        nivel3Unlocked,
        streak,
        lastChallengeAt,
        horoscopeAnimals: horoscopeAnimalsUnlocked,
        // MAESTRO DEL HOR√ìSCOPO
        horoscopeMaster: horoscopeMaster,
        horoscopeMasterAt: horoscopeMasterAt,
        ultimateChallengeCompleted: ultimateChallengeCompletedCount,
        // DESAF√çO N3
        desafioN3Completed: desafioN3Completed,
        desafioN3CompletedAt: desafioN3CompletedAt
      };

      localStorage.setItem('macaFlashcards_userData', JSON.stringify(payload));
      console.log('‚úÖ Progreso guardado en localStorage');
    } catch (error) {
      console.error('‚ùå Error guardando en localStorage:', error);
    }
  }

  // Reemplazar funciones locales
  function saveXP() { saveUserState(); }
  function loadXP() { /* XP se carga con loadUserState */ }
  function xpForLevel(level) {
    // Level 1: 10, Level 2: 50, Level 3: 100, Level 4: 200, Level 5: 300, etc.
    if(level === 1) return 10;
    if(level === 2) return 50;
    if(level === 3) return 100;
    return (level - 1) * 100;
  }
  function getCurrentLevel(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    return lvl;
  }
  function getLevelProgress(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    // xpNeeded: lo que requiere este nivel
    // total: xp acumulado hasta el nivel anterior
    return {
      lvl,
      prev: total,
      next: total + xpNeeded,
      progress: xp - total,
      needed: (total + xpNeeded) - xp,
      percent: Math.max(0, Math.min(100, ((xp - total) / xpNeeded) * 100))
    };
  }
  // Colores por nivel
  const xpColors = [
    // Celeste claro ‚Üí verde claro ‚Üí naranja
    {bar:'#7dd3fc', text:'#7dd3fc', bg:'#bae6fd', glow:'#e0f2fe'}, // 1 celeste claro
    {bar:'#38bdf8', text:'#38bdf8', bg:'#a5f3fc', glow:'#bae6fd'}, // 2 celeste
    {bar:'#5eead4', text:'#5eead4', bg:'#a7f3d0', glow:'#d1fae5'}, // 3 verde agua
    {bar:'#34d399', text:'#34d399', bg:'#bbf7d0', glow:'#d1fae5'}, // 4 verde claro
    {bar:'#fbbf24', text:'#fbbf24', bg:'#fef9c3', glow:'#fde68a'}, // 5 amarillo-naranja
    {bar:'#fb923c', text:'#fb923c', bg:'#fed7aa', glow:'#fdba74'}, // 6 naranja claro
    {bar:'#f97316', text:'#f97316', bg:'#fdba74', glow:'#fb923c'}, // 7 naranja
    {bar:'#ea580c', text:'#ea580c', bg:'#fb923c', glow:'#f97316'}, // 8 naranja intenso
  ];
  let lastLevel = null;
  function renderXPBar(levelUpAnim=false) {
    const { lvl, needed, percent } = getLevelProgress(xpPoints);
    const oldPercent = parseInt(document.getElementById('xpBar').style.width) || 0;
    
    document.getElementById('xpLevel').textContent = lvl;
    document.getElementById('xpBar').style.width = percent+"%";
    document.getElementById('xpToNext').textContent = `Faltan ${needed} xp para subir Ê∞¥Âπ≥`;
    
    // Colores por nivel
    const color = xpColors[(lvl-1)%xpColors.length];
    const xpBar = document.getElementById('xpBar');
    const xpBarWrap = document.getElementById('xpBarWrap');
    const xpLevel = document.getElementById('xpLevel');
    const xpToNext = document.getElementById('xpToNext');
    
    // Aplicar color din√°mico a la barra pixel art
    xpBar.style.setProperty('--xp-bar-color', color.bar);
    
    const container = xpBarWrap.querySelector('.xp-bar-container');
    if (container) {
      container.style.borderColor = color.bar;
    }
    xpLevel.style.color = color.text;
    xpToNext.style.color = color.text;
    const xpLabel = document.getElementById('xpLabel');
    if(xpLabel) xpLabel.style.color = color.text;
    const btnResetXP = document.getElementById('btnResetXP');
    if(btnResetXP) {
      btnResetXP.style.background = '#1e293b'; // azul oscuro
      btnResetXP.style.color = '#fff';
      btnResetXP.style.borderColor = '#1e293b';
    }
    // Set CSS vars for glow
    xpBar.style.setProperty('--xp-bar', color.bar);
    xpBar.style.setProperty('--xp-glow', color.glow);
    xpBarWrap.style.setProperty('--xp-glow', color.glow);
    
    // Animaci√≥n de brillo al subir de nivel y sonido de triunfo
    if(levelUpAnim) {
      xpBar.classList.add('xp-gain');
      soundLevelUpTrumpet();
      
      // IMPORTANTE: No bloquear la funcionalidad durante level up
      setTimeout(()=>{
        xpBar.classList.remove('xp-gain');
      }, 800);
    } 
    // Animaci√≥n de ganancia de XP cuando hay avance pero NO level up
    else if (percent > oldPercent) {
      xpBar.classList.add('xp-gain');
      setTimeout(()=>{
        xpBar.classList.remove('xp-gain');
      }, 800);
      createXPParticles(color.bar);
    }
    
    lastLevel = lvl;
  }

  // Funci√≥n para crear part√≠culas de XP - BURST DIRECCIONAL
  function createXPParticles(color) {
    const xpBar = document.getElementById('xpBar');
    if (!xpBar) return;
    
    const particleCount = 8; // M√°s part√≠culas para mejor efecto burst
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'xp-particle-burst';
      particle.style.background = color;
      
      // Posici√≥n inicial: extremo derecho de la barra
      particle.style.left = '100%';
      particle.style.top = '50%';
      particle.style.marginLeft = '-2px';
      particle.style.marginTop = '-2px';
      
      // BURST DIRECCIONAL: Cono hacia arriba-derecha (momentum del progreso)
      const burstAngle = -45 + (Math.random() * 90 - 45); // -90¬∞ a 0¬∞ (cono hacia arriba-derecha)
      const velocity = 30 + Math.random() * 40; // Velocidad aleatoria 30-70px
      const angleRad = burstAngle * Math.PI / 180;
      
      // Calcular trayectoria en el cono direccional
      const finalX = Math.cos(angleRad) * velocity;
      const finalY = Math.sin(angleRad) * velocity;
      
      // Variaci√≥n adicional para naturalidad
      const scatter = 15;
      const scatterX = (Math.random() - 0.5) * scatter;
      const scatterY = (Math.random() - 0.5) * scatter;
      
      particle.style.setProperty('--burst-x', (finalX + scatterX) + 'px');
      particle.style.setProperty('--burst-y', (finalY + scatterY) + 'px');
      
      // Rotaci√≥n aleatoria para efecto din√°mico
      const rotation = Math.random() * 360;
      particle.style.setProperty('--burst-rotation', rotation + 'deg');
      
      // Scale aleatorio para variedad visual
      const scale = 0.8 + Math.random() * 0.6; // 0.8 a 1.4
      particle.style.setProperty('--burst-scale', scale);
      
      // Delay escalonado para efecto de r√°faga
      particle.style.animationDelay = (i * 20) + 'ms';
      particle.style.animation = 'xpBurstFloat 600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
      
      xpBar.appendChild(particle);
      
      // Remover part√≠cula despu√©s de la animaci√≥n
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 800);
    }
  }
  // CSS para animaci√≥n de brillo
  const xpGlowStyle = document.createElement('style');
  xpGlowStyle.textContent = `
    @keyframes softGlow {
    0%   { opacity: 1;   transform: scale(1);   }
    40%  { opacity: 0.94; transform: scale(1.03); }
    100% { opacity: 1;   transform: scale(1);   }
  }

  /* Si quer√©s conservar una SOMBRA SUAVE, dejala fija (no animada) en el elemento XP */
  .xp-halo-static {
    /* ajust√° color con --xp-glow o --xp-bar si ya las us√°s */
    box-shadow: 0 0 14px 4px var(--xp-glow, rgba(255,255,255,.5)),
                0 0 0 2px var(--xp-bar, rgba(255,255,255,.6));
  }

  /* Reemplazo de .xp-glow-anim (antes animaba box-shadow) */
  .xp-glow-anim {
    animation: softGlow 1.1s cubic-bezier(.4,2,.6,1) 1;
    will-change: transform, opacity; /* hint al compositor */
  }

  /* Reemplazo de .xp-glow-anim-bg (antes animaba filter/brightness) */
  .xp-glow-anim-bg {
    animation: softGlow 1.1s cubic-bezier(.4,2,.6,1) 1;
    will-change: transform, opacity;
  }

    /* Animaci√≥n de part√≠culas XP */
    .xp-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #0ea5e9;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
    }
    @keyframes xpParticleFloat {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(var(--particle-x, 20px), var(--particle-y, -20px)) scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: translate(var(--particle-x2, 40px), var(--particle-y2, -40px)) scale(0);
        opacity: 0;
      }
    }

    /* ========== BURST DIRECCIONAL - Nuevas part√≠culas ========== */
    .xp-particle-burst {
      position: absolute;
      width: 5px;
      height: 5px;
      background: #0ea5e9;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      box-shadow: 0 0 3px rgba(255,255,255,0.5);
    }

    @keyframes xpBurstFloat {
      0% {
        transform: translate(0, 0) scale(var(--burst-scale, 1)) rotate(0deg);
        opacity: 1;
        filter: brightness(1.5);
      }
      20% {
        transform: translate(calc(var(--burst-x, 30px) * 0.3), calc(var(--burst-y, -30px) * 0.3)) 
                  scale(calc(var(--burst-scale, 1) * 1.2)) 
                  rotate(calc(var(--burst-rotation, 90deg) * 0.3));
        opacity: 1;
        filter: brightness(1.8);
      }
      70% {
        transform: translate(calc(var(--burst-x, 30px) * 0.9), calc(var(--burst-y, -30px) * 0.9)) 
                  scale(calc(var(--burst-scale, 1) * 0.8)) 
                  rotate(calc(var(--burst-rotation, 90deg) * 0.8));
        opacity: 0.6;
        filter: brightness(1.2);
      }
      100% {
        transform: translate(var(--burst-x, 30px), var(--burst-y, -30px)) 
                  scale(0) 
                  rotate(var(--burst-rotation, 90deg));
        opacity: 0;
        filter: brightness(1);
      }
    }

    /* Animaci√≥n para botones que aparecen en m√≥vil */
    @keyframes mobileButtonFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mobile-fade-in {
      animation: mobileButtonFadeIn 300ms ease-out forwards;
    }

    @keyframes mobileButtonFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

    .mobile-fade-out {
      animation: mobileButtonFadeOut 400ms ease-in forwards;
    }
    
    /* CSS para fade-out selectivo */
    @keyframes fadeOutButtons {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.95); }
    }
    
    .quiz-fade-out {
      animation: fadeOutButtons 300ms ease-out forwards;
    }
    
    .quiz-fade-out-delayed {
      animation: fadeOutButtons 300ms ease-out forwards;
      animation-delay: 200ms;
    }
    
    /* Botones invisibles desde el inicio */
    .quiz-invisible {
      opacity: 0 !important;
      pointer-events: none;
    }

    /* Animaci√≥n para el bot√≥n parlante */
    @keyframes speakerGlow {
      0% { 
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 20px 4px rgba(34, 197, 94, 0.8), 0 0 40px 8px rgba(34, 197, 94, 0.4);
        transform: scale(1.1);
      }
      100% { 
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        transform: scale(1);
      }
    }
    
    .speaker-glow-active {
      animation: speakerGlow 600ms ease-out;
    }
    
    /* Pulso suave mientras reproduce */
    @keyframes speakerPulse {
      0%, 100% { 
        box-shadow: 0 0 15px 3px rgba(34, 197, 94, 0.6);
        transform: scale(1.05);
      }
      50% { 
        box-shadow: 0 0 25px 6px rgba(34, 197, 94, 0.9);
        transform: scale(1.08);
      }
    }

    /* Animaciones optimizadas para tarjetas m√≠ticas - Solo 2 ciclos */
    @keyframes legendaryWave {
      0% { 
        background-position: 0% 50%; 
      }
      50% { 
        background-position: 100% 50%; 
      }
      100% { 
        background-position: 0% 50%; 
      }
    }

    @keyframes legendaryPulse {
      0% {
        box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5), 0 0 0 0 rgba(255, 215, 0, 0.4);
        transform: scale(1);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), 0 0 20px 5px rgba(255, 215, 0, 0.2);
        transform: scale(1.02);
      }
    }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    @keyframes neonPulse {
      0% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ff88, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.5),
          0 0 20px rgba(0, 255, 65, 0.4),
          0 0 40px rgba(0, 255, 65, 0.2);
        border-color: #00cc33;
      }
      50% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ffaa, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.8),
          0 0 30px rgba(0, 255, 65, 0.7),
          0 0 60px rgba(0, 255, 65, 0.4),
          0 0 80px rgba(57, 255, 20, 0.3);
        border-color: #00ff55;
        transform: scale(1.02);
      }
      100% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ff88, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.5),
          0 0 20px rgba(0, 255, 65, 0.4),
          0 0 40px rgba(0, 255, 65, 0.2);
        border-color: #00cc33;
      }
    }
    
    .speaker-playing {
      animation: speakerPulse 1.2s ease-in-out infinite;
    }

    /* ---------- Mi Colecci√≥n: Grid (igual que index) ---------- */
    #knownGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100px, 22vw), 1fr));
      gap: 6px;
      pointer-events: auto !important;
      z-index: 1 !important;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .squareCell{
      aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden; white-space:nowrap; padding:10px;
      text-align:center; user-select:none;
    }

    /* ===== TRADING CARDS STYLES ===== */
    .trading-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      cursor: pointer;
      font-family: 'Jersey 10', monospace;
      overflow: hidden;
    }

    .trading-card:hover {
      transform: rotateX(5deg) rotateY(5deg) scale(1.05);
      z-index: 10;
    }

    /* Rareza Com√∫n (Streak 0-2) */
    .card-common {
      background: linear-gradient(135deg, #f3f4f6, #d1d5db);
      border: 2px solid #9ca3af;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card-common:hover {
      box-shadow: 0 8px 25px rgba(156, 163, 175, 0.4);
    }

    /* Rareza Poco Com√∫n (Streak 3-5) */
    .card-uncommon {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border: 2px solid #22c55e;
      box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
    }

    .card-uncommon:hover {
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.5);
    }

    /* Rareza Rara (Streak 6-10) */
    .card-rare {
      background: linear-gradient(135deg, #dbeafe, #93c5fd);
      border: 2px solid #3b82f6;
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      /* animation: rareShimmer 3s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .card-rare:hover {
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
    }

    /* Rareza √âpica (Streak 11-20) */
    .card-epic {
      background: linear-gradient(135deg, #f3e8ff, #c4b5fd);
      border: 2px solid #8b5cf6;
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
      /* animation: epicGlow 2s ease-in-out infinite alternate; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .card-epic:hover {
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.7);
    }

    /* Rareza Legendaria (Streak 21+) */
    .card-legendary {
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b);
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      /* animation: legendaryPulse 3.5s ease-in-out infinite alternate; - REMOVIDA PARA MEJOR RENDIMIENTO */
      position: relative;
    }

    .card-legendary:hover {
      box-shadow: 0 12px 35px rgba(217, 119, 6, 0.8);
    }

    .card-legendary::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      /* animation: legendaryBorder 5s ease infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    /* Contenido de la carta */
    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 8px;
      position: relative;
      z-index: 2;
    }

    .card-hanzi {
      font-size: clamp(20px, 4vw, 32px);
      font-weight: bold;
      color: #1f2937;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
      margin-bottom: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .card-legendary .card-hanzi {
      color: #92400e;
      text-shadow: 1px 1px 2px rgba(255, 215, 0, 0.5);
    }

    /* Badge de streak mejorado */
    .card-streak-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      min-width: 24px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      color: white;
      z-index: 3;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .card-common .card-streak-badge {
      background: #6b7280;
    }

    .card-uncommon .card-streak-badge {
      background: #16a34a;
    }

    .card-rare .card-streak-badge {
      background: #2563eb;
    }

    .card-epic .card-streak-badge {
      background: #7c3aed;
    }

    .card-legendary .card-streak-badge {
      background: linear-gradient(45deg, #dc2626, #ea580c);
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    }

    /* Badge de categor√≠a mejorado */
    .card-category-badge {
      position: absolute;
      bottom: 6px;
      left: 6px;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: bold;
      z-index: 3;
      backdrop-filter: blur(8px);
    }

    .card-common .card-category-badge {
      background: rgba(107, 114, 128, 0.8);
      color: white;
    }

    .card-uncommon .card-category-badge {
      background: rgba(22, 163, 74, 0.8);
      color: white;
    }

    .card-rare .card-category-badge {
      background: rgba(37, 99, 235, 0.8);
      color: white;
    }

    .card-epic .card-category-badge {
      background: rgba(124, 58, 237, 0.8);
      color: white;
    }

    .card-legendary .card-category-badge {
      background: rgba(220, 38, 38, 0.9);
      color: #fef3c7;
    }

    /* Animaciones */
    @keyframes rareShimmer {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes epicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      100% {
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
    }

    @keyframes legendaryPulse {
      0% {
        box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5), 0 0 0 0 rgba(255, 215, 0, 0.4);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), 0 0 20px 5px rgba(255, 215, 0, 0.2);
      }
    }

    @keyframes legendaryBorder {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Efecto de nueva carta */
    @keyframes newCardAppear {
      0% {
        transform: scale(0) rotateY(180deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) rotateY(90deg);
        opacity: 0.8;
      }
      100% {
        transform: scale(1) rotateY(0deg);
        opacity: 1;
      }
    }

    .new-card {
      animation: newCardAppear 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ===== MYTHIC HOROSCOPE CARDS - Estilo Legendario ===== */
    .card-mythic-animal {
      position: relative;
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b, #d97706, #fbbf24, #fef3c7);
      background-size: 300% 300%;
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      animation: legendaryPulse 3.5s ease-in-out 2 alternate;
      overflow: hidden;
    }

    .card-mythic-animal::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      animation: legendaryWave 4s ease-in-out 2;
    }

    .card-mythic-animal::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
      transform: translate(-50%, -50%);
      /* animation: mythicPulse 2s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
      pointer-events: none;
    }

    .card-mythic-animal:hover {
      box-shadow: 0 12px 35px rgba(217, 119, 6, 0.8);
    }

    /* Master Card - Ultra Legendaria */
    .card-ultra-master {
      position: relative;
      background: linear-gradient(135deg, #ffd700, #ffed4a, #fff8dc, #ffd700, #ff6b35, #ffd700);
      background-size: 400% 400%;
      border: 4px solid d97706;
      background-clip: padding-box;
      /* animation: masterFlow 12s ease-in-out infinite, masterRadiance 6s ease-in-out infinite alternate; - REMOVIDA */
      overflow: hidden;
    }

    .card-ultra-master::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ff0000, #ff6b35, #ffd700, #00ff00, #0099ff, #9900ff, #ff0000);
      background-size: 500% 500%;
      border-radius: 16px;
      z-index: -1;
      /* animation: masterBorder 8s linear infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .card-ultra-master::after {
      content: '‚ú®';
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      /* animation: sparkle 3s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
      pointer-events: none;
    }

    .card-ultra-master:hover {
      transform: rotateX(15deg) rotateY(15deg) scale(1.12);
      z-index: 30;
      box-shadow: 0 25px 50px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 107, 53, 0.5);
    }

    /* Badges m√≠ticos */
    .mythic-streak-badge {
      background: linear-gradient(45deg, #dc2626, #ea580c);
      color: #fff;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .master-streak-badge {
      background: linear-gradient(45deg, #ffd700, #ff6b35);
      color: #000;
      box-shadow: 0 3px 10px rgba(255, 215, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      font-weight: 900;
    }

    .mythic-category-badge {
      background: rgba(217, 119, 6, 0.9) !important;
      color: #fef3c7 !important;
      border: 1px solid rgba(255, 215, 0, 0.8);
      box-shadow: 0 2px 4px rgba(217, 119, 6, 0.3);
    }

    .master-category-badge {
      background: rgba(255, 215, 0, 0.95) !important;
      color: #8B4513 !important;
      border: 1px solid rgba(255, 107, 53, 0.8);
      box-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
      font-weight: bold;
    }

    /* Animaciones m√≠ticas */
    @keyframes mythicFlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes mythicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(217, 119, 6, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), inset 0 1px 0 rgba(255, 215, 0, 0.5);
      }
    }

    @keyframes mythicBorder {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes mythicPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.1; }
    }

    @keyframes masterFlow {
      0%, 100% { background-position: 0% 50%; }
      33% { background-position: 100% 0%; }
      66% { background-position: 0% 100%; }
    }

    @keyframes masterRadiance {
      0% {
        box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 107, 53, 0.3);
      }
      100% {
        box-shadow: 0 12px 35px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 107, 53, 0.6);
      }
    }

    @keyframes masterBorder {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    /* Estilos para modales de hor√≥scopo din√°micos - Exactamente como badges legendarios */
    .horoscope-modal-image {
      position: relative;
      display: inline-block;
      background: linear-gradient(-45deg, #fff9e0, #fcc842, #faac25, #e08f31, #ffc940, #fff9e0);
      background-size: 500% 500%;
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      /* animation: legendaryPulse 3.5s ease-in-out infinite alternate, legendaryWave 7s ease-in-out infinite; - REMOVIDA */
      border-radius: 9px;
      overflow: hidden;
    }

    .horoscope-modal-image::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      /* animation: legendaryBorder 5s ease infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .horoscope-modal-image img {
      display: block;
      border-radius: 9px;
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .horoscope-modal-container {
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b, #d97706);
      background-size: 400% 400%;
      /* animation: legendaryFlow 6s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
      border: 4px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .horoscope-modal-container::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffd700, #f59e0b, #d97706, #92400e, #ffd700);
      background-size: 300% 300%;
      border-radius: 24px;
      z-index: -1;
      /* animation: legendaryBorder 4s linear infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    @keyframes mythicFlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes mythicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(217, 119, 6, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), inset 0 1px 0 rgba(255, 215, 0, 0.5);
      }
    }

    @keyframes legendaryBorder {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes legendaryWave {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes sparkle {
      0%, 100% { transform: rotate(0deg) scale(1); opacity: 1; }
      50% { transform: rotate(180deg) scale(1.2); opacity: 0.7; }
    }
  `;
  document.head.appendChild(xpGlowStyle);
  const STORAGE_KEY = 'srs_unidades_v7_es';

  // Eliminada declaraci√≥n duplicada de cards
  let sessionQueue = [];
  let currentCard = null;
  let flipped = false;
  let todayReviewed = 0;
  let currentMission = ''; // 'unit2'..'unit9'|'known'|'revise1'|'revise2'|'challenge'
  let horoscopeAnimalsUnlocked = []; // Array de categor√≠as desbloqueadas: ['colores', 'fruta', etc.]

  // Variables para el Desaf√≠o Final
  let ultimateChallengeActive = false;
  let ultimateChallengeCards = [];
  let ultimateChallengeCurrentAnimal = '';
  let ultimateChallengeAnimalIndex = 0;
  let ultimateChallengeCardIndex = 0;
  let ultimateChallengeHearts = 3; // Sistema de vidas para Ultimate Challenge
  let ultimateChallengeTimer = 500; // Tiempo en segundos (8 min 20 seg)
  let ultimateChallengeTimerInterval = null; // Intervalo del timer
  
  // Sistema de timer y vidas para Desaf√≠os N1, N2, N3
  let desafioNActive = false;
  let desafioNTimerInterval = null;
  let desafioNTimeLeft = 120; // 2 minutos = 120 segundos
  let desafioNHearts = 3; // 3 vidas para desaf√≠os N

  // Sistema de timer2 y vidas2 para Desaf√≠os Cl√°sicos (clasico, menos, mas)
  let desafioClasico2Active = false;
  let desafioClasico2TimerInterval = null;
  let desafioClasico2TimeLeft = 90; // 1 minuto y medio = 90 segundos
  let desafioClasico2Hearts = 2; // 2 vidas para desaf√≠os cl√°sicos
  let previousKnownCount = 0; // Para detectar cambios en el contador de conocidas
  
  // Sistema de notificaciones post-desaf√≠o
  let challengeStartState = []; // Estado de cartas al iniciar desaf√≠o
  let challengeEndState = []; // Estado de cartas al finalizar desaf√≠o

  // --- Mapeo de categor√≠as del hor√≥scopo a animales chinos ---
  const horoscopeAnimals = {
    'colores': { name: 'Rata', image: 'rata1.webp', chinese: 'Èº†' },
    'fruta': { name: 'Gallo', image: 'gallo1.webp', chinese: 'È∏°' },
    'verduras': { name: 'Conejo', image: 'conejo1.webp', chinese: 'ÂÖî' },
    'comidas': { name: 'Cerdo', image: 'cerdo1.webp', chinese: 'Áå™' },
    'animales': { name: 'Perro', image: 'perro1.webp', chinese: 'Áãó' },
    'deportes': { name: 'Caballo', image: 'caballo1.webp', chinese: 'È©¨' },
    'hobbies': { name: 'Buey', image: 'vaca1.webp', chinese: 'Áâõ' },
    'ropa': { name: 'Cabra', image: 'cabra1.webp', chinese: 'Áæä' },
    'casa': { name: 'Serpiente', image: 'serpiente1.webp', chinese: 'Ëõá' },
    'cuerpo': { name: 'Mono', image: 'mono1.webp', chinese: 'Áå¥' },
    'profesiones': { name: 'Tigre', image: 'tigre1.webp', chinese: 'Ëôé' },
    'emociones': { name: 'Drag√≥n', image: 'dragon1.webp', chinese: 'Èæô' }
  };

  // Orden fijo de animales para el Desaf√≠o Final (12 animales x 5 cartas = 60 total)
  const ultimateChallengeOrder = [
    { animal: 'Rata', categoria: 'colores' },
    { animal: 'Gallo', categoria: 'fruta' },
    { animal: 'Conejo', categoria: 'verduras' },
    { animal: 'Cerdo', categoria: 'comidas' },
    { animal: 'Perro', categoria: 'animales' },
    { animal: 'Caballo', categoria: 'deportes' },
    { animal: 'Buey', categoria: 'hobbies' },
    { animal: 'Cabra', categoria: 'ropa' },
    { animal: 'Serpiente', categoria: 'casa' },
    { animal: 'Mono', categoria: 'cuerpo' },
    { animal: 'Tigre', categoria: 'profesiones' },
    { animal: 'Drag√≥n', categoria: 'emociones' }
  ];

  let sessionTotal = 0;
  let sessionCorrect = 0;
  // 'flash' | 'quizPinyin' | 'quizMeaning'
  let mode = 'flash';

  /* ========= DOM ========= */
  const bodyEl  = document.getElementById('body');
  const cardEl  = document.getElementById('card');
  const frontEl = document.getElementById('cardFront');
  const backEl  = document.getElementById('cardBack');

  const statInSession = document.getElementById('statInSession');
  const statToday     = document.getElementById('statToday');
  const statMission   = document.getElementById('statMission');
  const statBox       = document.getElementById('statBox');
  const streakBox = document.getElementById('streakBox');
  const streakCount = document.getElementById('streakCount');
  const streakStatus = document.getElementById('streakStatus');

  const flashRow = document.getElementById('flashRow');
  const quizRow  = document.getElementById('quizRow');

  const btnKnownBox   = document.getElementById('btnKnown');
  const btnRevise1Box = document.getElementById('btnRevise1');
  const btnRevise2Box = document.getElementById('btnRevise2');

  /* Overlay conocidos */
  const knownOverlay  = document.getElementById('knownOverlay');
  const knownGrid     = document.getElementById('knownGrid');
  const knownCount    = document.getElementById('knownCount');

  /* ========= Utils ========= */
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function hoursSince(ts){ if(!ts) return null; const diffMs = Date.now() - ts; return Math.floor(diffMs / 3600000); }
  function saveAll(){ saveUserState(); }
  
  /* ========= SISTEMA DE MONITOREO DE RENDIMIENTO ========= */
  let performanceMonitor = {
    memoryCheckInterval: null,
    lastMemoryCheck: 0,
    animationCount: 0,
    timerCount: 0,
    intervalCount: 0,
    
    startMonitoring() {
      console.log('üîç INICIANDO MONITOREO DE RENDIMIENTO');
      this.memoryCheckInterval = setInterval(() => {
        this.checkMemoryUsage();
        this.checkActiveAnimations();
        this.checkActiveTimers();
      }, 5000); // Cada 5 segundos
    },
    
    stopMonitoring() {
      if (this.memoryCheckInterval) {
        clearInterval(this.memoryCheckInterval);
        this.memoryCheckInterval = null;
        console.log('üîç MONITOREO DETENIDO');
      }
    },
    
    checkMemoryUsage() {
      if (performance.memory) {
        const memoryMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
        const totalMemoryMB = Math.round(performance.memory.totalJSHeapSize / 1024 / 1024);
        
        let status = '‚úÖ LEVE';
        if (memoryMB > 100) status = '‚ö†Ô∏è SOSPECHOSO';
        if (memoryMB > 200) status = 'üî• EXAGERADO';
        
        console.log(`üìä MEMORIA: ${memoryMB}MB / ${totalMemoryMB}MB - ${status}`);
        
        if (memoryMB > 150) {
          console.warn('üö® MEMORIA ALTA - Posible memory leak');
        }
      }
    },
    
    checkActiveAnimations() {
      const animations = document.getAnimations();
      this.animationCount = animations.length;
      
      let status = '‚úÖ LEVE';
      if (this.animationCount > 10) status = '‚ö†Ô∏è SOSPECHOSO';
      if (this.animationCount > 25) status = 'üî• EXAGERADO';
      
      console.log(`üé¨ ANIMACIONES ACTIVAS: ${this.animationCount} - ${status}`);
      
      if (this.animationCount > 20) {
        console.warn('üö® DEMASIADAS ANIMACIONES:', animations.map(a => a.animationName || a.id));
      }
    },
    
    checkActiveTimers() {
      // Nota: No podemos contar timers directamente, pero podemos trackear los conocidos
      const activeIntervals = [
        window.desafioNTimerInterval,
        window.desafioClasico2TimerInterval, 
        window.ultimateChallengeTimerInterval,
        this.memoryCheckInterval
      ].filter(Boolean).length;
      
      console.log(`‚è∞ INTERVALS CONOCIDOS ACTIVOS: ${activeIntervals}`);
      
      if (activeIntervals > 3) {
        console.warn('üö® M√öLTIPLES INTERVALS ACTIVOS - Posible acumulaci√≥n');
      }
    }
  };
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  
  /* ========= SISTEMA INTELIGENTE DE OPCIONES ========= */
  
  // Detectar n√∫mero de s√≠labas en pinyin
  function getSyllableCount(pinyin) {
    if (!pinyin) return 1;
    return pinyin.trim().split(/\s+/).length;
  }
  
  // Generar opciones inteligentes basadas en s√≠labas y contexto
  function generateSmartOptions(correctCard, availablePool, debugMode = true) {
    const targetSyllables = getSyllableCount(correctCard.pinyin);
    const strategy = Math.random() < 0.5 ? 'unit' : 'category';
    
    if (debugMode) {
      console.log(`üéØ SMART OPTIONS DEBUG:
        Tarjeta: ${correctCard.hanzi} (${correctCard.pinyin}) - ${targetSyllables} s√≠labas
        Estrategia: ${strategy}
        Pool disponible: ${availablePool.length} opciones
        Unidad: ${correctCard.unit}, Categor√≠a: ${correctCard.cat}`);
    }
    
    // PASO 1: Filtrar por n√∫mero de s√≠labas (ESTRICTO)
    let sameSyllablePool = availablePool.filter(card => 
      card.hanzi !== correctCard.hanzi && 
      getSyllableCount(card.pinyin) === targetSyllables
    );
    
    if (debugMode) {
      console.log(`üìä Palabras de ${targetSyllables} s√≠labas: ${sameSyllablePool.length}`);
    }
    
    // PASO 2: Si hay muy pocas de la misma cantidad de s√≠labas, usar fallback
    if (targetSyllables >= 3 && sameSyllablePool.length < 3) {
      // Para 3+ s√≠labas, mezclar con 2 s√≠labas
      const twoSyllablePool = availablePool.filter(card => 
        card.hanzi !== correctCard.hanzi && 
        getSyllableCount(card.pinyin) === 2
      );
      sameSyllablePool = [...sameSyllablePool, ...twoSyllablePool];
      
      if (debugMode) {
        console.log(`üîÑ Fallback aplicado: agregando palabras de 2 s√≠labas. Total: ${sameSyllablePool.length}`);
      }
    }
    
    if (sameSyllablePool.length < 3) {
      if (debugMode) {
        console.log(`‚ö†Ô∏è Pool insuficiente, usando opciones aleatorias`);
      }
      // Fallback extremo: usar cualquier opci√≥n disponible
      return shuffle(availablePool.filter(card => card.hanzi !== correctCard.hanzi))
        .slice(0, 3)
        .map(card => ({
          ...card,
          debugInfo: `${getSyllableCount(card.pinyin)}syl-fallback`
        }));
    }
    
    // PASO 3: Aplicar estrategia elegida
    let contextualOptions = [];
    let randomOptions = [];
    
    if (strategy === 'unit') {
      // Estrategia por UNIDAD/TEM√ÅTICA
      contextualOptions = sameSyllablePool.filter(card => 
        card.unit === correctCard.unit
      );
      if (debugMode) {
        console.log(`üìö Opciones de misma unidad (${correctCard.unit}): ${contextualOptions.length}`);
      }
    } else {
      // Estrategia por CATEGOR√çA GRAMATICAL
      contextualOptions = sameSyllablePool.filter(card => 
        card.cat === correctCard.cat
      );
      if (debugMode) {
        console.log(`üî§ Opciones de misma categor√≠a (${correctCard.cat}): ${contextualOptions.length}`);
      }
    }
    
    // Preparar opciones aleatorias (del pool de s√≠labas correctas)
    randomOptions = sameSyllablePool.filter(card => 
      !contextualOptions.some(ctx => ctx.hanzi === card.hanzi)
    );
    
    // PASO 4: Seleccionar 2 contextuales + 1 aleatoria
    const selectedContextual = shuffle([...contextualOptions]).slice(0, 2);
    const selectedRandom = shuffle([...randomOptions]).slice(0, 1);
    
    const finalOptions = [
      ...selectedContextual.map(card => ({
        ...card,
        debugInfo: `${getSyllableCount(card.pinyin)}syl-${strategy}`
      })),
      ...selectedRandom.map(card => ({
        ...card,
        debugInfo: `${getSyllableCount(card.pinyin)}syl-random`
      }))
    ];
    
    // Si no tenemos suficientes, completar con aleatorias
    while (finalOptions.length < 3 && randomOptions.length > 0) {
      const extraRandom = randomOptions.shift();
      if (!finalOptions.some(opt => opt.hanzi === extraRandom.hanzi)) {
        finalOptions.push({
          ...extraRandom,
          debugInfo: `${getSyllableCount(extraRandom.pinyin)}syl-extra`
        });
      }
    }
    
    if (debugMode) {
      console.log(`‚úÖ Opciones finales generadas:`, 
        finalOptions.map(opt => `${opt.hanzi}(${opt.pinyin})-${opt.debugInfo}`));
    }
    
    return finalOptions.slice(0, 3);
  }
  
  // Funci√≥n espec√≠fica para Ultimate Challenge (SIEMPRE estrategia tem√°tica)
  function generateSmartOptionsUltimate(correctCard, availablePool, field, debugMode = true) {
    const targetSyllables = getSyllableCount(correctCard.pinyin);
    
    if (debugMode) {
      console.log(`üèÜ ULTIMATE CHALLENGE SMART OPTIONS:
        Tarjeta: ${correctCard.hanzi} (${correctCard.pinyin}) - ${targetSyllables} s√≠labas
        Estrategia: TEM√ÅTICA (unit) - FORZADA
        Pool disponible: ${availablePool.length} opciones
        Unidad: ${correctCard.unit}
        Campo: ${field}`);
    }
    
    // PASO 1: Filtrar por n√∫mero de s√≠labas (ESTRICTO)
    let sameSyllablePool = availablePool.filter(card => 
      getSyllableCount(card.pinyin) === targetSyllables
    );
    
    if (debugMode) {
      console.log(`üìä Ultimate Challenge - Palabras de ${targetSyllables} s√≠labas: ${sameSyllablePool.length}`);
    }
    
    // PASO 2: Fallback si hay pocas de 3+ s√≠labas
    if (targetSyllables >= 3 && sameSyllablePool.length < 3) {
      const twoSyllablePool = availablePool.filter(card => 
        getSyllableCount(card.pinyin) === 2
      );
      sameSyllablePool = [...sameSyllablePool, ...twoSyllablePool];
      
      if (debugMode) {
        console.log(`üîÑ Ultimate Challenge - Fallback aplicado: agregando 2 s√≠labas. Total: ${sameSyllablePool.length}`);
      }
    }
    
    if (sameSyllablePool.length < 3) {
      if (debugMode) {
        console.log(`‚ö†Ô∏è Ultimate Challenge - Pool insuficiente, usando opciones aleatorias`);
      }
      return shuffle(availablePool)
        .slice(0, 3)
        .map(card => card[field])
        .filter(val => val);
    }
    
    // PASO 3: ESTRATEGIA TEM√ÅTICA FORZADA (por unidad)
    let contextualOptions = sameSyllablePool.filter(card => 
      card.unit === correctCard.unit
    );
    
    if (debugMode) {
      console.log(`üé® Ultimate Challenge - Opciones de misma tem√°tica (${correctCard.unit}): ${contextualOptions.length}`);
    }
    
    // Opciones aleatorias (del pool de s√≠labas correctas, pero diferentes tem√°ticas)
    let randomOptions = sameSyllablePool.filter(card => 
      card.unit !== correctCard.unit
    );
    
    // PASO 4: Seleccionar 2 tem√°ticas + 1 aleatoria (o lo que est√© disponible)
    const selectedContextual = shuffle([...contextualOptions]).slice(0, 2);
    const selectedRandom = shuffle([...randomOptions]).slice(0, 1);
    
    let finalOptions = [
      ...selectedContextual.map(card => card[field]),
      ...selectedRandom.map(card => card[field])
    ].filter(val => val);
    
    // Completar con opciones aleatorias si falta
    while (finalOptions.length < 3 && sameSyllablePool.length > 0) {
      const extraCard = sameSyllablePool.shift();
      const extraValue = extraCard[field];
      if (extraValue && !finalOptions.includes(extraValue)) {
        finalOptions.push(extraValue);
      }
    }
    
    if (debugMode) {
      console.log(`‚úÖ Ultimate Challenge - Opciones finales:`, 
        finalOptions.map((opt, i) => `${opt}(${getSyllableCount(correctCard.pinyin)}syl-${i < 2 ? 'tem√°tica' : 'aleatorio'})`));
    }
    
    return finalOptions.slice(0, 3);
  }
  
  function dedupeByHanzi(rows){
    const seen = new Set(); const out = [];
    for(const r of rows){ const key = r[0]; if(seen.has(key)) continue; seen.add(key); out.push(r); }
    return out;
  }

  /* ========= Audio (WebAudio) ========= */

  // Pool de audio para sonidos correctos (m√∫ltiples instancias)
  let correctSoundPool = [];
  let poolIndex = 0;
  const POOL_SIZE = 3;

  // Inicializar pool de sonidos
  function initCorrectSoundPool() {
    correctSoundPool = [];
    for(let i = 0; i < POOL_SIZE; i++) {
      try {
        const audio = new Audio('music/soundcorrect.mp3');
        audio.volume = 0.4;
        audio.preload = 'auto';
        correctSoundPool.push(audio);
      } catch(e) {
        console.log('Error creando audio pool:', e);
        break;
      }
    }
    console.log(`Pool de audio correcto inicializado: ${correctSoundPool.length} instancias`);
  }

  // Obtener pr√≥xima instancia de audio del pool
  function getNextCorrectSound() {
    if(correctSoundPool.length === 0) {
      console.log('Pool vac√≠o, reinicializando...');
      initCorrectSoundPool();
      if(correctSoundPool.length === 0) return null;
    }
    const sound = correctSoundPool[poolIndex];
    poolIndex = (poolIndex + 1) % correctSoundPool.length;
    return sound;
  }

  // Reinicializar pool si hay problemas
  function refreshCorrectSoundPool() {
    console.log('Refrescando pools de audio...');
    correctSoundPool = [];
    poolIndex = 0;
    celebrationSoundPool = [];
    celebrationSoundIndex = 0;
    initCorrectSoundPool();
    initCelebrationSoundPool();
    initCongratulationSoundPool();
  }

  /* ========= M√∫sica de fondo para modo desaf√≠o ========= */
  let desafioMusic = null;
  function playDesafioMusic(desafioType = null) {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
    }
    
    // Seleccionar track y volumen seg√∫n el tipo de desaf√≠o
    let trackFile = 'music/track1ok.mp3'; // Default para challenge y desaf√≠o cl√°sico
    let volume = 0.5; // Volumen por defecto para track1
    
    if (desafioType === 'desafioN1') {
      trackFile = 'music/track4.mp3';
      volume = 0.6;
    } else if (desafioType === 'desafioN2') {
      trackFile = 'music/track2.mp3';
      volume = 0.6;
    } else if (desafioType === 'desafioN3') {
      trackFile = 'music/track3.mp3';
      volume = 0.6;
    } else if (desafioType === 'ultimateChallenge') {
      trackFile = 'music/trackchin1.mp3';
      volume = 0.8;
    } else if (desafioType && desafioType.includes && desafioType.includes('desafioHoroscopo-')) {
      // Desaf√≠os del hor√≥scopo por categor√≠a espec√≠fica
      const categoria = desafioType.replace('desafioHoroscopo-', '');
      
      // Grupo 1: trackchin2 - Rata, Gallo, Conejo, Cerdo
      if (['colores', 'fruta', 'verduras', 'comidas'].includes(categoria)) {
        trackFile = 'music/trackchin2.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria}: usando trackchin2`);
      }
      // Grupo 2: trackchin3 - Perro, Caballo, Buey, Cabra  
      else if (['animales', 'deportes', 'hobbies', 'ropa'].includes(categoria)) {
        trackFile = 'music/trackchin3.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria}: usando trackchin3`);
      }
      // Grupo 3: trackchin1 - Serpiente, Mono, Tigre, Drag√≥n
      else if (['casa', 'cuerpo', 'profesiones', 'emociones'].includes(categoria)) {
        trackFile = 'music/trackchin1.mp3';
        volume = 0.7;
        console.log(`üéµ Desaf√≠o ${categoria}: usando trackchin1`);
      }
      else {
        // Fallback para desaf√≠os del hor√≥scopo sin categor√≠a espec√≠fica
        trackFile = 'music/trackchin2.mp3';
        volume = 0.5;
        console.log(`üéµ Desaf√≠o hor√≥scopo gen√©rico: usando trackchin2`);
      }
    } else if (desafioType === 'desafioHoroscopo') {
      // Fallback para llamadas gen√©ricas del hor√≥scopo
      trackFile = 'music/trackchin2.mp3';
      volume = 0.5;
    }
    
    desafioMusic = new Audio(trackFile);
    desafioMusic.loop = true;
    desafioMusic.volume = volume;
    desafioMusic.play();
  }
  function stopDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
      desafioMusic = null;
    }
    // üßπ LIMPIAR COUNTDOWN AL PARAR LA M√öSICA
    cleanupCountdown();
  }
  
  // ================== BADGES LEGENDARIOS SIN ANIMACI√ìN ==================
  // Las animaciones de badges legendarios fueron removidas para mejor rendimiento
  // Los badges mantienen su est√©tica dorada pero sin consumir recursos de CPU
  
  // ================== FUNCIONES DE VIDEO DE FONDO ==================
  let challengeVideoElement = null;
  
  function createChallengeVideo(challengeType = 'default') {
    // Si ya existe, no crear otro
    if (challengeVideoElement) return;
    
    challengeVideoElement = document.createElement('video');
    
    // Seleccionar el video seg√∫n el tipo de desaf√≠o
    let videoSrc = 'img/fondodesafio.mp4'; // Video por defecto
    
    switch(challengeType) {
      case 'desafioN1':
        videoSrc = 'img/fondon1.mp4';
        break;
      case 'desafioN2':
        videoSrc = 'img/fondo2.mp4';
        break;
      case 'desafioN3':
        videoSrc = 'img/fondon3.mp4';
        break;
      case 'desafioHoroscopo':
        videoSrc = 'img/animal.mp4';
        break;
      case 'ultimateChallenge':
        videoSrc = 'img/animal.mp4';
        break;
      case 'challenge':
      default:
        videoSrc = 'img/fondodesafio.mp4'; // Video por defecto
        break;
    }
    
    challengeVideoElement.src = videoSrc;
    challengeVideoElement.className = 'challenge-video-bg';
    challengeVideoElement.autoplay = true;
    challengeVideoElement.loop = true;
    challengeVideoElement.muted = true; // Para evitar problemas de autoplay
    challengeVideoElement.playsInline = true; // Para m√≥viles
    
    // Insertar el video al body
    document.body.appendChild(challengeVideoElement);
    
    console.log(`üé¨ Video de fondo de desaf√≠o creado: ${videoSrc}`);
  }
  
  // ================== SISTEMA DE PRECARGA DE VIDEOS ==================
  
  // Variables para controlar cu√°ndo pueden iniciarse los timers
  let preloadingChallenge = false;
  let pendingTimerCallbacks = [];
  let countdownInterval = null;
  let countdownActive = false;
  
  function getVideoSrc(challengeType) {
    switch(challengeType) {
      case 'desafioN1':
        return 'img/fondon1.mp4';
      case 'desafioN2':
        return 'img/fondo2.mp4';
      case 'desafioN3':
        return 'img/fondon3.mp4';
      case 'desafioHoroscopo':
        return 'img/animal.mp4';
      case 'ultimateChallenge':
        return 'img/animal.mp4';
      case 'challenge':
      default:
        return 'img/fondodesafio.mp4';
    }
  }
  
  function showVideoPreloader(challengeType) {
    const preloader = document.getElementById('videoPreloader');
    const progressBar = document.getElementById('preloadProgress');
    
    preloader.style.display = 'flex';
    progressBar.style.width = '0%';
    
    return new Promise((resolve, reject) => {
      // Crear elemento de video para precarga
      const video = document.createElement('video');
      const videoSrc = getVideoSrc(challengeType);
      
      video.src = videoSrc;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.preload = 'auto';
      
      let progressInterval;
      
      // Simular progreso de carga
      progressInterval = setInterval(() => {
        const currentProgress = parseInt(progressBar.style.width) || 0;
        if (currentProgress < 90) {
          progressBar.style.width = Math.min(currentProgress + Math.random() * 15, 90) + '%';
        }
      }, 200);
      
      // Cuando el video est√© listo
      video.addEventListener('canplaythrough', () => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        // Mostrar cuenta regresiva despu√©s de cargar
        setTimeout(() => {
          showCountdown(challengeType).then(() => {
            preloader.style.display = 'none';
            resolve(video);
          });
        }, 500);
      });
      
      // Manejo de errores
      video.addEventListener('error', () => {
        clearInterval(progressInterval);
        // Mostrar cuenta regresiva aunque haya error
        showCountdown(challengeType).then(() => {
          preloader.style.display = 'none';
          console.error('Error cargando video:', videoSrc);
          reject(new Error('Error cargando video'));
        });
      });
      
      // Timeout de seguridad (10 segundos para carga + 4 segundos para countdown)
      setTimeout(() => {
        if (preloader.style.display !== 'none') {
          clearInterval(progressInterval);
          // Mostrar cuenta regresiva aunque sea timeout
          showCountdown().then(() => {
            preloader.style.display = 'none';
            console.log('Timeout de carga de video, continuando sin video');
            resolve(null);
          });
        }
      }, 10000);
    });
  }
  
  function showCountdown(challengeType = null) {
    return new Promise((resolve) => {
      // üõ°Ô∏è PREVENIR M√öLTIPLES EJECUCIONES
      if (countdownActive) {
        console.log('‚ö†Ô∏è Countdown ya est√° activo, ignorando llamada duplicada');
        return resolve();
      }
      
      countdownActive = true;
      console.log('üöÄ Iniciando countdown √∫nico para:', challengeType);
      
      const preloaderContent = document.querySelector('.preloader-content');
      const countdownContent = document.getElementById('countdownContent');
      const countdownNumber = document.getElementById('countdownNumber');
      
      // Ocultar contenido de carga y mostrar countdown
      preloaderContent.style.display = 'none';
      countdownContent.style.display = 'block';
      
      // Aplicar fuente Jersey 10 con estilo pixel
      countdownNumber.style.fontFamily = 'Jersey 10, monospace';
      countdownNumber.style.fontSize = '8rem';
      countdownNumber.style.fontWeight = 'bold';
      countdownNumber.style.letterSpacing = '4px';
      countdownNumber.style.textShadow = '0 0 20px rgba(74, 222, 128, 0.8), 4px 4px 0px rgba(0, 0, 0, 0.8)';
      
      let count = 3;
      countdownNumber.textContent = count;
      
      // ‚ú® INICIAR M√öSICA SOLO UNA VEZ CUANDO COMIENZA EL CONTEO
      if (challengeType && !desafioMusic) {
        console.log('üéµ Iniciando m√∫sica √∫nica para:', challengeType);
        playDesafioMusic(challengeType);
      } else if (desafioMusic) {
        console.log('üéµ M√∫sica ya est√° reproduci√©ndose, no reiniciar');
      }
      
      countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownNumber.textContent = count;
          // Reiniciar animaci√≥n
          countdownNumber.style.animation = 'none';
          setTimeout(() => {
            countdownNumber.style.animation = 'countdownPulse 0.5s ease-in-out';
          }, 10);
        } else {
          // üßπ LIMPIAR COMPLETAMENTE EL COUNTDOWN
          clearInterval(countdownInterval);
          countdownInterval = null;
          
          // Mostrar "¬°GO!" brevemente
          countdownNumber.textContent = 'ÂºÄÂßã';
          countdownNumber.style.color = '#4ade80';
          countdownNumber.style.animation = 'countdownPulse 0.5s ease-in-out';
          
          setTimeout(() => {
            // Restaurar estado original para pr√≥ximas veces
            preloaderContent.style.display = 'block';
            countdownContent.style.display = 'none';
            countdownNumber.style.color = '#ffffff';
            countdownNumber.style.fontFamily = '';
            countdownNumber.style.fontSize = '';
            countdownNumber.style.letterSpacing = '';
            countdownNumber.style.textShadow = '';
            
            // üîí MARCAR COUNTDOWN COMO TERMINADO
            countdownActive = false;
            console.log('‚úÖ Countdown completado y limpiado');
            
            resolve();
          }, 600);
        }
      }, 700); // ‚è±Ô∏è 0.7 segundos en lugar de 1 segundo
    });
  }
  
  async function createChallengeVideoWithPreload(challengeType = 'default', onReadyCallback = null) {
    // Marcar que estamos precargando
    preloadingChallenge = true;
    
    // Si ya existe, no crear otro
    if (challengeVideoElement) {
      // Si ya existe el video, ejecutar callback inmediatamente
      preloadingChallenge = false;
      executePendingTimers();
      if (onReadyCallback) onReadyCallback();
      return true;
    }
    
    try {
      // Mostrar preloader y esperar a que el video cargue
      const preloadedVideo = await showVideoPreloader(challengeType);
      
      if (preloadedVideo) {
        challengeVideoElement = preloadedVideo;
        challengeVideoElement.className = 'challenge-video-bg';
        challengeVideoElement.autoplay = true;
        
        document.body.appendChild(challengeVideoElement);
        challengeVideoElement.play();
        
        console.log(`üé¨ Video de fondo precargado y listo: ${getVideoSrc(challengeType)}`);
        
        // Marcar que la precarga termin√≥ y ejecutar timers pendientes
        preloadingChallenge = false;
        executePendingTimers();
        
        // Ejecutar callback despu√©s de que el video est√© listo
        if (onReadyCallback) onReadyCallback();
        
        return true;
      } else {
        console.log('üé¨ Continuando sin video de fondo');
        
        // Marcar que la precarga termin√≥ aunque no haya video
        preloadingChallenge = false;
        executePendingTimers();
        
        // Ejecutar callback aunque no haya video
        if (onReadyCallback) onReadyCallback();
        
        return false;
      }
    } catch (error) {
      console.error('Error en precarga de video:', error);
      
      // Marcar que la precarga termin√≥ aunque haya error
      preloadingChallenge = false;
      executePendingTimers();
      
      // Ejecutar callback aunque haya error
      if (onReadyCallback) onReadyCallback();
      
      return false;
    }
  }
  
  function executePendingTimers() {
    console.log(`üéØ Ejecutando ${pendingTimerCallbacks.length} timers pendientes`);
    const callbacks = [...pendingTimerCallbacks];
    pendingTimerCallbacks = [];
    callbacks.forEach(callback => callback());
  }
  
  function cleanupCountdown() {
    // üßπ FUNCI√ìN DE LIMPIEZA COMPLETA DEL COUNTDOWN
    if (countdownInterval) {
      console.log('üßΩ Limpiando countdown interval activo');
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    countdownActive = false;
    console.log('üîí Countdown limpiado y desbloqueado');
  }
  
  function removeChallengeVideo() {
    if (challengeVideoElement) {
      challengeVideoElement.pause();
      challengeVideoElement.remove();
      challengeVideoElement = null;
      console.log('üé¨ Video de fondo de desaf√≠o removido');
    }
  }
  
  // Funci√≥n helper para limpiar todos los temas de desaf√≠o
  function clearAllChallengeThemes() {
    const bodyEl = document.querySelector('body');
    const statBox = document.getElementById('statBox');
    if(bodyEl) {
      bodyEl.classList.remove('challenge-bg', 'challenge-n2-bg', 'challenge-n3-bg', 'horoscope-bg');
    }
    if(statBox) {
      statBox.classList.remove('challenge-stat', 'challenge-n2-stat', 'challenge-n3-stat');
    }
    // Remover video de fondo si existe
    removeChallengeVideo();
  }
  function beep(freq=440, duration=0.12, type='sine', gain=0.05){
    ensureAudio(); // Activar AudioContext si est√° suspendido
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    o.stop(audioCtx.currentTime + duration);
  }
  
  // Contador global para beeps secuenciales
  let currentBeepIndex = 0;

  // 10 diferentes composiciones de beep satisfactorias para desaf√≠os m√≥viles
  function playSequentialChallengeBeep() {
    const beepPatterns = [
      // Beep 6: Acordes r√°pidos
      () => {
        // Acorde C mayor
        beep(523, 0.08, 'sine', 0.2);       // C5
        beep(659, 0.08, 'sine', 0.2);       // E5
        beep(784, 0.08, 'sine', 0.2);       // G5
        setTimeout(() => {
          // Acorde F mayor
          beep(698, 0.12, 'sine', 0.3);     // F5
          beep(880, 0.12, 'sine', 0.3);     // A5
          beep(1047, 0.12, 'sine', 0.3);    // C6
        }, 120);
      },
    ];
    
    // Reproducir el beep actual seg√∫n el √≠ndice
    beepPatterns[currentBeepIndex]();
    
    // Incrementar √≠ndice para el pr√≥ximo beep (circular)
    currentBeepIndex = (currentBeepIndex + 1) % 10;
    
    console.log(`üéµ Reproduciendo beep de desaf√≠o #${currentBeepIndex === 0 ? 10 : currentBeepIndex} en m√≥vil`);
  }

  async function soundCorrect(){
    // Detectar si estamos en m√≥vil
    const isMobile = window.innerWidth <= 768;
    
    // Si es m√≥vil, usar siempre el beep #6 (Acordes r√°pidos)
    if (isMobile) {
      // Beep #6: Acordes r√°pidos - C mayor ‚Üí F mayor
      beep(523, 0.08, 'sine', 0.2);       // C5
      beep(659, 0.08, 'sine', 0.2);       // E5
      beep(784, 0.08, 'sine', 0.2);       // G5
      setTimeout(() => {
        // Acorde F mayor
        beep(698, 0.12, 'sine', 0.3);     // F5
        beep(880, 0.12, 'sine', 0.3);     // A5
        beep(1047, 0.12, 'sine', 0.3);    // C6
      }, 120);

      return;
    }
    
    // Si es desktop, usar el sonido normal
    // Usar pool de audio para m√°xima confiabilidad
    const sound = getNextCorrectSound();
    if (sound) {
      try {
        sound.currentTime = 0; // Reiniciar si ya estaba reproduci√©ndose
        sound.play().catch(e => {
          console.log('Error con audio del pool, intentando con nueva instancia:', e);
          // Intentar crear nueva instancia si falla
          try {
            const newAudio = new Audio('music/soundcorrect.mp3');
            newAudio.volume = 0.4;
            newAudio.play().catch(() => {
              // Fallback final a sonido sint√©tico
              beep(1397, 0.11, 'triangle', 0.16); // F6
              beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
            });
          } catch(e2) {
            // Fallback inmediato
            beep(1397, 0.11, 'triangle', 0.16); // F6
            beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
          }
        });
      } catch(e) {
        // Fallback inmediato
        beep(1397, 0.11, 'triangle', 0.16); // F6
        beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
      }
    } else {
      // Si no hay pool disponible, fallback inmediato
      beep(1397, 0.11, 'triangle', 0.16); // F6
      beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
    }
  }

  // Pool de audios para celebraci√≥n (similar al de correcto)
  let celebrationSoundPool = [];
  let celebrationSoundIndex = 0;
  
  // Pool de sonidos de felicitaci√≥n (feichanghao, feichangbang, etc.)
  let congratulationSoundPool = [];
  let congratulationSoundIndex = 0;
  const congratulationSounds = ['feichanghao.mp3', 'feichangbang.mp3', 'niubi.mp3', 'tebiehao.mp3'];
  
  function initCelebrationSoundPool() {
    celebrationSoundPool = [];
    for(let i = 0; i < 3; i++) {
      try {
        const audio = new Audio('music/complete.mp3');
        audio.volume = 0.5; // Volumen un poco m√°s alto para celebraci√≥n
        audio.preload = 'auto';
        celebrationSoundPool.push(audio);
      } catch(e) {
        console.log('Error creando audio de celebraci√≥n:', e);
      }
    }
  }
  
  function initCongratulationSoundPool() {
    congratulationSoundPool = [];
    // Crear m√∫ltiples instancias de cada sonido de felicitaci√≥n
    congratulationSounds.forEach(soundFile => {
      for(let i = 0; i < 2; i++) {
        try {
          const audio = new Audio(`music/${soundFile}`);
          audio.preload = 'auto';
          audio.volume = 0.6;
          congratulationSoundPool.push(audio);
        } catch(e) {
          console.log(`Error creando audio ${soundFile}:`, e);
        }
      }
    });
    congratulationSoundIndex = 0;
  }

  // Sonido de celebraci√≥n para x/x correctas
  function soundCelebration(){
    try {
      // Inicializar pools si no existen
      if(celebrationSoundPool.length === 0) {
        initCelebrationSoundPool();
      }
      if(congratulationSoundPool.length === 0) {
        initCongratulationSoundPool();
      }
      
      // Reproducir complete.mp3
      const completeAudio = celebrationSoundPool[celebrationSoundIndex];
      celebrationSoundIndex = (celebrationSoundIndex + 1) % celebrationSoundPool.length;
      
      if(completeAudio) {
        completeAudio.currentTime = 0;
        completeAudio.play().catch(e => {
          console.log('Error reproduciendo complete.mp3:', e);
        });
      }
      
      // Reproducir uno de los sonidos de felicitaci√≥n al azar
      const randomIndex = Math.floor(Math.random() * congratulationSounds.length);
      const congratulationFile = congratulationSounds[randomIndex];
      
      // Buscar una instancia disponible de ese sonido
      const availableAudio = congratulationSoundPool.find(audio => 
        audio.src.includes(congratulationFile) && (audio.paused || audio.ended)
      );
      
      if(availableAudio) {
        availableAudio.currentTime = 0;
        // Peque√±o delay para que no se superpongan completamente
        setTimeout(() => {
          availableAudio.play().catch(e => {
            console.log(`Error reproduciendo ${congratulationFile}:`, e);
          });
        }, 200);
      }
      
    } catch(e) {
      console.log('Error en soundCelebration:', e);
      fallbackCelebrationSound();
    }
  }
  
  function fallbackCelebrationSound() {
    // Sonido sint√©tico de respaldo
    beep(523, 0.14, 'triangle', 0.19); // C5
    setTimeout(() => beep(659, 0.13, 'triangle', 0.17), 60); // E5
    setTimeout(() => beep(784, 0.13, 'triangle', 0.15), 120); // G5
    setTimeout(() => beep(1046, 0.11, 'triangle', 0.13), 180); // C6
    setTimeout(() => beep(1568, 0.09, 'triangle', 0.11), 240); // G6
    setTimeout(() => beep(2093, 0.18, 'triangle', 0.13), 320); // C7
  }
  function soundWrong(){
    // Efecto digital tipo "fart" corto
    // Secuencia descendente y distorsionada
    ensureAudio(); // Activar AudioContext si est√° suspendido
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(110, audioCtx.currentTime);
  o.frequency.linearRampToValueAtTime(55, audioCtx.currentTime + 0.18);
  g.gain.setValueAtTime(0.108, audioCtx.currentTime); // -40%
  g.gain.linearRampToValueAtTime(0.006, audioCtx.currentTime + 0.18); // -40%
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.19);
    // "pop" final
  setTimeout(() => beep(70, 0.07, 'triangle', 0.038), 170); // -40%
  }

  // Datasets de caracteres (igual que en frontend)
function unit2Sample() {
  return [
    ['‰∏Ä','yƒ´','uno','unit2','S'],
    ['‰∫å','√®r','dos','unit2','S'],
    ['‰∏â','sƒÅn','tres','unit2','S'],
    ['Âõõ','s√¨','cuatro','unit2','S'],
    ['‰∫î','w«î','cinco','unit2','S'],
    ['ÂÖ≠','li√π','seis','unit2','S'],
    ['‰∏É','qƒ´','siete','unit2','S'],
    ['ÂÖ´','bƒÅ','ocho','unit2','S'],
    ['‰πù','ji«î','nueve','unit2','S'],
    ['ÂçÅ','sh√≠','diez','unit2','S'],
    ['Ë∞¢Ë∞¢','xi√® xie','gracias','unit2','E'],
    ['‰∏çÂÆ¢Ê∞î','b√∫ k√® qi','de nada','unit2','E'],
    ['ÂØπ‰∏çËµ∑','du√¨ bu q«ê','perd√≥n / lo siento','unit2','E'],
    ['Ê≤°ÂÖ≥Á≥ª','m√©i guƒÅn x√¨','no pasa nada','unit2','E'],
    ['Â§ßÂÆ∂Â•Ω','d√† jiƒÅ h«éo','hola a todos','unit2','E'],
  ];
}

function unit3Sample() {
  return [
    ['‰Ω†','n«ê','t√∫','unit3','P'],
    ['Êàë','w«í','yo','unit3','P'],
    ['ÊòØ','sh√¨','ser','unit3','V'],
    ['Âæà','hƒõn','muy','unit3','E'],
    ['È´òÂÖ¥','gƒÅo x√¨ng','contento / feliz','unit3','A'],
    ['ËÆ§ËØÜ','r√®n shi','conocer','unit3','V'],
    ['Âë¢','ne','part√≠cula de seguimiento','unit3','E'],
    ['Âêó','ma','part√≠cula interrogativa','unit3','E'],
    ['‰πü','yƒõ','tambi√©n','unit3','E'],
    ['ÊÇ®','n√≠n','usted (formal)','unit3','P'],
    ['ÂñúÊ¨¢','x«ê huan','gustar','unit3','V'],
    ['Â≠¶','xu√©','aprender / estudiar','unit3','V'],
    ['Ê±âËØ≠','h√†n y«î','chino (idioma)','unit3','S'],
    ['Â≠¶Áîü','xu√© sheng','estudiante','unit3','S'],
    ['ËÄÅÂ∏à','l«éo shƒ´','profesor','unit3','S'],
    ['ÂÜçËßÅ','z√†i ji√†n','adi√≥s','unit3','E'],
  ];
}

function unit4Sample() {
  return [
    ['Âè´','ji√†o','llamarse / llamar','unit4','V'],
    ['‰ªÄ‰πà','sh√©n me','qu√©','unit4','E'],
    ['ÂêçÂ≠ó','m√≠ng zi','nombre','unit4','S'],
    ['Â§öÂ§ß','du≈ç d√†','qu√© edad / cu√°n grande','unit4','E'],
    ['Â≤Å','su√¨','a√±os (de edad)','unit4','S'],
    ['‰∫∫','r√©n','persona / gente','unit4','S'],
    ['‰∏≠ÂõΩ','Zh≈çng gu√≥','China','unit4','S'],
    ['‰∏ç','b√π','no (negaci√≥n)','unit4','E'],
    ['Âì™','n«é','cu√°l (de) / qu√© lugar','unit4','E'],
  ];
}

function unit5Sample() {
  return [
    ['ÊÉ≥','xi«éng','querer / pensar','unit5','V'],
    ['ÂêÉ','chƒ´','comer','unit5','V'],
    ['ÂÅö','zu√≤','hacer','unit5','V'],
    ['È•≠','f√†n','comida','unit5','S'],
    ['Âñù','hƒì','beber','unit5','V'],
    ['Ëå∂','ch√°','t√©','unit5','S'],
    ['Ê∞¥','shu«ê','agua','unit5','S'],
    ['ÂíñÂï°','kƒÅ fƒìi','caf√© (bebida)','unit5','S'],
    ['ËØ¥','shu≈ç','hablar / decir','unit5','V'],
    ['Âî±','ch√†ng','cantar','unit5','V'],
    ['Ê≠å','gƒì','canci√≥n','unit5','S'],
    ['Áúã','k√†n','ver / mirar','unit5','V'],
    ['‰π¶','sh≈´','libro','unit5','S'],
    ['ÁîµÂΩ±','di√†n y«êng','pel√≠cula','unit5','S'],
    ['ÁîµËßÜÂâß','di√†n sh√¨ j√π','serie de TV','unit5','S'],
    ['Âê¨','tƒ´ng','escuchar','unit5','V'],
    ['Èü≥‰πê','yƒ´n yu√®','m√∫sica','unit5','S'],
    ['ËßÜÂ±è','sh√¨ p√≠n','v√≠deo','unit5','S'],
    ['‰Ωú‰∏ö','zu√≤ y√®','tarea','unit5','S'],
  ];
}

function unit6Sample() {
  return [
    ['‰ªñ','tƒÅ','√©l','unit6','P'],
    ['Â•π','tƒÅ','ella','unit6','P'],
    ['‰ª¨','men','sufijo plural','unit6','E'],
    ['Ë∞Å','sh√©i','qui√©n','unit6','E'],
    ['ÁöÑ','de','part√≠cula posesiva','unit6','E'],
    ['ÊúãÂèã','p√©ng you','amigo / amiga','unit6','S'],
    ['Áî∑','n√°n','hombre / masculino','unit6','S'],
    ['Â•≥','n«ö','mujer / femenino','unit6','S'],
    ['Â•≥ÊúãÂèã','n«ö p√©ng you','novia','unit6','S'],
    ['Áî∑ÊúãÂèã','n√°n p√©ng you','novio','unit6','S'],
    ['Áà∏Áà∏','b√† ba','pap√°','unit6','S'],
    ['Â¶àÂ¶à','mƒÅ ma','mam√°','unit6','S'],
    ['Âì•Âì•','gƒì ge','hermano mayor','unit6','S'],
    ['ÂºüÂºü','d√¨ di','hermano menor','unit6','S'],
    ['ÂßêÂßê','jiƒõ jie','hermana mayor','unit6','S'],
    ['Â¶πÂ¶π','m√®i mei','hermana menor','unit6','S'],
    ['ÂÑøÂ≠ê','√©r zi','hijo (var√≥n)','unit6','S'],
    ['Â•≥ÂÑø','n«ö √©r','hija','unit6','S'],
    ['Â∏Ö','shu√†i','guapo','unit6','A'],
    ['ÊºÇ‰∫Æ','pi√†o liang','bonita / guapa','unit6','A'],
    ['ËÅ™Êòé','c≈çng ming','inteligente','unit6','A'],
    ['ËÄÅÂÖ¨','l«éo g≈çng','esposo','unit6','S'],
    ['ËÄÅÂ©Ü','l«éo po','esposa','unit6','S']
  ];
}

function unit7Sample() {
  return [
    ['ÁâπÂà´','t√® bi√©','especialmente / muy','unit7','E'],
    ['ÈùûÂ∏∏','fƒìi ch√°ng','muy / much√≠simo','unit7','E'],
    ['ËßâÂæó','ju√© de','creer / opinar / sentir que','unit7','V'],
    ['ÊÄé‰πàÊ†∑','zƒõn me y√†ng','qu√© tal','unit7','E'],
    ['Â•ΩÁúã','h«éo k√†n','bonito (de ver)','unit7','A'],
    ['Â•ΩÂêÉ','h«éo chƒ´','rico (de comer)','unit7','A'],
    ['Â•ΩÂê¨','h«éo tƒ´ng','agradable de o√≠r','unit7','A'],
    ['ÊúâÊÑèÊÄù','y«íu y√¨ si','interesante','unit7','A'],
    ['Ëøô','zh√®','este / esta','unit7','P'],
    ['ÈÇ£','n√†','ese / esa / aquel','unit7','P'],
    ['‰∏™','g√®','clasificador general','unit7','E'],
    ['Êú¨','bƒõn','clasificador de libros','unit7','E'],
    ['È¶ñ','sh«íu','clasificador de canciones','unit7','E'],
    ['ÊùØ','bƒìi','clasificador: vaso / taza','unit7','E'],
    ['‰∏§','li«éng','dos','unit7','E'],
  ];
}

function unit8Sample() {
  return [
    ['‰∏∫‰ªÄ‰πà','w√®i sh√©n me','por qu√©','unit8','E'],
    ['Âõ†‰∏∫','yƒ´n w√®i','porque','unit8','E'],
    ['ÊºîÂëò','y«én yu√°n','actor / actriz','unit8','S'],
    ['Ê≠åÊâã','gƒì sh«íu','cantante','unit8','S'],
    ['ÁΩëÁ∫¢','w«éng h√≥ng','influencer','unit8','S'],
    ['ÂèØÁà±','kƒõ √†i','tierno / adorable','unit8','A'],
    ['ÊúâÂêç','y«íu m√≠ng','famoso','unit8','A'],
    ['Êµ™Êº´','l√†ng m√†n','rom√°ntico','unit8','A'],
    ['ÊÑüÂä®‰∫∫','g«én d√≤ng r√©n','conmovedor','unit8','A'],
    ['Ê£í','b√†ng','genial','unit8','A'],
    ['ÈÖ∑','k√π','cool','unit8','A'],
    ['Êúâ','y«íu','haber / tener','unit8','V'],
    ['Âíå','h√©','y (conjunci√≥n)','unit8','E'],
    ['Ê≤°','m√©i','no hay / no tener','unit8','E'],
    ['Âè™','zhƒ´','clasif de mascota','unit8','E'],
    ['Áãó','g«íu','perro','unit8','S'],
    ['Áå´','mƒÅo','gato','unit8','S'],
    ['‰∏ë','ch«íu','feo','unit8','A'],
    ['ÁÅ´','hu«í','fuego','unit8','S'],
  ];
}

function unit9Sample() {
  return [
    ['Âú®','z√†i','estar / en','unit9','V'],
    ['ÂÆ∂','jiƒÅ','casa / hogar','unit9','S'],
    ['Â≠¶Ê†°','xu√© xi√†o','escuela','unit9','S'],
    ['ÁîµÂΩ±Èô¢','di√†n y«êng yu√†n','cine','unit9','S'],
    ['ÂïÜÂ∫ó','shƒÅng di√†n','tienda','unit9','S'],
    ['ÂíñÂï°Â∫ó','kƒÅ fƒìi di√†n','cafeter√≠a','unit9','S'],
    ['È•≠Â∫ó','f√†n di√†n','restaurante / hotel','unit9','S'],
    ['Ë∂ÖÂ∏Ç','chƒÅo sh√¨','supermercado','unit9','S'],
    ['ÂÖ¨Âõ≠','g≈çng yu√°n','parque','unit9','S'],
    ['Â∑•‰Ωú','g≈çng zu√≤','trabajar / trabajo','unit9','V'],
    ['‰π∞','m«éi','comprar','unit9','V'],
    ['‰∏úË•ø','d≈çng xƒ´','cosas / objetos','unit9','S'],
    ['ËøôÂÑø','zh√®r','aqu√≠','unit9','P'],
    ['ÈÇ£ÂÑø','n√†r','all√≠','unit9','P'],
    ['Âì™ÂÑø','n«ér','d√≥nde','unit9','E'],
    ['ÊâãÊú∫','sh«íu jƒ´','tel√©fono m√≥vil','unit9','S'],
    ['ÁîµËÑë','di√†n n«éo','computadora','unit9','S'],
    ['Ê∞¥Êûú','shu«ê gu«í','fruta','unit9','S'],
    ['ÂåªÈô¢','yƒ´ yu√†n','hospital','unit9','S'],
    ['‰Ωè','zh√π','vivir','unit9','V'],
  ];
}

// Nivel 2
function unit1N2Sample() {
  return [
    ['Êó©‰∏ä','z«éo shang','ma√±ana','unit1N2','S'],
    ['‰∏äÂçà','sh√†ng w«î','media ma√±ana','unit1N2','S'],
    ['‰∏ãÂçà','xi√† w«î','tarde','unit1N2','S'],
    ['Êôö‰∏ä','w«én shang','noche','unit1N2','S'],
    ['‰∏≠Âçà','zh≈çng w«î','mediod√≠a','unit1N2','S'],
    ['‰ªäÂ§©','jƒ´n tiƒÅn','hoy','unit1N2','S'],
    ['ÊòéÂ§©','m√≠ng tiƒÅn','ma√±ana (d√≠a siguiente)','unit1N2','S'],
    ['Áé∞Âú®','xi√†n z√†i','ahora','unit1N2','S'],
    ['‰∏Ä‰ºöÂÑø','y√≠ hu√¨r','un rato','unit1N2','S'],
    ['Âá†ÁÇπ','j«ê di«én','qu√© hora','unit1N2','E'],
    ['Âçä','b√†n','media','unit1N2','S'],
    ['ÂàÜ','fƒìn','minuto','unit1N2','S'],
    ['Áù°Ëßâ','shu√¨ ji√†o','dormir','unit1N2','V'],
    ['‰ªÄ‰πàÊó∂ÂÄô','sh√©n me sh√≠ hou','cu√°ndo','unit1N2','E']
  ];
}

function unit2N2Sample() {
  return [
    ['Â§öÂ∞ë','du≈ç shao','cu√°nto','unit2N2','E'],['Èí±','qi√°n','dinero','unit2N2','S'],['ÊÉ≥Ë¶Å','xi«éng y√†o','querer','unit2N2','V'],['ËØ∑ÈóÆ','q«êng w√®n','disculpe','unit2N2','P'],['ÂùóÈí±','ku√†i qi√°n','yuan','unit2N2','S'],['ÂÖÉ','yu√°n','yuan','unit2N2','S'],['Áôæ','b«éi','cien','unit2N2','S'],['Ë¥µ','gu√¨','caro','unit2N2','A'],['‰æøÂÆú','pi√°n yi','barato','unit2N2','A'],['ÁâõÂ•∂','ni√∫ n«éi','leche','unit2N2','S'],['Â•∂Ëå∂','n«éi ch√°','t√© con leche','unit2N2','S'],['ËØ∑ÂÆ¢','q«êng k√®','invitar','unit2N2','V'],['ËßÅ','ji√†n','ver','unit2N2','V'],['ÂºÄÂßã','kƒÅi sh«ê','empezar','unit2N2','V'],['Âéª','q√π','ir','unit2N2','V'],['ÂõûÂÆ∂','hu√≠ jiƒÅ','volver a casa','unit2N2','V'],['Âêß','ba','part√≠cula sugerencia','unit2N2','P'],['ÁªøËå∂','l«ú ch√°','t√© verde','unit2N2','S'],['Á∫¢Ëå∂','h√≥ng ch√°','t√© rojo','unit2N2','S']
  ];
}

function unit3N2Sample() {
  return [
    ['ÊØî','b«ê','comparar','unit3N2','V'],['ÊØîËæÉ','b«ê ji√†o','comparar','unit3N2','V'],['‰∏âÊòéÊ≤ª','sƒÅn m√≠ng zh√¨','s√°ndwich','unit3N2','S'],['ËõãÁ≥ï','d√†n gƒÅo','pastel','unit3N2','S'],['Èù¢ÂåÖ','mi√†n bƒÅo','pan','unit3N2','S'],['ÁÇπÂøÉ','di«én xƒ´n','snack','unit3N2','S'],['‰∏ÄÊ†∑','y√≠ y√†ng','igual','unit3N2','A'],['È´ò','gƒÅo','alto','unit3N2','A'],['ÁüÆ','«éi','bajo','unit3N2','A'],['Â§ß','d√†','grande','unit3N2','A'],['Â∞è','xi«éo','peque√±o','unit3N2','A']
  ];
}

function unit4N2Sample() {
  return [
    ['Âπ¥','ni√°n','a√±o','unit4N2','S'],['Êúà','yu√®','mes','unit4N2','S'],['Âè∑','h√†o','n√∫mero','unit4N2','S'],['Êó•','r√¨','d√≠a','unit4N2','S'],['ÊòüÊúüÂ§©','xƒ´ng qƒ´ tiƒÅn','domingo','unit4N2','S'],['ÊòüÊúüÂÖ≠','xƒ´ng qƒ´ li√π','s√°bado','unit4N2','S'],['Âë®Êú´','zh≈çu m√≤','fin de semana','unit4N2','S'],['ÊòüÊúü','xƒ´ng qƒ´','semana','unit4N2','S'],['ÊòüÊúüÂá†','xƒ´ng qƒ´ j«ê','qu√© d√≠a de la semana','unit4N2','E'],['Âá†Êúà','j«ê yu√®','qu√© mes','unit4N2','E'],['Âá†Âè∑','j«ê h√†o','qu√© n√∫mero','unit4N2','E'],['‰ªäÂπ¥','jƒ´n ni√°n','este a√±o','unit4N2','S'],['ÊòéÂπ¥','m√≠ng ni√°n','el a√±o que viene','unit4N2','S'],['‰∏ã‰∏™','xi√† ge','el siguiente','unit4N2','P'],['ÁîüÊó•','shƒìng r√¨','cumplea√±os','unit4N2','S'],['Âø´‰πê','ku√†i l√®','feliz','unit4N2','A'],['Á©∫','k√≤ng','libre','unit4N2','A'],['Á•ù‰Ω†','zh√π n«ê','te deseo','unit4N2','V']
  ];
}

function unit5N2Sample() {
  return [
    ['Ë∑ü','gƒìn','con','unit5N2','P'],['‰∏ÄËµ∑','y√¨ q«ê','juntos','unit5N2','P'],['ËÆ°Âàí','j√¨ hu√†','plan','unit5N2','S'],['ÊúâÁ©∫','y«íu k√≤ng','tener tiempo libre','unit5N2','A'],['Êù•','l√°i','venir','unit5N2','V'],['Ê≤°ÊúâÁ©∫','m√©i y«íu k√≤ng','no tener tiempo','unit5N2','A']
  ];
}

function unit6N2Sample() {
  return [
    ['ÂæÆ‰ø°','wƒìi x√¨n','WeChat','unit6N2','S'],
    ['‰ø°ÊÅØ','x√¨n xƒ´','mensaje','unit6N2','S'],
    ['Âèë','fƒÅ','enviar','unit6N2','V'],
    ['Âè∑Á†Å','h√†o m«é','n√∫mero','unit6N2','S'],
    ['ÁîµËØù','di√†n hu√†','tel√©fono','unit6N2','S'],
    ['ÊâìÁîµËØù','d«é di√†n hu√†','llamar por tel√©fono','unit6N2','V'],
    ['Áªô','gƒõi','dar','unit6N2','V'],
    ['ÊâãÊú∫Âè∑Á†Å','sh«íu jƒ´ h√†o m«é','n√∫mero de m√≥vil','unit6N2','S'],
    ['ÂΩì','dƒÅng','ser','unit6N2','V'],
    ['ÂèØ‰ª•','kƒõ y«ê','poder','unit6N2','V'],
    ['Èõ∂','l√≠ng','cero','unit6N2','S'],
    ['Âπ∫','yƒÅo','uno (en n√∫meros)','unit6N2','S']
  ];
}

function unit7N2Sample() {
  return [
    ['ÈÉΩ','d≈çu','todos','unit7N2','P'],
    ['Áü•ÈÅì','zhƒ´ d√†o','saber','unit7N2','V'],
    ['‰ºö','hu√¨','saber (habilidad)','unit7N2','V'],
    ['‰∏ÄÁÇπÂÑø','y√¨ di«én er','un poco','unit7N2','S'],
    ['‰∏Ä‰∫õ','y√¨ xiƒì','algunos','unit7N2','S'],
    ['ÂºÄËΩ¶','kƒÅi chƒì','conducir','unit7N2','V'],
    ['Áî®','y√≤ng','usar','unit7N2','V'],
    ['Âï§ÈÖí','p√≠ ji«î','cerveza','unit7N2','S'],
    ['Á∫¢ÈÖí','h√≥ng ji«î','vino tinto','unit7N2','S'],
    ['ÁôΩÈÖí','b√°i ji«î','licor blanco','unit7N2','S'],
    ['È•ø','√®','hambriento','unit7N2','A'],
    ['Ê∏¥','kƒõ','sediento','unit7N2','A'],
    ['Á¥Ø','l√®i','cansado','unit7N2','A'],
    ['ÊÄï','p√†','tener miedo','unit7N2','A'],
    ['ÁîüÊ∞î','shƒìngq√¨','enojado','unit7N2','A']
  ];
}

function unit8N2Sample() {
  return [
    ['Ê°åÂ≠ê','zhu≈ç zi','mesa','unit8N2','S'],['‰∏äÈù¢','sh√†ng mi√†n','encima','unit8N2','P'],['‰∏ãÈù¢','xi√†mi√†n','debajo','unit8N2','P'],['Ê§ÖÂ≠ê','y«êzi','silla','unit8N2','S'],['ÂâçÈù¢','qi√°nmi√†n','delante','unit8N2','P'],['ÂêéÈù¢','h√≤umi√†n','detr√°s','unit8N2','P'],['‰π¶ÂåÖ','sh≈´bƒÅo','mochila','unit8N2','S'],['ÈáåÈù¢','l«êmi√†n','dentro','unit8N2','P'],['Â§ñÈù¢','w√†imi√†n','fuera','unit8N2','P'],['ÂØπÈù¢','du√¨mi√†n','enfrente','unit8N2','P'],['Â∑¶Ëæπ','zu«íbiƒÅn','izquierda','unit8N2','P'],['Âè≥Ëæπ','y√≤ubiƒÅn','derecha','unit8N2','P'],['ÊóÅËæπ','p√°ngbiƒÅn','al lado','unit8N2','P'],['ÁõíÂ≠ê','h√©zi','caja','unit8N2','S']
  ];
}

function unit9N2Sample() {
  return [
    ['Â§©Ê∞î','tiƒÅn q√¨','clima','unit9N2','S'],['ÂÜ∑','lƒõng','fr√≠o','unit9N2','A'],['ÁÉ≠','r√®','calor','unit9N2','A'],['Êò®Â§©','zu√≥ tiƒÅn','ayer','unit9N2','S'],['‰∏çÂÜ∑‰∏çÁÉ≠','b√π lƒõng b√π r√®','ni fr√≠o ni calor','unit9N2','A'],['Â§™‰∫Ü','t√†i le','demasiado','unit9N2','A'],['Âåó‰∫¨','Bƒõi jƒ´ng','Beijing','unit9N2','S'],['‰∏äÊµ∑','Sh√†ng h«éi','Shanghai','unit9N2','S'],['ÂπøÂ∑û','Gu«éngzh≈çu','Guangzhou','unit9N2','S'],['È¶ôÊ∏Ø','XiƒÅngg«éng','Hong Kong','unit9N2','S'],['ËΩ¶','chƒì','auto','unit9N2','S'],['ÂÖ¨ÂÖ±Ê±ΩËΩ¶','g≈çngg√≤ng q√¨chƒì','autob√∫s','unit9N2','S'],['Âú∞ÈìÅ','d√¨tiƒõ','metro','unit9N2','S'],['ÁÅ´ËΩ¶','hu«íchƒì','tren','unit9N2','S'],['Âá∫ÁßüËΩ¶','ch≈´z≈´chƒì','taxi','unit9N2','S'],['Êª¥Êª¥','Dƒ´dƒ´','Didi (app)','unit9N2','S'],['È£ûÊú∫','fƒìijƒ´','avi√≥n','unit9N2','S'],['Ëàπ','chu√°n','barco','unit9N2','S'],['Âùê','zu√≤','sentarse / viajar en','unit9N2','V'],['È™ë','q√≠','montar','unit9N2','V'],['Ëá™Ë°åËΩ¶','z√¨x√≠ngchƒì','bicicleta','unit9N2','S'],['Êë©ÊâòËΩ¶','m√≥tu≈çchƒì','moto','unit9N2','S']
  ];
}

// Nivel 3
function unit1N3Sample() {
  return [
    ['Áôæ','b«éi','cien','unit1N3','S'],['ÂçÉ','qiƒÅn','mil','unit1N3','S'],['ÂÖ¨Êñ§','g≈çng jƒ´n','kilogramo','unit1N3','S'],['Ê¨°','c√¨','vez','unit1N3','S'],['‰ª∂','ji√†n','pieza / prenda','unit1N3','S'],['Âº†','zhƒÅng','hoja (papel)','unit1N3','S'],['È¢ò','t√≠','pregunta / problema','unit1N3','S'],['ÊúÄ','zu√¨','m√°s / el m√°s','unit1N3','E'],['Âæó','de','part√≠cula de resultado','unit1N3','E'],['Á≠â','dƒõng','esperar','unit1N3','V'],['ÂÜç','z√†i','otra vez','unit1N3','E']
  ];
}

function unit2N3Sample() {
  return [
    ['Ëèú','c√†i','verdura / comida','unit2N3','S'],['È∏°Ëõã','jƒ´ d√†n','huevo','unit2N3','S'],['Á±≥È•≠','m«ê f√†n','arroz','unit2N3','S'],['ËãπÊûú','p√≠ng gu«í','manzana','unit2N3','S'],['Ë•øÁìú','xƒ´ guƒÅ','sand√≠a','unit2N3','S'],['ÁæäËÇâ','y√°ng r√≤u','carne de cordero','unit2N3','S'],['Âçñ','m√†i','vender','unit2N3','V'],['‰π∞','m«éi','comprar','unit2N3','V'],['Ë¶Å','y√†o','querer / necesitar','unit2N3','V'],['ËçØ','y√†o','medicina','unit2N3','S'],['Âñù','hƒì','beber','unit2N3','V'],['È±º','y√∫','pez / pescado','unit2N3','S']
  ];
}

function unit3N3Sample() {
  return [
    ['ÊàøÈó¥','f√°ng jiƒÅn','habitaci√≥n','unit3N3','S'],['Èó®','m√©n','puerta','unit3N3','S'],['Ë∑Ø','l√π','camino / calle','unit3N3','S'],['ÁÅ´ËΩ¶Á´ô','hu«í chƒì zh√†n','estaci√≥n de tren','unit3N3','S'],['Êú∫Âú∫','jƒ´ ch«éng','aeropuerto','unit3N3','S'],['Ê°åÂ≠ê','zhu≈ç zi','mesa','unit3N3','S'],['Ê§ÖÂ≠ê','y«ê zi','silla','unit3N3','S'],['‰∏ä','sh√†ng','arriba / subir','unit3N3','V'],['‰∏ã','xi√†','abajo / bajar','unit3N3','V'],['Èáå','l«ê','dentro','unit3N3','P'],['Â§ñ','w√†i','fuera','unit3N3','P'],['Ëøë','j√¨n','cerca','unit3N3','A']
  ];
}

function unit4N3Sample() {
  return [
    ['ÊúçÂä°Âëò','f√∫ w√π yu√°n','camarero/a','unit4N3','S'],['ÂÖàÁîü','xiƒÅn sheng','se√±or','unit4N3','S'],['Â∞èÂßê','xi«éo jiƒõ','se√±orita','unit4N3','S'],['‰∏àÂ§´','zh√†ng fu','esposo','unit4N3','S'],['Â≠©Â≠ê','h√°i zi','ni√±o/a','unit4N3','S'],['ÂÆÉ','tƒÅ','ello','unit4N3','P'],['ÂåªÁîü','yƒ´ shƒìng','doctor','unit4N3','S'],['ÁúºÁùõ','y«én jƒ´ng','ojos','unit4N3','S'],['ÊÄß','x√¨ng','sexo / g√©nero','unit4N3','S'],['Ë∫´‰Ωì','shƒìn t«ê','cuerpo','unit4N3','S'],['ÂêåÂ≠¶','t√≥ng xu√©','compa√±ero de clase','unit4N3','S']
  ];
}

function unit5N3Sample() {
  return [
    ['Âá∫','ch≈´','salir','unit5N3','V'],['Á©ø','chuƒÅn','usar (ropa)','unit5N3','V'],['Ë∑ëÊ≠•','p«éo b√π','correr','unit5N3','V'],['Ê∏∏Ê≥≥','y√≥u y«íng','nadar','unit5N3','V'],['Ë∏¢Ë∂≥ÁêÉ','tƒ´ z√∫ qi√∫','jugar f√∫tbol','unit5N3','V'],['ÊâìÁØÆÁêÉ','d«é l√°n qi√∫','jugar b√°squet','unit5N3','V'],['Ë∑≥Ëàû','ti√†o w«î','bailar','unit5N3','V'],['Áé©','w√°n','jugar','unit5N3','V'],['ÂÆå','w√°n','terminar','unit5N3','V'],['ÂºÄ','kƒÅi','abrir / conducir','unit5N3','V'],['Ëøõ','j√¨n','entrar','unit5N3','V'],['Âêë','xi√†ng','hacia','unit5N3','P'],['Êâæ','zh«éo','buscar','unit5N3','V']
  ];
}

function unit6N3Sample() {
  return [
    ['ÊØè','mƒõi','cada','unit6N3','E'],['Â∞èÊó∂','xi«éo sh√≠','hora','unit6N3','S'],['ÂéªÂπ¥','q√π ni√°n','el a√±o pasado','unit6N3','S'],['Â∑≤Áªè','y«ê jƒ´ng','ya','unit6N3','E'],['‰∫Ü','le','part√≠cula perfectiva','unit6N3','E'],['Ëøá','gu√≤','part√≠cula experiencial','unit6N3','E'],['Ëøò','h√°i','todav√≠a','unit6N3','E'],['Â∞±','ji√π','entonces / solo','unit6N3','E'],['Ê≠£Âú®','zh√®ng z√†i','estar + gerundio','unit6N3','E'],['ÂáÜÂ§á','zh«în b√®i','preparar','unit6N3','V'],['ÂºÄÂßã','kƒÅi sh«ê','empezar','unit6N3','V'],['Êó©‰∏ä','z«éo shang','ma√±ana','unit6N3','S'],['Êò®Â§©','zu√≥ tiƒÅn','ayer','unit6N3','S']
  ];
}

function unit7N3Sample() {
  return [
    ['Êô¥','q√≠ng','soleado','unit7N3','A'],['‰∏ãÈõ®','xi√† y«î','llover','unit7N3','V'],['Èõ™','xuƒõ','nieve','unit7N3','S'],['Èò¥','yƒ´n','nublado','unit7N3','A'],['ÁÉ≠','r√®','caliente','unit7N3','A'],['ÂÜ∑','lƒõng','fr√≠o','unit7N3','A'],['Â§©Ê∞î','tiƒÅn q√¨','clima','unit7N3','S'],['È¢úËâ≤','y√°n s√®','color','unit7N3','S']
  ];
}

function unit8N3Sample() {
  return [
    ['ÁîüÁóÖ','shƒìng b√¨ng','enfermarse','unit8N3','V'],['Á¥Ø','l√®i','cansado','unit8N3','A'],['Âøô','m√°ng','ocupado','unit8N3','A'],['ÊÖ¢','m√†n','lento','unit8N3','A'],['Âø´','ku√†i','r√°pido','unit8N3','A'],['È´òÂÖ¥','gƒÅo x√¨ng','feliz','unit8N3','A'],['ÁùÄÊÄ•','zh√°o j√≠','preocupado','unit8N3','A'],['Ê¨¢Ëøé','huƒÅn y√≠ng','dar la bienvenida','unit8N3','V'],['Â∏åÊúõ','xƒ´ w√†ng','esperar / desear','unit8N3','V'],['Á¨ë','xi√†o','re√≠r','unit8N3','V'],['Áúü','zhƒìn','verdaderamente','unit8N3','E'],['ÊáÇ','d«íng','entender','unit8N3','V'],['ÊÑèÊÄù','y√¨ si','significado','unit8N3','S']
  ];
}

function unit9N3Sample() {
  return [
    ['Êä•Á∫∏','b√†o zh«ê','peri√≥dico','unit9N3','S'],['Â∏ÆÂä©','bƒÅng zh√π','ayudar','unit9N3','V'],['Âà´','bi√©','no (imperativo)','unit9N3','E'],['‰ΩÜÊòØ','d√†n sh√¨','pero','unit9N3','E'],['ËØª','d√∫','leer','unit9N3','V'],['ÂØπ','du√¨','correcto / hacia','unit9N3','A'],['ÂëäËØâ','g√†o su','decir / contar','unit9N3','V'],['ÂõûÁ≠î','hu√≠ d√°','responder','unit9N3','V'],['ÁúãËßÅ','k√†n ji√†n','ver','unit9N3','V'],['ËÄÉËØï','k«éo sh√¨','examen','unit9N3','S'],['ÂèØËÉΩ','kƒõ n√©ng','posible','unit9N3','A'],['ÂèØ‰ª•','kƒõ y«ê','poder','unit9N3','V'],['ÈóÆ','w√®n','preguntar','unit9N3','V'],['ÈóÆÈ¢ò','w√®n t√≠','pregunta / problema','unit9N3','S'],['ËØ¥ËØù','shu≈ç hu√†','hablar','unit9N3','V']
  ];
}

// ========= HOR√ìSCOPO - Los 12 animales =========

// Rata - Colores
function coloresSample() {
  return [
    ['È¢úËâ≤','y√°n s√®','color','colores','S'],
    ['Á∫¢','h√≥ng','rojo','colores','S'],
    ['Ëìù','l√°n','azul','colores','S'],
    ['Áªø','l«ú','verde','colores','S'],
    ['ÈªÑ','hu√°ng','amarillo','colores','S'],
    ['Èªë','hƒìi','negro','colores','S'],
    ['ÁôΩ','b√°i','blanco','colores','S'],
    ['ÁÅ∞','huƒ´','gris','colores','S'],
    ['Ê£ïËâ≤','z≈çng s√®','marr√≥n','colores','S'],
    ['Á≤âËâ≤','fƒõn s√®','rosa','colores','S'],
    ['Á¥´Ëâ≤','z«ê s√®','morado','colores','S'],
    ['Ê©ôËâ≤','ch√©ng s√®','naranja','colores','S'],
    ['ÈáëËâ≤','jƒ´n s√®','dorado','colores','S'],
    ['‰∫Æ','li√†ng','brillante','colores','A'],
    ['Êöó','√†n','oscuro (tono)','colores','A'],
    ['Ëâ∫ÊúØ','y√¨ sh√π','arte','colores','S']
  ];
}

// Gallo - Fruta
function frutaSample() {
  return [
    ['Ê∞¥Êûú','shu«ê gu«í','fruta','fruta','S'],
    ['ËãπÊûú','p√≠ng gu«í','manzana','fruta','S'],
    ['È¶ôËïâ','xiƒÅng jiƒÅo','banana','fruta','S'],
    ['Ê©ôÂ≠ê','ch√©ng zi','naranja','fruta','S'],
    ['Ë•øÁìú','xƒ´ guƒÅ','sand√≠a','fruta','S'],
    ['Ëë°ËêÑ','p√∫ tao','uva','fruta','S'],
    ['ËçâËéì','c«éo m√©i','frutilla','fruta','S'],
    ['Ê¢®','l√≠','pera','fruta','S'],
    ['Ê°ÉÂ≠ê','t√°o zi','durazno','fruta','S'],
    ['Êü†Ê™¨','n√≠ng m√©ng','lim√≥n','fruta','S'],
    ['ËäíÊûú','m√°ng gu«í','mango','fruta','S'],
    ['Ëè†Ëêù','b≈ç lu√≥','pi√±a','fruta','S'],
    ['ÊüöÂ≠ê','y√≤u zi','pomelo','fruta','S'],
    ['ÊûúÊ±Å','gu«í zhƒ´','jugo','fruta','S'],
    ['Áîú','ti√°n','dulce','fruta','A'],
    ['ÈÖ∏','suƒÅn','√°cido','fruta','A'],
    ['Ëã¶','k«î','amargo','fruta','A']
  ];
}

// Conejo - Verdura
function verdurasSample() {
  return [
    ['Ëî¨Ëèú','sh≈´ c√†i','verdura','verduras','S'],
    ['ÂúüË±Ü','t«î d√≤u','papa','verduras','S'],
    ['Ë•øÁ∫¢Êüø','xƒ´ h√≥ng sh√¨','tomate','verduras','S'],
    ['ÈªÑÁìú','hu√°ng guƒÅ','pepino','verduras','S'],
    ['ËÉ°ËêùÂçú','h√∫ lu√≥ bo','zanahoria','verduras','S'],
    ['Ê¥ãËë±','y√°ng c≈çng','cebolla','verduras','S'],
    ['ÁîüËèú','shƒìng c√†i','lechuga','verduras','S'],
    ['ÁôΩËèú','b√°i c√†i','col china','verduras','S'],
    ['Â§ßËíú','d√† su√†n','ajo','verduras','S'],
    ['Á∫¢ËñØ','h√≥ng sh«î','batata/ camote','verduras','S'],
    ['Ë±ÜËÖê','d√≤u fu','tofu','verduras','S'],
    ['ËåÑÂ≠ê','qi√© zi','berenjena','verduras','S'],
    ['Ëæ£Ê§í','l√† jiƒÅo','aj√≠','verduras','S'],
    ['ÂçóÁìú','n√°n guƒÅ','calabaza','verduras','S'],
    ['ÁéâÁ±≥','y√π m«ê','choclo/ ma√≠z','verduras','S'],
    ['Êñ∞È≤ú','xƒ´n xiƒÅn','fresco','verduras','A']
  ];
}

// Cerdo - Comidas
function comidasSample() {
  return [
    ['È•≠','f√†n','comida, arroz','comidas','S'],
    ['Á±≥È•≠','m«ê f√†n','arroz','comidas','S'],
    ['Èù¢ÂåÖ','mi√†n bƒÅo','pan','comidas','S'],
    ['Èù¢Êù°','mi√†n ti√°o','fideos','comidas','S'],
    ['ÂåÖÂ≠ê','bƒÅo zi','bao','comidas','S'],
    ['È•∫Â≠ê','ji«éo zi','dumpling','comidas','S'],
    ['Ê±§','tƒÅng','sopa','comidas','S'],
    ['ËÇâ','r√≤u','carne','comidas','S'],
    ['È±º','y√∫','pescado','comidas','S'],
    ['ËõãÁ≥ï','d√†n gƒÅo','pastel','comidas','S'],
    ['‰∏âÊòéÊ≤ª','sƒÅn m√≠ng zh√¨','sandwich','comidas','S'],
    ['Â∑ßÂÖãÂäõ','qi«éo k√® l√¨','chocolate','comidas','S'],
    ['Ê±âÂ†°','h√†n b«éo','hamburguesa','comidas','S'],
    ['Êä´Ëê®','pƒ´ s√†','pizza','comidas','S'],
    ['ÁÇ∏È∏°','zh√° jƒ´','pollo frito','comidas','S'],
    ['Ê≤ôÊãâ','shƒÅ lƒÅ','ensalada','comidas','S'],
    ['ÁÉ§ËÇâ','k«éo r√≤u','carne asada','comidas','S'],
    ['ÂØøÂè∏','sh√≤u sƒ´','sushi','comidas','S'],
    ['Âø´È§ê','ku√†i cƒÅn','comida r√°pida','comidas','S'],
    ['Êñπ‰æøÈù¢','fƒÅng bi√†n mi√†n','fideos instant√°neos','comidas','S']
  ];
}

// Perro - Animales
function animalesSample() {
  return [
    ['Âä®Áâ©','d√≤ng w√π','animal','animales','S'],
    ['Èº†','sh«î','rata','animales','S'],
    ['Áâõ','ni√∫','buey/vaca','animales','S'],
    ['Ëôé','h«î','tigre','animales','S'],
    ['ÂÖî','t√π','conejo','animales','S'],
    ['Èæô','l√≥ng','drag√≥n','animales','S'],
    ['Ëõá','sh√©','serpiente','animales','S'],
    ['È©¨','m«é','caballo','animales','S'],
    ['Áæä','y√°ng','cabra/oveja','animales','S'],
    ['Áå¥','h√≥u','mono','animales','S'],
    ['È∏°','jƒ´','gallo/gallina','animales','S'],
    ['Áãó','g«íu','perro','animales','S'],
    ['Áå™','zh≈´','cerdo','animales','S'],
    ['ÁÜäÁå´','xi√≥ng mƒÅo','oso panda','animales','S'],
    ['ÁãÆÂ≠ê','shƒ´ zi','le√≥n','animales','S'],
    ['ÈïøÈ¢àÈπø','ch√°ng j«êng l√π','jirafa','animales','S'],
    ['È≤®È±º','shƒÅ y√∫','tibur√≥n','animales','S'],
    ['Áãº','l√°ng','lobo','animales','S'],
    ['Â§ßÁå©Áå©','d√† xƒ´ng xing','gorila','animales','S'],
    ['Â§ßË±°','d√† xi√†ng','elefante','animales','S'],
    ['È∏ü','ni«éo','p√°jaro','animales','S']
  ];
}

// Caballo - Deportes
function deportesSample() {
  return [
    ['ËøêÂä®','y√πn d√≤ng','deporte','deportes','S'],
    ['Ë∂≥ÁêÉ','z√∫ qi√∫','f√∫tbol','deportes','S'],
    ['ÁØÆÁêÉ','l√°n qi√∫','baloncesto','deportes','S'],
    ['ÁΩëÁêÉ','w«éng qi√∫','tenis','deportes','S'],
    ['‰πí‰πìÁêÉ','pƒ´ng pƒÅng qi√∫','ping pong','deportes','S'],
    ['ÊéíÁêÉ','p√°i qi√∫','voleibol','deportes','S'],
    ['Ê∏∏Ê≥≥','y√≥u y«íng','nadar','deportes','V'],
    ['Ë∑ëÊ≠•','p«éo b√π','correr','deportes','V'],
    ['È™ëËΩ¶','q√≠ chƒì','andar en bicicleta','deportes','V'],
    ['Êâì','d«é','jugar/golpear (deportes)','deportes','V'],
    ['Ë∏¢','tƒ´','patear (jugar f√∫tbol)','deportes','V'],
    ['ÁªÉ‰π†','li√†n x√≠','practicar','deportes','V'],
    ['ÊØîËµõ','b«ê s√†i','partido/competencia','deportes','S'],
    ['ÂÅ•Ë∫´','ji√†n shƒìn','hacer ejercicio','deportes','V'],
    ['ÁêÉÂú∫','qi√∫ ch«éng','cancha','deportes','S'],
    ['Èòü','du√¨','equipo','deportes','S'],
    ['ÂÜ†ÂÜõ','gu√†n j≈´n','campe√≥n','deportes','S'],
    ['Âä™Âäõ','n«î l√¨','esforzarse','deportes','V'],
    ['Â••Ëøê‰ºö','√†o y√πn hu√¨','juegos ol√≠mpicos','deportes','S']
  ];
}

// Buey - Hobbies
function hobbiesSample() {
  return [
    ['Áà±Â•Ω','√†i h√†o','hobby','hobbies','S'],
    ['Áúã‰π¶','k√†n sh≈´','leer libros','hobbies','V'],
    ['ÁúãÁîµÂΩ±','k√†n di√†n y«êng','ver pel√≠culas','hobbies','V'],
    ['Âî±Ê≠å','ch√†ng gƒì','cantar','hobbies','V'],
    ['Ë∑≥Ëàû','ti√†o w«î','bailar','hobbies','V'],
    ['ÁîªÁîª','hu√† hu√†','dibujar/pintar','hobbies','V'],
    ['ÊãçÁÖß','pƒÅi zh√†o','sacar fotos','hobbies','V'],
    ['ÊóÖÊ∏∏','l«ö y√≥u','viajar','hobbies','V'],
    ['ÊâìÊ∏∏Êàè','d«é y√≥u x√¨','jugar videojuegos','hobbies','V'],
    ['Ë¥≠Áâ©','g√≤u w√π','ir de compras','hobbies','V'],
    ['‰∏äÁΩë','sh√†ng w«éng','navegar en internet','hobbies','V'],
    ['ËÅäÂ§©','li√°o tiƒÅn','charlar','hobbies','V'],
    ['Â≠¶ËØ≠Ë®Ä','xu√© y«î y√°n','aprender idioma','hobbies','V'],
    ['Êî∂Ëóè','sh≈çu c√°ng','coleccionar','hobbies','V'],
    ['Âõ≠Ëâ∫','yu√°n y√¨','jardiner√≠a','hobbies','S'],
    ['Ê≠¶ÊúØ','w«î sh√π','artes marciales','hobbies','S'],
    ['Ê°åÊ∏∏','zhu≈ç y√≥u','juego de mesa','hobbies','S']
  ];
}

// Cabra - Ropa
function ropaSample() {
  return [
    ['Ë°£Êúç','yƒ´ fu','ropa','ropa','S'],
    ['Ë£§Â≠ê','k√π zi','pantal√≥n','ropa','S'],
    ['Ë°¨Ë°´','ch√®n shƒÅn','camisa','ropa','S'],
    ['Â§ñÂ•ó','w√†i t√†o','abrigo','ropa','S'],
    ['Èûã','xi√©','zapatos','ropa','S'],
    ['È´òË∑üÈûã','gƒÅo gƒìn xi√©','tacones','ropa','S'],
    ['Ë¢úÂ≠ê','w√† zi','medias','ropa','S'],
    ['ÁöÆÂ∏¶','p√≠ d√†i','cintur√≥n','ropa','S'],
    ['Ë•øË£Ö','xƒ´ zhuƒÅng','traje','ropa','S'],
    ['ËøûË°£Ë£ô','li√°n yƒ´ q√∫n','vestido','ropa','S'],
    ['ÊØõË°£','m√°o yƒ´','sweater','ropa','S'],
    ['Âç´Ë°£','w√®i yƒ´','buzo','ropa','S'],
    ['ËøêÂä®Êúç','y√πn d√≤ng f√∫','ropa deportiva','ropa','S'],
    ['Â∏ΩÂ≠ê','m√†o zi','sombrero/gorra','ropa','S'],
    ['ÁúºÈïú','y«én j√¨ng','lentes / anteojos','ropa','S'],
    ['Á©ø','chuƒÅn','ponerse (ropa)','ropa','V'],
    ['Êà¥','d√†i','llevar puesto (accesorios)','ropa','V'],
    ['ËØï','sh√¨','probarse','ropa','V']
  ];
}

// Serpiente - Casa
function casaSample() {
  return [
    ['ÂÆ∂','jiƒÅ','hogar, familia','casa','S'],
    ['ÊàøÂ≠ê','f√°ng zi','casa (edificio)','casa','S'],
    ['ÊàøÈó¥','f√°ng jiƒÅn','habitaci√≥n','casa','S'],
    ['ÂçßÂÆ§','w√≤ sh√¨','dormitorio','casa','S'],
    ['Âé®Êàø','ch√∫ f√°ng','cocina','casa','S'],
    ['ÂÆ¢ÂéÖ','k√® tƒ´ng','sala de estar','casa','S'],
    ['Ê¥óÊâãÈó¥','x«ê sh«íu jiƒÅn','ba√±o','casa','S'],
    ['Èò≥Âè∞','y√°ng t√°i','balc√≥n','casa','S'],
    ['Ëä±Âõ≠','huƒÅ yu√°n','jard√≠n','casa','S'],
    ['Ê°åÂ≠ê','zhu≈ç zi','mesa','casa','S'],
    ['Ê§ÖÂ≠ê','y«ê zi','silla','casa','S'],
    ['Â∫ä','chu√°ng','cama','casa','S'],
    ['Ê≤ôÂèë','shƒÅ fƒÅ','sof√°','casa','S'],
    ['ÁÅØ','dƒìng','l√°mpara','casa','S'],
    ['Èó®','m√©n','puerta','casa','S'],
    ['Á™óÊà∑','chuƒÅng hu','ventana','casa','S'],
    ['ÈïúÂ≠ê','j√¨ng zi','espejo','casa','S'],
    ['ÂÜ∞ÁÆ±','bƒ´ng xiƒÅng','refrigerador','casa','S'],
    ['ÂÆ∂ÂÖ∑','jiƒÅ j√π','muebles','casa','S']
  ];
}

// Mono - Cuerpo
function cuerpoSample() {
  return [
    ['Â§¥','t√≥u','cabeza','cuerpo','S'],
    ['ËÑ∏','li«én','cara','cuerpo','S'],
    ['Â§¥Âèë','t√≥u fa','cabello','cuerpo','S'],
    ['ÁúºÁùõ','y«én jing','ojo','cuerpo','S'],
    ['ÈºªÂ≠ê','b√≠ zi','nariz','cuerpo','S'],
    ['Âò¥','zu«ê','boca','cuerpo','S'],
    ['ËÄ≥Êúµ','ƒõr duo','oreja','cuerpo','S'],
    ['ËÑñÂ≠ê','b√≥ zi','cuello','cuerpo','S'],
    ['ËÇ©ËÜÄ','jiƒÅn b«éng','hombro','cuerpo','S'],
    ['Êâã','sh«íu','mano','cuerpo','S'],
    ['ÊâãÊåá','sh«íu zh«ê','dedo','cuerpo','S'],
    ['ËÉ≥ËÜä','gƒì bo','brazo','cuerpo','S'],
    ['ËÖø','tu«ê','pierna','cuerpo','S'],
    ['ËÑö','ji«éo','pie','cuerpo','S'],
    ['ËÉå','b√®i','espalda','cuerpo','S'],
    ['Áâô','y√°','dientes','cuerpo','S'],
    ['ËàåÂ§¥','sh√© tou','lengua','cuerpo','S'],
    ['ËÇöÂ≠ê','d√π zi','panza','cuerpo','S'],
    ['ÁöÆËÇ§','p√≠ f≈´','piel','cuerpo','S'],
    ['Â£∞Èü≥','shƒìng yƒ´n','voz / sonido','cuerpo','S']
  ];
}

// Tigre - Profesiones
function profesionesSample() {
  return [
    ['ËÄÅÂ∏à','l«éo shƒ´','profesor','profesiones','S'],
    ['Â≠¶Áîü','xu√© shƒìng','estudiante','profesiones','S'],
    ['ÂåªÁîü','yƒ´ shƒìng','doctor','profesiones','S'],
    ['Â∑•‰∫∫','g≈çng r√©n','obrero','profesiones','S'],
    ['Âè∏Êú∫','sƒ´ jƒ´','chofer','profesiones','S'],
    ['Ë≠¶ÂØü','j«êng ch√°','polic√≠a','profesiones','S'],
    ['ÊúçÂä°Âëò','f√∫ w√π yu√°n','mesero','profesiones','S'],
    ['ÁªèÁêÜ','jƒ´ng l«ê','gerente','profesiones','S'],
    ['ÂæãÂ∏à','l«ú shƒ´','abogado','profesiones','S'],
    ['ÂïÜ‰∫∫','shƒÅng r√©n','empresario','profesiones','S'],
    ['Â∑•Á®ãÂ∏à','g≈çng ch√©ng shƒ´','ingeniero','profesiones','S'],
    ['ËÆ∞ËÄÖ','j√¨ zhƒõ','periodista','profesiones','S'],
    ['ÊºîÂëò','y«én yu√°n','actor','profesiones','S'],
    ['Ê≠åÊâã','gƒì sh«íu','cantante','profesiones','S'],
    ['ÁîªÂÆ∂','hu√† jiƒÅ','pintor','profesiones','S'],
    ['Âé®Â∏à','ch√∫ shƒ´','cocinero','profesiones','S'],
    ['Á®ãÂ∫èÂëò','ch√©ng x√π yu√°n','programador','profesiones','S'],
    ['ÁΩëÁ∫¢','w«éng h√≥ng','influencer','profesiones','S']
  ];
}

// Drag√≥n - Emociones
function emocionesSample() {
  return [
    ['È´òÂÖ¥','gƒÅo x√¨ng','feliz','emociones','A'],
    ['Âø´‰πê','ku√†i l√®','alegre','emociones','A'],
    ['ÈöæËøá','n√°n gu√≤','triste','emociones','A'],
    ['ÁîüÊ∞î','shƒìng q√¨','enojado','emociones','A'],
    ['Á¥ßÂº†','j«ên zhƒÅng','nervioso','emociones','A'],
    ['ÂÆ≥ÊÄï','h√†i p√†','asustado','emociones','A'],
    ['ÊãÖÂøÉ','dƒÅn xƒ´n','preocupado','emociones','A'],
    ['Á¥Ø','l√®i','cansado','emociones','A'],
    ['Êó†ËÅä','w√∫ li√°o','aburrido','emociones','A'],
    ['ÊîæÊùæ','f√†ng s≈çng','relajado','emociones','A'],
    ['Êª°ÊÑè','m«én y√¨','satisfecho','emociones','A'],
    ['ÁîüÁóÖ','shƒìng b√¨ng','enfermo','emociones','V'],
    ['ÊÑüÂä®','g«én d√≤ng','conmovido','emociones','A'],
    ['Ëá™‰ø°','z√¨ x√¨n','confiado','emociones','A'],
    ['ÂÆ≥Áæû','h√†i xi≈´','t√≠mido','emociones','A'],
    ['ÁÉ≠ÊÉÖ','r√® q√≠ng','entusiasta','emociones','A'],
    ['Âπ∏Á¶è','x√¨ng f√∫','feliz, dichoso','emociones','A']
  ];
}


  /* ========= Carga ========= */
  async function loadAll(){
    console.log('üöÄ Iniciando carga completa de la aplicaci√≥n...');
    updateLoadingProgress(10, 'Iniciando sesi√≥n...');
    
    await loadUserState(jwtToken);
    
    // Renderizar barra de XP al final de la carga
    renderXPBar();
    
    // Mostrar SIEMPRE el box y bot√≥n de Nivel 2 si nivel2Unlocked es true
    setTimeout(() => {
      console.log('üîç Verificando nivel2Unlocked:', nivel2Unlocked);
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      
      if(true){
        console.log('‚úÖ Mostrando Nivel 2...');
        if(nivel2Wrap) {
          nivel2Wrap.style.display = '';
          console.log('‚úÖ nivel2Wrap mostrado');
        }
        if(btnNivel2) {
          btnNivel2.style.display = '';
          console.log('‚úÖ btnNivel2 mostrado');
        }
      }

      // Verificar y mostrar Nivel 3 si est√° desbloqueado
      console.log('üîç Verificando nivel3Unlocked:', nivel3Unlocked);
      const nivel3Wrap = document.getElementById('nivel3Wrap');
      const btnNivel3 = document.getElementById('btnNivel3');
      
      if(true){
        console.log('‚úÖ Mostrando Nivel 3...');
        if(nivel3Wrap) {
          nivel3Wrap.style.display = '';
          console.log('‚úÖ nivel3Wrap mostrado');
        }
        if(btnNivel3) {
          btnNivel3.style.display = '';
          console.log('‚úÖ btnNivel3 mostrado');
        }
      }
    }, 200);
    
    // Asegurar que est√© en el top despu√©s de cargar todo
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 300);
  }

  /* ========= L√≥gica ========= */
  function buildQueue(type){
      if(type==='todoN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit)));
      if(type==='desafioN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit))).slice(0,20);
      if(type==='desafioN2') return shuffle(cards.filter(c=>[
        'unit1N2','unit2N2','unit3N2','unit4N2','unit5N2','unit6N2','unit7N2','unit8N2','unit9N2'
      ].includes(c.unit))).slice(0,20);
      if(type==='desafioN3') return shuffle(cards.filter(c=>[
        'unit1N3','unit2N3','unit3N3','unit4N3','unit5N3','unit6N3','unit7N3','unit8N3','unit9N3'
      ].includes(c.unit))).slice(0,20);
      if(type==='unit2') return cards.filter(c=>c.unit==='unit2');
      if(type==='unit3') return cards.filter(c=>c.unit==='unit3');
      if(type==='unit4') return cards.filter(c=>c.unit==='unit4');
      if(type==='unit5') return cards.filter(c=>c.unit==='unit5');
      if(type==='unit6') return cards.filter(c=>c.unit==='unit6');
      if(type==='unit7') return cards.filter(c=>c.unit==='unit7');
      if(type==='unit8') return cards.filter(c=>c.unit==='unit8');
      if(type==='unit9') return cards.filter(c=>c.unit==='unit9');
      // Nivel 2
      if(type==='todoN2') return shuffle(cards.filter(c=>[
        'unit1N2','unit2N2','unit3N2','unit4N2','unit5N2','unit6N2','unit7N2','unit8N2','unit9N2'
      ].includes(c.unit)));
      if(type==='unit1N2') return cards.filter(c=>c.unit==='unit1N2');
      if(type==='unit2N2') return cards.filter(c=>c.unit==='unit2N2');
      if(type==='unit3N2') return cards.filter(c=>c.unit==='unit3N2');
      if(type==='unit4N2') return cards.filter(c=>c.unit==='unit4N2');
      if(type==='unit5N2') return cards.filter(c=>c.unit==='unit5N2');
      if(type==='unit6N2') return cards.filter(c=>c.unit==='unit6N2');
      if(type==='unit7N2') return cards.filter(c=>c.unit==='unit7N2');
      if(type==='unit8N2') return cards.filter(c=>c.unit==='unit8N2');
      if(type==='unit9N2') return cards.filter(c=>c.unit==='unit9N2');

      // Nivel 3
      if(type==='todoN3') return shuffle(cards.filter(c=>[
        'unit1N3','unit2N3','unit3N3','unit4N3','unit5N3','unit6N3','unit7N3','unit8N3','unit9N3'
      ].includes(c.unit)));
      if(type==='unit1N3') return cards.filter(c=>c.unit==='unit1N3');
      if(type==='unit2N3') return cards.filter(c=>c.unit==='unit2N3');
      if(type==='unit3N3') return cards.filter(c=>c.unit==='unit3N3');
      if(type==='unit4N3') return cards.filter(c=>c.unit==='unit4N3');
      if(type==='unit5N3') return cards.filter(c=>c.unit==='unit5N3');
      if(type==='unit6N3') return cards.filter(c=>c.unit==='unit6N3');
      if(type==='unit7N3') return cards.filter(c=>c.unit==='unit7N3');
      if(type==='unit8N3') return cards.filter(c=>c.unit==='unit8N3');
      if(type==='unit9N3') return cards.filter(c=>c.unit==='unit9N3');

      // HOR√ìSCOPO - Los 12 animales
      // HOR√ìSCOPO - Los 12 animales del hor√≥scopo
      if(type==='colores') return cards.filter(c=>c.unit==='colores');
      if(type==='fruta') return cards.filter(c=>c.unit==='fruta');
      if(type==='verduras') return cards.filter(c=>c.unit==='verduras');
      if(type==='comidas') return cards.filter(c=>c.unit==='comidas');
      if(type==='animales') return cards.filter(c=>c.unit==='animales');
      if(type==='deportes') return cards.filter(c=>c.unit==='deportes');
      if(type==='hobbies') return cards.filter(c=>c.unit==='hobbies');
      if(type==='ropa') return cards.filter(c=>c.unit==='ropa');
      if(type==='casa') return cards.filter(c=>c.unit==='casa');
      if(type==='cuerpo') return cards.filter(c=>c.unit==='cuerpo');
      if(type==='profesiones') return cards.filter(c=>c.unit==='profesiones');
      if(type==='emociones') return cards.filter(c=>c.unit==='emociones');

      // DESAF√çOS DEL HOR√ìSCOPO - Solo palabras conocidas de cada categor√≠a (EXCLUIR badges del hor√≥scopo)
      if(type==='desafioColores') return shuffle(cards.filter(c=>c.unit==='colores' && !c.isHoroscopeAnimal));
      if(type==='desafioFruta') return shuffle(cards.filter(c=>c.unit==='fruta' && !c.isHoroscopeAnimal));
      if(type==='desafioVerduras') return shuffle(cards.filter(c=>c.unit==='verduras' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioComidas') return shuffle(cards.filter(c=>c.unit==='comidas' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioAnimales') return shuffle(cards.filter(c=>c.unit==='animales' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioDeportes') return shuffle(cards.filter(c=>c.unit==='deportes' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioHobbies') return shuffle(cards.filter(c=>c.unit==='hobbies' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioRopa') return shuffle(cards.filter(c=>c.unit==='ropa' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioCasa') return shuffle(cards.filter(c=>c.unit==='casa' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioCuerpo') return shuffle(cards.filter(c=>c.unit==='cuerpo' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioProfesiones') return shuffle(cards.filter(c=>c.unit==='profesiones' && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioEmociones') return shuffle(cards.filter(c=>c.unit==='emociones' && c.known && !c.isHoroscopeAnimal)).slice(0,10);

      if(type==='known') return shuffle(cards.filter(c=>c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      if(type==='revise1') return shuffle(cards.filter(c=>c.revise1 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      if(type==='revise2') return shuffle(cards.filter(c=>c.revise2 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      if(type==='challenge') return shuffle(cards.filter(c=>c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo')).slice(0,10);
      return [];
    }
  document.getElementById('btnDesafioN1').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N1 clickeado!');
    showDesafioNNotification('desafioN1', 'Nivel 1', 'acceso al Nivel 2');
  };
  document.getElementById('btnTodoN1').onclick = () => startMission('todoN1');

  // Event listener para el bot√≥n de Desaf√≠o N2
  document.getElementById('btnDesafioN2').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N2 clickeado!');
    showDesafioNNotification('desafioN2', 'Nivel 2', 'acceso al Nivel 3 y acceso al Hor√≥scopo Chino');
  };

  // Event listener para el bot√≥n de Desaf√≠o N3
  document.getElementById('btnDesafioN3').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N3 clickeado!');
    showDesafioNNotification('desafioN3', 'Nivel 3', 'Pr√≥ximo Nivel (Pr√≥ximamente)');
  };

  // Funci√≥n para controlar la visibilidad de los botones de quiz
  function updateQuizButtonsVisibility(missionType) {
    const quizModeButtons = document.getElementById('quizModeButtons');
    if (!quizModeButtons) return;
    
    console.log('üéØ DEBUG: Actualizando visibilidad botones quiz para misi√≥n:', missionType);
    
    // NEVER show quiz buttons in Ultimate Challenge
    if (missionType === 'ultimateChallenge' || ultimateChallengeActive) {
      console.log('‚ùå Ultimate Challenge activo - ocultando botones de quiz');
      quizModeButtons.classList.add('hidden');
      return;
    }
    
    // Lista de modos donde S√ç deben aparecer los botones de quiz
    const allowedModes = [
      'known', 'revise1', 'revise2', // Modos b√°sicos
      'unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', // Unidades N1
      'todoN1', // Todo N1
      'unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2','todoN2', // Unidades N2
      'unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3','unit7N3','unit8N3','unit9N3','todoN3', // Unidades N3 (si existen)
      'colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', // Hor√≥scopo modos normales
      'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'
    ];
    
    if (allowedModes.includes(missionType)) {
      console.log('‚úÖ Mostrando botones de quiz');
      quizModeButtons.classList.remove('hidden');
    } else {
      console.log('‚ùå Ocultando botones de quiz');
      quizModeButtons.classList.add('hidden');
    }
  }

  async function startMission(type){
    // Limpiar Ultimate Challenge si est√° activo
    if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
      console.log('üßπ Limpiando Ultimate Challenge al cambiar de modo');
      ultimateChallengeActive = false;
      hideUltimateChallengeHearts();
      stopUltimateChallengeTimer();
    }
    
    // Limpiar sistema de desaf√≠os N si no es un desaf√≠o N
    if (desafioNActive && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3') {
      console.log('üßπ Limpiando sistema de desaf√≠os N al cambiar de modo');
      desafioNActive = false;
      stopDesafioNTimer();
      hideDesafioNHearts();
    }
    
    // Limpiar sistema de desaf√≠os cl√°sicos si no es un desaf√≠o cl√°sico
    if (desafioClasico2Active && type !== 'challenge' && type !== 'clasico' && type !== 'menos' && type !== 'mas') {
      console.log('üßπ Limpiando sistema de desaf√≠os cl√°sicos al cambiar de modo');
      desafioClasico2Active = false;
      stopDesafioClasico2Timer();
      hideDesafioClasico2Hearts();
    }
    
    // üêæ Limpiar sistema de desaf√≠os N si no es un desaf√≠o N ni del hor√≥scopo
    if (desafioNActive && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3' && !type.startsWith('desafio')) {
      console.log('üßπ Limpiando sistema de desaf√≠os N al cambiar de modo');
      desafioNActive = false;
      stopDesafioNTimer();
      hideDesafioNHearts();
    }
    
    // üéπ Limpiar controles de teclado al cambiar de misi√≥n
    if (window.quizKeyboardHandler) {
      document.removeEventListener('keydown', window.quizKeyboardHandler);
      window.quizKeyboardHandler = null;
      
      // Ocultar indicador de teclado
      const keyboardHint = document.getElementById('keyboardHint');
      if (keyboardHint) {
        keyboardHint.classList.add('hidden');
      }
      
      console.log('üßπ Controles de teclado limpiados al cambiar de misi√≥n');
    }
    
    currentMission = type;
    sessionQueue = buildQueue(type).slice();
    todayReviewed = 0;
    sessionTotal = sessionQueue.length;
    sessionCorrect = 0;

    // Actualizar statMission para desaf√≠os N desde startMission
    console.log('üìã DEBUG: startMission actualizando statMission para type:', type);
    const statMission = document.getElementById('statMission');
    if (statMission && (type === 'desafioN1' || type === 'desafioN2' || type === 'desafioN3')) {
      const desafioNames = {
        'desafioN1': 'Desaf√≠o N1',
        'desafioN2': 'Desaf√≠o N2', 
        'desafioN3': 'Desaf√≠o N3'
      };
      const newText = desafioNames[type] || 'Desaf√≠o N';
      console.log('üìã DEBUG: Actualizando statMission desde startMission - anterior:', statMission.textContent, 'nuevo:', newText);
      statMission.textContent = newText;
      statMission.style.color = '#f2e5b1';
      statMission.style.fontWeight = 'bold';
      statMission.style.fontSize = '14px';
      console.log('üìã DEBUG: statMission actualizado desde startMission:', statMission.textContent);
    }

    // Capturar estado inicial para desaf√≠os
    if (type === 'challenge' || type === 'desafioN1' || type === 'desafioN2' || type === 'desafioN3' || type.startsWith('desafio')) {
      console.log('üì∑ Capturando estado pre-desaf√≠o para:', type);
      capturePreChallengeState();
    }

    // ACTUALIZAR VISIBILIDAD DE BOTONES DE QUIZ
    updateQuizButtonsVisibility(type);

    // LIMPIAR CLASES DE DESAF√çO AL INICIAR CUALQUIER MISI√ìN
    clearAllChallengeThemes();
    // DETENER M√öSICA DE DESAF√çO SI NO ES MODO DESAF√çO
    if(type !== 'challenge' && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3' && !type.startsWith('desafio')) {
      stopDesafioMusic();
    }
    
    // AUTO-SCROLL AL √ÅREA DE JUEGO EN M√ìVIL - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);

    // M√∫sica de fondo se inicia en countdown - removido de aqu√≠
    if(type==='challenge' || type==='desafioN1' || type==='desafioN2' || type==='desafioN3' || type.startsWith('desafio')){
      // playDesafioMusic(type); // ‚ú® MOVIDO AL COUNTDOWN
      setMode(type==='challenge' ? 'quizMeaning' : (Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin'));
      
      // Aplicar tema visual y precargar video seg√∫n tipo de desaf√≠o
      if(type==='desafioN2') {
        bodyEl.classList.add('challenge-n2-bg');
        statBox.classList.add('challenge-n2-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para N2 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(type==='desafioN3') {
        bodyEl.classList.add('challenge-n3-bg');
        statBox.classList.add('challenge-n3-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para N3 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(isHoroscopeChallenge(type)) {
        // Desaf√≠os del hor√≥scopo usan tema monochrome harmony
        bodyEl.classList.add('horoscope-bg');
        statBox.classList.add('challenge-stat');
        await createChallengeVideoWithPreload('desafioHoroscopo', () => {
          // Para hor√≥scopo no hay timer especial en startMission
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else {
        // challenge, desafioN1 usan tema morado por defecto con video
        bodyEl.classList.add('challenge-bg');
        statBox.classList.add('challenge-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para challenge/desafioN1 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      }
      // Timer y vidas se manejan en startDesafioNWithSystem()
      // Ocultar la tabla de conocidas y cerrar overlay si est√° abierto
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = 'none';
      const knownOverlay = document.getElementById('knownOverlay');
      if(knownOverlay) knownOverlay.remove();
    } else {
      stopDesafioMusic();
      setMode('flash');
      clearAllChallengeThemes();
      // Mostrar la tabla de conocidas
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = '';
    }

    // Iniciar el juego despu√©s de la precarga (para desaf√≠os) o inmediatamente (para otros modos)
    nextCard();
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones al iniciar misi√≥n
  }

// --- Sistema de Timer para Desaf√≠os N1, N2, N3 ---
function startDesafioNTimer() {
  stopDesafioNTimer(); // Limpiar timer anterior
  
  desafioNTimeLeft = 120; // 2 minutos
  console.log('üïê DEBUG: Tiempo configurado:', desafioNTimeLeft);
  showDesafioNTimer();
  
  desafioNTimerInterval = setInterval(() => {
    if (!desafioNActive) {
      stopDesafioNTimer();
      return;
    }
    
    desafioNTimeLeft--;
    updateDesafioNTimer();
    
    if (desafioNTimeLeft <= 0) {
      console.log('‚è∞ Tiempo agotado en desaf√≠o N');
      stopDesafioNTimer();
      
      // Todos los desaf√≠os N usan el modal de desaf√≠o cl√°sico que funciona bien
      showDesafioClasico2Failed('Tiempo agotado');
    }
  }, 1000);
  
  console.log('‚è±Ô∏è Timer de desaf√≠o N iniciado: 2 minutos');
}

function showDesafioNTimer() {
  // Remover timer anterior si existe
  hideDesafioNTimer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'desafioNTimer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateDesafioNTimer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer de desaf√≠o N mostrado');
}

function stopDesafioNTimer() {
  if (desafioNTimerInterval) {
    clearInterval(desafioNTimerInterval);
    desafioNTimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer de desaf√≠o N detenido');
  }
  hideDesafioNTimer();
}

function updateDesafioNTimer() {
  const timerDisplay = document.getElementById('desafioNTimer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(desafioNTimeLeft / 60);
  const seconds = desafioNTimeLeft % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Usar contenido con ancho fijo
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animation = '';
  
  if (desafioNTimeLeft <= 30) {
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animation = 'animation: pulse 1s infinite;';
  } else if (desafioNTimeLeft <= 60) {
    icon = '‚ö†';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
  }
  
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = desafioNTimeLeft <= 30 ? 'pulse 1s infinite' : '';
  timerDisplay.innerHTML = `${icon} ${timeString}`;
}

function hideDesafioNTimer() {
  const timerDisplay = document.getElementById('desafioNTimer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('üôà Timer de desaf√≠o N ocultado');
  }
}

// --- Sistema de Vidas para Desaf√≠os N1, N2, N3 ---
function showDesafioNHearts() {
  console.log('‚ù§Ô∏è DEBUG: showDesafioNHearts iniciado');
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'desafioNHeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas agregado al DOM');
  }
  
  updateDesafioNHearts();
  console.log('‚ù§Ô∏è Vidas de desaf√≠o N mostradas');
}

function updateDesafioNHearts() {
  const heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < desafioNHearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideDesafioNHearts() {
  const heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
    console.log('üôà Vidas de desaf√≠o N ocultadas');
  }
}

function loseDesafioNLife() {
  if (desafioNHearts > 0) {
    desafioNHearts--;
    updateDesafioNHearts();
    console.log(`üíÄ Vida perdida en desaf√≠o N! Vidas restantes: ${desafioNHearts}`);
    
    if (desafioNHearts <= 0) {
      console.log('‚ò†Ô∏è Sin vidas en desaf√≠o N');
      stopDesafioNTimer();
      hideDesafioNHearts();
      showDesafioClasico2Failed('Sin vidas restantes');
    }
  }
}

function showDesafioNFailed(razon) {
  // Detener timer y limpiar sistema
  desafioNActive = false;
  stopDesafioNTimer();
  hideDesafioNHearts();
  
  // Detectar si es desaf√≠o del hor√≥scopo para cambiar comportamiento del bot√≥n
  const isHoroscope = isHoroscopeChallenge(currentMission);
  const buttonText = isHoroscope ? 'VOLVER AL MEN√ö' : 'REINTENTAR';
  const buttonAction = isHoroscope ? 
    `this.parentElement.parentElement.remove(); 
     // Limpiar cualquier overlay residual
     document.querySelectorAll('[style*="z-index"]').forEach(el => {
       if (parseInt(el.style.zIndex) > 1000) el.remove();
     });
     // Ir directamente a revise1 (como tocar el bot√≥n revise1)
     document.getElementById('btnRevise1').click();` :
    'this.parentElement.parentElement.remove(); location.reload()';
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: 'Jersey 10', monospace;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #7f1d1d 100%);
    border: 3px solid #ef4444;
    padding: 30px;
    text-align: center;
    max-width: 400px;
    margin: 20px;
    box-shadow: 
      0 0 20px rgba(239, 68, 68, 0.5),
      0 0 40px rgba(239, 68, 68, 0.3);
  `;
  
  const title = document.createElement('h2');
  title.style.cssText = `
    color: #fca5a5;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
    margin-bottom: 20px;
  `;
  title.textContent = 'üíÄ DESAF√çO FALLIDO';
  
  const message = document.createElement('p');
  message.style.cssText = `color: #fed7d7; font-size: 16px; margin-bottom: 20px;`;
  message.innerHTML = `<strong>${razon}</strong><br>${isHoroscope ? '¬°Vuelve al men√∫ para seleccionar otro desaf√≠o!' : '¬°Int√©ntalo de nuevo cuando est√©s listo!'}`;
  
  const button = document.createElement('button');
  button.style.cssText = `
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    font-family: 'Jersey 10', monospace;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
  `;
  button.textContent = buttonText;
  
  // Event listeners para el bot√≥n
  button.onmouseover = function() { this.style.transform = 'translateY(-1px)'; };
  button.onmouseout = function() { this.style.transform = 'translateY(0px)'; };
  
  if (isHoroscope) {
    button.onclick = function() {
      modal.remove();
      // Limpiar cualquier overlay residual
      document.querySelectorAll('[style*="z-index"]').forEach(el => {
        if (parseInt(el.style.zIndex) > 1000) el.remove();
      });
      // Ir directamente a revise1
      const btnRevise1 = document.getElementById('btnRevise1');
      if (btnRevise1) btnRevise1.click();
    };
  } else {
    button.onclick = function() {
      modal.remove();
      location.reload();
    };
  }
  
  modalContent.appendChild(title);
  modalContent.appendChild(message);
  modalContent.appendChild(button);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}
function showDesafioPerdido(){
  let msg = document.getElementById('desafioPerdidoMsg');
  if(!msg){
    msg = document.createElement('div');
    msg.id = 'desafioPerdidoMsg';
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-rose-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.textContent = 'Te has quedado sin tiempo, perdiste el desaf√≠o';
  msg.onclick = () => { location.reload(); };
    document.body.appendChild(msg);
  }
  msg.style.opacity = '1';
}

// --- Sistema de Timer2 para Desaf√≠os Cl√°sicos (clasico, menos, mas) ---
function startDesafioClasico2Timer() {
  stopDesafioClasico2Timer(); // Limpiar timer anterior
  
  desafioClasico2TimeLeft = 90; // 1 minuto y medio
  showDesafioClasico2Timer();
  
  desafioClasico2TimerInterval = setInterval(() => {
    if (!desafioClasico2Active) {
      stopDesafioClasico2Timer();
      return;
    }
    
    desafioClasico2TimeLeft--;
    updateDesafioClasico2Timer();
    
    if (desafioClasico2TimeLeft <= 0) {
      console.log('‚è∞ Tiempo agotado en desaf√≠o cl√°sico');
      stopDesafioClasico2Timer();
      showDesafioClasico2Failed('Tiempo agotado');
    }
  }, 1000);
  
  console.log('‚è±Ô∏è Timer2 de desaf√≠o cl√°sico iniciado: 90 segundos (1:30)');
}

function showDesafioClasico2Timer() {
  // Remover timer anterior si existe
  hideDesafioClasico2Timer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'desafioClasico2Timer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateDesafioClasico2Timer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer2 de desaf√≠o cl√°sico mostrado');
}

function stopDesafioClasico2Timer() {
  if (desafioClasico2TimerInterval) {
    clearInterval(desafioClasico2TimerInterval);
    desafioClasico2TimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer2 de desaf√≠o cl√°sico detenido');
  }
  hideDesafioClasico2Timer();
}

function updateDesafioClasico2Timer() {
  const timerDisplay = document.getElementById('desafioClasico2Timer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(desafioClasico2TimeLeft / 60);
  const seconds = desafioClasico2TimeLeft % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Configurar estilos y animaciones seg√∫n tiempo restante
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animationStyle = '';
  
  if (desafioClasico2TimeLeft <= 15) {
    // üö® ALERTA CR√çTICA: √öltimos 15 segundos - Rojo intenso con pulse
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animationStyle = 'pulse 1s infinite';
    console.log('üö® ALERTA CR√çTICA: ‚â§15 segundos');
  } else if (desafioClasico2TimeLeft <= 30) {
    // ‚ö†Ô∏è ADVERTENCIA: 30 segundos - Naranja/rojo
    icon = '‚ö†Ô∏è';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
    animationStyle = '';
    console.log('‚ö†Ô∏è ADVERTENCIA: ‚â§30 segundos');
  } else {
    // ‚è±Ô∏è NORMAL: M√°s de 30 segundos - Negro
    icon = '‚è±Ô∏è';
    bgStyle = 'rgba(0, 0, 0, 0.8)';
    animationStyle = '';
  }
  
  // Aplicar estilos
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = animationStyle;
  timerDisplay.innerHTML = `${icon} ${timeString}`;
}

function hideDesafioClasico2Timer() {
  const timerDisplay = document.getElementById('desafioClasico2Timer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('üôà Timer2 de desaf√≠o cl√°sico ocultado');
  }
}

// --- Sistema de Vidas2 para Desaf√≠os Cl√°sicos (clasico, menos, mas) ---
function showDesafioClasico2Hearts() {
  console.log('‚ù§Ô∏è DEBUG: showDesafioClasico2Hearts iniciado');
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'desafioClasico2HeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas2 agregado al DOM');
  }
  
  updateDesafioClasico2Hearts();
  console.log('‚ù§Ô∏è Vidas2 de desaf√≠o cl√°sico mostradas');
}

function updateDesafioClasico2Hearts() {
  const heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < desafioClasico2Hearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideDesafioClasico2Hearts() {
  const heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
    console.log('üôà Vidas2 de desaf√≠o cl√°sico ocultadas');
  }
}

function loseDesafioClasico2Life() {
  if (desafioClasico2Hearts > 0) {
    desafioClasico2Hearts--;
    updateDesafioClasico2Hearts();
    console.log(`üíÄ Vida2 perdida en desaf√≠o cl√°sico! Vidas restantes: ${desafioClasico2Hearts}`);
    
    if (desafioClasico2Hearts <= 0) {
      console.log('‚ò†Ô∏è Sin vidas2 en desaf√≠o cl√°sico');
      stopDesafioClasico2Timer();
      hideDesafioClasico2Hearts();
      showDesafioClasico2Failed('Sin vidas restantes');
    }
  }
}

function showDesafioClasico2Failed(razon) {
  // Detener timer y limpiar sistema
  desafioClasico2Active = false;
  stopDesafioClasico2Timer();
  hideDesafioClasico2Hearts();
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    ">
      <h2 style="
        color: #ff6b6b;
        font-size: 24px;
        margin-bottom: 15px;
        text-shadow: 0 0 8px rgba(255, 107, 107, 0.8);
      ">üíÄ DESAF√çO CL√ÅSICO FALLIDO</h2>
      
      <p style="
        color: #ffffff;
        font-size: 18px;
        margin-bottom: 20px;
        line-height: 1.4;
      ">${razon}</p>
      
      <button onclick="cleanupAndGoToRevise()" style="
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        IR A REPASAR
      </button>
    </div>
  `;
  
  document.body.appendChild(modal); 
  
  // Limpiar flags y asegurar que no hay bloqueos
  desafioClasico2Active = false;
  desafioClasico2Hearts = 2; // Reset para pr√≥ximo intento
  
  // Asegurar que no hay elementos bloqueando la interacci√≥n
  document.body.style.pointerEvents = '';
  document.body.style.overflow = '';
  
  // Limpiar cualquier elemento con pointer-events none que pueda estar bloqueando
  const blockedElements = document.querySelectorAll('[style*="pointer-events: none"]');
  blockedElements.forEach(el => {
    if (el.id === 'cardWrap' || el.id === 'flashRow') {
      el.style.pointerEvents = '';
    }
  });
}

// --- Funci√≥n principal para iniciar desaf√≠os cl√°sicos con sistema Timer2 y Vidas2 ---
function startDesafioClasico2WithSystem(desafioType) {
  console.log('üöÄ DEBUG: startDesafioClasico2WithSystem llamada con:', desafioType);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // Ocultar challengeBox
  const challengeBox = document.getElementById('challengeBox');
  if (challengeBox) challengeBox.classList.add('hidden');
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o cl√°sico');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // Limpiar sistema de desaf√≠os N si est√° activo
  if (desafioNActive || desafioNTimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o N al iniciar desaf√≠o cl√°sico');
    desafioNActive = false;
    stopDesafioNTimer();
    hideDesafioNHearts();
  }
  
  // Activar sistema de desaf√≠o cl√°sico
  desafioClasico2Active = true;
  desafioClasico2Hearts = 2;
  desafioClasico2TimeLeft = 90; // 1 minuto y medio
  console.log('‚öôÔ∏è DEBUG: Variables de desaf√≠o cl√°sico configuradas:', { desafioClasico2Active, desafioClasico2Hearts, desafioClasico2TimeLeft });
  
  // Iniciar misi√≥n seg√∫n el tipo
  console.log('üìã DEBUG: Llamando startMission/startChallengeCustom con:', desafioType);
  if (desafioType === 'challenge') {
    startMission('challenge');
  } else if (desafioType === 'menos' || desafioType === 'mas') {
    startChallengeCustom(desafioType);
  }
  
  // Actualizar statMission para mostrar el tipo de desaf√≠o
  console.log('üìä DEBUG: Intentando actualizar statMission para:', desafioType);
  const statMission = document.getElementById('statMission');
  console.log('üìä DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const desafioNames = {
      'challenge': 'Desaf√≠o Cl√°sico',
      'menos': 'Desaf√≠o 0-1',
      'mas': 'Desaf√≠o 2+'
    };
    const newText = desafioNames[desafioType] || 'Desaf√≠o Cl√°sico';
    console.log('üìä DEBUG: Texto anterior:', statMission.textContent);
    console.log('üìä DEBUG: Texto nuevo que se asignar√°:', newText);
    statMission.textContent = newText;
    statMission.style.color = '#f2e5b1';
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '14px';
    console.log('üéØ DEBUG: statMission actualizado exitosamente:', statMission.textContent);
    
    // Verificar que realmente se actualiz√≥
    setTimeout(() => {
      console.log('‚è±Ô∏è DEBUG: Verificaci√≥n posterior - statMission.textContent:', statMission.textContent);
    }, 100);
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission');
  }
  
  // Iniciar timer y vidas del desaf√≠o cl√°sico
  
  // Inicializar contador de conocidas para detectar cambios
  previousKnownCount = cards.filter(c => c.known).length;
  console.log('üìä Contador inicial de conocidas:', previousKnownCount);
  
  // Agendar el timer para despu√©s de la precarga si es necesario
  const timerCallback = () => {
    startDesafioClasico2Timer();
    console.log('‚è∞ Timer del desaf√≠o cl√°sico iniciado despu√©s de preload');
  };
  
  if (preloadingChallenge) {
    console.log('‚è≥ Timer agendado para despu√©s de precarga');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  showDesafioClasico2Hearts();
  
  console.log(`üéØ Desaf√≠o Cl√°sico iniciado: ${desafioType} con timer2 y vidas2`);
  console.log('üîç DEBUG: Estado final - desafioClasico2Active:', desafioClasico2Active, 'hearts:', desafioClasico2Hearts, 'timeLeft:', desafioClasico2TimeLeft);
}

function bloquearDesafio(){
  // Bloquear controles de desaf√≠o
  document.getElementById('cardWrap').style.pointerEvents = 'none';
  document.getElementById('flashRow').style.pointerEvents = 'none';
  // El usuario debe elegir otro modo para continuar
}

  function ensureReviseFlags(card){
    if(!card.dkAddedAt){ card.dkAddedAt = now(); }
    card.revise1 = true; card.revise2 = true; card.known = false;
  }

  /* ===== Etiquetas de esquina para tarjetas especiales ===== */
  function addCardCornerLabel() {
    // Limpiar etiqueta anterior si existe
    removeCardCornerLabel();
    
    let labelText = '';
    let labelClass = '';
    
    if (cardEl.classList.contains('premium-gold')) {
      labelText = '+2 NIV';
      labelClass = 'gold';
    } else if (cardEl.classList.contains('mythic-violet')) {
      labelText = '+5 NIV';
      labelClass = 'violet';
    } else if (cardEl.classList.contains('legendary-red')) {
      labelText = 'üí£ BOMBA';
      labelClass = 'red';
    }
    
    if (labelText) {
      const label = document.createElement('div');
      label.className = `card-corner-label ${labelClass}`;
      label.textContent = labelText;
      label.id = 'cardCornerLabel';
      
      // Agregar al contenedor de la carta
      cardEl.appendChild(label);
    }
  }
  
  function removeCardCornerLabel() {
    const existingLabel = document.getElementById('cardCornerLabel');
    if (existingLabel) {
      existingLabel.remove();
    }
  }

  /* ===== Funci√≥n para limpiar y ir a repasar despu√©s de fallar desaf√≠o cl√°sico ===== */
  function cleanupAndGoToRevise() {
    // Limpiar modal
    const modals = document.querySelectorAll('[style*="position: fixed"][style*="z-index"]');
    modals.forEach(modal => {
      if (modal.style.background && modal.style.background.includes('rgba')) {
        modal.remove();
      }
    });
    
    // LIMPIEZA COMPLETA: Desbloquear todo
    document.body.style.pointerEvents = '';
    document.body.style.overflow = '';
    
    // Desbloquear elementos espec√≠ficos
    const cardWrap = document.getElementById('cardWrap');
    const flashRow = document.getElementById('flashRow');
    if (cardWrap) cardWrap.style.pointerEvents = '';
    if (flashRow) flashRow.style.pointerEvents = '';
    
    // Limpiar elementos bloqueados
    const blockedElements = document.querySelectorAll('[style*="pointer-events"]');
    blockedElements.forEach(el => {
      if (el.style.pointerEvents === 'none') {
        el.style.pointerEvents = '';
      }
    });
    
    // Iniciar revise1 despu√©s de un peque√±o delay
    setTimeout(() => {
      startMission('revise1');
    }, 100);
  }

  /* ===== Feedback visual/sonoro y resaltado de cajas ===== */
  function pulseBox(el, colorClass){
    if(!el) return;
    el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal');
    void el.offsetWidth; // reflow para reiniciar animaci√≥n
    el.classList.add('pulseBadge', colorClass);
    setTimeout(()=>{ el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal'); }, 750);
  }
  // üéÆ FUNCI√ìN PARA MOSTRAR PUNTOS FLOTANTES TIPO GAMER
  function showFloatingPoints() {
    // Determinar puntos seg√∫n el tipo de carta
    let points = 1; // Default
    let baseColor = '#00bfff'; // Celeste gamer por defecto
    let fontSize = '28px'; // Tama√±o base
    
    if (cardEl.classList.contains('premium-gold')) {
      points = 2;
      baseColor = '#ffffff'; // Blanco para mejor contraste
      fontSize = '32px'; // M√°s grande porque es m√°s importante
    } else if (cardEl.classList.contains('mythic-violet')) {
      points = 5;
      baseColor = '#ffffff'; // Negro para mejor contraste
      fontSize = '36px'; // M√°s grande porque es m√°s importante
    } else if (cardEl.classList.contains('legendary-red')) {
      points = 1; // O el valor que corresponda para cartas rojas
      baseColor = '#ffffff'; // Negro para mejor contraste
      fontSize = '28px'; // Tama√±o seg√∫n importancia
    }
    
    // üéÆ DETECTAR MODO DE JUEGO INTELIGENTEMENTE
    let displayText = `+${points}`;
    
    // Detectar si es MODO DESAF√çO (challenge, desafioN1, N2, N3, etc.)
    const isDesafioMode = currentMission && (
      currentMission === 'challenge' || 
      currentMission.startsWith('desafio')
    );
    
    // Detectar si es modo Quiz (cualquier quiz)
    const isQuizMode = mode && mode.toLowerCase().includes('quiz');
    
    // Detectar si es modo Flashcard
    const isFlashMode = mode === 'flash';
    
    // Aplicar l√≥gica de texto seg√∫n el modo
    if (isDesafioMode) {
      // MODO DESAF√çO ‚Üí "+X Nivel" o "+X Niveles" (NUNCA XP en desaf√≠os)
      const nivelText = points === 1 ? 'Nivel' : 'Niveles';
      displayText = `+${points} ${nivelText}`;
    } else if (isQuizMode) {
      // Modo Quiz (en unidades, conocidas, revisar) ‚Üí "+X XP" 
      displayText = `+${points} XP`;
    } else if (isFlashMode) {
      // Modo Flashcard (en cualquier misi√≥n) ‚Üí "A la colecci√≥n"
      displayText = 'A la colecci√≥n';
    } else {
      // Fallback para otros casos
      displayText = 'A la colecci√≥n';
    }
    
    // Crear elemento flotante
    const floatingText = document.createElement('div');
    floatingText.textContent = displayText;
    floatingText.style.cssText = `
      position: fixed;
      color: ${baseColor};
      font-size: ${fontSize};
      font-weight: bold;
      font-family: 'Jersey 10', monospace;
      text-shadow: 0 0 4px ${baseColor}, 0 0 8px ${baseColor}60;
      pointer-events: none;
      z-index: 10000;
      opacity: 0;
      transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    `;
    
    // Posicionar cerca de la carta (centrado y un poco m√°s arriba)
    const cardRect = cardEl.getBoundingClientRect();
    floatingText.style.left = (cardRect.left + cardRect.width / 2) + 'px';
    floatingText.style.top = (cardRect.top + cardRect.height / 2 - 30) + 'px';
    floatingText.style.transform = 'translateX(-50%)'; // Centrar horizontalmente
    
    document.body.appendChild(floatingText);
    
    // Animar: fade in + float up (manteniendo centrado)
    requestAnimationFrame(() => {
      floatingText.style.opacity = '1';
      floatingText.style.transform = 'translateX(-50%) translateY(-80px) scale(1.2)';
      
      // Fade out despu√©s de 800ms
      setTimeout(() => {
        floatingText.style.opacity = '0';
        floatingText.style.transform = 'translateX(-50%) translateY(-120px) scale(0.8)';
        
        // Remover del DOM
        setTimeout(() => {
          if (floatingText.parentNode) {
            floatingText.parentNode.removeChild(floatingText);
          }
        }, 400);
      }, 800);
    });
  }

  async function feedbackCorrect(){
    // Reproducir sonido INMEDIATAMENTE junto con la animaci√≥n visual
    soundCorrect();
    
    // üéÆ MOSTRAR PUNTOS FLOTANTES
    showFloatingPoints();
    
    cardEl.classList.remove('shakeAnim'); void cardEl.offsetWidth;
    cardEl.classList.add('popAnim');
    
    // Aplicar override para tarjetas especiales (pausar su glow y aplicar verde)
    if(cardEl.classList.contains('premium-gold') || 
       cardEl.classList.contains('mythic-violet') || 
       cardEl.classList.contains('legendary-red')) {
      cardEl.classList.add('correct-override');
      // Remover la clase despu√©s de la animaci√≥n
      setTimeout(() => {
        cardEl.classList.remove('correct-override');
      }, 420); // Misma duraci√≥n que popAnim
    }
    
    pulseBox(btnKnownBox, 'pulseGreen');
  }
  async function feedbackWrong(){
    cardEl.classList.remove('popAnim'); void cardEl.offsetWidth;
    soundWrong();
    pulseBox(btnRevise1Box, 'pulseAmber');
    pulseBox(btnRevise2Box, 'pulseTeal');
  }

  // Funci√≥n para mostrar notificaci√≥n de castigo del hor√≥scopo
  function showHoroscopePenaltyNotification(lostCharacters) {
    // Remover notificaci√≥n anterior si existe
    const existingNotification = document.querySelector('.horoscope-penalty-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.className = 'horoscope-penalty-notification';
    
    // Construir contenido
    let charactersHtml = '';
    lostCharacters.forEach(char => {
      charactersHtml += `
        <div class="penalty-character">
          <div>
            <span class="penalty-hanzi">${char.hanzi}</span>
            <div class="penalty-meaning">${char.meaning}</div>
          </div>
          <div class="penalty-streak">Nivel ${char.challengeStreak || 0}</div>
        </div>
      `;
    });
    
    notification.innerHTML = `
      <div class="penalty-header">
        <span style="font-size: 24px;">üê≤‚öîÔ∏è</span>
        <span>CASTIGO DEL HOR√ìSCOPO</span>
      </div>
      ${charactersHtml}
      <div style="
        font-size: 14px; 
        margin-top: 5px; 
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        text-align: center;
        padding: 5px;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 8px;
        border: 1px solid #ff6b6b;
      ">
        üíÄ PERDISTE ${lostCharacters.length} CARACTER${lostCharacters.length > 1 ? 'ES' : ''} üíÄ
      </div>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    // Ocultar despu√©s de 4 segundos
    setTimeout(() => {
      notification.classList.add('fadeout');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 500);
    }, 4000);
  }

  // Llama feedback y pasa a siguiente tras una breve pausa
  function respond(knew){
    if(knew) feedbackCorrect();
    else {
      // Todo el feedback visual y de estado a la vez
      feedbackWrong(); // sonido y glow
      cardEl.classList.add('cardWrong','shakeAnim'); // shake y fondo rojo
      // Si es incorrecto, agregar flags de repaso/confirmar inmediatamente
      if(currentCard) ensureReviseFlags(currentCard);
      setTimeout(()=>{
        cardEl.classList.add('cardWrongFade');
        // Fade out a las opciones tras 1s
        const quizBtns = Array.from(quizRow.children);
        quizBtns.forEach(b=>{
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
      }, 1500);
      setTimeout(()=>{
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
      }, 2000);
      return;
    }
    setTimeout(()=>{ answer(knew); }, 920); // Aumentado para que el glow dure m√°s
  }

  function answer(knew){
      if(!currentCard) return;
      const c = currentCard;

      if(currentMission==='challenge'){
        // actualizar racha y √∫ltima hora
        c.lastChallengeAt = now();
        if(knew){
          // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
          if(cardEl.classList.contains('mythic-violet')){
            c.challengeStreak += 5;
          } else if(cardEl.classList.contains('premium-gold')){
            c.challengeStreak += 2;
          } else {
            c.challengeStreak++;
          }
          c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
        } else {
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            console.log('üî¥ TARJETA ROJA (Challenge): Perdiendo car√°cter actual + uno al azar');
            c.known = false;
            c.challengeStreak = 0;
            // Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              const randomChar = knownChars[idx];
              console.log(`üéØ Car√°cter aleatorio perdido: ${randomChar.hanzi} (${randomChar.meaning})`);
              randomChar.known = false;
              randomChar.challengeStreak = 0;
            }
          }
          c.challengeStreak = 0;
          ensureReviseFlags(c); // sale de conocidas -> repaso/confirmar
        }
      } else if(currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3'){
        // Sistema de vidas activo para desaf√≠os N
        console.log(`üéØ DEBUG: Desaf√≠o N - Misi√≥n: ${currentMission}, Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, Vidas: ${desafioNHearts}`);
        
        if(knew){
          // Respuesta correcta
          if(c.known) {
            // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
        } else {
          // Respuesta incorrecta - perder vida solo en desaf√≠os N1, N2, N3 (no en hor√≥scopo)
          if (desafioNActive && (currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3')) {
            loseDesafioNLife();
          }
          
          if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
      } else if(currentMission==='challenge' || currentMission==='clasico' || currentMission==='menos' || currentMission==='mas'){
        // Sistema de vidas2 activo para desaf√≠os cl√°sicos
        console.log(`üéØ DEBUG: Desaf√≠o Cl√°sico - Misi√≥n: ${currentMission}, Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, Vidas2: ${desafioClasico2Hearts}`);
        
        if(knew){
          // Respuesta correcta
          if(c.known) {
            // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
        } else {
          // Respuesta incorrecta - aplicar efectos especiales y modificar tarjeta
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            console.log('üî¥ TARJETA ROJA: Perdiendo car√°cter actual + uno al azar');
            c.known = false;
            c.challengeStreak = 0;
            // Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              const randomChar = knownChars[idx];
              console.log(`üéØ Car√°cter aleatorio perdido: ${randomChar.hanzi} (${randomChar.meaning})`);
              randomChar.known = false;
              randomChar.challengeStreak = 0;
              ensureReviseFlags(randomChar);
            }
          } else if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
          }
          
          if(c.known) {
            ensureReviseFlags(c);
          }
        }
      } else if(currentMission==='desafioColores' || currentMission==='desafioFruta' || currentMission==='desafioVerduras' ||
                 currentMission==='desafioComidas' || currentMission==='desafioAnimales' || currentMission==='desafioDeportes' ||
                 currentMission==='desafioHobbies' || currentMission==='desafioRopa' || currentMission==='desafioCasa' ||
                 currentMission==='desafioCuerpo' || currentMission==='desafioProfesiones' || currentMission==='desafioEmociones'){
        // üê≤ DESAF√çOS DEL HOR√ìSCOPO: Castigo especial por equivocarse
        console.log(`üîç DEBUG: Desaf√≠o hor√≥scopo - Misi√≥n: ${currentMission}, Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}`);
        
        if(c.known) {
          if(knew){
            // Si ya la conoc√≠a y responde bien: sumar nivel
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            // üí• CASTIGO ESPECIAL: Perder car√°cter actual + 2 aleatorios de la colecci√≥n
            console.log('üê≤‚öîÔ∏è Castigo del hor√≥scopo: perdiendo car√°cter actual + 2 aleatorios');
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Perder el car√°cter actual (guardar info antes de modificarlo)
            const currentCharInfo = {
              hanzi: c.hanzi,
              meaning: c.meaning,
              challengeStreak: c.challengeStreak
            };
            lostCharacters.push(currentCharInfo);
            
            c.known = false;
            c.challengeStreak = 0;
            ensureReviseFlags(c);
            
            // 2. Perder 2 caracteres aleatorios adicionales de la colecci√≥n (excluyendo animales del hor√≥scopo)
            const knownChars = cards.filter(card => 
              card.known && 
              card.id !== c.id && 
              !card.isHoroscopeAnimal // No perder animales coleccionados del hor√≥scopo
            );
            
            console.log(`üéØ Caracteres disponibles para castigo: ${knownChars.length}`);
            
            // Perder hasta 2 caracteres aleatorios (si hay suficientes)
            const charactersToLose = Math.min(2, knownChars.length);
            
            for(let i = 0; i < charactersToLose; i++) {
              if(knownChars.length > 0) {
                const randomIndex = Math.floor(Math.random() * knownChars.length);
                const lostChar = knownChars.splice(randomIndex, 1)[0]; // Remover del array para evitar duplicados
                
                // Guardar info antes de modificarlo
                lostCharacters.push({
                  hanzi: lostChar.hanzi,
                  meaning: lostChar.meaning,
                  challengeStreak: lostChar.challengeStreak
                });
                
                lostChar.known = false;
                lostChar.challengeStreak = 0;
                ensureReviseFlags(lostChar);
                console.log(`üíÄ Perdido: ${lostChar.hanzi} (${lostChar.meaning})`);
              }
            }
            
            // Mostrar notificaci√≥n visual
            if(lostCharacters.length > 0) {
              showHoroscopePenaltyNotification(lostCharacters);
              console.log(`‚ö†Ô∏è CASTIGO APLICADO: Perdiste ${lostCharacters.length} caracteres total`);
            } else {
              console.log(`‚ö†Ô∏è No hab√≠a caracteres adicionales para perder`);
            }
          }
        } else if(!knew) {
          // üî• CASTIGO ALTERNATIVO: Si el car√°cter no estaba en conocidas pero fall√≥ en desaf√≠o hor√≥scopo
          console.log('üê≤‚öîÔ∏è Castigo alternativo: car√°cter no conocido pero perdiendo 2 aleatorios');
          
          // Array para recopilar caracteres perdidos para la notificaci√≥n
          const lostCharacters = [];
          
          const knownChars = cards.filter(card => 
            card.known && 
            card.id !== c.id && 
            !card.isHoroscopeAnimal
          );
          
          console.log(`üéØ Caracteres disponibles para castigo alternativo: ${knownChars.length}`);
          
          const charactersToLose = Math.min(2, knownChars.length);
          
          for(let i = 0; i < charactersToLose; i++) {
            if(knownChars.length > 0) {
              const randomIndex = Math.floor(Math.random() * knownChars.length);
              const lostChar = knownChars.splice(randomIndex, 1)[0];
              
              // Guardar info antes de modificarlo
              lostCharacters.push({
                hanzi: lostChar.hanzi,
                meaning: lostChar.meaning,
                challengeStreak: lostChar.challengeStreak
              });
              
              lostChar.known = false;
              lostChar.challengeStreak = 0;
              ensureReviseFlags(lostChar);
              console.log(`üíÄ Perdido (castigo alternativo): ${lostChar.hanzi} (${lostChar.meaning})`);
            }
          }
          
          // Mostrar notificaci√≥n visual
          if(lostCharacters.length > 0) {
            showHoroscopePenaltyNotification(lostCharacters);
            console.log(`‚ö†Ô∏è CASTIGO ALTERNATIVO APLICADO: Perdiste ${lostCharacters.length} caracteres`);
          }
        }
        // Si no est√° en conocidas y responde bien: no hacer nada
      } else if(currentMission === 'ultimateChallenge' && ultimateChallengeActive){
        // üèÜ ULTIMATE CHALLENGE: Sistema de vidas (3 corazones)
        console.log(`üèÜ DEBUG: Ultimate Challenge - Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, Vidas: ${ultimateChallengeHearts}`);
        
        if(c.known) {
          if(knew){
            // Respuesta correcta: sumar nivel como en otros desaf√≠os
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            // üí• RESPUESTA INCORRECTA: Perder 1 vida + castigo de 2 caracteres aleatorios
            ultimateChallengeHearts--;
            updateUltimateChallengeHearts();
            console.log(`üíÄ Vida perdida! Vidas restantes: ${ultimateChallengeHearts}`);
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Perder el car√°cter actual (guardar info antes de modificarlo)
            const currentCharInfo = {
              hanzi: c.hanzi,
              meaning: c.meaning,
              challengeStreak: c.challengeStreak
            };
            lostCharacters.push(currentCharInfo);
            
            c.known = false;
            c.challengeStreak = 0;
            ensureReviseFlags(c);
            
            // 2. Perder 2 caracteres aleatorios adicionales de la colecci√≥n
            const knownChars = cards.filter(card => 
              card.known && 
              card.id !== c.id && 
              !card.isHoroscopeAnimal // No perder animales coleccionados del hor√≥scopo
            );
            
            console.log(`üéØ Caracteres disponibles para castigo Ultimate: ${knownChars.length}`);
            
            const charactersToLose = Math.min(2, knownChars.length);
            
            for(let i = 0; i < charactersToLose; i++) {
              if(knownChars.length > 0) {
                const randomIndex = Math.floor(Math.random() * knownChars.length);
                const lostChar = knownChars.splice(randomIndex, 1)[0];
                
                lostCharacters.push({
                  hanzi: lostChar.hanzi,
                  meaning: lostChar.meaning,
                  challengeStreak: lostChar.challengeStreak
                });
                
                lostChar.known = false;
                lostChar.challengeStreak = 0;
                ensureReviseFlags(lostChar);
                console.log(`üíÄ Ultimate perdido: ${lostChar.hanzi} (${lostChar.meaning})`);
              }
            }
            
            // Mostrar notificaci√≥n de caracteres perdidos
            if(lostCharacters.length > 0) {
              showHoroscopePenaltyNotification(lostCharacters);
              console.log(`‚ö†Ô∏è CASTIGO ULTIMATE APLICADO: Perdiste ${lostCharacters.length} caracteres`);
            }
            
            // Verificar si perdi√≥ todas las vidas
            if(ultimateChallengeHearts <= 0) {
              console.log('üíÄ GAME OVER - Todas las vidas perdidas');
              setTimeout(() => {
                showUltimateChallengeGameOver();
              }, 2000); // Delay para que vea el castigo primero
              return; // Salir sin continuar
            }
          }
        } else if(!knew) {
          // Car√°cter no conocido pero respuesta incorrecta: solo perder vida + 2 aleatorios
          ultimateChallengeHearts--;
          updateUltimateChallengeHearts();
          console.log(`üíÄ Vida perdida (car√°cter no conocido)! Vidas restantes: ${ultimateChallengeHearts}`);
          
          const lostCharacters = [];
          const knownChars = cards.filter(card => 
            card.known && 
            card.id !== c.id && 
            !card.isHoroscopeAnimal
          );
          
          const charactersToLose = Math.min(2, knownChars.length);
          
          for(let i = 0; i < charactersToLose; i++) {
            if(knownChars.length > 0) {
              const randomIndex = Math.floor(Math.random() * knownChars.length);
              const lostChar = knownChars.splice(randomIndex, 1)[0];
              
              lostCharacters.push({
                hanzi: lostChar.hanzi,
                meaning: lostChar.meaning,
                challengeStreak: lostChar.challengeStreak
              });
              
              lostChar.known = false;
              lostChar.challengeStreak = 0;
              ensureReviseFlags(lostChar);
              console.log(`üíÄ Ultimate perdido (alternativo): ${lostChar.hanzi} (${lostChar.meaning})`);
            }
          }
          
          if(lostCharacters.length > 0) {
            showHoroscopePenaltyNotification(lostCharacters);
          }
          
          // Verificar game over
          if(ultimateChallengeHearts <= 0) {
            console.log('üíÄ GAME OVER - Todas las vidas perdidas');
            setTimeout(() => {
              showUltimateChallengeGameOver();
            }, 2000);
            return;
          }
        }
      } else if(currentMission.startsWith('unit') || currentMission==='todoN1' || 
                 currentMission==='colores' || currentMission==='fruta' || currentMission==='verduras' ||
                 currentMission==='comidas' || currentMission==='animales' || currentMission==='deportes' ||
                 currentMission==='hobbies' || currentMission==='ropa' || currentMission==='casa' ||
                 currentMission==='cuerpo' || currentMission==='profesiones' || currentMission==='emociones'){
        if(knew){ c.known = true; }
        else    { ensureReviseFlags(c); }
      } else if(currentMission==='known'){
        if(knew){ c.known = true; }
        else {
          // Solo agrega a revise1 y revise2, pero NO elimina de conocidas ni reinicia challengeStreak
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
          c.known = true; // Asegura que nunca se elimine de conocidas
          // NO modificar challengeStreak
        }
      } else if(currentMission==='revise1'){
        if(knew){ c.revise1 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1/revise2
          if(!c.revise1) c.revise1 = true;  
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      } else if(currentMission==='revise2'){
        if(knew){ c.revise2 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1 y revise2
          if(!c.revise2) c.revise2 = true;
          if(!c.revise1) c.revise1 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      }

      if(knew) {
        sessionCorrect++;
        // Sumar XP si es modo quiz
        if(mode === 'quizPinyin' || mode === 'quizMeaning' || mode === 'quizHanzi') {
          const prevLevel = getCurrentLevel(xpPoints);
          xpPoints++;
          saveXP();
          const newLevel = getCurrentLevel(xpPoints);
          
          // Hacer la animaci√≥n del level up ASINCRONA para no bloquear nextCard()
          setTimeout(() => {
            renderXPBar(newLevel > prevLevel);
          }, 0); // Ejecutar en el siguiente tick del event loop
        }
      }
      todayReviewed++;
      saveAll();
      nextCard();
    }

  function nextCard(){
    // Reset flag de respuesta para nueva carta
    window.isAnswering = false;
    console.log('üéπ DEBUG: isAnswering reseteado en nextCard()');
    
    // DESTRUIR CASILLAS ANTES DEL FLIP (solo en m√≥vil para evitar titileo)
    if(isMobile()) {
      const quizRow = document.getElementById('quizRow');
      if(quizRow) {
        console.log('üßπ Destruyendo casillas ANTES del flip en m√≥vil');
        // Guardar altura para evitar saltos
        const currentHeight = quizRow.offsetHeight;
        quizRow.style.minHeight = currentHeight + 'px';
        // Limpiar casillas
        quizRow.innerHTML = '';
      }
    }
    
    // Delay m√≠nimo antes de iniciar la animaci√≥n de flip
    setTimeout(() => {
      cardEl.classList.add('card-flip-vert', 'flipping');
      setTimeout(() => {
        // En el punto medio del flip, cambiar el contenido
        flipped = false; cardEl.classList.remove('flip');
        // DESAF√çO FINAL: Usar su propio pool de cartas
        if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
          console.log('üîÑ DEBUG: Ultimate Challenge nextCard()');
          console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
          console.log('- ultimateChallengeCards.length:', ultimateChallengeCards.length);
          
          if (ultimateChallengeCardIndex >= ultimateChallengeCards.length) {
            console.warn('‚ùå Ultimate Challenge: No m√°s cartas');
            finishUltimateChallenge();
            return;
          }
          
          currentCard = ultimateChallengeCards[ultimateChallengeCardIndex];
          console.log('üÉã Carta seleccionada:', currentCard);
          
          // Actualizar animal si es necesario (cada 5 cartas)
          const animalIndex = Math.floor(ultimateChallengeCardIndex / 5);
          if (animalIndex !== ultimateChallengeAnimalIndex) {
            ultimateChallengeAnimalIndex = animalIndex;
            console.log('üêæ Cambiando a animal √≠ndice:', ultimateChallengeAnimalIndex);
          }
          
          // SOLO actualizar contador, NO incrementar √≠ndice aqu√≠ (lo hace handleUltimateChallengeAnswer)
          console.log('üìä Llamando updateUltimateChallengeCounter() desde nextCard()');
          updateUltimateChallengeCounter();
        } else {
          currentCard = sessionQueue.shift() || null;
        }
        
        // LIMPIAR CLASES DE BOTONES QUIZ PARA EVITAR CASILLAS SEMI-MARCADAS EN M√ìVIL
        const quizBtns = Array.from(document.querySelectorAll('#quizRow button'));
        quizBtns.forEach(b => {
          // Limpiar todas las clases de estado
          b.classList.remove('optCorrect', 'optWrong', 'optCorrectFade', 'optWrongFade');
          // Limpiar estilos inline que puedan quedar
          b.style.backgroundColor = '';
          b.style.borderColor = '';
          b.style.color = '';
          b.style.opacity = '';
          // Resetear al estado por defecto y habilitar
          b.disabled = false;
          b.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
          // FORZAR RE-RENDER COMPLETO para eliminar estados hover persistentes
          b.style.display = 'none';
          b.offsetHeight; // Trigger reflow
          b.style.display = '';
        });
        
        // Si estamos en challenge o desafios (incluyendo hor√≥scopo), elegir aleatoriamente entre quizMeaning, quizPinyin o quizHanzi
        if((currentMission==='challenge' || currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3' || currentMission.startsWith('desafio')) && currentCard) {
          const quizModes = ['quizMeaning', 'quizPinyin', 'quizHanzi'];
          setMode(quizModes[Math.floor(Math.random() * quizModes.length)]);
          
          // M√ìVIL: Crear casillas DESPU√âS de configurar el modo (solo para desaf√≠os del hor√≥scopo, NO Ultimate Challenge)
          if (isMobile() && currentMission.startsWith('desafio') && currentMission !== 'ultimateChallenge') {
            setTimeout(() => {
              createQuizButtonsAfterFlip();
            }, 15);
          }
          
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        } else if(['quizPinyin','quizMeaning','quizHanzi'].includes(mode) && currentCard) {
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        }
        // Premium gold (20%), mythic violet (10%) y legendary red (5%) en modo desaf√≠o
        if ((currentMission==='challenge'||currentMission==='desafioN1'||currentMission==='desafioN2'||currentMission==='desafioN3'||currentMission.startsWith('desafio')) && currentCard) {
          const rand = Math.random();
          if (rand < 0.15) {
            cardEl.classList.add('legendary-red');
            cardEl.classList.remove('mythic-violet');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.2) {
            cardEl.classList.add('mythic-violet');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.50) {
            cardEl.classList.add('premium-gold');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('mythic-violet');
          } else {
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
            cardEl.classList.remove('mythic-violet');
          }
          
          // üè∑Ô∏è Agregar etiquetas de esquina para tarjetas especiales
          addCardCornerLabel();
        } else {
          cardEl.classList.remove('legendary-red');
          cardEl.classList.remove('premium-gold');
          cardEl.classList.remove('mythic-violet');
          
          // Limpiar etiquetas de esquina
          removeCardCornerLabel();
        }
        
        // DESAF√çO FINAL: Renderizado especial
        if (ultimateChallengeActive && currentMission === 'ultimateChallenge' && currentCard) {
          renderUltimateChallengeCard(currentCard);
        } else {
          renderCard();
        }
        
        updateStats();
        // limpiar animaciones para la pr√≥xima
        cardEl.classList.remove('popAnim','shakeAnim','correct-override');
        // Completar el flip
        cardEl.classList.remove('flipping');
        cardEl.classList.add('flipped');
        setTimeout(() => {
          cardEl.classList.remove('card-flip-vert', 'flipped');
          // SOLUCI√ìN M√ìVIL: Crear casillas por primera vez despu√©s del flip 
          // (NO para desaf√≠os que ya se manejan arriba, Ultimate Challenge se maneja arriba tambi√©n)
          setTimeout(() => {
            if (isMobile() && currentMission !== 'ultimateChallenge' && !currentMission.startsWith('desafio') && currentMission !== 'challenge' && currentMission !== 'desafioN1' && currentMission !== 'desafioN2' && currentMission !== 'desafioN3') {
              createQuizButtonsAfterFlip();
            }
          }, 50);
        }, 440);
      }, 220); // punto medio del flip
    }, 100); // delay m√≠nimo antes de iniciar la animaci√≥n
}

  function renderCard(){
    if(!currentCard){
      const n = sessionTotal, x = sessionCorrect;
      const percent = n > 0 ? Math.round((x / n) * 100) : 0;
      backEl.textContent = '';
      frontEl.innerHTML = `<div class="text-3xl font-semibold">${x} / ${n} correctas</div>`;
      // Prevent flipping on results card
      cardEl.classList.remove('flip');
      cardEl.onclick = null;
      document.getElementById('btnFlip').disabled = true;
      
      // üî• FINALIZAR TIMER2 Y VIDAS2 PARA DESAF√çOS CL√ÅSICOS
      if (desafioClasico2Active && (currentMission === 'challenge' || currentMission === 'clasico' || currentMission === 'menos' || currentMission === 'mas')) {
        console.log('üèÅ FINALIZANDO DESAF√çO CL√ÅSICO: Deteniendo timer2 y ocultando vidas2');
        desafioClasico2Active = false;
        stopDesafioClasico2Timer();
        hideDesafioClasico2Hearts();
      }
      
      // üêæ FINALIZAR SOLO TIMER N PARA DESAF√çOS DEL HOR√ìSCOPO (SIN VIDAS)
      if (desafioNActive && currentMission.startsWith('desafio') && 
          currentMission !== 'desafioN1' && currentMission !== 'desafioN2' && currentMission !== 'desafioN3') {
        console.log('üèÅ FINALIZANDO DESAF√çO HOR√ìSCOPO: Deteniendo solo timer N (sin vidas)');
        desafioNActive = false;
        stopDesafioNTimer();
        // No ocultar vidas N porque no se muestran en desaf√≠os del hor√≥scopo
      }
      
      // Capturar estado final para desaf√≠os y mostrar notificaci√≥n de cambios
      if (currentMission === 'challenge' || currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3' || currentMission.startsWith('desafio')) {
        console.log('üìä Capturando estado post-desaf√≠o y mostrando cambios');
        setTimeout(() => capturePostChallengeState(), 2000); // Delay para que se vean las celebraciones primero
      }
      
      // Sonido y confetti de celebraci√≥n si >= 85%
      if (percent >= 85) {
        showConfetti();
        soundCelebration();
        // Mostrar GIF adorable aleatorio
        const gifs = [
          'img/cat1.gif',
          'img/cat4.gif',
          'img/cat5.gif'
        ];
        const chosen = gifs[Math.floor(Math.random() * gifs.length)];
        showCelebrationGif(chosen);
        // Actualizar racha en backend SOLO si est√° en modo desaf√≠o
        if (currentMission === 'challenge' || currentMission === 'desafioN1') {
          actualizarRacha(percent);
        }
        
        // Marcar Desaf√≠o N3 como completado si se aprob√≥
        if (currentMission === 'desafioN3') {
          console.log('üéØ Desaf√≠o N3 finalizado con', percent, '% de aciertos');
          completarDesafioN3();
        }
        
        // DESBLOQUEAR ANIMAL DEL HOR√ìSCOPO si es un desaf√≠o del hor√≥scopo exitoso
        console.log(`üîç DEBUG Desbloqueo: percent=${percent}, currentMission=${currentMission}`);
        console.log(`üîç Es desaf√≠o hor√≥scopo?: ${isHoroscopeChallenge(currentMission)}`);
        
        if (percent >= 85 && isHoroscopeChallenge(currentMission)) {
          const categoria = getHoroscopeCategoryFromMission(currentMission);
          console.log(`üéâ DESBLOQUEANDO ANIMAL: ${categoria}`);
          unlockHoroscopeAnimal(categoria);
        } else {
          console.log(`‚ùå No se desbloquea: percent < 85 o no es desaf√≠o hor√≥scopo`);
        }
        
        // MENSAJE ESPECIAL PARA DESAF√çO N3
        if (currentMission === 'desafioN3') {
          showDesafioN3Message();
        }
      }
// Actualiza la racha localmente (modo documental)
async function actualizarRacha(percent) {
  if (!jwtToken) return;

  try {
    const now = Date.now();
    const last = lastChallengeAt ? new Date(lastChallengeAt).getTime() : null;

    const nowDate = new Date(now);
    const lastDate = last ? new Date(last) : null;
    const sameDay = !!(lastDate &&
      nowDate.getFullYear() === lastDate.getFullYear() &&
      nowDate.getMonth() === lastDate.getMonth() &&
      nowDate.getDate() === lastDate.getDate());

    if (!sameDay) {
      streak = (streak || 0) + 1;
      lastChallengeAt = now;
      await saveUserState();
      animarStreakFire();
    }

    updateStreakBox();
  } catch (e) {
    console.warn('‚ö†Ô∏è actualizarRacha (modo documental) fall√≥:', e);
  }
}

// Animaci√≥n de fuego en el box de racha
function animarStreakFire() {
  const box = document.getElementById('streakBox');
  if (!box) return;
  box.classList.add('streak-fire-anim');
  // Solo animaci√≥n visual, sin emoji
  soundFireEffect();
  setTimeout(() => {
    box.classList.remove('streak-fire-anim');
  }, 1500);
}

// Sonido especial de fuego
function soundFireEffect() {
  // Sonido glorioso tipo coro: acorde mayor y fade
  beep(523, 0.22, 'triangle', 0.13); // C5
  beep(659, 0.22, 'triangle', 0.11); // E5
  beep(784, 0.22, 'triangle', 0.10); // G5
  setTimeout(() => beep(1046, 0.18, 'triangle', 0.09), 120); // C6
  setTimeout(() => beep(1568, 0.13, 'triangle', 0.08), 220); // G6
}

/* Animaci√≥n CSS para el box de racha */
const streakFireStyle = document.createElement('style');
streakFireStyle.textContent = `
  .streak-fire-anim {
    box-shadow: 0 0 32px 8px #f87171, 0 0 0 4px #f59e42;
    background: linear-gradient(90deg, #f59e42 0%, #f87171 100%);
    transition: box-shadow 0.3s, background 0.3s;
  }
`;
document.head.appendChild(streakFireStyle);
// Muestra un GIF adorable en el centro de la pantalla por 2 segundos
function showCelebrationGif(src) {
  let gif = document.getElementById('celebrationGif');
  if (!gif) {
    gif = document.createElement('img');
    gif.id = 'celebrationGif';
    gif.src = src;
    gif.style.position = 'fixed';
    // Ubicaci√≥n: centrado horizontal, posicionamiento optimizado para m√≥vil
    const card = document.getElementById('card');
    if (card) {
      const rect = card.getBoundingClientRect();
      gif.style.left = (rect.left + rect.width/2) + 'px';
      
      // Ajuste especial para m√≥vil: evitar que se corte
      if (isMobile()) {
        // En m√≥vil: posicionar en el centro vertical de la tarjeta
        gif.style.top = (rect.top + rect.height/2) + 'px';
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        // En desktop: posici√≥n original debajo de la tarjeta
        gif.style.top = (rect.bottom) + 'px';
        gif.style.transform = 'translate(-50%, 0)';
      }
    } else {
      gif.style.left = '50%';
      if (isMobile()) {
        gif.style.top = '50%'; // Centro en m√≥vil
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        gif.style.top = '80%'; // Posici√≥n original en desktop
        gif.style.transform = 'translate(-50%, 0)';
      }
    }
    gif.style.zIndex = '99999';
  // Tama√±o por defecto
  let gifWidth = 270;
  
  // Ajuste para m√≥vil: reducir tama√±o para que no se salga de pantalla
  if (isMobile()) {
    gifWidth = Math.min(gifWidth, window.innerWidth * 0.6); // M√°ximo 60% del ancho de pantalla
  }
  
  // Ajuste especial para cat1, cat4 y cat5
  if (src.includes('cat1')) gifWidth = Math.round(gifWidth * 1.3); // 30% m√°s grande
  if (src.includes('cat4')) gifWidth = Math.round(gifWidth * 0.75); // 35% m√°s peque√±o
  if (src.includes('cat5')) gifWidth = Math.round(gifWidth * 0.5);  // 50% m√°s peque√±o
  gif.style.width = gifWidth + 'px';
    gif.style.height = 'auto';
    gif.style.opacity = '1';
    gif.style.transition = 'opacity 0.7s';
    document.body.appendChild(gif);
  } else {
    gif.src = src;
    gif.style.opacity = '1';
    gif.style.display = '';
  }
  setTimeout(() => {
    gif.style.opacity = '0';
    setTimeout(() => { if (gif) gif.style.display = 'none'; }, 700);
  }, 2000);
}
      // --- L√≥gica para mostrar bot√≥n Nivel 2 e insignia ---
      if(currentMission==='desafioN1'){
        // Limpiar sistema de desaf√≠o N
        desafioNActive = false;
        stopDesafioNTimer();
        hideDesafioNHearts();
        
        if(sessionTotal === 20){
          if(desafioNTimeLeft>0 && percent>=90){
            showNivel2Button();
            showNivel1Badge();
          } else if(desafioNTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioNoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioNoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }

      // --- L√≥gica para mostrar bot√≥n Nivel 3 ---
      if(currentMission==='desafioN2'){
        // Limpiar sistema de desaf√≠o N
        desafioNActive = false;
        stopDesafioNTimer();
        hideDesafioNHearts();
        
        if(sessionTotal === 20){
          if(desafioNTimeLeft>0 && percent>=90){
            showNivel3Button();
            showNivel2Badge();
          } else if(desafioNTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioN2NoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioN2NoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado el Desaf√≠o N2 (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }
      // Ocultar la tabla de conocidas en modo desaf√≠o
      const knownTableSection = document.querySelector('section.mt-16');
      if(currentMission==='challenge' || currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3' || currentMission.startsWith('desafio')) {
        if(knownTableSection) knownTableSection.style.display = 'none';
      } else {
        if(knownTableSection) knownTableSection.style.display = '';
      }
  return;
}

// --- Mensaje especial para Desaf√≠o N3 ---
function showDesafioN3Message() {
  // Limpiar sistema de desaf√≠o N
  desafioNActive = false;
  stopDesafioNTimer();
  hideDesafioNHearts();
  // Crear overlay de mensaje especial
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
  overlay.style.backdropFilter = 'blur(5px)';
  
  const messageBox = document.createElement('div');
  messageBox.className = 'bg-gradient-to-br from-emerald-800 to-emerald-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-emerald-400';
  
  messageBox.innerHTML = `
    <div class="text-6xl mb-4">üéâ</div>
    <h2 class="text-3xl font-bold mb-4 text-emerald-200">¬°Desaf√≠o N3 Completado!</h2>
    <div class="text-lg mb-6 leading-relaxed">
      <p class="mb-4">¬°Proximamente m√°s contenido!</p>
      <p class="mb-4">Guarda este c√≥digo:</p>
      <div class="bg-emerald-700 px-4 py-3 rounded-xl text-2xl font-mono font-bold tracking-wider border border-emerald-400">
        manuesgrande
      </div>
    </div>
    <div class="text-sm text-emerald-300 mb-6">
      Si te ha gustado recuerda que puedes donar ‚ù§Ô∏è
    </div>
    <button class="bg-emerald-600 hover:bg-emerald-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors w-full">
      ¬°Continuar!
    </button>
  `;
  
  // Agregar event listener al bot√≥n
  const continueBtn = messageBox.querySelector('button');
  continueBtn.onclick = () => {
    overlay.remove();
  };
  
  overlay.appendChild(messageBox);
  document.body.appendChild(overlay);
  
  // Sonido especial de logro
  setTimeout(() => {
    beep(523, 0.3, 'sine', 0.2); // C5
    setTimeout(() => beep(659, 0.3, 'sine', 0.18), 150); // E5
    setTimeout(() => beep(784, 0.3, 'sine', 0.16), 300); // G5
    setTimeout(() => beep(1046, 0.4, 'sine', 0.15), 450); // C6
  }, 500);
}

// --- Mostrar bot√≥n Nivel 2 ---
function showNivel2Button(){
  nivel2Unlocked = true;
  saveUserState();
  
  // Mostrar el Nivel 2
  const nivel2Wrap = document.getElementById('nivel2Wrap');
  const btnNivel2 = document.getElementById('btnNivel2');
  
  if(nivel2Wrap) nivel2Wrap.style.display = '';
  if(btnNivel2) btnNivel2.style.display = '';
  
  console.log('‚úÖ Nivel 2 desbloqueado y mostrado');
}

// --- Mostrar bot√≥n Nivel 3 ---
function showNivel3Button(){
  nivel3Unlocked = true;
  saveUserState();
  
  // Mostrar el Nivel 3
  const nivel3Wrap = document.getElementById('nivel3Wrap');
  const btnNivel3 = document.getElementById('btnNivel3');
  
  if(nivel3Wrap) nivel3Wrap.style.display = '';
  if(btnNivel3) btnNivel3.style.display = '';
  
  // Desbloquear botones del hor√≥scopo
  updateHoroscopeButtonsState();
  
  // Mostrar mensaje de celebraci√≥n por desbloqueo
  setTimeout(() => {
    showNivel3UnlockedCelebration();
  }, 1000); // Peque√±o delay para que se vea primero el badge del nivel 2
  
  console.log('‚úÖ Nivel 3 desbloqueado y mostrado');
}

// Actualizar estado visual de botones del hor√≥scopo
function updateHoroscopeButtonsState() {
  const btnHoroscopo = document.getElementById('btnHoroscopo');
  const btnDesafiosHoroscopo = document.getElementById('btnDesafiosHoroscopo');
  
  console.log('üîÑ Actualizando estado botones hor√≥scopo. Nivel3Unlocked:', nivel3Unlocked);
  
  if (nivel3Unlocked) {
    // Desbloquear: remover clase locked y restaurar estilos normales
    if (btnHoroscopo) {
      btnHoroscopo.classList.remove('locked');
      btnHoroscopo.style.cursor = 'pointer';
      btnHoroscopo.style.opacity = '1';
      // Forzar estilos normales
      btnHoroscopo.style.background = '';
      btnHoroscopo.style.color = '';
      btnHoroscopo.style.border = '';
    }
    if (btnDesafiosHoroscopo) {
      btnDesafiosHoroscopo.classList.remove('locked');
      btnDesafiosHoroscopo.style.cursor = 'pointer';
      btnDesafiosHoroscopo.style.opacity = '1';
      // Forzar estilos normales
      btnDesafiosHoroscopo.style.background = '';
      btnDesafiosHoroscopo.style.color = '';
      btnDesafiosHoroscopo.style.border = '';
    }
    console.log('üîì Botones del hor√≥scopo desbloqueados y estilos restaurados');
  } else {
    // Bloquear: agregar clase locked
    if (btnHoroscopo) {
      btnHoroscopo.classList.add('locked');
    }
    if (btnDesafiosHoroscopo) {
      btnDesafiosHoroscopo.classList.add('locked');
    }
    console.log('üîí Botones del hor√≥scopo bloqueados');
  }
}

// Mostrar el bot√≥n Nivel 2 si est√° desbloqueado al cargar la p√°gina
window.addEventListener('DOMContentLoaded', async () => {
    // Bot√≥n cerrar sesi√≥n al lado de "si se traba"
    const btnTraba = document.getElementById('btnTraba');
    if(btnTraba && !document.getElementById('btnLogout')) {
      const btnLogout = document.createElement('button');
      btnLogout.id = 'btnLogout';
      btnLogout.textContent = 'Cerrar sesi√≥n';
      btnLogout.className = 'ml-2 px-4 py-2 rounded-xl bg-red-700 hover:bg-red-600 text-white font-bold';
      btnLogout.onclick = () => {
        localStorage.removeItem('jwtToken');
        location.reload();
      };
      btnTraba.parentNode.insertBefore(btnLogout, btnTraba.nextSibling);
    }
  await loadAll();
  if(nivel2Unlocked) {
    console.log('üéØ DOMContentLoaded: Verificaci√≥n adicional de Nivel 2');
    if (typeof showNivel2Button === 'function') {
      showNivel2Button();
    } else {
      // Mostrar directamente
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      if(nivel2Wrap) nivel2Wrap.style.display = '';
      if(btnNivel2) btnNivel2.style.display = '';
    }
  }
  
  // DEBUG: Verificaci√≥n temporal adicional
  console.log('üîç Estado al cargar p√°gina:');
  console.log('- nivel2Unlocked:', nivel2Unlocked);
  console.log('- xpPoints:', xpPoints);
  
  // Inicializar botones de reinicio
  initializeResetButtons();
  
  // ========= CONFIGURAR BOT√ìN HISTORIA =========
  console.log('üé≠ DEBUG: Configurando bot√≥n Historia en DOMContentLoaded principal');
  
  const btnHistoria = document.getElementById('btnHistoria');
  if (btnHistoria) {
    btnHistoria.onclick = function() {
      console.log('üé≠ DEBUG: ¬°Bot√≥n Historia clickeado!');
      showChapterModal();
    };
    console.log('üé≠ DEBUG: ‚úÖ Event listener del bot√≥n Historia configurado correctamente');
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el bot√≥n Historia en el DOM');
  }
});
// --- Mostrar insignia de Nivel 1 aprobado ---
function showNivel1Badge(){
  // Eliminado: insignia estrella
}

// --- Mostrar insignia de Nivel 2 aprobado ---
function showNivel2Badge(){
  // Eliminado: insignia estrella
}
    // Frente: siempre hanzi, con bot√≥n de parlante si no es desaf√≠o
    frontEl.innerHTML = '';
    // Contenedor relativo para posicionar el parlante
    const frontWrap = document.createElement('div');
    frontWrap.style.position = 'relative';
    frontWrap.style.width = '100%';
    frontWrap.style.height = '100%';
    // Hanzi centrado
    const hanziSpan = document.createElement('span');
    hanziSpan.textContent = currentCard.hanzi;
    hanziSpan.style.display = 'inline-block';
    hanziSpan.style.position = 'absolute';
    hanziSpan.style.top = '50%';
    hanziSpan.style.left = '50%';
    hanziSpan.style.transform = 'translate(-50%, -50%)';
    frontWrap.appendChild(hanziSpan);
    // Bot√≥n parlante (solo si no es desaf√≠o)
    if(currentMission !== 'challenge') {
      const speakBtn = document.createElement('button');
      speakBtn.title = 'Escuchar pronunciaci√≥n';
      speakBtn.style.position = 'absolute';
      speakBtn.style.top = '10px';
      speakBtn.style.right = '10px';
      speakBtn.style.background = 'rgba(30,41,59,0.85)';
      speakBtn.style.border = 'none';
      speakBtn.style.cursor = 'pointer';
      speakBtn.style.borderRadius = '50%';
      speakBtn.style.padding = '4px';
      speakBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
      speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5zm7.07 2.93a10 10 0 010 14.14m2.83-2.83a6 6 0 000-8.48"/></svg>';
      speakBtn.onclick = (e) => {
        e.stopPropagation();
        speakHanzi(currentCard.hanzi, speakBtn);
      };
      frontWrap.appendChild(speakBtn);
    }
    frontEl.appendChild(frontWrap);

    // Enable flipping for normal cards

    cardEl.onclick = () => {
      if(currentCard && mode==='flash'){
        flipped = !flipped;
        flipped ? cardEl.classList.add('flip') : cardEl.classList.remove('flip');
      }
    };
    document.getElementById('btnFlip').disabled = false;
// Pronuncia el Hanzi (modo documental: TTS desactivado, sin requests)
async function speakHanzi(text, buttonElement = null) {
  // Feedback visual inmediato: glow verde inicial
  if (buttonElement) {
    buttonElement.classList.add('speaker-glow-active');
    setTimeout(() => {
      buttonElement.classList.remove('speaker-glow-active');
    }, 600);
  }

  console.log('üîá TTS desactivado en modo documental:', text);
}

    if(mode === 'flash'){
          
          
          

          
          
           backEl.innerHTML = `<div class="mb-2">${currentCard.pinyin}</div><div>${currentCard.meaning}</div>`;
      flashRow.classList.remove('hidden');
      quizRow.classList.add('hidden');
    } else {
      backEl.textContent = '';
      flashRow.classList.add('hidden');
      quizRow.classList.remove('hidden');
      
      // ULTIMATE CHALLENGE: Usar setupQuizChoices siempre
      if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
        console.log('üèÜ Ultimate Challenge: Usando setupQuizChoices');
        setupQuizChoices();
      }
      // Usar setupChallengeCard para modo desaf√≠o, setupQuizChoices para el resto
      else if (currentMission === 'challenge' || currentMission === 'desafioN1') {
        if (!setupChallengeCard()) {
          setupQuizChoices(); // fallback si setupChallengeCard falla
        }
      } else {
        setupQuizChoices();
      }
    }
  }

  // Confetti effect for celebration - versi√≥n solo verde
  function showConfetti() {
    let confettiCanvas = document.getElementById('confettiCanvas');
    if (!confettiCanvas) {
      confettiCanvas = document.createElement('canvas');
      confettiCanvas.id = 'confettiCanvas';
      confettiCanvas.style.position = 'fixed';
      confettiCanvas.style.left = '0';
      confettiCanvas.style.top = '0';
      confettiCanvas.style.width = '100vw';
      confettiCanvas.style.height = '100vh';
      confettiCanvas.style.pointerEvents = 'none'; // Asegura que nunca bloquee clics
      confettiCanvas.style.zIndex = '9999';
      document.body.appendChild(confettiCanvas);
    }
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiCanvas.style.pointerEvents = 'none'; // Refuerza pointer-events

    const ctx = confettiCanvas.getContext('2d');
    const colors = ['#22c55e','#16a34a','#10b981','#34d399','#86efac','#166534'];
    const pieces = 140;
    const confetti = [];

    // Get card position for explosion origin
    const cardRect = cardEl.getBoundingClientRect();
    let originX = cardRect.left + cardRect.width/2;
    let originY;
    
    if (isMobile()) {
      // En m√≥vil: origen en el centro de la tarjeta para evitar cortes
      originY = cardRect.top + cardRect.height/2;
    } else {
      // En desktop: origen debajo de la tarjeta (original)
      originY = cardRect.bottom - 10;
    }

    for (let i = 0; i < pieces; i++) {
      const angle = Math.PI/2 + (Math.random()-0.5)*Math.PI/1.2; // mostly upward
      const speed = Math.random()*7+6;
      confetti.push({
        x: originX,
        y: originY,
        r: Math.random() * 8 + 4,
        c: colors[Math.floor(Math.random() * colors.length)],
        vx: Math.cos(angle)*speed,
        vy: -Math.abs(Math.sin(angle)*speed*1.5), // 50% m√°s alto
        alpha: 1,
        gravity: 0.25 + Math.random()*0.15,
        fade: 0.012 + Math.random()*0.008
      });
    }

    let frames = 0;
    function draw() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (const p of confetti) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = p.c;
        ctx.globalAlpha = p.alpha;
        ctx.fill();
        ctx.restore();

        // Movimiento: primero suben, luego caen y se desvanecen
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.gravity;
        if (frames > 30) p.alpha -= p.fade; // fade out after some frames
        if (p.alpha < 0) p.alpha = 0;
      }
      frames++;
      if (frames < 90) {
        requestAnimationFrame(draw);
      } else {
        // Eliminar canvas y asegurar pointer-events none
        confettiCanvas.style.pointerEvents = 'none';
        if (confettiCanvas.parentNode) confettiCanvas.parentNode.removeChild(confettiCanvas);
      }
    }
    draw();
}


  /* ========= QUIZ ========= */
  
  // Funci√≥n para crear casillas por primera vez despu√©s del flip (solo m√≥vil)
  function createQuizButtonsAfterFlip() {
    console.log('üì± Creando casillas por primera vez despu√©s del flip');
    console.log('üì± DEBUG currentMission:', currentMission);
    console.log('üì± DEBUG ultimateChallengeActive:', ultimateChallengeActive);
    
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) {
      console.error('‚ùå createQuizButtonsAfterFlip: quizRow no encontrado');
      return;
    }
    
    console.log('üì± DEBUG quizRow classes:', quizRow.className);
    console.log('üì± DEBUG quizRow display:', getComputedStyle(quizRow).display);
    
    // Limpiar cualquier bot√≥n existente
    quizRow.innerHTML = '';
    
    // Crear 4 botones nuevos desde cero INVISIBLES inicialmente
    for(let i = 0; i < 4; i++) {
      const btn = document.createElement('button');
      btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
      btn.style.fontSize = '24px';
      btn.style.outline = 'none';
      btn.style.webkitTapHighlightColor = 'transparent';
      
      // CREAR INVISIBLES para evitar el "1 frame visible"
      btn.style.opacity = '0';
      btn.style.pointerEvents = 'auto'; // Mantener funcionalidad
      
      // Auto-blur inmediato en m√≥vil
      btn.addEventListener('touchend', function() {
        setTimeout(() => this.blur(), 5);
      });
      
      quizRow.appendChild(btn);
    }
    
    console.log('‚úÖ Casillas creadas invisibles, configurando contenido...');
    
    // Re-aplicar la l√≥gica de quiz despu√©s de crear
    if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
      setupQuizChoices();
    }
    
    // ACTIVAR FADE-IN en el siguiente frame del navegador
    requestAnimationFrame(() => {
      const buttons = quizRow.querySelectorAll('.quizOpt');
      buttons.forEach((btn, i) => {
        btn.classList.add('mobile-fade-in');
        btn.style.animationDelay = (i * 50) + 'ms';
        // Hacer visible con la animaci√≥n
        btn.style.opacity = '1';
      });
      
      console.log('üé¨ Fade-in activado en siguiente frame');
      
      // Limpiar animaciones despu√©s de que terminen
      setTimeout(() => {
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 600);
    });
  }

  // Detectar si estamos en m√≥vil
  function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
           ('ontouchstart' in window) || 
           (navigator.maxTouchPoints > 0);
  }

  // Funci√≥n para recrear completamente los botones de quiz en m√≥vil (elimina cualquier estado focus)
  function forceRecreateQuizButtons() {
    console.log('ÔøΩ RECREACI√ìN M√ìVIL de botones...');
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) return;
    
    // Guardar altura actual para evitar movimiento de contenido
    const currentHeight = quizRow.offsetHeight;
    quizRow.style.minHeight = currentHeight + 'px';
    
    // PASO 1: DESTRUCCI√ìN COMPLETA - Eliminar todo el contenido
    quizRow.innerHTML = '';
    
    // PASO 2: RECREACI√ìN INMEDIATA 
    setTimeout(() => {
      console.log('üÜï Creando botones nuevos sin historial...');
      
      // Recrear 4 botones completamente nuevos desde cero con animaci√≥n
      for(let i = 0; i < 4; i++) {
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base mobile-fade-in';
        btn.style.fontSize = '24px';
        btn.style.outline = 'none';
        btn.style.webkitTapHighlightColor = 'transparent';
        btn.style.animationDelay = (i * 50) + 'ms'; // Delay escalonado para cada bot√≥n
        
        // Auto-blur inmediato en m√≥vil
        btn.addEventListener('touchend', function() {
          setTimeout(() => this.blur(), 5);
        });
        
        quizRow.appendChild(btn);
      }
      
      // Re-aplicar la l√≥gica de quiz despu√©s de recrear
      if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
        setupQuizChoices();
      }
      
      // Restaurar altura autom√°tica despu√©s de recrear
      setTimeout(() => {
        quizRow.style.minHeight = '';
        
        // Limpiar clases de animaci√≥n despu√©s de que terminen
        const buttons = quizRow.querySelectorAll('.quizOpt');
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 400); // 300ms de animaci√≥n + 100ms extra
      
      console.log('‚úÖ Botones m√≥vil recreados exitosamente');
    }, 30); // Muy r√°pido pero suficiente para limpiar DOM
  }
  
  
  function setupQuizChoices(){
    // DEBUG ULTIMATE CHALLENGE
    if (ultimateChallengeActive) {
      console.log('üéÆ setupQuizChoices - Ultimate Challenge Mode');
      console.log('- currentCard:', currentCard);
      console.log('- mode:', mode);
      console.log('- forceSpanishQuestion:', currentCard?.forceSpanishQuestion);
      console.log('- ultimateChallengeMode:', currentCard?.ultimateChallengeMode);
      

    }
    
    // Asegurar 4 botones
    if(quizRow.children.length !== 4){
      quizRow.innerHTML = '';
      for(let i=0;i<4;i++){
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
        btn.style.fontSize = '24px';
        
        // En m√≥vil: Solo hacer invisibles si NO es Ultimate Challenge
        // En Ultimate Challenge, las casillas siempre deben ser visibles
        if (isMobile() && !ultimateChallengeActive && !btn.classList.contains('mobile-fade-in')) {
          btn.style.opacity = '0';
          btn.style.pointerEvents = 'none';
        }
        
        quizRow.appendChild(btn);
      }
    }
    
    // Limpiar flag de respuesta
    window.isAnswering = false;
    
    const quizBtns = Array.from(quizRow.children);

    // ULTIMATE CHALLENGE: Configuraci√≥n especial
    if (ultimateChallengeActive && currentCard?.forceSpanishQuestion) {
      console.log('üèÜ ULTIMATE CHALLENGE: Configurando pregunta en espa√±ol');
      
      // MOSTRAR PREGUNTA EN ESPA√ëOL
      frontEl.innerHTML = `<div class='text-3xl sm:text-4xl font-bold flex items-center justify-center h-full text-center p-4'>${currentCard.meaning}</div>`;
      backEl.innerHTML = '';
      
      // OPCIONES: hanzi o pinyin seg√∫n el modo
      const field = currentCard.ultimateChallengeMode === 'hanzi' ? 'hanzi' : 'pinyin';
      const correct = currentCard[field];
      
      console.log(`üìù Campo de respuesta: ${field}`);
      console.log(`‚úÖ Respuesta correcta: ${correct}`);
      
      // üéØ APLICAR SISTEMA INTELIGENTE ESPEC√çFICO PARA ULTIMATE CHALLENGE
      console.log('üèÜ Ultimate Challenge: Aplicando sistema inteligente (SIEMPRE TEM√ÅTICA)');
      
      const source = ultimateChallengeCards.filter(c => c.id !== currentCard.id);
      
      // Generar opciones inteligentes con estrategia FORZADA a 'unit' (tem√°tica)
      const smartOptions = generateSmartOptionsUltimate(currentCard, source, field, true);
      
      // Crear opciones finales
      const options = shuffle([correct, ...smartOptions]);
      console.log('üéØ Ultimate Challenge - Opciones inteligentes generadas:', options);
      
      // Configurar botones
      quizBtns.forEach((btn, idx) => {
        btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
        btn.textContent = options[idx];
        btn.onclick = () => handleUltimateChallengeAnswer(btn, options[idx], correct, quizBtns, options);
      });
      
      return; // Salir aqu√≠ para Ultimate Challenge
    }

    // MODO NORMAL: Generar opciones desde el pool actual de la misi√≥n (o todas si vac√≠o)
    const pool = buildQueue(currentMission);
    const source = pool.length ? pool : cards;

    const field   = (mode==='quizPinyin') ? 'pinyin' : (mode==='quizHanzi') ? 'hanzi' : 'meaning';
    const correct = currentCard[field];

    const values = new Set([correct]);
    const distractors = [];
    const candidates = shuffle(source.filter(c => c.id !== currentCard.id));
    for(const c of candidates){
      const v = c[field];
      if(!values.has(v)){ values.add(v); distractors.push(v); }
      if(distractors.length===3) break;
    }
    while(distractors.length<3){ distractors.push('‚Äî'); } // fallback

    const options = shuffle([correct, ...distractors]);

    function setDisabledAll(flag){ quizBtns.forEach(b=>b.disabled=flag); }

    quizBtns.forEach((btn, idx) => {
      btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
      btn.textContent = options[idx];
      btn.onclick = () => {
        // Marcar que estamos respondiendo para que los nuevos botones aparezcan invisibles
        window.isAnswering = true;
        
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        btn.blur();
        const isCorrect = options[idx] === correct;
        setDisabledAll(true);
        
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          
          // En m√≥vil: fade-out de TODAS las casillas juntas despu√©s del glow
          if(isMobile()) {
            setTimeout(() => {
              // TODAS las casillas se desvanecen al mismo tiempo
              quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
            }, 800); // Despu√©s de que el glow tenga tiempo de verse
          }
          
          setTimeout(()=>{
            setDisabledAll(false);
            window.isAnswering = false; // Reset para permitir teclado nuevamente
            console.log('üéπ DEBUG: isAnswering reseteado a false (respuesta correcta)');
          }, 450);
        } else {
          btn.classList.add('optWrong');
          quizBtns.forEach((b, i) => {
            if(options[i] === correct) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            quizBtns.forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
            
            // En m√≥vil: fade-out de TODAS las casillas juntas
            if(isMobile()) {
              setTimeout(() => {
                // TODAS las casillas se desvanecen al mismo tiempo
                quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
              }, 900); // Despu√©s de las animaciones de correcto/incorrecto
            }
          }, 1000);
          
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            window.isAnswering = false; // Reset para permitir teclado nuevamente
            console.log('üéπ DEBUG: isAnswering reseteado a false (respuesta incorrecta)');
            answer(false);
          }, 2000);
        }
      };
    });
    
    // üéπ CONTROLES DE TECLADO PARA DESKTOP (NO en Ultimate Challenge)
    if (!isMobile() && !ultimateChallengeActive) {
      // Peque√±o delay para asegurar que los botones est√©n completamente configurados
      setTimeout(() => {
        setupKeyboardControls(quizBtns, options, correct, setDisabledAll);
      }, 50);
    }
  }

  // üéπ Sistema de controles de teclado para desktop
  function setupKeyboardControls(quizBtns, options, correct, setDisabledAll) {
    // Limpiar listeners anteriores
    document.removeEventListener('keydown', window.quizKeyboardHandler);
    
    // Mostrar indicador de teclado
    const keyboardHint = document.getElementById('keyboardHint');
    if (keyboardHint) {
      keyboardHint.classList.remove('hidden');
    }
    
    console.log('üéπ DEBUG: Configurando teclado con opciones:', options, 'correcta:', correct);
    
    // Crear nuevo handler
    window.quizKeyboardHandler = function(e) {
      // DEBUG: Verificar estado actual
      console.log('üéπ DEBUG: Tecla presionada, modo actual:', mode, 'quizBtns length:', quizBtns.length, 'isAnswering:', window.isAnswering);
      
      // Verificaci√≥n mejorada: Si hay 4 botones con contenido (sin importar si est√°n disabled temporalmente)
      const buttonsWithContent = quizBtns.filter(btn => btn && btn.textContent.trim() !== '');
      console.log('üéπ DEBUG: Botones con contenido:', buttonsWithContent.length);
      console.log('üéπ DEBUG: Estados de botones:', quizBtns.map((btn, i) => `${i+1}: disabled=${btn.disabled}, text="${btn.textContent}"`));
      
      // Solo funcionar si tenemos botones con contenido O si estamos en modo quiz expl√≠cito
      const isQuizMode = ['quizMeaning', 'quizPinyin', 'quizHanzi'].includes(mode) || buttonsWithContent.length === 4;
      if (!isQuizMode) {
        console.log('üéπ DEBUG: No es modo quiz v√°lido. Modo:', mode, 'Botones con contenido:', buttonsWithContent.length);
        return;
      }
      if (quizBtns.length !== 4) {
        console.log('üéπ DEBUG: No hay 4 botones quiz:', quizBtns.length);
        return;
      }
      if (window.isAnswering) {
        console.log('üéπ DEBUG: Bloqueado por isAnswering');
        return;
      }
      
      // Verificaci√≥n adicional: asegurar que los botones existen y est√°n visibles
      const quizRow = document.getElementById('quizRow');
      if (!quizRow || quizRow.classList.contains('hidden')) {
        console.log('üéπ DEBUG: quizRow no visible');
        return;
      }
      
      let buttonIndex = -1;
      
      // Mapear teclas a posiciones:
      // 1 = arriba izquierda (0)  2 = arriba derecha (1)
      // 3 = abajo izquierda (2)   4 = abajo derecha (3)
      switch(e.code) {
        case 'Digit1':
        case 'Numpad1':
          buttonIndex = 0; // Arriba izquierda
          break;
        case 'Digit2':
        case 'Numpad2':
          buttonIndex = 1; // Arriba derecha
          break;
        case 'Digit3':
        case 'Numpad3':
          buttonIndex = 2; // Abajo izquierda
          break;
        case 'Digit4':
        case 'Numpad4':
          buttonIndex = 3; // Abajo derecha
          break;
        default:
          return; // Ignorar otras teclas
      }
      
      // Prevenir comportamiento por defecto
      e.preventDefault();
      
      // Ejecutar la misma l√≥gica que el onclick original
      const button = quizBtns[buttonIndex];
      console.log(`üéπ DEBUG: Intentando activar bot√≥n ${buttonIndex + 1}:`, !!button, 'disabled:', button?.disabled, 'text:', button?.textContent);
      
      if (button && button.textContent.trim() !== '' && options && correct) {
        const selectedOption = options[buttonIndex];
        const isCorrect = selectedOption === correct;
        
        console.log(`üéπ ‚úÖ Evaluando respuesta del bot√≥n ${buttonIndex + 1}:`);
        console.log(`   - Opci√≥n seleccionada: "${selectedOption}"`);
        console.log(`   - Respuesta correcta: "${correct}"`);
        console.log(`   - Es correcta: ${isCorrect}`);
        
        // Marcar que estamos respondiendo
        window.isAnswering = true;
        
        // Efecto visual de "pressed"
        button.style.transform = 'scale(0.95)';
        button.style.backgroundColor = '#374151';
        
        // Deshabilitar todos los botones
        setDisabledAll(true);
        
        // Aplicar la misma l√≥gica que el onclick original
        setTimeout(() => {
          button.style.transform = '';
          button.style.backgroundColor = '';
          
          if(isCorrect){
            button.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out de TODAS las casillas juntas despu√©s del glow
            if(isMobile()) {
              setTimeout(() => {
                quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
              }, 800);
            }
            
            setTimeout(()=>{
              setDisabledAll(false);
              window.isAnswering = false;
              console.log('üéπ DEBUG: isAnswering reseteado a false (teclado - respuesta correcta)');
            }, 450);
          } else {
            button.classList.add('optWrong');
            quizBtns.forEach((b, i) => {
              if(options[i] === correct) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              quizBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              if(isMobile()) {
                setTimeout(() => {
                  quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
                }, 900);
              }
            }, 1000);
            
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              window.isAnswering = false;
              console.log('üéπ DEBUG: isAnswering reseteado a false (teclado - respuesta incorrecta)');
              answer(false);
            }, 2000);
          }
        }, 100);
        
        console.log(`üéπ Tecla ${e.code} presionada - Procesando respuesta del bot√≥n ${buttonIndex + 1}`);
      } else {
        console.log('üéπ ‚ùå Bot√≥n no disponible o faltan datos del quiz');
      }
    };
    
    // Agregar listener
    document.addEventListener('keydown', window.quizKeyboardHandler);
    console.log('üéπ Controles de teclado activados para desktop (1,2,3,4)');
  }

  // Actualizar contador de Ultimate Challenge
  function updateUltimateChallengeCounter() {
    console.log('üîç DEBUG updateUltimateChallengeCounter() llamada');
    console.log('- ultimateChallengeActive:', ultimateChallengeActive);
    console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
    console.log('- ultimateChallengeAnimalIndex:', ultimateChallengeAnimalIndex);
    
    if (ultimateChallengeActive) {
      // ACTUALIZAR "FALTAN" - elemento statInSession
      const statInSession = document.getElementById('statInSession');
      console.log('üì¶ Elemento statInSession encontrado:', !!statInSession);
      
      if (statInSession) {
        console.log('üì¶ statInSession.textContent ANTES:', statInSession.textContent);
        const remaining = 60 - ultimateChallengeCardIndex;
        console.log('üßÆ C√°lculo: 60 - ' + ultimateChallengeCardIndex + ' = ' + remaining);
        
        statInSession.textContent = remaining;
        console.log('ÔøΩ statInSession.textContent DESPU√âS:', statInSession.textContent);
        console.log('üéØ VALOR MOSTRADO EN CAJA "FALTAN":', statInSession.textContent);
      } else {
        console.error('‚ùå No se encontr√≥ elemento statInSession');
      }
      
      // ACTUALIZAR "MODO ACTUAL" - solo nombre del animal
      const statMission = document.getElementById('statMission');
      if (statMission) {
        const currentAnimalData = ultimateChallengeOrder[ultimateChallengeAnimalIndex];
        const animalName = currentAnimalData?.animal || 'Desconocido';
        statMission.textContent = `üèÜ ${animalName}`;
        statMission.style.color = '#f2e5b1';
        statMission.style.fontWeight = 'bold';
        console.log(`üêæ Animal actual: ${animalName}`);
      }
      
      console.log('‚úÖ Contador Ultimate Challenge actualizado');
    }
  }

  // Manejar respuesta en Ultimate Challenge
  function handleUltimateChallengeAnswer(btn, selectedValue, correct, allBtns, allOptions) {
    console.log('üéØ Ultimate Challenge - Respuesta seleccionada:', selectedValue);
    console.log('‚úÖ Respuesta correcta:', correct);
    
    window.isAnswering = true;
    btn.blur();
    
    const isCorrect = selectedValue === correct;
    allBtns.forEach(b => b.disabled = true);
    
    if(isCorrect){
      console.log('üéâ ¬°CORRECTO!');
      btn.classList.add('optCorrect');
      respond(true);
      
      if(isMobile()) {
        setTimeout(() => {
          allBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
        }, 800);
      }
      
      setTimeout(() => {
        allBtns.forEach(b => b.disabled = false);
        // INCREMENTAR √çNDICE DESPU√âS DE RESPUESTA CORRECTA
        if (ultimateChallengeActive) {
          ultimateChallengeCardIndex++;
          console.log('üî¢ √çndice incrementado (correcto) a:', ultimateChallengeCardIndex);
          
          // DEBUG INMEDIATO: Verificar valor despu√©s de incrementar
          const statInSession = document.getElementById('statInSession');
          if (statInSession) {
            console.log('üì¶ VALOR INMEDIATO en statInSession despu√©s de incrementar:', statInSession.textContent);
          }
        }
        // Avanzar a la siguiente carta
        nextCard();
      }, 1200);
    } else {
      console.log('‚ùå Incorrecto');
      btn.classList.add('optWrong');
      allBtns.forEach((b, i) => {
        if(allOptions[i] === correct) b.classList.add('optCorrect');
      });
      
      cardEl.classList.add('cardWrong','shakeAnim');
      soundWrong();
      
      setTimeout(() => {
        cardEl.classList.add('cardWrongFade');
        allBtns.forEach(b => {
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
        
        if(isMobile()) {
          setTimeout(() => {
            allBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
          }, 900);
        }
      }, 1000);
      
      setTimeout(() => {
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
        // INCREMENTAR √çNDICE DESPU√âS DE RESPUESTA INCORRECTA
        if (ultimateChallengeActive) {
          ultimateChallengeCardIndex++;
          console.log('üî¢ √çndice incrementado (incorrecto) a:', ultimateChallengeCardIndex);
          
          // DEBUG INMEDIATO: Verificar valor despu√©s de incrementar
          const statInSession = document.getElementById('statInSession');
          if (statInSession) {
            console.log('üì¶ VALOR INMEDIATO en statInSession despu√©s de incrementar:', statInSession.textContent);
          }
        }
        // Avanzar a la siguiente carta
        nextCard();
      }, 2500);
    }
  }

  // --- Quiz Hanzi ---
const btnQuizMeaning = document.getElementById('btnQuizMeaning');
if(btnQuizMeaning) {
  let btnQuizHanzi = document.getElementById('btnQuizHanzi');
  if(!btnQuizHanzi) {
    btnQuizHanzi = document.createElement('button');
    btnQuizHanzi.id = 'btnQuizHanzi';
    btnQuizHanzi.className = 'px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 ml-2';
    btnQuizHanzi.textContent = 'Quiz Hanzi';
    btnQuizMeaning.parentNode.insertBefore(btnQuizHanzi, btnQuizMeaning.nextSibling);
  }
  btnQuizHanzi.onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizHanzi');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };
}

// --- L√≥gica para modo quizHanzi ---
const oldSetupQuizChoices = window.setupQuizChoices;
window.setupQuizChoices = function() {
  if(mode === 'quizHanzi' && currentCard) {
    // Mostrar pinyin o significado aleatorio en la tarjeta
    const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
    frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
    backEl.innerHTML = '';

    // üéØ OPCIONES INTELIGENTES: 1 correcta + 3 inteligentes basadas en s√≠labas
    console.log(`üéÆ QUIZ HANZI - Generando opciones inteligentes`);
    
    // Determinar pool disponible (usar todas las cartas para mayor variedad)
    let availablePool = cards.filter(c => c.hanzi !== currentCard.hanzi);
    
    // Generar opciones inteligentes
    const smartOptions = generateSmartOptions(currentCard, availablePool, true);
    
    // Crear array final con respuestas correctas + opciones inteligentes
    let hanziOptions = [
      currentCard.hanzi,
      ...smartOptions.map(opt => opt.hanzi)
    ];
    
    // Mezclar todas las opciones
    hanziOptions = shuffle(hanziOptions);
    
    console.log(`üéØ Quiz Hanzi - Opciones finales:`, hanziOptions);

    quizRow.innerHTML = '';
    // Helper para deshabilitar todos los botones hanzi
    function setDisabledAll(flag) {
      Array.from(quizRow.children).forEach(b => b.disabled = flag);
    }
    hanziOptions.forEach(hz => {
      const btn = document.createElement('button');
      btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
      btn.textContent = hz;
      btn.disabled = false;
      btn.onclick = function() {
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        this.blur();
        setDisabledAll(true);
        const isCorrect = hz === currentCard.hanzi;
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          // Marcar la opci√≥n correcta
          Array.from(quizRow.children).forEach((b, i) => {
            if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            Array.from(quizRow.children).forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
          }, 1000);
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
            setDisabledAll(false);
            answer(false);
          }, 2000);
        }
      };
      quizRow.appendChild(btn);
    });
    
    // Configurar controles de teclado para desktop
    if (!isMobile()) {
      const quizBtns = Array.from(quizRow.children);
      setTimeout(() => {
        setupKeyboardControls(quizBtns, hanziOptions, currentCard.hanzi, setDisabledAll);
      }, 50);
      console.log('üéπ quizHanzi - Configurando teclado:', hanziOptions, 'Correcto:', currentCard.hanzi);
    }
    
    quizRow.classList.remove('hidden');
    flashRow.classList.add('hidden');
    return;
  } else {
    // Restaurar fuente original para quizRow y sus hijos
    quizRow.classList.remove('text-3xl','font-bold');
    Array.from(quizRow.children).forEach(btn => {
      btn.classList.remove('text-3xl','font-bold');
    });
    // Restaurar tarjeta frontal
    if(currentCard && (mode === 'quizPinyin' || mode === 'quizMeaning')) {
      frontEl.innerHTML = `<span class='text-5xl font-bold'>${currentCard.hanzi}</span>`;
    }
  }
  if(typeof oldSetupQuizChoices === 'function') oldSetupQuizChoices();
}

// --- Desaf√≠os ---
function setupChallengeCard() {
  if(currentMission === 'challenge' || currentMission === 'desafioN1') {
    // Elegir aleatoriamente el tipo de pregunta
    // 50%: muestra hanzi y opciones pinyin/meaning
    // 50%: muestra pinyin o meaning y opciones hanzi (quiz hanzi style)
    const hanziQuiz = Math.random() < 0.5;
    if(hanziQuiz) {
      // Quiz hanzi: muestra pinyin o significado, opciones hanzi
      const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
      backEl.innerHTML = '';
      
      // Usar sistema inteligente de opciones
      let hanziOptions;
      if (typeof generateSmartOptions === 'function') {
        const smartOptions = generateSmartOptions(currentCard, cards.filter(c => c.hanzi !== currentCard.hanzi), true);
        hanziOptions = [currentCard.hanzi, ...smartOptions.map(opt => opt.hanzi)];
        hanziOptions = shuffle(hanziOptions);
        console.log('üß† Challenge (hanziQuiz) - Usando opciones inteligentes:', hanziOptions);
      } else {
        // Fallback al sistema legacy si no existe la funci√≥n inteligente
        hanziOptions = [currentCard.hanzi];
        let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
        while(hanziOptions.length < 4 && pool.length > 0) {
          const idx = Math.floor(Math.random() * pool.length);
          hanziOptions.push(pool[idx].hanzi);
          pool.splice(idx,1);
        }
        hanziOptions = shuffle(hanziOptions);
        console.log('‚ö° Challenge (hanziQuiz) - Usando opciones legacy:', hanziOptions);
      }
      quizRow.innerHTML = '';
      hanziOptions.forEach((hz, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = hz;
        btn.disabled = false;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        btn.onclick = function() {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          this.blur();
          Array.from(quizRow.children).forEach(b => b.disabled = true);
          const isCorrect = hz === currentCard.hanzi;
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                const challengeBtns = Array.from(quizRow.children);
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            Array.from(quizRow.children).forEach((b, i) => {
              if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              Array.from(quizRow.children).forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  const challengeBtns = Array.from(quizRow.children);
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              Array.from(quizRow.children).forEach(b=>b.disabled=false);
              answer(false);
            }, 2000);
          }
        };
        quizRow.appendChild(btn);
      });
      
      // Configurar controles de teclado para desktop (hanziQuiz)
      if (!isMobile()) {
        const challengeBtns = Array.from(quizRow.children);
        function setDisabledAll(flag) { challengeBtns.forEach(b => b.disabled = flag); }
        setTimeout(() => {
          setupKeyboardControls(challengeBtns, hanziOptions, currentCard.hanzi, setDisabledAll);
        }, 50);
        console.log('üéπ Challenge (hanziQuiz) - Configurando teclado:', hanziOptions, 'Correcto:', currentCard.hanzi);
      }
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones hanzi
      if (isMobile()) {
        requestAnimationFrame(() => {
          const challengeBtns = Array.from(quizRow.children);
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    } else {
      // Modo cl√°sico: muestra hanzi y opciones pinyin/meaning
      const types = ['pinyin','meaning'];
      const optionsType = types[Math.floor(Math.random()*types.length)];
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
      backEl.innerHTML = '';
      let correct = currentCard[optionsType];
      
      // üéØ OPCIONES INTELIGENTES: Aplicar sistema de s√≠labas para quiz cl√°sico
      console.log(`üéÆ QUIZ CL√ÅSICO (${optionsType}) - Generando opciones inteligentes`);
      
      // Determinar pool disponible (usar cartas del contexto actual)
      let availablePool = cards.filter(c => c[optionsType] !== correct);
      
      // Generar opciones inteligentes basadas en la respuesta correcta
      const smartOptions = generateSmartOptions(currentCard, availablePool, true);
      
      // Crear array final con respuesta correcta + opciones inteligentes
      let options = [
        correct,
        ...smartOptions.map(opt => opt[optionsType])
      ].filter(opt => opt); // Filtrar opciones undefined/null
      
      // Si no tenemos suficientes opciones, completar con aleatorias
      if (options.length < 4) {
        const remainingPool = availablePool.filter(c => 
          !options.includes(c[optionsType])
        );
        while(options.length < 4 && remainingPool.length > 0) {
          const idx = Math.floor(Math.random() * remainingPool.length);
          options.push(remainingPool[idx][optionsType]);
          remainingPool.splice(idx, 1);
        }
      }
      
      options = shuffle(options);
      
      console.log(`üéØ Quiz Cl√°sico (${optionsType}) - Opciones finales:`, options);
      quizRow.innerHTML = '';
      options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = opt;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o  
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        quizRow.appendChild(btn);
      });
      const challengeBtns = Array.from(quizRow.children);
      function setDisabledAll(flag){ challengeBtns.forEach(b=>b.disabled=flag); }
      challengeBtns.forEach((btn, idx) => {
        btn.onclick = () => {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          btn.blur();
          const isCorrect = btn.textContent === currentCard[optionsType];
          setDisabledAll(true);
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            challengeBtns.forEach((b, i) => {
              if(b.textContent === currentCard[optionsType]) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              challengeBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              challengeBtns.forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              // Avanzar a la siguiente tarjeta
              nextCard();
            }, 2000);
          }
        };
      });
      
      // Configurar controles de teclado para desktop (modo cl√°sico)
      if (!isMobile()) {
        setTimeout(() => {
          setupKeyboardControls(challengeBtns, options, correct, setDisabledAll);
        }, 50);
        console.log('üéπ Challenge (cl√°sico) - Configurando teclado:', options, 'Correcto:', correct);
      }
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones del modo cl√°sico
      if (isMobile()) {
        requestAnimationFrame(() => {
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    }
  }
  return false;
}
  /* ========= Modo/UI ========= */
  function setMode(newMode){
    // En Desaf√≠o, no permitimos modo Flash
    if(currentMission==='challenge' && newMode==='flash'){
      mode = 'quizMeaning';
    } else {
      mode = newMode;
    }
    
    // Refrescar pool de audio al cambiar modo para prevenir problemas
    if(typeof refreshCorrectSoundPool === 'function') {
      refreshCorrectSoundPool();
    }
    
    if(mode!=='flash'){ flipped=false; cardEl.classList.remove('flip'); }

    // Seguridad: evitar que quede bloqueada la interacci√≥n (pointer-events) tras desaf√≠os
    if (mode === 'flash') {
      const cardWrapEl = document.getElementById('cardWrap');
      const flashRowEl = document.getElementById('flashRow');
      if (cardWrapEl) cardWrapEl.style.pointerEvents = '';
      if (flashRowEl) flashRowEl.style.pointerEvents = '';
    }
    
    // NO llamar renderCard() en Ultimate Challenge porque usa su propio renderizado
    if(currentCard && !ultimateChallengeActive) {
      renderCard();
    }
    
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones seg√∫n el modo
  }

  // Funci√≥n para actualizar las instrucciones del juego seg√∫n el modo
  function updateGameInstructions(){
    const instructionsEl = document.getElementById('gameInstructions');
    if(!instructionsEl) return;
    
    if(currentMission === 'challenge' || currentMission === 'desafioN1'){
      // Modo desaf√≠o
      instructionsEl.innerHTML = `<span class="text-yellow-400">Tarjeta Dorada:</span> + 2 niv al caracter, <span class="text-purple-400">Tarjeta Violeta:</span> + 5 niv al caracter, <span class="text-red-400">Tarjeta Roja:</span> si te equivocas pierdes un caracter extra al azar (con todo su nivel).`;
    } else if(mode === 'flash'){
      // Modo flashcards - personalizar seg√∫n tipo de misi√≥n
      
      // Modos donde S√ç pierdes caracter si te equivocas (unidades de todos los niveles + todoN1/N2/N3)
      const dangerousModes = [
        'todoN1', 'todoN2', 'todoN3',
        'unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', // N1
        'unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2', // N2
        'unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3' // N3
      ];
      
      // Modos donde NO pierdes caracter si te equivocas
      const safeModes = ['known', 'revise1', 'revise2'];
      
      if(dangerousModes.includes(currentMission)){
        // Modos donde pierdes caracter si te equivocas
        instructionsEl.innerHTML = `<span class="text-red-400">Recuerda:</span> si aciertas o pones "La conozco" se agregar√° a tu colecci√≥n <span class="text-red-400">pero si te equivocas</span> perder√°s el caracter de la colecci√≥n (si ya la tienes) junto a sus niveles.`;
      } else if(safeModes.includes(currentMission)){
        // Modos donde NO pierdes caracter
        instructionsEl.innerHTML = `<span class="text-green-400">Recuerda:</span> en este modo si te equivocas no perder√°s el caracter de tu colecci√≥n. Aparecer√° en "A repasar" y "Confirmar" pero no lo perder√°s. Sumas XP si aciertas en modo Quiz`;
      } else {
        // Otros modos flashcards (instrucciones por defecto)
        instructionsEl.textContent = 'Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la s√©, Espacio = Voltear, Derecha = La sab√≠a.';
      }
    } else {
      // Modo quiz (quizPinyin, quizMeaning, quizHanzi) - Sin texto
      instructionsEl.textContent = '';
    }
  }

  // --- L√≥gica de racha diaria por d√≠a GMT-6 ---
  function getLocalDate(ts) {
    const date = new Date(ts);
    date.setHours(date.getHours() - 6);
    return date.toISOString().slice(0, 10);
  }
  function getRachaStatus(lastChallengeAt) {
    const now = Date.now();
    const today = getLocalDate(now);
    const lastDay = getLocalDate(lastChallengeAt);
    
    if (today === lastDay) {
      // Ya hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 del pr√≥ximo d√≠a
      const nextMidnight = new Date(now);
      nextMidnight.setUTCHours(6, 0, 0, 0); // 00:00 GMT-6 = 06:00 UTC
      if (now >= nextMidnight.getTime()) {
        nextMidnight.setUTCDate(nextMidnight.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((nextMidnight.getTime() - now) / 3600000);
      return { status: 'yaHizo', horasRestantes: Math.min(24, horasRestantes) };
    } else {
      // No hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 (fin del d√≠a actual)
      const endOfDay = new Date(now);
      endOfDay.setUTCHours(6, 0, 0, 0); // Pr√≥ximas 00:00 GMT-6
      if (now >= endOfDay.getTime()) {
        endOfDay.setUTCDate(endOfDay.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((endOfDay.getTime() - now) / 3600000);
      return { status: 'puedeHacer', horasRestantes: Math.min(24, horasRestantes) };
    }
  }
  function updateStreakBox() {
    if (!streakBox || !streakCount || !streakStatus) return;
    streakCount.textContent = streak || 0;
    // Tomar el √∫ltimo desaf√≠o exitoso
    const lastTs = lastChallengeAt || 0;
    const racha = getRachaStatus(lastTs);
    let horas = racha.horasRestantes;
    streakStatus.style.color = '#fff';
    if (racha.status === 'yaHizo') {
      streakStatus.textContent = `Ya sumaste hoy. Espera ${horas} hs.`;
    } else {
      streakStatus.textContent = `Tienes ${horas} hs para no perder la racha.`;
    }
    // Si quedan menos de 5 horas, fondo naranja de aviso
    if (racha.status === 'puedeHacer' && horas <= 5) {
      streakBox.style.background = '#f54242'; // naranja
      streakStatus.style.color = '#fff';
    } else {
      streakBox.style.background = '';
    }
  }
  // Mostrar mensaje al tocar el box
  if (streakBox) {
    streakBox.onclick = function() {
      // Mostrar imagen "fuerte.png" centrada en pantalla
      let overlay = document.getElementById('rachaFuerteOverlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'rachaFuerteOverlay';
          overlay.className = 'fade-overlay';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(0,0,0,0.7)';
          overlay.style.zIndex = '99999';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.cursor = 'pointer';
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.5s';
          // Container principal para imagen y di√°logo
          const container = document.createElement('div');
          container.style.position = 'relative';
          container.style.display = 'flex';
          container.style.flexDirection = 'column';
          container.style.alignItems = 'center';
          container.style.gap = '20px';
          
          // Imagen centrada
          const img = document.createElement('img');
          img.src = 'img/lilifireok.webp';
          img.alt = 'lilifireok';
          img.style.maxWidth = '80vw';
          img.style.maxHeight = '60vh';
          img.style.borderRadius = '24px';
          img.style.boxShadow = '0 0 32px #0008';
          
          // Cuadro de di√°logo
          const dialogBox = document.createElement('div');
          dialogBox.style.cssText = `
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            font-family: 'Jersey 10', monospace;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 3px solid #a855f7;
            position: relative;
            max-width: 90vw;
          `;
          dialogBox.textContent = '¬°As√≠ se hace! ¬°Juntemos m√°s rachas!';
          
          // Agregar tri√°ngulo apuntando hacia la imagen (speech bubble effect)
          const triangle = document.createElement('div');
          triangle.style.cssText = `
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 15px solid #a855f7;
          `;
          dialogBox.appendChild(triangle);
          
          container.appendChild(img);
          container.appendChild(dialogBox);
          overlay.appendChild(container);
          document.body.appendChild(overlay);
          // Fade in
          setTimeout(() => { overlay.style.opacity = '1'; }, 10);
          // Cerrar al hacer click en cualquier parte con fade out
          overlay.onclick = function() {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.remove(); }, 500);
          };
        }
    };
  }

  // Funci√≥n helper para obtener texto de desaf√≠os de hor√≥scopo
  function getHoroscopeDisplayText(mission) {
    console.log('üêæ getHoroscopeDisplayText llamada para:', mission);
    
    // Extraer categor√≠a del nombre de la misi√≥n (ej: 'desafioColores' -> 'colores')
    const categoria = mission.replace('desafio', '').toLowerCase();
    console.log('üêæ Categor√≠a extra√≠da:', categoria);
    
    const animalData = horoscopeAnimals[categoria];
    const categoryNames = {
      'colores': 'Colores',
      'fruta': 'Frutas', 
      'verduras': 'Verduras',
      'comidas': 'Comidas',
      'animales': 'Animales',
      'deportes': 'Deportes',
      'hobbies': 'Hobbies',
      'ropa': 'Ropa',
      'casa': 'Casa',
      'cuerpo': 'Cuerpo',
      'profesiones': 'Profesiones',
      'emociones': 'Emociones'
    };
    
    if (animalData && categoryNames[categoria]) {
      const displayText = `${animalData.chinese} ${animalData.name} - ${categoryNames[categoria]}`;
      console.log('üêæ Texto generado para hor√≥scopo:', displayText);
      return displayText;
    }
    
    console.log('üêæ No se encontraron datos, retornando texto por defecto');
    return 'Desaf√≠o Hor√≥scopo';
  }

  function updateStats(){
    console.log('üìà updateStats() llamada');
    console.log('- ultimateChallengeActive:', ultimateChallengeActive);
    console.log('- currentMission:', currentMission);
    
    // DEBUG CR√çTICO: Verificar si updateStats() est√° sobrescribiendo statInSession
    const statInSession = document.getElementById('statInSession');
    if (statInSession) {
      console.log('üì¶ statInSession.textContent ANTES de updateStats():', statInSession.textContent);
    }
    
    if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
      console.log('‚ö†Ô∏è SALTANDO actualizaci√≥n de statInSession - Ultimate Challenge activo');
      // NO tocar statInSession en Ultimate Challenge
    } else {
      const newValue = sessionQueue.length + (currentCard ? 1 : 0);
      console.log('üìä updateStats() actualizando statInSession a:', newValue);
      statInSession.textContent = newValue;
    }
    
    statToday.textContent = todayReviewed;
    
    // NO sobrescribir statMission si estamos en Ultimate Challenge 
    // (lo maneja updateUltimateChallengeCounter)
    if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
      console.log('‚ö†Ô∏è updateStats() saltando statMission - Ultimate Challenge activo');
      // Solo actualizar los otros stats, no statMission
    } else {
      console.log('üìä updateStats() actualizando statMission normalmente');
      const statMissionBefore = statMission.textContent;
      console.log('üìä DEBUG: statMission ANTES de updateStats():', statMissionBefore);
      
      statMission.textContent = (
      currentMission==='unit2' ? 'Unidad 2' :
      currentMission==='unit3' ? 'Unidad 3' :
      currentMission==='unit4' ? 'Unidad 4' :
      currentMission==='unit5' ? 'Unidad 5' :
      currentMission==='unit6' ? 'Unidad 6' :
      currentMission==='unit7' ? 'Unidad 7' :
      currentMission==='unit8' ? 'Unidad 8' :
      currentMission==='unit9' ? 'Unidad 9' :
      currentMission==='todoN1' ? 'Todo N1' :
      currentMission==='unit1N2' ? 'Unidad 1 (N2)' :
      currentMission==='unit2N2' ? 'Unidad 2 (N2)' :
      currentMission==='unit3N2' ? 'Unidad 3 (N2)' :
      currentMission==='unit4N2' ? 'Unidad 4 (N2)' :
      currentMission==='unit5N2' ? 'Unidad 5 (N2)' :
      currentMission==='unit6N2' ? 'Unidad 6 (N2)' :
      currentMission==='unit7N2' ? 'Unidad 7 (N2)' :
      currentMission==='unit8N2' ? 'Unidad 8 (N2)' :
      currentMission==='unit9N2' ? 'Unidad 9 (N2)' :
      currentMission==='todoN2' ? 'Todo N2' :
      currentMission==='unit1N3' ? 'Unidad 1 (N3)' :
      currentMission==='unit2N3' ? 'Unidad 2 (N3)' :
      currentMission==='unit3N3' ? 'Unidad 3 (N3)' :
      currentMission==='unit4N3' ? 'Unidad 4 (N3)' :
      currentMission==='unit5N3' ? 'Unidad 5 (N3)' :
      currentMission==='unit6N3' ? 'Unidad 6 (N3)' :
      currentMission==='unit7N3' ? 'Unidad 7 (N3)' :
      currentMission==='unit8N3' ? 'Unidad 8 (N3)' :
      currentMission==='unit9N3' ? 'Unidad 9 (N3)' :
      currentMission==='todoN3' ? 'Todo N3' :
      currentMission==='known' ? 'Conocidas' :
      currentMission==='revise1' ? 'A repasar' :
      currentMission==='revise2' ? 'Para confirmar' :
      currentMission==='challenge' ? 'Desaf√≠o' :
      currentMission==='desafioN1' ? 'Desaf√≠o N1' :
      currentMission==='desafioN2' ? 'Desaf√≠o N2' :
      currentMission==='desafioN3' ? 'Desaf√≠o N3' :
      currentMission==='ultimateChallenge' ? 'üèÜ Ultimate Challenge' :
      currentMission.startsWith('desafio') ? getHoroscopeDisplayText(currentMission) : '‚Äî'
      );
      
      console.log('üìä DEBUG: statMission DESPU√âS de updateStats():', statMission.textContent);
      
      // Si es un desaf√≠o N o hor√≥scopo, aplicar estilos especiales
      if (currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3' || currentMission.startsWith('desafio')) {
        statMission.style.color = '#f2e5b1';
        statMission.style.fontWeight = 'bold';
        statMission.style.fontSize = '14px';
        console.log('üìä DEBUG: Estilos especiales aplicados a statMission');
      }
    }
    // Cambiar color de statBox seg√∫n el modo actual
    const modeToBtn = {
      'unit2': 'btnUnit2',
      'unit3': 'btnUnit3',
      'unit4': 'btnUnit4',
      'unit5': 'btnUnit5',
      'unit6': 'btnUnit6',
      'unit7': 'btnUnit7',
      'unit8': 'btnUnit8',
      'unit9': 'btnUnit9',
      'todoN1': 'btnTodoN1',
      'unit1N2': 'btnUnit1N2',
      'unit2N2': 'btnUnit2N2',
      'unit3N2': 'btnUnit3N2',
      'unit4N2': 'btnUnit4N2',
      'unit5N2': 'btnUnit5N2',
      'unit6N2': 'btnUnit6N2',
      'unit7N2': 'btnUnit7N2',
      'unit8N2': 'btnUnit8N2',
      'unit9N2': 'btnUnit9N2',
      'todoN2': 'btnTodoN2',
      'unit1N3': 'btnUnit1N3',
      'unit2N3': 'btnUnit2N3',
      'unit3N3': 'btnUnit3N3',
      'unit4N3': 'btnUnit4N3',
      'unit5N3': 'btnUnit5N3',
      'unit6N3': 'btnUnit6N3',
      'unit7N3': 'btnUnit7N3',
      'unit8N3': 'btnUnit8N3',
      'unit9N3': 'btnUnit9N3',
      'todoN3': 'btnTodoN3',
      'known': 'btnKnown',
      'revise1': 'btnRevise1',
      'revise2': 'btnRevise2',
      'challenge': 'btnChallenge'
    };
    let btnId = modeToBtn[currentMission];
    let btn = btnId ? document.getElementById(btnId) : null;
    if(btn) {
      statBox.style.background = window.getComputedStyle(btn).backgroundColor;
      statBox.style.color = window.getComputedStyle(btn).color;
      statBox.style.borderColor = window.getComputedStyle(btn).borderColor || 'transparent';
    } else {
      statBox.style.background = '';
      statBox.style.color = '';
      statBox.style.borderColor = '';
    }
    // contadores
    const countKnown = cards.filter(c=>c.known).length;
    const countRev1  = cards.filter(c=>c.revise1).length;
    const countRev2  = cards.filter(c=>c.revise2).length;
    
    // üî• DETECTAR CAMBIOS EN CONOCIDAS PARA DESAF√çOS CL√ÅSICOS
    if (desafioClasico2Active && 
        (currentMission === 'challenge' || currentMission === 'clasico' || currentMission === 'menos' || currentMission === 'mas') &&
        previousKnownCount > 0 && countKnown < previousKnownCount) {
      console.log('üíî CAMBIO DETECTADO: Conocidas baj√≥ de', previousKnownCount, 'a', countKnown, '- Perdiendo vida en desaf√≠o cl√°sico');
      loseDesafioClasico2Life();
    }
    
    // Actualizar contador anterior
    previousKnownCount = countKnown;
    
    const elKnown = document.getElementById('countKnown'); if(elKnown) elKnown.textContent = countKnown;
    const elR1    = document.getElementById('countRev1');  if(elR1)   elR1.textContent   = countRev1 === 0 ? '‚úÖ' : countRev1;
    const elR2    = document.getElementById('countRev2');  if(elR2)   elR2.textContent   = countRev2 === 0 ? '‚úÖ' : countRev2;

  updateStreakBox();
  }

  /* ========= Tabla Conocidas ========= */
  let overlayField = 'hanzi'; // 'hanzi' | 'pinyin' | 'meaning'
  
  // üîÑ Sistema de ciclo individual por carta
  const cardDisplayStates = {}; // Objeto para rastrear el estado de cada carta individual
  
  // Funci√≥n para obtener el siguiente estado en el ciclo
  function getNextDisplayState(currentState) {
    const cycle = ['hanzi', 'pinyin', 'meaning'];
    const currentIndex = cycle.indexOf(currentState);
    return cycle[(currentIndex + 1) % cycle.length];
  }
  
  // Funci√≥n para obtener el valor a mostrar seg√∫n el estado
  function getDisplayValue(card, state) {
    switch(state) {
      case 'pinyin': return card.pinyin;
      case 'meaning': return card.meaning;
      default: return card.hanzi;
    }
  }
let knownCatFilter = 'ALL'; // 'ALL'|'S'|'A'|'V'|'P'|'E'

// Estado previo de conocidas para animaciones
let prevKnownState = [];
window.prevKnownState = prevKnownState;

  // Funci√≥n para inicializar el estado correcto al cargar desde backend
  function initializeKnownState() {
    console.log('üîß initializeKnownState() - Inicializando estado correcto');
    
    // Establecer prevKnownState con los datos actuales (excluyendo badges del hor√≥scopo)
    const currentKnown = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo')
      .map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    
    prevKnownState = currentKnown.map(c => ({ ...c }));
    window.prevKnownState = prevKnownState;
    
    console.log('üîß prevKnownState inicializado con', prevKnownState.length, 'elementos conocidos');
    
    // Actualizar contadores inmediatamente
    updateStats();
    
    console.log('üîß Contadores actualizados - Mi colecci√≥n deber√≠a mostrar el n√∫mero correcto');
  }
  // Overlay removed: no-op

  // Interpolaci√≥n azul -> naranja para la racha
  const COLOR_A = { r: 59, g: 130, b: 246 };   // #3B82F6
  const COLOR_B = { r: 255, g: 134, b: 35  };  // #FF8623
  function lerp(a,b,t){ return a + (b-a)*t; }
  function mixColor(t){
    const r = Math.round(lerp(COLOR_A.r, COLOR_B.r, t));
    const g = Math.round(lerp(COLOR_A.g, COLOR_B.g, t));
    const b = Math.round(lerp(COLOR_A.b, COLOR_B.b, t));
    return `rgb(${r}, ${g}, ${b})`;
  }

  // Ajuste de texto para celdas (binaria para que quepa en ancho/alto)
  function fitCellText(el, minPx=10, maxPx=64){
    const parent = el.parentElement;
    if(!parent) return;
    const pad = 18; // margen de seguridad
    let low = minPx, high = maxPx, best = minPx;
    while(low <= high){
      const mid = Math.floor((low + high)/2);
      el.style.fontSize = mid + 'px';
      // Medimos (fudges con padding)
      const OK = (el.scrollWidth <= parent.clientWidth - pad) && (el.scrollHeight <= parent.clientHeight - pad);
      if(OK){ best = mid; low = mid + 1; } else { high = mid - 1; }
    }
    el.style.fontSize = best + 'px';
  }

  function sizeClassForHanzi(len){
    return len >= 4 ? 'font-bold' : 'font-bold';
  }

  // Render con animaciones de level up y perdidos
  // Helper function para obtener el nombre de la rareza
  function getRarityName(streak) {
    if (streak >= 15) return 'Legendaria';
    if (streak >= 10) return '√âpica';
    if (streak >= 5) return 'Rara';
    if (streak >= 2) return 'Poco Com√∫n';
    return 'Com√∫n';
  }

  function renderKnownGridWithAnimations(levelUpIds, lostChars, newlyAdded) {
    // EXCLUIR badges del hor√≥scopo del conteo de conocidas normales
    let known = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo');
    if(knownCatFilter !== 'ALL') {
      known = known.filter(c => (c.cat||'E').toUpperCase() === knownCatFilter);
    }
    
    // Conteo total incluye badges del hor√≥scopo cuando no hay filtro
    const totalCount = knownCatFilter === 'ALL' 
      ? known.length + horoscopeBadges.length 
      : known.length;
    
    knownCount.textContent = `${totalCount} palabras`;

    // Grid responsivo: 4 columnas en m√≥vil, m√°s en desktop
    knownGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(min(100px, 22vw), 1fr))';

    // ordenar por challengeStreak desc
    known.sort((a,b)=> (b.challengeStreak||0) - (a.challengeStreak||0));
    const maxStreak = Math.max(0, ...known.map(c => c.challengeStreak||0));

    // --- Renderizar animaciones temporales arriba ---
    knownGrid.innerHTML = '';
    
    // üé® Funci√≥n helper para crear cartas de animaci√≥n
    function createAnimationCard(c, type) {
      const cell = document.createElement('div');
      cell.className = `trading-card squareCell ${type}-cell`;
      cell.style.position = 'relative';
      cell.style.opacity = '0';
      cell.style.transition = 'opacity 0.7s cubic-bezier(.4,0,.2,1), transform 0.7s cubic-bezier(.4,0,.2,1)';
      cell.style.transform = 'translateY(20px)';
      
      if(type === 'lost') {
        // Estilo rojo para perdidas
        cell.style.background = 'linear-gradient(135deg, #7f1d1d, #991b1b)';
        cell.style.border = '2px solid #dc2626';
        cell.style.boxShadow = '0 4px 8px rgba(220, 38, 38, 0.3)';
        cell.title = `${c.hanzi} - PERDIDA (Streak: ${c.streak})`;
      } else if(type === 'levelup') {
        // Estilo verde para level up (m√°s claro)
        cell.style.background = 'linear-gradient(135deg, #15803d, #4ade80)';
        cell.style.border = '2px solid #22c55e';
        cell.style.boxShadow = '0 4px 8px rgba(34, 197, 94, 0.4)';
        cell.title = `${c.hanzi} - LEVEL UP! (Streak: ${c.challengeStreak})`;
      } else {
        // Estilo blanco con gradiente y borde verde ne√≥n para caracdteres nuevos
        cell.style.background = 'linear-gradient(135deg, #ffffff, #f0fdf4)';
        cell.style.border = '2px solid #10b981';
        cell.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4), 0 0 8px rgba(16, 185, 129, 0.2)';
        cell.title = `${c.hanzi} - ¬°NUEVO! (Streak: ${c.challengeStreak || c.streak})`;
      }
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Hanzi principal
      const content = document.createElement('div');
      content.className = 'card-hanzi jersey-font-coleccion-cards';
      content.textContent = getDisplayValue(c, cardDisplayStates[c.id] || overlayField);
      
      if(type === 'lost') {
        content.style.color = '#fecaca';
        content.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.8)';
      } else if(type === 'levelup') {
        content.style.color = '#bbf7d0';
        content.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.8)';
      } else {
        content.style.color = '#065f46';
        content.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
      }
      
      cardContent.appendChild(content);
      
      // üìã Cartelito informativo
      const infoLabel = document.createElement('div');
      infoLabel.style.position = 'absolute';
      infoLabel.style.bottom = '8px';
      infoLabel.style.left = '50%';
      infoLabel.style.transform = 'translateX(-50%)';
      infoLabel.style.fontSize = '9px';
      infoLabel.style.fontWeight = 'bold';
      infoLabel.style.padding = '2px 6px';
      infoLabel.style.borderRadius = '8px';
      infoLabel.style.textAlign = 'center';
      infoLabel.style.minWidth = '60px';
      infoLabel.style.whiteSpace = 'nowrap';
      infoLabel.className = 'jersey-font-coleccion-cards';
      
      if(type === 'lost') {
        infoLabel.textContent = 'PERDISTE';
        infoLabel.style.background = 'rgba(153, 27, 27, 0.9)';
        infoLabel.style.color = '#fecaca';
        infoLabel.style.border = '1px solid #dc2626';
      } else if(type === 'levelup') {
        // Calcular cu√°ntos niveles subi√≥
        const prevStreak = window.prevKnownState ? 
          (window.prevKnownState.find(x => x.id === c.id)?.streak || 0) : 0;
        const newStreak = c.challengeStreak || 0;
        const levelsUp = newStreak - prevStreak;
        
        infoLabel.textContent = levelsUp > 1 ? `SUBE ${levelsUp} NIVELES` : 'SUBE 1 NIVEL';
        
        // üé® COLORES SEG√öN NIVELES: Verde (1), Amarillo (2), Naranja (5+)
        if (levelsUp >= 5) {
          // Naranja para 5+ niveles
          infoLabel.style.background = 'rgba(194, 65, 12, 0.9)';
          infoLabel.style.color = '#fed7aa';
          infoLabel.style.border = '1px solid #ea580c';
        } else if (levelsUp === 2) {
          // Amarillo para 2 niveles
          infoLabel.style.background = 'rgba(161, 98, 7, 0.9)';
          infoLabel.style.color = '#fef3c7';
          infoLabel.style.border = '1px solid #d97706';
        } else {
          // Verde para 1 nivel (por defecto)
          infoLabel.style.background = 'rgba(21, 128, 61, 0.9)';
          infoLabel.style.color = '#bbf7d0';
          infoLabel.style.border = '1px solid #22c55e';
        }
      } else {
        infoLabel.textContent = 'A√ëADISTE';
        infoLabel.style.background = 'rgba(5, 150, 105, 0.9)';
        infoLabel.style.color = '#ffffff';
        infoLabel.style.border = '1px solid #10b981';
      }
      
      cardContent.appendChild(infoLabel);
      
      // Badge de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge';
      badge.textContent = c.challengeStreak || c.streak || 0;
      
      if(type === 'lost') {
        badge.style.background = '#7f1d1d';
      } else if(type === 'levelup') {
        badge.style.background = '#166534';
        // Mostrar el nuevo nivel con efecto de subida
        const prevStreak = window.prevKnownState ? 
          (window.prevKnownState.find(x => x.id === c.id)?.streak || 0) : 0;
        const newStreak = c.challengeStreak || 0;
        
        if(prevStreak < newStreak) {
          badge.textContent = prevStreak;
          let current = prevStreak;
          const interval = setInterval(() => {
            current++;
            badge.textContent = current;
            if(current >= newStreak) clearInterval(interval);
          }, 120);
        }
      } else {
        badge.style.background = '#059669';
        badge.style.color = '#ffffff';
        // Para nuevos caracteres, mostrar efecto de ‚≠ê -> n√∫mero
        badge.textContent = '‚≠ê';
        setTimeout(() => {
          badge.textContent = c.challengeStreak || c.streak || 0;
        }, 400);
      }
      
      // Ensamblar carta (sin badge de categor√≠a)
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      
      return cell;
    }
    
    // üîÑ Crear contenedor para animaciones (perdidos + level ups)
    const animationRow = document.createElement('div');
    animationRow.style.display = 'contents';
    animationRow.id = 'animationRow';
    
    // üî¥ Renderizar cartas perdidas (rojas)
    lostChars.forEach(c => {
      const cell = createAnimationCard(c, 'lost');
      animationRow.appendChild(cell);
    });
    
    // üü¢ Renderizar cartas que suben de nivel (verdes)
    if(levelUpIds && levelUpIds.length) {
      levelUpIds.forEach(cardId => {
        const card = cards.find(x => x.id === cardId && x.known);
        if(card) {
          const cell = createAnimationCard(card, 'levelup');
          animationRow.appendChild(cell);
        }
      });
    }
    
    // üîµ Renderizar cartas nuevas a√±adidas (azules)
    if(newlyAdded && newlyAdded.length) {
      newlyAdded.forEach(c => {
        const cell = createAnimationCard(c, 'new');
        animationRow.appendChild(cell);
      });
    }
    
    // Solo agregar las animaciones si hay cartas para mostrar
    if(lostChars.length > 0 || (levelUpIds && levelUpIds.length > 0) || (newlyAdded && newlyAdded.length > 0)) {
      knownGrid.appendChild(animationRow);
      
      // üîä Sonido especial para las animaciones de cargtas
      try {
        const satisfactionSound = new Audio('music/trackcol.mp3');
        satisfactionSound.volume = 0.3;
        satisfactionSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
      } catch(e) {
        console.log('Error al crear sonido:', e);
      }
      
      // ‚ú® Fade-in inicial despu√©s de 1 segundo (para que se aprecie)
      setTimeout(() => {
        const allAnimationCells = animationRow.querySelectorAll('.lost-cell, .levelup-cell, .new-cell');
        allAnimationCells.forEach(cell => {
          cell.style.opacity = '1';
          cell.style.transform = 'translateY(0)';
        });
      }, 1000);
      
      // ‚è∞ Iniciar fade-out despu√©s de 7s (1s m√°s para apreciar)
      setTimeout(() => {
        const allAnimationCells = animationRow.querySelectorAll('.lost-cell, .levelup-cell, .new-cell');
        allAnimationCells.forEach(cell => {
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-20px)';
        });
        
        // üóëÔ∏è Remover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (animationRow.parentNode) {
            animationRow.parentNode.removeChild(animationRow);
          }
        }, 700);
      }, 7000);
    }

    // --- Badge Ultimate Master si est√° completado ---
    if(knownCatFilter === 'ALL' && horoscopeMaster) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üëë ULTIMATE MASTER - Desaf√≠o Final del Hor√≥scopo Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de master con overlay dorado
      const masterDiv = document.createElement('div');
      masterDiv.className = 'card-hanzi';
      masterDiv.style.display = 'flex';
      masterDiv.style.alignItems = 'center';
      masterDiv.style.justifyContent = 'center';
      masterDiv.style.height = '100%';
      masterDiv.style.position = 'relative';
      
      const masterImg = document.createElement('img');
      masterImg.src = 'img/master.webp';
      masterImg.alt = 'Ultimate Master';
      masterImg.style.width = '100%';
      masterImg.style.height = '100%';
      masterImg.style.objectFit = 'contain';
      masterImg.style.borderRadius = '0';
      masterImg.style.filter = 'none';
      masterImg.style.border = 'none';
      masterImg.style.boxShadow = 'none';
      masterImg.onerror = function() {
        console.log('Error loading master.webp');
        this.style.display = 'none';
      };
      
      masterDiv.appendChild(masterImg);
      cardContent.appendChild(masterDiv);
      
      // Badge m√≠tico de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'MASTER';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      
      // Badge de categor√≠a m√≠tico
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "ULTIMATE";
      catBadge.style.fontSize = '8px';
      
      // Ensamblar carta master
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Renderizar animales del hor√≥scopo desbloqueados EN ORDEN FIJO ---
    if(knownCatFilter === 'ALL') { // Solo mostrar animales cuando no hay filtro espec√≠fico
      // Orden fijo de animales del hor√≥scopo
      const fixedAnimalOrder = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
      
      // Renderizar solo los animales desbloqueados, pero en el orden fijo
      fixedAnimalOrder.forEach(categoria => {
        // Solo renderizar si el animal ha sido desbloqueado
        if (horoscopeAnimalsUnlocked.includes(categoria)) {
          const animal = horoscopeAnimals[categoria];
          const cell = document.createElement('div');
          cell.className = 'trading-card card-mythic-animal squareCell';
          cell.style.position = 'relative';
          cell.style.pointerEvents = 'auto';
          cell.style.zIndex = '1';
          cell.title = `üêâ ${animal.chinese} ${animal.name} - Animal M√≠tico del Hor√≥scopo`;
          
          // Contenedor del contenido
          const cardContent = document.createElement('div');
          cardContent.className = 'card-content';
          
          // Imagen del animal con efectos
          const imgDiv = document.createElement('div');
          imgDiv.className = 'card-hanzi';
          imgDiv.style.display = 'flex';
          imgDiv.style.justifyContent = 'center';
          imgDiv.style.alignItems = 'center';
          imgDiv.style.height = '100%';
          
          const animalImg = document.createElement('img');
          animalImg.src = `img/${animal.image}`;
          animalImg.alt = animal.name;
          animalImg.className = 'horoscope-animal-image';
          animalImg.style.filter = 'none';
          animalImg.onerror = function() {
            console.log(`Error loading image: img/${animal.image}`);
            this.style.display = 'none';
          };
          
          imgDiv.appendChild(animalImg);
          cardContent.appendChild(imgDiv);
          
          // Badge m√≠tico con car√°cter chino
          const badge = document.createElement('div');
          badge.className = 'card-streak-badge mythic-streak-badge';
          badge.textContent = animal.chinese;
          badge.style.fontSize = '14px';
          badge.style.fontWeight = 'bold';
          
          // Badge de categor√≠a m√≠tico
          const catBadge = document.createElement('div');
          catBadge.className = 'card-category-badge mythic-category-badge';
          catBadge.textContent = "M√çTICO";
          catBadge.style.fontSize = '8px';
          
          // Ensamblar carta m√≠tica
          cell.appendChild(cardContent);
          cell.appendChild(badge);
          cell.appendChild(catBadge);
          
          knownGrid.appendChild(cell);
        }
      });
    }

    // --- Renderizar badges del hor√≥scopo desbloqueados ---
    if(knownCatFilter === 'ALL' && horoscopeBadges.length > 0) { // Solo cuando no hay filtro espec√≠fico
      console.log(`üé® Renderizando ${horoscopeBadges.length} badges del hor√≥scopo`);
      
      // Ordenar badges por categor√≠a para consistencia visual
      const sortedBadges = [...horoscopeBadges].sort((a, b) => {
        if (a.unit !== b.unit) return a.unit.localeCompare(b.unit);
        return a.hanzi.localeCompare(b.hanzi);
      });

      sortedBadges.forEach(badge => {
        const cell = document.createElement('div');
        cell.className = 'horoscope-badge squareCell rounded-xl px-2';
        cell.style.position = 'relative';
        cell.style.background = 'linear-gradient(145deg, #e0f2fe, #81d4fa)';
        cell.style.border = '2px solid #29b6f6';
        cell.style.boxShadow = '0 4px 8px rgba(41, 182, 246, 0.3)';
        cell.title = `${badge.hanzi} - ${badge.meaning} (Badge del Hor√≥scopo)`;
        
        // Contenido principal (hanzi)
        const content = document.createElement('div');
        content.textContent = badge.hanzi;
        content.className = 'leading-tight font-bold text-blue-900 jersey-font-coleccion-cards';
        cell.appendChild(content);
        
        // Badge "H" para indicar que es del hor√≥scopo
        const hBadge = document.createElement('div');
        hBadge.className = 'streak-badge';
        hBadge.style.background = '#29b6f6';
        hBadge.style.color = 'white';
        hBadge.textContent = 'H';
        hBadge.style.fontSize = '12px';
        cell.appendChild(hBadge);
        
        // Badge de categor√≠a de la unidad
        const catBadge = document.createElement('div');
        catBadge.textContent = badge.unit.slice(0, 3).toUpperCase();
        catBadge.style.position = 'absolute';
        catBadge.style.left = '7px';
        catBadge.style.bottom = '7px';
        catBadge.style.fontWeight = 'bold';
        catBadge.style.fontSize = '0.77em';
        catBadge.style.color = 'white';
        catBadge.style.background = 'rgba(41, 182, 246, 0.8)';
        catBadge.style.padding = '1px 3px';
        catBadge.style.borderRadius = '3px';
        catBadge.style.pointerEvents = 'none';
        cell.appendChild(catBadge);
        
        knownGrid.appendChild(cell);
        requestAnimationFrame(() => fitCellText(content, 10, 64));
      });
    }

    // --- Renderizar conocidos normales como Trading Cards ---
    known.forEach(c => {
      // üîÑ Determinar el estado de display para esta carta
      const cardKey = c.id || c.hanzi; // Usar ID si existe, sino hanzi como fallback
      let cardState = cardDisplayStates[cardKey];
      
      // Si no hay estado individual, usar el overlayField global
      if (!cardState) {
        cardState = overlayField;
      }
      
      const value = getDisplayValue(c, cardState);
      const st = c.challengeStreak || 0;
      
      // Determinar rareza basada en streak
      let rarityClass = 'card-common';
      if (st >= 21) rarityClass = 'card-legendary';
      else if (st >= 11) rarityClass = 'card-epic';
      else if (st >= 6) rarityClass = 'card-rare';
      else if (st >= 3) rarityClass = 'card-uncommon';
      
      // Crear la carta
      const cell = document.createElement('div');
      cell.className = `trading-card ${rarityClass} squareCell clickable-card`;
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.cursor = 'pointer';
      cell.style.zIndex = '1';
      
      // Verificar si es nueva carta para animaci√≥n
      if(levelUpIds && levelUpIds.includes(c.id)) {
        cell.classList.add('new-card');
      }
      
      // Contenedor del contenido de la carta
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Hanzi principal
      const hanziDiv = document.createElement('div');
      hanziDiv.className = 'card-hanzi jersey-font-coleccion-cards';
      hanziDiv.textContent = value;
      cardContent.appendChild(hanziDiv);
      
      // Badge de streak (esquina superior derecha)
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge';
      badge.textContent = st;
      
      // Animaci√≥n de level up
      if(levelUpIds && levelUpIds.includes(c.id)) {
        badge.classList.add('levelup-anim');
        // N√∫mero subiendo animado
        let prev = 0;
        if(window.prevKnownState) {
          const prevC = window.prevKnownState.find(x=>x.id===c.id);
          if(prevC) prev = prevC.streak;
        }
        if(prev < st) {
          let n = prev;
          const anim = setInterval(()=>{
            n++;
            badge.textContent = n;
            if(n>=st) clearInterval(anim);
          }, 120);
        }
      }
      
      // Badge de categor√≠a (esquina inferior izquierda)
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge';
      catBadge.textContent = cat;
      
      // Ensamblar la carta
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      // üîÑ Event listener para ciclar individualmente
      cell.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Obtener estado actual de esta carta
        const currentState = cardDisplayStates[cardKey] || overlayField;
        const nextState = getNextDisplayState(currentState);
        
        // Guardar el nuevo estado individual
        cardDisplayStates[cardKey] = nextState;
        
        // Actualizar solo el contenido de esta carta
        const hanziDiv = cell.querySelector('.card-hanzi');
        if (hanziDiv) {
          hanziDiv.textContent = getDisplayValue(c, nextState);
        }
        
        // Actualizar tooltip
        cell.title = `${c.hanzi} (${c.pinyin})\n${c.meaning}\nStreak: ${st} - ${getRarityName(st)}\nModo: ${nextState}`;
      });
      
      // Tooltip con informaci√≥n completa
      cell.title = `${c.hanzi} (${c.pinyin})\n${c.meaning}\nStreak: ${st} - ${getRarityName(st)}\nModo: ${cardState}`;
      
      knownGrid.appendChild(cell);
    });

    // --- Animar salida de perdidos, luego level up, luego reacomodar ---
    if(lostChars.length) {
      setTimeout(()=>{
        // Sonido removido para evitar conflictos con nuevo sonido de satisfacci√≥n
        lostRow.childNodes.forEach(cell=>{
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-40px)';
        });
        setTimeout(()=>{
          lostRow.remove();
          // Animar level up despu√©s de perdidos
          animateLevelUps(levelUpIds, ()=>{
            // Al terminar animaci√≥n, re-renderizar la tabla normal SIN animaciones para evitar bucle
            setTimeout(()=>renderKnownGridWithAnimations([], [], []), 100);
          });
        }, 700);
      }, 1200);
    } else {
      // Si no hay perdidos, animar level up inmediatamente sin recursi√≥n
      setTimeout(()=>animateLevelUps(levelUpIds), 400);
    }

    // --- Animaci√≥n visual llamativa para level up (brillo verde en celda entera) ---
    function animateLevelUps(levelUpIds, onDone) {
      if(!levelUpIds || !levelUpIds.length) { if(onDone) onDone(); return; }
      const cells = knownGrid.querySelectorAll('.squareCell');
  const animDuration = 3900;
      let anyLevelUp = false;
      cells.forEach(cell => {
        const badge = cell.querySelector('.streak-badge');
        if(!badge) return;
        const hanzi = cell.querySelector('div').textContent;
        const c = cards.find(x => x.hanzi === hanzi && x.known);
        if(c && levelUpIds.includes(c.id)) {
          anyLevelUp = true;
          // --- POP de la celda ---
          cell.animate([
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: cell.style.background || '' },
            { transform: 'scale(1.13)', boxShadow: '0 0 40px 16px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1.05)', boxShadow: '0 0 24px 8px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: '#22c55e33' }
          ], {
            duration: animDuration*0.6,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          // --- Badge de racha crece y vuelve ---
          // Cambiar badge a amarillo con glow durante la animaci√≥n
          const originalBg = badge.style.background;
          const originalBoxShadow = badge.style.boxShadow;
          badge.style.background = '#fbbf24';
          badge.style.boxShadow = '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24';
          badge.animate([
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1.35)', filter: 'brightness(1.7)', boxShadow: '0 0 40px 16px #fde68a, 0 0 0 4px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' }
          ], {
            duration: animDuration*0.4,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          setTimeout(()=>{
            badge.style.background = originalBg || '#3B82F6';
            badge.style.boxShadow = originalBoxShadow || '0 0 10px rgba(0,0,0,.25)';
          }, animDuration*0.8);
          // --- Level up icon (^^) sobre el badge ---
          let lvlIcon = badge.parentElement.querySelector('.levelup-icon');
          if(!lvlIcon) {
            lvlIcon = document.createElement('div');
            lvlIcon.className = 'levelup-icon';
            lvlIcon.innerHTML = '<span style="font-size:20px;font-weight:bold;color:#fbbf24;text-shadow:0 0 8px #fde68a,0 2px 2px #0007;">^^</span>';
            lvlIcon.style.position = 'absolute';
            lvlIcon.style.right = '10px';
            lvlIcon.style.bottom = '38px';
            lvlIcon.style.pointerEvents = 'none';
            lvlIcon.style.opacity = '0';
            badge.parentElement.appendChild(lvlIcon);
          }
          // Dura el doble de tiempo visible
          const lvlIconDuration = animDuration;
          lvlIcon.animate([
            { opacity: 0, transform: 'translateY(10px) scale(0.7)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.15)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.1)' },
            { opacity: 0, transform: 'translateY(-10px) scale(0.7)' }
          ], {
            duration: lvlIconDuration,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          lvlIcon.style.opacity = '1';
          setTimeout(() => { lvlIcon.style.opacity = '0'; }, lvlIconDuration);
          // --- Fondo verde que desvanece ---
          cell.style.transition = `background 1.1s`;
          cell.style.background = '#22c55e33';
          setTimeout(()=>{
            cell.style.background = 'rgba(34,197,94,0)';
          }, animDuration*0.6);
          setTimeout(()=>{
            cell.style.background = '';
          }, animDuration+1100);
        }
      });
      // Sonido de gloria si hubo level up
      if(anyLevelUp) soundGlory();
      // Llamar onDone despu√©s de la animaci√≥n + 1s de espera
  setTimeout(()=>{ if(onDone) setTimeout(onDone, 1000); }, animDuration);
    }

    // Sonido para salida de perdidos
    function soundLostKnowns() {
      // Sonido digital descendente, tipo "whoosh triste"
      beep(220,0.18,'triangle',0.11);
      setTimeout(()=>beep(130,0.16,'triangle',0.09),90);
      setTimeout(()=>beep(80,0.13,'sine',0.07),180);
    }
    // Sonido de gloria para level up
    function soundGlory() {
      // Acorde mayor brillante
      beep(523,0.22,'triangle',0.13); // C5
      beep(659,0.22,'triangle',0.11); // E5
      beep(784,0.22,'triangle',0.10); // G5
      setTimeout(() => beep(1046, 0.18, 'triangle', 0.10), 180); // C6
      setTimeout(() => beep(1318, 0.13, 'triangle', 0.08), 320); // E6
    }
    
    // Forzar Jersey 10 font y anti-zoom despu√©s del renderizado
    setTimeout(() => {
      forceJerseyFont();
      applyMobileAntiZoom();
    }, 100);
  }

  /* ========= Controles ========= */
  // Inicializar controles despu√©s de que el DOM est√© listo
  function initializeControls() {
    // === DROPDOWNS ===
    
    // --- Nivel 1 dropdown ---
    const btnNivel1 = document.getElementById('btnNivel1');
    const nivel1Box = document.getElementById('nivel1Box');
    const nivel1Arrow = document.getElementById('nivel1Arrow');
    if(btnNivel1 && nivel1Box) {
      btnNivel1.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel1Box.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          nivel1Box.classList.remove('opacity-100', 'scale-y-100');
          nivel1Box.classList.add('opacity-0', 'scale-y-95');
          if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            nivel1Box.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids de nivel antes de abrir este
          closeAllLevelGrids(nivel1Box);
          // Abrir
          nivel1Box.classList.remove('hidden');
          setTimeout(() => {
            nivel1Box.classList.remove('opacity-0', 'scale-y-95');
            nivel1Box.classList.add('opacity-100', 'scale-y-100');
            if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!nivel1Box.classList.contains('hidden')) {
          if (!nivel1Box.contains(e.target) && e.target !== btnNivel1) {
            nivel1Box.classList.remove('opacity-100', 'scale-y-100');
            nivel1Box.classList.add('opacity-0', 'scale-y-95');
            if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              nivel1Box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // --- Nivel 2 dropdown ---
    const btnNivel2 = document.getElementById('btnNivel2');
    const nivel2Box = document.getElementById('nivel2Box');
    const nivel2Arrow = document.getElementById('nivel2Arrow');
    if(btnNivel2 && nivel2Box) {
      btnNivel2.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel2Box.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          nivel2Box.classList.remove('opacity-100', 'scale-y-100');
          nivel2Box.classList.add('opacity-0', 'scale-y-95');
          if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            nivel2Box.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids de nivel antes de abrir este
          closeAllLevelGrids(nivel2Box);
          // Abrir
          nivel2Box.classList.remove('hidden');
          setTimeout(() => {
            nivel2Box.classList.remove('opacity-0', 'scale-y-95');
            nivel2Box.classList.add('opacity-100', 'scale-y-100');
            if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!nivel2Box.classList.contains('hidden')) {
          if (!nivel2Box.contains(e.target) && e.target !== btnNivel2) {
            nivel2Box.classList.remove('opacity-100', 'scale-y-100');
            nivel2Box.classList.add('opacity-0', 'scale-y-95');
            if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              nivel2Box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // --- Nivel 3 dropdown ---
    const btnNivel3 = document.getElementById('btnNivel3');
    const nivel3Box = document.getElementById('nivel3Box');
    const nivel3Arrow = document.getElementById('nivel3Arrow');
    if(btnNivel3 && nivel3Box) {
      btnNivel3.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel3Box.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          nivel3Box.classList.remove('opacity-100', 'scale-y-100');
          nivel3Box.classList.add('opacity-0', 'scale-y-95');
          if(nivel3Arrow) nivel3Arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            nivel3Box.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids de nivel antes de abrir este
          closeAllLevelGrids(nivel3Box);
          // Abrir
          nivel3Box.classList.remove('hidden');
          setTimeout(() => {
            nivel3Box.classList.remove('opacity-0', 'scale-y-95');
            nivel3Box.classList.add('opacity-100', 'scale-y-100');
            if(nivel3Arrow) nivel3Arrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!nivel3Box.classList.contains('hidden')) {
          if (!nivel3Box.contains(e.target) && e.target !== btnNivel3) {
            nivel3Box.classList.remove('opacity-100', 'scale-y-100');
            nivel3Box.classList.add('opacity-0', 'scale-y-95');
            if(nivel3Arrow) nivel3Arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              nivel3Box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // --- Desaf√≠o dropdown ---
    const btnChallenge = document.getElementById('btnChallenge');
    const challengeBox = document.getElementById('challengeBox');
    const challengeArrow = document.getElementById('challengeArrow');
    if(btnChallenge && challengeBox) {
      btnChallenge.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !challengeBox.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          challengeBox.classList.remove('opacity-100', 'scale-y-100');
          challengeBox.classList.add('opacity-0', 'scale-y-95');
          if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            challengeBox.classList.add('hidden');
          }, 300);
        } else {
          // Abrir
          challengeBox.classList.remove('hidden');
          setTimeout(() => {
            challengeBox.classList.remove('opacity-0', 'scale-y-95');
            challengeBox.classList.add('opacity-100', 'scale-y-100');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!challengeBox.classList.contains('hidden')) {
          if (!challengeBox.contains(e.target) && e.target !== btnChallenge) {
            challengeBox.classList.remove('opacity-100', 'scale-y-100');
            challengeBox.classList.add('opacity-0', 'scale-y-95');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              challengeBox.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // === BOTONES DE UNIDADES ===
    
    // Botones de unidades Nivel 1
    const btnUnit2 = document.getElementById('btnUnit2');
    if(btnUnit2) btnUnit2.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit2'); };
    const btnUnit3 = document.getElementById('btnUnit3');
    if(btnUnit3) btnUnit3.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit3'); };
    const btnUnit4 = document.getElementById('btnUnit4');
    if(btnUnit4) btnUnit4.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit4'); };
    const btnUnit5 = document.getElementById('btnUnit5');
    if(btnUnit5) btnUnit5.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit5'); };
    const btnUnit6 = document.getElementById('btnUnit6');
    if(btnUnit6) btnUnit6.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit6'); };
    const btnUnit7 = document.getElementById('btnUnit7');
    if(btnUnit7) btnUnit7.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit7'); };
    const btnUnit8 = document.getElementById('btnUnit8');
    if(btnUnit8) btnUnit8.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit8'); };
    const btnUnit9 = document.getElementById('btnUnit9');
    if(btnUnit9) btnUnit9.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit9'); };
    
    // Botones especiales Nivel 1
    const btnTodoN1 = document.getElementById('btnTodoN1');
    if(btnTodoN1) btnTodoN1.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('todoN1'); };
    const btnDesafioN1 = document.getElementById('btnDesafioN1');
    if(btnDesafioN1) btnDesafioN1.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN1 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN1', 'Nivel 1', 'acceso al Nivel 2'); 
    };
    
    // Botones de unidades Nivel 2
    const btnUnit1N2 = document.getElementById('btnUnit1N2');
    if(btnUnit1N2) btnUnit1N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit1N2'); };
    const btnUnit2N2 = document.getElementById('btnUnit2N2');
    if(btnUnit2N2) btnUnit2N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit2N2'); };
    const btnUnit3N2 = document.getElementById('btnUnit3N2');
    if(btnUnit3N2) btnUnit3N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit3N2'); };
    const btnUnit4N2 = document.getElementById('btnUnit4N2');
    if(btnUnit4N2) btnUnit4N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit4N2'); };
    const btnUnit5N2 = document.getElementById('btnUnit5N2');
    if(btnUnit5N2) btnUnit5N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit5N2'); };
    const btnUnit6N2 = document.getElementById('btnUnit6N2');
    if(btnUnit6N2) btnUnit6N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit6N2'); };
    const btnUnit7N2 = document.getElementById('btnUnit7N2');
    if(btnUnit7N2) btnUnit7N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit7N2'); };
    const btnUnit8N2 = document.getElementById('btnUnit8N2');
    if(btnUnit8N2) btnUnit8N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit8N2'); };
    const btnUnit9N2 = document.getElementById('btnUnit9N2');
    if(btnUnit9N2) btnUnit9N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit9N2'); };
    const btnTodoN2 = document.getElementById('btnTodoN2');
    if(btnTodoN2) btnTodoN2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('todoN2'); };
    const btnDesafioN2 = document.getElementById('btnDesafioN2');
    if(btnDesafioN2) btnDesafioN2.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN2 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN2', 'Nivel 2', 'acceso al Nivel 3 y Desaf√≠os del Hor√≥scopo'); 
    };
    
    // Botones de unidades Nivel 3
    const btnUnit1N3 = document.getElementById('btnUnit1N3');
    if(btnUnit1N3) btnUnit1N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit1N3'); };
    const btnUnit2N3 = document.getElementById('btnUnit2N3');
    if(btnUnit2N3) btnUnit2N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit2N3'); };
    const btnUnit3N3 = document.getElementById('btnUnit3N3');
    if(btnUnit3N3) btnUnit3N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit3N3'); };
    const btnUnit4N3 = document.getElementById('btnUnit4N3');
    if(btnUnit4N3) btnUnit4N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit4N3'); };
    const btnUnit5N3 = document.getElementById('btnUnit5N3');
    if(btnUnit5N3) btnUnit5N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit5N3'); };
    const btnUnit6N3 = document.getElementById('btnUnit6N3');
    if(btnUnit6N3) btnUnit6N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit6N3'); };
    const btnUnit7N3 = document.getElementById('btnUnit7N3');
    if(btnUnit7N3) btnUnit7N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit7N3'); };
    const btnUnit8N3 = document.getElementById('btnUnit8N3');
    if(btnUnit8N3) btnUnit8N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit8N3'); };
    const btnUnit9N3 = document.getElementById('btnUnit9N3');
    if(btnUnit9N3) btnUnit9N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('unit9N3'); };
    const btnTodoN3 = document.getElementById('btnTodoN3');
    if(btnTodoN3) btnTodoN3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('todoN3'); };
    const btnDesafioN3 = document.getElementById('btnDesafioN3');
    if(btnDesafioN3) btnDesafioN3.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN3 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN3', 'Nivel 3', 'Pr√≥ximo Nivel (Pr√≥ximamente)'); 
    };
    
    // Botones de desaf√≠o
    const btnDesafioClassico = document.getElementById('btnDesafioClassico');
    if(btnDesafioClassico) btnDesafioClassico.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startDesafioClasico2WithSystem('challenge'); };
    const btnDesafioMenos = document.getElementById('btnDesafioMenos');
    if(btnDesafioMenos) btnDesafioMenos.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startDesafioClasico2WithSystem('menos'); };
    const btnDesafioMas = document.getElementById('btnDesafioMas');
    if(btnDesafioMas) btnDesafioMas.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startDesafioClasico2WithSystem('mas'); };
    
    // Funci√≥n para cerrar todos los grids
    function closeAllGrids(except = null) {
      const grids = [
        { box: document.getElementById('horoscopoBox'), arrow: document.getElementById('horoscopoArrow') },
        { box: document.getElementById('desafiosHoroscopoBox'), arrow: document.getElementById('desafiosHoroscopoArrow') }
      ];
      
      grids.forEach(grid => {
        if (grid.box && grid.box !== except && !grid.box.classList.contains('hidden')) {
          grid.box.style.opacity = '0';
          grid.box.style.transform = 'scaleY(0.95)';
          if (grid.arrow) grid.arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            grid.box.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // Funci√≥n para cerrar todos los grids de nivel
    function closeAllLevelGrids(except = null) {
      const levelGrids = [
        { box: document.getElementById('nivel1Box'), arrow: document.getElementById('nivel1Arrow') },
        { box: document.getElementById('nivel2Box'), arrow: document.getElementById('nivel2Arrow') },
        { box: document.getElementById('nivel3Box'), arrow: document.getElementById('nivel3Arrow') }
      ];
      
      levelGrids.forEach(grid => {
        if (grid.box && grid.box !== except && !grid.box.classList.contains('hidden')) {
          grid.box.classList.remove('opacity-100', 'scale-y-100');
          grid.box.classList.add('opacity-0', 'scale-y-95');
          if (grid.arrow) grid.arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            grid.box.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // === MODAL DE DONACI√ìN ===
    const btnDonation = document.getElementById('btnDonation');
    const donationModal = document.getElementById('donationModal');
    const donationArrow = document.getElementById('donationArrow');
    
    if (btnDonation && donationModal && donationArrow) {
      btnDonation.onclick = (e) => {
        e.stopPropagation();
        
        const isVisible = !donationModal.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          donationModal.classList.add('hidden');
          donationArrow.style.transform = 'rotate(0deg)';
        } else {
          // Abrir
          donationModal.classList.remove('hidden');
          donationArrow.style.transform = 'rotate(180deg)';
        }
      };
      
      // Cerrar modal al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!donationModal.classList.contains('hidden')) {
          if (!donationModal.contains(e.target) && e.target !== btnDonation) {
            donationModal.classList.add('hidden');
            donationArrow.style.transform = 'rotate(0deg)';
          }
        }
      });
    }
    
    // HOR√ìSCOPO - Bot√≥n principal y dropdown
    const btnHoroscopo = document.getElementById('btnHoroscopo');
    const horoscopoBox = document.getElementById('horoscopoBox');
    const horoscopoArrow = document.getElementById('horoscopoArrow');
    
    if (btnHoroscopo && horoscopoBox && horoscopoArrow) {
      btnHoroscopo.onclick = (e) => {
        e.stopPropagation();
        
        const isVisible = !horoscopoBox.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          horoscopoBox.style.opacity = '0';
          horoscopoBox.style.transform = 'scaleY(0.95)';
          horoscopoArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            horoscopoBox.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids antes de abrir este
          closeAllGrids(horoscopoBox);
          // Abrir
          horoscopoBox.classList.remove('hidden');
          horoscopoArrow.style.transform = 'rotate(180deg)';
          setTimeout(() => {
            horoscopoBox.style.opacity = '1';
            horoscopoBox.style.transform = 'scaleY(1)';
          }, 10);
        }
      };
      
      // Cerrar cuando se hace click fuera
      document.addEventListener('click', (e) => {
        if (!btnHoroscopo.contains(e.target) && !horoscopoBox.contains(e.target)) {
          horoscopoBox.style.opacity = '0';
          horoscopoBox.style.transform = 'scaleY(0.95)';
          horoscopoArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            horoscopoBox.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // HOR√ìSCOPO - Botones de animales
    const btnRata = document.getElementById('btnRata');
    if(btnRata) btnRata.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('colores'); };
    const btnGallo = document.getElementById('btnGallo');
    if(btnGallo) btnGallo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('fruta'); };
    const btnConejo = document.getElementById('btnConejo');
    if(btnConejo) btnConejo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('verduras'); };
    const btnCerdo = document.getElementById('btnCerdo');
    if(btnCerdo) btnCerdo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('comidas'); };
    const btnPerro = document.getElementById('btnPerro');
    if(btnPerro) btnPerro.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('animales'); };
    const btnCaballo = document.getElementById('btnCaballo');
    if(btnCaballo) btnCaballo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('deportes'); };
    const btnBuey = document.getElementById('btnBuey');
    if(btnBuey) btnBuey.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('hobbies'); };
    const btnCabra = document.getElementById('btnCabra');
    if(btnCabra) btnCabra.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('ropa'); };
    const btnSerpiente = document.getElementById('btnSerpiente');
    if(btnSerpiente) btnSerpiente.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('casa'); };
    const btnMono = document.getElementById('btnMono');
    if(btnMono) btnMono.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('cuerpo'); };
    const btnTigre = document.getElementById('btnTigre');
    if(btnTigre) btnTigre.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('profesiones'); };
    const btnDragon = document.getElementById('btnDragon');
    if(btnDragon) btnDragon.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); startMission('emociones'); };
    
    // DESAF√çOS DEL HOR√ìSCOPO - Bot√≥n principal y dropdown
    const btnDesafiosHoroscopo = document.getElementById('btnDesafiosHoroscopo');
    const desafiosHoroscopoBox = document.getElementById('desafiosHoroscopoBox');
    const desafiosHoroscopoArrow = document.getElementById('desafiosHoroscopoArrow');
    
    if (btnDesafiosHoroscopo && desafiosHoroscopoBox && desafiosHoroscopoArrow) {
      btnDesafiosHoroscopo.onclick = (e) => {
        e.stopPropagation();
        
        const isVisible = !desafiosHoroscopoBox.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          desafiosHoroscopoBox.style.opacity = '0';
          desafiosHoroscopoBox.style.transform = 'scaleY(0.95)';
          desafiosHoroscopoArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            desafiosHoroscopoBox.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids antes de abrir este
          closeAllGrids(desafiosHoroscopoBox);
          // Abrir
          desafiosHoroscopoBox.classList.remove('hidden');
          desafiosHoroscopoArrow.style.transform = 'rotate(180deg)';
          setTimeout(() => {
            desafiosHoroscopoBox.style.opacity = '1';
            desafiosHoroscopoBox.style.transform = 'scaleY(1)';
          }, 10);
        }
      };
      
      // Cerrar cuando se hace click fuera
      document.addEventListener('click', (e) => {
        if (!btnDesafiosHoroscopo.contains(e.target) && !desafiosHoroscopoBox.contains(e.target)) {
          desafiosHoroscopoBox.style.opacity = '0';
          desafiosHoroscopoBox.style.transform = 'scaleY(0.95)';
          desafiosHoroscopoArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            desafiosHoroscopoBox.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // DESAF√çOS DEL HOR√ìSCOPO - Botones de animales (desaf√≠os especializados)
    const btnDesafioRata = document.getElementById('btnDesafioRata');
    console.log('üîç DEBUG btnDesafioRata:', btnDesafioRata);
    if(btnDesafioRata) {
      btnDesafioRata.onclick = () => { 
        console.log('üîç DEBUG: Click en btnDesafioRata');
        desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
        showHoroscopeModal('colores'); 
      };
    }
    
    // Bot√≥n Desaf√≠o Final
    const btnDesafioFinal = document.getElementById('btnDesafioFinal');
    if(btnDesafioFinal) {
      btnDesafioFinal.onclick = () => {
        console.log('üèÜ Clic en Desaf√≠o Final desde grid');

        // Si est√° desbloqueado, continuar normalmente
        desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden');
        
        try {
          startUltimateChallenge();
        } catch (error) {
          console.error('Error:', error);
        }
      };
      // Actualizar visibilidad inicial
      updateUltimateChallengeButton();
      console.log('üèÜ Bot√≥n Desaf√≠o Final configurado');
    } else {
      console.error('‚ö†Ô∏è btnDesafioFinal no encontrado');
    }
    const btnDesafioGallo = document.getElementById('btnDesafioGallo');
    if(btnDesafioGallo) btnDesafioGallo.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('fruta'); };
    const btnDesafioConejo = document.getElementById('btnDesafioConejo');
    if(btnDesafioConejo) btnDesafioConejo.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('verduras'); };
    const btnDesafioCerdo = document.getElementById('btnDesafioCerdo');
    if(btnDesafioCerdo) btnDesafioCerdo.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('comidas'); };
    const btnDesafioPerro = document.getElementById('btnDesafioPerro');
    if(btnDesafioPerro) btnDesafioPerro.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('animales'); };
    const btnDesafioCaballo = document.getElementById('btnDesafioCaballo');
    if(btnDesafioCaballo) btnDesafioCaballo.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('deportes'); };
    const btnDesafioBuey = document.getElementById('btnDesafioBuey');
    if(btnDesafioBuey) btnDesafioBuey.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('hobbies'); };
    const btnDesafioCabra = document.getElementById('btnDesafioCabra');
    if(btnDesafioCabra) btnDesafioCabra.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('ropa'); };
    const btnDesafioSerpiente = document.getElementById('btnDesafioSerpiente');
    if(btnDesafioSerpiente) btnDesafioSerpiente.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('casa'); };
    const btnDesafioMono = document.getElementById('btnDesafioMono');
    if(btnDesafioMono) btnDesafioMono.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('cuerpo'); };
    const btnDesafioTigre = document.getElementById('btnDesafioTigre');
    if(btnDesafioTigre) btnDesafioTigre.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('profesiones'); };
    const btnDesafioDragon = document.getElementById('btnDesafioDragon');
    if(btnDesafioDragon) btnDesafioDragon.onclick = () => { desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); showHoroscopeModal('emociones'); };
  }

  document.getElementById('btnKnown').onclick   = () => startMission('known');
  // Filtros de categor√≠a para la tabla de conocidos
  document.getElementById('btnCatAll').onclick = () => { knownCatFilter = 'ALL'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatS').onclick   = () => { knownCatFilter = 'S'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatA').onclick   = () => { knownCatFilter = 'A'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatV').onclick   = () => { knownCatFilter = 'V'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatP').onclick   = () => { knownCatFilter = 'P'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatE').onclick   = () => { knownCatFilter = 'E'; showKnownTableWithAnimations(); };
  document.getElementById('btnRevise1').onclick = () => startMission('revise1');
  document.getElementById('btnRevise2').onclick = () => startMission('revise2');

  // btnChallenge onclick manejado por dropdown m√°s abajo
  document.getElementById('btnQuizPinyin').onclick  = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizPinyin');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };
  document.getElementById('btnQuizMeaning').onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizMeaning');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP  
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };

  document.getElementById('btnKnownTable').onclick = () => {
    if (currentMission === 'challenge' || 
        currentMission === 'desafioN1' || 
        currentMission === 'desafioN2' || 
        currentMission === 'desafioN3' || 
        currentMission === 'colores' ||
        currentMission === 'fruta' ||
        currentMission === 'verduras' ||
        currentMission === 'comidas' ||
        currentMission === 'animales' ||
        currentMission === 'deportes' ||
        currentMission === 'hobbies' ||
        currentMission === 'ropa' ||
        currentMission === 'casa' ||
        currentMission === 'cuerpo' ||
        currentMission === 'profesiones' ||
        currentMission === 'emociones' ||
        currentMission === 'desafioColores' ||
        currentMission === 'desafioFruta' ||
        currentMission === 'desafioVerduras' ||
        currentMission === 'desafioComidas' ||
        currentMission === 'desafioAnimales' ||
        currentMission === 'desafioDeportes' ||
        currentMission === 'desafioHobbies' ||
        currentMission === 'desafioRopa' ||
        currentMission === 'desafioCasa' ||
        currentMission === 'desafioCuerpo' ||
        currentMission === 'desafioProfesiones' ||
        currentMission === 'desafioEmociones' ||
        currentMission === 'ultimateChallenge' ||
        ultimateChallengeActive) {
      
      console.log('üö™ SALIENDO del modo desaf√≠o para ver Tabla Conocidas');
      console.log('- currentMission antes:', currentMission);
      console.log('- ultimateChallengeActive antes:', ultimateChallengeActive);
      console.log('- ¬øEs desaf√≠o hor√≥scopo?', currentMission && currentMission.startsWith('desafio'));
      
      // GUARDAR EL MODO ORIGINAL ANTES DE CAMBIAR
      const originalMission = currentMission;
      const wasUltimateChallengeActive = ultimateChallengeActive;
      
      // RESET PARCIAL - cambiar misi√≥n pero recordar el estado original para statBox
      currentMission = 'known'; // Cambiar a modo normal para tabla conocidas
      ultimateChallengeActive = false; // Desactivar Ultimate Challenge temporalmente
      
      // ACTUALIZAR VISIBILIDAD DE BOTONES DE QUIZ
      updateQuizButtonsVisibility('known');
      
      // Limpiar estado de desaf√≠o completamente
      sessionQueue = [];
      sessionCorrect = 0;
      sessionTotal = 0;
      currentCard = null;
      todayReviewed = 0;
      
      // Limpiar clases visuales de desaf√≠o
      clearAllChallengeThemes();
      stopDesafioMusic();
      
      // Ocultar corazones y timer del Ultimate Challenge si est√°n visibles
      hideUltimateChallengeHearts();
      stopUltimateChallengeTimer();
      
      // OCULTAR LA TARJETA ACTUAL pero mantener statBox en desaf√≠os
      const gameBox = document.getElementById('gameBox');
      const statBox = document.getElementById('statBox');
      console.log('üéØ DEBUG: Ocultando gameBox, manteniendo statBox para desaf√≠os');
      
      // Siempre ocultar gameBox (las cartas)
      if (gameBox) {
        gameBox.style.display = 'none';
        console.log('‚úÖ gameBox ocultado');
      }
      
      // Solo ocultar statBox si NO era un desaf√≠o en curso (usar estado original)
      // En desaf√≠os, el usuario debe poder ver el estado actual
      const isChallenge = (
        originalMission === 'challenge' || 
        originalMission === 'desafioN1' || 
        originalMission === 'desafioN2' || 
        originalMission === 'desafioN3' || 
        originalMission.startsWith('desafio') ||
        originalMission === 'ultimateChallenge' ||
        wasUltimateChallengeActive
      );
      
      console.log('üîç DEBUG STATBOX:');
      console.log('- originalMission:', originalMission);
      console.log('- currentMission (ahora):', currentMission);
      console.log('- wasUltimateChallengeActive:', wasUltimateChallengeActive);
      console.log('- ultimateChallengeActive (ahora):', ultimateChallengeActive);
      console.log('- isChallenge:', isChallenge);
      console.log('- statBox existe:', !!statBox);
      
      if (statBox && !isChallenge) {
        statBox.style.display = 'none';
        console.log('‚úÖ statBox ocultado (no es desaf√≠o)');
      } else if (statBox) {
        statBox.style.display = '';
        console.log('üìä statBox mantenido visible (es desaf√≠o)');
      }
      
      // MOSTRAR SECCIONES NORMALES
      const knownTableSection = document.querySelector('section.mt-16');
      console.log('üéØ DEBUG: Mostrando secci√≥n tabla conocidas:', knownTableSection);
      if (knownTableSection) {
        knownTableSection.style.display = 'block';
        console.log('‚úÖ Secci√≥n tabla conocidas mostrada');
      }
      
      // FORZAR MOSTRAR TABLA CONOCIDAS
      overlayField = 'hanzi';
      console.log('üéØ DEBUG: Llamando showKnownTableWithAnimations()');
      showKnownTableWithAnimations();
      
      // CERRAR TODAS LAS OVERLAYS QUE PUEDAN ESTAR ABIERTAS
      const overlays = ['challengeSuccessOverlay', 'challengeFailOverlay', 'ultimateChallengeSuccessOverlay', 'ultimateChallengeFailureOverlay'];
      overlays.forEach(overlayId => {
        const overlay = document.getElementById(overlayId);
        if (overlay) {
          overlay.classList.add('hidden');
          console.log(`‚úÖ Overlay ${overlayId} cerrado`);
        }
      });
      
      console.log('‚úÖ RESET COMPLETO TERMINADO. currentMission ahora:', currentMission);
      
      // Scroll forzado a la tabla despu√©s de un momento
      setTimeout(() => {
        console.log('üéØ DEBUG: Iniciando scroll a tabla conocidas');
        const knownGrid = document.getElementById('knownGrid');
        if (knownGrid) {
          console.log('‚úÖ knownGrid encontrado, haciendo scroll');
          window.scrollTo({ top: knownGrid.offsetTop - 60, behavior: 'smooth' });
        } else {
          console.log('‚ùå knownGrid NO encontrado');
        }
        
        // Verificar estado final
        console.log('üîç ESTADO FINAL:');
        console.log('- currentMission:', currentMission);
        console.log('- gameBox display:', gameBox ? gameBox.style.display : 'no encontrado');
        console.log('- statBox display:', statBox ? statBox.style.display : 'no encontrado');
        console.log('- knownTableSection display:', knownTableSection ? knownTableSection.style.display : 'no encontrado');
      }, 200);
      
    } else {
      // Asegurarse de que statBox est√© visible en modo normal
      const statBox = document.getElementById('statBox');
      if (statBox) {
        statBox.style.display = '';
        console.log('üìä statBox mantenido visible en modo normal');
      }
      
      overlayField = 'hanzi';
      showKnownTableWithAnimations();
      window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
    }
  };

  // Actualizar badge de Maestro del Hor√≥scopo
  function updateHoroscopeMasterBadge() {
    const badge = document.getElementById('horoscopeMasterBadge');
    if (!badge) return;
    
    if (horoscopeMaster) {
      badge.classList.remove('hidden');
      // Si complet√≥ m√∫ltiples veces, mostrar el contador
      if (ultimateChallengeCompletedCount > 1) {
        badge.innerHTML = `üèÜ Maestro del Hor√≥scopo (${ultimateChallengeCompletedCount}x)`;
      } else {
        badge.innerHTML = `üèÜ Maestro del Hor√≥scopo`;
      }
      console.log('üèÜ Badge de Maestro del Hor√≥scopo mostrado');
    } else {
      badge.classList.add('hidden');
      console.log('üîí Badge de Maestro del Hor√≥scopo oculto');
    }
  }

  // Funci√≥n para detectar level up y perdidos y disparar animaciones
  function showKnownTableWithAnimations() {
    // Prevenir llamadas m√∫ltiples simult√°neas
    if(window._animatingKnownTable) return;
    window._animatingKnownTable = true;
    
    // Actualizar badge de maestro del hor√≥scopo
    updateHoroscopeMasterBadge();
    
    // Estado actual (EXCLUIR badges del hor√≥scopo)
    const currentKnown = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo').map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    // Detectar level up (EXCLUIR animales del hor√≥scopo que no pueden subir de nivel)
    const prevMap = Object.fromEntries(prevKnownState.map(c => [c.id, c]));
    const levelUpIds = [];
    for (const c of currentKnown) {
      // EXCLUIR cartas sin ID (badges del hor√≥scopo) y animales del hor√≥scopo
      if (!c.id) {
        console.log('ÔøΩ Excluido por no tener ID (badge del hor√≥scopo):', c.hanzi);
        continue; // Saltar expl√≠citamente a la siguiente iteraci√≥n
      } else if (prevMap[c.id] && c.streak > prevMap[c.id].streak) {
        // Buscar la tarjeta completa para verificar si es animal del hor√≥scopo
        const fullCard = cards.find(card => card.id === c.id);
        
        console.log(`üîç DEBUG Level Up Check: ${c.hanzi} (ID: ${c.id})`);
        console.log(`   - Streak actual: ${c.streak}, Streak previo: ${prevMap[c.id].streak}`);
        console.log(`   - Tarjeta encontrada:`, fullCard ? {
          hanzi: fullCard.hanzi, 
          unit: fullCard.unit,
          isHoroscopeAnimal: fullCard.isHoroscopeAnimal,
          meaning: fullCard.meaning?.slice(0, 30) + '...'
        } : 'NO ENCONTRADA');
        
        // Solo permitir level up si:
        // 1. La tarjeta existe
        // 2. NO es animal del hor√≥scopo 
        // 3. NO tiene unit 'horoscopo' (badges del hor√≥scopo)
        if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
          console.log(`‚úÖ Level Up confirmado para: ${c.hanzi} (${fullCard.unit})`);
          levelUpIds.push(c.id);
        } else {
          console.log(`üö´ Excluido: ${c.hanzi} - Motivo:`, 
            !fullCard ? 'No encontrada' :
            fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
            fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
        }
      }
    }
    // Detectar perdidos (EXCLUIR animales del hor√≥scopo que no se pueden perder)
    const currentIds = new Set(currentKnown.map(c => c.id));
    const lostChars = prevKnownState.filter(c => {
      if (!currentIds.has(c.id)) {
        const fullCard = cards.find(card => card.id === c.id);
        return !fullCard?.isHoroscopeAnimal;
      }
      return false;
    });
    
    // Detectar caracteres nuevos a√±adidos (EXCLUIR animales del hor√≥scopo)
    const prevIds = new Set(prevKnownState.map(c => c.id));
    const newlyAdded = currentKnown.filter(c => {
      if (!prevIds.has(c.id)) {
        const fullCard = cards.find(card => card.id === c.id);
        return !fullCard?.isHoroscopeAnimal && fullCard?.unit !== 'horoscopo';
      }
      return false;
    });
    
    // Guardar para animaciones siguientes
    window._levelUpIds = levelUpIds;
    window._lostChars = lostChars;
    window._newlyAdded = newlyAdded;
    // Renderizar tabla con animaciones (siguiente paso)
    renderKnownGridWithAnimations(levelUpIds, lostChars, newlyAdded);
    // Guardar nuevo estado previo para la pr√≥xima vez
    prevKnownState = currentKnown.map(c => ({ ...c }));
    window.prevKnownState = prevKnownState;
    
    // Liberar bloqueo despu√©s de un breve delay para permitir que terminen las animaciones
    setTimeout(() => {
      window._animatingKnownTable = false;
    }, 100);
  }
  // üîÑ Botones globales - limpian estados individuales y aplican a todos
  const btnShowHanzi = document.getElementById('btnShowHanzi');
  const btnShowPinyin = document.getElementById('btnShowPinyin');
  const btnShowMeaning = document.getElementById('btnShowMeaning');
  
  if (btnShowHanzi) {
    btnShowHanzi.onclick = ()=>{ 
      overlayField='hanzi'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Hanzi aplicado a todas las cartas');
    };
  }
  
  if (btnShowPinyin) {
    btnShowPinyin.onclick = ()=>{ 
      overlayField='pinyin'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Pinyin aplicado a todas las cartas');
    };
  }
  
  if (btnShowMeaning) {
    btnShowMeaning.onclick = ()=>{ 
      overlayField='meaning'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Traducci√≥n aplicada a todas las cartas');
    };
  }

  // Verificar que los elementos existan antes de asignar eventos
  const btnKnow = document.getElementById('btnKnow');
  const btnDontKnow = document.getElementById('btnDontKnow');
  
  if (btnKnow) {
    btnKnow.onclick = () => respond(true);
  }
  if (btnDontKnow) {
    btnDontKnow.onclick = () => respond(false);
  }

  // El flip manual puede no verse si quedan pegadas clases de transici√≥n
  // que pisan `transform` (por ej. card-flip-vert.flipped). Limpiar antes.
  function normalizeCardForManualFlip() {
    cardEl.classList.remove(
      'card-flip-vert',
      'flipping',
      'flipped',
      'card-flip-up-out',
      'card-flip-up-in',
      'card-flip-animate'
    );
    if (cardEl.style && cardEl.style.transform) cardEl.style.transform = '';
  }

  document.getElementById('btnFlip').onclick     = () => {
    const flashVisible = !flashRow.classList.contains('hidden');
    if (currentCard && (mode === 'flash' || flashVisible)) {
      normalizeCardForManualFlip();
      flipped = !flipped;
      flipped ? cardEl.classList.add('flip') : cardEl.classList.remove('flip');
    }
  };
  cardEl.onclick = () => {
    const flashVisible = !flashRow.classList.contains('hidden');
    if (currentCard && (mode === 'flash' || flashVisible)) {
      normalizeCardForManualFlip();
      flipped = !flipped;
      flipped ? cardEl.classList.add('flip') : cardEl.classList.remove('flip');
    }
  };


  document.getElementById('btnReset').onclick = async () => {
    if(!confirm('¬øReiniciar TODO? Se borrar√° el progreso y se cargar√°n las Unidades 2‚Äì9.')) return;
    cards = [];
    // MODO DOCUMENTAL: siempre mantener todo desbloqueado
    nivel2Unlocked = true;
    nivel3Unlocked = true;
    horoscopeAnimalsUnlocked = [...ALL_HOROSCOPE_CATEGORIES];
    await saveUserState();
    await loadAll();
    startMission('unit2');
  };

  // Bot√≥n de reiniciar XP
  document.getElementById('btnResetXP').onclick = () => {
    if(confirm('¬øSeguro que quieres reiniciar tu Nivel a 0?')) {
      xpPoints = 0;
      saveXP();
      renderXPBar();
    }
  };

  // Bot√≥n "si se traba" para refrescar la p√°gina
  document.getElementById('btnSiSeTraba').onclick = () => {
    location.reload();
  };

  // Funci√≥n para inicializar los botones de reinicio
  function initializeResetButtons() {
    const btnShowResetOptions = document.getElementById('btnShowResetOptions');
    const btnCancelReset = document.getElementById('btnCancelReset');
    
    if (btnShowResetOptions) {
      btnShowResetOptions.onclick = () => {
        const mainContainer = document.getElementById('mainButtonsContainer');
        const resetContainer = document.getElementById('resetButtonsContainer');
        
        if (mainContainer && resetContainer) {
          // Ocultar botones principales y mostrar opciones de reinicio
          mainContainer.style.display = 'none';
          resetContainer.style.display = 'grid';
        }
      };
    }

    if (btnCancelReset) {
      btnCancelReset.onclick = () => {
        const mainContainer = document.getElementById('mainButtonsContainer');
        const resetContainer = document.getElementById('resetButtonsContainer');
        
        if (mainContainer && resetContainer) {
          // Volver a mostrar botones principales y ocultar opciones de reinicio
          mainContainer.style.display = 'grid';
          resetContainer.style.display = 'none';
        }
      };
    }
  }

  // Mensaje temporal para modo desaf√≠o (funci√≥n utilitaria)
  function showChallengeWarning() {
    let msg = document.getElementById('challengeWarningMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'challengeWarningMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-rose-700 text-white px-6 py-3 rounded-2xl shadow-lg text-base font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      msg.textContent = 'Desafio terminado. No se puede ver la tabla cuando est√°s en modo desaf√≠o';
      document.body.appendChild(msg);
    }
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 1800);
  }

// --- Funci√≥n para iniciar desaf√≠os personalizaados ---
async function startChallengeCustom(tipo) {
  let pool;
  if(tipo === 'menos') {
    pool = shuffle(cards.filter(c => c.known && (c.challengeStreak === 0 || c.challengeStreak === 1) && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  } else if(tipo === 'mas') {
    pool = shuffle(cards.filter(c => c.known && c.challengeStreak >= 2 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  } else {
    pool = shuffle(cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  }
  sessionQueue = pool.slice(0,10); // 10 tarjetas por desaf√≠o personalizado
  currentMission = 'challenge';
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  setMode(Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin');
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  
  // ¬°PRECARGAR VIDEO DE FONDO! (M√∫sica se inicia en countdown)
  await createChallengeVideoWithPreload('challenge');
  // playDesafioMusic('challenge'); // ‚ú® MOVIDO AL COUNTDOWN
  
  nextCard();
  updateStats();
}

// --- Funci√≥n para mostrar modal de presentaci√≥n del desaf√≠o ---
function showHoroscopeModal(categoria) {
  console.log(`üîç DEBUG: showHoroscopeModal ejecut√°ndose con: ${categoria}`);
  
  // Filtrar TODAS las palabras de la categor√≠a espec√≠fica (conocidas o sno)
  const pool = cards.filter(c => c.unit === categoria);
  
  // Si no hay palabras de esa categor√≠a, mostrar mensaje
  if(pool.length === 0) {
    alert(`No se encontraron palabras para la categor√≠a "${categoria}".`);
    return;
  }
  
  // MODO DOCUMENTAL: sin requisito de m√≠nimo de conocidos
  
  // Mostrar modal con imagen
  const animal = horoscopeAnimals[categoria];
  const unlockedCount = horoscopeAnimalsUnlocked.length;
  
  const modal = document.createElement('div');
  modal.id = 'horoscope-modal-active';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #9c88ff;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(156, 136, 255, 0.3);
      position: relative;
    ">
      <div style="
        display: flex;
        justify-content: center;
        margin-bottom: 2px;
      ">
        <div class="horoscope-modal-image">
          <img src="img/${animal.image}" alt="${animal.name}" style="
            width: 150px;
            height: 180px;
            object-fit: cover;
          ">
        </div>
      </div>
      
      <h2 style="
        color: #9c88ff;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 3px 0;
        text-shadow: 2px 2px 0px #4c1d95;
      ">‚öîÔ∏è DESAF√çO DEL ${animal.chinese} ‚öîÔ∏è</h2>
      
      <h3 style="
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 1px 0;
        text-shadow: 1px 1px 0px #000000;
      ">${animal.name.toUpperCase()}</h3>
      
      <div style="
        background: rgba(156, 136, 255, 0.1);
        border: 2px solid #9c88ff;
        border-radius: 12px;
        padding: 10px 20px;
        margin: 3px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.4;
        text-align: left;
      ">
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ff6b6b;">üíÄ Cada ERROR</span> elimina el car√°cter M√ÅS 2 al AZAR de tu Colecci√≥n</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #87ceeb;">üìä Progreso</span> ${unlockedCount}/12 animales del hor√≥scopo coleccionados</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #FFD700;">üê≤ Colecciona los 12 animales</span> para Desbloquear el Desaf√≠o Final</div>
      </div>
      
      <div style="
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-top: 10px;
      ">
        <button onclick="startHoroscopeChallenge('${categoria}')" style="
          background: linear-gradient(135deg, #9c88ff, #7c3aed);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 6px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(156, 136, 255, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚öîÔ∏è¬°COMENZAR!
        </button>
        
        <button onclick="closeHoroscopeModal()" style="
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 6px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚ùå Cancelar
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  console.log("‚úÖ Modal del hor√≥scopo mostrado exitosamente");
}

// Cerrar modal de desaf√≠o del hor√≥scopo
function closeHoroscopeModal() {
  const modal = document.getElementById('horoscope-modal-active');
  if (modal) {
    modal.remove();
  }
}

// --- Funci√≥n para iniciar desaf√≠o del hor√≥scopo cerrando modal primero ---
function startHoroscopeChallenge(categoria) {
  console.log("üî• CERRANDO MODAL DIRECTAMENTE");
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o hor√≥scopo');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // M√©todo 1: Por ID
  const modalById = document.getElementById('horoscope-modal-active');
  if(modalById) {
    modalById.remove();
    console.log("‚úÖ Modal eliminado por ID");
  }
  
  // M√©todo 2: Por clase (backup)
  const modalByClass = document.querySelector('.horoscope-modal-overlay');
  if(modalByClass) {
    modalByClass.remove();
    console.log("‚úÖ Modal eliminado por clase");
  }
  
  // M√©todo 3: Nuclear - eliminar todos los modals
  const allModals = document.querySelectorAll('[style*="position: fixed"]');
  allModals.forEach(m => {
    if(m.style.zIndex >= 10000) {
      m.remove();
      console.log("üî• Modal eliminado nuclearmente");
    }
  });
  
  console.log("üöÄ Iniciando desaf√≠o:", categoria);
  startDesafioHoroscopo(categoria);
}

// --- Funci√≥n para contar animales desbloqueados ---
function getUnlockedAnimalsCount() {
  return horoscopeAnimalsUnlocked.length;
}

// --- Funci√≥n para verificar si es un desaf√≠o del hor√≥scopo ---
function isHoroscopeChallenge(mission) {
  return mission && (
    mission === 'desafioColores' || mission === 'desafioFruta' || mission === 'desafioVerduras' ||
    mission === 'desafioComidas' || mission === 'desafioAnimales' || mission === 'desafioDeportes' ||
    mission === 'desafioHobbies' || mission === 'desafioRopa' || mission === 'desafioCasa' ||
    mission === 'desafioCuerpo' || mission === 'desafioProfesiones' || mission === 'desafioEmociones'
  );
}

// --- Funci√≥n para obtener categor√≠a desde mission ---
function getHoroscopeCategoryFromMission(mission) {
  const missionToCategory = {
    'desafioColores': 'colores',
    'desafioFruta': 'fruta', 
    'desafioVerduras': 'verduras',
    'desafioComidas': 'comidas',
    'desafioAnimales': 'animales',
    'desafioDeportes': 'deportes',
    'desafioHobbies': 'hobbies',
    'desafioRopa': 'ropa',
    'desafioCasa': 'casa',
    'desafioCuerpo': 'cuerpo',
    'desafioProfesiones': 'profesiones',
    'desafioEmociones': 'emociones'
  };
  return missionToCategory[mission] || null;
}

// --- Funci√≥n para mostrar notificaci√≥n previa de desaf√≠os N ---
function showDesafioNNotification(desafioType, nivelName, recompensa) {
  console.log('üì¢ DEBUG: showDesafioNNotification llamada con:', { desafioType, nivelName, recompensa });
  
  const modal = document.createElement('div');
  console.log('üé≠ DEBUG: Modal creado:', modal);
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: 'Jersey 10', monospace;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
      border: 3px solid #fbbf24;
      padding: 30px;
      text-align: center;
      max-width: 500px;
      margin: 20px;
      box-shadow: 
        0 0 20px rgba(251, 191, 36, 0.5),
        0 0 40px rgba(251, 191, 36, 0.3);
      ">
      
      <div style="color: #e2e8f0; font-size: 18px; line-height: 1.6; margin-bottom: 25px;">
        <p style="margin-bottom: 15px;">
          <strong style="color: #fbbf24;">Objetivo del Desaf√≠o:</strong><br>
          Responder correctamente 20 palabras aleatorias del ${nivelName}
        </p>
        
        <p style="margin-bottom: 15px;">
          <strong style="color: #fbbf24;">Recompensa:</strong><br>
          Desbloquear ${recompensa}
        </p>
        
        <div style="
          background: rgba(239, 68, 68, 0.1);
          border: 2px solid #ef4444;
          border-radius: 8px;
          padding: 15px;
          margin: 15px 0;
        ">
          <p style="color: #fed7d7; font-size: 18px;">
            ‚è±Ô∏è 2 minutos para completar<br>
            ‚ù§Ô∏è 3 vidas<br>
            üö® Si se acaba el tiempo o las vidas, ¬°pierdes el desaf√≠o!
          </p>
        </div>
      </div>
      
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
          background: #6b7280;
          color: white;
          border: none;
          padding: 12px 24px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
        " 
        onmouseover="this.style.background='#4b5563'; this.style.transform='translateY(-1px)'"
        onmouseout="this.style.background='#6b7280'; this.style.transform='translateY(0px)'">
          CANCELAR
        </button>
        
        <button onclick="startDesafioNWithSystem('${desafioType}'); this.parentElement.parentElement.parentElement.remove()" style="
          background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
          color: white;
          border: none;
          padding: 12px 24px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 
            2px 2px 0px rgba(0, 0, 0, 0.3),
            0 0 12px rgba(220, 38, 38, 0.4);
        "
        onmouseover="this.style.transform='translateY(-1px) scale(1.02)'; this.style.boxShadow='3px 3px 0px rgba(0, 0, 0, 0.4), 0 0 16px rgba(255, 200, 0, 0.6)'"
        onmouseout="this.style.transform='translateY(0px) scale(1)'; this.style.boxShadow='2px 2px 0px rgba(0, 0, 0, 0.3), 0 0 12px rgba(220, 38, 38, 0.4)'">
          üöÄ INICIAR DESAF√çO
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// --- Funci√≥n para iniciar desaf√≠o N con sistema de timer y vidas ---
function startDesafioNWithSystem(desafioType) {
  console.log('üöÄ DEBUG: startDesafioNWithSystem llamada con:', desafioType);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // Ocultar cajas de nivel correspondientes
  const levelBoxes = {
    'desafioN1': 'nivel1Box',
    'desafioN2': 'nivel2Box', 
    'desafioN3': 'nivel3Box'
  };
  
  const levelBox = document.getElementById(levelBoxes[desafioType]);
  if (levelBox) levelBox.classList.add('hidden');
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o N');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // Activar sistema de desaf√≠o N
  desafioNActive = true;
  desafioNHearts = 3;
  desafioNTimeLeft = 120; // 2 minutos
  console.log('‚öôÔ∏è DEBUG: Variables de desaf√≠o N configuradas:', { desafioNActive, desafioNHearts, desafioNTimeLeft });
  
  // Iniciar misi√≥n normal
  console.log('üìã DEBUG: Llamando startMission con:', desafioType);
  startMission(desafioType);
  
  // Actualizar statMission para mostrar el tipo de desaf√≠o N
  console.log('üìä DEBUG: Intentando actualizar statMission para:', desafioType);
  const statMission = document.getElementById('statMission');
  console.log('üìä DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const desafioNames = {
      'desafioN1': 'Desaf√≠o N1',
      'desafioN2': 'Desaf√≠o N2', 
      'desafioN3': 'Desaf√≠o N3'
    };
    const newText = desafioNames[desafioType] || 'Desaf√≠o N';
    console.log('üìä DEBUG: Texto anterior:', statMission.textContent);
    console.log('üìä DEBUG: Texto nuevo que se asignar√°:', newText);
    statMission.textContent = newText;
    statMission.style.color = '#f2e5b1';
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '14px';
    console.log('üéØ DEBUG: statMission actualizado exitosamente:', statMission.textContent);
    
    // Verificar que realmente se actualiz√≥
    setTimeout(() => {
      console.log('‚è±Ô∏è DEBUG: Verificaci√≥n posterior - statMission.textContent:', statMission.textContent);
    }, 100);
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission');
  }
  
  // Iniciar timer y vidas del desaf√≠o N
  // Agendar el timer para despu√©s de la precarga si es necesario
  const timerCallback = () => {
    startDesafioNTimer();
    console.log('‚è∞ Timer del desaf√≠o N iniciado despu√©s de preload');
  };
  
  if (preloadingChallenge) {
    console.log('‚è≥ Timer N agendado para despu√©s de precarga');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  showDesafioNHearts();
  
  console.log(`üéØ Desaf√≠o N iniciado: ${desafioType} con timer y vidas`);
  console.log('üîç DEBUG: Estado final - desafioNActive:', desafioNActive, 'hearts:', desafioNHearts, 'timeLeft:', desafioNTimeLeft);
}

// --- Funci√≥n para mostrar modal de animal desbloquseado ---
function showAnimalUnlockedModal(categoria) {
  const animal = horoscopeAnimals[categoria];
  const modal = document.createElement('div');
  modal.className = 'horoscope-modal-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(145deg, #FFD700, #32CD32);
      border-radius: 20px;
      padding: 20px;
      max-width: 90vw;
      max-height: 90vh;
      width: 100%;
      max-width: 500px;
      overflow-y: auto;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    ">
      <div style="margin-bottom: 15px;">
        <h2 style="
          font-size: clamp(18px, 5vw, 24px);
          margin: 0 0 15px 0;
          color: #2F4F2F;
        ">üéÜ ¬°Animal Desbloqueado! üéÜ</h2>
      </div>
      
      <div style="margin-bottom: 20px; display: flex; justify-content: center;">
        <div class="horoscope-modal-image">
          <img src="img/${animal.image}" alt="${animal.name}" style="
            width: clamp(120px, 30vw, 180px);
            height: clamp(120px, 30vw, 180px);
            object-fit: cover;
          ">
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        
        <p style="
          font-size: clamp(16px, 4vw, 20px);
          color: #2F4F2F;
          font-weight: bold;
          margin: 10px 0;
        ">üèÜ ¬°Has derrotado al Desaf√≠o y desbloqueado al ${animal.chinese} ${animal.name}! üèÜ</p>
        
        <p style="
          color: #2F4F2F;
          font-size: clamp(14px, 3.5vw, 16px);
          margin: 8px 0;
        ">El ${animal.name} ha sido agregado a tu colecci√≥n.</p>
        
        <p style="
          color: #2F4F2F;
          font-size: clamp(14px, 3.5vw, 16px);
          margin: 8px 0;
        ">üìä Tienes <span style="font-weight: bold;">${horoscopeAnimalsUnlocked.length}/12</span> animales del hor√≥scopo en tu Colecci√≥n</p>
        
        ${horoscopeAnimalsUnlocked.length === 12 ? `
          <p style="
            color: #FF4500;
            font-weight: bold;
            font-size: clamp(14px, 3.5vw, 16px);
            margin: 12px 0;
          ">üéÜ ¬°COLECCI√ìN COMPLETA! Desaf√≠o Final desbloqueado üéÜ</p>
          
          <button onclick="startUltimateChallenge()" style="
            width: 100%;
            margin-top: 15px;
            padding: clamp(10px, 3vw, 15px);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 3px solid #FF4500;
            border-radius: 12px;
            color: #8B0000;
            font-weight: bold;
            font-size: clamp(14px, 3.5vw, 16px);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(255,69,0,0.3);
            transition: all 0.3s ease;
          ">
            üèÜ DESAF√çO FINAL üèÜ<br>
            <span style="font-size: clamp(10px, 2.5vw, 12px); color: #B8860B;">60 tarjetas ‚Ä¢ Todas las categor√≠as</span>
          </button>
        ` : ''}
      </div>
      
      <button onclick="closeAnimalUnlockedModal()" style="
        width: 100%;
        padding: clamp(12px, 3vw, 16px);
        background: linear-gradient(145deg, #32CD32, #228B22);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: bold;
        font-size: clamp(14px, 4vw, 18px);
        cursor: pointer;
        transition: all 0.3s ease;
      ">‚ú® ¬°Genial!</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Auto-cerrar despu√©s de 8 segundos (m√°s tiempo para m√≥vil)
  setTimeout(() => {
    closeAnimalUnlockedModal();
  }, 8000);
}

// --- Funci√≥n para cerrar modal de animal desbloqueado ---
function closeAnimalUnlockedModal() {
  const modal = document.querySelector('.horoscope-modal-overlay');
  if(modal) modal.remove();
}

// === DESAF√çO N3: MARCAR COMO COMPLETADO ===
async function completarDesafioN3() {
  console.log('üéØ Intentando marcar Desaf√≠o N3 como completado...');
  
  if (!jwtToken) {
    console.error('‚ùå completarDesafioN3: No hay jwtToken');
    return;
  }
  
  if (desafioN3Completed) {
    console.log('‚úÖ Desaf√≠o N3 ya estaba completado anteriormente');
    return;
  }

  try {
    desafioN3Completed = true;
    desafioN3CompletedAt = new Date();
    await saveUserState();

    setTimeout(() => {
      updateAchievements();
      console.log('üèÖ Logros actualizados tras completar Desaf√≠o N3');
    }, 300);
  } catch (error) {
    console.error('‚ùå Error completando Desaf√≠o N3 (localStorage):', error);
  }
}

// --- Funci√≥n para desbloquear animal del hor√≥scopo ---
function unlockHoroscopeAnimal(categoria) {
  console.log(`üîç DEBUG unlockHoroscopeAnimal: categoria=${categoria}`);
  console.log(`üîç DEBUG horoscopeAnimalsUnlocked actual:`, horoscopeAnimalsUnlocked);
  
  if (!categoria || horoscopeAnimalsUnlocked.includes(categoria)) {
    console.log(`‚ùå No se desbloquea: categoria inv√°lida o ya desbloqueado`);
    return; // Ya desbloqueado o categor√≠a inv√°lida
  }
  
  console.log(`üéâ ¬°Animal desbloqueado: ${horoscopeAnimals[categoria].name}!`);
  
  // Agregar a lista de desbloqueados
  horoscopeAnimalsUnlocked.push(categoria);
  console.log(`‚úÖ Agregado a lista. Nueva lista:`, horoscopeAnimalsUnlocked);
  
  // Crear "car√°cter especial" del animal para la tabla de conocidas
  const animalChar = {
    hanzi: horoscopeAnimals[categoria].chinese,
    pinyin: horoscopeAnimals[categoria].name.toLowerCase(),
    meaning: `Animal ${horoscopeAnimals[categoria].name} (Hor√≥scopo)`,
    unit: 'horoscopo',
    cat: 'ANIMAL',
    known: true,
    challengeStreak: 1,
    challengeBest: 1,
    isHoroscopeAnimal: true,
    animalImage: horoscopeAnimals[categoria].image,
    animalCategory: categoria
  };
  
  // Agregar badge al array separado (NO al array principal cards)
  const existsInBadges = horoscopeBadges.some(b => b.hanzi === animalChar.hanzi);
  if (!existsInBadges) {
    horoscopeBadges.push(animalChar);
    console.log(`‚úÖ Badge agregado a horoscopeBadges. Total badges: ${horoscopeBadges.length}`);
  } else {
    console.log(`‚ùå Badge ya existe en horoscopeBadges`);
  }
  
  // Mostrar notificaci√≥n de desbloqueado
  console.log(`üìß Mostrando modal de desbloqueado...`);
  showAnimalUnlockedModal(categoria);
  
  // Guardar progreso en backend
  console.log(`üíæ Guardando progreso con animal desbloqueado...`);
  console.log(`üê≤ horoscopeAnimalsUnlocked antes de saveAll:`, horoscopeAnimalsUnlocked);
  saveAll();
  
  // Actualizar bot√≥n del desaf√≠o final
  updateUltimateChallengeButton();
  
  // Resetear statMission al completar desaf√≠o hor√≥scopo
  const statMission = document.getElementById('statMission');
  if (statMission) {
    statMission.textContent = '‚Äî';
    statMission.style.color = '';
    statMission.style.fontWeight = '';
    statMission.style.fontSize = '';
    console.log('üîÑ statMission reseteado despu√©s del desaf√≠o hor√≥scopo');
  }
}

// --- Funci√≥n para actualizar apariencia del bot√≥n desaf√≠o final ---
function updateUltimateChallengeButton() {
  const btnDesafioFinal = document.getElementById('btnDesafioFinal');
  if (!btnDesafioFinal) return;

  // MODO DOCUMENTAL: siempre desbloqueado
  btnDesafioFinal.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
  btnDesafioFinal.style.opacity = '1';
  btnDesafioFinal.style.cursor = 'pointer';
  btnDesafioFinal.title = 'üèÜ Desaf√≠o Final del Hor√≥scopo - ¬°Desbloqueado!';
}

// --- Funci√≥n para mostrar modal de requerimientos del desaf√≠o final ---
function showUltimateChallengeRequirementModal() {
  // MODO DOCUMENTAL: sin requisitos, no mostrar modal de bloqueo
  return;

  const animalsCount = horoscopeAnimalsUnlocked.length;
  const remaining = 12 - animalsCount;
  
  // Crear modal din√°mico
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-md w-full bg-gradient-to-b from-slate-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl">
      <!-- Header -->
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-orange-900/30">
        <h3 class="text-1xl font-bold text-red-400 jersey-font-coleccion-cards text-center flex items-center justify-center gap-2">
          üîí DESAF√çO BLOQUEADO
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/desafiofinal.webp" alt="Desaf√≠o Final" class="w-48 h-80 object-cover rounded-lg shadow-lg" 
             style="border: 3px solid #FFF8DC; 
                    box-shadow: 
                      0 0 20px rgba(255, 248, 220, 0.7),
                      0 0 40px rgba(255, 235, 150, 0.5),
                      0 0 60px rgba(255, 215, 0, 0.3),
                      inset 0 0 10px rgba(255, 248, 220, 0.2);
                    /* Animaci√≥n removida para mejor rendimiento */
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Estilos CSS para la animaci√≥n -->
      <style>
        /* @keyframes goldenGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
      </style>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        
        <div class="text-gray-300 jersey-font-coleccion-cards">
          Para desbloquear el Desaf√≠o Final necesitas coleccionar los <strong>12 animales del hor√≥scopo</strong>
        </div>
        
        <!-- Progress -->
        <div class="bg-slate-700 rounded-full h-4 overflow-hidden">
          <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-full transition-all duration-500" 
               style="width: ${(animalsCount / 12) * 100}%"></div>
        </div>
        
        <div class="text-lg font-bold jersey-font-coleccion-cards">
          <span class="text-cyan-400">${animalsCount}</span><span class="text-gray-400">/</span><span class="text-yellow-400">12</span> animales
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-gray-600 bg-slate-800/50">
        <button class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all jersey-font-coleccion-cards text-lg" onclick="this.closest('.fixed').remove()">
          ¬°Volver√© m√°s fuerte!
        </button>
      </div>
    </div>
  `;
  
  // Agregar al DOM
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function renderUltimateChallengeCard(card) {
  console.log('=== DEBUG ULTIMATE CHALLENGE ===');
  console.log('üèÜ Renderizando carta Ultimate Challenge:', card);
  console.log('üì± DEBUG - Dispositivo m√≥vil:', isMobile());
  console.log('üì± DEBUG - User agent:', navigator.userAgent);
  console.log('üìä √çndices: cardIndex=' + ultimateChallengeCardIndex + ', animalIndex=' + ultimateChallengeAnimalIndex);
  console.log('üÉã SessionQueue length:', sessionQueue.length);
  
  if (!card) {
    console.error('‚ö†Ô∏è ERROR: No hay carta para renderizar');
    return;
  }
  
  // Actualizar animal actual basado en el √≠ndice
  const currentAnimalData = ultimateChallengeOrder[ultimateChallengeAnimalIndex];
  ultimateChallengeCurrentAnimal = currentAnimalData?.animal || 'Desconocido';
  console.log('üêç Animal actual:', ultimateChallengeCurrentAnimal);
  
  // Actualizar display del modo actual (Ultimate Challenge)
  console.log('üìä Llamando updateUltimateChallengeCounter() desde renderUltimateChallengeCard()');
  updateUltimateChallengeCounter();
  
  // Determinar si mostrar hanzi o pinyin como opciones (aleatorio)
  const showHanziOptions = Math.random() < 0.5;
  console.log(`üé≤ Opciones: ${showHanziOptions ? 'HANZI' : 'PINYIN'}`);
  console.log('üá®üá≥ Pregunta (debe ser espa√±ol):', card.meaning);
  
  // CONFIGURAR MODO: Siempre pregunta en espa√±ol (meaning) con opciones hanzi/pinyin
  if (showHanziOptions) {
    setMode('quizMeaning'); // Pregunta meaning (espa√±ol), opciones ser√°n hanzi
    console.log('üîÑ Modo: quizMeaning con opciones HANZI');
  } else {
    setMode('quizMeaning'); // Pregunta meaning (espa√±ol), opciones ser√°n pinyin  
    console.log('üîÑ Modo: quizMeaning con opciones PINYIN');
  }
  
  // IMPORTANTE: Forzar que la pregunta sea en espa√±ol
  currentCard = {
    ...card,
    forceSpanishQuestion: true,
    ultimateChallengeMode: showHanziOptions ? 'hanzi' : 'pinyin'
  };
  
  console.log('üìù Carta procesada:', currentCard);
  console.log('==============================');
  
  // NO usar renderCard() - llamar directamente setupQuizChoices para evitar conflictos
  // renderCard();
  
  // Configurar directamente
  backEl.textContent = '';
  flashRow.classList.add('hidden');
  
  // Obtener referencia a quizRow
  const quizRow = document.getElementById('quizRow');
  if (!quizRow) {
    console.error('‚ùå ERROR: quizRow no encontrado en DOM');
    return;
  }
  
  quizRow.classList.remove('hidden');
  
  // M√ìVIL: Verificar si existen casillas, crearlas si es necesario
  console.log('üîç DEBUG renderUltimateChallengeCard - isMobile():', isMobile());
  console.log('üîç DEBUG quizRow existe:', !!quizRow);
  
  if (isMobile()) {
    const existingButtons = quizRow.querySelectorAll('.quizOpt');
    console.log('üîç DEBUG casillas existentes:', existingButtons.length);
    
    // Usar setTimeout para asegurar que el DOM est√© listo
    setTimeout(() => {
      if (existingButtons.length === 0) {
        console.log('üì± Ultimate Challenge - Creando casillas para m√≥vil (no existen)');
        createQuizButtonsAfterFlip();
      } else {
        console.log('üì± Ultimate Challenge - Casillas ya existen, configurando contenido');
        
        // Asegurar que las casillas sean visibles en Ultimate Challenge
        existingButtons.forEach(btn => {
          btn.style.opacity = '1';
          btn.style.pointerEvents = 'auto';
        });
        
        setupQuizChoices();
      }
    }, 50);
  } else {
    console.log('üíª Ultimate Challenge - Desktop, llamando setupQuizChoices directamente');
    setupQuizChoices();
  }
}

function handleUltimateChallengeAnswerOLD(isCorrect, buttonClicked) {
  console.log(`üéØ Ultimate Challenge respuesta OLD: ${isCorrect ? 'CORRECTA' : 'INCORRECTA'}`);
  
  // Verificar que buttonClicked existe
  if (!buttonClicked) {
    console.error('‚ùå buttonClicked es null o undefined');
    return;
  }
  
  // Feedback visual
  if (isCorrect) {
    buttonClicked.style.background = 'linear-gradient(145deg, #90EE90, #32CD32)';
    buttonClicked.style.borderColor = '#228B22';
    buttonClicked.style.color = '#006400';
  } else {
    buttonClicked.style.background = 'linear-gradient(145deg, #FFB6C1, #FF69B4)';
    buttonClicked.style.borderColor = '#DC143C';
    buttonClicked.style.color = '#8B0000';
  }
  
  // Desactivar todos los botones
  const allButtons = document.querySelectorAll('#optionsContainer button');
  allButtons.forEach(btn => {
    btn.disabled = true;
    btn.style.cursor = 'not-allowed';
  });
  
  // Procesar respuesta
  if (isCorrect) {
    score++;
    xpPoints++;
  }
  
  totalAnswered++;
  
  // Avanzar al siguiente
  setTimeout(() => {
    ultimateChallengeCardIndex++;
    
    // Verificar si cambiar de animal (cada 5 cartas)
    if (ultimateChallengeCardIndex % 5 === 0) {
      ultimateChallengeAnimalIndex++;
    }
    
    // Verificar si termin√≥ el desaf√≠o
    if (ultimateChallengeCardIndex >= ultimateChallengeCards.length) {
      finishUltimateChallenge();
    } else {
      nextCard();
    }
  }, 1500);
}

async function finishUltimateChallenge() {
  console.log('üèÅ Finalizando Ultimate Challenge');
  console.log('- sessionCorrect:', sessionCorrect);
  console.log('- sessionTotal:', sessionTotal);
  console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
  
  // Usar variables correctas de sesi√≥n
  const totalQuestions = 60;
  const correctAnswers = sessionCorrect;
  const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
  
  console.log(`üìä Resultado final: ${percentage}% (${correctAnswers}/${totalQuestions})`);
  
  // Resetear estado
  ultimateChallengeActive = false;
  ultimateChallengeCards = [];
  ultimateChallengeCurrentAnimal = '';
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeCardIndex = 0;
  ultimateChallengeHearts = 3;
  
  // Ocultar corazones y timer
  hideUltimateChallengeHearts();
  stopUltimateChallengeTimer();
  
  // Mostrar resultado
  if (percentage >= 85) {
    console.log('üéâ ¬°ULTIMATE CHALLENGE COMPLETADO!');
    
    // COMPLETAR ULTIMATE CHALLENGE Y CONVERTIRSE EN MAESTsRO DEL HOR√ìSCOPO
    try {
      await completeUltimateChallenge();
      console.log('üèÜ Ultimate Challenge registrado exitosamente');
    } catch (error) {
      console.error('‚ùå Error registrando Ultimate Challenge:', error);
    }
    
    // Mensaje de √©xito
    showUltimateChallengeSuccess(percentage, correctAnswers, totalQuestions);
  } else {
    // No alcanz√≥ el m√≠nimo
    showUltimateChallengeFailure(percentage, correctAnswers, totalQuestions);
  }
}

// Mostrar mensaje de √©xito Ultimate Challenge
function showUltimateChallengeSuccess(percentage, correct, total) {
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
  overlay.style.backdropFilter = 'blur(5px)';
  
  const messageBox = document.createElement('div');
  messageBox.className = 'bg-gradient-to-br from-yellow-600 to-orange-700 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-yellow-400';
  
  messageBox.innerHTML = `
    <div class="text-6xl mb-4">üèÜ</div>
    <h2 class="text-3xl font-bold mb-4 text-yellow-200">¬°ULTIMATE CHALLENGE COMPLETADO!</h2>
    <div class="text-lg mb-6 leading-relaxed">
      <p class="mb-4">üìä Resultado: <span class="font-bold text-2xl">${percentage}%</span></p>
      <p class="mb-4">‚úÖ Correctas: ${correct}/${total}</p>
      <p class="mb-4">ÔøΩ ¬°Eres un maestro del hor√≥scopo chino!</p>
      <div class="bg-yellow-700 px-4 py-3 rounded-xl text-lg font-bold border border-yellow-400">
        ÔøΩ ${ultimateChallengeCompletedCount === 1 ? 'Maestro del Hor√≥scopo desbloqueado' : `Ultimate Challenge completado ${ultimateChallengeCompletedCount} veces`}
      </div>
    </div>
    <button class="bg-yellow-600 hover:bg-yellow-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors w-full">
      ¬°Continuar!
    </button>
  `;
  
  const continueBtn = messageBox.querySelector('button');
  continueBtn.onclick = () => {
    overlay.remove(); 
    exitUltimateChallenge();
  };
  
  overlay.appendChild(messageBox);
  document.body.appendChild(overlay);
  
  // Confetti especial
  setTimeout(() => showConfetti(), 500);
}

// Mostrar mensaje de fallo Ultimate Challenge
function showUltimateChallengeFailure(percentage, correct, total) {
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
  overlay.style.backdropFilter = 'blur(5px)';
  
  const messageBox = document.createElement('div');
  messageBox.className = 'bg-gradient-to-br from-red-700 to-red-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-500';
  
  messageBox.innerHTML = `
    <div class="text-6xl mb-4">üòî</div>
    <h2 class="text-3xl font-bold mb-4 text-red-200">Casi lo logras</h2>
    <div class="text-lg mb-6 leading-relaxed">
      <p class="mb-4">üìä Resultado: <span class="font-bold text-2xl">${percentage}%</span></p>
      <p class="mb-4">‚úÖ Correctas: ${correct}/${total}</p>
      <p class="mb-4">üéØ Necesitas 85% o m√°s</p>
      <p class="text-red-300">üí™ ¬°Int√©ntalo de nuevo!</p>
    </div>
    <button class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors w-full">
      Reintentar
    </button>
  `;
  
  const continueBtn = messageBox.querySelector('button');
  continueBtn.onclick = () => {
    overlay.remove();
    exitUltimateChallenge();
  };
  
  overlay.appendChild(messageBox);
  document.body.appendChild(overlay);
}

// --- DESAF√çO FINAL DEL HOR√ìSCOPO ---
// Mostrar modal informativo antes del Ultimate Challenge
function showUltimateChallengeInfo() {
  const modal = document.createElement('div');
  modal.id = 'ultimateChallengeInfoModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #9c88ff;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(156, 136, 255, 0.3);
      position: relative;
    ">

      
      <h2 style="
        color: #9c88ff;
        font-family: 'Jersey 10', monospace;
        font-size: 28px;
        margin: 5px 0;
        text-shadow: 2px 2px 0px #4c1d95;
      ">‚öîÔ∏è DESAF√çO FINAL ‚öîÔ∏è</h2>
      
      <!-- Imagen de portada con glow dorado -->
      <div style="display: flex; justify-content: center; margin: 15px 0;">
        <img src="img/desafiofinal.webp" alt="Desaf√≠o Final" 
             style="width: 192px; 
                    height: 320px; 
                    object-fit: cover; 
                    border-radius: 8px;
                    border: 3px solid #FFF8DC; 
                    box-shadow: 
                      0 0 20px rgba(255, 248, 220, 0.7),
                      0 0 40px rgba(255, 235, 150, 0.5),
                      0 0 60px rgba(255, 215, 0, 0.3),
                      inset 0 0 10px rgba(255, 248, 220, 0.2);
                    /* Animaci√≥n removida para mejor rendimiento */
                    transform: scale(1) translateZ(0);
                    opacity: 1;" 
             onerror="this.style.display='none'">
      </div>
      
      <!-- Estilos CSS para la animaci√≥n del modal de instrucciones -->
      <style>
        /* @keyframes instructionsGoldenGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
      </style>
      
      <h3 style="
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 28px;
        margin: 0px 0;
        text-shadow: 1px 1px 0px #000000;
      ">MAESTRO DEL HOR√ìSCOPO</h3>
      
      <div style="
        background: rgba(156, 136, 255, 0.1);
        border: 2px solid #9c88ff;
        border-radius: 6px;
        padding: 10px 20px;
        margin: 5px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.3;
        text-align: left;
      ">
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #FFD700;">‚è±Ô∏è Tiempo:</span> 500 segundos</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #87ceeb;">üí° 60 Preguntas:</span> 5 de cada animal</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ff6b6b;">‚ù§Ô∏è Vidas:</span> Solo 3 oportunidades</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ffa500;">‚ö° Penalizaci√≥n:</span> PIERDES 3 caracteres de tu Colecci√≥n al AZAR</div>
      </div>
      
      <div style="
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-top: 15px;
      ">
        <button onclick="actualStartUltimateChallenge()" style="
          background: linear-gradient(135deg, #9c88ff, #7c3aed);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-family: 'Jersey 10', monospace;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(156, 136, 255, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚öîÔ∏è¬°EMPEZAR!
        </button>
        
        <button onclick="closeUltimateChallengeInfo()" style="
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-family: 'Jersey 10', monospace;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚ùå Tengo Miedo
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  
  console.log("‚úÖ Modal del Ultimate Challenge mostrado exitosamente");
}

// Cerrar modal de informaci√≥n del Ultimate Challenge
function closeUltimateChallengeInfo() {
  const modal = document.getElementById('ultimateChallengeInfoModal');
  if (modal) {
    modal.remove();
  }
}

// Mostrar mensaje de que el hor√≥scopo est√° bloqueado
function showHoroscopeLockedMessage() {
  // MODO DOCUMENTAL: sin requisitos, no mostrar modal de bloqueo
  return;

  const modal = document.createElement('div');
  modal.id = 'horoscopeLockedModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
      position: relative;
    ">
      <div style="
        font-size: 60px;
        margin-bottom: 10px;
      ">üîí</div>
      
      <h2 style="
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 10px 0;
        text-shadow: 2px 2px 0px #8b0000;
      ">LOS 12 DESAF√çOS DEL HOR√ìSCOPO BLOQUEADO</h2>
      
      <div style="
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid #ff6b6b;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.6;
        text-align: left;
      ">
        <div style="margin-bottom: 15px;">
          <strong style="color: #ff6b6b;">üìã REQUISITOS:</strong>
        </div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #FFD700;">‚úÖ Completar Nivel 2</span> - Termina el desaf√≠o N2</div>
        <div style="margin: 15px 0 8px 0;">
          <strong style="color: #ff6b6b;">üéØ DESPU√âS PODR√ÅS:</strong>
        </div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #ffc853;">üê≤ Acceder a las 12 Unidades Nuevas del hor√≥scopo</span></div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #9c88ff;">‚öîÔ∏è Jugar los Desaf√≠os del Hor√≥scopo</span></div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #FFD700;">üèÜ Intentar el Desaf√≠o Final</span></div>
      </div>
      
      <button onclick="closeHoroscopeLockedMessage()" style="
        background: linear-gradient(135deg, #ff6b6b, #e55a5a);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        margin-top: 10px;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        ENTENDIDO
      </button>
    </div>
  `;

  document.body.appendChild(modal);
}

// Cerrar modal de hor√≥scopo bloqueado
function closeHoroscopeLockedMessage() {
  const modal = document.getElementById('horoscopeLockedModal');
  if (modal) {
    modal.remove();
  }
}

// Mostrar mensaje de que el hor√≥scopo est√° bloqueado
function showHoroscopeLockedMessage() {
  // MODO DOCUMENTAL: sin requisitos, no mostrar modal de bloqueo
  return;

  const modal = document.createElement('div');
  modal.id = 'horoscopeLockedModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
      position: relative;
    ">
      <div style="
        font-size: 60px;
        margin-bottom: 20px;
      ">üîí</div>
      
      <h2 style="
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 15px 0;
        text-shadow: 2px 2px 0px #8b0000;
      ">HOR√ìSCOPO BLOQUEADO</h2>
      
      <div style="
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid #ff6b6b;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 20px;
        line-height: 1.6;
        text-align: left;
      ">
        <div style="margin-bottom: 15px;">
          <strong style="color: #ff6b6b;">üìã REQUISITOS:</strong>
        </div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #FFD700;">‚úÖ Completar Nivel 2</span> - Termina el desaf√≠o N2</div>
        <div style="margin: 15px 0 8px 0;">
          <strong style="color: #ff6b6b;">üéØ DESPU√âS PODR√ÅS:</strong>
        </div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #ffc853;">üê≤ Acceder a los 12 Animales del Hor√≥scopo</span></div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #9c88ff;">‚öîÔ∏è Hacer los Desaf√≠os del Hor√≥scopo</span></div>
        <div style="margin: 8px 0;">‚Ä¢ <span style="color: #FFD700;">üèÜ Hacer el Desaf√≠o Final</span></div>
      </div>
      
      <button onclick="closeHoroscopeLockedMessage()" style="
        background: linear-gradient(135deg, #ff6b6b, #e55a5a);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        margin-top: 15px;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        üîô ENTENDIDO
      </button>
    </div>
  `;

  document.body.appendChild(modal);
}

// Cerrar modal de hor√≥scopo bloqueado
function closeHoroscopeLockedMessage() {
  const modal = document.getElementById('horoscopeLockedModal');
  if (modal) {
    modal.remove();
  }
}

// Nueva funci√≥n que muestra el modal informativo
function startUltimateChallenge() {
  showUltimateChallengeInfo();
}

async function actualStartUltimateChallenge() {
  console.log('üèÜ Iniciando Desaf√≠o Final del Hor√≥scopo');
  
  // Cerrar modal del Ultimate Challenge
  closeUltimateChallengeInfo();
  
  // MODO DOCUMENTAL: sin requisitos (siempre disponible)
  
  // Preparar las 60 cartas (5 de cada categor√≠a en orden fijo)
  ultimateChallengeCards = [];
  
  for (const item of ultimateChallengeOrder) {
    const categoryCards = cards.filter(c => c.unit === item.categoria);
    
    if (categoryCards.length < 5) {
      console.warn(`‚ö†Ô∏è Categor√≠a ${item.categoria} tiene menos de 5 cartas (${categoryCards.length})`);
    }
    
    // Seleccionar 5 cartas al azar de esta categor√≠a
    const shuffled = categoryCards.sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, Math.min(5, categoryCards.length));
    
    // Agregar metadata del animal actual
    selected.forEach(card => {
      ultimateChallengeCards.push({
        ...card,
        currentAnimal: item.animal,
        currentCategory: item.categoria
      });
    });
  }
  
  console.log(`üéØ Desaf√≠o Final preparado: ${ultimateChallengeCards.length} cartas`);
  
  // Configurar variables de estado
  ultimateChallengeActive = true;
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeCardIndex = 0;
  ultimateChallengeCurrentAnimal = ultimateChallengeOrder[0].animal;
  
  // Configurar estado del desaf√≠o final
  ultimateChallengeActive = true;
  currentMission = 'ultimateChallenge';
  ultimateChallengeCardIndex = 0;
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeHearts = 3; // Reiniciar vidas a 3
  todayReviewed = 0;
  sessionTotal = ultimateChallengeCards.length;
  sessionCorrect = 0;
  
  // IMPORTANTE: Ocultar botones de quiz para Ultimate Challenge
  updateQuizButtonsVisibility('ultimateChallenge');
  
  // DEBUG: Estado inicial
  console.log('üîç DEBUG Estado inicial Ultimate Challenge:');
  console.log('- ultimateChallengeActive:', ultimateChallengeActive);
  console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
  console.log('- ultimateChallengeAnimalIndex:', ultimateChallengeAnimalIndex);
  console.log('- currentMission:', currentMission);
  console.log('- Element statMission exists:', !!document.getElementById('statMission'));
  
  // IMPORTANTE: Configurar sessionQueue para que el sistema de quiz funcione
  sessionQueue = [...ultimateChallengeCards]; // Copia las cartas del Ultimate Challenge
  console.log(`üéØ SessionQueue configurado con ${sessionQueue.length} cartas para Ultimate Challenge`);
  
  // Aplicar tema visual de desaf√≠o (como en desaf√≠os hor√≥scopo)
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  
  // Precargar video de fondo y reproducir m√∫sica de desaf√≠o
  await createChallengeVideoWithPreload('ultimateChallenge', () => {
    // Iniciar timer solo despu√©s de que el video est√© listo
    showUltimateChallengeHearts();
    startUltimateChallengeTimer();
    
    // Empezar con la primera carta
    nextCard();
    updateStats();
  });
  
  // playDesafioMusic('ultimateChallenge'); // ‚ú® MOVIDO AL COUNTDOWN
  
  // El modo se configurar√° autom√°ticamente en renderUltimateChallengeCard()
}

// --- Funciones para el sistema de vidas del Ultimate Challenge ---
function showUltimateChallengeHearts() {
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'ultimateHeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas agregado al DOM');
  }
  
  updateUltimateChallengeHearts();
}

function updateUltimateChallengeHearts() {
  const heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < ultimateChallengeHearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideUltimateChallengeHearts() {
  const heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
  }
}

// === FUNCIONES DEL TIMER DEL ULTIMATE CHALLENGE ===

// Mostrar timer del Ultimate Challenge
function showUltimateChallengeTimer() {
  // Remover timer anterior si existe
  hideUltimateChallengeTimer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'ultimateChallengeTimer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateUltimateChallengeTimer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer del Ultimate Challenge mostrado');
}

// Actualizar display del timer
function updateUltimateChallengeTimer() {
  const timerDisplay = document.getElementById('ultimateChallengeTimer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(ultimateChallengeTimer / 60);
  const seconds = ultimateChallengeTimer % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Usar contenido con ancho fijo
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animation = '';
  
  if (ultimateChallengeTimer <= 60) {
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animation = 'animation: pulse 1s infinite;';
  } else if (ultimateChallengeTimer <= 120) {
    icon = '‚ö†';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
  }
  
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = ultimateChallengeTimer <= 60 ? 'pulse 1s infinite' : '';
  timerDisplay.innerHTML = `<span style="color: #FFD700; text-shadow: 1px 1px 0px #b8860b; font-family: 'Jersey 10', monospace; ${animation}">${icon} ${timeString}</span>`;
}

// Ocultar timer del Ultimate Challenge
function hideUltimateChallengeTimer() {
  const timerDisplay = document.getElementById('ultimateChallengeTimer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('‚è∞ Timer del Ultimate Challenge ocultado');
  }
}

// Iniciar countdown del timer
function startUltimateChallengeTimer() {
  // Limpiar timer anterior si existe
  if (ultimateChallengeTimerInterval) {
    clearInterval(ultimateChallengeTimerInterval);
  }
  
  ultimateChallengeTimer = 500; // Reiniciar a 500 segundos
  showUltimateChallengeTimer();
  
  ultimateChallengeTimerInterval = setInterval(() => {
    ultimateChallengeTimer--;
    updateUltimateChallengeTimer();
    
    // Si se acaba el tiempo, el jugador pierde
    if (ultimateChallengeTimer <= 0) {
      clearInterval(ultimateChallengeTimerInterval);
      hideUltimateChallengeTimer();
      hideUltimateChallengeHearts();
      showUltimateChallengeTimeUp();
    }
  }, 1000);
  
  console.log('‚è∞ Timer del Ultimate Challenge iniciado (500 segundos)');
}

// Detener timer del Ultimate Challenge
function stopUltimateChallengeTimer() {
  if (ultimateChallengeTimerInterval) {
    clearInterval(ultimateChallengeTimerInterval);
    ultimateChallengeTimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer del Ultimate Challenge detenido');
  }
  hideUltimateChallengeTimer();
}

// === SISTEMA DE NOTIFICACIONES POST-DESAF√çO ===

// Capturar estado inicial del desaf√≠o (EXCLUIR badges del hor√≥scopo)
function capturePreChallengeState() {
  challengeStartState = cards.filter(c => 
    c.known && 
    !c.isHoroscopeAnimal && 
    c.unit !== 'horoscopo'
  ).map(card => ({
    id: card.id,
    hanzi: card.hanzi,
    pinyin: card.pinyin,
    meaning: card.meaning,
    challengeStreak: card.challengeStreak || 0,
    known: card.known
  }));
  console.log('üì∑ Estado pre-desaf√≠o capturado:', challengeStartState.length, 'cartas conocidas (sin badges hor√≥scopo)');
}

// Capturar estado final y mostrar notificaci√≥n (EXCLUIR badges del hor√≥scopo)
function capturePostChallengeState() {
  challengeEndState = cards.filter(c => 
    c.known && 
    !c.isHoroscopeAnimal && 
    c.unit !== 'horoscopo'
  ).map(card => ({
    id: card.id,
    hanzi: card.hanzi,
    pinyin: card.pinyin,
    meaning: card.meaning,
    challengeStreak: card.challengeStreak || 0,
    known: card.known
  }));
  
  const changes = analyzeChallengeChanges();
  
  // Modal especial para Desaf√≠o N3
  if (currentMission === 'desafioN3') {
    showDesafioN3CompleteModal(changes);
  } else if (changes.levelsUp.length > 0 || changes.lost.length > 0) {
    showChallengeChangesNotification(changes);
  }
}

// Analizar cambios entre estado inicial y final
function analyzeChallengeChanges() {
  const startMap = new Map();
  challengeStartState.forEach(card => {
    startMap.set(card.id, card);
  });
  
  const endMap = new Map();
  challengeEndState.forEach(card => {
    endMap.set(card.id, card);
  });
  
  const changes = {
    levelsUp: [],
    lost: []
  };
  
  // Detectar subidas de nivel (EXCLUIR animales del hor√≥scopo)
  challengeEndState.forEach(endCard => {
    const startCard = startMap.get(endCard.id);
    if (startCard && endCard.challengeStreak > startCard.challengeStreak) {
      // Buscar la tarjeta completa - mejorar b√∫squeda para IDs undefined
      let fullCard;
      if (endCard.id && endCard.id !== 'undefined') {
        // B√∫squeda normal por ID
        fullCard = cards.find(card => card.id === endCard.id);
      } else {
        // Para badges del hor√≥scopo sin ID v√°lido, buscar por hanzi Y unit
        fullCard = cards.find(card => 
          card.hanzi === endCard.hanzi && 
          (card.unit === 'horoscopo' || card.isHoroscopeAnimal === true)
        );
      }
      
      console.log(`üîç DEBUG Changes Level Up: ${endCard.hanzi} (ID: ${endCard.id})`);
      console.log(`   - Streak inicial: ${startCard.challengeStreak}, Streak final: ${endCard.challengeStreak}`);
      console.log(`   - Tarjeta encontrada:`, fullCard ? {
        hanzi: fullCard.hanzi, 
        unit: fullCard.unit,
        isHoroscopeAnimal: fullCard.isHoroscopeAnimal,
        meaning: fullCard.meaning?.slice(0, 30) + '...'
      } : 'NO ENCONTRADA');
      
      // Solo permitir level up si:
      // 1. La tarjeta existe
      // 2. NO es animal del hor√≥scopo 
      // 3. NO tiene unit 'horoscopo' (badges del hor√≥scopo)
      if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
        const levelsGained = endCard.challengeStreak - startCard.challengeStreak;
        console.log(`‚úÖ Changes Level Up confirmado para: ${endCard.hanzi} (${fullCard.unit}) - Gan√≥ ${levelsGained} niveles`);
        changes.levelsUp.push({
          ...endCard,
          levelsGained: levelsGained,
          oldLevel: startCard.challengeStreak,
          newLevel: endCard.challengeStreak
        });
      } else {
        console.log(`üö´ Changes Excluido: ${endCard.hanzi} - Motivo:`, 
          !fullCard ? 'No encontrada' :
          fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
          fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
      }
    }
  });
  
  // Detectar cartas perdidas (que estaban en start pero no en end) - EXCLUIR animales del hor√≥scopo
  challengeStartState.forEach(startCard => {
    if (!endMap.has(startCard.id)) {
      // Verificar si es animal del hor√≥scopo antes de agregar como perdida - mejorar b√∫squeda para IDs undefined
      let fullCard;
      if (startCard.id && startCard.id !== 'undefined') {
        fullCard = cards.find(card => card.id === startCard.id);
      } else {
        fullCard = cards.find(card => 
          card.hanzi === startCard.hanzi && 
          (card.unit === 'horoscopo' || card.isHoroscopeAnimal === true)
        );
      }
      
      console.log(`üîç DEBUG Changes Lost: ${startCard.hanzi} (ID: ${startCard.id})`);
      
      // Solo agregar como perdida si NO es animal del hor√≥scopo
      if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
        console.log(`üíî Changes Lost confirmado para: ${startCard.hanzi} (${fullCard.unit})`);
        changes.lost.push(startCard);
      } else {
        console.log(`üö´ Changes Lost excluido: ${startCard.hanzi} - Motivo:`, 
          !fullCard ? 'No encontrada' :
          fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
          fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
      }
    }
  });
  
  return changes;
}

// Mostrar notificaci√≥n de cambios
// Modal especial estilo pixel art para Desaf√≠o N3
function showDesafioN3CompleteModal(changes) {
  const modal = document.createElement('div');
  modal.className = 'desafio-n3-complete-overlay';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    font-family: 'Jersey 10', monospace;
  `;
  
  const percent = sessionTotal > 0 ? Math.round((sessionCorrect / sessionTotal) * 100) : 0;
  const isApproved = percent >= 85;
  
  let content = `
    <div style="
      background: linear-gradient(145deg, #2d3748, #1a202c);
      border: 4px solid ${isApproved ? '#48bb78' : '#f56565'};
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      text-align: center;
      color: white;
      box-shadow: 
        0 0 30px ${isApproved ? 'rgba(72, 187, 120, 0.5)' : 'rgba(245, 101, 101, 0.5)'},
        inset 0 2px 4px rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    ">
      
      <!-- Decoraci√≥n pixel art -->
      <div style="
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        height: 8px;
        background: repeating-linear-gradient(
          90deg,
          ${isApproved ? '#48bb78' : '#f56565'} 0px,
          ${isApproved ? '#48bb78' : '#f56565'} 4px,
          transparent 4px,
          transparent 8px
        );
      "></div>
      
      <!-- T√≠tulo principal -->
      <div style="
        font-size: 3rem;
        margin-bottom: 1rem;
        text-shadow: 3px 3px 0px #000000;
        color: ${isApproved ? '#48bb78' : '#f56565'};
      ">${isApproved ? 'üéØ' : 'üíî'}</div>
      
      <h2 style="
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 0px #000000;
        color: #f7fafc;
      ">${isApproved ? '¬°DESAF√çO N3 COMPLETADO!' : 'DESAF√çO N3 FALLIDO'}</h2>
      
      <!-- Estad√≠sticas -->
      <div style="
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      ">
        <div style="font-size: 2rem; color: ${isApproved ? '#48bb78' : '#f56565'}; margin-bottom: 0.5rem;">
          ${sessionCorrect}/${sessionTotal} correctas
        </div>
        <div style="font-size: 1.5rem; color: #a0aec0;">
          ${percent}% de aciertos
        </div>
        ${isApproved ? '<div style="font-size: 1rem; color: #48bb78; margin-top: 0.5rem;">¬°Logro desbloqueado! üèÜ</div>' : '<div style="font-size: 1rem; color: #f56565; margin-top: 0.5rem;">Necesitas 85% para aprobar</div>'}
      </div>
  `;
  
  // Mostrar cambios si los hay
  if (changes.levelsUp.length > 0) {
    content += `
      <div style="
        background: rgba(72, 187, 120, 0.1);
        border: 2px solid #48bb78;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: left;
      ">
        <h3 style="color: #48bb78; margin-bottom: 0.5rem; font-size: 1.2rem;">üéâ Mejoras conseguidas:</h3>
        <div style="max-height: 120px; overflow-y: auto;">
    `;
    
    changes.levelsUp.slice(0, 6).forEach(card => {
      content += `
        <div style="
          background: rgba(0, 0, 0, 0.2);
          padding: 0.5rem;
          margin-bottom: 0.3rem;
          border-radius: 4px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span style="color: white; font-size: 0.9rem;">
            ${card.hanzi} (${card.pinyin})
          </span>
          <span style="color: #48bb78; font-weight: bold;">
            +${card.levelsGained} üìà
          </span>
        </div>
      `;
    });
    
    if (changes.levelsUp.length > 6) {
      content += `<div style="color: #a0aec0; text-align: center; font-size: 0.8rem;">+${changes.levelsUp.length - 6} m√°s...</div>`;
    }
    
    content += `</div></div>`;
  }
  
  // Bot√≥n de cerrar
  content += `
      <button onclick="this.parentElement.parentElement.remove()" style="
        background: linear-gradient(145deg, #4299e1, #3182ce);
        border: 3px solid #2d3748;
        border-radius: 8px;
        color: white;
        font-family: 'Jersey 10', monospace;
        font-size: 1.2rem;
        padding: 0.8rem 2rem;
        cursor: pointer;
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.3),
          inset 0 2px 4px rgba(255, 255, 255, 0.2);
        text-shadow: 1px 1px 0px #000000;
        transition: transform 0.1s;
      " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
        ¬°ENTENDIDO! üéÆ
      </button>
      
      <!-- Decoraci√≥n inferior -->
      <div style="
        position: absolute;
        bottom: -2px;
        left: -2px;
        right: -2px;
        height: 8px;
        background: repeating-linear-gradient(
          90deg,
          ${isApproved ? '#48bb78' : '#f56565'} 0px,
          ${isApproved ? '#48bb78' : '#f56565'} 4px,
          transparent 4px,
          transparent 8px
        );
      "></div>
    </div>
  `;
  
  modal.innerHTML = content;
  document.body.appendChild(modal);
  
  // Efecto de entrada con animaci√≥n
  modal.style.opacity = '0';
  modal.style.transform = 'scale(0.8)';
  setTimeout(() => {
    modal.style.transition = 'all 0.3s ease-out';
    modal.style.opacity = '1';
    modal.style.transform = 'scale(1)';
  }, 10);
}

function showChallengeChangesNotification(changes) {
  const modal = document.createElement('div');
  modal.className = 'challenge-changes-overlay';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  `;
  
  let content = `
    <div class="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-4 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border-2 border-slate-600">
      <div class="text-3xl text-center mb-3">üìä</div>
      <h2 class="text-xl font-bold mb-4 text-center text-blue-300">Resultados del Desaf√≠o</h2>
  `;
  
  // Mostrar subidas de nivel
  if (changes.levelsUp.length > 0) {
    content += `
      <div class="mb-4">
        <h3 class="text-base font-semibold mb-3 text-green-400">üéâ Mejoras de tu Colecci√≥n:</h3>
        <div class="grid grid-cols-3 gap-3">
    `;
    
    changes.levelsUp.forEach(card => {
      content += `
        <div class="bg-green-900/30 p-2 rounded-lg border border-green-600/30">
          <div class="font-bold text-sm">${card.hanzi} (${card.pinyin})</div>
          <div class="text-xs text-gray-300 truncate" title="${card.meaning}">${card.meaning}</div>
          <div class="text-green-400 font-semibold text-xs mt-1">
            ${card.oldLevel} ‚Üí ${card.newLevel} (+${card.levelsGained})
          </div>
        </div>
      `;
    });
    
    content += `</div></div>`;
  }
  
  // Mostrar cartas perdidas
  if (changes.lost.length > 0) {
    content += `
      <div class="mb-4">
        <h3 class="text-base font-semibold mb-3 text-red-400">üòî Has perdido a:</h3>
        <div class="grid grid-cols-3 gap-3">
    `;
    
    changes.lost.forEach(card => {
      content += `
        <div class="bg-red-900/30 p-2 rounded-lg border border-red-600/30">
          <div class="font-bold text-sm">${card.hanzi} (${card.pinyin})</div>
          <div class="text-xs text-gray-300 truncate" title="${card.meaning}">${card.meaning}</div>
          <div class="text-red-400 font-semibold text-xs mt-1">
            Era nivel ${card.challengeStreak}
          </div>
        </div>
      `;
    });
    
    content += `</div></div>`;
  }
  
  content += `
      <button id="closeChangesNotification" class="w-full bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl font-bold text-base transition-colors mt-4">
        ¬°Entendido!
      </button>
    </div>
  `;
  
  modal.innerHTML = content;
  
  // Evento para cerrar
  modal.querySelector('#closeChangesNotification').onclick = () => {
    modal.remove();
  };
  
  // Tambi√©n cerrar al hacer clic fuera
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  document.body.appendChild(modal);
  
  // üéµ Reproducir sonido satisfactorio
  createChallengeResultsSound();
  
  // ‚ú® Aplicar fade in animado
  modal.style.opacity = '0';
  modal.style.transform = 'scale(0.9)';
  modal.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
  
  // Trigger del fade in despu√©s de un frame
  requestAnimationFrame(() => {
    modal.style.opacity = '1';
    modal.style.transform = 'scale(1)';
  });
  
  console.log('üìä Notificaci√≥n de cambios mostrada:', {
    levelsUp: changes.levelsUp.length,
    lost: changes.lost.length
  });
}

// Modal de tiempo agotado
function showUltimateChallengeTimeUp() {
  console.log('‚è∞ TIEMPO AGOTADO - Ultimate Challenge');
  
  const modal = document.createElement('div');
  modal.className = 'ultimate-timeup-overlay';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  `;
  
  modal.innerHTML = `
    <div class="bg-gradient-to-br from-red-900 to-red-700 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-500">
      <div class="text-6xl mb-4">‚è∞</div>
      <h2 class="text-3xl font-bold mb-4 text-red-200">¬°Tiempo Agotado!</h2>
      <div class="text-lg mb-6 leading-relaxed">
        <p class="mb-4">Se acabaron los 8 minutos y 20 segundos</p>
        <p class="mb-4">El Ultimate Challenge ha terminado</p>
        <p class="mb-4 text-red-300">üíÄ Necesitas m√°s velocidad para ser el maestro</p>
      </div>
      <div class="flex gap-3">
        <button id="retryUltimateChallenge" class="flex-1 bg-orange-600 hover:bg-orange-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors">
          üîÑ Reintentar
        </button>
        <button id="exitUltimateChallenge" class="flex-1 bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors">
          üö™ Salir
        </button>
      </div>
    </div>
  `;
  
  // Eventos de botones
  modal.querySelector('#retryUltimateChallenge').onclick = () => {
    modal.remove();
    actualStartUltimateChallenge(); // Reiniciar el desaf√≠o directamente
  };
  
  modal.querySelector('#exitUltimateChallenge').onclick = () => {
    modal.remove();
    exitUltimateChallenge();
  };
  
  document.body.appendChild(modal);
}

function showUltimateChallengeGameOver() {
  // Ocultar corazones y timer
  hideUltimateChallengeHearts();
  stopUltimateChallengeTimer();
  
  // Crear modal de Game Over
  const modal = document.createElement('div');
  modal.className = 'ultimate-gameover-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(145deg, #8B0000, #DC143C);
      border-radius: 20px;
      padding: 30px;
      max-width: 90vw;
      width: 100%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      border: 3px solid #FF4500;
    ">
      <div style="margin-bottom: 20px;">
        <h2 style="
          font-size: clamp(24px, 6vw, 32px);
          margin: 0 0 15px 0;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        ">üíÄ GAME OVER üíÄ</h2>
      </div>
      
      <div style="font-size: clamp(60px, 15vw, 80px); margin: 20px 0;">üíî</div>
      
      <p style="
        font-size: clamp(18px, 4.5vw, 22px);
        color: #FFD700;
        font-weight: bold;
        margin: 15px 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      ">¬°Has perdido todas tus vidas!</p>
      
      <p style="
        color: #FFF;
        font-size: clamp(16px, 4vw, 18px);
        margin: 15px 0;
        line-height: 1.4;
      ">El Ultimate Challenge es implacable.<br>Pierdes caracteres con cada error.</p>
      
      <p style="
        color: #FFD700;
        font-size: clamp(14px, 3.5vw, 16px);
        margin: 20px 0;
        font-weight: bold;
      ">üí° ¬°Puedes intentarlo de nuevo con 3 vidas renovadas!</p>
      
      <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button onclick="exitUltimateChallenge()" style="
          padding: 15px 25px;
          border: none;
          border-radius: 10px;
          background: linear-gradient(145deg, #666, #888);
          color: white;
          font-size: clamp(14px, 3.5vw, 16px);
          font-weight: bold;
          cursor: pointer;
          border: 2px solid #444;
        ">‚ùå Salir</button>
        
        <button onclick="restartUltimateChallenge()" style="
          padding: 15px 25px;
          border: none;
          border-radius: 10px;
          background: linear-gradient(145deg, #228B22, #32CD32);
          color: white;
          font-size: clamp(14px, 3.5vw, 16px);
          font-weight: bold;
          cursor: pointer;
          border: 2px solid #006400;
        ">üîÑ Reintentar</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function exitUltimateChallenge() {
  // Limpiar estado del Ultimate Challenge
  ultimateChallengeActive = false;
  ultimateChallengeCards = [];
  ultimateChallengeHearts = 3;
  currentMission = 'known';
  
  // Actualizar visibilidad de botones de quiz al salir
  updateQuizButtonsVisibility('known');
  
  // Limpiar temas visuales
  clearAllChallengeThemes();
  stopDesafioMusic();
  
  // Ocultar corazones
  hideUltimateChallengeHearts();
  
  // Cerrar modal
  const modal = document.querySelector('.ultimate-gameover-overlay');
  if (modal) modal.remove();
  
  // Mostrar tabla conocidas
  overlayField = 'hanzi';
  showKnownTableWithAnimations();
  
  console.log('‚ùå Ultimate Challenge terminado - Usuario sali√≥');
}

function restartUltimateChallenge() {
  // Cerrar modal
  const modal = document.querySelector('.ultimate-gameover-overlay');
  if (modal) modal.remove();
  
  // Reiniciar Ultimate Challenge directamente (sin modal de informaci√≥n)
  console.log('üîÑ Reiniciando Ultimate Challenge');
  actualStartUltimateChallenge();
}

function getUltimateChallengeOptions(correctCard) {
  // Pool completo de palabras del hor√≥scopo para opciones incorrectas
  const horoscopeCategories = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
  const horoscopePool = cards.filter(c => horoscopeCategories.includes(c.unit));
  
  // Decidir aleatoriamente si mostrar hanzi o pinyin como opciones
  const showHanzi = Math.random() < 0.5;
  
  console.log(`üé≤ Ultimate Challenge: Mostrando ${showHanzi ? 'HANZI' : 'PINYIN'} como opciones`);
  console.log(`üèÜ Ultimate Challenge: Aplicando sistema inteligente para ${correctCard.hanzi} (${correctCard.pinyin})`);
  
  // üéØ APLICAR SISTEMA INTELIGENTE DE OPCIONES
  const smartOptions = generateSmartOptions(correctCard, horoscopePool, true);
  
  // Obtener opciones incorrectas usando el sistema inteligente
  const incorrectOptions = smartOptions
    .slice(0, 3)
    .map(opt => showHanzi ? opt.hanzi : opt.pinyin);
  
  // Opci√≥n correcta
  const correctOption = showHanzi ? correctCard.hanzi : correctCard.pinyin;
  
  // Combinar y mezclar
  const allOptions = [correctOption, ...incorrectOptions].sort(() => 0.5 - Math.random());
  
  console.log(`üéØ Ultimate Challenge - Opciones inteligentes generadas:`, allOptions);
  
  return {
    options: allOptions,
    correctAnswer: correctOption,
    questionType: showHanzi ? 'hanzi' : 'pinyin'
  };
}

// --- Funci√≥n para iniciar desaf√≠os del hor√≥scopo (TODAS las palabras de esa categor√≠a) ---
async function startDesafioHoroscopo(categoria) {
  console.log('üêæ DEBUG: startDesafioHoroscopo iniciado para categor√≠a:', categoria);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  // Cerrar modal si est√° abierto
  closeHoroscopeModal();
  
  // Filtrar TODAS las palabras de la categor√≠a espec√≠fica (conocidas o no) - EXCLUIR badges del hor√≥scopo
  const pool = cards.filter(c => c.unit === categoria && !c.isHoroscopeAnimal);
  
  // Debug: Verificar duplicados
  const duplicateCheck = new Map();
  pool.forEach(card => {
    const key = card.hanzi;
    if (duplicateCheck.has(key)) {
      console.warn(`üö® DUPLICADO detectado: ${key}`, {
        original: duplicateCheck.get(key),
        duplicate: {hanzi: card.hanzi, unit: card.unit, isHoroscopeAnimal: card.isHoroscopeAnimal, id: card.id}
      });
    } else {
      duplicateCheck.set(key, {hanzi: card.hanzi, unit: card.unit, isHoroscopeAnimal: card.isHoroscopeAnimal, id: card.id});
    }
  });
  
  // USAR TODAS LAS PALABRAS DE LA CATEGOR√çA (no solo 10)
  sessionQueue = shuffle(pool);
  
  // Configurar como desaf√≠o especial del hor√≥scopo
  currentMission = 'desafio' + categoria.charAt(0).toUpperCase() + categoria.slice(1);
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  
  // Capturar estado inicial para el desaf√≠o de hor√≥scopo
  console.log('üì∑ Capturando estado pre-desaf√≠o hor√≥scopo:', categoria);
  capturePreChallengeState();
  
  // üî• ACTIVAR SOLO SISTEMA DE TIMER N PARA HOR√ìSCOPO (SIN VIDAS)
  console.log('‚ö° Activando solo timer N para desaf√≠o hor√≥scopo (sin vidas)');
  desafioNActive = true;
  desafioNTimeLeft = 120; // 2 minutos como los desaf√≠os N
  
  // OCULTAR BOTONES DE QUIZ EN DESAF√çOS DEL HOR√ìSCOPO
  updateQuizButtonsVisibility(currentMission);
  
  // ACTUALIZAR "MODO ACTUAL" - mostrar animal y tem√°tica
  const statMission = document.getElementById('statMission');
  console.log('üêæ DEBUG: Intentando actualizar statMission para hor√≥scopo categor√≠a:', categoria);
  console.log('üêæ DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const animalData = horoscopeAnimals[categoria];
    console.log('üêæ DEBUG: Animal data:', animalData);
    const categoryNames = {
      'colores': 'Colores',
      'fruta': 'Frutas', 
      'verduras': 'Verduras',
      'comidas': 'Comidas',
      'animales': 'Animales',
      'deportes': 'Deportes',
      'hobbies': 'Hobbies',
      'ropa': 'Ropa',
      'casa': 'Casa',
      'cuerpo': 'Cuerpo',
      'profesiones': 'Profesiones',
      'emociones': 'Emociones'
    };
    
    console.log('üêæ DEBUG: Category name:', categoryNames[categoria]);
    if (animalData && categoryNames[categoria]) {
      const displayText = `${animalData.chinese} ${animalData.name} - ${categoryNames[categoria]}`;
      console.log('üêæ DEBUG: Texto anterior:', statMission.textContent);
      console.log('üêæ DEBUG: Texto nuevo:', displayText);
      statMission.textContent = displayText;
      statMission.style.color = '#f2e5b1';
      statMission.style.fontWeight = 'bold';
      statMission.style.fontSize = '14px';
      console.log(`üêæ Modo hor√≥scopo actualizado exitosamente: ${displayText}`);
    } else {
      console.error('‚ùå ERROR: No se encontraron datos del animal o nombre de categor√≠a');
      console.error('‚ùå DEBUG: animalData:', animalData, 'categoryNames[categoria]:', categoryNames[categoria]);
    }
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission para hor√≥scopo');
  }
  
  console.log(`üéØ Desaf√≠o ${categoria}: ${sessionTotal} palabras totales`);
  
  // El modo aleatorio se aplicar√° autom√°ticamente para cada tarjeta en nextCard()
  
  // Aplicar tema visual de desaf√≠o del hor√≥scopo (monochrome harmony)
  bodyEl.classList.add('horoscope-bg');
  statBox.classList.add('challenge-stat');
  
  // Precargar video de fondo para desaf√≠o del hor√≥scopo
  await createChallengeVideoWithPreload('desafioHoroscopo', () => {
    // Iniciar timer solo despu√©s de que el video est√© listo
    startDesafioNTimer();
    
    // Iniciar el juego
    nextCard();
    updateStats();
  });
  
  // Reproducir m√∫sica de desaf√≠o espec√≠fica por categor√≠a - MOVIDO AL COUNTDOWN
  // playDesafioMusic(`desafioHoroscopo-${categoria}`); // ‚ú® MOVIDO AL COUNTDOWN
  
  // Ocultar la tabla de conocidas durante el desaf√≠o
  const knownTableSection = document.querySelector('section.mt-16');
  if(knownTableSection) knownTableSection.style.display = 'none';
  const knownOverlay = document.getElementById('knownOverlay');
  if(knownOverlay) knownOverlay.remove();
  
  // AUTO-SCROLL AL √ÅREA DE JUEGO
  setTimeout(() => {
    const xpElement = document.getElementById('xpBarWrap');
    if (xpElement) {
      xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      setTimeout(() => {
        window.scrollBy({ top: -10, behavior: 'smooth' });
      }, 300);
    }
  }, 100);
  
  console.log(`üéØ Desaf√≠o del Hor√≥scopo iniciado: ${categoria} (${sessionTotal} palabras)`);
}
// ========= Fin de cambios ========= */


  /* ========= AUTO-BLUR PARA ELIMINAR FOCUS PERSISTENTE EN M√ìVIL ========= */
  // Quitar focus de cualquier bot√≥n cuando se toca en cualquier parte de la pantalla
  document.addEventListener('touchend', (e) => {
    // Si no se toc√≥ un bot√≥n, quitar focus de todos los botones
    if (!e.target.tagName || e.target.tagName.toLowerCase() !== 'button') {
      const allButtons = document.querySelectorAll('button');
      allButtons.forEach(btn => {
        if (document.activeElement === btn) {
          btn.blur();
        }
      });
    }
  }, { passive: true });

  /* ========= Temporizador para racha ========= */
  setInterval(updateStreakBox, 60_000);

  /* ========= Inicio ========= */
  // Inicializar controles cuando el DOM est√© listo
  initializeControls();
  loadAll();
  loadXP();
  renderXPBar();
  startMission('unit2');

  // Mostrar notificaci√≥n de desaf√≠o bloqueado estilo pixel art
  function showChallengeBlockedNotification(categoria, knownCount, requiredCount = 10) {
    // MODO DOCUMENTAL: sin bloqueos
    return;

    // Remover notificaci√≥n anterior si existe
    const existingNotification = document.querySelector('.challenge-blocked-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.className = 'challenge-blocked-notification';
    
    // Obtener emoji del animal seg√∫n categor√≠a
    const categoryEmojis = {
      'colores': 'üé®',
      'fruta': 'üçé',
      'verduras': 'ü•ï',
      'comidas': 'üçú',
      'animales': 'üê∂',
      'deportes': '‚öΩ',
      'hobbies': 'üé≤',
      'ropa': 'üëï',
      'casa': 'üè†',
      'cuerpo': 'üë§',
      'profesiones': 'üë®‚Äçüíº',
      'emociones': 'üòä'
    };
    
    const emoji = categoryEmojis[categoria] || 'üê≤';
    const categoryName = categoria.charAt(0).toUpperCase() + categoria.slice(1);
    
    notification.innerHTML = `
      <div class="blocked-header">
        üîí DESAF√çO BLOQUEADO üîí
      </div>
      
      <div style="font-size: 40px; margin: 10px 0;">${emoji}</div>
      
      <div class="blocked-content">
        <div style="font-size: 20px; margin-bottom: 5px;">
          Necesitas conocer al menos <strong>${requiredCount} caracteres</strong> de <strong>${categoryName}</strong>
        </div>
      </div>
      
      <div class="blocked-stats">
        üìä Actualmente conoces: ${knownCount}/${requiredCount}
      </div>
      
      <div class="blocked-tip">
        <div style="font-size: 18px;">
        üí° Ve a las unidades del hor√≥scopo para coleccionar m√°s caracteres primero
      </div>
      
      <button class="blocked-button" onclick="closeChallengeBlockedNotification()">
        üîô ENTENDIDO
      </button>
    `;
    
    // Agregar overlay para fondo oscuro
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 99998;
    `;
    overlay.onclick = () => closeChallengeBlockedNotification();
    
    // Agregar al DOM
    document.body.appendChild(overlay);
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
  }

  // Cerrar notificaci√≥n de desaf√≠o bloqueado
  function closeChallengeBlockedNotification() {
    const notification = document.querySelector('.challenge-blocked-notification');
    const overlay = notification?.previousElementSibling;
    
    if (notification) {
      notification.style.opacity = '0';
      notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
      
      setTimeout(() => {
        if (notification.parentNode) notification.parentNode.removeChild(notification);
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      }, 300);
    }
  }


  </script>
</div> <!-- Cierre de gameArea -->
</body>
</html>