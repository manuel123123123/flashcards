<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Flashcards MacaLaoshi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MacaFlash" />
  <!-- Prevent zoom on iOS -->
  <meta name="format-detection" content="telephone=no" />
  <!-- PWA Manifest -->
  <!-- <link rel="manifest" href="manifest.json" /> -->
  <style>
    /* ---------- Base / flipping ---------- */
    .flip { transform: rotateY(180deg); }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotateY180 { transform: rotateY(180deg); }
    .perspective { perspective: 1000px; }
    .hidden { display: none; }

    /* ---------- Animaciones de feedback ---------- */
    @keyframes pop {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
      30%  { transform: scale(1.09);box-shadow: 0 0 45px rgba(16,185,129,.55); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-6px); }
      80%     { transform: translateX(6px); }
    }
    .popAnim   { animation: pop   420ms ease-out; }
    .shakeAnim { animation: shake 420ms ease; }

    @keyframes pulseGlow {
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
      50%  { box-shadow: 0 0 24px 8px var(--glow); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    .pulseBadge { animation: pulseGlow 700ms ease-out; }
    .pulseGreen { --glow: rgba(16,185,129,.85); } /* known */
    .pulseAmber { --glow: rgba(245,158,11,.85); } /* revise1 */
    .pulseTeal  { --glow: rgba(20,184,166,.85); } /* revise2 */

    /* ---------- Estado de opciones en QUIZ ---------- */
    .optCorrect {
      background-color: #059669 !important;
      color: #fff !important;
      box-shadow: 0 0 26px rgba(16,185,129,.75) !important;
      transform: scale(1.02);
    }
    .optWrong {
      background-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(220,38,38,.7) !important;
    }

    /* ---------- Tema ‚ÄúDesaf√≠o‚Äù ---------- */
    .challenge-bg   { background-color: #4c1d95 !important; } /* morado profundo */
    .challenge-stat { background-color: #6d28d9 !important; } /* morado vivo */

    /* ---------- Overlay Tabla Conocidas ---------- */
    .overlay {
      position: fixed; inset: 0; z-index: 40; display: flex; align-items: center; justify-content: center;
      background: rgba(2,6,23,.75);
    }
    .overlayCard { width: min(1100px, 95vw); height: min(90vh, 900px); }
    /* Scroll for known table grid */
/* Scroll for known table grid - 4 columnas en m√≥vil, m√°s en desktop */
    #knownGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100px, 22vw), 1fr));
      gap: 6px;
      pointer-events: auto !important;
      z-index: 1 !important;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .squareCell{
      aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden; white-space:nowrap; padding:10px;
      text-align:center; user-select:none;
    }
    .streak-badge{
      position:absolute; right:6px; bottom:6px;
      padding:2px 6px; border-radius:10px; font-size:12px; font-weight:700;
      color:#0B1020; background:#3B82F6;
      box-shadow:0 0 10px rgba(0,0,0,.25);
    }


    /* --- Fondo din√°mico tipo conic/radial  */
    .challenge-bg {
      margin: 0;
      background-color: #5d2d91;
      background-image:
        radial-gradient(transparent 1.2em, #4c1d95 0.6em), /* antes 0.6em / 0.3em ‚Üí ahora x2 */
        conic-gradient(at 2em 2em, transparent 270deg, #4203 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4204 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4205 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4206 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em; /* antes 1em/4em ‚Üí ahora x2 */
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
    }

    /* Horizontal */
    @keyframes bpx {
      0%, 7.5%, 100% { background-position-x: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-x: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-x: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-x: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-x: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-x: 0, -6em, 0, 6em, 12em; }
    }

    /* Vertical */
    @keyframes bpy {
      0%, 7.5%, 100% { background-position-y: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-y: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-y: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-y: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-y: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-y: 0, -6em, 0, 6em, 12em; }
    }

    /* --- Animaci√≥n para tarjeta incorrecta --- */
.cardWrong {
  box-shadow: 0 0 0 9999px rgba(220,38,38,0.3) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}
.cardWrongFade {
  box-shadow: 0 0 0 0 rgba(220,38,38,0) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}

/* --- Fade out para casillas correctas e incorrectas --- */
.optCorrectFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #05966933 !important;
  box-shadow: 0 0 0 rgba(16,185,129,0) !important;
}
.optWrongFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #dc262633 !important;
  box-shadow: 0 0 0 rgba(220,38,38,0) !important;
}

/* Transici√≥n flip hacia arriba entre tarjetas */
.card-flip-up-out {
  transform: rotateX(90deg);
  opacity: 0;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}
.card-flip-up-in {
  transform: rotateX(-90deg);
  opacity: 0;
}
.card-flip-up-in.card-flip-animate {
  transform: rotateX(0deg);
  opacity: 1;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}

/* Flip vertical transici√≥n entre tarjetas (cambio de contenido en el medio) */
.card-flip-vert {
  transition: transform 0.44s cubic-bezier(.4,0,.2,1);
  transform-style: preserve-3d;
}
.card-flip-vert.flipping {
  transform: rotateX(90deg);
}
.card-flip-vert.flipped {
  transform: rotateX(0deg);
}

  
    /* Animaci√≥n de glow dorado intensificado para tarjetas premium */
    @keyframes goldGlow {
      0%   { box-shadow: 0 0 32px 8px #ffd70099, 0 0 0 3px #fffbe6; }
      50%  { box-shadow: 0 0 64px 16px #f6dc4dcc, 0 0 0 5px #fae078; }
      100% { box-shadow: 0 0 32px 8px #ffd70099, 0 0 0 3px #fffbe6; }
    }
    .premium-gold {
      background: linear-gradient(155deg, #e7d173 0%, #d4be5e 25%, #dec557 50%, #d4be5e 75%, #e7d173 100%) !important;
      border: 2px solid #f3d54f !important;
      box-shadow: 0 0 32px 8px #000000eb, 0 0 0 4px #fffbe6;
      animation: goldGlow 2.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    /* Tarjeta m√≠tica violeta para desaf√≠o */
    @keyframes mythicGlow {
      0%   { box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe; }
      50%  { box-shadow: 0 0 64px 16px #a78bface, 0 0 0 6px #c4b5fd; }
      100% { box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe; }
    }
    .mythic-violet {
      background: linear-gradient(145deg, #a99af5 0%, #7356cc 100%) !important;
      border: 2px solid #a78bfa !important;
      box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe;
      animation: mythicGlow 1.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    /* Tarjeta legendaria roja para desaf√≠o */
    @keyframes legendaryGlow {
      0%   { box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2; }
      50%  { box-shadow: 0 0 64px 16px #f87171cc, 0 0 0 6px #fca5a5; }
      100% { box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2; }
    }
    .legendary-red {
      background: linear-gradient(135deg, #f57f7f 0%, #fb4646 100%) !important;
      border: 4px solid #f87171 !important;
      box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2;
      animation: legendaryGlow 1.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    /* Clases para pausar animaciones especiales y aplicar glow verde cuando es correcto */
    .premium-gold.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .mythic-violet.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .legendary-red.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    /* --- Mejoras para m√≥vil --- */
    @media (max-width: 640px) {
      .flip-card { min-height: 250px; }
      .text-6xl { font-size: 3rem !important; }
      .text-2xl { font-size: 1.5rem !important; }
      
      /* Botones m√°s grandes para m√≥vil */
      #flashRow button, #quizRow button {
        min-height: 48px;
        font-size: 1rem;
      }
      
      /* Header buttons responsive */
      header .grid button {
        min-height: 48px;
        padding: 12px 16px;
        font-size: 0.9rem;
      }
      
      /* XP Bar responsive */
      #xpBarWrap .flex {
        flex-wrap: wrap;
      }
      
      #xpToNext {
        word-break: break-word;
      }
      
      /* Evitar zoom en inputs */
      input, select, textarea {
        font-size: 16px !important;
      }
      
      /* √Årea de toque m√°s grande */
      .touch-target {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Dropdown menus responsive */
      .absolute.min-w-\[180px\] {
        min-width: 160px;
        left: 0;
        right: 0;
        margin: 0 auto;
      }
    }
    
    /* Animaciones m√°s suaves en m√≥vil */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* FIX: Estados de botones en m√≥vil - contraste consistente */
    button:focus,
    button:active,
    button:focus-visible {
      outline: none !important;
    }
    
    /* Botones principales del juego - SIN transparencia para mejor contraste */
    #btnKnown {
      background-color: #047857 !important; /* emerald-700 s√≥lido */
    }
    #btnKnown:hover, 
    #btnKnown:focus, 
    #btnKnown:active {
      background-color: #065f46 !important; /* emerald-800 m√°s oscuro */
    }
    
    #btnRevise1 {
      background-color: #d97706 !important; /* amber-600 s√≥lido */
    }
    #btnRevise1:hover,
    #btnRevise1:focus,
    #btnRevise1:active {
      background-color: #b45309 !important; /* amber-700 m√°s oscuro */
    }
    
    #btnRevise2 {
      background-color: #0d9488 !important; /* teal-600 s√≥lido */
    }
    #btnRevise2:hover,
    #btnRevise2:focus,
    #btnRevise2:active {
      background-color: #0f766e !important; /* teal-700 m√°s oscuro */
    }
    
    #btnQuizPinyin,
    #btnQuizMeaning,
    #btnQuizHanzi {
      background-color: #7c3aed !important; /* purple-600 s√≥lido */
    }
    #btnQuizPinyin:hover, #btnQuizPinyin:focus, #btnQuizPinyin:active,
    #btnQuizMeaning:hover, #btnQuizMeaning:focus, #btnQuizMeaning:active,
    #btnQuizHanzi:hover, #btnQuizHanzi:focus, #btnQuizHanzi:active {
      background-color: #6d28d9 !important; /* purple-700 m√°s oscuro */
    }
    
    #btnChallenge {
      background-color: #a21caf !important; /* fuchsia-700 s√≥lido */
    }
    #btnChallenge:hover,
    #btnChallenge:focus,
    #btnChallenge:active {
      background-color: #86198f !important; /* fuchsia-800 m√°s oscuro */
    }
    
    /* Prevenir efectos webkit en m√≥vil */
    button {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ===== SOLUCI√ìN DEFINITIVA PARA EL PROBLEMA DE FOCUS EN M√ìVIL ===== */
    @media (max-width: 768px) {
      /* Eliminar TODOS los estados de focus/active en botones de quiz */
      #quizOpt button:focus,
      #quizOpt button:active,
      #quizOpt button:focus-visible,
      button.quiz-button:focus,
      button.quiz-button:active,
      button.quiz-button:focus-visible {
        background: inherit !important;
        opacity: 1 !important;
        outline: none !important;
        -webkit-tap-highlight-color: transparent !important;
        box-shadow: none !important;
        border-color: inherit !important;
      }
      
      /* Forzar estilos espec√≠ficos para cada tipo de bot√≥n */
      button.bg-blue-600\/80:focus,
      button.bg-blue-600\/80:active { 
        background: rgb(37 99 235 / 0.8) !important; 
      }
      
      button.bg-red-600\/80:focus,
      button.bg-red-600\/80:active { 
        background: rgb(220 38 38 / 0.8) !important; 
      }
      
      button.bg-yellow-600\/80:focus,
      button.bg-yellow-600\/80:active { 
        background: rgb(202 138 4 / 0.8) !important; 
      }
      
      button.bg-purple-600\/80:focus,
      button.bg-purple-600\/80:active { 
        background: rgb(147 51 234 / 0.8) !important; 
      }
      
      /* Eliminar cualquier estado residual */
      * {
        -webkit-tap-highlight-color: transparent !important;
      }
    }
  </style>
</head>
<body id="body" class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-lg mx-auto p-4 sm:p-6">

    <!-- ---------- Encabezado ---------- -->
    <header class="flex flex-col gap-3 mx-12 sm:mx-20">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-center sm:text-left">Flashcards MacaLaoshi</h1>
      
      <!-- Fila 1: Nivel 1 ancho completo, Nivel 2 si se desbloquea -->
      <div class="grid grid-cols-1 gap-2">
        <!-- Nivel 1 - Ancho completo -->
        <div class="relative">
          <button id="btnNivel1" class="w-full px-4 py-2 rounded-2xl bg-indigo-700 hover:bg-indigo-600 font-semibold">
            <span>Nivel 1</span> <span id="nivel1Arrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="nivel1Box" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnUnit2" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 2</button>
            <button id="btnUnit3" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 3</button>
            <button id="btnUnit4" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 4</button>
            <button id="btnUnit5" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 5</button>
            <button id="btnUnit6" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 6</button>
            <button id="btnUnit7" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 7</button>
            <button id="btnUnit8" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 8</button>
            <button id="btnUnit9" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 9</button>
            <button id="btnTodoN1" class="px-4 py-2 rounded-2xl bg-indigo-500 hover:bg-indigo-400 font-bold">Todo N1</button>
            <button id="btnDesafioN1" class="px-4 py-2 rounded-2xl bg-fuchsia-700 hover:bg-fuchsia-600 font-bold">Desaf√≠o N1</button>
          </div>
        </div>
        
        <!-- Columna 2: Nivel 2 (cuando est√° desbloqueado) -->
        <div class="relative" id="nivel2Wrap" style="display:none;">
          <button id="btnNivel2" class="w-full px-4 py-2 rounded-2xl bg-red-700 hover:bg-red-600 font-semibold">
            <span>Nivel 2 ‚ñº</span> 
          </button>
          <div id="nivel2Box" class="absolute left-0 mt-2 bg-slate-800 rounded-xl shadow-lg ring-1 ring-white/10 z-50 flex flex-col min-w-[180px] opacity-0 scale-y-95 transition-all duration-300 origin-top hidden">
            <button id="btnUnit1N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 1</button>
            <button id="btnUnit2N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 2</button>
            <button id="btnUnit3N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 3</button>
            <button id="btnUnit4N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 4</button>
            <button id="btnUnit5N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 5</button>
            <button id="btnUnit6N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 6</button>
            <button id="btnUnit7N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 7</button>
            <button id="btnUnit8N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 8</button>
            <button id="btnUnit9N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 9</button>
            <button id="btnUnit10N2" class="px-4 py-2 rounded-xl bg-red-600 hover:bg-red-500 m-1">Unidad 10</button>
            <button id="btnTodoN2" class="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-400 font-bold m-1">Todo N2</button>
          </div>
        </div>
        
        <!-- Columna 3: Espacio reservado para Nivel 3 -->
        <div class="hidden sm:block"></div>
      </div>
      
      <!-- Fila 2: Conocidas, A repasar, Confirmar - GRID 3 COLUMNAS FORZADO -->
      <div class="grid grid-cols-3 gap-1">
        <button id="btnKnown" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Conocidas <span id="countKnown" class="font-bold ml-1">0</span></span>
        </button>
        <button id="btnRevise1" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">A repasar <span id="countRev1" class="ml-1">‚úÖ</span></span>
        </button>
        <button id="btnRevise2" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Confirmar <span id="countRev2" class="ml-1">‚úÖ</span></span>
        </button>
      </div>
      
      <!-- Fila 3: Quiz modes - GRID 3 COLUMNAS FORZADO -->
      <div class="grid grid-cols-3 gap-1">
        <button id="btnQuizPinyin" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Pinyin</span>
        </button>
        <button id="btnQuizMeaning" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Trad</span>
        </button>
        <button id="btnQuizHanzi" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Hanzi</span>
        </button>
      </div>
      
      <!-- Fila 4: Desaf√≠o, Tabla Conocidas - GRID 2 COLUMNAS FORZADO -->
      <div class="grid grid-cols-2 gap-1">
        <div class="relative">
          <button id="btnChallenge" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
            <span class="whitespace-nowrap">Desaf√≠o</span> <span id="challengeArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="challengeBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[240px]">
            <button id="btnDesafioClassico" class="px-6 py-3 rounded-2xl bg-purple-600 hover:bg-purple-500 font-semibold">Desaf√≠o cl√°sico</button>
            <button id="btnDesafioMenos" class="px-6 py-3 rounded-2xl bg-purple-600 hover:bg-purple-500 font-semibold">Desaf√≠o - (nivel 0 y 1)</button>
            <button id="btnDesafioMas" class="px-6 py-3 rounded-2xl bg-purple-600 hover:bg-purple-500 font-semibold">Desaf√≠o + (nivel 2+)</button>
          </div>
        </div>
        <button id="btnKnownTable" class="px-2 py-1 rounded-2xl bg-yellow-600 hover:bg-yellow-500 text-black font-semibold ring-2 ring-yellow-700 min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Tabla Conocidas</span>
        </button>
      </div>
    </header>

  <script>
  // --- Login autom√°tico ---
  // FUNCI√ìN showLoginForm COMENTADA - NO SE USA EN VERSI√ìN LOCAL
  /*
  function showLoginForm() {
    const loginDiv = document.createElement('div');
    loginDiv.style.position = 'fixed';
    loginDiv.style.top = '0';
    loginDiv.style.left = '0';
    loginDiv.style.width = '100vw';
    loginDiv.style.height = '100vh';
    loginDiv.style.background = 'rgba(0,0,0,0.7)';
    loginDiv.style.zIndex = '9999';
    loginDiv.style.display = 'flex';
    loginDiv.style.alignItems = 'center';
    loginDiv.style.justifyContent = 'center';
    loginDiv.innerHTML = `
      <form id="loginForm" style="background:#222;padding:32px 24px;border-radius:16px;box-shadow:0 0 32px #000;display:flex;flex-direction:column;gap:16px;min-width:280px;">
        <h2 style="color:#fff;font-size:1.3em;margin-bottom:8px;">Iniciar sesi√≥n</h2>
        <input id="loginUser" type="text" placeholder="Usuario" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
        <input id="loginPass" type="password" placeholder="Contrase√±a" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
        <button type="submit" style="padding:10px 0;border-radius:8px;background:#2563eb;color:#fff;font-weight:bold;">Entrar</button>
        <button id="btnCreateUser" type="button" style="margin-top:8px;padding:10px 0;border-radius:8px;background:#fbbf24;color:#222;font-weight:bold;">Crear usuario nuevo</button>
        <div id="loginError" style="color:#f87171;font-size:0.95em;"></div>
      </form>
      <div id="registerBox" style="display:none;margin-top:18px;background:#222;padding:24px 18px;border-radius:14px;box-shadow:0 0 18px #000;flex-direction:column;gap:12px;min-width:260px;">
        <h3 style="color:#fff;font-size:1.1em;margin-bottom:8px;">Registro de usuario</h3>
        <div id="registerStepCode">
          <input id="registerCode" type="text" placeholder="C√≥digo de invitaci√≥n" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" />
          <button id="btnCheckCode" type="button" style="margin-top:8px;padding:8px 0;border-radius:8px;background:#fbbf24;color:#222;font-weight:bold;">Validar c√≥digo</button>
          <div id="registerCodeError" style="color:#f87171;font-size:0.95em;margin-top:6px;"></div>
        </div>
        <form id="registerForm" style="display:none;flex-direction:column;gap:10px;">
          <input id="registerUser" type="text" placeholder="Usuario (solo min√∫sculas)" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" pattern="[a-z]+" required />
          <input id="registerPass1" type="password" placeholder="Contrase√±a" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
          <input id="registerPass2" type="password" placeholder="Repetir contrase√±a" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
          <select id="registerCountry" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required>
            <option value="">Selecciona tu pa√≠s</option>
            <option value="Argentina">Argentina</option>
            <option value="China">China</option>
            <option value="M√©xico">M√©xico</option>
            <option value="Espa√±a">Espa√±a</option>
            <option value="Chile">Chile</option>
            <option value="Colombia">Colombia</option>
            <option value="Per√∫">Per√∫</option>
            <option value="Uruguay">Uruguay</option>
            <option value="Ecuador">Ecuador</option>
            <option value="Bolivia">Bolivia</option>
            <option value="Venezuela">Venezuela</option>
            <option value="Paraguay">Paraguay</option>
            <option value="Costa Rica">Costa Rica</option>
            <option value="Panam√°">Panam√°</option>
            <option value="Estados Unidos">Estados Unidos</option>
            <option value="Portugal">Portugal</option>
            <option value="Francia">Francia</option>
            <option value="Guatemala">Guatemala</option>
            <option value="Honduras">Honduras</option>
            <option value="El Salvador">El Salvador</option>
            <option value="Nicaragua">Nicaragua</option>
            <option value="Puerto Rico">Puerto Rico</option>
            <option value="Cuba">Cuba</option>
            <option value="Rep√∫blica Dominicana">Rep√∫blica Dominicana</option>
            <option value="Otro">Otro</option>
          </select>
          <button type="submit" style="padding:10px 0;border-radius:8px;background:#fbbf24;color:#222;font-weight:bold;">Registrar usuario</button>
          <div id="registerError" style="color:#f87171;font-size:0.95em;margin-top:6px;"></div>
        </form>
      </div>
    `;
    document.body.appendChild(loginDiv);
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPass').value;
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = '';
      try {
        const res = await fetch(`${window.API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if(res.ok){
          const data = await res.json();
          jwtToken = data.token;
          window.username = data.username || username;
          localStorage.setItem('jwtToken', jwtToken);
          localStorage.setItem('username', window.username);
          loginDiv.remove();
          await loadAll();
          await renderLeaderboard();
        } else {
          errorDiv.textContent = 'Usuario o contrase√±a incorrectos.';
        }
      } catch(err){
        errorDiv.textContent = 'Error de conexi√≥n.';
      }
    };

    // --- Registro de usuario ---
    document.getElementById('btnCreateUser').onclick = function() {
      document.getElementById('registerBox').style.display = 'flex';
    };
    document.getElementById('btnCheckCode').onclick = function() {
      const code = document.getElementById('registerCode').value.trim();
      const codeError = document.getElementById('registerCodeError');
      if(code !== 'lili') {
        codeError.textContent = 'C√≥digo incorrecto.';
        return;
      }
      codeError.textContent = '';
      document.getElementById('registerStepCode').style.display = 'none';
      document.getElementById('registerForm').style.display = 'flex';
    };
    document.getElementById('registerForm').onsubmit = async function(e) {
      e.preventDefault();
      const user = document.getElementById('registerUser').value.trim();
      const pass1 = document.getElementById('registerPass1').value;
      const pass2 = document.getElementById('registerPass2').value;
      const country = document.getElementById('registerCountry').value;
      const errorDiv = document.getElementById('registerError');
      errorDiv.textContent = '';
      if(!/^[a-z]+$/.test(user)) {
        errorDiv.textContent = 'El usuario debe ser solo min√∫sculas.';
        return;
      }
      if(pass1.length < 4) {
        errorDiv.textContent = 'La contrase√±a debe tener al menos 4 caracteres.';
        return;
      }
      if(pass1 !== pass2) {
        errorDiv.textContent = 'Las contrase√±as no coinciden.';
        return;
      }
      if(!country) {
        errorDiv.textContent = 'Selecciona tu pa√≠s.';
        return;
      }
      try {
        const res = await fetch(`${window.API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass1, country })
        });
        if(res.ok){
          errorDiv.style.color = '#22c55e';
          errorDiv.textContent = 'Usuario creado correctamente. Ahora puedes iniciar sesi√≥n.';
          setTimeout(()=>{ document.getElementById('registerBox').style.display = 'none'; }, 1800);
        } else {
          const data = await res.json();
          errorDiv.textContent = data.error || 'No se pudo crear el usuario.';
        }
      } catch(err){
        errorDiv.textContent = 'Error de conexi√≥n.';
      }
    };
  }
  */
  // FIN DEL COMENTARIO DE showLoginForm

  window.addEventListener('DOMContentLoaded', async () => {
    // Inicializar pools de sonidos
    initCorrectSoundPool();
    initCelebrationSoundPool();
    
    // Scroll al top al cargar la p√°gina
    window.scrollTo(0, 0);
    
    // Tambi√©n forzar scroll al top en pageshow (bot√≥n atr√°s del navegador)
    window.addEventListener('pageshow', () => {
      window.scrollTo(0, 0);
    });
    
    // Registrar Service Worker para PWA
    // COMENTADO - NO FUNCIONA CON file://
    /*
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('SW registrado:', registration);
      } catch (error) {
        console.log('Error registrando SW:', error);
      }
    }
    */
    
    // Configurar URL base del API - COMENTADO PARA VERSI√ìN LOCAL
    /*
    // Para desarrollo local, siempre usar localhost:4000
    console.log('Hostname actual:', window.location.hostname);
    console.log('Protocol actual:', window.location.protocol);
    
    if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.API_BASE = 'http://localhost:4000';
    } else {
      // En producci√≥n, usar el mismo dominio (Railway maneja el puerto internamente)
      window.API_BASE = window.location.origin;
    }
    
    console.log('API_BASE configurado como:', window.API_BASE);
    */
    
    // Auto-inicio como Usuario local sin login
    jwtToken = 'local-token-v10';
    currentUser = 'Usuario';
    console.log('üéÆ Modo local iniciado como:', currentUser);
    
    await loadAll();
    // Leaderboard eliminado en PARTE6-ES
    
    // Mostrar el bot√≥n y box de Nivel 2 si est√° desbloqueado
    if(nivel2Unlocked) {
      showNivel2Button();
      // Forzar display del box si existe
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      if(nivel2Wrap) nivel2Wrap.style.display = '';
      const btnNivel2 = document.getElementById('btnNivel2');
      if(btnNivel2) btnNivel2.style.display = '';
    }
    
    // Forzar scroll al top despu√©s de cargar todos los datos
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 100);
  });
  </script>

        
      </div>
    </header>

    <!-- Barra de experiencia (XP) -->
    <div id="xpBarWrap" class="mt-4 mb-2 mx-12 sm:mx-20">
      <div class="flex items-center justify-between gap-2 mb-1">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <span id="xpLabel" class="font-bold text-sm whitespace-nowrap">Ê∞¥Âπ≥ <span id="xpLevel">1</span></span>
          <span id="xpToNext" class="text-xs flex-1 min-w-0"></span>
        </div>
      </div>
      <div class="w-full h-4 bg-sky-900 rounded-full overflow-hidden relative">
        <div id="xpBar" class="h-4 bg-sky-400 transition-all duration-500 relative" style="width:0%"></div>
      </div>
    </div>

    <!-- ---------- Estado ---------- -->
  
    <section class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm mx-12 sm:mx-20">
      <div class="bg-slate-900/95 rounded-xl p-2">
        <div class="text-slate-400 text-xs">Faltan</div>
        <div id="statInSession" class="text-lg font-semibold">0</div>
      </div>
      <div class="bg-slate-900/95 rounded-xl p-2">
        <div class="text-slate-400 text-xs">Revisadas</div>
        <div id="statToday" class="text-lg font-semibold">0</div>
      </div>
      <div id="statBox" class="bg-slate-900/95 rounded-xl p-2">
        <div class="text-slate-400 text-xs">Modo Actual</div>
        <div id="statMission" class="text-lg font-semibold">‚Äî</div>
      </div>
      <div class="bg-slate-900/95 rounded-xl p-2 cursor-pointer" id="streakBox">
        <div class="text-slate-400 flex items-center gap-1 text-xs">
          Rachas <span id="streakCount" class="font-bold text-orange-400">0</span> <span style="font-size:1.1em;vertical-align:middle;">üî•</span>
        </div>
        <div id="streakStatus" class="text-sm font-semibold text-orange-300">‚Äî</div>
      </div>
    </section>

     <!-- ---------- Tarjeta ---------- -->
    <main class="mt-6 mx-12 sm:mx-20">
      <div id="cardWrap" class="relative h-72 sm:h-80 select-none perspective">
        <div id="card" class="absolute inset-0 rounded-3xl bg-slate-900/95 ring-1 ring-white/10 shadow-xl flex items-center justify-center text-center preserve-3d transition-transform duration-300 will-change-transform">
          <div id="cardFront" class="absolute inset-0 flex items-center justify-center backface-hidden text-6xl font-bold"></div>
          <div id="cardBack" class="absolute inset-0 flex flex-col items-center justify-center rotateY180 backface-hidden text-2xl leading-relaxed whitespace-pre-line"></div>
        </div>
      </div>

      <!-- Controles modo FLASH -->
      <div id="flashRow" class="mt-4 grid grid-cols-3 gap-2">
        <button id="btnDontKnow" class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700">‚Üê No la s√©</button>
        <button id="btnFlip"     class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700">Voltear</button>
        <button id="btnKnow"     class="py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500">La sab√≠a ‚Üí</button>
      </div>

      <!-- Controles modo QUIZ (opciones din√°micas) -->
      <div id="quizRow" class="mt-4 grid grid-cols-2 gap-2 hidden"></div>

      <p id="gameInstructions" class="mt-3 text-slate-400 text-xs sm:text-sm">
        Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la s√©, Espacio = Voltear, Derecha = La sab√≠a.
      </p>
    </main>
  </div>

  <!-- ========= Overlay: Leaderboard y Tabla Conocidas ========= -->
  <section class="mt-16 mx-auto max-w-3xl px-4 sm:px-6">
    <!-- üìä Tabla de conocidas despu√©s del leaderboard -->
    <div class="mt-8">
      <h2 class="text-lg font-semibold mb-2">Tabla de conocidas</h2>
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <span id="knownCount" class="text-slate-400 text-sm">0</span>
        <div class="flex items-center gap-2">
          <button id="btnShowHanzi" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Ê±âÂ≠ó</button>
          <button id="btnShowPinyin" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Pinyin</button>
          <button id="btnShowMeaning" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Significado</button>
        </div>
        <div class="flex items-center gap-1 ml-4">
          <span class="text-slate-400 text-xs">Filtrar:</span>
          <button id="btnCatAll" class="px-2 py-1 rounded bg-slate-700 text-xs font-bold">Todos</button>
          <button id="btnCatS" class="px-2 py-1 rounded bg-green-700 text-xs font-bold">S</button>
          <button id="btnCatA" class="px-2 py-1 rounded bg-orange-600 text-xs font-bold">A</button>
          <button id="btnCatV" class="px-2 py-1 rounded bg-red-700 text-xs font-bold">V</button>
          <button id="btnCatP" class="px-2 py-1 rounded bg-yellow-600 text-xs font-bold">P</button>
          <button id="btnCatE" class="px-2 py-1 rounded bg-blue-700 text-xs font-bold">E</button>
        </div>
      </div>
      <div id="knownGrid" class="w-full max-w-full overflow-hidden mb-16"></div>
    </div>
    
    <!-- Botones de administraci√≥n al final -->
    <div class="mt-16 pt-8 border-t border-slate-800">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-lg mx-auto">
        <button id="btnResetXP" class="px-4 py-3 rounded-2xl bg-sky-600 hover:bg-sky-500 font-semibold transition-colors text-center">
          Reiniciar Ê∞¥Âπ≥
        </button>
        <button id="btnReset" class="px-4 py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 font-semibold transition-colors text-center">
          Reiniciar progreso
        </button>
        <button id="btnLogout" class="px-4 py-3 rounded-2xl bg-red-700 hover:bg-red-600 text-white font-semibold transition-colors text-center">
          Cerrar sesi√≥n
        </button>
      </div>
    </div>
    
    <div style="height: 70px;"></div>
  </section>

  <script>
  /* ========= Estado y setup ========= */
  // Variable para controlar el estado del leaderboard
  let showingMyContext = false;
  
  // --- Leaderboard logic ---
  // Datos ficticios para modo local (18 usuarios)
  function getFakeLeaderboardData() {
    return [
      { username: 'Messi', country: 'Argentina', group: 'N1', xp: 230, knownCharsCount: 200, streak: 30, level: 5 },
      { username: 'Ronaldo', country: 'Portugal', group: 'N1', xp: 220, knownCharsCount: 180, streak: 28, level: 5 },
      { username: 'MacaLaoshi', country: 'China', group: 'N1', xp: 210, knownCharsCount: 170, streak: 25, level: 4 },
      { username: 'MrBeast', country: 'Estados Unidos', group: 'N1', xp: 200, knownCharsCount: 160, streak: 22, level: 4 },
      { username: 'JackieChan', country: 'China', group: 'N2', xp: 190, knownCharsCount: 150, streak: 20, level: 4 },
      { username: 'Yaoming', country: 'China', group: 'N2', xp: 180, knownCharsCount: 140, streak: 18, level: 4 },
      { username: 'Agustinaaprende', country: 'Argentina', group: 'N2', xp: 170, knownCharsCount: 130, streak: 15, level: 3 },
      { username: 'LeonardoDV', country: 'Estados Unidos', group: 'N2', xp: 160, knownCharsCount: 120, streak: 14, level: 3 },
      { username: 'Usuario', country: 'Argentina', group: 'N2', xp: 120, knownCharsCount: 80, streak: 10, level: 3 },
      { username: 'Gero', country: 'Colombia', group: 'N2', xp: 110, knownCharsCount: 70, streak: 8, level: 2 },
      { username: 'Antoniobanderas', country: 'Espa√±a', group: 'N3', xp: 100, knownCharsCount: 60, streak: 7, level: 2 },
      { username: 'GuillermoBull', country: 'Chile', group: 'N3', xp: 90, knownCharsCount: 50, streak: 6, level: 2 },
      { username: 'Jermaioni', country: 'M√©xico', group: 'N3', xp: 80, knownCharsCount: 45, streak: 5, level: 2 },
      { username: 'Tomyjerry', country: 'Panam√°', group: 'N3', xp: 70, knownCharsCount: 40, streak: 4, level: 2 },
      { username: 'Joshi', country: 'M√©xico', group: 'N3', xp: 60, knownCharsCount: 30, streak: 3, level: 1 },
      { username: 'Marioelbross', country: 'Espa√±a', group: 'N3', xp: 50, knownCharsCount: 25, streak: 2, level: 1 },
      { username: 'Mikewasaoski', country: 'Estados Unidos', group: 'N3', xp: 30, knownCharsCount: 15, streak: 1, level: 1 },
      { username: 'Peterpedro', country: 'Panam√°', group: 'N3', xp: 20, knownCharsCount: 10, streak: 1, level: 1 }
    ];
  }

  function getLeaderboardCurrentUser() {
    // En modo local forzado, el usuario real es el global `currentUser`.
    // Si existe un login real (window.username), se usa en producci√≥n.
    const token = (typeof jwtToken !== 'undefined' && jwtToken) ? String(jwtToken) : '';
    if (token.startsWith('local-token')) {
      return (typeof currentUser !== 'undefined' && currentUser) ? currentUser : 'Usuario';
    }
    return window.username || ((typeof currentUser !== 'undefined' && currentUser) ? currentUser : null);
  }

  function ensureUserInLeaderboardData(data) {
    const me = getLeaderboardCurrentUser();
    if (!me) return data;

    // Si el usuario actual no existe en el dataset (ej: mismatch entre window.username y 'Usuario'), lo agregamos.
    const idx = data.findIndex(u => u.username === me);
    const known = cards.filter(c => c.known).length;
    const meRow = {
      username: me,
      country: 'Argentina',
      group: 'N2',
      xp: xpPoints,
      knownCharsCount: known,
      streak,
      level: getCurrentLevel(xpPoints)
    };

    if (idx >= 0) {
      data[idx] = { ...data[idx], ...meRow };
    } else {
      data.push(meRow);
    }

    return data;
  }

  async function fetchLeaderboard(groupFilter = '', countryFilter = '') {
    // Versi√≥n local con datos ficticios
    let data = getFakeLeaderboardData();

    data = ensureUserInLeaderboardData(data);
    
    // Actualizar datos del usuario actual (si existe como global legacy)
    if (typeof currentUser !== 'undefined' && currentUser) {
      const userIndex = data.findIndex(u => u.username === currentUser);
      if (userIndex >= 0) {
        const known = cards.filter(c => c.known).length;
        data[userIndex].xp = xpPoints;
        data[userIndex].knownCharsCount = known;
        data[userIndex].streak = streak;
        data[userIndex].level = getCurrentLevel(xpPoints);
      }
    }
    
    // Aplicar filtros
    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }
    
    // Calcular score y ordenar
    data.forEach(u => u.totalScore = calcScore(u));
    data.sort((a, b) => b.totalScore - a.totalScore);
    // Asignar ranking
    data.forEach((u, i) => u.rank = i + 1);
    
    console.log('Leaderboard local:', data.length, 'usuarios');
    return data;
  }

  // Funci√≥n para obtener leaderboard completo (para Mi contexto)
  async function fetchLeaderboardFull(groupFilter = '', countryFilter = '') {
    // Versi√≥n local con datos ficticios completos
    let data = getFakeLeaderboardData();

    data = ensureUserInLeaderboardData(data);
    
    // Actualizar datos del usuario actual (si existe como global legacy)
    if (typeof currentUser !== 'undefined' && currentUser) {
      const userIndex = data.findIndex(u => u.username === currentUser);
      if (userIndex >= 0) {
        const known = cards.filter(c => c.known).length;
        data[userIndex].xp = xpPoints;
        data[userIndex].knownCharsCount = known;
        data[userIndex].streak = streak;
        data[userIndex].level = getCurrentLevel(xpPoints);
      }
    }
    
    // Aplicar filtros
    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }
    
    // Calcular score y ordenar
    data.forEach(u => u.totalScore = calcScore(u));
    data.sort((a, b) => b.totalScore - a.totalScore);
    // Asignar ranking
    data.forEach((u, i) => u.rank = i + 1);
    
    console.log('Leaderboard completo local:', data.length, 'usuarios');
    return data;
  }

  function calcScore(user) {
    // Nueva f√≥rmula: (conocidas + XP) * (1 + 0.01*racha) * (1 + 0.05*nivel)
    const xp = user.xp || 0;
    const known = user.knownCharsCount || (Array.isArray(user.knownChars) ? user.knownChars.filter(c=>c.known).length : 0);
    const streak = user.streak || 0;
    const level = user.level || 1;
    return Math.round((known + xp) * (1 + 0.01 * streak) * (1 + 0.05 * level));
  }

  async function showMyContextInLeaderboard() {
    const leaderboardTableEl = document.getElementById('leaderboardTable');
    if (!leaderboardTableEl) return;

    // Obtener filtros actuales
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    // Solicitar lista completa para poder mostrar contexto (filtros ya aplicados en backend)
    const filteredLeaderboard = await fetchLeaderboardFull(selectedGroup, selectedCountry);
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      leaderboardTableEl.innerHTML = '<div class="text-center text-slate-400 py-4">No hay datos para mostrar contexto</div>';
      return;
    }
    
    // Usuario actual (modo local o login)
    const currentUser = getLeaderboardCurrentUser();
    
    const myUserIndex = filteredLeaderboard.findIndex(u => u.username === currentUser);
    
    console.log('Debug Mi contexto:');
    console.log('Usuario actual:', currentUser);
    console.log('Mi √≠ndice:', myUserIndex);
    console.log('Total usuarios filtrados:', filteredLeaderboard.length);
    
    if (myUserIndex === -1) {
      leaderboardTableEl.innerHTML = '<div class="text-center text-slate-400 py-4">No se encontr√≥ tu posici√≥n en el ranking actual</div>';
      return;
    }
    
    // Obtener 5 usuarios arriba y 5 abajo (o los que haya disponibles)
    const startIndex = Math.max(0, myUserIndex - 5);
    const endIndex = Math.min(filteredLeaderboard.length, myUserIndex + 6); // usuario actual + 5 abajo
    
    console.log('Start index:', startIndex);
    console.log('End index:', endIndex);
    console.log('Usuarios que se van a mostrar:', endIndex - startIndex);
    
    const contextUsers = filteredLeaderboard.slice(startIndex, endIndex);
    
    console.log('Context users length:', contextUsers.length);
    console.log('Context users:', contextUsers.map(u => `${u.username} (pos ${u.rank})`));
    
    renderLeaderboardTable(contextUsers, currentUser, true);
  }

  async function toggleLeaderboardView() {
    const btnShowMyContext = document.getElementById('btnShowMyContext');
    
    if (!showingMyContext) {
      // Cambiar a "mi contexto"
      await showMyContextInLeaderboard();
      showingMyContext = true;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üîù Ver top';
        btnShowMyContext.title = 'Volver al leaderboard completo';
      }
    } else {
      // Cambiar a "ver top"
      await renderLeaderboard();
      showingMyContext = false;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üéØ Mi contexto';
        btnShowMyContext.title = 'Ver mi contexto en el ranking';
      }
    }
  }

  async function renderLeaderboard() {
    const leaderboardTableEl = document.getElementById('leaderboardTable');
    if (!leaderboardTableEl) return;

    // Obtener filtros seleccionados
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    console.log('Filtros seleccionados - Grupo:', selectedGroup, 'Pa√≠s:', selectedCountry); // Debug
    
    // El backend aplica todos los filtros y ordenamientos
    const filteredLeaderboard = await fetchLeaderboard(selectedGroup, selectedCountry);
    console.log('Leaderboard recibido del backend:', filteredLeaderboard); // Debug
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      let message = 'No hay usuarios';
      if (selectedGroup) message += ` en el grupo ${selectedGroup}`;
      if (selectedCountry) message += ` en ${selectedCountry}`;
      if (!selectedGroup && !selectedCountry) message = 'No recib√≠ nada';
      
      leaderboardTableEl.innerHTML = `<div class="text-center text-slate-400 py-4">${message}<br><span class='text-xs break-all text-yellow-400'>JWT: ${jwtToken}</span></div>`;
      return;
    }
    
    // Usuario actual (modo local o login)
    const currentUser = getLeaderboardCurrentUser();
    
    renderLeaderboardTable(filteredLeaderboard, currentUser, false);
    
    // Eventos para los filtros
    const countryFilterEl2 = document.getElementById('leaderboardCountryFilter');
    if (countryFilterEl2) countryFilterEl2.onchange = renderLeaderboard;
    
    const groupFilterEl2 = document.getElementById('leaderboardGroupFilter');
    if (groupFilterEl2) groupFilterEl2.onchange = renderLeaderboard;
  }

  // Funciones utilitarias para el leaderboard
  function countryToEmoji(country) {
    switch((country||'').toLowerCase()) {
      case 'argentina': return 'üá¶üá∑';
      case 'm√©xico': return 'üá≤üáΩ';
      case 'espa√±a': return 'üá™üá∏';
      case 'chile': return 'üá®üá±';
      case 'colombia': return 'üá®üá¥';
      case 'per√∫': return 'üáµüá™';
      case 'uruguay': return 'üá∫üáæ';
      case 'ecuador': return 'üá™üá®';
      case 'bolivia': return 'üáßüá¥';
      case 'venezuela': return 'üáªüá™';
      case 'paraguay': return 'üáµüáæ';
      case 'costa rica': return 'üá®üá∑';
      case 'panam√°': return 'üáµüá¶';
      case 'estados unidos': return 'üá∫üá∏';
      case 'portugal': return 'üáµüáπ';
      case 'francia': return 'üá´üá∑';
      case 'guatemala': return 'üá¨üáπ';
      case 'honduras': return 'üá≠üá≥';
      case 'el salvador': return 'üá∏üáª';
      case 'nicaragua': return 'üá≥üáÆ';
      case 'puerto rico': return 'üáµüá∑';
      case 'cuba': return 'üá®üá∫';
      case 'rep√∫blica dominicana': return 'üá©üá¥';
      case 'china': return 'üá®üá≥';
      default: return 'üåé';
    }
  }
  
  function groupToDisplay(group) {
    switch(group || '') {
      case 'N1': return 'üî¥ N1';
      case 'N2': return 'üü† N2';
      case 'N3': return 'üü° N3';
      case 'N4': return 'üü¢ N4';
      case 'N5': return 'üîµ N5';
      case 'S': return '‚≠ê S';
      case 'HSK3': return 'üèÆ HSK3';
      case 'No': return '‚ùå No';
      default: return '‚ö´ ‚Äî';
    }
  }
  
  function renderLeaderboardTable(users, currentUser, isContextView) {
    const leaderboardTableEl = document.getElementById('leaderboardTable');
    if (!leaderboardTableEl) return;

    const headerText = isContextView ? 'Mi contexto en el ranking' : 'Leaderboard completo';
    let html = `<table class="min-w-[320px] w-full text-xs sm:text-sm bg-slate-900 rounded-xl overflow-hidden">`;
    
    if (isContextView) {
      html += `<caption class="text-center text-blue-400 font-bold py-2 text-sm sm:text-base">${headerText}</caption>`;
    }
    
    html += `<thead><tr class="bg-slate-800 text-yellow-400">
      <th class="py-1 px-1 text-xs sm:text-sm">#</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Usuario</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Pa√≠s</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Grupo</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Niv</th>
      <th class="py-1 px-1 text-xs sm:text-sm">XP</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Conoc</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Racha</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Score</th>
    </tr></thead><tbody>`;
    
    users.forEach((u)=>{
      const score = calcScore(u);
      const known = Array.isArray(u.knownChars) ? u.knownChars.filter(c=>c.known).length : (u.knownCharsCount || 0);
      const lvl = u.level || (typeof getCurrentLevel==='function' ? getCurrentLevel(u.xp||0) : '-');
      
      // Resaltar usuario actual siempre en amarillo
      const isCurrentUser = u.username === currentUser;
      const highlightClass = isCurrentUser ? 'bg-yellow-100 text-black font-bold' : '';
      
      html += `<tr${highlightClass ? ` class="${highlightClass}"` : ''}>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.rank}</td>
        <td class="py-1 px-1 text-xs sm:text-sm max-w-[60px] sm:max-w-none truncate">${u.username}${isCurrentUser && isContextView ? ' üë§' : ''}</td>
        <td class="py-1 px-1 text-center text-xs">${countryToEmoji(u.country)}</td>
        <td class="py-1 px-1 text-center text-xs">${groupToDisplay(u.group)}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${lvl}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.xp||0}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${known}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.streak||0}</td>
        <td class="py-1 px-1 text-center font-bold text-xs sm:text-sm">${u.totalScore || score}</td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    
    if (isContextView) {
      html += '<div class="text-center mt-2">' +
              '<button id="btnBackToFullLeaderboard" class="px-3 py-1 rounded bg-gray-600 hover:bg-gray-500 text-white text-xs">' +
              '‚Üê Volver al leaderboard completo</button></div>';
    }
    
    leaderboardTableEl.innerHTML = html;
    
    // Agregar evento para volver al leaderboard completo
    if (isContextView) {
      const btnBack = document.getElementById('btnBackToFullLeaderboard');
      if (btnBack) btnBack.onclick = renderLeaderboard;
    }
  }
  
  const btnReload = document.getElementById('btnReloadLeaderboard');
  if (btnReload) btnReload.onclick = renderLeaderboard;
  const btnStar = document.getElementById('btnStarLeaderboard');
  if (btnStar) btnStar.onclick = renderLeaderboard;
  
  // Agregar evento para bot√≥n de contexto
  const btnShowMyContext = document.getElementById('btnShowMyContext');
  if (btnShowMyContext) btnShowMyContext.onclick = toggleLeaderboardView;

  // --- Funcionalidad para cambiar grupo ---
  // FUNCI√ìN changeUserGroup COMENTADA - NO SE USA EN VERSI√ìN LOCAL
  /*
  async function changeUserGroup(group) {
    if(!jwtToken) return;
    try {
      const res = await fetch(`${window.API_BASE}/api/setgroup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': jwtToken
        },
        body: JSON.stringify({ group })
      });
      if(res.ok){
        // Actualizar leaderboard despu√©s de cambiar grupo
        await renderLeaderboard();
        showGroupChangeMessage(group);
      }
    } catch(e) {
      console.error('Error al cambiar grupo:', e);
    }
  }
  */

  function showGroupChangeMessage(group) {
    let msg = document.getElementById('groupChangeMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'groupChangeMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-2xl shadow-lg text-sm font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      document.body.appendChild(msg);
    }
    
    const groupDisplay = {
      'N1': 'üî¥ N1',
      'N2': 'üü† N2', 
      'N3': 'üü° N3',
      'N4': 'üü¢ N4',
      'N5': 'üîµ N5',
      'S': '‚≠ê S',
      'HSK3': 'üèÆ HSK3',
      'No': '‚ùå No'
    }[group] || group;
    
    msg.textContent = `Grupo cambiado a: ${groupDisplay}`;
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 2000);
  }

  // Manejar selector de grupo
  window.addEventListener('DOMContentLoaded', function() {
    const btnChangeGroup = document.getElementById('btnChangeGroup');
    const groupSelector = document.getElementById('groupSelector');
    
    if(btnChangeGroup && groupSelector) {
      btnChangeGroup.onclick = (e) => {
        e.stopPropagation();
        groupSelector.style.display = groupSelector.style.display === 'none' ? 'flex' : 'none';
      };
      
      // Cerrar selector al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!groupSelector.contains(e.target) && e.target !== btnChangeGroup) {
          groupSelector.style.display = 'none';
        }
      });
      
      // Manejar selecci√≥n de grupo
      const groupOptions = document.querySelectorAll('.group-option');
      groupOptions.forEach(option => {
        option.onclick = async (e) => {
          e.stopPropagation();
          const selectedGroup = option.getAttribute('data-group');
          await changeUserGroup(selectedGroup);
          groupSelector.style.display = 'none';
        };
      });
    }
  });
 
   // --- Logout button handler ---
   window.addEventListener('DOMContentLoaded', function() {
     var btnLogout = document.getElementById('btnLogout');
     if (btnLogout) {
       btnLogout.onclick = function() {
         localStorage.removeItem('jwtToken');
         jwtToken = null;
         location.reload();
       };
     }
     
     // Agregar evento para bot√≥n de contexto
     const btnShowMyContext = document.getElementById('btnShowMyContext');
     if (btnShowMyContext) {
       btnShowMyContext.onclick = toggleLeaderboardView;
     }
   });
  // Leaderboard eliminado en PARTE6-ES
  // Backend sync system
  let xpPoints = 0;
  // ...existing code...
  let unlockedUnits = [];
  let nivel2Unlocked = false;
  let streak = 0;
  let lastChallengeAt = null;
  let jwtToken = null;
  // Recuperar token de localStorage si existe
  if(localStorage.getItem('jwtToken')) {
    jwtToken = localStorage.getItem('jwtToken');
    if(localStorage.getItem('username')) {
      window.username = localStorage.getItem('username');
    }
  }

  // Funci√≥n para inicializar caracteres faltantes desde el backend
  // FUNCI√ìN initializeCharactersIfNeeded COMENTADA - NO SE USA EN VERSI√ìN LOCAL
  /*
  async function initializeCharactersIfNeeded() {
    if(!jwtToken) return;
    
    // Si no hay cartas o hay muy pocas, llamar al backend para inicializarlas
    if(!cards || cards.length < 10) {
      try {
        const res = await fetch(`${window.API_BASE}/api/initialize-chars`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': jwtToken
          }
        });
        
        if(res.ok) {
          const data = await res.json();
          console.log('Caracteres inicializados:', data.message, 'Total:', data.totalCharacters);
          // Recargar el estado del usuario para obtener los caracteres actualizados
          await loadUserState(jwtToken);
        }
      } catch(e) {
        console.error('Error inicializando caracteres:', e);
      }
    }
  }
  */

  // Cargar estado del usuario desde localStorage
  async function loadUserState(token) {
    jwtToken = token;
    const saved = localStorage.getItem('v10_flashcards_data');
    
    if(saved) {
      try {
        const data = JSON.parse(saved);
        xpPoints = data.xp || 0;
        cards = data.knownChars || [];
        unlockedUnits = data.unlockedUnits || [];
        nivel2Unlocked = !!data.nivel2Unlocked;
        streak = data.streak || 0;
        lastChallengeAt = data.lastChallengeAt || null;
        
        console.log('‚úÖ Datos cargados desde localStorage');
        
        // Mostrar Nivel 2 si est√° desbloqueado
        if(nivel2Unlocked) {
          console.log('üîì Nivel 2 ya estaba desbloqueado, mostrando bot√≥n...');
          setTimeout(() => showNivel2Button(), 100);
        }
      } catch(e) {
        console.error('Error parseando localStorage:', e);
        // Inicializar valores por defecto
        xpPoints = 0;
        cards = [];
        unlockedUnits = [];
        nivel2Unlocked = false;
        streak = 0;
        lastChallengeAt = null;
      }
    } else {
      // Si no hay datos, inicializar valores por defecto
      xpPoints = 0;
      cards = [];
      unlockedUnits = [];
      nivel2Unlocked = false;
      streak = 0;
      lastChallengeAt = null;
      console.log('üì¶ Primera vez, datos inicializados');
    }
  }

  // Guardar estado del usuario en localStorage
  async function saveUserState() {
    if(!jwtToken) return;
    
    const data = {
      xp: xpPoints,
      knownChars: cards,
      unlockedUnits,
      nivel2Unlocked,
      streak,
      lastChallengeAt
    };
    
    localStorage.setItem('v10_flashcards_data', JSON.stringify(data));
    console.log('üíæ Datos guardados en localStorage');
  }

  // Reemplazar funciones locales
  function saveXP() { saveUserState(); }
  function loadXP() { /* XP se carga con loadUserState */ }
  function xpForLevel(level) {
    // Level 1: 10, Level 2: 50, Level 3: 100, Level 4: 200, Level 5: 300, etc.
    if(level === 1) return 10;
    if(level === 2) return 50;
    if(level === 3) return 100;
    return (level - 1) * 100;
  }
  function getCurrentLevel(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    return lvl;
  }
  function getLevelProgress(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    // xpNeeded: lo que requiere este nivel
    // total: xp acumulado hasta el nivel anterior
    return {
      lvl,
      prev: total,
      next: total + xpNeeded,
      progress: xp - total,
      needed: (total + xpNeeded) - xp,
      percent: Math.max(0, Math.min(100, ((xp - total) / xpNeeded) * 100))
    };
  }
  // Colores por nivel
  const xpColors = [
    // Celeste claro ‚Üí verde claro ‚Üí naranja
    {bar:'#7dd3fc', text:'#7dd3fc', bg:'#bae6fd', glow:'#e0f2fe'}, // 1 celeste claro
    {bar:'#38bdf8', text:'#38bdf8', bg:'#a5f3fc', glow:'#bae6fd'}, // 2 celeste
    {bar:'#5eead4', text:'#5eead4', bg:'#a7f3d0', glow:'#d1fae5'}, // 3 verde agua
    {bar:'#34d399', text:'#34d399', bg:'#bbf7d0', glow:'#d1fae5'}, // 4 verde claro
    {bar:'#fbbf24', text:'#fbbf24', bg:'#fef9c3', glow:'#fde68a'}, // 5 amarillo-naranja
    {bar:'#fb923c', text:'#fb923c', bg:'#fed7aa', glow:'#fdba74'}, // 6 naranja claro
    {bar:'#f97316', text:'#f97316', bg:'#fdba74', glow:'#fb923c'}, // 7 naranja
    {bar:'#ea580c', text:'#ea580c', bg:'#fb923c', glow:'#f97316'}, // 8 naranja intenso
  ];
  let lastLevel = null;
  function renderXPBar(levelUpAnim=false) {
    const { lvl, needed, percent } = getLevelProgress(xpPoints);
    const oldPercent = parseInt(document.getElementById('xpBar').style.width) || 0;
    
    document.getElementById('xpLevel').textContent = lvl;
    document.getElementById('xpBar').style.width = percent+"%";
    document.getElementById('xpToNext').textContent = `Faltan ${needed} xp para subir Ê∞¥Âπ≥`;
    
    // Colores por nivel
    const color = xpColors[(lvl-1)%xpColors.length];
    const xpBar = document.getElementById('xpBar');
    const xpBarWrap = document.getElementById('xpBarWrap');
    const xpLevel = document.getElementById('xpLevel');
    const xpToNext = document.getElementById('xpToNext');
    xpBar.style.background = color.bar;
    xpBarWrap.querySelector('.w-full').style.background = color.bg;
    xpLevel.style.color = color.text;
    xpToNext.style.color = color.text;
    const xpLabel = document.getElementById('xpLabel');
    if(xpLabel) xpLabel.style.color = color.text;
    const btnResetXP = document.getElementById('btnResetXP');
    if(btnResetXP) {
      btnResetXP.style.background = '#1e293b'; // azul oscuro
      btnResetXP.style.color = '#fff';
      btnResetXP.style.borderColor = '#1e293b';
    }
    // Set CSS vars for glow
    xpBar.style.setProperty('--xp-bar', color.bar);
    xpBar.style.setProperty('--xp-glow', color.glow);
    xpBarWrap.style.setProperty('--xp-glow', color.glow);
    
    // Animaci√≥n de brillo al subir de nivel y sonido de triunfo
    if(levelUpAnim) {
      xpBar.classList.add('xp-glow-anim');
      xpBarWrap.classList.add('xp-glow-anim-bg');
      soundLevelUpTrumpet();
      
      // IMPORTANTE: No bloquear la funcionalidad durante level up
      setTimeout(()=>{
        xpBar.classList.remove('xp-glow-anim');
        xpBarWrap.classList.remove('xp-glow-anim-bg');
      }, 1200);
    } 
    // Part√≠culas de progreso cuando hay avance pero NO level up
    else if (percent > oldPercent) {
      createXPParticles(color.bar);
    }
    
    lastLevel = lvl;
  }

  // Funci√≥n para crear part√≠culas de XP
  function createXPParticles(color) {
    const xpBar = document.getElementById('xpBar');
    if (!xpBar) return;
    
    const barRect = xpBar.getBoundingClientRect();
    const particleCount = 6; // N√∫mero de part√≠culas
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'xp-particle';
      particle.style.background = color;
      
      // Posici√≥n inicial: extremo derecho de la barra
      particle.style.left = '100%';
      particle.style.top = '50%';
      particle.style.marginLeft = '-2px';
      particle.style.marginTop = '-2px';
      
      // Variables CSS personalizadas para cada part√≠cula
      const randomX = Math.random() * 60 - 30; // -30 a +30px
      const randomY = Math.random() * 50 + 20;  // 20 a 70px hacia arriba
      const randomX2 = randomX + (Math.random() * 40 - 20);
      const randomY2 = randomY + (Math.random() * 30 + 20);
      
      particle.style.setProperty('--particle-x', randomX + 'px');
      particle.style.setProperty('--particle-y', -randomY + 'px');
      particle.style.setProperty('--particle-x2', randomX2 + 'px');
      particle.style.setProperty('--particle-y2', -randomY2 + 'px');
      
      // Delay aleatorio para cada part√≠cula
      particle.style.animationDelay = (Math.random() * 200) + 'ms';
      particle.style.animation = 'xpParticleFloat 800ms ease-out forwards';
      
      xpBar.appendChild(particle);
      
      // Remover part√≠cula despu√©s de la animaci√≥n
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 1000);
    }
  }
  // CSS para animaci√≥n de brillo
  const xpGlowStyle = document.createElement('style');
  xpGlowStyle.textContent = `
    .xp-glow-anim {
      box-shadow: 0 0 24px 8px var(--xp-glow, #fff), 0 0 0 2px var(--xp-bar, #fff);
      animation: xpGlow 1.1s cubic-bezier(.4,2,.6,1);
    }
    .xp-glow-anim-bg {
      animation: xpGlowBG 1.1s cubic-bezier(.4,2,.6,1);
    }
    @keyframes xpGlow {
      0% { box-shadow: 0 0 0 0 var(--xp-glow, #fff); }
      40% { box-shadow: 0 0 32px 16px var(--xp-glow, #fff); }
      100% { box-shadow: 0 0 0 0 var(--xp-glow, #fff); }
    }
    @keyframes xpGlowBG {
      0% { filter: brightness(1.1); }
      40% { filter: brightness(1.7) drop-shadow(0 0 16px var(--xp-glow, #fff)); }
      100% { filter: brightness(1.1); }
    }

    /* Animaci√≥n de part√≠culas XP */
    .xp-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #0ea5e9;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
    }
    @keyframes xpParticleFloat {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(var(--particle-x, 20px), var(--particle-y, -20px)) scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: translate(var(--particle-x2, 40px), var(--particle-y2, -40px)) scale(0);
        opacity: 0;
      }
    }

    /* Animaci√≥n para botones que aparecen en m√≥vil */
    @keyframes mobileButtonFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mobile-fade-in {
      animation: mobileButtonFadeIn 300ms ease-out forwards;
    }

    @keyframes mobileButtonFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

    .mobile-fade-out {
      animation: mobileButtonFadeOut 400ms ease-in forwards;
    }
    
    /* CSS para fade-out selectivo */
    @keyframes fadeOutButtons {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.95); }
    }
    
    .quiz-fade-out {
      animation: fadeOutButtons 300ms ease-out forwards;
    }
    
    .quiz-fade-out-delayed {
      animation: fadeOutButtons 300ms ease-out forwards;
      animation-delay: 200ms;
    }
    
    /* Botones invisibles desde el inicio */
    .quiz-invisible {
      opacity: 0 !important;
      pointer-events: none;
    }
  `;
  document.head.appendChild(xpGlowStyle);
  const STORAGE_KEY = 'srs_unidades_v7_es';

  // Eliminada declaraci√≥n duplicada de cards
  let sessionQueue = [];
  let currentCard = null;
  let flipped = false;
  let todayReviewed = 0;
  let currentMission = ''; // 'unit2'..'unit9'|'known'|'revise1'|'revise2'|'challenge'
  let sessionTotal = 0;
  let sessionCorrect = 0;

  // Sistema de timer y vidas para desaf√≠os
  let challengeActive = false;
  let challengeTimeLeft = 90; // 90 segundos
  let challengeTimerInterval = null;
  let challengeHearts = 2; // 2 vidas

  // 'flash' | 'quizPinyin' | 'quizMeaning'
  let mode = 'flash';

  /* ========= DOM ========= */
  const bodyEl  = document.getElementById('body');
  const cardEl  = document.getElementById('card');
  const frontEl = document.getElementById('cardFront');
  const backEl  = document.getElementById('cardBack');

  const statInSession = document.getElementById('statInSession');
  const statToday     = document.getElementById('statToday');
  const statMission   = document.getElementById('statMission');
  const statBox       = document.getElementById('statBox');
  const streakBox = document.getElementById('streakBox');
  const streakCount = document.getElementById('streakCount');
  const streakStatus = document.getElementById('streakStatus');

  const flashRow = document.getElementById('flashRow');
  const quizRow  = document.getElementById('quizRow');

  const btnKnownBox   = document.getElementById('btnKnown');
  const btnRevise1Box = document.getElementById('btnRevise1');
  const btnRevise2Box = document.getElementById('btnRevise2');

  /* Overlay conocidos */
  const knownOverlay  = document.getElementById('knownOverlay');
  const knownGrid     = document.getElementById('knownGrid');
  const knownCount    = document.getElementById('knownCount');

  /* ========= Utils ========= */
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function hoursSince(ts){ if(!ts) return null; const diffMs = Date.now() - ts; return Math.floor(diffMs / 3600000); }
  function saveAll(){ saveUserState(); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function dedupeByHanzi(rows){
    const seen = new Set(); const out = [];
    for(const r of rows){ const key = r[0]; if(seen.has(key)) continue; seen.add(key); out.push(r); }
    return out;
  }

  /* ========= Audio (WebAudio) ========= */

  // Pool de audio para sonidos correctos (m√∫ltiples instancias)
  let correctSoundPool = [];
  let poolIndex = 0;
  const POOL_SIZE = 3;

  // Inicializar pool de sonidos
  function initCorrectSoundPool() {
    correctSoundPool = [];
    for(let i = 0; i < POOL_SIZE; i++) {
      try {
        const audio = new Audio('music/soundcorrect.mp3');
        audio.volume = 0.4;
        audio.preload = 'auto';
        correctSoundPool.push(audio);
      } catch(e) {
        console.log('Error creando audio pool:', e);
        break;
      }
    }
    console.log(`Pool de audio correcto inicializado: ${correctSoundPool.length} instancias`);
  }

  // Obtener pr√≥xima instancia de audio del pool
  function getNextCorrectSound() {
    if(correctSoundPool.length === 0) {
      console.log('Pool vac√≠o, reinicializando...');
      initCorrectSoundPool();
      if(correctSoundPool.length === 0) return null;
    }
    const sound = correctSoundPool[poolIndex];
    poolIndex = (poolIndex + 1) % correctSoundPool.length;
    return sound;
  }

  // Reinicializar pool si hay problemas
  function refreshCorrectSoundPool() {
    console.log('Refrescando pools de audio...');
    correctSoundPool = [];
    poolIndex = 0;
    celebrationSoundPool = [];
    celebrationSoundIndex = 0;
    initCorrectSoundPool();
    initCelebrationSoundPool();
  }

  /* ========= M√∫sica de fondo para modo desaf√≠o ========= */
  let desafioMusic = null;
  function playDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
    }
    desafioMusic = new Audio('music/track1.mp3');
    desafioMusic.loop = true;
    desafioMusic.volume = 0.23;
    desafioMusic.play();
  }
  function stopDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
      desafioMusic = null;
    }
  }
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  async function ensureAudio(){ try { if(audioCtx.state !== 'running') await audioCtx.resume(); } catch(e){} }
  function beep(freq=440, duration=0.12, type='sine', gain=0.05){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    o.stop(audioCtx.currentTime + duration);
  }
  
  function soundCorrect(){
    // Usar pool de audio para m√°xima confiabilidad
    const sound = getNextCorrectSound();
    if (sound) {
      try {
        sound.currentTime = 0; // Reiniciar si ya estaba reproduci√©ndose
        sound.play().catch(e => {
          console.log('Error con audio del pool, intentando con nueva instancia:', e);
          // Intentar crear nueva instancia si falla
          try {
            const newAudio = new Audio('music/soundcorrect.mp3');
            newAudio.volume = 0.4;
            newAudio.play().catch(() => {
              // Fallback final a sonido sint√©tico
              beep(1397, 0.11, 'triangle', 0.16); // F6
              beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
            });
          } catch(e2) {
            // Fallback inmediato
            beep(1397, 0.11, 'triangle', 0.16); // F6
            beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
          }
        });
      } catch(e) {
        // Fallback inmediato
        beep(1397, 0.11, 'triangle', 0.16); // F6
        beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
      }
    } else {
      // Si no hay pool disponible, fallback inmediato
      beep(1397, 0.11, 'triangle', 0.16); // F6
      beep(2093, 0.13, 'triangle', 0.13); // C7 simult√°neo
    }
  }

  // Pool de audios para celebraci√≥n (similar al de correcto)
  let celebrationSoundPool = [];
  let celebrationSoundIndex = 0;
  
  function initCelebrationSoundPool() {
    celebrationSoundPool = [];
    for(let i = 0; i < 3; i++) {
      try {
        const audio = new Audio('music/complete.mp3');
        audio.volume = 0.5; // Volumen un poco m√°s alto para celebraci√≥n
        audio.preload = 'auto';
        celebrationSoundPool.push(audio);
      } catch(e) {
        console.log('Error creando audio de celebraci√≥n:', e);
      }
    }
  }

  // Sonido de celebraci√≥n para x/x correctas
  function soundCelebration(){
    try {
      if(celebrationSoundPool.length === 0) {
        initCelebrationSoundPool();
      }
      
      const audio = celebrationSoundPool[celebrationSoundIndex];
      celebrationSoundIndex = (celebrationSoundIndex + 1) % celebrationSoundPool.length;
      
      if(audio) {
        audio.currentTime = 0; // Reiniciar desde el principio
        audio.play().catch(e => {
          console.log('Error reproduciendo celebraci√≥n:', e);
          // Fallback a sonido sint√©tico
          fallbackCelebrationSound();
        });
      } else {
        fallbackCelebrationSound();
      }
    } catch(e) {
      console.log('Error en soundCelebration:', e);
      fallbackCelebrationSound();
    }
  }
  
  function fallbackCelebrationSound() {
    // Sonido sint√©tico de respaldo
    beep(523, 0.14, 'triangle', 0.19); // C5
    setTimeout(() => beep(659, 0.13, 'triangle', 0.17), 60); // E5
    setTimeout(() => beep(784, 0.13, 'triangle', 0.15), 120); // G5
    setTimeout(() => beep(1046, 0.11, 'triangle', 0.13), 180); // C6
    setTimeout(() => beep(1568, 0.09, 'triangle', 0.11), 240); // G6
    setTimeout(() => beep(2093, 0.18, 'triangle', 0.13), 320); // C7
  }
  function soundWrong(){
    // Efecto digital tipo "fart" corto
    // Secuencia descendente y distorsionada
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(110, ctx.currentTime);
  o.frequency.linearRampToValueAtTime(55, ctx.currentTime + 0.18);
  g.gain.setValueAtTime(0.108, ctx.currentTime); // -40%
  g.gain.linearRampToValueAtTime(0.006, ctx.currentTime + 0.18); // -40%
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.19);
    // "pop" final
  setTimeout(() => beep(70, 0.07, 'triangle', 0.038), 170); // -40%
  }

  /* ========= Datasets (ES) ========= */
  // Unidad 2
  function unit2Sample(){
    return [
      ['‰∏Ä','yƒ´','uno','unit2','S'],
      ['‰∫å','√®r','dos','unit2','S'],
      ['‰∏â','sƒÅn','tres','unit2','S'],
      ['Âõõ','s√¨','cuatro','unit2','S'],
      ['‰∫î','w«î','cinco','unit2','S'],
      ['ÂÖ≠','li√π','seis','unit2','S'],
      ['‰∏É','qƒ´','siete','unit2','S'],
      ['ÂÖ´','bƒÅ','ocho','unit2','S'],
      ['‰πù','ji«î','nueve','unit2','S'],
      ['ÂçÅ','sh√≠','diez','unit2','S'],
      ['Ë∞¢Ë∞¢','xi√®xie','gracias','unit2','E'],
      ['‰∏çÂÆ¢Ê∞î','b√∫ k√®qi','de nada','unit2','E'],
      ['ÂØπ‰∏çËµ∑','du√¨buq«ê','perd√≥n / lo siento','unit2','E'],
      ['Ê≤°ÂÖ≥Á≥ª','m√©iguƒÅnxi','no pasa nada','unit2','E'],
      ['Â§ßÂÆ∂Â•Ω','d√†jiƒÅ h«éo','hola a todos','unit2','E'],
    ];
  }
  // Unidad 3
  function unit3Sample(){
    return [
      ['‰Ω†','n«ê','t√∫','unit3','P'],
      ['Êàë','w«í','yo','unit3','P'],
      ['ÊòØ','sh√¨','ser','unit3','V'],
      ['Âæà','hƒõn','muy','unit3','E'],
      ['È´òÂÖ¥','gƒÅox√¨ng','contento / feliz','unit3','A'],
      ['ËÆ§ËØÜ','r√®nshi','conocer','unit3','V'],
      ['Âë¢','ne','part√≠cula de seguimiento','unit3','E'],
      ['Âêó','ma','part√≠cula interrogativa','unit3','E'],
      ['‰πü','yƒõ','tambi√©n','unit3','E'],
      ['ÊÇ®','n√≠n','usted (formal)','unit3','P'],
      ['ÂñúÊ¨¢','x«êhuan','gustar','unit3','V'],
      ['Â≠¶','xu√©','aprender / estudiar','unit3','V'],
      ['Ê±âËØ≠','h√†ny«î','chino (idioma)','unit3','S'],
      ['Â≠¶Áîü','xu√©sheng','estudiante','unit3','S'],
      ['ËÄÅÂ∏à','l«éoshƒ´','profesor','unit3','S'],
      ['ÂÜçËßÅ','z√†iji√†n','adi√≥s','unit3','E'],
    ];
  }
  // Unidad 4
  function unit4Sample(){
    return [
      ['Âè´','ji√†o','llamarse / llamar','unit4','V'],
      ['‰ªÄ‰πà','sh√©nme','qu√©','unit4','E'],
      ['ÂêçÂ≠ó','m√≠ngzi','nombre','unit4','S'],
      ['Â§öÂ§ß','du≈çd√†','qu√© edad / cu√°n grande','unit4','E'],
      ['Â≤Å','su√¨','a√±os (de edad)','unit4','S'],
      ['‰∫∫','r√©n','persona / gente','unit4','S'],
      ['‰∏≠ÂõΩ','Zh≈çnggu√≥','China','unit4','S'],
      ['‰∏ç','b√π','no (negaci√≥n)','unit4','E'],
      ['Âì™','n«é','cu√°l (de) / qu√© lugar','unit4','E'],
    ];
  }
  // Unidad 5
  function unit5Sample(){
    return [
      ['ÊÉ≥','xi«éng','querer / pensar','unit5','V'],
      ['ÂêÉ','chƒ´','comer','unit5','V'],
      ['ÂÅö','zu√≤','hacer','unit5','V'],
      ['È•≠','f√†n','comida','unit5','S'],
      ['Âñù','hƒì','beber','unit5','V'],
      ['Ëå∂','ch√°','t√©','unit5','S'],
      ['Ê∞¥','shu«ê','agua','unit5','S'],
      ['ÂíñÂï°','kƒÅfƒìi','caf√© (bebida)','unit5','S'],
      ['ËØ¥','shu≈ç','hablar / decir','unit5','V'],
      ['Âî±','ch√†ng','cantar','unit5','V'],
      ['Ê≠å','gƒì','canci√≥n','unit5','S'],
      ['Áúã','k√†n','ver / mirar','unit5','V'],
      ['‰π¶','sh≈´','libro','unit5','S'],
      ['ÁîµÂΩ±','di√†ny«êng','pel√≠cula','unit5','S'],
      ['ÁîµËßÜÂâß','di√†nsh√¨j√π','serie de TV','unit5','S'],
      ['Âê¨','tƒ´ng','escuchar','unit5','V'],
      ['Èü≥‰πê','yƒ´nyu√®','m√∫sica','unit5','S'],
    ];
  }
  // Unidad 6
  function unit6Sample(){
    return [
      ['‰ªñ','tƒÅ','√©l','unit6','P'],
      ['Â•π','tƒÅ','ella','unit6','P'],
      ['‰ª¨','men','sufijo plural','unit6','E'],
      ['Ë∞Å','sh√©i','qui√©n','unit6','E'],
      ['ÁöÑ','de','part√≠cula posesiva','unit6','E'],
      ['ÊúãÂèã','p√©ngyou','amigo / amiga','unit6','S'],
      ['Áî∑','n√°n','hombre / masculino','unit6','S'],
      ['Â•≥','n«ö','mujer / femenino','unit6','S'],
      ['Áà∏Áà∏','b√†ba','pap√°','unit6','S'],
      ['Â¶àÂ¶à','mƒÅma','mam√°','unit6','S'],
      ['Âì•Âì•','gƒìge','hermano mayor','unit6','S'],
      ['ÂºüÂºü','d√¨di','hermano menor','unit6','S'],
      ['ÂßêÂßê','jiƒõjie','hermana mayor','unit6','S'],
      ['ÂèØÁà±','kƒõ‚Äô√†i','tierno / adorable','unit8','A'],
      ['ÊúâÂêç','y«íum√≠ng','famoso','unit8','A'],
      ['Êµ™Êº´','l√†ngm√†n','rom√°ntico','unit8','A'],
      ['ÊÑüÂä®‰∫∫','g«énd√≤ng r√©n','conmovedor','unit8','A'],
      ['Ê£í','b√†ng','genial','unit8','A'],
      ['ÈÖ∑','k√π','cool','unit8','A'],
      ['Êúâ','y«íu','haber / tener','unit8','V'],
      ['Âíå','h√©','y (conjunci√≥n)','unit8','E'],
      ['Ê≤°','m√©i','no hay / no tener','unit8','E'],
    ];
  }
  // Unidad 7
  function unit7Sample(){
    return [
      ['ÁâπÂà´','t√®bi√©','especialmente / muy','unit7','E'],
      ['ÈùûÂ∏∏','fƒìich√°ng','muy / much√≠simo','unit7','E'],
      ['ËßâÂæó','ju√©de','creer / opinar / sentir que','unit7','V'],
      ['ÊÄé‰πàÊ†∑','zƒõnmey√†ng','qu√© tal','unit7','E'],
      ['Â•ΩÁúã','h«éok√†n','bonito (de ver)','unit7','A'],
      ['Â•ΩÂêÉ','h«éochƒ´','rico (de comer)','unit7','A'],
      ['Â•ΩÂê¨','h«éotƒ´ng','agradable de o√≠r','unit7','A'],
      ['ÊúâÊÑèÊÄù','y«íuy√¨si','interesante','unit7','A'],
      ['Ëøô','zh√®','este / esta','unit7','P'],
      ['ÈÇ£','n√†','ese / esa / aquel','unit7','P'],
      ['‰∏™','g√®','clasificador general','unit7','E'],
      ['Êú¨','bƒõn','clasificador de libros','unit7','E'],
      ['È¶ñ','sh«íu','clasificador de canciones','unit7','E'],
      ['ÊùØ','bƒìi','clasificador: vaso / taza','unit7','E'],
    ];
  }
  // Unidad 8
  function unit8Sample(){
    return [
      ['‰∏∫‰ªÄ‰πà','w√®ish√©nme','por qu√©','unit8','E'],
      ['Âõ†‰∏∫','yƒ´nw√®i','porque','unit8','E'],
      ['ÊºîÂëò','y«ényu√°n','actor / actriz','unit8','S'],
      ['Ê≠åÊâã','gƒìsh«íu','cantante','unit8','S'],
      ['ÁΩëÁ∫¢','w«éngh√≥ng','influencer','unit8','S'],
      ['ÂèØÁà±','kƒõ\'√†i','tierno / adorable','unit8','A'],
      ['ÊúâÂêç','y«íum√≠ng','famoso','unit8','A'],
      ['Êµ™Êº´','l√†ngm√†n','rom√°ntico','unit8','A'],
      ['ÊÑüÂä®‰∫∫','g«énd√≤ng r√©n','conmovedor','unit8','A'],
      ['Ê£í','b√†ng','genial','unit8','A'],
      ['ÈÖ∑','k√π','cool','unit8','A'],
      ['Êúâ','y«íu','haber / tener','unit8','V'],
      ['Âíå','h√©','y (conjunci√≥n)','unit8','E'],
      ['Ê≤°','m√©i','no hay / no tener','unit8','E'],
    ];
  }
  // Unidad 9
  function unit9Sample(){
    return [
      ['Âú®','z√†i','estar / en','unit9','V'],
      ['ÂÆ∂','jiƒÅ','casa / hogar','unit9','S'],
      ['Â≠¶Ê†°','xu√©xi√†o','escuela','unit9','S'],
      ['ÁîµÂΩ±Èô¢','di√†ny«êngyu√†n','cine','unit9','S'],
      ['ÂïÜÂ∫ó','shƒÅngdi√†n','tienda','unit9','S'],
      ['ÂíñÂï°Â∫ó','kƒÅfƒìi di√†n','cafeter√≠a','unit9','S'],
      ['È•≠Â∫ó','f√†ndi√†n','restaurante / hotel','unit9','S'],
      ['Ë∂ÖÂ∏Ç','chƒÅosh√¨','supermercado','unit9','S'],
      ['ÂÖ¨Âõ≠','g≈çngyu√°n','parque','unit9','S'],
      ['Â∑•‰Ωú','g≈çngzu√≤','trabajar / trabajo','unit9','V'],
      ['‰π∞','m«éi','comprar','unit9','V'],
      ['‰∏úË•ø','d≈çngxi','cosas / objetos','unit9','S'],
      ['ËøôÂÑø','zh√®r','aqu√≠','unit9','P'],
      ['ÈÇ£ÂÑø','n√†r','all√≠','unit9','P'],
      ['Âì™ÂÑø','n«ér','d√≥nde','unit9','E'],
      ['ÊâãÊú∫','sh«íujƒ´','tel√©fono m√≥vil','unit9','S'],
      ['ÁîµËÑë','di√†nn«éo','computadora','unit9','S'],
    ];
  }

  // Nivel 2
  function unit2N2Sample(){
    return [
      ['Êó©‰∏ä','z«éoshang','ma√±ana','unit2N2','S'],['‰∏ãÂçà','xi√†w«î','tarde','unit2N2','S'],['Êôö‰∏ä','w«énshang','noche','unit2N2','S'],['‰∏≠Âçà','zh≈çngw«î','mediod√≠a','unit2N2','S'],['‰ªäÂ§©','jƒ´ntiƒÅn','hoy','unit2N2','S'],['ÊòéÂ§©','m√≠ngtiƒÅn','ma√±ana (d√≠a siguiente)','unit2N2','S'],['Áé∞Âú®','xi√†nz√†i','ahora','unit2N2','S'],['‰∏Ä‰ºöÂÑø','y√≠hu√¨r','un rato','unit2N2','S'],['Âá†ÁÇπ','j«êdi«én','qu√© hora','unit2N2','E'],['Âçä','b√†n','media','unit2N2','S'],['ÂàÜ','fƒìn','minuto','unit2N2','S'],['Áù°Ëßâ','shu√¨ji√†o','dormir','unit2N2','V'],['‰ªÄ‰πàÊó∂ÂÄô','sh√©nme sh√≠hou','cu√°ndo','unit2N2','E']
    ];
  }
  function unit3N2Sample(){
    return [
      ['Â§öÂ∞ë','du≈çshao','cu√°nto','unit3N2','E'],['Èí±','qi√°n','dinero','unit3N2','S'],['ÊÉ≥Ë¶Å','xi«éngy√†o','querer','unit3N2','V'],['ËØ∑ÈóÆ','q«êngw√®n','disculpe','unit3N2','P'],['ÂùóÈí±','ku√†iqi√°n','yuan','unit3N2','S'],['ÂÖÉ','yu√°n','yuan','unit3N2','S'],['Áôæ','b«éi','cien','unit3N2','S'],['Ë¥µ','gu√¨','caro','unit3N2','A'],['‰æøÂÆú','pi√°nyi','barato','unit3N2','A'],['ÁâõÂ•∂','ni√∫n«éi','leche','unit3N2','S'],['Â•∂Ëå∂','n«éich√°','t√© con leche','unit3N2','S'],['ËØ∑ÂÆ¢','q«êngk√®','invitar','unit3N2','V'],['ËßÅ','ji√†n','ver','unit3N2','V'],['ÂºÄÂßã','kƒÅish«ê','empezar','unit3N2','V'],['Âéª','q√π','ir','unit3N2','V'],['ÂõûÂÆ∂','hu√≠jiƒÅ','volver a casa','unit3N2','V'],['Âêß','ba','part√≠cula sugerencia','unit3N2','P'],['ÁªøËå∂','l«úch√°','t√© verde','unit3N2','S'],['Á∫¢Ëå∂','h√≥ngch√°','t√© rojo','unit3N2','S']
    ];
  }
  function unit4N2Sample(){
    return [
      ['ÊØî','b«ê','comparar','unit4N2','V'],['ÊØîËæÉ','b«êji√†o','comparar','unit4N2','V'],['‰∏âÊòéÊ≤ª','sƒÅnm√≠ngzh√¨','s√°ndwich','unit4N2','S'],['ËõãÁ≥ï','d√†ngƒÅo','pastel','unit4N2','S'],['Èù¢ÂåÖ','mi√†nbƒÅo','pan','unit4N2','S'],['ÁÇπÂøÉ','di«énxƒ´n','snack','unit4N2','S'],['‰∏ÄÊ†∑','y√≠y√†ng','igual','unit4N2','A'],['È´ò','gƒÅo','alto','unit4N2','A'],['ÁüÆ','«éi','bajo','unit4N2','A'],['Â§ß','d√†','grande','unit4N2','A'],['Â∞è','xi«éo','peque√±o','unit4N2','A']
    ];
  }
  function unit5N2Sample(){
    return [
      ['Âπ¥','ni√°n','a√±o','unit5N2','S'],['Êúà','yu√®','mes','unit5N2','S'],['Âè∑','h√†o','n√∫mero','unit5N2','S'],['Êó•','r√¨','d√≠a','unit5N2','S'],['ÊòüÊúüÂ§©','xƒ´ngqƒ´tiƒÅn','domingo','unit5N2','S'],['ÊòüÊúüÂÖ≠','xƒ´ngqƒ´li√π','s√°bado','unit5N2','S'],['Âë®Êú´','zh≈çum√≤','fin de semana','unit5N2','S'],['ÊòüÊúü','xƒ´ngqƒ´','semana','unit5N2','S'],['ÊòüÊúüÂá†','xƒ´ngqƒ´j«ê','qu√© d√≠a de la semana','unit5N2','E'],['Âá†Êúà','j«êyu√®','qu√© mes','unit5N2','E'],['Âá†Âè∑','j«êh√†o','qu√© n√∫mero','unit5N2','E'],['‰ªäÂπ¥','jƒ´nni√°n','este a√±o','unit5N2','S'],['ÊòéÂπ¥','m√≠ngni√°n','el a√±o que viene','unit5N2','S'],['‰∏ã‰∏™','xi√†ge','el siguiente','unit5N2','P'],['ÁîüÊó•','shƒìngr√¨','cumplea√±os','unit5N2','S'],['Âø´‰πê','ku√†il√®','feliz','unit5N2','A'],['Á©∫','k√≤ng','libre','unit5N2','A'],['Á•ù‰Ω†','zh√π n«ê','te deseo','unit5N2','V']
    ];
  }
  function unit6N2Sample(){
    return [
      ['Ë∑ü','gƒìn','con','unit6N2','P'],['‰∏ÄËµ∑','y√¨q«ê','juntos','unit6N2','P'],['ËÆ°Âàí','j√¨hu√†','plan','unit6N2','S'],['ÊúâÁ©∫','y«íuk√≤ng','tener tiempo libre','unit6N2','A'],['Êù•','l√°i','venir','unit6N2','V'],['Ê≤°ÊúâÁ©∫','m√©iy«íu k√≤ng','no tener tiempo','unit6N2','A']
    ];
  }
  function unit7N2Sample(){
    return [
      ['ÂæÆ‰ø°','wƒìix√¨n','WeChat','unit7N2','S'],['‰ø°ÊÅØ','x√¨nxƒ´','mensaje','unit7N2','S'],['Âèë','fƒÅ','enviar','unit7N2','V'],['Âè∑Á†Å','h√†om«é','n√∫mero','unit7N2','S'],['ÁîµËØù','di√†nhu√†','tel√©fono','unit7N2','S'],['ÊâãÊú∫','sh«íujƒ´','m√≥vil','unit7N2','S'],['‰ø°ÊÅØ','x√¨nxƒ´','mensaje','unit7N2','S'],['ÊâìÁîµËØù','d«é di√†nhu√†','llamar por tel√©fono','unit7N2','V'],['Áªô','gƒõi','dar','unit7N2','V'],['ÊâãÊú∫Âè∑Á†Å','sh«íujƒ´ h√†om«é','n√∫mero de m√≥vil','unit7N2','S'],['ÂΩì','dƒÅng','ser','unit7N2','V'],['ÂèØ‰ª•','kƒõy«ê','poder','unit7N2','V'],['Èõ∂','l√≠ng','cero','unit7N2','S'],['Âπ∫','yƒÅo','uno (en n√∫meros)','unit7N2','S']
    ];
  }
  function unit8N2Sample(){
    return [
      ['ÈÉΩ','d≈çu','todos','unit8N2','P'],['Áü•ÈÅì','zhƒ´d√†o','saber','unit8N2','V'],['‰ºö','hu√¨','saber (habilidad)','unit8N2','V'],['‰∏ÄÁÇπÂÑø','y√¨di«énr','un poco','unit8N2','S'],['‰∏Ä‰∫õ','y√¨xiƒì','algunos','unit8N2','S'],['ÂºÄËΩ¶','kƒÅichƒì','conducir','unit8N2','V'],['Áî®','y√≤ng','usar','unit8N2','V'],['ÁîµËÑë','di√†nn«éo','computadora','unit8N2','S'],['Âï§ÈÖí','p√≠ji«î','cerveza','unit8N2','S'],['Á∫¢ÈÖí','h√≥ngji«î','vino tinto','unit8N2','S'],['ÁôΩÈÖí','b√°iji«î','licor blanco','unit8N2','S'],['È•ø','√®','hambriento','unit8N2','A'],['Ê∏¥','kƒõ','sediento','unit8N2','A'],['Á¥Ø','l√®i','cansado','unit8N2','A'],['ÊÄï','p√†','tener miedo','unit8N2','A'],['ÁîüÊ∞î','shƒìngq√¨','enojado','unit8N2','A']
    ];
  }
  function unit9N2Sample(){
    return [
      ['Ê°åÂ≠ê','zhu≈çzi','mesa','unit9N2','S'],['‰∏äÈù¢','sh√†ngmi√†n','encima','unit9N2','P'],['‰∏ãÈù¢','xi√†mi√†n','debajo','unit9N2','P'],['Ê§ÖÂ≠ê','y«êzi','silla','unit9N2','S'],['ÂâçÈù¢','qi√°nmi√†n','delante','unit9N2','P'],['ÂêéÈù¢','h√≤umi√†n','detr√°s','unit9N2','P'],['‰π¶ÂåÖ','sh≈´bƒÅo','mochila','unit9N2','S'],['ÈáåÈù¢','l«êmi√†n','dentro','unit9N2','P'],['Â§ñÈù¢','w√†imi√†n','fuera','unit9N2','P'],['ÂØπÈù¢','du√¨mi√†n','enfrente','unit9N2','P'],['Â∑¶Ëæπ','zu«íbiƒÅn','izquierda','unit9N2','P'],['Âè≥Ëæπ','y√≤ubiƒÅn','derecha','unit9N2','P'],['ÊóÅËæπ','p√°ngbiƒÅn','al lado','unit9N2','P'],['ÁõíÂ≠ê','h√©zi','caja','unit9N2','S']
    ];
  }
  function unit10N2Sample(){
    return [
      ['Â§©Ê∞î','tiƒÅnq√¨','clima','unit10N2','S'],['ÂÜ∑','lƒõng','fr√≠o','unit10N2','A'],['ÁÉ≠','r√®','calor','unit10N2','A'],['Êò®Â§©','zu√≥tiƒÅn','ayer','unit10N2','S'],['‰∏çÂÜ∑‰∏çÁÉ≠','b√π lƒõng b√π r√®','ni fr√≠o ni calor','unit10N2','A'],['Â§™‰∫Ü','t√†i le','demasiado','unit10N2','A'],['Âåó‰∫¨','Bƒõijƒ´ng','Beijing','unit10N2','S'],['‰∏äÊµ∑','Sh√†ngh«éi','Shanghai','unit10N2','S'],['ÂπøÂ∑û','Gu«éngzh≈çu','Guangzhou','unit10N2','S'],['È¶ôÊ∏Ø','XiƒÅngg«éng','Hong Kong','unit10N2','S'],['ËΩ¶','chƒì','auto','unit10N2','S'],['ÂÖ¨ÂÖ±Ê±ΩËΩ¶','g≈çngg√≤ng q√¨chƒì','autob√∫s','unit10N2','S'],['Âú∞ÈìÅ','d√¨tiƒõ','metro','unit10N2','S'],['ÁÅ´ËΩ¶','hu«íchƒì','tren','unit10N2','S'],['Âá∫ÁßüËΩ¶','ch≈´z≈´chƒì','taxi','unit10N2','S'],['Êª¥Êª¥','Dƒ´dƒ´','Didi (app)','unit10N2','S'],['È£ûÊú∫','fƒìijƒ´','avi√≥n','unit10N2','S'],['Ëàπ','chu√°n','barco','unit10N2','S'],['Âùê','zu√≤','sentarse / viajar en','unit10N2','V'],['È™ë','q√≠','montar','unit10N2','V'],['Ëá™Ë°åËΩ¶','z√¨x√≠ngchƒì','bicicleta','unit10N2','S'],['Êë©ÊâòËΩ¶','m√≥tu≈çchƒì','moto','unit10N2','S']
    ];
  }


  /* ========= Carga ========= */
  async function loadAll(){
    await loadUserState(jwtToken);
    
    // SIEMPRE inicializar todas las cartas desde las funciones para asegurar que todas las unidades est√©n disponibles
    const rows = dedupeByHanzi([
      ...unit2Sample(), ...unit3Sample(), ...unit4Sample(), ...unit5Sample(),
      ...unit6Sample(), ...unit7Sample(), ...unit8Sample(), ...unit9Sample(),
      ...unit2N2Sample(), ...unit3N2Sample(), ...unit4N2Sample(), ...unit5N2Sample(),
      ...unit6N2Sample(), ...unit7N2Sample(), ...unit8N2Sample(), ...unit9N2Sample(), ...unit10N2Sample()
    ]);
    
    // Si no hay cartas guardadas, crear nuevas
    if(!cards || cards.length === 0) {
      cards = rows.map(row => ({
        id: uid(),
        hanzi: row[0],
        pinyin: row[1],
        meaning: row[2],
        unit: row[3],
        cat: row[4],
        dkAddedAt: 0, revise1: false, revise2: false, known: false,
        challengeStreak: 0, challengeBest: 0, lastChallengeAt: 0,
        level: row[3].includes('N2') ? 2 : 1
      }));
      await saveUserState();
    } else {
      // Si hay cartas guardadas, actualizar/agregar las que falten y asegurar que el campo 'unit' exista
      const existingHanzi = new Set(cards.map(c => c.hanzi));
      const missingCards = rows.filter(row => !existingHanzi.has(row[0]));
      
      // Agregar cartas faltantes
      if(missingCards.length > 0) {
        const newCards = missingCards.map(row => ({
          id: uid(),
          hanzi: row[0],
          pinyin: row[1],
          meaning: row[2],
          unit: row[3],
          cat: row[4],
          dkAddedAt: 0, revise1: false, revise2: false, known: false,
          challengeStreak: 0, challengeBest: 0, lastChallengeAt: 0,
          level: row[3].includes('N2') ? 2 : 1
        }));
        cards = [...cards, ...newCards];
      }
      
      // Asegurar que todas las cartas tengan el campo 'unit'
      cards.forEach(card => {
        if(!card.unit) {
          const matchingRow = rows.find(row => row[0] === card.hanzi);
          if(matchingRow) {
            card.unit = matchingRow[3];
            card.level = matchingRow[3].includes('N2') ? 2 : 1;
          }
        }
      });
      
      await saveUserState();
    }
    
    // Asegurar que todos los caracteres est√©n inicializados
    // await initializeCharactersIfNeeded(); // COMENTADO - NO SE USA EN VERSI√ìN LOCAL
    
    // Renderizar barra de XP y stats con el valor correcto al cargar
    renderXPBar();
    updateStats();
    
    // Mostrar SIEMPRE el box y bot√≥n de Nivel 2 si nivel2Unlocked es true
    setTimeout(() => {
      console.log('üîç Verificando nivel2Unlocked:', nivel2Unlocked);
      const nivel2Row = document.getElementById('nivel2Row');
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      const nivel2Box = document.getElementById('nivel2Box');
      
      if(nivel2Unlocked){
        console.log('‚úÖ Mostrando Nivel 2...');
        if(nivel2Row) {
          nivel2Row.classList.remove('hidden');
          console.log('‚úÖ nivel2Row mostrado');
        }
        if(nivel2Wrap) {
          nivel2Wrap.style.display = '';
          console.log('‚úÖ nivel2Wrap mostrado');
        }
        if(btnNivel2) {
          btnNivel2.style.display = '';
          console.log('‚úÖ btnNivel2 mostrado');
        }
        if(nivel2Box) {
          nivel2Box.style.display = '';
          console.log('‚úÖ nivel2Box mostrado');
        }
      } else {
        console.log('‚ùå Nivel 2 no desbloqueado, ocultando...');
        if(nivel2Row) nivel2Row.classList.add('hidden');
        if(nivel2Wrap) nivel2Wrap.style.display = 'none';
        if(btnNivel2) btnNivel2.style.display = 'none';
        if(nivel2Box) nivel2Box.style.display = 'none';
      }
    }, 200);
    
    // Asegurar que est√© en el top despu√©s de cargar todo
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 300);
  }

  /* ========= L√≥gica ========= */
  function buildQueue(type){
      if(type==='todoN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit)));
      if(type==='desafioN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit))).slice(0,20);
      if(type==='unit2') return cards.filter(c=>c.unit==='unit2');
      if(type==='unit3') return cards.filter(c=>c.unit==='unit3');
      if(type==='unit4') return cards.filter(c=>c.unit==='unit4');
      if(type==='unit5') return cards.filter(c=>c.unit==='unit5');
      if(type==='unit6') return cards.filter(c=>c.unit==='unit6');
      if(type==='unit7') return cards.filter(c=>c.unit==='unit7');
      if(type==='unit8') return cards.filter(c=>c.unit==='unit8');
      if(type==='unit9') return cards.filter(c=>c.unit==='unit9');
      // Nivel 2
      if(type==='todoN2') return shuffle(cards.filter(c=>[
        'unit2N2','unit3N2','unit4N2','unit5N2','unit6N2','unit7N2','unit8N2','unit9N2','unit10N2'
      ].includes(c.unit)));
      if(type==='unit2N2') return cards.filter(c=>c.unit==='unit2N2');
      if(type==='unit3N2') return cards.filter(c=>c.unit==='unit3N2');
      if(type==='unit4N2') return cards.filter(c=>c.unit==='unit4N2');
      if(type==='unit5N2') return cards.filter(c=>c.unit==='unit5N2');
      if(type==='unit6N2') return cards.filter(c=>c.unit==='unit6N2');
      if(type==='unit7N2') return cards.filter(c=>c.unit==='unit7N2');
      if(type==='unit8N2') return cards.filter(c=>c.unit==='unit8N2');
      if(type==='unit9N2') return cards.filter(c=>c.unit==='unit9N2');
      if(type==='unit10N2') return cards.filter(c=>c.unit==='unit10N2');
      if(type==='known') return shuffle(cards.filter(c=>c.known));
      if(type==='revise1') return shuffle(cards.filter(c=>c.revise1));
      if(type==='revise2') return shuffle(cards.filter(c=>c.revise2));
      if(type==='challenge') return shuffle(cards.filter(c=>c.known)).slice(0,10);
      return [];
    }
  document.getElementById('btnDesafioN1').onclick = () => {
    const nivel1Box = document.getElementById('nivel1Box');
    if(nivel1Box) nivel1Box.classList.add('hidden');
    startMission('desafioN1');
  };
  document.getElementById('btnTodoN1').onclick = () => startMission('todoN1');

  /* ========= SISTEMA DE TIMER Y VIDAS PARA DESAF√çO ========= */
  function startChallengeTimer() {
    console.log('üöÄ startChallengeTimer() INICIADO');
    stopChallengeTimer(); // Limpiar timer anterior
    
    challengeActive = true;
    challengeTimeLeft = 90; // 90 segundos
    challengeHearts = 2; // 2 vidas
    console.log(`‚úÖ challengeActive=${challengeActive}, challengeHearts=${challengeHearts}`);
    showChallengeTimer();
    showChallengeHearts();
    
    challengeTimerInterval = setInterval(() => {
      if (!challengeActive) {
        stopChallengeTimer();
        return;
      }
      
      challengeTimeLeft--;
      updateChallengeTimer();
      
      if (challengeTimeLeft <= 0) {
        console.log('‚è∞ Tiempo agotado en desaf√≠o');
        stopChallengeTimer();
        showChallengeFailed('Tiempo agotado');
      }
    }, 1000);
    
    console.log('‚è±Ô∏è Timer de desaf√≠o iniciado: 90 segundos');
  }

  function showChallengeTimer() {
    hideChallengeTimer();
    
    const timerDisplay = document.createElement('div');
    timerDisplay.id = 'challengeTimer';
    timerDisplay.style.cssText = `
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 99998;
      background: rgba(0, 0, 0, 0.8);
      color: #FFD700;
      padding: 12px 16px;
      border-radius: 12px;
      fontSize: 18px;
      font-weight: bold;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(255, 69, 0, 0.4);
      font-family: 'Jersey 10', monospace;
      text-shadow: 1px 1px 0px #b8860b;
      letter-spacing: 1px;
      width: 120px;
      text-align: center;
      min-width: 120px;
      max-width: 120px;
    `;
    
    updateChallengeTimer();
    document.body.appendChild(timerDisplay);
    console.log('‚è∞ Timer de desaf√≠o mostrado');
  }

  function updateChallengeTimer() {
    const timerDisplay = document.getElementById('challengeTimer');
    if (!timerDisplay) return;
    
    const minutes = Math.floor(challengeTimeLeft / 60);
    const seconds = challengeTimeLeft % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    let icon = '‚è±Ô∏è';
    let bgStyle = 'rgba(0, 0, 0, 0.8)';
    let animationStyle = '';
    
    if (challengeTimeLeft <= 15) {
      icon = 'üö®';
      bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
      animationStyle = 'pulse 1s infinite';
    } else if (challengeTimeLeft <= 30) {
      icon = '‚ö†Ô∏è';
      bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
    }
    
    timerDisplay.style.background = bgStyle;
    timerDisplay.style.animation = animationStyle;
    timerDisplay.innerHTML = `${icon} ${timeString}`;
  }

  function stopChallengeTimer() {
    if (challengeTimerInterval) {
      clearInterval(challengeTimerInterval);
      challengeTimerInterval = null;
      console.log('‚è∞ Timer de desaf√≠o detenido');
    }
    challengeActive = false;
    hideChallengeTimer();
    hideChallengeHearts();
  }

  function hideChallengeTimer() {
    const timerDisplay = document.getElementById('challengeTimer');
    if (timerDisplay) {
      timerDisplay.remove();
      console.log('üôà Timer de desaf√≠o ocultado');
    }
  }

  function showChallengeHearts() {
    let heartsContainer = document.getElementById('challengeHeartsContainer');
    if (!heartsContainer) {
      heartsContainer = document.createElement('div');
      heartsContainer.id = 'challengeHeartsContainer';
      heartsContainer.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px 15px;
        border-radius: 20px;
        border: 2px solid #FFD700;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      `;
      document.body.appendChild(heartsContainer);
    }
    
    updateChallengeHearts();
    console.log('‚ù§Ô∏è Vidas de desaf√≠o mostradas');
  }

  function updateChallengeHearts() {
    const heartsContainer = document.getElementById('challengeHeartsContainer');
    console.log('‚ù§Ô∏è DEBUG updateChallengeHearts - container:', heartsContainer, 'hearts:', challengeHearts);
    if (!heartsContainer) return;
    
    let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: Jersey 10, monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
    heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
    
    for (let i = 0; i < 2; i++) {
      if (i < challengeHearts) {
        heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: Jersey 10, monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
      } else {
        heartsHTML += '<span style="color: #444; font-size: 18px; font-family: Jersey 10, monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
      }
    }
    
    heartsHTML += '</div>';
    heartsContainer.innerHTML = heartsHTML;
  }

  function hideChallengeHearts() {
    const heartsContainer = document.getElementById('challengeHeartsContainer');
    if (heartsContainer) {
      heartsContainer.remove();
      console.log('üôà Vidas de desaf√≠o ocultadas');
    }
  }

  function loseChallengeLife() {
    console.log(`üîç loseChallengeLife() llamada - challengeHearts ANTES: ${challengeHearts}`);
    if (challengeHearts > 0) {
      challengeHearts--;
      console.log(`üîª challengeHearts DECREMENTADO a: ${challengeHearts}`);
      updateChallengeHearts();
      console.log(`üíÄ Vida perdida en desaf√≠o! Vidas restantes: ${challengeHearts}`);
      
      if (challengeHearts <= 0) {
        console.log('‚ò†Ô∏è Sin vidas en desaf√≠o');
        stopChallengeTimer();
        showChallengeFailed('Sin vidas restantes');
      }
    } else {
      console.log(`‚ö†Ô∏è NO se decrement√≥ vida - challengeHearts ya es ${challengeHearts}`);
    }
  }

  function showChallengeFailed(razon) {
    challengeActive = false;
    stopChallengeTimer();
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      font-family: 'Jersey 10', monospace;
    `;
    
    modal.innerHTML = `
      <div style=\"
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 3px solid #ff6b6b;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
      \">
        <h2 style=\"
          color: #ff6b6b;
          font-size: 2em;
          margin-bottom: 15px;
          text-shadow: 2px 2px 0px #000;
        \">¬°DESAF√çO FALLIDO!</h2>
        <p style=\"
          color: #e0e0e0;
          font-size: 1.2em;
          margin-bottom: 20px;
        \">${razon}</p>
        <button id=\"closeChallengeFailedModal\" style=\"
          background: linear-gradient(135deg, #667eea, #764ba2);
          color: white;
          border: none;
          padding: 12px 30px;
          font-size: 1.1em;
          border-radius: 10px;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
          font-family: 'Jersey 10', monospace;
          font-weight: bold;
        \">CONTINUAR</button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('closeChallengeFailedModal').onclick = () => {
      modal.remove();
      location.reload();
    };
  }
  /* ========= FIN SISTEMA DE TIMER Y VIDAS ========= */

  function startMission(type){
    currentMission = type;
    sessionQueue = buildQueue(type).slice();
    todayReviewed = 0;
    sessionTotal = sessionQueue.length;
    sessionCorrect = 0;

    // LIMPIAR CLASES DE DESAF√çO AL INICIAR CUALQUIER MISI√ìN
    bodyEl.classList.remove('challenge-bg');
    statBox.classList.remove('challenge-stat');
    // DETENER M√öSICA DE DESAF√çO SI NO ES MODO DESAF√çO
    if(type !== 'challenge' && type !== 'desafioN1') {
      stopDesafioMusic();
    }
    
    // AUTO-SCROLL AL √ÅREA DE JUEGO EN M√ìVIL - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);

    // M√∫sica de fondo solo en modo desaf√≠o
    if(type==='challenge' || type==='desafioN1'){
      playDesafioMusic();
      setMode(type==='challenge' ? 'quizMeaning' : (Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin'));
      bodyEl.classList.add('challenge-bg');
      statBox.classList.add('challenge-stat');
      
      // Iniciar timer y vidas para desaf√≠os
      if(type==='challenge') {
        startChallengeTimer(); // Timer de 90 seg y 2 vidas para desaf√≠o cl√°sico
      } else if(type==='desafioN1') {
        startDesafioTimer(); // Timer existente para desaf√≠o N1
      }
      
      // Ocultar la tabla de conocidas y cerrar overlay si est√° abierto
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = 'none';
      const knownOverlay = document.getElementById('knownOverlay');
      if(knownOverlay) knownOverlay.remove();
    } else {
      stopDesafioMusic();
      stopChallengeTimer(); // Detener timer si cambiamos de modo
      setMode('flash');
      bodyEl.classList.remove('challenge-bg');
      statBox.classList.remove('challenge-stat');
      // Mostrar la tabla de conocidas
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = '';
    }

    nextCard();
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones al iniciar misi√≥n
  }

// --- Contador regresivo para desaf√≠o ---
let desafioTimer = null;
let desafioTimeLeft = 300; // 5 minutos en segundos
function startDesafioTimer(){
  clearDesafioTimer();
  desafioTimeLeft = 120;
  updateDesafioTimerUI();
  // Mostrar temporizador solo en modo desafioN1
  const statMission = document.getElementById('statMission');
  if(currentMission !== 'desafioN1') {
    removeDesafioTimerUI();
    return;
  }
  desafioTimer = setInterval(()=>{
    if(currentMission !== 'desafioN1') {
      clearDesafioTimer();
      return;
    }
    desafioTimeLeft--;
    updateDesafioTimerUI();
    if(desafioTimeLeft<=0){
      clearDesafioTimer();
      showDesafioPerdido();
      bloquearDesafio();
    }
  },1000);
}
function clearDesafioTimer(){
  if(desafioTimer){ clearInterval(desafioTimer); desafioTimer=null; }
  removeDesafioTimerUI();
}
function updateDesafioTimerUI(){
  // Solo mostrar si est√° en modo desafioN1
  if(currentMission !== 'desafioN1') {
    removeDesafioTimerUI();
    return;
  }
  const statMission = document.getElementById('statMission');
  if(statMission){
    const min = Math.floor(desafioTimeLeft/60).toString().padStart(2,'0');
    const sec = (desafioTimeLeft%60).toString().padStart(2,'0');
    statMission.textContent = `Tiempo: ${min}:${sec}`;
  }
}
function removeDesafioTimerUI(){
  const timerEl = document.getElementById('desafioTimer');
  if(timerEl) timerEl.remove();
}
function showDesafioPerdido(){
  let msg = document.getElementById('desafioPerdidoMsg');
  if(!msg){
    msg = document.createElement('div');
    msg.id = 'desafioPerdidoMsg';
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-rose-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.textContent = 'Te has quedado sin tiempo, perdiste el desaf√≠o';
  msg.onclick = () => { location.reload(); };
    document.body.appendChild(msg);
  }
  msg.style.opacity = '1';
}
function bloquearDesafio(){
  // Bloquear controles de desaf√≠o
  document.getElementById('cardWrap').style.pointerEvents = 'none';
  document.getElementById('flashRow').style.pointerEvents = 'none';
  // El usuario debe elegir otro modo para continuar
}

  function ensureReviseFlags(card){
    if(!card.dkAddedAt){ card.dkAddedAt = now(); }
    card.revise1 = true; card.revise2 = true; card.known = false;
  }

  /* ===== Feedback visual/sonoro y resaltado de cajas ===== */
  function pulseBox(el, colorClass){
    if(!el) return;
    el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal');
    void el.offsetWidth; // reflow para reiniciar animaci√≥n
    el.classList.add('pulseBadge', colorClass);
    setTimeout(()=>{ el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal'); }, 750);
  }
  async function feedbackCorrect(){
    await ensureAudio();
    
    // Reproducir sonido INMEDIATAMENTE junto con la animaci√≥n visual
    soundCorrect();
    
    cardEl.classList.remove('shakeAnim'); void cardEl.offsetWidth;
    cardEl.classList.add('popAnim');
    
    // Aplicar override para tarjetas especiales (pausar su glow y aplicar verde)
    if(cardEl.classList.contains('premium-gold') || 
       cardEl.classList.contains('mythic-violet') || 
       cardEl.classList.contains('legendary-red')) {
      cardEl.classList.add('correct-override');
      // Remover la clase despu√©s de la animaci√≥n
      setTimeout(() => {
        cardEl.classList.remove('correct-override');
      }, 420); // Misma duraci√≥n que popAnim
    }
    
    pulseBox(btnKnownBox, 'pulseGreen');
  }
  async function feedbackWrong(){
    await ensureAudio();
    cardEl.classList.remove('popAnim'); void cardEl.offsetWidth;
    soundWrong();
    pulseBox(btnRevise1Box, 'pulseAmber');
    pulseBox(btnRevise2Box, 'pulseTeal');
  }

  // Llama feedback y pasa a siguiente tras una breve pausa
  function respond(knew){
    if(knew) feedbackCorrect();
    else {
      // Todo el feedback visual y de estado a la vez
      feedbackWrong(); // sonido y glow
      cardEl.classList.add('cardWrong','shakeAnim'); // shake y fondo rojo
      // Si es incorrecto, agregar flags de repaso/confirmar inmediatamente
      if(currentCard) ensureReviseFlags(currentCard);
      
      // üî• PERDER VIDA EN MODO DESAF√çO
      console.log('üîç DEBUG respond(false) - currentMission:', currentMission, 'challengeActive:', challengeActive);
      if(currentMission === 'challenge' && challengeActive) {
        console.log('üíî Llamando loseChallengeLife() desde respond()');
        loseChallengeLife();
      } else {
        console.log('‚ö†Ô∏è NO se llam√≥ loseChallengeLife desde respond() - Condiciones no cumplidas');
      }
      
      setTimeout(()=>{
        cardEl.classList.add('cardWrongFade');
        // Fade out a las opciones tras 1s
        const quizBtns = Array.from(quizRow.children);
        quizBtns.forEach(b=>{
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
      }, 1500);
      setTimeout(()=>{
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
      }, 2000);
      return;
    }
    setTimeout(()=>{ answer(knew); }, 920); // Aumentado para que el glow dure m√°s
  }

  function answer(knew){
      if(!currentCard) return;
      const c = currentCard;
      console.log('üéØ answer() llamada - knew:', knew, 'currentMission:', currentMission, 'challengeActive:', challengeActive);

      if(currentMission==='challenge'){
        // actualizar racha y √∫ltima hora
        c.lastChallengeAt = now();
        console.log('üìä MODO CHALLENGE - Actualizando racha. knew:', knew);
        if(knew){
          // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
          if(cardEl.classList.contains('mythic-violet')){
            c.challengeStreak += 5;
            console.log('üî• RACHA +5 (m√≠tica violeta). Nueva racha:', c.challengeStreak);
          } else if(cardEl.classList.contains('premium-gold')){
            c.challengeStreak += 2;
            console.log('üî• RACHA +2 (premium gold). Nueva racha:', c.challengeStreak);
          } else {
            c.challengeStreak++;
            console.log('üî• RACHA +1 (normal). Nueva racha:', c.challengeStreak);
          }
          c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          console.log('‚úÖ challengeBest actualizado a:', c.challengeBest);
        } else {
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            c.known = false;
            c.challengeStreak = 0;
            // Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              knownChars[idx].known = false;
              knownChars[idx].challengeStreak = 0;
            }
          }
          c.challengeStreak = 0;
          ensureReviseFlags(c); // sale de conocidas -> repaso/confirmar
        }
      } else if(currentMission==='desafioN1'){
        // Solo afecta si ya est√° en conocidas
        if(c.known) {
          if(knew){
            // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
        // Si no est√° en conocidas, no suma ni modifica nada
      } else if(currentMission.startsWith('unit') || currentMission==='todoN1'){
        if(knew){ c.known = true; }
        else    { ensureReviseFlags(c); }
      } else if(currentMission==='known'){
        if(knew){ c.known = true; }
        else {
          // Solo agrega a revise1 y revise2, pero NO elimina de conocidas ni reinicia challengeStreak
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
          c.known = true; // Asegura que nunca se elimine de conocidas
          // NO modificar challengeStreak
        }
      } else if(currentMission==='revise1'){
        if(knew){ c.revise1 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1/revise2
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      } else if(currentMission==='revise2'){
        if(knew){ c.revise2 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1 y revise2
          if(!c.revise2) c.revise2 = true;
          if(!c.revise1) c.revise1 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      }

      if(knew) {
        sessionCorrect++;
        // Sumar XP si es modo quiz
        if(mode === 'quizPinyin' || mode === 'quizMeaning' || mode === 'quizHanzi') {
          const prevLevel = getCurrentLevel(xpPoints);
          xpPoints++;
          saveXP();
          const newLevel = getCurrentLevel(xpPoints);
          renderXPBar(newLevel > prevLevel);
        }
      }
      todayReviewed++;
      saveAll();
      nextCard();
    }

  function nextCard(){
    // DESTRUIR CASILLAS ANTES DEL FLIP (solo en m√≥vil para evitar titileo)
    if(isMobile()) {
      const quizRow = document.getElementById('quizRow');
      if(quizRow) {
        console.log('üßπ Destruyendo casillas ANTES del flip en m√≥vil');
        // Guardar altura para evitar saltos
        const currentHeight = quizRow.offsetHeight;
        quizRow.style.minHeight = currentHeight + 'px';
        // Limpiar casillas
        quizRow.innerHTML = '';
      }
    }
    
    // Delay m√≠nimo antes de iniciar la animaci√≥n de flip
    setTimeout(() => {
      cardEl.classList.add('card-flip-vert', 'flipping');
      setTimeout(() => {
        // En el punto medio del flip, cambiar el contenido
        flipped = false; cardEl.classList.remove('flip');
        currentCard = sessionQueue.shift() || null;
        
        // LIMPIAR CLASES DE BOTONES QUIZ PARA EVITAR CASILLAS SEMI-MARCADAS EN M√ìVIL
        const quizBtns = Array.from(document.querySelectorAll('#quizRow button'));
        quizBtns.forEach(b => {
          // Limpiar todas las clases de estado
          b.classList.remove('optCorrect', 'optWrong', 'optCorrectFade', 'optWrongFade');
          // Limpiar estilos inline que puedan quedar
          b.style.backgroundColor = '';
          b.style.borderColor = '';
          b.style.color = '';
          b.style.opacity = '';
          // Resetear al estado por defecto y habilitar
          b.disabled = false;
          b.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
          // FORZAR RE-RENDER COMPLETO para eliminar estados hover persistentes
          b.style.display = 'none';
          b.offsetHeight; // Trigger reflow
          b.style.display = '';
        });
        
        // Si estamos en challenge o desafioN1, elegir aleatoriamente entre quizMeaning, quizPinyin o quizHanzi
        if((currentMission==='challenge' || currentMission==='desafioN1') && currentCard) {
          const quizModes = ['quizMeaning', 'quizPinyin', 'quizHanzi'];
          setMode(quizModes[Math.floor(Math.random() * quizModes.length)]);
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        } else if(['quizPinyin','quizMeaning','quizHanzi'].includes(mode) && currentCard) {
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        }
        // Premium gold (20%), mythic violet (10%) y legendary red (5%) en modo desaf√≠o
        if ((currentMission==='challenge'||currentMission==='desafioN1') && currentCard) {
          const rand = Math.random();
          if (rand < 0.1) {
            cardEl.classList.add('legendary-red');
            cardEl.classList.remove('mythic-violet');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.2) {
            cardEl.classList.add('mythic-violet');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.50) {
            cardEl.classList.add('premium-gold');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('mythic-violet');
          } else {
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
            cardEl.classList.remove('mythic-violet');
          }
        } else {
          cardEl.classList.remove('legendary-red');
          cardEl.classList.remove('premium-gold');
          cardEl.classList.remove('mythic-violet');
        }
        renderCard();
        updateStats();
        // limpiar animaciones para la pr√≥xima
        cardEl.classList.remove('popAnim','shakeAnim','correct-override');
        // Completar el flip
        cardEl.classList.remove('flipping');
        cardEl.classList.add('flipped');
        setTimeout(() => {
          cardEl.classList.remove('card-flip-vert', 'flipped');
          // SOLUCI√ìN M√ìVIL: Crear casillas por primera vez despu√©s del flip (NO en modo desaf√≠o)
          setTimeout(() => {
            if (isMobile() && currentMission !== 'challenge' && currentMission !== 'desafioN1') {
              createQuizButtonsAfterFlip();
            }
          }, 50);
        }, 440);
      }, 220); // punto medio del flip
    }, 100); // delay m√≠nimo antes de iniciar la animaci√≥n
}

  function renderCard(){
    if(!currentCard){
      const n = sessionTotal, x = sessionCorrect;
      const percent = n > 0 ? Math.round((x / n) * 100) : 0;
      backEl.textContent = '';
      frontEl.innerHTML = `<div class="text-3xl font-semibold">${x} / ${n} correctas</div>`;
      // Prevent flipping on results card
      cardEl.classList.remove('flip');
      cardEl.onclick = null;
      document.getElementById('btnFlip').disabled = true;
      // Sonido y confetti de celebraci√≥n si >= 85%
      if (percent >= 85) {
        showConfetti();
        soundCelebration();
        // Mostrar GIF adorable aleatorio
        const gifs = [
          'img/cat1.gif',
          'img/cat4.gif',
          'img/cat5.gif'
        ];
        const chosen = gifs[Math.floor(Math.random() * gifs.length)];
        showCelebrationGif(chosen);
        // Actualizar racha en backend SOLO si est√° en modo desaf√≠o
        if (currentMission === 'challenge' || currentMission === 'desafioN1') {
          console.log('üî• Desaf√≠o completado con >=85%. Actualizando racha diaria...');
          actualizarRacha(percent);
          
          // üî• ACTUALIZAR RACHA DIARIA LOCALMENTE
          const now = Date.now();
          const today = getLocalDate(now);
          const lastDay = lastChallengeAt ? getLocalDate(lastChallengeAt) : null;
          
          if (today !== lastDay) {
            // Si es un d√≠a diferente, incrementar racha
            const yesterday = new Date(now - 86400000);
            const yesterdayStr = getLocalDate(yesterday.getTime());
            
            if (lastDay === yesterdayStr) {
              // Es d√≠a consecutivo
              streak++;
              console.log('‚úÖ Racha consecutiva! Nueva racha:', streak);
            } else {
              // Racha rota, reiniciar a 1
              streak = 1;
              console.log('üîÑ Racha reiniciada a 1');
            }
            
            lastChallengeAt = now;
            updateStreakBox();
            animarStreakFire();
            saveAll(); // Guardar racha en localStorage
            console.log('üíæ Racha guardada:', streak, 'lastChallengeAt:', new Date(lastChallengeAt).toISOString());
          } else {
            console.log('‚ö†Ô∏è Ya completaste un desaf√≠o hoy. Racha no cambia:', streak);
          }
        }
      }
// Llama al backend para actualizar la racha si aprueba el desaf√≠o
async function actualizarRacha(percent) {
  if (!jwtToken) return;
  try {
    const res = await fetch(`${window.API_BASE}/api/challenge`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': jwtToken
      },
      body: JSON.stringify({ percent })
    });
    const data = await res.json();
    if (data.success) {
      streak = data.streak;
      lastChallengeAt = new Date(data.lastChallengeAt).getTime();
      updateStreakBox();
      animarStreakFire();
    } else {
      // Si ya hizo el desaf√≠o hoy, solo actualiza la UI
      if (typeof data.streak === 'number') {
        streak = data.streak;
        updateStreakBox();
      }
    }
// Animaci√≥n de fuego en el box de racha
function animarStreakFire() {
  const box = document.getElementById('streakBox');
  if (!box) return;
  box.classList.add('streak-fire-anim');
  // Solo animaci√≥n visual, sin emoji
  soundFireEffect();
  setTimeout(() => {
    box.classList.remove('streak-fire-anim');
  }, 1500);
// Sonido especial de fuego
function soundFireEffect() {
  // Sonido glorioso tipo coro: acorde mayor y fade
  beep(523, 0.22, 'triangle', 0.13); // C5
  beep(659, 0.22, 'triangle', 0.11); // E5
  beep(784, 0.22, 'triangle', 0.10); // G5
  setTimeout(() => beep(1046, 0.18, 'triangle', 0.09), 120); // C6
  setTimeout(() => beep(1568, 0.13, 'triangle', 0.08), 220); // G6
}
}
/* Animaci√≥n CSS para el box de racha */
const streakFireStyle = document.createElement('style');
streakFireStyle.textContent = `
  .streak-fire-anim {
    box-shadow: 0 0 32px 8px #f87171, 0 0 0 4px #f59e42;
    background: linear-gradient(90deg, #f59e42 0%, #f87171 100%);
    transition: box-shadow 0.3s, background 0.3s;
  }
`;
document.head.appendChild(streakFireStyle);
  } catch (e) {
    // Error de red o backend
  }
}
// Muestra un GIF adorable en el centro de la pantalla por 2 segundos
function showCelebrationGif(src) {
  let gif = document.getElementById('celebrationGif');
  if (!gif) {
    gif = document.createElement('img');
    gif.id = 'celebrationGif';
    gif.src = src;
    gif.style.position = 'fixed';
    // Ubicaci√≥n: centrado horizontal, posicionamiento optimizado para m√≥vil
    const card = document.getElementById('card');
    if (card) {
      const rect = card.getBoundingClientRect();
      gif.style.left = (rect.left + rect.width/2) + 'px';
      
      // Ajuste especial para m√≥vil: evitar que se corte
      if (isMobile()) {
        // En m√≥vil: posicionar en el centro vertical de la tarjeta
        gif.style.top = (rect.top + rect.height/2) + 'px';
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        // En desktop: posici√≥n original debajo de la tarjeta
        gif.style.top = (rect.bottom) + 'px';
        gif.style.transform = 'translate(-50%, 0)';
      }
    } else {
      gif.style.left = '50%';
      if (isMobile()) {
        gif.style.top = '50%'; // Centro en m√≥vil
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        gif.style.top = '80%'; // Posici√≥n original en desktop
        gif.style.transform = 'translate(-50%, 0)';
      }
    }
    gif.style.zIndex = '99999';
  // Tama√±o por defecto
  let gifWidth = 270;
  
  // Ajuste para m√≥vil: reducir tama√±o para que no se salga de pantalla
  if (isMobile()) {
    gifWidth = Math.min(gifWidth, window.innerWidth * 0.6); // M√°ximo 60% del ancho de pantalla
  }
  
  // Ajuste especial para cat1, cat4 y cat5
  if (src.includes('cat1')) gifWidth = Math.round(gifWidth * 1.3); // 30% m√°s grande
  if (src.includes('cat4')) gifWidth = Math.round(gifWidth * 0.75); // 35% m√°s peque√±o
  if (src.includes('cat5')) gifWidth = Math.round(gifWidth * 0.5);  // 50% m√°s peque√±o
  gif.style.width = gifWidth + 'px';
    gif.style.height = 'auto';
    gif.style.opacity = '1';
    gif.style.transition = 'opacity 0.7s';
    document.body.appendChild(gif);
  } else {
    gif.src = src;
    gif.style.opacity = '1';
    gif.style.display = '';
  }
  setTimeout(() => {
    gif.style.opacity = '0';
    setTimeout(() => { if (gif) gif.style.display = 'none'; }, 700);
  }, 2000);
}
      // --- L√≥gica para mostrar bot√≥n Nivel 2 e insignia ---
      if(currentMission==='desafioN1'){
        clearDesafioTimer();
        if(sessionTotal === 20){
          if(desafioTimeLeft>0 && percent>=90){
            showNivel2Button();
            showNivel1Badge();
          } else if(desafioTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioNoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioNoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }
      // Ocultar la tabla de conocidas en modo desaf√≠o
      const knownTableSection = document.querySelector('section.mt-16');
      if(currentMission==='challenge' || currentMission==='desafioN1') {
        if(knownTableSection) knownTableSection.style.display = 'none';
      } else {
        if(knownTableSection) knownTableSection.style.display = '';
      }
  return;
}
// --- Mostrar bot√≥n Nivel 2 ---
function showNivel2Button(){
  nivel2Unlocked = true;
  saveUserState();
  
  // Mostrar la fila completa de Nivel 2
  const nivel2Row = document.getElementById('nivel2Row');
  const nivel2Wrap = document.getElementById('nivel2Wrap');
  const btnNivel2 = document.getElementById('btnNivel2');
  
  if(nivel2Row) nivel2Row.classList.remove('hidden');
  if(nivel2Wrap) nivel2Wrap.style.display = '';
  if(btnNivel2) btnNivel2.style.display = '';
  
  console.log('‚úÖ Nivel 2 desbloqueado y mostrado');
}

// Mostrar el bot√≥n Nivel 2 si est√° desbloqueado al cargar la p√°gina
window.addEventListener('DOMContentLoaded', async () => {
    // Bot√≥n cerrar sesi√≥n al lado de "si se traba"
    const btnTraba = document.getElementById('btnTraba');
    if(btnTraba && !document.getElementById('btnLogout')) {
      const btnLogout = document.createElement('button');
      btnLogout.id = 'btnLogout';
      btnLogout.textContent = 'Cerrar sesi√≥n';
      btnLogout.className = 'ml-2 px-4 py-2 rounded-xl bg-red-700 hover:bg-red-600 text-white font-bold';
      btnLogout.onclick = () => {
        localStorage.removeItem('jwtToken');
        location.reload();
      };
      btnTraba.parentNode.insertBefore(btnLogout, btnTraba.nextSibling);
    }
  await loadAll();
  if(nivel2Unlocked) {
    console.log('üéØ DOMContentLoaded: Verificaci√≥n adicional de Nivel 2');
    showNivel2Button();
  }
  
  // DEBUG: Verificaci√≥n temporal adicional
  console.log('üîç Estado al cargar p√°gina:');
  console.log('- nivel2Unlocked:', nivel2Unlocked);
  console.log('- xpPoints:', xpPoints);
});
// --- Mostrar insignia de Nivel 1 aprobado ---
function showNivel1Badge(){
  // Eliminado: insignia estrella
}
    // Frente: siempre hanzi, con bot√≥n de parlante si no es desaf√≠o
    frontEl.innerHTML = '';
    // Contenedor relativo para posicionar el parlante
    const frontWrap = document.createElement('div');
    frontWrap.style.position = 'relative';
    frontWrap.style.width = '100%';
    frontWrap.style.height = '100%';
    // Hanzi centrado
    const hanziSpan = document.createElement('span');
    hanziSpan.textContent = currentCard.hanzi;
    hanziSpan.style.display = 'inline-block';
    hanziSpan.style.position = 'absolute';
    hanziSpan.style.top = '50%';
    hanziSpan.style.left = '50%';
    hanziSpan.style.transform = 'translate(-50%, -50%)';
    frontWrap.appendChild(hanziSpan);
    // Bot√≥n parlante (solo si no es desaf√≠o)
    if(currentMission !== 'challenge') {
      const speakBtn = document.createElement('button');
      speakBtn.title = 'Escuchar pronunciaci√≥n';
      speakBtn.style.position = 'absolute';
      speakBtn.style.top = '10px';
      speakBtn.style.right = '10px';
      speakBtn.style.background = 'rgba(30,41,59,0.85)';
      speakBtn.style.border = 'none';
      speakBtn.style.cursor = 'pointer';
      speakBtn.style.borderRadius = '50%';
      speakBtn.style.padding = '4px';
      speakBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
      speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5zm7.07 2.93a10 10 0 010 14.14m2.83-2.83a6 6 0 000-8.48"/></svg>';
      speakBtn.onclick = (e) => {
        e.stopPropagation();
        speakHanzi(currentCard.hanzi);
      };
      frontWrap.appendChild(speakBtn);
    }
    frontEl.appendChild(frontWrap);

    // Enable flipping for normal cards

    cardEl.onclick = () => {
      if(currentCard && mode==='flash'){
        flipped = !flipped;
        flipped ? cardEl.classList.add('flip') : cardEl.classList.remove('flip');
      }
    };
    document.getElementById('btnFlip').disabled = false;
// Pronuncia el Hanzi usando SpeechSynthesis, priorizando voz femenina y calidad
function speakHanzi(text) {
  if (!window.speechSynthesis) return;
  const voices = window.speechSynthesis.getVoices();
  // Buscar voz en chino, priorizando femenina y calidad
  let zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.gender === 'female');
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.name && /female|woman|Â•≥/i.test(v.name));
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.voiceURI && /female|woman|Â•≥/i.test(v.voiceURI));
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh'));
  const utter = new window.SpeechSynthesisUtterance(text);
  if (zhVoice) utter.voice = zhVoice;
  utter.lang = zhVoice ? zhVoice.lang : 'zh-CN';
  utter.rate = 0.97;
  utter.pitch = 1.15;
  utter.volume = 1;
  window.speechSynthesis.speak(utter);
}

    if(mode === 'flash'){
          
          
          

          
          
           backEl.innerHTML = `<div class="mb-2">${currentCard.pinyin}</div><div>${currentCard.meaning}</div>`;
      flashRow.classList.remove('hidden');
      quizRow.classList.add('hidden');
    } else {
      backEl.textContent = '';
      flashRow.classList.add('hidden');
      quizRow.classList.remove('hidden');
      
      // Usar setupChallengeCard para modo desaf√≠o, setupQuizChoices para el resto
      if (currentMission === 'challenge' || currentMission === 'desafioN1') {
        if (!setupChallengeCard()) {
          setupQuizChoices(); // fallback si setupChallengeCard falla
        }
      } else {
        setupQuizChoices();
      }
    }
  }

  // Confetti effect for celebration - versi√≥n solo verde
  function showConfetti() {
    let confettiCanvas = document.getElementById('confettiCanvas');
    if (!confettiCanvas) {
      confettiCanvas = document.createElement('canvas');
      confettiCanvas.id = 'confettiCanvas';
      confettiCanvas.style.position = 'fixed';
      confettiCanvas.style.left = '0';
      confettiCanvas.style.top = '0';
      confettiCanvas.style.width = '100vw';
      confettiCanvas.style.height = '100vh';
      confettiCanvas.style.pointerEvents = 'none'; // Asegura que nunca bloquee clics
      confettiCanvas.style.zIndex = '9999';
      document.body.appendChild(confettiCanvas);
    }
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiCanvas.style.pointerEvents = 'none'; // Refuerza pointer-events

    const ctx = confettiCanvas.getContext('2d');
    const colors = ['#22c55e','#16a34a','#10b981','#34d399','#86efac','#166534'];
    const pieces = 140;
    const confetti = [];

    // Get card position for explosion origin
    const cardRect = cardEl.getBoundingClientRect();
    let originX = cardRect.left + cardRect.width/2;
    let originY;
    
    if (isMobile()) {
      // En m√≥vil: origen en el centro de la tarjeta para evitar cortes
      originY = cardRect.top + cardRect.height/2;
    } else {
      // En desktop: origen debajo de la tarjeta (original)
      originY = cardRect.bottom - 10;
    }

    for (let i = 0; i < pieces; i++) {
      const angle = Math.PI/2 + (Math.random()-0.5)*Math.PI/1.2; // mostly upward
      const speed = Math.random()*7+6;
      confetti.push({
        x: originX,
        y: originY,
        r: Math.random() * 8 + 4,
        c: colors[Math.floor(Math.random() * colors.length)],
        vx: Math.cos(angle)*speed,
        vy: -Math.abs(Math.sin(angle)*speed*1.5), // 50% m√°s alto
        alpha: 1,
        gravity: 0.25 + Math.random()*0.15,
        fade: 0.012 + Math.random()*0.008
      });
    }

    let frames = 0;
    function draw() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (const p of confetti) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = p.c;
        ctx.globalAlpha = p.alpha;
        ctx.fill();
        ctx.restore();

        // Movimiento: primero suben, luego caen y se desvanecen
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.gravity;
        if (frames > 30) p.alpha -= p.fade; // fade out after some frames
        if (p.alpha < 0) p.alpha = 0;
      }
      frames++;
      if (frames < 90) {
        requestAnimationFrame(draw);
      } else {
        // Eliminar canvas y asegurar pointer-events none
        confettiCanvas.style.pointerEvents = 'none';
        if (confettiCanvas.parentNode) confettiCanvas.parentNode.removeChild(confettiCanvas);
      }
    }
    draw();
}


  /* ========= QUIZ ========= */
  
  // Funci√≥n para crear casillas por primera vez despu√©s del flip (solo m√≥vil)
  function createQuizButtonsAfterFlip() {
    console.log('üì± Creando casillas por primera vez despu√©s del flip');
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) return;
    
    // Limpiar cualquier bot√≥n existente
    quizRow.innerHTML = '';
    
    // Crear 4 botones nuevos desde cero INVISIBLES inicialmente
    for(let i = 0; i < 4; i++) {
      const btn = document.createElement('button');
      btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
      btn.style.fontSize = '24px';
      btn.style.outline = 'none';
      btn.style.webkitTapHighlightColor = 'transparent';
      
      // CREAR INVISIBLES para evitar el "1 frame visible"
      btn.style.opacity = '0';
      btn.style.pointerEvents = 'auto'; // Mantener funcionalidad
      
      // Auto-blur inmediato en m√≥vil
      btn.addEventListener('touchend', function() {
        setTimeout(() => this.blur(), 5);
      });
      
      quizRow.appendChild(btn);
    }
    
    console.log('‚úÖ Casillas creadas invisibles, configurando contenido...');
    
    // Re-aplicar la l√≥gica de quiz despu√©s de crear
    if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
      setupQuizChoices();
    }
    
    // ACTIVAR FADE-IN en el siguiente frame del navegador
    requestAnimationFrame(() => {
      const buttons = quizRow.querySelectorAll('.quizOpt');
      buttons.forEach((btn, i) => {
        btn.classList.add('mobile-fade-in');
        btn.style.animationDelay = (i * 50) + 'ms';
        // Hacer visible con la animaci√≥n
        btn.style.opacity = '1';
      });
      
      console.log('üé¨ Fade-in activado en siguiente frame');
      
      // Limpiar animaciones despu√©s de que terminen
      setTimeout(() => {
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 600);
    });
  }

  // Detectar si estamos en m√≥vil
  function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
           ('ontouchstart' in window) || 
           (navigator.maxTouchPoints > 0);
  }

  // Funci√≥n para recrear completamente los botones de quiz en m√≥vil (elimina cualquier estado focus)
  function forceRecreateQuizButtons() {
    console.log('ÔøΩ RECREACI√ìN M√ìVIL de botones...');
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) return;
    
    // Guardar altura actual para evitar movimiento de contenido
    const currentHeight = quizRow.offsetHeight;
    quizRow.style.minHeight = currentHeight + 'px';
    
    // PASO 1: DESTRUCCI√ìN COMPLETA - Eliminar todo el contenido
    quizRow.innerHTML = '';
    
    // PASO 2: RECREACI√ìN INMEDIATA 
    setTimeout(() => {
      console.log('üÜï Creando botones nuevos sin historial...');
      
      // Recrear 4 botones completamente nuevos desde cero con animaci√≥n
      for(let i = 0; i < 4; i++) {
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base mobile-fade-in';
        btn.style.fontSize = '24px';
        btn.style.outline = 'none';
        btn.style.webkitTapHighlightColor = 'transparent';
        btn.style.animationDelay = (i * 50) + 'ms'; // Delay escalonado para cada bot√≥n
        
        // Auto-blur inmediato en m√≥vil
        btn.addEventListener('touchend', function() {
          setTimeout(() => this.blur(), 5);
        });
        
        quizRow.appendChild(btn);
      }
      
      // Re-aplicar la l√≥gica de quiz despu√©s de recrear
      if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
        setupQuizChoices();
      }
      
      // Restaurar altura autom√°tica despu√©s de recrear
      setTimeout(() => {
        quizRow.style.minHeight = '';
        
        // Limpiar clases de animaci√≥n despu√©s de que terminen
        const buttons = quizRow.querySelectorAll('.quizOpt');
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 400); // 300ms de animaci√≥n + 100ms extra
      
      console.log('‚úÖ Botones m√≥vil recreados exitosamente');
    }, 30); // Muy r√°pido pero suficiente para limpiar DOM
  }
  
  
  function setupQuizChoices(){
    // Asegurar 4 botones
    if(quizRow.children.length !== 4){
      quizRow.innerHTML = '';
      for(let i=0;i<4;i++){
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
        btn.style.fontSize = '24px';
        
        // En m√≥vil: Solo hacer invisibles si NO fueron creados por createQuizButtonsAfterFlip
        // Los botones con mobile-fade-in ya son visibles y deben mantenerse as√≠
        if (isMobile() && !btn.classList.contains('mobile-fade-in')) {
          btn.style.opacity = '0';
          btn.style.pointerEvents = 'none';
        }
        
        quizRow.appendChild(btn);
      }
    }
    
    // Limpiar flag de respuesta
    window.isAnswering = false;
    
    const quizBtns = Array.from(quizRow.children);

    // Generar opciones desde el pool actual de la misi√≥n (o todas si vac√≠o)
    const pool = buildQueue(currentMission);
    const source = pool.length ? pool : cards;

    const field   = (mode==='quizPinyin') ? 'pinyin' : 'meaning';
    const correct = currentCard[field];

    const values = new Set([correct]);
    const distractors = [];
    const candidates = shuffle(source.filter(c => c.id !== currentCard.id));
    for(const c of candidates){
      const v = c[field];
      if(!values.has(v)){ values.add(v); distractors.push(v); }
      if(distractors.length===3) break;
    }
    while(distractors.length<3){ distractors.push('‚Äî'); } // fallback

    const options = shuffle([correct, ...distractors]);

    function setDisabledAll(flag){ quizBtns.forEach(b=>b.disabled=flag); }

    quizBtns.forEach((btn, idx) => {
      btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
      btn.textContent = options[idx];
      btn.onclick = () => {
        // Marcar que estamos respondiendo para que los nuevos botones aparezcan invisibles
        window.isAnswering = true;
        
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        btn.blur();
        const isCorrect = options[idx] === correct;
        setDisabledAll(true);
        
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          
          // En m√≥vil: fade-out de TODAS las casillas juntas despu√©s del glow
          if(isMobile()) {
            setTimeout(() => {
              // TODAS las casillas se desvanecen al mismo tiempo
              quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
            }, 800); // Despu√©s de que el glow tenga tiempo de verse
          }
          
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          quizBtns.forEach((b, i) => {
            if(options[i] === correct) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          
          // Perder vida en modo desaf√≠o
          console.log('üîç DEBUG Respuesta incorrecta - currentMission:', currentMission, 'challengeActive:', challengeActive);
          if(currentMission === 'challenge' && challengeActive) {
            console.log('üíî Llamando loseChallengeLife()');
            loseChallengeLife();
          } else {
            console.log('‚ö†Ô∏è NO se llam√≥ loseChallengeLife - Condiciones no cumplidas');
          }
          
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            quizBtns.forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
            
            // En m√≥vil: fade-out de TODAS las casillas juntas
            if(isMobile()) {
              setTimeout(() => {
                // TODAS las casillas se desvanecen al mismo tiempo
                quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
              }, 900); // Despu√©s de las animaciones de correcto/incorrecto
            }
          }, 1000);
          
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            answer(false);
          }, 2000);
        }
      };
    });
  }
  // --- Quiz Hanzi ---
const btnQuizMeaning = document.getElementById('btnQuizMeaning');
if(btnQuizMeaning) {
  let btnQuizHanzi = document.getElementById('btnQuizHanzi');
  if(!btnQuizHanzi) {
    btnQuizHanzi = document.createElement('button');
    btnQuizHanzi.id = 'btnQuizHanzi';
    btnQuizHanzi.className = 'px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 ml-2';
    btnQuizHanzi.textContent = 'Quiz Hanzi';
    btnQuizMeaning.parentNode.insertBefore(btnQuizHanzi, btnQuizMeaning.nextSibling);
  }
  btnQuizHanzi.onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    bodyEl.classList.remove('challenge-bg');
    statBox.classList.remove('challenge-stat');
    stopDesafioMusic();
    setMode('quizHanzi');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };
}

// --- L√≥gica para modo quizHanzi ---
const oldSetupQuizChoices = window.setupQuizChoices;
window.setupQuizChoices = function() {
  if(mode === 'quizHanzi' && currentCard) {
    // Mostrar pinyin o significado aleatorio en la tarjeta
    const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
    frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
    backEl.innerHTML = '';

    // Opciones: 1 correcta + 3 aleatorias
    let hanziOptions = [currentCard.hanzi];
    let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
    while(hanziOptions.length < 4 && pool.length > 0) {
      const idx = Math.floor(Math.random() * pool.length);
      hanziOptions.push(pool[idx].hanzi);
      pool.splice(idx,1);
    }
    hanziOptions = shuffle(hanziOptions);

    quizRow.innerHTML = '';
    // Helper para deshabilitar todos los botones hanzi
    function setDisabledAll(flag) {
      Array.from(quizRow.children).forEach(b => b.disabled = flag);
    }
    hanziOptions.forEach(hz => {
      const btn = document.createElement('button');
      btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
      btn.textContent = hz;
      btn.disabled = false;
      btn.onclick = function() {
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        this.blur();
        setDisabledAll(true);
        const isCorrect = hz === currentCard.hanzi;
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          // Marcar la opci√≥n correcta
          Array.from(quizRow.children).forEach((b, i) => {
            if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            Array.from(quizRow.children).forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
          }, 1000);
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
            setDisabledAll(false);
            answer(false);
          }, 2000);
        }
      };
      quizRow.appendChild(btn);
    });
    quizRow.classList.remove('hidden');
    flashRow.classList.add('hidden');
    return;
  } else {
    // Restaurar fuente original para quizRow y sus hijos
    quizRow.classList.remove('text-3xl','font-bold');
    Array.from(quizRow.children).forEach(btn => {
      btn.classList.remove('text-3xl','font-bold');
    });
    // Restaurar tarjeta frontal
    if(currentCard && (mode === 'quizPinyin' || mode === 'quizMeaning')) {
      frontEl.innerHTML = `<span class='text-5xl font-bold'>${currentCard.hanzi}</span>`;
    }
  }
  if(typeof oldSetupQuizChoices === 'function') oldSetupQuizChoices();
}

// --- Desaf√≠os ---
function setupChallengeCard() {
  if(currentMission === 'challenge' || currentMission === 'desafioN1') {
    // Elegir aleatoriamente el tipo de pregunta
    // 50%: muestra hanzi y opciones pinyin/meaning
    // 50%: muestra pinyin o meaning y opciones hanzi (quiz hanzi style)
    const hanziQuiz = Math.random() < 0.5;
    if(hanziQuiz) {
      // Quiz hanzi: muestra pinyin o significado, opciones hanzi
      const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
      backEl.innerHTML = '';
      // Opciones hanzi
      let hanziOptions = [currentCard.hanzi];
      let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
      while(hanziOptions.length < 4 && pool.length > 0) {
        const idx = Math.floor(Math.random() * pool.length);
        hanziOptions.push(pool[idx].hanzi);
        pool.splice(idx,1);
      }
      hanziOptions = shuffle(hanziOptions);
      quizRow.innerHTML = '';
      hanziOptions.forEach((hz, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = hz;
        btn.disabled = false;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        btn.onclick = function() {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          this.blur();
          Array.from(quizRow.children).forEach(b => b.disabled = true);
          const isCorrect = hz === currentCard.hanzi;
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                const challengeBtns = Array.from(quizRow.children);
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            Array.from(quizRow.children).forEach((b, i) => {
              if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            
            // üî• PERDER VIDA EN MODO DESAF√çO
            console.log('üîç DEBUG setupChallengeCard wrong - currentMission:', currentMission, 'challengeActive:', challengeActive);
            if(currentMission === 'challenge' && challengeActive) {
              console.log('üíî Llamando loseChallengeLife() desde setupChallengeCard');
              loseChallengeLife();
            }
            
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              Array.from(quizRow.children).forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  const challengeBtns = Array.from(quizRow.children);
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              Array.from(quizRow.children).forEach(b=>b.disabled=false);
              answer(false);
            }, 2000);
          }
        };
        quizRow.appendChild(btn);
      });
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones hanzi
      if (isMobile()) {
        requestAnimationFrame(() => {
          const challengeBtns = Array.from(quizRow.children);
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    } else {
      // Modo cl√°sico: muestra hanzi y opciones pinyin/meaning
      const types = ['pinyin','meaning'];
      const optionsType = types[Math.floor(Math.random()*types.length)];
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
      backEl.innerHTML = '';
      let correct = currentCard[optionsType];
      let options = [correct];
      let pool = cards.filter(c => c[optionsType] !== correct);
      while(options.length < 4 && pool.length > 0) {
        const idx = Math.floor(Math.random() * pool.length);
        options.push(pool[idx][optionsType]);
        pool.splice(idx,1);
      }
      options = shuffle(options);
      quizRow.innerHTML = '';
      options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = opt;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o  
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        quizRow.appendChild(btn);
      });
      const challengeBtns = Array.from(quizRow.children);
      function setDisabledAll(flag){ challengeBtns.forEach(b=>b.disabled=flag); }
      challengeBtns.forEach((btn, idx) => {
        btn.onclick = () => {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          btn.blur();
          const isCorrect = btn.textContent === currentCard[optionsType];
          setDisabledAll(true);
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            challengeBtns.forEach((b, i) => {
              if(b.textContent === currentCard[optionsType]) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            
            // üî• PERDER VIDA EN MODO DESAF√çO
            console.log('üîç DEBUG setupChallengeCard (cl√°sico) wrong - currentMission:', currentMission, 'challengeActive:', challengeActive);
            if(currentMission === 'challenge' && challengeActive) {
              console.log('üíî Llamando loseChallengeLife() desde setupChallengeCard (cl√°sico)');
              loseChallengeLife();
            }
            
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              challengeBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              challengeBtns.forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              // Avanzar a la siguiente tarjeta
              nextCard();
            }, 2000);
          }
        };
      });
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones del modo cl√°sico
      if (isMobile()) {
        requestAnimationFrame(() => {
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    }
  }
  return false;
}
  /* ========= Modo/UI ========= */
  function setMode(newMode){
    // En Desaf√≠o, no permitimos modo Flash
    if(currentMission==='challenge' && newMode==='flash'){
      mode = 'quizMeaning';
    } else {
      mode = newMode;
    }
    
    // Refrescar pool de audio al cambiar modo para prevenir problemas
    if(typeof refreshCorrectSoundPool === 'function') {
      refreshCorrectSoundPool();
    }
    
    if(mode!=='flash'){ flipped=false; cardEl.classList.remove('flip'); }
    if(currentCard) renderCard();
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones seg√∫n el modo
  }

  // Funci√≥n para actualizar las instrucciones del juego seg√∫n el modo
  function updateGameInstructions(){
    const instructionsEl = document.getElementById('gameInstructions');
    if(!instructionsEl) return;
    
    if(currentMission === 'challenge' || currentMission === 'desafioN1'){
      // Modo desaf√≠o
      instructionsEl.innerHTML = `<span class="text-yellow-400">Tarjeta Dorada:</span> + 2 niv al caracter, <span class="text-purple-400">Tarjeta Violeta:</span> + 5 niv al caracter, <span class="text-red-400">Tarjeta Roja:</span> si te equivocas pierdes un caracter extra al azar (con todo su nivel).`;
    } else if(mode === 'flash'){
      // Modo flashcards
      instructionsEl.textContent = 'Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la s√©, Espacio = Voltear, Derecha = La sab√≠a.';
    } else {
      // Modo quiz (quizPinyin, quizMeaning, quizHanzi) - Sin texto
      instructionsEl.textContent = '';
    }
  }

  // --- L√≥gica de racha diaria por d√≠a GMT-6 ---
  function getLocalDate(ts) {
    const date = new Date(ts);
    date.setHours(date.getHours() - 6);
    return date.toISOString().slice(0, 10);
  }
  function getRachaStatus(lastChallengeAt) {
    const now = Date.now();
    const today = getLocalDate(now);
    const lastDay = getLocalDate(lastChallengeAt);
    
    if (today === lastDay) {
      // Ya hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 del pr√≥ximo d√≠a
      const nextMidnight = new Date(now);
      nextMidnight.setUTCHours(6, 0, 0, 0); // 00:00 GMT-6 = 06:00 UTC
      if (now >= nextMidnight.getTime()) {
        nextMidnight.setUTCDate(nextMidnight.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((nextMidnight.getTime() - now) / 3600000);
      return { status: 'yaHizo', horasRestantes: Math.min(24, horasRestantes) };
    } else {
      // No hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 (fin del d√≠a actual)
      const endOfDay = new Date(now);
      endOfDay.setUTCHours(6, 0, 0, 0); // Pr√≥ximas 00:00 GMT-6
      if (now >= endOfDay.getTime()) {
        endOfDay.setUTCDate(endOfDay.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((endOfDay.getTime() - now) / 3600000);
      return { status: 'puedeHacer', horasRestantes: Math.min(24, horasRestantes) };
    }
  }
  function updateStreakBox() {
    if (!streakBox || !streakCount || !streakStatus) return;
    streakCount.textContent = streak || 0;
    // Tomar el √∫ltimo desaf√≠o exitoso
    const lastTs = lastChallengeAt || 0;
    const racha = getRachaStatus(lastTs);
    let horas = racha.horasRestantes;
    streakStatus.style.color = '#fff';
    if (racha.status === 'yaHizo') {
      streakStatus.textContent = `Faltan ${horas} hs para poder sumar racha.`;
    } else {
      streakStatus.textContent = `Tienes ${horas} hs para no perder la racha.`;
    }
    // Si quedan menos de 5 horas, fondo naranja de aviso
    if (racha.status === 'puedeHacer' && horas <= 5) {
      streakBox.style.background = '#f54242'; // naranja
      streakStatus.style.color = '#fff';
    } else {
      streakBox.style.background = '';
    }
  }
  // Mostrar mensaje al tocar el box
  if (streakBox) {
    streakBox.onclick = function() {
      // Mostrar imagen "fuerte.png" centrada en pantalla
      let overlay = document.getElementById('rachaFuerteOverlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'rachaFuerteOverlay';
          overlay.className = 'fade-overlay';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(0,0,0,0.7)';
          overlay.style.zIndex = '99999';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.cursor = 'pointer';
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.5s';
          // Imagen centrada
          const img = document.createElement('img');
          img.src = 'img/fuerte.png';
          img.alt = 'Fuerte';
          img.style.maxWidth = '80vw';
          img.style.maxHeight = '80vh';
          img.style.borderRadius = '24px';
          img.style.boxShadow = '0 0 32px #0008';
          overlay.appendChild(img);
          document.body.appendChild(overlay);
          // Fade in
          setTimeout(() => { overlay.style.opacity = '1'; }, 10);
          // Cerrar al hacer click en cualquier parte con fade out
          overlay.onclick = function() {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.remove(); }, 500);
          };
        }
    };
  }

  function updateStats(){
    statInSession.textContent = sessionQueue.length + (currentCard ? 1 : 0);
    statToday.textContent = todayReviewed;
    statMission.textContent = (
      currentMission==='unit2' ? 'Unidad 2' :
      currentMission==='unit3' ? 'Unidad 3' :
      currentMission==='unit4' ? 'Unidad 4' :
      currentMission==='unit5' ? 'Unidad 5' :
      currentMission==='unit6' ? 'Unidad 6' :
      currentMission==='unit7' ? 'Unidad 7' :
      currentMission==='unit8' ? 'Unidad 8' :
      currentMission==='unit9' ? 'Unidad 9' :
      currentMission==='unit2N2' ? 'Unidad 1 (N2)' :
      currentMission==='unit3N2' ? 'Unidad 2 (N2)' :
      currentMission==='unit4N2' ? 'Unidad 3 (N2)' :
      currentMission==='unit5N2' ? 'Unidad 4 (N2)' :
      currentMission==='unit6N2' ? 'Unidad 5 (N2)' :
      currentMission==='unit7N2' ? 'Unidad 6 (N2)' :
      currentMission==='unit8N2' ? 'Unidad 7 (N2)' :
      currentMission==='unit9N2' ? 'Unidad 8 (N2)' :
      currentMission==='unit10N2'? 'Unidad 9 (N2)' :
      currentMission==='todoN2' ? 'Todo N2' :
      currentMission==='known' ? 'Conocidas' :
      currentMission==='revise1' ? 'A repasar' :
      currentMission==='revise2' ? 'Para confirmar' :
      currentMission==='challenge' ? 'Desaf√≠o' : '‚Äî'
    );
    // Cambiar color de statBox seg√∫n el modo actual
    const modeToBtn = {
      'unit2': 'btnUnit2',
      'unit3': 'btnUnit3',
      'unit4': 'btnUnit4',
      'unit5': 'btnUnit5',
      'unit6': 'btnUnit6',
      'unit7': 'btnUnit7',
      'unit8': 'btnUnit8',
      'unit9': 'btnUnit9',
      'unit2N2': 'btnUnit2N2',
      'unit3N2': 'btnUnit3N2',
      'unit4N2': 'btnUnit4N2',
      'unit5N2': 'btnUnit5N2',
      'unit6N2': 'btnUnit6N2',
      'unit7N2': 'btnUnit7N2',
      'unit8N2': 'btnUnit8N2',
      'unit9N2': 'btnUnit9N2',
      'unit10N2': 'btnUnit10N2',
      'todoN2': 'btnTodoN2',
      'known': 'btnKnown',
      'revise1': 'btnRevise1',
      'revise2': 'btnRevise2',
      'challenge': 'btnChallenge'
    };
    let btnId = modeToBtn[currentMission];
    let btn = btnId ? document.getElementById(btnId) : null;
    if(btn) {
      statBox.style.background = window.getComputedStyle(btn).backgroundColor;
      statBox.style.color = window.getComputedStyle(btn).color;
      statBox.style.borderColor = window.getComputedStyle(btn).borderColor || 'transparent';
    } else {
      statBox.style.background = '';
      statBox.style.color = '';
      statBox.style.borderColor = '';
    }
    // contadores
    const countKnown = cards.filter(c=>c.known).length;
    const countRev1  = cards.filter(c=>c.revise1).length;
    const countRev2  = cards.filter(c=>c.revise2).length;
    const elKnown = document.getElementById('countKnown'); if(elKnown) elKnown.textContent = countKnown;
    const elR1    = document.getElementById('countRev1');  if(elR1)   elR1.textContent   = countRev1 === 0 ? '‚úÖ' : countRev1;
    const elR2    = document.getElementById('countRev2');  if(elR2)   elR2.textContent   = countRev2 === 0 ? '‚úÖ' : countRev2;

  updateStreakBox();
  }

  /* ========= Tabla Conocidas ========= */
  let overlayField = 'hanzi'; // 'hanzi' | 'pinyin' | 'meaning'
let knownCatFilter = 'ALL'; // 'ALL'|'S'|'A'|'V'|'P'|'E'

// Estado previo de conocidas para animaciones
let prevKnownState = [];
  // Overlay removed: no-op

  // Interpolaci√≥n azul -> naranja para la racha
  const COLOR_A = { r: 59, g: 130, b: 246 };   // #3B82F6
  const COLOR_B = { r: 255, g: 134, b: 35  };  // #FF8623
  function lerp(a,b,t){ return a + (b-a)*t; }
  function mixColor(t){
    const r = Math.round(lerp(COLOR_A.r, COLOR_B.r, t));
    const g = Math.round(lerp(COLOR_A.g, COLOR_B.g, t));
    const b = Math.round(lerp(COLOR_A.b, COLOR_B.b, t));
    return `rgb(${r}, ${g}, ${b})`;
  }

  // Ajuste de texto para celdas (binaria para que quepa en ancho/alto)
  function fitCellText(el, minPx=10, maxPx=64){
    const parent = el.parentElement;
    if(!parent) return;
    const pad = 18; // margen de seguridad
    let low = minPx, high = maxPx, best = minPx;
    while(low <= high){
      const mid = Math.floor((low + high)/2);
      el.style.fontSize = mid + 'px';
      // Medimos (fudges con padding)
      const OK = (el.scrollWidth <= parent.clientWidth - pad) && (el.scrollHeight <= parent.clientHeight - pad);
      if(OK){ best = mid; low = mid + 1; } else { high = mid - 1; }
    }
    el.style.fontSize = best + 'px';
  }

  function sizeClassForHanzi(len){
    return len >= 4 ? 'font-bold' : 'font-bold';
  }

  // Render con animaciones de level up y perdidos
  function renderKnownGridWithAnimations(levelUpIds, lostChars) {
    let known = cards.filter(c=>c.known);
    if(knownCatFilter !== 'ALL') {
      known = known.filter(c => (c.cat||'E').toUpperCase() === knownCatFilter);
    }
    knownCount.textContent = `${known.length} palabras`;

    // Grid responsivo: 4 columnas en m√≥vil, m√°s en desktop
    knownGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(min(100px, 22vw), 1fr))';

    // ordenar por challengeStreak desc
    known.sort((a,b)=> (b.challengeStreak||0) - (a.challengeStreak||0));
    const maxStreak = Math.max(0, ...known.map(c => c.challengeStreak||0));

    // --- Renderizar perdidos arriba ---
    knownGrid.innerHTML = '';
    const lostRow = document.createElement('div');
    lostRow.style.display = 'contents';
    lostRow.id = 'lostRow';
    lostChars.forEach(c => {
      const cell = document.createElement('div');
      cell.className = `squareCell rounded-xl bg-rose-800/80 ring-2 ring-rose-400/60 px-2 lost-cell`;
      cell.style.position = 'relative';
      cell.style.opacity = '1';
      cell.style.transition = 'opacity 0.7s cubic-bezier(.4,0,.2,1), transform 0.7s cubic-bezier(.4,0,.2,1)';
      cell.style.transform = 'translateY(0)';
      // contenido principal
      const content = document.createElement('div');
      content.textContent = c.hanzi;
      content.className = 'leading-tight font-bold';
      cell.appendChild(content);
      // badge de racha
      const badge = document.createElement('div');
      badge.className = 'streak-badge';
      badge.style.background = '#dc2626';
      badge.textContent = c.streak;
      cell.appendChild(badge);
      // badge de categor√≠a
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.textContent = cat;
      catBadge.style.position = 'absolute';
      catBadge.style.left = '7px';
      catBadge.style.bottom = '7px';
      catBadge.style.fontWeight = 'bold';
      catBadge.style.fontSize = '0.77em';
      catBadge.style.color = '#fff';
      catBadge.style.background = 'transparent';
      catBadge.style.pointerEvents = 'none';
      cell.appendChild(catBadge); 
      lostRow.appendChild(cell);
      requestAnimationFrame(()=> fitCellText(content, 10, 64));
    });
    knownGrid.appendChild(lostRow);

    // --- Renderizar conocidos normales ---
    known.forEach(c => {
      const value = overlayField==='hanzi' ? c.hanzi : overlayField==='pinyin' ? c.pinyin : c.meaning;
  const cell = document.createElement('div');
  cell.className = `squareCell rounded-xl bg-slate-800/70 ring-1 ring-white/10 px-2`;
  cell.style.position = 'relative';
  cell.style.pointerEvents = 'auto';
  cell.style.zIndex = '1';
      // contenido principal
      const content = document.createElement('div');
      content.textContent = value;
      content.className = overlayField==='hanzi'
        ? 'leading-tight ' + sizeClassForHanzi((value||'').length)
        : 'leading-tight';
      cell.appendChild(content);
      // badge de racha
      const st = c.challengeStreak || 0;
      const t = maxStreak ? st / maxStreak : 0;
      const badge = document.createElement('div');
      badge.className = 'streak-badge';
      badge.style.background = mixColor(t);
      badge.textContent = st;
      // Animaci√≥n de level up
      if(levelUpIds && levelUpIds.includes(c.id)) {
        badge.classList.add('levelup-anim');
        // N√∫mero subiendo animado
        let prev = 0;
        if(window.prevKnownState) {
          const prevC = window.prevKnownState.find(x=>x.id===c.id);
          if(prevC) prev = prevC.streak;
        }
        if(prev < st) {
          let n = prev;
          const anim = setInterval(()=>{
            n++;
            badge.textContent = n;
            if(n>=st) clearInterval(anim);
          }, 120);
        }
      }
      cell.appendChild(badge);
      // badge de categor√≠a
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.textContent = cat;
      catBadge.style.position = 'absolute';
      catBadge.style.left = '7px';
      catBadge.style.bottom = '7px';
      catBadge.style.fontWeight = 'bold';
      catBadge.style.fontSize = '0.77em';
      catBadge.style.color = '#fff';
      catBadge.style.background = 'transparent';
      catBadge.style.pointerEvents = 'none';
      cell.appendChild(catBadge);
      knownGrid.appendChild(cell);
      requestAnimationFrame(()=> fitCellText(content, 10, 64));
    });

    // --- Animar salida de perdidos, luego level up, luego reacomodar ---
    if(lostChars.length) {
      setTimeout(()=>{
        // Sonido de salida de perdidos
        soundLostKnowns();
        lostRow.childNodes.forEach(cell=>{
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-40px)';
        });
        setTimeout(()=>{
          lostRow.remove();
          // Animar level up despu√©s de perdidos
          animateLevelUps(levelUpIds, ()=>{
            // Al terminar animaci√≥n, re-renderizar la tabla normal
            setTimeout(()=>renderKnownGrid(), 100);
          });
        }, 700);
      }, 1200);
    } else {
      // Si no hay perdidos, animar level up inmediatamente y luego reacomodar
      setTimeout(()=>animateLevelUps(levelUpIds, ()=>{
        setTimeout(()=>renderKnownGrid(), 100);
      }), 400);
    }

    // --- Animaci√≥n visual llamativa para level up (brillo verde en celda entera) ---
    function animateLevelUps(levelUpIds, onDone) {
      if(!levelUpIds || !levelUpIds.length) { if(onDone) onDone(); return; }
      const cells = knownGrid.querySelectorAll('.squareCell');
  const animDuration = 3900;
      let anyLevelUp = false;
      cells.forEach(cell => {
        const badge = cell.querySelector('.streak-badge');
        if(!badge) return;
        const hanzi = cell.querySelector('div').textContent;
        const c = cards.find(x => x.hanzi === hanzi && x.known);
        if(c && levelUpIds.includes(c.id)) {
          anyLevelUp = true;
          // --- POP de la celda ---
          cell.animate([
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: cell.style.background || '' },
            { transform: 'scale(1.13)', boxShadow: '0 0 40px 16px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1.05)', boxShadow: '0 0 24px 8px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: '#22c55e33' }
          ], {
            duration: animDuration*0.6,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          // --- Badge de racha crece y vuelve ---
          // Cambiar badge a amarillo con glow durante la animaci√≥n
          const originalBg = badge.style.background;
          const originalBoxShadow = badge.style.boxShadow;
          badge.style.background = '#fbbf24';
          badge.style.boxShadow = '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24';
          badge.animate([
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1.35)', filter: 'brightness(1.7)', boxShadow: '0 0 40px 16px #fde68a, 0 0 0 4px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' }
          ], {
            duration: animDuration*0.4,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          setTimeout(()=>{
            badge.style.background = originalBg || '#3B82F6';
            badge.style.boxShadow = originalBoxShadow || '0 0 10px rgba(0,0,0,.25)';
          }, animDuration*0.8);
          // --- Level up icon (^^) sobre el badge ---
          let lvlIcon = badge.parentElement.querySelector('.levelup-icon');
          if(!lvlIcon) {
            lvlIcon = document.createElement('div');
            lvlIcon.className = 'levelup-icon';
            lvlIcon.innerHTML = '<span style="font-size:20px;font-weight:bold;color:#fbbf24;text-shadow:0 0 8px #fde68a,0 2px 2px #0007;">^^</span>';
            lvlIcon.style.position = 'absolute';
            lvlIcon.style.right = '10px';
            lvlIcon.style.bottom = '38px';
            lvlIcon.style.pointerEvents = 'none';
            lvlIcon.style.opacity = '0';
            badge.parentElement.appendChild(lvlIcon);
          }
          // Dura el doble de tiempo visible
          const lvlIconDuration = animDuration;
          lvlIcon.animate([
            { opacity: 0, transform: 'translateY(10px) scale(0.7)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.15)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.1)' },
            { opacity: 0, transform: 'translateY(-10px) scale(0.7)' }
          ], {
            duration: lvlIconDuration,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          lvlIcon.style.opacity = '1';
          setTimeout(() => { lvlIcon.style.opacity = '0'; }, lvlIconDuration);
          // --- Fondo verde que desvanece ---
          cell.style.transition = `background 1.1s`;
          cell.style.background = '#22c55e33';
          setTimeout(()=>{
            cell.style.background = 'rgba(34,197,94,0)';
          }, animDuration*0.6);
          setTimeout(()=>{
            cell.style.background = '';
          }, animDuration+1100);
        }
      });
      // Sonido de gloria si hubo level up
      if(anyLevelUp) soundGlory();
      // Llamar onDone despu√©s de la animaci√≥n + 1s de espera
  setTimeout(()=>{ if(onDone) setTimeout(onDone, 1000); }, animDuration);
    }

    // Sonido para salida de perdidos
    function soundLostKnowns() {
      // Sonido digital descendente, tipo "whoosh triste"
      beep(220,0.18,'triangle',0.11);
      setTimeout(()=>beep(130,0.16,'triangle',0.09),90);
      setTimeout(()=>beep(80,0.13,'sine',0.07),180);
    }
    // Sonido de gloria para level up
    function soundGlory() {
      // Acorde mayor brillante
      beep(523,0.22,'triangle',0.13); // C5
      beep(659,0.22,'triangle',0.11); // E5
      beep(784,0.22,'triangle',0.10); // G5
      setTimeout(() => beep(1046, 0.18, 'triangle', 0.10), 180); // C6
      setTimeout(() => beep(1318, 0.13, 'triangle', 0.08), 320); // E6
    }
  }

  /* ========= Controles ========= */
  // Inicializar controles despu√©s de que el DOM est√© listo
  function initializeControls() {
    // === DROPDOWNS ===
    
    // --- Nivel 1 dropdown ---
    const btnNivel1 = document.getElementById('btnNivel1');
    const nivel1Box = document.getElementById('nivel1Box');
    const nivel1Arrow = document.getElementById('nivel1Arrow');
    if(btnNivel1 && nivel1Box) {
      btnNivel1.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel1Box.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          nivel1Box.classList.remove('opacity-100', 'scale-y-100');
          nivel1Box.classList.add('opacity-0', 'scale-y-95');
          if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            nivel1Box.classList.add('hidden');
          }, 300);
        } else {
          // Abrir
          nivel1Box.classList.remove('hidden');
          setTimeout(() => {
            nivel1Box.classList.remove('opacity-0', 'scale-y-95');
            nivel1Box.classList.add('opacity-100', 'scale-y-100');
            if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!nivel1Box.classList.contains('hidden')) {
          if (!nivel1Box.contains(e.target) && e.target !== btnNivel1) {
            nivel1Box.classList.remove('opacity-100', 'scale-y-100');
            nivel1Box.classList.add('opacity-0', 'scale-y-95');
            if(nivel1Arrow) nivel1Arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              nivel1Box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // --- Nivel 2 dropdown ---
    const btnNivel2 = document.getElementById('btnNivel2');
    const nivel2Box = document.getElementById('nivel2Box');
    const nivel2Arrow = document.getElementById('nivel2Arrow');
    if(btnNivel2 && nivel2Box) {
      btnNivel2.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel2Box.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          nivel2Box.classList.remove('opacity-100', 'scale-y-100');
          nivel2Box.classList.add('opacity-0', 'scale-y-95');
          if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            nivel2Box.classList.add('hidden');
          }, 300);
        } else {
          // Abrir
          nivel2Box.classList.remove('hidden');
          setTimeout(() => {
            nivel2Box.classList.remove('opacity-0', 'scale-y-95');
            nivel2Box.classList.add('opacity-100', 'scale-y-100');
            if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!nivel2Box.classList.contains('hidden')) {
          if (!nivel2Box.contains(e.target) && e.target !== btnNivel2) {
            nivel2Box.classList.remove('opacity-100', 'scale-y-100');
            nivel2Box.classList.add('opacity-0', 'scale-y-95');
            if(nivel2Arrow) nivel2Arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              nivel2Box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // --- Desaf√≠o dropdown ---
    const btnChallenge = document.getElementById('btnChallenge');
    const challengeBox = document.getElementById('challengeBox');
    const challengeArrow = document.getElementById('challengeArrow');
    if(btnChallenge && challengeBox) {
      btnChallenge.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !challengeBox.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          challengeBox.classList.remove('opacity-100', 'scale-y-100');
          challengeBox.classList.add('opacity-0', 'scale-y-95');
          if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            challengeBox.classList.add('hidden');
          }, 300);
        } else {
          // Abrir
          challengeBox.classList.remove('hidden');
          setTimeout(() => {
            challengeBox.classList.remove('opacity-0', 'scale-y-95');
            challengeBox.classList.add('opacity-100', 'scale-y-100');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!challengeBox.classList.contains('hidden')) {
          if (!challengeBox.contains(e.target) && e.target !== btnChallenge) {
            challengeBox.classList.remove('opacity-100', 'scale-y-100');
            challengeBox.classList.add('opacity-0', 'scale-y-95');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              challengeBox.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // === BOTONES DE UNIDADES ===
    
    // Botones de unidades Nivel 1
    const btnUnit2 = document.getElementById('btnUnit2');
    if(btnUnit2) btnUnit2.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit2'); };
    const btnUnit3 = document.getElementById('btnUnit3');
    if(btnUnit3) btnUnit3.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit3'); };
    const btnUnit4 = document.getElementById('btnUnit4');
    if(btnUnit4) btnUnit4.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit4'); };
    const btnUnit5 = document.getElementById('btnUnit5');
    if(btnUnit5) btnUnit5.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit5'); };
    const btnUnit6 = document.getElementById('btnUnit6');
    if(btnUnit6) btnUnit6.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit6'); };
    const btnUnit7 = document.getElementById('btnUnit7');
    if(btnUnit7) btnUnit7.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit7'); };
    const btnUnit8 = document.getElementById('btnUnit8');
    if(btnUnit8) btnUnit8.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit8'); };
    const btnUnit9 = document.getElementById('btnUnit9');
    if(btnUnit9) btnUnit9.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('unit9'); };
    
    // Botones especiales Nivel 1
    const btnTodoN1 = document.getElementById('btnTodoN1');
    if(btnTodoN1) btnTodoN1.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('todoN1'); };
    const btnDesafioN1 = document.getElementById('btnDesafioN1');
    if(btnDesafioN1) btnDesafioN1.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('desafioN1'); };
    
    // Botones de unidades Nivel 2
    const btnUnit1N2 = document.getElementById('btnUnit1N2');
    if(btnUnit1N2) btnUnit1N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit1N2'); };
    const btnUnit2N2 = document.getElementById('btnUnit2N2');
    if(btnUnit2N2) btnUnit2N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit2N2'); };
    const btnUnit3N2 = document.getElementById('btnUnit3N2');
    if(btnUnit3N2) btnUnit3N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit3N2'); };
    const btnUnit4N2 = document.getElementById('btnUnit4N2');
    if(btnUnit4N2) btnUnit4N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit4N2'); };
    const btnUnit5N2 = document.getElementById('btnUnit5N2');
    if(btnUnit5N2) btnUnit5N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit5N2'); };
    const btnUnit6N2 = document.getElementById('btnUnit6N2');
    if(btnUnit6N2) btnUnit6N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit6N2'); };
    const btnUnit7N2 = document.getElementById('btnUnit7N2');
    if(btnUnit7N2) btnUnit7N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit7N2'); };
    const btnUnit8N2 = document.getElementById('btnUnit8N2');
    if(btnUnit8N2) btnUnit8N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit8N2'); };
    const btnUnit9N2 = document.getElementById('btnUnit9N2');
    if(btnUnit9N2) btnUnit9N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit9N2'); };
    const btnUnit10N2 = document.getElementById('btnUnit10N2');
    if(btnUnit10N2) btnUnit10N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('unit10N2'); };
    const btnTodoN2 = document.getElementById('btnTodoN2');
    if(btnTodoN2) btnTodoN2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('todoN2'); };
    
    // Botones de desaf√≠o
    const btnDesafioClassico = document.getElementById('btnDesafioClassico');
    if(btnDesafioClassico) btnDesafioClassico.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startMission('challenge'); };
    const btnDesafioMenos = document.getElementById('btnDesafioMenos');
    if(btnDesafioMenos) btnDesafioMenos.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startChallengeCustom('menos'); };
    const btnDesafioMas = document.getElementById('btnDesafioMas');
    if(btnDesafioMas) btnDesafioMas.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); startChallengeCustom('mas'); };
  }

  document.getElementById('btnKnown').onclick   = () => startMission('known');
  // Filtros de categor√≠a para la tabla de conocidos
  document.getElementById('btnCatAll').onclick = () => { knownCatFilter = 'ALL'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatS').onclick   = () => { knownCatFilter = 'S'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatA').onclick   = () => { knownCatFilter = 'A'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatV').onclick   = () => { knownCatFilter = 'V'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatP').onclick   = () => { knownCatFilter = 'P'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatE').onclick   = () => { knownCatFilter = 'E'; showKnownTableWithAnimations(); };
  document.getElementById('btnRevise1').onclick = () => startMission('revise1');
  document.getElementById('btnRevise2').onclick = () => startMission('revise2');

  // btnChallenge onclick manejado por dropdown m√°s abajo
  document.getElementById('btnQuizPinyin').onclick  = () => {
    // LIMPIAR CLASES DE DESAF√çO
    bodyEl.classList.remove('challenge-bg');
    statBox.classList.remove('challenge-stat');
    stopDesafioMusic();
    setMode('quizPinyin');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };
  document.getElementById('btnQuizMeaning').onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    bodyEl.classList.remove('challenge-bg');
    statBox.classList.remove('challenge-stat');
    stopDesafioMusic();
    setMode('quizMeaning');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP  
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset de 10px m√°s arriba para mejor espacio visual
        setTimeout(() => {
          window.scrollBy({ top: -10, behavior: 'smooth' });
        }, 300);
      }
    }, 100);
  };

  document.getElementById('btnKnownTable').onclick = () => {
    if (currentMission === 'challenge') {
      showChallengeWarning();
      // Salir de desaf√≠o y mostrar conocidas
      startMission('known');
      setTimeout(() => {
        overlayField = 'hanzi';
        showKnownTableWithAnimations();
        window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
      }, 120);
    } else {
      overlayField = 'hanzi';
      showKnownTableWithAnimations();
      window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
    }
  };

  // Funci√≥n para detectar level up y perdidos y disparar animaciones
  function showKnownTableWithAnimations() {
    // Estado actual
    const currentKnown = cards.filter(c => c.known).map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    // Detectar level up
    const prevMap = Object.fromEntries(prevKnownState.map(c => [c.id, c]));
    const levelUpIds = [];
    for (const c of currentKnown) {
      if (prevMap[c.id] && c.streak > prevMap[c.id].streak) {
        levelUpIds.push(c.id);
      }
    }
    // Detectar perdidos
    const currentIds = new Set(currentKnown.map(c => c.id));
    const lostChars = prevKnownState.filter(c => !currentIds.has(c.id));
    // Guardar para animaciones siguientes
    window._levelUpIds = levelUpIds;
    window._lostChars = lostChars;
    // Renderizar tabla con animaciones (siguiente paso)
    renderKnownGridWithAnimations(levelUpIds, lostChars);
    // Guardar nuevo estado previo para la pr√≥xima vez
    prevKnownState = currentKnown.map(c => ({ ...c }));
  }
  document.getElementById('btnShowHanzi').onclick   = ()=>{ overlayField='hanzi'; showKnownTableWithAnimations(); };
  document.getElementById('btnShowPinyin').onclick  = ()=>{ overlayField='pinyin'; showKnownTableWithAnimations(); };
  document.getElementById('btnShowMeaning').onclick = ()=>{ overlayField='meaning'; showKnownTableWithAnimations(); };

  document.getElementById('btnKnow').onclick     = () => respond(true);
  document.getElementById('btnDontKnow').onclick = () => respond(false);
  document.getElementById('btnFlip').onclick     = () => {
    if(mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); }
  };
  cardEl.onclick = () => {
    if(currentCard && mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); }
  };


  document.getElementById('btnReset').onclick = async () => {
    if(!confirm('¬øReiniciar TODO? Se borrar√° el progreso y se cargar√°n las Unidades 2‚Äì9.')) return;
    cards = [];
    nivel2Unlocked = false;
    await saveUserState();
    await loadAll();
    startMission('unit2');
  };

  // Bot√≥n de reiniciar XP
  document.getElementById('btnResetXP').onclick = () => {
    if(confirm('¬øSeguro que quieres reiniciar tu Nivel a 0?')) {
      xpPoints = 0;
      saveXP();
      renderXPBar();
    }
  };

  // Bot√≥n "si se traba" para refrescar la p√°gina
  // COMENTADO - BOT√ìN NO EXISTE EN HTML
  /*
  document.getElementById('btnSiSeTraba').onclick = () => {
    location.reload();
  };
  */

  // Mensaje temporal para modo desaf√≠o (funci√≥n utilitaria)
  function showChallengeWarning() {
    let msg = document.getElementById('challengeWarningMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'challengeWarningMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-rose-700 text-white px-6 py-3 rounded-2xl shadow-lg text-base font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      msg.textContent = 'Desafio terminado. No se puede ver la tabla cuando est√°s en modo desaf√≠o';
      document.body.appendChild(msg);
    }
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 1800);
  }

// --- Funci√≥n para iniciar desaf√≠os personalizados ---
function startChallengeCustom(tipo) {
  let pool;
  if(tipo === 'menos') {
    pool = shuffle(cards.filter(c => c.known && (c.challengeStreak === 0 || c.challengeStreak === 1)));
  } else if(tipo === 'mas') {
    pool = shuffle(cards.filter(c => c.known && c.challengeStreak >= 2));
  } else {
    pool = shuffle(cards.filter(c => c.known));
  }
  sessionQueue = pool.slice(0,10); // 10 tarjetas por desaf√≠o personalizado
  currentMission = 'challenge';
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  setMode(Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin');
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  
  // Iniciar timer y vidas para el desaf√≠o
  startChallengeTimer();
  
  // ¬°REPRODUCIR M√öSICA DE DESAF√çO!
  playDesafioMusic();
  
  nextCard();
  updateStats();
}
// ========= Fin de cambios ========= */


  /* ========= AUTO-BLUR PARA ELIMINAR FOCUS PERSISTENTE EN M√ìVIL ========= */
  // Quitar focus de cualquier bot√≥n cuando se toca en cualquier parte de la pantalla
  document.addEventListener('touchend', (e) => {
    // Si no se toc√≥ un bot√≥n, quitar focus de todos los botones
    if (!e.target.tagName || e.target.tagName.toLowerCase() !== 'button') {
      const allButtons = document.querySelectorAll('button');
      allButtons.forEach(btn => {
        if (document.activeElement === btn) {
          btn.blur();
        }
      });
    }
  }, { passive: true });

  /* ========= Temporizador para racha ========= */
  setInterval(updateStreakBox, 60_000);

  /* ========= Inicio ========= */
  // Inicializar controles cuando el DOM est√© listo
  initializeControls();
  loadAll();
  loadXP();
  renderXPBar();
  startMission('unit2');
  </script>
</body>
</html>
