<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1, shrink-to-fit=no" />
  <title>MacaLaoshi Flashcards</title>
  <!-- Test push to GitHub main - 9 oct 2025 -->
  <!-- Evitar b√∫squeda autom√°tica de favicon -->
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  
  <!-- üé≠ SISTEMA DE HISTORIA - Cargado desde archivo separado -->
  <script>
    // Variables de control para el sistema de historia
    let storySystemLoaded = false;
    let pendingStoryAction = null;
    
    // Funci√≥n temporal que se ejecuta si el sistema a√∫n no est√° cargado
    window.showChapterModal = function() {
      if (storySystemLoaded) {
        // Si ya est√° cargado, ejecutar la funci√≥n real
        return window._actualShowChapterModal();
      } else {
        // Si no est√° cargado, mostrar loading y guardar la acci√≥n
        console.log('üé≠ Sistema de historia cargando... esperando...');
        pendingStoryAction = 'showChapterModal';
        
        // Mostrar modal de carga temporal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'storyLoadingModal';
        loadingModal.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
        loadingModal.style.backdropFilter = 'blur(5px)';
        
        loadingModal.innerHTML = `
          <div class="bg-gradient-to-br from-purple-900 to-indigo-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-purple-400">
            <div class="text-6xl mb-4">üìö</div>
            <h2 class="text-2xl font-bold mb-4 jersey-font-niveles">Cargando Historia...</h2>
            <div class="flex items-center justify-center gap-4">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-400"></div>
              <span class="jersey-font-dropdown">Preparando aventuras...</span>
            </div>
          </div>
        `;
        
        document.body.appendChild(loadingModal);
      }
    };
    
    // ========== DETECCI√ìN DE DISPOSITIVO ==========
    function isMobilePhoneOnly() {
      // Nueva funci√≥n: Solo detecta tel√©fonos m√≥viles peque√±os
      // Tablets y desktop usan bonfiredesktop.mp4
      // Solo phones peque√±os usan bonfirehigh.mp4
      
      const userAgent = navigator.userAgent.toLowerCase();
      const screenWidth = window.innerWidth || screen.width;
      const screenPhysicalWidth = screen.width;
      const screenHeight = window.innerHeight || screen.height;
      const screenPhysicalHeight = screen.height;
      
      // Detectar espec√≠ficamente tel√©fonos (no tablets)
      const phoneKeywords = ['iphone', 'android.*mobile', 'blackberry', 'windows phone'];
      const isPhoneUA = phoneKeywords.some(keyword => {
        return new RegExp(keyword).test(userAgent);
      });
      
      // Excluir tablets expl√≠citamente
      const tabletKeywords = ['ipad', 'tablet', 'kindle'];
      const isTabletUA = tabletKeywords.some(keyword => userAgent.includes(keyword));
      
      // Criterios de pantalla peque√±a (t√≠picos de phones)
      const hasSmallScreen = screenPhysicalWidth <= 480 || screenPhysicalHeight <= 800;
      const hasNarrowAspect = (screenPhysicalWidth / screenPhysicalHeight) < 0.75; // Muy estrecho
      
      // Es tel√©fono m√≥vil si:
      // 1. User Agent indica phone Y NO es tablet
      // 2. O tiene pantalla muy peque√±a/estrecha Y tiene touch
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      const isMobilePhone = (isPhoneUA && !isTabletUA) || 
                           (hasSmallScreen && isTouchDevice && !isTabletUA) ||
                           (hasNarrowAspect && isTouchDevice && !isTabletUA);
      
      console.log('ÔøΩ Detecci√≥n dispositivo:', {
        userAgent: userAgent.substring(0, 60) + '...',
        screenWidth,
        screenPhysicalWidth,
        screenHeight,
        screenPhysicalHeight,
        isPhoneUA,
        isTabletUA,
        hasSmallScreen,
        hasNarrowAspect,
        isTouchDevice,
        deviceType: isMobilePhone ? 'TEL√âFONO M√ìVIL' : 'DESKTOP/TABLET'
      });
      
      return isMobilePhone;
    }

    // ========== SISTEMA DE VIDEO DE FONDO INICIAL ==========
    let initialVideoElement = null;

    function createInitialBackgroundVideo() {
      // Remover video anterior si existe
      if (initialVideoElement && initialVideoElement.parentNode) {
        initialVideoElement.parentNode.removeChild(initialVideoElement);
      }

      // Crear elemento de video con detecci√≥n de dispositivo
      initialVideoElement = document.createElement('video');
      
      // Seleccionar video seg√∫n dispositivo
      // Solo tel√©fonos m√≥viles usan bonfirehigh.mp4
      // Desktop y tablets usan bonfiredesktop.mp4
      const videoSrc = isMobilePhoneOnly() ? 'img/bonfirehigh.mp4' : 'img/bonfiredesktop.mp4';
      initialVideoElement.src = videoSrc;
      
      console.log('üé¨ Video seleccionado:', videoSrc);
      
      // Configuraci√≥n optimizada para carga r√°pida
      initialVideoElement.setAttribute('autoplay', '');
      initialVideoElement.setAttribute('muted', '');
      initialVideoElement.setAttribute('loop', '');
      initialVideoElement.setAttribute('playsinline', ''); // Importante para iOS
      initialVideoElement.setAttribute('preload', 'metadata'); // Solo carga metadatos primero
      
      // Optimizaci√≥n: Reducir calidad autom√°ticamente
      initialVideoElement.style.filter = 'brightness(0.9)'; // Reduce brillo ligeramente
      
      // CSS para recortar arriba y abajo (crop vertical)
      initialVideoElement.style.transform = 'scale(1.2)'; // Agranda para recortar
      initialVideoElement.style.objectPosition = 'center center'; // Centra el recorte
      
      // Propiedades JavaScript tambi√©n
      initialVideoElement.autoplay = true;
      initialVideoElement.loop = true;
      initialVideoElement.muted = true;
      initialVideoElement.playsInline = true;
      
      initialVideoElement.className = 'initial-video-bg';
      
      // Agregar al body
      document.body.appendChild(initialVideoElement);
      
      // Detectar velocidad de conexi√≥n y ajustar calidad
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (connection) {
        if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
          // Conexi√≥n muy lenta: no cargar video, usar imagen est√°tica
          const posterSrc = isMobilePhoneOnly() ? 'img/bonfirehigh.mp4' : 'img/bonfiredesktop.mp4';
          initialVideoElement.poster = posterSrc; // Usar primer frame del video apropiado
          initialVideoElement.preload = 'none';
          console.log('üêå Conexi√≥n lenta detectada, usando imagen est√°tica:', posterSrc);
          return;
        } else if (connection.effectiveType === '3g') {
          // Conexi√≥n 3G: reducir calidad m√°s
          initialVideoElement.style.filter += ' contrast(0.8) saturate(0.9)';
          console.log('üì∂ Conexi√≥n 3G: calidad reducida');
        }
      }

      // Carga progresiva: solo carga cuando es visible
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initialVideoElement.preload = 'auto';
            observer.disconnect();
          }
        });
      });
      observer.observe(initialVideoElement);

      // Intentar reproducir manualmente si autoplay falla
      initialVideoElement.addEventListener('loadeddata', () => {
        initialVideoElement.play().then(() => {
          const currentVideoSrc = isMobilePhoneOnly() ? 'bonfirehigh.mp4' : 'bonfiredesktop.mp4';
          console.log('üé¨ Video de fondo inicial reproduci√©ndose:', currentVideoSrc);
        }).catch(error => {
          console.log('‚ö†Ô∏è Autoplay bloqueado en m√≥vil, mostrando frame est√°tico');
          // En m√≥vil puede quedarse en el primer frame, pero al menos se ve algo
        });
      });
      
      const selectedVideo = isMobilePhoneOnly() ? 'bonfirehigh.mp4' : 'bonfiredesktop.mp4';
      console.log('üé¨ Video de fondo inicial creado:', selectedVideo);
    }

    function removeInitialBackgroundVideo() {
      if (initialVideoElement && initialVideoElement.parentNode) {
        initialVideoElement.parentNode.removeChild(initialVideoElement);
        initialVideoElement = null;
        
        // Restaurar fondo s√≥lido
        document.body.style.backgroundColor = '#100e37';
        
        console.log('üé¨ Video de fondo inicial removido, fondo s√≥lido restaurado');
      }
    }

    // Funci√≥n para detectar cuando se elige un modo
    function onModeSelected() {
      removeInitialBackgroundVideo();
    }

    // Interceptar clicks de modos para remover el video
    function interceptModeButtons() {
      const modeButtons = [
        'btnChallenge', 'btnNivel2', 'btnNivel3', 'btnHoroscopo', 'btnDesafiosHoroscopo'
      ];
      
      modeButtons.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            // COMENTADO: Para que el video no se vaya al elegir modo
            // setTimeout(onModeSelected, 100); // Peque√±o delay para que el modo se active primero
          });
        }
      });
    }

    // Funci√≥n para intentar reproducir el video en la primera interacci√≥n
    function tryPlayVideoOnInteraction() {
      if (initialVideoElement && initialVideoElement.paused) {
        initialVideoElement.play().then(() => {
          console.log('üé¨ Video iniciado tras interacci√≥n del usuario');
        }).catch(error => {
          console.log('‚ö†Ô∏è No se pudo iniciar video tras interacci√≥n:', error);
        });
      }
    }

    // Crear video de fondo inicial cuando carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      createInitialBackgroundVideo();
      interceptModeButtons(); // Mantener por si queremos reactivar despu√©s
      
      // Intentar reproducir en la primera interacci√≥n (para m√≥viles)
      ['touchstart', 'click', 'keydown'].forEach(event => {
        document.addEventListener(event, tryPlayVideoOnInteraction, { once: true });
      });
    });

    // Crear un iframe oculto para cargar el sistema de historia
    document.addEventListener('DOMContentLoaded', function() {
      const storyFrame = document.createElement('iframe');
      storyFrame.id = 'storySystemFrame';
      storyFrame.src = 'img/story.html';
      storyFrame.style.cssText = 'position: absolute; width: 0; height: 0; border: none; visibility: hidden;';
      document.body.appendChild(storyFrame);
      
      // Una vez que se carga el iframe, transferir las funciones globales
      storyFrame.onload = function() {
        try {
          const storyWindow = storyFrame.contentWindow;
          
          // Transferir todas las funciones de historia al scope global
          if (storyWindow.storyScenes) window.storyScenes = storyWindow.storyScenes;
          if (storyWindow.showChapterModal) window._actualShowChapterModal = storyWindow.showChapterModal;
          if (storyWindow.startChapter) window.startChapter = storyWindow.startChapter;
          if (storyWindow.showStoryScene) window.showStoryScene = storyWindow.showStoryScene;
          if (storyWindow.renderStoryScene) window.renderStoryScene = storyWindow.renderStoryScene;
          if (storyWindow.processDialoguePlaceholders) window.processDialoguePlaceholders = storyWindow.processDialoguePlaceholders;
          if (storyWindow.startTypewriterEffect) window.startTypewriterEffect = storyWindow.startTypewriterEffect;
          if (storyWindow.nextScene) window.nextScene = storyWindow.nextScene;
          if (storyWindow.showStoryCompletedMessage) window.showStoryCompletedMessage = storyWindow.showStoryCompletedMessage;
          if (storyWindow.closeStoryModal) window.closeStoryModal = storyWindow.closeStoryModal;
          
          // Variables globales
          window.currentStoryData = null;
          window.currentSceneIndex = 0;
          
          // Marcar como cargado
          storySystemLoaded = true;
          
          // Reemplazar la funci√≥n temporal con la real
          window.showChapterModal = window._actualShowChapterModal;
          
          console.log('üé≠ Sistema de Historia cargado exitosamente desde story.html');
          
          // Si hay una acci√≥n pendiente, ejecutarla
          if (pendingStoryAction === 'showChapterModal') {
            // Cerrar modal de loading
            const loadingModal = document.getElementById('storyLoadingModal');
            if (loadingModal) {
              loadingModal.remove();
            }
            
            // Ejecutar la acci√≥n pendiente
            setTimeout(() => {
              window.showChapterModal();
              pendingStoryAction = null;
            }, 100);
          }
          
        } catch (error) {
          console.error('‚ùå Error cargando sistema de historia:', error);
          
          // En caso de error, mostrar mensaje de error
          const loadingModal = document.getElementById('storyLoadingModal');
          if (loadingModal) {
            loadingModal.innerHTML = `
              <div class="bg-gradient-to-br from-red-900 to-purple-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-400">
                <div class="text-6xl mb-4">‚ùå</div>
                <h2 class="text-2xl font-bold mb-4 jersey-font-niveles">Error al Cargar</h2>
                <p class="mb-4 jersey-font-dropdown">No se pudo cargar el sistema de historia.</p>
                <button onclick="this.parentElement.parentElement.remove()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-2xl font-bold transition-all duration-300 jersey-font-dropdown">
                  Cerrar
                </button>
              </div>
            `;
          }
        }
      };
    });
  </script>
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="MacaFlash" />
  <!-- Prevent zoom on iOS -->
  <meta name="format-detection" content="telephone=no" />
  <!-- Prevenir zoom de accesibilidad -->
  <meta name="mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ========== REGLA ELIMINADA - PREVENIR ZOOM ========== */
    
    /* ========== BOT√ìN DE ASISTENCIA (LILI AYUDA) ========== */
    @keyframes assistanceGlow {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.85;
        transform: scale(1.05);
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    #assistanceButton:hover:not(.disabled) {
      transform: scale(1.1);
    }
    
    #assistanceButton.disabled {
      opacity: 0.3;
      filter: grayscale(1);
      cursor: not-allowed;
    }
    
    #assistanceButton.used-this-question {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Animaci√≥n glow para el contador */
    #assistanceCounter {
      animation: assistanceGlow 3s ease-in-out infinite;
    }
    
    /* Detener animaci√≥n cuando est√° agotado */
    #assistanceButton.disabled + #assistanceCounter {
      animation: none;
    }
    
    @keyframes dialogBounce {
      0% {
        opacity: 0;
        transform: translateY(-50%) translateX(-10px);
      }
      60% {
        transform: translateY(-50%) translateX(5px);
      }
      100% {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
    }
    
    @keyframes dialogFadeOut {
      0% {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
      }
      100% {
        opacity: 0;
        transform: translateY(-50%) translateX(-10px);
      }
    }
    
    .box-cell.eliminated {
      opacity: 0.3 !important;
      filter: grayscale(1) !important;
      pointer-events: none !important;
      position: relative;
    }
    
    .box-cell.shake {
      animation: shake 0.5s ease-in-out;
    }
    
    /* Responsive para m√≥viles */
    @media (max-width: 640px) {
      #assistanceButton {
        width: 70px !important;
        height: 70px !important;
      }
      #assistanceCounter {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
        bottom: -6px !important;
        right: -6px !important;
      }
    }
  </style>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <!-- Google Fonts - Jersey 10 para estilo pixel art -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jersey+10&display=swap" rel="stylesheet">
  <style>
    /* FONT DISPLAY SWAP PARA JERSEY 10 */
    * {
      font-display: swap;
    }
    
    /* Fallback para Jersey 10 */
    @font-face {
      font-family: 'Jersey 10 Fallback';
      src: local('Jersey 10'), local('Courier New'), monospace;
      font-display: swap;
    }

    /* ========== BARRA DE EXPERIENCIA PIXEL ART ========== */
    .xp-bar-container {
      width: 100%;
      height: 18px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 50%, #020617 100%);
      border: 2px solid #334155;
      border-bottom: 3px solid #0f172a;
      border-right: 3px solid #0f172a;
      border-top: 2px solid #64748b;
      border-left: 2px solid #64748b;
      position: relative;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    .xp-bar-container::before {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      right: 1px;
      bottom: 1px;
      border: 1px solid #475569;
      pointer-events: none;
    }

    .xp-bar-fill {
      height: 100%;
      background: var(--xp-bar-color, #3b82f6);
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-right: 1px solid rgba(0,0,0,0.3);
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    .xp-bar-fill::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 40%;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.4) 0%, 
        rgba(255,255,255,0.2) 50%, 
        rgba(255,255,255,0.1) 100%
      );
      pointer-events: none;
    }

    /* Animaci√≥n de brillo cuando sube XP */
    .xp-bar-fill.xp-gain {
      animation: xpGlow 0.8s ease-out;
    }

    @keyframes xpGlow {
      0% { 
        box-shadow: 0 0 0 rgba(96, 165, 250, 0);
        filter: brightness(1);
      }
      50% { 
        box-shadow: 0 0 15px rgba(96, 165, 250, 0.8), inset 0 0 10px rgba(255, 255, 255, 0.3);
        filter: brightness(1.3);
      }
      100% { 
        box-shadow: 0 0 0 rgba(96, 165, 250, 0);
        filter: brightness(1);
      }
    }

    /* Responsive para m√≥vil */
    @media (max-width: 640px) {
      .xp-bar-container {
        height: 16px;
      }
    }

    /* ---------- Base / flipping ---------- */
    .flip { transform: rotateY(180deg); }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotateY180 { transform: rotateY(180deg); }
    .perspective { perspective: 1000px; }
    .hidden { display: none; }

    /* ---------- Animaciones de feedback ---------- */
    @keyframes pop {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
      30%  { transform: scale(1.09);box-shadow: 0 0 45px rgba(16,185,129,.55); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-6px); }
      80%     { transform: translateX(6px); }
    }
    .popAnim   { animation: pop   420ms ease-out; }
    .shakeAnim { animation: shake 420ms ease; }

    @keyframes pulseGlow {
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
      50%  { box-shadow: 0 0 24px 8px var(--glow); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    .pulseBadge { animation: pulseGlow 700ms ease-out; }
    .pulseGreen { --glow: rgba(16,185,129,.85); } /* known */
    .pulseAmber { --glow: rgba(245,158,11,.85); } /* revise1 */
    .pulseTeal  { --glow: rgba(20,184,166,.85); } /* revise2 */

    /* ---------- Estado de opciones en QUIZ ---------- */
    .optCorrect {
      background-color: #059669 !important;
      color: #fff !important;
      box-shadow: 0 0 26px rgba(16,185,129,.75) !important;
      transform: scale(1.02);
    }
    .optWrong {
      background-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(220,38,38,.7) !important;
    }

    /* ---------- Tema ‚ÄúDesaf√≠o‚Äù ---------- */
    .challenge-bg   { margin-bottom: 15rem !important; } /* mantener fondo din√°mico */
    .challenge-stat { background-color: #6d28d9 !important; } /* morado vivo */
    
    /* Tema Desaf√≠o N2 - Rojo */
    .challenge-n2-bg   { margin-bottom: 15rem !important; } /* mantener fondo din√°mico */
    .challenge-n2-stat { background-color: #dc2626 !important; } /* rojo vivo */
    
    /* Tema Desaf√≠o N3 - Verde */
    .challenge-n3-bg   { margin-bottom: 15rem !important; } /* mantener fondo din√°mico */
    .challenge-n3-stat { background-color: #16a34a !important; } /* verde vivo */





    /* ---------- Dropdowns de Niveles con Efecto Vidrio ---------- */
    #nivel1Box {
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(15px) !important;
      -webkit-backdrop-filter: blur(15px) !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
    }

    #nivel2Box, #nivel3Box, #HSK3Box, #HSK4Box {
      background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(15px) !important;
      -webkit-backdrop-filter: blur(15px) !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important;
    }

    /* Botones de unidades dentro de los dropdowns - Nivel 1 */
    #btnUnit2, #btnUnit3, #btnUnit4, #btnUnit5, #btnUnit6, #btnUnit7, #btnUnit8, #btnUnit9, #btnTodoN1 {
      background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }

    #btnUnit2:hover, #btnUnit3:hover, #btnUnit4:hover, #btnUnit5:hover, #btnUnit6:hover, 
    #btnUnit7:hover, #btnUnit8:hover, #btnUnit9:hover, #btnTodoN1:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
    }

    /* Botones de unidades dentro de los dropdowns - Nivel 2 */
    #btnUnit1N2, #btnUnit2N2, #btnUnit3N2, #btnUnit4N2, #btnUnit5N2, 
    #btnUnit6N2, #btnUnit7N2, #btnUnit8N2, #btnUnit9N2, #btnTodoN2 {
      background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }

    #btnUnit1N2:hover, #btnUnit2N2:hover, #btnUnit3N2:hover, #btnUnit4N2:hover, #btnUnit5N2:hover,
    #btnUnit6N2:hover, #btnUnit7N2:hover, #btnUnit8N2:hover, #btnUnit9N2:hover, #btnTodoN2:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
    }

    /* Botones de unidades dentro de los dropdowns - Nivel 3 */
    #btnUnit1N3, #btnUnit2N3, #btnUnit3N3, #btnUnit4N3, #btnUnit5N3, 
    #btnUnit6N3, #btnUnit7N3, #btnUnit8N3, #btnUnit9N3, #btnTodoN3 {
      background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
    }

    #btnUnit1N3:hover, #btnUnit2N3:hover, #btnUnit3N3:hover, #btnUnit4N3:hover, #btnUnit5N3:hover,
    #btnUnit6N3:hover, #btnUnit7N3:hover, #btnUnit8N3:hover, #btnUnit9N3:hover, #btnTodoN3:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
    }

    /* Botones de unidades dentro de los dropdowns - HSK3 */
    #btnHSK3unit1, #btnHSK3unit2, #btnHSK3unit3, #btnHSK3unit4, #btnHSK3unit5, 
    #btnHSK3unit6, #btnHSK3unit7, #btnHSK3unit8, #btnHSK3unit9, #btnHSK3unit10,
    #btnHSK3unit11, #btnHSK3unit12, #btnHSK3unit13, #btnHSK3unit14, #btnHSK3unit15,
    #btnHSK3unit16, #btnHSK3unit17, #btnHSK3unit18, #btnHSK3unit19, #btnHSK3unit20 {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.569), rgba(255,255,255,0.1)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 1.125rem !important; /* 18px - texto del bot√≥n m√°s grande */
    }

    /* Hacer los spans blancos y m√°s grandes dentro de los botones HSK3 */
    #btnHSK3unit1 span, #btnHSK3unit2 span, #btnHSK3unit3 span, #btnHSK3unit4 span, #btnHSK3unit5 span,
    #btnHSK3unit6 span, #btnHSK3unit7 span, #btnHSK3unit8 span, #btnHSK3unit9 span, #btnHSK3unit10 span,
    #btnHSK3unit11 span, #btnHSK3unit12 span, #btnHSK3unit13 span, #btnHSK3unit14 span, #btnHSK3unit15 span,
    #btnHSK3unit16 span, #btnHSK3unit17 span, #btnHSK3unit18 span, #btnHSK3unit19 span, #btnHSK3unit20 span {
      color: #ffffff !important;
      font-size: 1.4rem !important; /* Contador m√°s grande */
    }

    #btnHSK3unit1:hover, #btnHSK3unit2:hover, #btnHSK3unit3:hover, #btnHSK3unit4:hover, #btnHSK3unit5:hover,
    #btnHSK3unit6:hover, #btnHSK3unit7:hover, #btnHSK3unit8:hover, #btnHSK3unit9:hover, #btnHSK3unit10:hover,
    #btnHSK3unit11:hover, #btnHSK3unit12:hover, #btnHSK3unit13:hover, #btnHSK3unit14:hover, #btnHSK3unit15:hover,
    #btnHSK3unit16:hover, #btnHSK3unit17:hover, #btnHSK3unit18:hover, #btnHSK3unit19:hover, #btnHSK3unit20:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
    }

    /* Botones de unidades dentro de los dropdowns - HSK4 */
    #btnHSK4unit1, #btnHSK4unit2, #btnHSK4unit3, #btnHSK4unit4, #btnHSK4unit5, 
    #btnHSK4unit6, #btnHSK4unit7, #btnHSK4unit8, #btnHSK4unit9, #btnHSK4unit10,
    #btnHSK4unit11, #btnHSK4unit12, #btnHSK4unit13, #btnHSK4unit14, #btnHSK4unit15,
    #btnHSK4unit16, #btnHSK4unit17, #btnHSK4unit18, #btnHSK4unit19, #btnHSK4unit20 {
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.597), rgba(255,255,255,0.1)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255,255,255,0.3) !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 1.125rem !important; /* 18px - texto del bot√≥n m√°s grande */
    }

    /* Hacer los spans blancos y m√°s grandes dentro de los botones HSK4 */
    #btnHSK4unit1 span, #btnHSK4unit2 span, #btnHSK4unit3 span, #btnHSK4unit4 span, #btnHSK4unit5 span,
    #btnHSK4unit6 span, #btnHSK4unit7 span, #btnHSK4unit8 span, #btnHSK4unit9 span, #btnHSK4unit10 span,
    #btnHSK4unit11 span, #btnHSK4unit12 span, #btnHSK4unit13 span, #btnHSK4unit14 span, #btnHSK4unit15 span,
    #btnHSK4unit16 span, #btnHSK4unit17 span, #btnHSK4unit18 span, #btnHSK4unit19 span, #btnHSK4unit20 span {
      color: #ffffff !important;
      font-size: 1.4rem !important; /* Contador m√°s grande */
    }

    #btnHSK4unit1:hover, #btnHSK4unit2:hover, #btnHSK4unit3:hover, #btnHSK4unit4:hover, #btnHSK4unit5:hover,
    #btnHSK4unit6:hover, #btnHSK4unit7:hover, #btnHSK4unit8:hover, #btnHSK4unit9:hover, #btnHSK4unit10:hover,
    #btnHSK4unit11:hover, #btnHSK4unit12:hover, #btnHSK4unit13:hover, #btnHSK4unit14:hover, #btnHSK4unit15:hover,
    #btnHSK4unit16:hover, #btnHSK4unit17:hover, #btnHSK4unit18:hover, #btnHSK4unit19:hover, #btnHSK4unit20:hover {
      background: linear-gradient(145deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important;
    }

    /* ---------- Overlay Tabla Conocidas ---------- */
    .overlay {
      position: fixed; inset: 0; z-index: 40; display: flex; align-items: center; justify-content: center;
      background: rgba(2,6,23,.75);
    }
    .overlayCard { width: min(1100px, 95vw); height: min(90vh, 900px); }
    /* Scroll for known table grid */
/* Scroll for known table grid - 4 columnas en m√≥vil, m√°s en desktop */
    #knownGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100px, 22vw), 1fr));
      gap: 6px;
      pointer-events: auto !important;
      z-index: 1 !important;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }

    .squareCell{
      aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden; white-space:nowrap; padding:10px;
      text-align:center; user-select:none;
    }
    .streak-badge{
      position:absolute; right:6px; bottom:6px;
      padding:2px 6px; border-radius:10px; font-size:12px; font-weight:700;
      color:#0B1020; background:#3B82F6;
      box-shadow:0 0 10px rgba(0,0,0,.25);
    }


    /* --- Fondo con video para desaf√≠os ---  */
    .challenge-bg {
      margin: 0 0 15rem 0;
      position: relative;
      /* Mantener el fondo din√°mico y agregar overlay morado sutil */
    }
    
    .challenge-bg::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(76, 29, 149, 0.2), rgba(109, 40, 217, 0.1));
      z-index: -1;
      pointer-events: none;
    }

    /* Video de fondo para desaf√≠os */
    .challenge-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.8;
      pointer-events: none;
    }

    /* Estilo de video de fondo alternativo usando elemento video */
    .challenge-video-bg {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      z-index: -1 !important;
      opacity: 1 !important;
      pointer-events: none !important;
    }

    /* Video de fondo inicial antes de elegir modo - Optimizado */
    .initial-video-bg {
      position: fixed !important;
      top: -10% !important; /* Recorte superior */
      left: 0 !important;
      width: 100% !important;
      height: 120% !important; /* Aumenta altura para recortar */
      object-fit: cover !important;
      z-index: -1 !important;
      opacity: 1 !important;
      pointer-events: none !important;
      /* Filtros para reducir "peso visual" */
      filter: brightness(0.9) contrast(0.9) !important;
      /* Optimizaci√≥n de renderizado */
      will-change: auto !important;
      backface-visibility: hidden !important;
    }

    /* Pantalla de precarga para videos */
    #videoPreloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .preloader-overlay {
      text-align: center;
      color: white;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .preloader-content {
      max-width: 400px;
      width: 90%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .preloader-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    .preloader-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      font-family: 'Jersey 10', monospace;
      text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.8);
      letter-spacing: 2px;
    }

    .preloader-text {
      font-size: 1.2rem;
      opacity: 0.8;
      margin-bottom: 1.5rem;
      font-family: 'Jersey 10', monospace;
      letter-spacing: 1px;
    }

    .preloader-progress {
      width: 100%;
      max-width: 350px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin: 0 auto;
    }

    .preloader-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }

    /* Estilos para cuenta regresiva */
    .countdown-content {
      text-align: center;
      color: white;
      padding: 2rem;
      display: flex !important;
      flex-direction: column;
      align-items: center;
      justify-content: center !important;
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      margin: 0 !important;
      z-index: 10001 !important;
      background: rgba(0, 0, 0, 0.95);
    }

    .countdown-title {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      font-family: 'Jersey 10', monospace;
      color: #4ade80;
      text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.8);
      letter-spacing: 3px;
    }

    @media (max-width: 640px) {
      .countdown-title {
        font-size: 2rem;
      }
    }

    .countdown-number {
      font-size: 8rem;
      font-weight: bold;
      font-family: 'Jersey 10', monospace;
      color: #ffffff;
      margin: 1rem auto;
      text-shadow: 0 0 20px rgba(74, 222, 128, 0.8), 4px 4px 0px rgba(0, 0, 0, 0.8);
      animation: countdownPulse 1s ease-in-out;
      letter-spacing: 4px;
      text-align: center;
      display: block;
      width: 100%;
      line-height: 1;
    }

    @media (max-width: 640px) {
      .countdown-number {
        font-size: 6rem;
      }
    }

    .countdown-text {
      font-size: 1.4rem;
      opacity: 0.9;
      margin-top: 1rem;
      font-family: 'Jersey 10', monospace;
      letter-spacing: 2px;
    }

    @media (max-width: 640px) {
      .countdown-text {
        font-size: 1.2rem;
      }
    }

    @keyframes countdownPulse {
      0% { 
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    /* --- Fondo espec√≠fico para desaf√≠os del hor√≥scopo - DESHABILITADO PARA PRUEBA --- */
    .horoscope-bg {
      margin: 0 0 15rem 0;
      /* Mantener fondo din√°mico y agregar overlay dorado sutil */
    }
    
    .horoscope-bg::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(245, 204, 92, 0.15), rgba(255, 245, 209, 0.08));
      z-index: -1;
      pointer-events: none;
    }

    /* Horizontal */
    @keyframes bpx {
      0%, 7.5%, 100% { background-position-x: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-x: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-x: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-x: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-x: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-x: 0, -6em, 0, 6em, 12em; }
    }

    /* Vertical */
    @keyframes bpy {
      0%, 7.5%, 100% { background-position-y: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-y: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-y: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-y: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-y: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-y: 0, -6em, 0, 6em, 12em; }
    }

    /* --- Fondo din√°mico N2 - Rojo - DESHABILITADO PARA PRUEBA --- */
    .challenge-n2-bg {
      margin: 0 0 5rem 0;
      background-color: #711515;
      /* ANIMACIONES DE FONDO COMENTADAS PARA PRUEBA DE RENDIMIENTO
      background-image:
        radial-gradient(transparent 1.2em, #991b1b 0.6em),
        conic-gradient(at 2em 2em, transparent 270deg, #c62e2ea5 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #640e0e95 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #9c2525a0 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #600d0d3e 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em;
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
      */
    }

    /* --- Fondo din√°mico N3 - Verde - DESHABILITADO PARA PRUEBA --- */
    .challenge-n3-bg {
      margin: 0 0 5rem 0;
      background-color: #3fb66e;
      /* ANIMACIONES DE FONDO COMENTADAS PARA PRUEBA DE RENDIMIENTO
      background-image:
        radial-gradient(transparent 1.2em, #166534 0.6em),
        conic-gradient(at 2em 2em, transparent 270deg, #21b05683 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #17a94d87 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #1f9d4d6c 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #207f4363 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em;
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
      */
    }

    /* --- Animaci√≥n para tarjeta incorrecta --- */
.cardWrong {
  box-shadow: 0 0 0 9999px rgba(220,38,38,0.3) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}
.cardWrongFade {
  box-shadow: 0 0 0 0 rgba(220,38,38,0) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}

/* --- Fade out para casillas correctas e incorrectas --- */
.optCorrectFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #05966933 !important;
  box-shadow: 0 0 0 rgba(16,185,129,0) !important;
}
.optWrongFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #dc262633 !important;
  box-shadow: 0 0 0 rgba(220,38,38,0) !important;
}

/* Transici√≥n flip hacia arriba entre tarjetas */
.card-flip-up-out {
  transform: rotateX(90deg);
  opacity: 0;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}
.card-flip-up-in {
  transform: rotateX(-90deg);
  opacity: 0;
}
.card-flip-up-in.card-flip-animate {
  transform: rotateX(0deg);
  opacity: 1;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}

/* Flip vertical transici√≥n entre tarjetas (cambio de contenido en el medio) */
.card-flip-vert {
  transition: transform 0.44s cubic-bezier(.4,0,.2,1);
  transform-style: preserve-3d;
}
.card-flip-vert.flipping {
  transform: rotateX(90deg);
}
.card-flip-vert.flipped {
  transform: rotateX(0deg);
}

  
    /* Animaci√≥n de glow dorado intensificado para tarjetas premium */
    /* @keyframes goldGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
    .premium-gold {
      background: linear-gradient(155deg, #e7d173 0%, #d4be5e 25%, #dec557 50%, #d4be5e 75%, #e7d173 100%) !important;
      border: 2px solid #f3d54f !important;
      box-shadow: 0 0 8px 2px hsla(51, 87%, 56%, 0.816), 0 0 0 2px #fffbe6; /* Estado base con glow sutil */
      /* animation: goldGlow 2.5s ease-in-out forwards; */ /* COMENTADO - Animaci√≥n de glow deshabilitada */
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }
    @keyframes goldGlow {
      0%   { box-shadow: 0 0 8px 2px #ffd70099; }
      50%  { box-shadow: 0 0 16px 4px #f6dc4dcc; }
      70%  { box-shadow: 0 0 10px 3px #ffd70088; }
      85%  { box-shadow: 0 0 5px 1px #ffd70066; }
      100% { box-shadow: 0 0 2px 0.5px #ffd70044; }
    }

    /* Tarjeta m√≠tica violeta para desaf√≠os */
    @keyframes mythicGlow {
      0%   { box-shadow: 0 0 8px 2px #a78bfa99; }
      50%  { box-shadow: 0 0 16px 4px #a78bface; }
      70%  { box-shadow: 0 0 10px 3px #a78bfa88; }
      85%  { box-shadow: 0 0 5px 1px #a78bfa66; }
      100% { box-shadow: 0 0 2px 0.5px #a78bfa44; }
    }
    .mythic-violet {
      background: linear-gradient(145deg, #a99af5 0%, #7356cc 100%) !important;
      border: 2px solid #a78bfa !important;
      box-shadow: 0 0 8px 2px #a78bfa44, 0 0 0 2px #ede9fe; /* Estado base con glow sutil */
      /* animation: mythicGlow 2.2s ease-in-out forwards; */ /* COMENTADO - Animaci√≥n de glow deshabilitada */
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }

    /* Tarjeta legendaria roja para desaf√≠o */
    @keyframes legendaryGlow {
      0%   { box-shadow: 0 0 8px 2px #f8717199; }
      50%  { box-shadow: 0 0 16px 4px #f87171cc; }
      70%  { box-shadow: 0 0 10px 3px #f8717188; }
      85%  { box-shadow: 0 0 5px 1px #f8717166; }
      100% { box-shadow: 0 0 2px 0.5px #f8717144; }
    }
    .legendary-red {
      background: linear-gradient(135deg, #f57f7f 0%, #fb4646 100%) !important;
      border: 4px solid #f87171 !important;
      box-shadow: 0 0 8px 2px #f8717144, 0 0 0 2px #fee2e2; /* Estado base con glow sutil */
      /* animation: legendaryGlow 2.2s ease-in-out forwards; */ /* COMENTADO - Animaci√≥n de glow deshabilitada */
      transition: background 0.3s, border 0.3s, box-shadow 1.5s ease-out;
    }

    /* Clases para pausar animaciones especiales y aplicar glow verde cuando es correcto */
    /* DESHABILITADO: Estas clases causaban conflictos con las transiciones de flip
    .premium-gold.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .mythic-violet.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    
    .legendary-red.correct-override {
      animation: none !important;
      box-shadow: 0 0 45px rgba(16,185,129,.75) !important;
      transform: scale(1.09) !important;
    }
    */

    /* ========== TARJETAS ESPECIALES DE LA EMPERATRIZ ========== */
    /* Tarjeta Naranja - Buff +100% da√±o - SOLO CARTEL COLOREADO */
    .emperatriz-orange .card-category-badge {
      background: rgba(255, 140, 66, 0.9) !important;
      color: white !important;
    }
    
    .emperatriz-orange .card-hanzi,
    .emperatriz-orange .card-pinyin,
    .emperatriz-orange .card-translation {
      color: white !important;
    }

    /* Tarjeta Celeste - Tiempo +20 segundos - SOLO CARTEL COLOREADO */
    .emperatriz-cyan .card-category-badge {
      background: rgba(34, 211, 238, 0.9) !important;
      color: white !important;
    }
    
    .emperatriz-cyan .card-hanzi,
    .emperatriz-cyan .card-pinyin,
    .emperatriz-cyan .card-translation {
      color: white !important;
    }

    /* Tarjeta Bordo/Crimson - Debuff -50% da√±o - SOLO CARTEL COLOREADO */
    .emperatriz-crimson .card-category-badge {
      background: rgba(159, 18, 57, 0.9) !important;
      color: white !important;
    }
    
    .emperatriz-crimson .card-hanzi,
    .emperatriz-crimson .card-pinyin,
    .emperatriz-crimson .card-translation {
      color: white !important;
    }

    /* Tarjeta Turquesa - Absorci√≥n de da√±o - SOLO CARTEL COLOREADO */
    .emperatriz-turquoise .card-category-badge {
      background: rgba(20, 184, 166, 0.9) !important;
      color: white !important;
    }
    
    .emperatriz-turquoise .card-hanzi,
    .emperatriz-turquoise .card-pinyin,
    .emperatriz-turquoise .card-translation {
      color: white !important;
    }

    /* ========== TARJETAS ESPECIALES DE 12 BESTIAS ========== */
    
    /* Tarjeta Naranja - Doble da√±o - SOLO CARTEL COLOREADO */
    .bestias12-orange .card-category-badge {
      background: rgba(255, 140, 66, 0.9) !important;
      color: white !important;
    }
    
    .bestias12-orange .card-hanzi,
    .bestias12-orange .card-pinyin,
    .bestias12-orange .card-translation {
      color: white !important;
    }

    /* Tarjeta Celeste - Tiempo +20 segundos - SOLO CARTEL COLOREADO */
    .bestias12-cyan .card-category-badge {
      background: rgba(34, 211, 238, 0.9) !important;
      color: white !important;
    }
    
    .bestias12-cyan .card-hanzi,
    .bestias12-cyan .card-pinyin,
    .bestias12-cyan .card-translation {
      color: white !important;
    }

    /* Tarjeta Bordo/Crimson - Debuff -50% da√±o - SOLO CARTEL COLOREADO */
    .bestias12-crimson .card-category-badge {
      background: rgba(159, 18, 57, 0.9) !important;
      color: white !important;
    }
    
    .bestias12-crimson .card-hanzi,
    .bestias12-crimson .card-pinyin,
    .bestias12-crimson .card-translation {
      color: white !important;
    }

    /* Tarjeta Turquesa - Absorci√≥n de da√±o - SOLO CARTEL COLOREADO */
    .bestias12-turquoise .card-category-badge {
      background: rgba(20, 184, 166, 0.9) !important;
      color: white !important;
    }
    
    .bestias12-turquoise .card-hanzi,
    .bestias12-turquoise .card-pinyin,
    .bestias12-turquoise .card-translation {
      color: white !important;
    }

    /* ========== ANIMACIONES DE LA EMPERATRIZ ========== */
    @keyframes damageFloat {
      0% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) translateY(-50px);
        opacity: 0;
      }
    }

    @keyframes effectFloat {
      0% {
        transform: translateX(-50%) translateY(0) scale(0.8);
        opacity: 0;
      }
      20% {
        transform: translateX(-50%) translateY(0) scale(1.1);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) translateY(-30px) scale(1);
        opacity: 0;
      }
    }

    @keyframes powerUpPulse {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      20% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
      }
      80% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
      }
    }

    @keyframes victoryGlow {
      0% {
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
      }
      100% {
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.8), 0 0 40px rgba(16, 185, 129, 0.6);
      }
    }

    @keyframes punishmentShake {
      0% {
        transform: translate(-50%, -50%) scale(0.5);
        opacity: 0;
      }
      10% {
        transform: translate(-50%, -50%) scale(1.1) rotate(-2deg);
        opacity: 1;
      }
      20% {
        transform: translate(-50%, -50%) scale(1) rotate(2deg);
      }
      30% {
        transform: translate(-50%, -50%) scale(1) rotate(-1deg);
      }
      40% {
        transform: translate(-50%, -50%) scale(1) rotate(1deg);
      }
      50% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      90% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
      }
    }
    
    @keyframes invulnerablePulse {
      from {
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        transform: scale(1);
      }
      to {
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
        transform: scale(1.02);
      }
    }
    
    @keyframes hpDamageFlash {
      0% { 
        color: #ef4444; 
        text-shadow: 0 0 15px rgba(239, 68, 68, 0.9);
        transform: scale(1.05);
      }
      50% { 
        color: #dc2626; 
        text-shadow: 0 0 20px rgba(220, 38, 38, 1);
        transform: scale(1.1);
      }
      100% { 
        color: white; 
        text-shadow: none;
        transform: scale(1);
      }
    }
    
    @keyframes hpHealFlash {
      0% { 
        color: #10b981; 
        text-shadow: 0 0 15px rgba(16, 185, 129, 0.9);
        transform: scale(1.05);
      }
      50% { 
        color: #059669; 
        text-shadow: 0 0 20px rgba(5, 150, 105, 1);
        transform: scale(1.1);
      }
      100% { 
        color: white; 
        text-shadow: none;
        transform: scale(1);
      }
    }
    
    @keyframes hpBoxDamageGlow {
      0% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
      25% {
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.9), 0 0 60px rgba(239, 68, 68, 0.6), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(220, 38, 38, 0.8);
      }
      50% {
        box-shadow: 0 0 40px rgba(220, 38, 38, 1), 0 0 80px rgba(220, 38, 38, 0.7), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(239, 68, 68, 0.9);
      }
      75% {
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.9), 0 0 60px rgba(239, 68, 68, 0.6), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(220, 38, 38, 0.8);
      }
      100% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
    }
    
    @keyframes hpBoxHealGlow {
      0% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
      25% {
        box-shadow: 0 0 30px rgba(20, 184, 166, 0.9), 0 0 60px rgba(20, 184, 166, 0.6), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(20, 184, 166, 0.7);
      }
      50% {
        box-shadow: 0 0 40px rgba(20, 184, 166, 1), 0 0 80px rgba(20, 184, 166, 0.7), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(20, 184, 166, 0.85);
      }
      75% {
        box-shadow: 0 0 30px rgba(20, 184, 166, 0.9), 0 0 60px rgba(20, 184, 166, 0.6), 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(20, 184, 166, 0.7);
      }
      100% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
    }
    
    @keyframes timerTimeGainGlow {
      0% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
      25% {
        box-shadow: 0 0 30px rgba(34, 211, 238, 0.9), 0 0 60px rgba(34, 211, 238, 0.6);
        background: rgba(34, 211, 238, 0.7);
      }
      50% {
        box-shadow: 0 0 40px rgba(34, 211, 238, 1), 0 0 80px rgba(34, 211, 238, 0.7);
        background: rgba(34, 211, 238, 0.85);
      }
      75% {
        box-shadow: 0 0 30px rgba(34, 211, 238, 0.9), 0 0 60px rgba(34, 211, 238, 0.6);
        background: rgba(34, 211, 238, 0.7);
      }
      100% {
        box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
        background: rgba(0, 0, 0, 0.9);
      }
    }
    
    /* üìä Animaciones para barra de progreso de caracteres */
    @keyframes progressBarGlow {
      0% { 
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
      }
      50% { 
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 30px rgba(251, 191, 36, 0.4);
      }
      100% { 
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
      }
    }
    
    /* Efecto de pulsaci√≥n para la barra cuando se actualiza */
    .progress-bar-pulse {
      animation: progressBarGlow 2s ease-in-out;
    }
    
    /* üè∑Ô∏è Etiquetas de esquina para tarjetas especiales */
    .card-corner-label {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      border-radius: 6px;
      font-family: 'Jersey 10', monospace;
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      z-index: 10;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      line-height: 1.2;
      max-width: 100px;
      word-wrap: break-word;
    }
    
    .card-corner-label.gold {
      background: linear-gradient(135deg, #ffeb93, #efbb37);
      color: #ffffff;
      border: 1px solid #ffd182;
    }
    
    .card-corner-label.violet {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: #ffffff;
      border: 1px solid #a78bfa;
    }
    
    .card-corner-label.red {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
      border: 1px solid #f87171;
    }
    
    /* ========== LABELS DE POWER-UPS EN ESQUINA ========== */
    .power-up-label {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      font-family: 'Jersey 10', monospace;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      z-index: 10;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    .power-up-label.critico {
      background: linear-gradient(135deg, #ff8c42, #ff6b1a);
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .power-up-label.tiempo {
      background: linear-gradient(135deg, #22d3ee, #0891b2);
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .power-up-label.reduccion {
      background: linear-gradient(135deg, #9f1239, #7f1d1d);
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .power-up-label.absorcion {
      background: linear-gradient(135deg, #14b8a6, #0d9488);
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    /* ========== TEXTO DE DI√ÅLOGO HISTORIA - BASE (DESKTOP) ========== */
    /* CAMBIAR TAMA√ëO AQU√ç (DESKTOP): controla el tama√±o del di√°logo en el modal de Historia */
    #storyModal #dialogueText,
    iframe #dialogueText,
    #storyModal .story-dialogue-text,
    iframe .story-dialogue-text {
      font-size: 1.6rem !important; /* ~25.6px */
      line-height: 1.25 !important;
    }

    /* CAMBIAR TAMA√ëO DEL NOMBRE DEL PERSONAJE (DESKTOP) */
    #storyModal .speaker-name,
    iframe .speaker-name {
      font-size: 1.4rem !important; /* ~22.4px */
      line-height: 1.2 !important;
    }

    /* ========== SECCI√ìN ELIMINADA - CSS FORZADO PARA M√ìVIL ========== */
    
    /* --- Mejoras para m√≥vil --- */
    @media (max-width: 640px) {
      .flip-card { min-height: 220px; }
      .text-6xl { font-size: 2.5rem !important; }
      .text-2xl { font-size: 1.3rem !important; }
      
      /* Botones m√°s grandes para m√≥vil - TAMA√ëOS FIJOS */
      #flashRow button, #quizRow button {
        min-height: 50px !important;
        font-size: 1.5rem !important;
        -webkit-text-size-adjust: none !important;
      }
      
      /* Botones espec√≠ficos de flashcards con fuente de 14px - M√ÅS ESPEC√çFICO */
      #flashRow #btnDontKnow, #flashRow #btnFlip, #flashRow #btnKnow {
        font-size: 18px !important;
        -webkit-text-size-adjust: none !important;
      }
      
      /* Header buttons responsive - TAMA√ëOS FIJOS */
      header .grid button {
        min-height: 44px !important;
        padding: 10px 14px !important;
        -webkit-text-size-adjust: none !important;
      }
      
      /* XP Bar responsive */
      #xpBarWrap .flex {
        flex-wrap: wrap;
      }
      
      #xpToNext {
        word-break: break-word;
      }
      
      /* √Årea de toque m√°s grande */
      .touch-target {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Dropdown menus responsive */
      .absolute.min-w-\[180px\] {
        min-width: 160px;
        left: 0;
        right: 0;
        margin: 0 auto;
      }
      
      /* ========== TEXTO DE DI√ÅLOGO HISTORIA - M√ìVIL ========== */
      /* CAMBIAR TAMA√ëO AQU√ç (M√ìVIL): controla el tama√±o del di√°logo en pantallas peque√±as */
      #storyModal #dialogueText,
      iframe #dialogueText,
      #storyModal .story-dialogue-text,
      iframe .story-dialogue-text {
        font-size: 1.5rem !important; /* ~24px */
        line-height: 1.2 !important;
      }

      /* CAMBIAR TAMA√ëO DEL NOMBRE DEL PERSONAJE (M√ìVIL) */
      #storyModal .speaker-name,
      iframe .speaker-name {
        font-size: 1.3rem !important; /* ~20.8px */
        line-height: 1.15 !important;
      }
    }
    
    /* Animaciones m√°s suaves en m√≥vil */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* FIX: Estados de botones en m√≥vil - contraste consistente */
    button:focus,
    button:active,
    button:focus-visible {
      outline: none !important;
    }
    
    /* ========== BOTONES CON EFECTOS 3D Y BORDES ========== */
    
    /* Botones nivel - con bordes 3D oscuros y colores espec√≠ficos */
    #btnNiveles {
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)) !important;
      backdrop-filter: blur(15px) !important;
      -webkit-backdrop-filter: blur(15px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.35) !important;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
      font-size: 22px !important;
      min-height: 50px !important;
      padding: 10px 8px !important;
    }
    
    #btnNivel1 {
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
    }
    #btnNivel2 {
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
    }

    #btnNivel3 {
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
    }

    #btnHSK3 {
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
    }

    #btnHSK4 {
      background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05)) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      color: #ffffff !important;
      border: 2px solid rgba(255,255,255,0.3) !important;
      border-bottom: 4px solid rgba(255,255,255,0.4) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4) !important;
      transition: all 0.2s ease !important;
    }

    #btnNiveles:hover {
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(255,255,255,0.45) !important;
      background: linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.09)) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.5) !important;
    }

    #btnNivel1:hover, #btnNivel2:hover, #btnNivel3:hover {
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(255,255,255,0.5) !important;
      background: linear-gradient(145deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1)) !important;
      box-shadow: 0 6px 15px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.5) !important;
    }

    #btnHSK3:hover, #btnHSK4:hover {
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(255,255,255,0.5) !important;
      background: linear-gradient(145deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1)) !important;
      box-shadow: 0 6px 15px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.5) !important;
    }
    
    /* Botones Conocidas, A repasar, Confirmar - Naranja #fc9766 */
    #btnKnown, #btnRevise1, #btnRevise2 {
      background-color: #fc9766 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #1f2937 !important; /* texto oscuro para mejor contraste */
      /* NO SOBREESCRIBIR font-size ni font-family - dejar que jersey-font-acciones funcione */
    }
    #btnKnown:hover, #btnRevise1:hover, #btnRevise2:hover,
    #btnKnown:focus, #btnRevise1:focus, #btnRevise2:focus,
    #btnKnown:active, #btnRevise1:active, #btnRevise2:active {
      background-color: #e7855a !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }

    /* Tama√±o de fuente espec√≠fico para m√≥vil en botones de acci√≥n */
    @media (max-width: 768px) {
      #btnKnown, #btnRevise1, #btnRevise2 {
        font-size: 20px !important; /* M√°s grande en m√≥vil */
      }
      
      /* Botones de unidades HSK3 y HSK4 m√°s grandes en m√≥vil */
      #btnHSK3unit1, #btnHSK3unit2, #btnHSK3unit3, #btnHSK3unit4, #btnHSK3unit5,
      #btnHSK3unit6, #btnHSK3unit7, #btnHSK3unit8, #btnHSK3unit9, #btnHSK3unit10,
      #btnHSK3unit11, #btnHSK3unit12, #btnHSK3unit13, #btnHSK3unit14, #btnHSK3unit15,
      #btnHSK3unit16, #btnHSK3unit17, #btnHSK3unit18, #btnHSK3unit19, #btnHSK3unit20,
      #btnHSK4unit1, #btnHSK4unit2, #btnHSK4unit3, #btnHSK4unit4, #btnHSK4unit5,
      #btnHSK4unit6, #btnHSK4unit7, #btnHSK4unit8, #btnHSK4unit9, #btnHSK4unit10,
      #btnHSK4unit11, #btnHSK4unit12, #btnHSK4unit13, #btnHSK4unit14, #btnHSK4unit15,
      #btnHSK4unit16, #btnHSK4unit17, #btnHSK4unit18, #btnHSK4unit19, #btnHSK4unit20 {
        font-size: 38px !important; /* M√°s grande en m√≥vil */
      }
    }
    
    /* Botones Quiz Pinyin, Quiz Trad, Quiz Hanzi - Violeta claro #c8a8e9 */
    #btnQuizPinyin, #btnQuizMeaning, #btnQuizHanzi {
      background-color: #c8a8e9 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #1f2937 !important; /* texto oscuro para mejor contraste */
    }
    #btnQuizPinyin:hover, #btnQuizMeaning:hover, #btnQuizHanzi:hover,
    #btnQuizPinyin:focus, #btnQuizMeaning:focus, #btnQuizHanzi:focus,
    #btnQuizPinyin:active, #btnQuizMeaning:active, #btnQuizHanzi:active {
      background-color: #b794e3 !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n de Desaf√≠os del Hor√≥scopo - Morado como desaf√≠o */
    #btnDesafiosHoroscopo {
      background-color: #7c3aed !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #ffffff !important;
    }
    #btnDesafiosHoroscopo:hover, #btnDesafiosHoroscopo:focus, #btnDesafiosHoroscopo:active {
      background-color: #6d28d9 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Botones de los 12 desaf√≠os de animales del hor√≥scopo - Morado como desaf√≠o */
    #btnDesafioRata, #btnDesafioGallo, #btnDesafioConejo, #btnDesafioCerdo, #btnDesafioPerro, #btnDesafioCaballo,
    #btnDesafioBuey, #btnDesafioCabra, #btnDesafioSerpiente, #btnDesafioMono, #btnDesafioTigre, #btnDesafioDragon {
      background-color: #7c3aed !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #ffffff !important;
      line-height: 1.2 !important;
    }
    #btnDesafioRata:hover, #btnDesafioGallo:hover, #btnDesafioConejo:hover, #btnDesafioCerdo:hover, #btnDesafioPerro:hover, #btnDesafioCaballo:hover,
    #btnDesafioBuey:hover, #btnDesafioCabra:hover, #btnDesafioSerpiente:hover, #btnDesafioMono:hover, #btnDesafioTigre:hover, #btnDesafioDragon:hover {
      background-color: #6d28d9 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n del hor√≥scopo - Amarillo #ffc853 */
    #btnHoroscopo {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #000000 !important;
      font-size: 30px !important;
    }
    #btnHoroscopo:hover, #btnHoroscopo:focus, #btnHoroscopo:active {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Botones del hor√≥scopo bloqueados */
    #btnHoroscopo.locked, #btnDesafiosHoroscopo.locked {
      background: linear-gradient(135deg, #666666, #555555) !important;
      color: #999999 !important;
      border: 2px solid #555555 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2) !important;
      cursor: not-allowed !important;
      opacity: 0.7 !important;
    }
    
    #btnHoroscopo.locked:hover, #btnDesafiosHoroscopo.locked:hover {
      transform: none !important;
      background: linear-gradient(135deg, #666666, #555555) !important;
    }
    
    /* Botones de los 12 animales del hor√≥scopo - Amarillo #ffc853 */
    #btnRata, #btnGallo, #btnConejo, #btnCerdo, #btnPerro, #btnCaballo,
    #btnBuey, #btnCabra, #btnSerpiente, #btnMono, #btnTigre, #btnDragon {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      color: #000000 !important;
      line-height: 1.2 !important;
    }
    #btnRata:hover, #btnGallo:hover, #btnConejo:hover, #btnCerdo:hover, #btnPerro:hover, #btnCaballo:hover,
    #btnBuey:hover, #btnCabra:hover, #btnSerpiente:hover, #btnMono:hover, #btnTigre:hover, #btnDragon:hover {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    #btnQuizPinyin:hover, #btnQuizMeaning:hover, #btnQuizHanzi:hover,
    #btnQuizPinyin:focus, #btnQuizMeaning:focus, #btnQuizHanzi:focus,
    #btnQuizPinyin:active, #btnQuizMeaning:active, #btnQuizHanzi:active {
      background-color: #b695df !important; /* m√°s oscuro en hover */
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n Desaf√≠o - con bordes 3D oscuros */
    #btnChallenge {
      background-color: #a21caf !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 22px !important;
      font-family: 'Jersey 10', monospace !important;
      height: 50px !important;
    }

    #btnChallenge:hover, #btnChallenge:focus, #btnChallenge:active {
      background-color: #86198f !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Bot√≥n Tabla Conocidas - amarillo #ffc853 con bordes uniformes */
    #btnKnownTable {
      background-color: #ffc853 !important;
      border: 2px solid rgba(0,0,0,0.6) !important;
      border-bottom: 4px solid rgba(0,0,0,0.6) !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      transition: all 0.2s ease !important;
      font-size: 22px !important;
      font-family: 'Jersey 10', monospace !important;
      height: 50px !important;
      width: auto !important;
      max-width: none !important;
      overflow: hidden !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      box-sizing: border-box !important;
    }
    #btnKnownTable:hover {
      background-color: #e6b347 !important;
      transform: translateY(1px) !important;
      border-bottom: 2px solid rgba(0,0,0,0.6) !important;
    }
    
    /* Prevenir efectos webkit en m√≥vil */
    button {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* ===== SOLUCI√ìN DEFINITIVA PARA EL PROBLEMA DE FOCUS EN M√ìVIL ===== */
    @media (max-width: 768px) {
      /* Eliminar TODOS los estados de focus/active en botones de quiz */
      #quizOpt button:focus,
      #quizOpt button:active,
      #quizOpt button:focus-visible,
      button.quiz-button:focus,
      button.quiz-button:active,
      button.quiz-button:focus-visible {
        background: inherit !important;
        opacity: 1 !important;
        outline: none !important;
        -webkit-tap-highlight-color: transparent !important;
        box-shadow: none !important;
        border-color: inherit !important;
      }
      
      /* Forzar estilos espec√≠ficos para cada tipo de bot√≥n */
      button.bg-blue-600\/80:focus,
      button.bg-blue-600\/80:active { 
        background: rgb(37 99 235 / 0.8) !important; 
      }
      
      button.bg-red-600\/80:focus,
      button.bg-red-600\/80:active { 
        background: rgb(220 38 38 / 0.8) !important; 
      }
      
      button.bg-yellow-600\/80:focus,
      button.bg-yellow-600\/80:active { 
        background: rgb(202 138 4 / 0.8) !important; 
      }
      
      button.bg-purple-600\/80:focus,
      button.bg-purple-600\/80:active { 
        background: rgb(147 51 234 / 0.8) !important; 
      }
      
      /* Eliminar cualquier estado residual */
      * {
        -webkit-tap-highlight-color: transparent !important;
      }

      /* Estilos para modal del hor√≥scopo */
      .horoscope-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }

      .horoscope-modal {
        background: linear-gradient(145deg, #fbdd35, #ffc515);
        border-radius: 20px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border: 3px solid #FFB300;
        animation: modalAppear 0.3s ease-out;
      }

      @keyframes modalAppear {
        from { opacity: 0; transform: scale(0.7) translateY(-50px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
      }

      .horoscope-modal-header h2 {
        color: #8B4513;
        margin: 0 0 20px 0;
        font-size: 24px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .horoscope-modal-content {
        text-align: center;
        margin-bottom: 25px;
      }

      .horoscope-animal-image {
        width: 120px;
        height: 120px;
        object-fit: contain;
        margin-bottom: 15px;
        border-radius: 0;
        border: none;
        box-shadow: none;
        display: block;
        max-width: 100%;
      }

      /* Fuente Jersey 10 para botones principales */
      .jersey-font-buttons {
        font-family: 'Jersey 10', monospace !important;
        font-size: 14px; /* TAMA√ëO BASE - MODIFICA AQU√ç */
      }

      /* Tama√±os espec√≠ficos para diferentes tipos de botones */
      .jersey-font-niveles,
      button.jersey-font-niveles,
      #btnNivel1.jersey-font-niveles,
      #btnNivel2.jersey-font-niveles,
      #btnNivel3.jersey-font-niveles {
        font-family: 'Jersey 10', monospace !important;
        font-size: 22px !important; /* TAMA√ëO NIVELES - MODIFICA AQU√ç */
      }

      .jersey-font-acciones {
        font-family: 'Jersey 10', monospace !important;
        font-size: 20px !important; /* TAMA√ëO ACCIONES (Conocidas, A repasar, etc.) - MODIFICA AQU√ç */
      }

      .jersey-font-horoscopo {
        font-family: 'Jersey 10', monospace !important;
        font-size: 26px !important; /* TAMA√ëO HOR√ìSCOPO - MODIFICA AQU√ç */
      }

      .jersey-font-leaderboard {
        font-family: 'Jersey 10', monospace !important;
        font-size: 18px !important; /* TAMA√ëO LEADERBOARD - Aumentado de 14px a 18px para mejor legibilidad */
      }

      /* Override para textos en TODAS las cajas de estado - hacer m√°s grandes y blancos */
      section .jersey-font-leaderboard .text-slate-400,
      section .jersey-font-leaderboard .text-xl,
      #statBox .text-slate-400,
      #streakBox .text-slate-400,
      #statBox .text-xl,
      #streakBox .text-xl {
        color: white !important;
        font-size: 24px !important; /* T√≠tulos m√°s grandes y blancos */
      }

      section .jersey-font-leaderboard .text-lg.font-semibold,
      #statBox .text-lg.font-semibold,
      #streakBox .text-lg.font-semibold,
      #statMission,
      #statInSession,
      #statToday {
        color: white !important;
        font-size: 22px !important; /* Valores m√°s grandes y blancos */
      }

      /* Mantener colores espec√≠ficos para elementos con colores intencionados */
      #streakCount {
        color: #fb923c !important; /* Mantener naranja para el contador de rachas */
      }
      
      #streakStatus {
        color: white !important; /* Cambiar a blanco tambi√©n */
        font-size: 16px !important;
      }

      /* Override para textos en barra de XP - hacer m√°s grandes */
      #xpBarWrap #xpLabel {
        font-size: 24px !important; /* Nivel m√°s grande (era text-2xl = 24px, mantener) */
      }

      #xpBarWrap #xpToNext {
        font-size: 20px !important; /* Progreso XP m√°s grande (era text-lg = 18px ‚Üí 20px) */
      }

      .jersey-font-dropdown {
        font-family: 'Jersey 10', monospace !important;
        /* font-size removido para permitir estilos inline responsivos */
      }

      /* Fuentes Jersey 10 para Mi Colecci√≥n */
      .jersey-font-coleccion-buttons {
        font-family: 'Jersey 10', monospace !important;
      }

      .jersey-font-coleccion-filters {
        font-family: 'Jersey 10', monospace !important;
      }

      .jersey-font-desafios-especiales {
        font-family: 'Jersey 10', monospace !important;
        font-size: 20px !important; /* TAMA√ëO DESAF√çOS ESPECIALES (Final, Bestias, Emperatriz) */
        text-shadow: 1px 1px 0px rgba(0,0,0,0.5) !important; /* Sombra pixel */
      }

      .jersey-font-coleccion-title {
        font-family: 'Jersey 10', monospace !important;
        font-size: 20px !important; /* TAMA√ëO T√çTULO MI COLECCI√ìN - MODIFICA AQU√ç */
      }

      .jersey-font-coleccion-counter {
        font-family: 'Jersey 10', monospace !important;
      }

      .jersey-font-coleccion-cards {
        font-family: 'Jersey 10', monospace !important;
      }

      /* SUPER OVERRIDE - Fuerza Jersey 10 en TODOS los dispositivos */
      button.jersey-font-niveles,
      button.jersey-font-acciones,
      button.jersey-font-horoscopo,
      button.jersey-font-dropdown,
      button.jersey-font-coleccion-buttons,
      button.jersey-font-coleccion-filters,
      .jersey-font-niveles,
      .jersey-font-acciones,
      .jersey-font-horoscopo,
      .jersey-font-dropdown,
      .jersey-font-coleccion-buttons,
      .jersey-font-coleccion-filters,
      .jersey-font-coleccion-title,
      .jersey-font-coleccion-counter,
      .jersey-font-coleccion-cards,
      #btnNivel1,
      #btnNivel2, 
      #btnNivel3,
      #btnAchievements,
      #btnDonation,
      #btnHoroscopo,
      #btnKnownTable,
      #btnShowHanzi,
      #btnShowPinyin,
      #btnShowMeaning,
      #btnCatAll,
      #btnCatS,
      #btnCatA,
      #btnCatV,
      #btnCatP,
      #btnCatE {
        font-family: 'Jersey 10', monospace !important;
        font-weight: normal !important;
        transition: all 0.3s ease;
      }

      /* Fuerza tama√±os espec√≠ficos para desktop */
      @media (min-width: 640px) {
        button.jersey-font-niveles,
        .jersey-font-niveles,
        #btnNivel1,
        #btnNivel2,
        #btnNivel3 {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-niveles */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-acciones,
        .jersey-font-acciones,
        #btnAchievements,
        #btnDonation {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-acciones */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-dropdown,
        .jersey-font-dropdown {
          /* NO forzar font-size aqu√≠, usar el de .jersey-font-dropdown */
          font-family: 'Jersey 10', monospace !important;
        }
        
        button.jersey-font-horoscopo,
        .jersey-font-horoscopo,
        #btnHoroscopo {
          font-family: 'Jersey 10', monospace !important;
          font-size: 18px !important;
        }
      }

      /* Responsive para badges de hor√≥scopo en m√≥vil */
      @media (max-width: 768px) {
        .horoscope-animal-image {
          width: 175px; /* 135px + 30% */
          height: 175px;
          border-radius: 0;
          border: none;
          box-shadow: none;
          margin-top: 7px;
        }
        
        /* REGLA DESHABILITADA - Estaba sobrescribiendo estilos inline responsivos
        button.jersey-font-dropdown,
        .jersey-font-dropdown,
        button.jersey-font-horoscopo,
        .jersey-font-horoscopo,
        button.jersey-font-acciones,
        .jersey-font-acciones,
        #btnHoroscopo,
        #btnDesafiosHoroscopo,
        #btnDesafioMenos,
        #btnDesafioMas,
        #btnDesafioClassico,
        #btnTodoN1,
        #btnTodoN2,
        #btnTodoN3,
        #btnUnit2,
        #btnUnit3,
        #btnUnit4,
        #btnUnit5,
        #btnUnit6,
        #btnUnit7,
        #btnUnit8,
        #btnUnit9,
        #btnUnit1N2,
        #btnUnit2N2,
        #btnUnit3N2,
        #btnUnit4N2,
        #btnUnit5N2,
        #btnUnit6N2,
        #btnUnit7N2,
        #btnUnit8N2,
        #btnUnit9N2,
        #btnUnit1N3,
        #btnUnit2N3,
        #btnUnit3N3,
        #btnUnit4N3,
        #btnUnit5N3,
        #btnUnit6N3,
        #btnUnit7N3,
        #btnUnit8N3,
        #btnUnit9N3,
        #btnDesafioN1,
        #btnDesafioN2,
        #btnDesafioN3,
        #btnDesafioRata,
        #btnDesafioGallo,
        #btnDesafioConejo,
        #btnDesafioCerdo,
        #btnDesafioPerro,
        #btnDesafioCaballo,
        #btnDesafioBuey,
        #btnDesafioCabra,
        #btnDesafioSerpiente,
        #btnDesafioMono,
        #btnDesafioTigre,
        #btnDesafioDragon,
        #btnDesafioFinal,
        #btnRata,
        #btnGallo,
        #btnConejo,
        #btnCerdo,
        #btnPerro,
        #btnCaballo,
        #btnBuey,
        #btnCabra,
        #btnSerpiente,
        #btnMono,
        #btnTigre,
        #btnDragon {
        }
        */
      }

      @media (max-width: 480px) {
        .horoscope-animal-image {
          width: 150px; /* 115px + 30% */
          height: 150px;
          border-radius: 0;
          border: none;
          box-shadow: none;
          margin-top: 8px;
        }
      }

      /* Ajustar tarjetas de animales del hor√≥scopo en m√≥vil - 30% m√°s grande */
      @media (max-width: 768px) {
        .card-mythic-animal .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 8px;
        }
        
        .card-mythic-animal .card-hanzi img {
          width: 175px !important; /* 135px + 30% */
          height: 175px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      @media (max-width: 480px) {
        .card-mythic-animal .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 6px;
        }
        
        .card-mythic-animal .card-hanzi img {
          width: 150px !important; /* 115px + 30% */
          height: 150px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      /* Ajustar maestro del hor√≥scopo en m√≥vil - 50% m√°s grande */
      @media (max-width: 768px) {
        .card-ultra-master .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 8px;
        }
        
        .card-ultra-master .card-hanzi img {
          width: 202px !important; /* 135px + 50% */
          height: 202px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      @media (max-width: 480px) {
        .card-ultra-master .card-hanzi {
          display: flex;
          align-items: center;
          justify-content: center;
          padding-top: 6px;
        }
        
        .card-ultra-master .card-hanzi img {
          width: 172px !important; /* 115px + 50% */
          height: 172px !important;
          object-fit: contain;
          border-radius: 0 !important;
          border: none !important;
          box-shadow: none !important;
          filter: none !important;
        }
      }

      .horoscope-message p {
        margin: 10px 0;
        color: #8B4513;
        font-size: 16px;
        font-weight: 600;
      }

      .progress-count {
        color: #D2691E;
        font-weight: bold;
        font-size: 18px;
      }

      .horoscope-modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .modal-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .cancel-btn {
        background: #DC3545;
        color: white;
      }

      .cancel-btn:hover {
        background: #C82333;
        transform: translateY(-2px);
      }

      .start-btn {
        background: linear-gradient(135deg, #28A745, #20C997);
        color: white;
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }

      .start-btn:hover {
        background: linear-gradient(135deg, #218838, #1E7E34);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
      }
    }
    
    /* ---------- Notificaciones de Castigo Hor√≥scopo - Estilo Pixel Art ---------- */
    .horoscope-penalty-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 20px;
      border-radius: 15px;
      border: 3px solid #ff6b6b;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
      max-width: 350px;
      font-family: 'Jersey 10', monospace;
      font-size: 16px;
      font-weight: bold;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s ease;
    }
    
    .horoscope-penalty-notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .horoscope-penalty-notification.fadeout {
      opacity: 0;
      transform: translateX(100%);
    }
    
    .penalty-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #ff6b6b;
      font-size: 20px;
      font-family: 'Jersey 10', monospace;
      text-shadow: 2px 2px 0px #8b0000;
      border-bottom: 2px solid #ff6b6b;
      padding-bottom: 10px;
    }
    
    .penalty-character {
      background: rgba(255, 107, 107, 0.1);
      padding: 12px 15px;
      margin: 8px 0;
      border-radius: 10px;
      border: 2px solid #ff6b6b;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Jersey 10', monospace;
    }
    
    .penalty-hanzi {
      font-size: 20px;
      font-weight: bold;
      color: #FFD700;
      font-family: 'Jersey 10', monospace;
      text-shadow: 1px 1px 0px #b8860b;
    }
    
    .penalty-meaning {
      font-size: 14px;
      color: #ffffff;
      font-family: 'Jersey 10', monospace;
      margin-top: 4px;
    }
    
    .penalty-streak {
      font-size: 12px;
      background: rgba(255, 107, 107, 0.3);
      padding: 4px 8px;
      border-radius: 6px;
      color: #FFD700;
      font-family: 'Jersey 10', monospace;
      border: 1px solid #ff6b6b;
    }
    
    /* ---------- Notificaci√≥n de BOMBA - Estilo Pixel Art ---------- */
    .bomb-penalty-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #2a0000, #1a0000);
      color: white;
      padding: 20px;
      border-radius: 15px;
      border: 3px solid #ff3333;
      box-shadow: 0 10px 30px rgba(255, 51, 51, 0.6), 0 0 20px rgba(255, 0, 0, 0.5);
      max-width: 350px;
      font-family: 'Jersey 10', monospace;
      font-size: 16px;
      font-weight: bold;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.5s ease;
      animation: bombPulse 1s infinite;
    }
    
    @keyframes bombPulse {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(255, 51, 51, 0.6), 0 0 20px rgba(255, 0, 0, 0.5);
      }
      50% {
        box-shadow: 0 10px 30px rgba(255, 51, 51, 0.8), 0 0 30px rgba(255, 0, 0, 0.7);
      }
    }
    
    .bomb-penalty-notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .bomb-penalty-notification.fadeout {
      opacity: 0;
      transform: translateX(100%);
    }
    
    /* ---------- Notificaci√≥n de Desaf√≠o Bloqueado - Estilo Pixel Art ---------- */
    .challenge-blocked-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 25px;
      border-radius: 15px;
      border: 3px solid #ffa500;
      box-shadow: 0 10px 30px rgba(255, 165, 0, 0.4);
      max-width: 400px;
      width: 90%;
      font-family: 'Jersey 10', monospace;
      text-align: center;
      z-index: 99999;
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
      transition: all 0.3s ease-out;
    }
    
    .challenge-blocked-notification.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .challenge-blocked-notification .blocked-header {
      color: #ffa500;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 2px 2px 0px #cc8400;
      border-bottom: 2px solid #ffa500;
      padding-bottom: 10px;
    }
    
    .challenge-blocked-notification .blocked-content {
      background: rgba(255, 165, 0, 0.1);
      border: 2px solid #ffa500;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .challenge-blocked-notification .blocked-stats {
      background: rgba(255, 69, 0, 0.2);
      border: 2px solid #ff4500;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #ff4500;
      font-size: 18px;
      font-weight: bold;
    }
    
    .challenge-blocked-notification .blocked-tip {
      background: rgba(135, 206, 235, 0.1);
      border: 2px solid #87ceeb;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      color: #87ceeb;
      font-size: 14px;
    }
    
    .challenge-blocked-notification .blocked-button {
      background: linear-gradient(135deg, #ffa500, #ff8c00);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-family: 'Jersey 10', monospace;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(255, 165, 0, 0.3);
      margin-top: 15px;
    }
    
    .challenge-blocked-notification .blocked-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(255, 165, 0, 0.4);
    }

    @keyframes penalty-slide-in {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes penalty-fade-out {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    /* ---------- Achievements / Logros ---------- */
    .achievement-item {
      background: linear-gradient(90deg, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
      border: none;
      border-left: 4px solid;
      padding: 12px 16px;
      margin: 4px 0;
      transition: all 0.3s ease;
      box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }
    
    .achievement-item:hover {
      transform: translateY(-1px);
      box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.4);
    }
    
    .achievement-item.completed {
      border-left-color: #22c55e;
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(21, 128, 61, 0.1) 100%);
      box-shadow: 
        2px 2px 0px rgba(0, 0, 0, 0.3),
        0 0 12px rgba(34, 197, 94, 0.2);
    }
    
    .achievement-item.completed:hover {
      background: linear-gradient(90deg, rgba(34, 197, 94, 0.25) 0%, rgba(21, 128, 61, 0.2) 100%);
      box-shadow: 
        3px 3px 0px rgba(0, 0, 0, 0.4),
        0 0 16px rgba(34, 197, 94, 0.3);
    }
    
    .achievement-item.incomplete {
      border-left-color: #6b7280;
      background: linear-gradient(90deg, rgba(107, 114, 128, 0.1) 0%, rgba(75, 85, 99, 0.05) 100%);
    }
    
    .achievement-item.incomplete:hover {
      background: linear-gradient(90deg, rgba(107, 114, 128, 0.2) 0%, rgba(75, 85, 99, 0.15) 100%);
      border-left-color: #9ca3af;
    }
    
    .achievement-icon {
      @apply text-2xl;
      filter: grayscale(100%);
      transition: filter 0.3s ease;
    }
    
    .achievement-item.completed .achievement-icon {
      filter: grayscale(0%);
    }
    
    .achievement-status {
      @apply font-medium text-sm px-2 py-1 rounded;
    }
    
    .achievement-status.completed {
      font-family: 'Jersey 10', monospace;
      font-weight: bold;
      background: transparent;
      color: #22c55e;
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.6), 0 0 16px rgba(34, 197, 94, 0.3);
      font-size: 15px;
    }
    
    .achievement-status.incomplete {
      font-family: 'Jersey 10', monospace;
      font-weight: bold;
      background: transparent;
      color: #eab308;
      text-shadow: 0 0 8px rgba(234, 179, 8, 0.6), 0 0 16px rgba(234, 179, 8, 0.3);
      font-size: 15px;
    }
    
    /* Scrollbar personalizado para el modal */
    #achievementsModal .overflow-y-auto::-webkit-scrollbar {
      width: 8px;
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-track {
      background: rgba(30, 27, 75, 0.5);
      border-radius: 0;
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #fbbf24 0%, #f59e0b  100%);
      border-radius: 0;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.3);
    }
    
    #achievementsModal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
    }
    
    /* Aplicar Jersey 10 a todo el texto del modal */
    #achievementsModal * {
      font-family: 'Jersey 10', monospace !important;
    }

    /* Asegurar que el header del modal de logros sea siempre visible */
    #achievementsModal .flex-shrink-0 {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* FORZAR TAMA√ëOS DE FUENTE M√ÅS GRANDES - SOBRESCRIBE TAILWIND */
    #achievementsModal h3 {
      font-size: 24px !important;
    }
    
    #achievementsModal .achievement-title {
      font-size: 18px !important;
    }
    
    #achievementsModal .achievement-icon {
      font-size: 20px !important;
    }

    /* Override espec√≠fico para todos los elementos con texto en el modal */
    #achievementsModal div, 
    #achievementsModal span, 
    #achievementsModal p {
      font-size: 24px !important;
    }
    
    /* Animaci√≥n pulse para timer cr√≠tico de desaf√≠os N */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    
    
    /* Pantalla de carga */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-family: 'Jersey 10', monospace;
    }
    
    .loading-container {
      text-align: center;
      color: white;
      max-width: 500px;
      padding: 2rem;
    }
    
    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    
    .loading-title {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #f2e5b1;
    }
    
    .loading-subtitle {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      opacity: 0.9;
    }
    
    .loading-progress {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 1rem;
    }
    
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #f2e5b1, #ffd700);
      border-radius: 4px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-screen.fade-out {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }

    /* ========== √öLTIMO OVERRIDE JERSEY 10 - M√ÅXIMA PRIORIDAD ========== */
    /* Esta regla debe ir DESPU√âS de todo para tener la m√°xima especificidad */
    button[class*="jersey-font"],
    .jersey-font-niveles,
    .jersey-font-acciones, 
    .jersey-font-horoscopo,
    .jersey-font-dropdown,
    #btnNivel1 *,
    #btnNivel2 *,
    #btnNivel3 *,
    #btnAchievements *,
    #btnDonation *,
    #btnHoroscopo *,
    #btnChallenge *,
    #btnChangeGroup * {
      font-family: 'Jersey 10', 'Courier New', monospace !important;
      font-weight: 400 !important;
      font-style: normal !important;
    }
    
    /* Desktop espec√≠fico - FUERZA ABSOLUTA */
    @media screen and (min-width: 640px) {
      button[class*="jersey-font"] *,
      .jersey-font-niveles *,
      .jersey-font-acciones *,
      .jersey-font-horoscopo *,
      .jersey-font-dropdown *,
      #btnNivel1,
      #btnNivel2, 
      #btnNivel3,
      #btnAchievements,
      #btnDonation,
      #btnHoroscopo,
      #btnChallenge,
      #btnChangeGroup {
        font-family: 'Jersey 10', 'Courier New', monospace !important;
        font-weight: 400 !important;
        text-transform: none !important;
        font-size: 18px !important;
      }
      
      /* EXCEPCI√ìN: Botones HSK3 y HSK4 NO deben tener font-size forzado aqu√≠ */
      #btnHSK3unit1, #btnHSK3unit2, #btnHSK3unit3, #btnHSK3unit4, #btnHSK3unit5,
      #btnHSK3unit6, #btnHSK3unit7, #btnHSK3unit8, #btnHSK3unit9, #btnHSK3unit10,
      #btnHSK3unit11, #btnHSK3unit12, #btnHSK3unit13, #btnHSK3unit14, #btnHSK3unit15,
      #btnHSK3unit16, #btnHSK3unit17, #btnHSK3unit18, #btnHSK3unit19, #btnHSK3unit20,
      #btnHSK4unit1, #btnHSK4unit2, #btnHSK4unit3, #btnHSK4unit4, #btnHSK4unit5,
      #btnHSK4unit6, #btnHSK4unit7, #btnHSK4unit8, #btnHSK4unit9, #btnHSK4unit10,
      #btnHSK4unit11, #btnHSK4unit12, #btnHSK4unit13, #btnHSK4unit14, #btnHSK4unit15,
      #btnHSK4unit16, #btnHSK4unit17, #btnHSK4unit18, #btnHSK4unit19, #btnHSK4unit20 {
        font-size: 1.125rem !important; /* 18px - mantener el tama√±o desktop */
      }
      
      /* EXCEPCI√ìN: Contadores HSK3 y HSK4 */
      #btnHSK3unit1 span, #btnHSK3unit2 span, #btnHSK3unit3 span, #btnHSK3unit4 span, #btnHSK3unit5 span,
      #btnHSK3unit6 span, #btnHSK3unit7 span, #btnHSK3unit8 span, #btnHSK3unit9 span, #btnHSK3unit10 span,
      #btnHSK3unit11 span, #btnHSK3unit12 span, #btnHSK3unit13 span, #btnHSK3unit14 span, #btnHSK3unit15 span,
      #btnHSK3unit16 span, #btnHSK3unit17 span, #btnHSK3unit18 span, #btnHSK3unit19 span, #btnHSK3unit20 span,
      #btnHSK4unit1 span, #btnHSK4unit2 span, #btnHSK4unit3 span, #btnHSK4unit4 span, #btnHSK4unit5 span,
      #btnHSK4unit6 span, #btnHSK4unit7 span, #btnHSK4unit8 span, #btnHSK4unit9 span, #btnHSK4unit10 span,
      #btnHSK4unit11 span, #btnHSK4unit12 span, #btnHSK4unit13 span, #btnHSK4unit14 span, #btnHSK4unit15 span,
      #btnHSK4unit16 span, #btnHSK4unit17 span, #btnHSK4unit18 span, #btnHSK4unit19 span, #btnHSK4unit20 span {
        font-size: 1.1rem !important; /* Contador desktop */
      }
      
      /* Override espec√≠fico para contrarrestar Tailwind font-semibold */
      button#btnNivel1.font-semibold,
      button#btnNivel2.font-semibold,
      button#btnNivel3.font-semibold {
        font-family: 'Jersey 10', 'Courier New', monospace !important;
        font-weight: 400 !important;
        /* NO forzar font-size aqu√≠, usar el de .jersey-font-niveles */
      }
    }
    
    /* √öLTIMO RECURSO - Override solo font-family, NO font-size */
    button#btnNivel1,
    button#btnNivel2,
    button#btnNivel3,
    button#btnAchievements,
    button#btnDonation,
    button#btnChallenge,
    button#btnChangeGroup {
      font-family: 'Jersey 10', 'Courier New', monospace !important;
      /* NO override font-size - permitir que las clases jersey-font-* controlen el tama√±o */
    }
    
    /* ========== BARRAS DE PROGRESO DE ANIMALES DEL HOR√ìSCOPO ========== */
    
    /* Contenedor de la barra de progreso con borde */
    .horoscope-progress-container {
      border: 2px solid #000 !important;
    }
    
    /* ========== BOTONES DROPDOWN DESAF√çO M√ÅS GRANDES EN M√ìVIL ========== */
    
    /* Botones del dropdown "Desaf√≠o" m√°s grandes en m√≥vil */
    @media (max-width: 768px) {
      #btnDesafioClassico,
      #btnDesafioMenos,
      #btnDesafioMas {
        font-size: 20px !important; /* M√°s grande que los 20px por defecto */
        padding: 7px 8px !important; /* Un poco m√°s de padding tambi√©n */
      }
      
      /* Aumentar fuente de botones de desaf√≠o especial en m√≥vil - USAR IDS ESPEC√çFICOS */
      #btnBestias12,
      #btnLaEmperatriz,
      #btnCruzarMar,
      #btnCruzarCielo {
        font-size: 22px !important; /* Aumentado significativamente para m√≥vil */
      }
      
      /* Bot√≥n del hor√≥scopo final */
      #btnDesafioFinal {
        font-size: 22px !important; /* Aumentado para m√≥vil */
      }
      
      #btnHoroscopo,
      #btnHoroscopo span {
        font-size: 22px !important; /* Aumentado para m√≥vil */
      }
    }
    
    /* ========== SECCI√ìN ELIMINADA - JERSEY FONTS M√ìVIL Y REGLAS DE MODALES ========== */
    
    /* REGLAS DESKTOP ELIMINADAS - CONTROLADAS DESDE ARRIBA */
    
    /* ========== ESTILOS DE TARJETAS ========== */
    /* Opacidad de las tarjetas principales */
    #card {
      opacity: 0.87; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* ========== ESTILOS DE CUADROS DE ESTADO ========== */
    /* Opacidad de los cuadros de estado principales */
    #streakBox,
    div[style*="background-color: #2e3856"]:not(#statBox) {
      opacity: 0.93 !important; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* StatBox transparente - fondo invisible, texto visible */
    #statBox {
      background-color: transparent !important;
      opacity: 1 !important;
    }
    
    #statBox .text-slate-400,
    #statBox #statMission {
      opacity: 1 !important;
    }
    
    /* Opacidad de contenedores de estad√≠sticas del modal */
    .achievement-category {
      opacity: 0.8 !important; /* Ajusta este valor: 1.0 = sin transparencia, 0.1 = muy transparente */
    }
    
    /* üîÑ Estilos para cartas clickeables en la tabla de conocidas */
    .clickable-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }
    
    .clickable-card:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3) !important;
    }
    
    .clickable-card:active {
      transform: translateY(0px) !important;
      transition: transform 0.1s ease !important;
    }
    
    /* Indicador visual removido - las cartas siguen siendo clickeables sin el s√≠mbolo */
    
    /* Responsive design para el modal de registro */
    @media (max-width: 480px) {
      #registerBox {
        margin: 20px 10px !important;
        padding: 16px !important;
        min-width: 260px !important;
        max-width: calc(100vw - 40px) !important;
        width: calc(100vw - 40px) !important;
        box-shadow: 4px 4px 0px #000, inset 0 0 0 2px #00ff88, inset 4px 4px 8px rgba(0, 255, 65, 0.5), 0 0 20px rgba(0, 255, 65, 0.4), 0 0 40px rgba(0, 255, 65, 0.2) !important;
      }
    }
    
    @media (max-width: 320px) {
      #registerBox {
        margin: 15px 5px !important;
        padding: 12px !important;
        min-width: 240px !important;
        max-width: calc(100vw - 20px) !important;
        width: calc(100vw - 20px) !important;
      }
    }
    
    /* =============================== FONDOS DE DESAF√çOS =============================== */
    .emperatriz-bg {
      background: linear-gradient(135deg, #40E0D0 0%, #20B2AA 50%, #008B8B 100%);
      transition: background 0.8s ease-in-out;
    }
    
    .dust-bg {
      background: linear-gradient(135deg, #D9B38C 0%, #B8865A 50%, #8B7355 100%);
      transition: background 0.8s ease-in-out;
    }
    
    .cruzaelcielo-bg {
      background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #c2410c 100%);
      transition: background 0.8s ease-in-out;
    }
    
    .cruzarhsk3-bg {
      background: linear-gradient(135deg, #78350f 0%, #92400e 50%, #a16207 100%);
      transition: background 0.8s ease-in-out;
    }
    
    .cruzarhsk4-bg {
      background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #000000 100%);
      transition: background 0.8s ease-in-out;
    }
    
    /* Bot√≥n Historia con puntitos blancos (estrellitas) */
    #btnHistoria {
      position: relative;
      overflow: hidden;
    }
    
    #btnHistoria::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle, white 1px, transparent 1px),
        radial-gradient(circle, white 0.5px, transparent 0.5px),
        radial-gradient(circle, white 1.5px, transparent 1.5px);
      background-size: 80px 80px, 120px 120px, 100px 100px;
      background-position: 0 0, 40px 40px, 20px 60px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 0;
    }
    
    #btnHistoria * {
      position: relative;
      z-index: 1;
    }
  </style>


</head>
<body id="body" class="min-h-screen text-slate-100">
<!-- Pantalla de carga inicial -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-container">
    <div class="loading-spinner"></div>
    <h2 class="loading-title text-5xl font-bold">MacaLaoshi Flashcards<span class="font-sans text-xl">¬Æ</span></h2>
    <h2 class="loading-title text-2xl font-bold">Creado por Maca Laoshi y Manu Shi (Youtube)</h2>
    <p class="loading-subtitle text-xl">Cargando tu experiencia...</p>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loadingProgressBar"></div>
    </div>
  </div>
</div>

<div id="gameArea" class="hidden">
  <div class="max-w-3xl mx-auto p-4 sm:p-6 px-6 sm:px-8">

    <!-- ---------- Encabezado ---------- -->
    <header class="flex flex-col gap-2 mb-2">
      <!-- Fila 1: T√≠tulo centrado (ancho completo) -->
      <div class="flex justify-center">
        <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-center leading-none" style="font-family: 'Jersey 10', monospace; text-shadow: 3px 3px 0px #777572">MacaLaoshi Flashcards</h1>
      </div>
      


      <!-- Tip inicial (arriba del bot√≥n Historia) -->
      <div id="initialTipContainer" class="mb-2" style="
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: all 0.8s ease-in-out;
        margin-bottom: 0;
      ">
        <div id="initialTip" style="
          text-align: center;
          color: white;
          font-family: 'Jersey 10', monospace;
          font-size: 1.5rem;
          padding: 1px 1px;
          line-height: 0.9;
          font-weight: 400;
        ">
          Colecciona caracteres, s√∫belos de nivel en desaf√≠os y enfr√©ntate a los jefes para salvar el mundo de la Emperatriz.
        </div>
      </div>

      <!-- Fila 2: Tres botones en grid (Apoyar | Logros | Guardar) -->
      <div class="grid grid-cols-3 gap-2">
        
        <!-- Bot√≥n Apoyar (con dropdown) -->
        <div class="relative">
          <button id="btnDonation" class="w-full px-2 py-0 sm:py-1 lg:py-1.5 rounded-xl bg-green-600 hover:bg-green-500 text-white font-medium border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2 flex items-center justify-center gap-1 whitespace-nowrap jersey-font-acciones text-sm lg:text-base leading-none sm:leading-tight">
            <span>üíù</span>
            <span>Apoyar</span>
            <span id="donationArrow" class="inline-block transition-transform duration-300 text-xs">‚ñº</span>
          </button>
          
          <!-- Modal de opciones de donaci√≥n -->
          <div id="donationModal" class="absolute left-0 mt-2 bg-gradient-to-br from-pink-300 to-rose-400 border border-pink-200 rounded-xl shadow-xl p-3 z-50 hidden min-w-[280px]">
            <div class="flex flex-col gap-2">
              <h3 class="text-sm font-semibold text-center mb-1 text-gray-800">üíù Opciones de Donaci√≥n</h3>
              
              <!-- Argentina -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üá¶üá∑</span>
                  <span class="font-medium text-xs text-gray-700">Argentina - Alias:</span>
                </div>
                <div class="bg-pink-50 rounded p-2 text-xs font-mono">
                  <span id="aliasArgentina" class="text-gray-800">shi.manuel</span>
                  <button onclick="copyToClipboard('shi.manuel', 'Alias copiado!')" class="ml-2 text-pink-600 hover:text-pink-500 text-xs">copiar</button>
                </div>
              </div>
              
              <!-- M√©xico -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üá≤üáΩ</span>
                  <span class="font-medium text-xs text-gray-700">M√©xico - CLABE BBVA:</span>
                </div>
                <div class="bg-pink-50 rounded p-2 text-xs font-mono">
                  <span id="clabeMexico" class="text-gray-800">012180015679448077</span>
                  <button onclick="copyToClipboard('012180015679448077', 'CLABE copiada!')" class="ml-2 text-pink-600 hover:text-pink-500 text-xs">copiar</button>
                </div>
              </div>
              
              <!-- Internacional - Stripe -->
              <div class="bg-white/70 rounded-lg p-2 border border-pink-200">
                <div class="flex items-center gap-1 mb-1">
                  <span class="text-sm">üåç</span>
                  <span class="font-medium text-xs text-gray-700">Internacional:</span>
                </div>
                <a href="https://buy.stripe.com/7sY3cv529eFgbp3bc2gMw1e" target="_blank" 
                   class="block bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-center py-2 px-3 rounded-lg font-medium text-xs transition-all duration-300">
                  üí≥ Tarjeta D√©b/Cr√©d
                </a>
              </div>
              
            </div>
          </div>
        </div>
        
        <!-- Bot√≥n Logross -->
        <button id="btnAchievements" class="w-full px-2 py-0 sm:py-1 lg:py-1.5 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-medium border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2 flex items-center justify-center gap-1 jersey-font-acciones text-sm lg:text-base leading-none sm:leading-tight" title="Ver logros y objetivos">
          <span>üèÖ</span>
          <span>Logros</span>
        </button>
        
        <!-- Bot√≥n Guardar -->
        <button id="btnSaveProgress" onclick="SaveQueue.flush()" class="w-full px-2 py-0 sm:py-1 lg:py-1.5 rounded-xl bg-yellow-600 hover:bg-yellow-500 text-black font-bold border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2 flex items-center justify-center gap-2 jersey-font-acciones text-sm lg:text-base leading-none sm:leading-tight">
          <span id="btnSaveText">‚úÖ Guardar</span>
          <span id="btnSaveSpinner" class="hidden">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        </button>
        
      </div> <!-- Cierre grid 3 columnas -->
    </header>
      
      <!-- Bot√≥n Historia -->
      <div class="mb-1 mt-1">
        <button id="btnHistoria" class="w-full px-4 py-3 rounded-2xl bg-transparent hover:bg-white/10 font-bold text-white text-lg jersey-font-niveles transition-all duration-300 shadow-lg border-2 border-grey border-b-4 border-b-white hover:translate-y-0.5 hover:border-b-2" onclick="console.log('üé≠ DIRECT CLICK: Bot√≥n Historia tocado directamente'); window.showChapterModal();">
          Modo Historia
        </button>
      </div>
      
      <!-- Fila 1: Bot√≥n Niveles Unificado -->
      <div class="relative mb-2">
        <button id="btnNiveles" class="w-full px-2 py-1 rounded-2xl bg-gradient-to-r from-indigo-700 via-red-700 to-green-700 hover:from-indigo-600 hover:via-red-600 hover:to-green-600 font-semibold jersey-font-niveles">
          <span id="nivelesText">üìñ Coleccionar Caracteres</span> <span id="nivelesArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
        </button>
        
        <!-- Dropdown principal de niveles -->
        <div id="nivelesBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 z-50 hidden min-w-[250px]">
          <div class="flex flex-col gap-2">
            
            <!-- Nivel 1 -->
            <div class="relative">
              <button id="btnNivel1" class="w-full px-3 py-3 rounded-xl bg-indigo-700 hover:bg-indigo-600 font-semibold jersey-font-niveles text-left relative">
                <div class="flex items-center justify-between mb-1">
                  <span>üìï Aprender Nivel 1</span> 
                  <span id="nivel1Arrow" class="inline-block transition-transform duration-300">‚ñº</span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                  <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative">
                    <div id="nivel1ProgressBar" class="h-full bg-yellow-400 transition-all duration-500 relative" style="width: 0%">
                      <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                    </div>
                  </div>
                  <span id="nivel1ProgressText" class="text-lg text-red-200 min-w-[40px]">0/0</span>
                </div>
              </button>
              <div id="nivel1Box" class="mt-2 bg-slate-800 rounded-xl shadow-lg p-2 hidden">
                <div class="flex flex-col gap-1">
                  <button id="btnUnit2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 2 <span id="unit2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 3 <span id="unit3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit4" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 4 <span id="unit4Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit5" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 5 <span id="unit5Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit6" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 6 <span id="unit6Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit7" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 7 <span id="unit7Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit8" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 8 <span id="unit8Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit9" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 9 <span id="unit9Progress" class="font-bold">0/0</span></button>
                  <button id="btnTodoN1" class="px-4 py-2 rounded-lg text-black font-bold jersey-font-dropdown text-xl" style="background-color: #e6b347;">Todo N1</button>
                  <button id="btnDesafioN1" class="px-4 py-2 rounded-lg bg-fuchsia-700 hover:bg-fuchsia-600 font-bold jersey-font-acciones text-xl">Desaf√≠o N1</button>
                </div>
              </div>
            </div>

            <!-- Nivel 2 -->
            <div class="relative" id="nivel2Wrap" style="display:none;">
              <button id="btnNivel2" class="w-full px-3 py-3 rounded-xl bg-red-700 hover:bg-red-600 font-semibold jersey-font-niveles text-left relative">
                <div class="flex items-center justify-between mb-1">
                  <span>üìò Aprender Nivel 2</span> 
                  <span id="nivel2Arrow" class="inline-block transition-transform duration-300">‚ñº</span>
                </div>
                <div id="nivel2ProgressWrap" class="flex items-center gap-2 mt-1">
                  <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative">
                    <div id="nivel2ProgressBar" class="h-full bg-yellow-400 transition-all duration-500 relative" style="width: 0%">
                      <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                    </div>
                  </div>
                  <span id="nivel2ProgressText" class="text-lg text-indigo-200 min-w-[40px]">0/0</span>
                </div>
              </button>
              <div id="nivel2Box" class="mt-2 bg-slate-800 rounded-xl shadow-lg p-2 hidden">
                <div class="flex flex-col gap-1">
                  <button id="btnUnit1N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 1 <span id="unit1N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit2N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 2 <span id="unit2N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit3N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 3 <span id="unit3N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit4N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 4 <span id="unit4N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit5N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 5 <span id="unit5N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit6N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 6 <span id="unit6N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit7N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 7 <span id="unit7N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit8N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 8 <span id="unit8N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit9N2" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 9 <span id="unit9N2Progress" class="font-bold">0/0</span></button>
                  <button id="btnTodoN2" class="px-4 py-2 rounded-lg text-black font-bold jersey-font-dropdown text-xl" style="background-color: #e6b347;">Todo N2</button>
                  <button id="btnDesafioN2" class="px-4 py-2 rounded-lg bg-fuchsia-700 hover:bg-fuchsia-600 font-bold jersey-font-acciones text-xl">Desaf√≠o N2</button>
                </div>
              </div>
            </div>

            <!-- Nivel 3 -->
            <div class="relative" id="nivel3Wrap" style="display:none;">
              <button id="btnNivel3" class="w-full px-3 py-3 rounded-xl bg-green-700 hover:bg-green-600 font-semibold jersey-font-niveles text-left relative">
                <div class="flex items-center justify-between mb-1">
                  <span>üìó Aprender Nivel 3</span> 
                  <span id="nivel3Arrow" class="inline-block transition-transform duration-300">‚ñº</span>
                </div>
                <div id="nivel3ProgressWrap" class="flex items-center gap-2 mt-1">
                  <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative">
                    <div id="nivel3ProgressBar" class="h-full bg-yellow-400 transition-all duration-500 relative" style="width: 0%">
                      <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                    </div>
                  </div>
                  <span id="nivel3ProgressText" class="text-lg text-green-200 min-w-[40px]">0/0</span>
                </div>
              </button>
              <div id="nivel3Box" class="mt-2 bg-slate-800 rounded-xl shadow-lg p-2 hidden">
                <div class="flex flex-col gap-1">
                  <button id="btnUnit1N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 1 <span id="unit1N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit2N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 2 <span id="unit2N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit3N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 3 <span id="unit3N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit4N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 4 <span id="unit4N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit5N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 5 <span id="unit5N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit6N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 6 <span id="unit6N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit7N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 7 <span id="unit7N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit8N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 8 <span id="unit8N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnUnit9N3" class="px-4 py-2 rounded-lg text-black jersey-font-dropdown text-xl flex justify-between items-center" style="background-color: #ffc853;">Unidad 9 <span id="unit9N3Progress" class="font-bold">0/0</span></button>
                  <button id="btnTodoN3" class="px-4 py-2 rounded-lg text-black font-bold jersey-font-dropdown text-xl" style="background-color: #e6b347;">Todo N3</button>
                  <button id="btnDesafioN3" class="px-4 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 font-bold jersey-font-acciones text-xl">Desaf√≠o N3</button>
                </div>
              </div>
            </div>
            
            <!-- HSK3 -->
            <div class="relative" id="HSK3Wrap">
              <button id="btnHSK3" class="w-full px-3 py-3 rounded-xl bg-purple-700 hover:bg-purple-600 font-semibold jersey-font-niveles text-left relative">
                <div class="flex items-center justify-between mb-1">
                  <span>üìö Aprender HSK3</span> 
                  <span id="HSK3Arrow" class="inline-block transition-transform duration-300">‚ñº</span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                  <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative">
                    <div id="HSK3ProgressBar" class="h-full bg-yellow-400 transition-all duration-500 relative" style="width: 0%">
                      <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                    </div>
                  </div>
                  <span id="HSK3ProgressText" class="text-lg text-purple-200 min-w-[40px]">0/0</span>
                </div>
              </button>
              <div id="HSK3Box" class="mt-2 bg-slate-800 rounded-xl shadow-lg p-2 hidden">
                <div class="grid grid-cols-2 gap-1">
                  <button id="btnHSK3unit1" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 1</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit1ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit1Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit2" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 2</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit2ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit2Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit3" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 3</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit3ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit3Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit4" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 4</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit4ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit4Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit5" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 5</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit5ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit5Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit6" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 6</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit6ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit6Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit7" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 7</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit7ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit7Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit8" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 8</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit8ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit8Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit9" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 9</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit9ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit9Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit10" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 10</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit10ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit10Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit11" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 11</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit11ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit11Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit12" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 12</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit12ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit12Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit13" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 13</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit13ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit13Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit14" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 14</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit14ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit14Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit15" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 15</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit15ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit15Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit16" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 16</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit16ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit16Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit17" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 17</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit17ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit17Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit18" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 18</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit18ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit18Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit19" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 19</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit19ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit19Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK3unit20" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 20</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK3unit20ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK3unit20Progress" class="font-bold text-xs">0/0</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- HSK4 -->
            <div class="relative" id="HSK4Wrap">
              <button id="btnHSK4" class="w-full px-3 py-3 rounded-xl bg-orange-700 hover:bg-orange-600 font-semibold jersey-font-niveles text-left relative">
                <div class="flex items-center justify-between mb-1">
                  <span>üìô Aprender HSK4</span> 
                  <span id="HSK4Arrow" class="inline-block transition-transform duration-300">‚ñº</span>
                </div>
                <div class="flex items-center gap-2 mt-1">
                  <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative">
                    <div id="HSK4ProgressBar" class="h-full bg-yellow-400 transition-all duration-500 relative" style="width: 0%">
                      <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                    </div>
                  </div>
                  <span id="HSK4ProgressText" class="text-lg text-orange-200 min-w-[40px]">0/0</span>
                </div>
              </button>
              <div id="HSK4Box" class="mt-2 bg-slate-800 rounded-xl shadow-lg p-2 hidden">
                <div class="grid grid-cols-2 gap-1">
                  <button id="btnHSK4unit1" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 1</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit1ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit1Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit2" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 2</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit2ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit2Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit3" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 3</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit3ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit3Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit4" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 4</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit4ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit4Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit5" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 5</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit5ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit5Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit6" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 6</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit6ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit6Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit7" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 7</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit7ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit7Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit8" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 8</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit8ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit8Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit9" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 9</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit9ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit9Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit10" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 10</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit10ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit10Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit11" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 11</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit11ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit11Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit12" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 12</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit12ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit12Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit13" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 13</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit13ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit13Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit14" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 14</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit14ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit14Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit15" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 15</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit15ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit15Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit16" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 16</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit16ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit16Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit17" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 17</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit17ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit17Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit18" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 18</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit18ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit18Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit19" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 19</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit19ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit19Progress" class="font-bold text-xs">0/0</span>
                  </button>
                  <button id="btnHSK4unit20" class="px-2 py-3 rounded-lg jersey-font-dropdown flex flex-col items-center justify-center gap-1" style="background-color: #ffc853;">
                    <span>Unidad 20</span>
                    <div class="w-full bg-gray-600/50 rounded-full h-1.5 overflow-hidden">
                      <div id="HSK4unit20ProgressBar" class="h-full bg-yellow-600 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="HSK4unit20Progress" class="font-bold text-xs">0/0</span>
                  </button>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
      
      <!-- Fila 2: Conocidas, A repasar, Confirmar - GRID 3 COLUMNAS FORZADO -->
      <div class="grid grid-cols-3 gap-1 mb-2">
        <button id="btnKnown" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">Conocidas <span id="countKnown" class="font-bold ml-1">0</span></span>
        </button>
        <button id="btnRevise1" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">Repasar <span id="countRev1" class="ml-1">‚úÖ</span></span>
        </button>
        <button id="btnRevise2" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones">
          <span class="whitespace-nowrap">Confirmar <span id="countRev2" class="ml-1">‚úÖ</span></span>
        </button>
      </div>
      

      
      <!-- Fila 4: Desaf√≠o, Tabla Conocidas - GRID 2 COLUMNAS FORZADO -->
      <div class="grid grid-cols-2 gap-1 mb-2">
        <div class="relative">
          <button id="btnChallenge" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-acciones" style="font-size: 22px !important;">
            <span class="whitespace-nowrap">Desaf√≠o</span> <span id="challengeArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span>
          </button>
          <div id="challengeBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnDesafioClassico" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o cl√°sico</button>
            <button id="btnDesafioMenos" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o a 0-1</button>
            <button id="btnDesafioMas" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 jersey-font-acciones">Desaf√≠o a 2+</button>
          </div>
        </div>
        <button id="btnKnownTable" class="px-2 py-1 rounded-2xl bg-yellow-600 hover:bg-yellow-500 text-black font-semibold ring-2 ring-yellow-700 min-h-[50px] flex items-center justify-center jersey-font-coleccion-buttons">
          <span class="whitespace-nowrap">Mi Colecci√≥n</span>
        </button>
      </div>
      
      <!-- Fila 5: Desaf√≠os del Hor√≥scopo y Los 12 animales del hor√≥scopo - GRID 2 COLUMNAS -->
      <div class="grid grid-cols-2 gap-1 mb-48">
        <!-- Desaf√≠os del Hor√≥scopo -->
        <div class="relative">
          <button id="btnDesafiosHoroscopo" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-horoscopo" style="font-size: 22px !important;">
            <span class="whitespace-nowrap">Desaf√≠os Historia</span>
          </button>
          <div id="desafiosHoroscopoBox" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 z-40 hidden" style="width: clamp(225px, 71vw, 300px); max-width: 71vw;">
            <div class="flex flex-col gap-2">
              
              <!-- Bot√≥n Cruzar el Mar -->
              <button id="btnCruzarMar" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #0891b2, #0e7490); border: 2px solid #06b6d4; margin-top: 8px; position: relative;">üåä CRUZAR EL MAR üåä<br><span style="font-size: 0.7em; color: #a5f3fc;">5000 HP ‚Ä¢ 4 mins ‚Ä¢ Solo Nivel 1</span></button>
              
              <!-- Bot√≥n Cruzar el Cielo -->
              <button id="btnCruzarCielo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #f97316, #ea580c); border: 2px solid #fb923c; margin-top: 8px; position: relative;">‚òÅÔ∏è CRUZAR EL CIELO ‚òÅÔ∏è<br><span style="font-size: 0.7em; color: #fed7aa;">6000 HP ‚Ä¢ 5 mins ‚Ä¢ Solo Nivel 2</span></button>
              
              <!-- NUEVO: Bot√≥n "Los Hor√≥scopo" que expande/colapsa los 12 animales -->
              <button id="btnLosHoroscopo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #9333ea, #7e22ce); border: 2px solid #a855f7; margin-top: 8px; position: relative;">
                LOS 12 HOR√ìSCOPOS <span id="losHoroscopoArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span><br><span style="font-size: 0.7em; color: #e9d5ff;">12 desaf√≠os tem√°ticos ‚Ä¢ Cruzar el Cielo</span>
              </button>
              
              <!-- Contenedor colapsable para los 12 animales -->
              <div id="losHoroscopoContainer" class="grid gap-2 overflow-hidden transition-all duration-500" style="grid-template-columns: repeat(auto-fit, minmax(clamp(90px, 30vw, 120px), 1fr)); max-height: 0; opacity: 0;">            
                <!-- Fila 1 -->
                <button id="btnDesafioRata" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêÅ Rata<br><span style="font-size: clamp(14px, 5vw, 18px);">colores</span></button>
                <button id="btnDesafioGallo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêì Gallo<br><span style="font-size: clamp(14px, 5vw, 18px);">fruta</span></button>
                <button id="btnDesafioConejo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêá Conejo<br><span style="font-size: clamp(14px, 5vw, 18px);">verdura</span></button>
                <!-- Fila 2 -->
                <button id="btnDesafioCerdo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêñ Cerdo<br><span style="font-size: clamp(14px, 5vw, 18px);">comidas</span></button>
                <button id="btnDesafioPerro" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêï Perro<br><span style="font-size: clamp(14px, 5vw, 18px);">animales</span></button>
                <button id="btnDesafioCaballo" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêé Caballo<br><span style="font-size: clamp(14px, 5vw, 18px);">deportes</span></button>
                <!-- Fila 3 -->
                <button id="btnDesafioBuey" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêÇ Buey<br><span style="font-size: clamp(14px, 5vw, 18px);">hobbies</span></button>
                <button id="btnDesafioCabra" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêê Cabra<br><span style="font-size: clamp(14px, 5vw, 18px);">ropa</span></button>
                <button id="btnDesafioSerpiente" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêç Serpiente<br><span style="font-size: clamp(14px, 5vw, 18px);">casa</span></button>
                <!-- Fila 4 -->
                <button id="btnDesafioMono" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêí Mono<br><span style="font-size: clamp(14px, 5vw, 18px);">cuerpo</span></button>
                <button id="btnDesafioTigre" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêÖ Tigre<br><span style="font-size: clamp(14px, 5vw, 18px);">profesi√≥n</span></button>
                <button id="btnDesafioDragon" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-dropdown" style="line-height: 1.2; min-height: 60px;"><span style="font-size: clamp(14px, 4vw, 20px);">üêâ Drag√≥n<br><span style="font-size: clamp(14px, 5vw, 18px);">emociones</span></button>
              </div>
              
              <!-- Bot√≥n 12 Bestias -->
              <button id="btnBestias12" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #D9B38C, #B8865A); border: 2px solid #8B7355; margin-top: 8px; position: relative;">üê≤ DESAF√çO 12 BESTIAS üê≤<br><span style="font-size: 0.7em; color: #F5DEB3;">10000 HP ‚Ä¢ Todos los animales</span></button>
              
              <!-- Bot√≥n La Emperatriz -->
              <button id="btnLaEmperatriz" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #2f998e, #22726e); border: 2px solid #48D1CC; margin-top: 8px; position: relative;">üëë LA EMPERATRIZ üëë<br><span style="font-size: 0.7em; color: #AFEEEE;">15000 HP ‚Ä¢ Todos los Caracteres</span></button>
              
              <!-- Separador visual -->
              <div style="height: 1px; background: rgba(255, 255, 255, 0.2); margin: 16px 0;"></div>
              
              <!-- Bot√≥n Cruzar HSK3 -->
              <button id="btnCruzarHSK3" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #78350f, #451a03); border: 2px solid #92400e; margin-top: 8px; position: relative;">CRUZAR HSK3<br><span style="font-size: 0.7em; color: #fef3c7;">6000 HP ‚Ä¢ 6 mins ‚Ä¢ Solo HSK3</span></button>
              
              <!-- Bot√≥n Cruzar HSK4 -->
              <button id="btnCruzarHSK4" class="px-3 py-2 rounded-xl font-semibold text-white jersey-font-desafios-especiales" style="line-height: 1.1; min-height: 60px; background: linear-gradient(135deg, #1f2937, #000000); border: 2px solid #374151; margin-top: 8px; position: relative;">CRUZAR HSK4<br><span style="font-size: 0.7em; color: #d1d5db;">7000 HP ‚Ä¢ 7 mins ‚Ä¢ Solo HSK4</span></button>
            </div>
          </div>
        </div>
        <!-- Los 12 animales del hor√≥scopo -->
        <div class="relative">
          <button id="btnHoroscopo" class="w-full px-2 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center jersey-font-horoscopo" style="font-size: 22px !important;">
            <span class="whitespace-nowrap">12 del Hor√≥scopo</span>
          </button>
        <div id="horoscopoBox" class="absolute right-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 z-40 hidden" style="width: clamp(225px, 71vw, 300px); max-width: 71vw;">
          <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(clamp(90px, 30vw, 120px), 1fr));">          
            <!-- Fila 1 -->
            <button id="btnRata" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêÅ Rata<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">colores</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="rataProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="rataProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnGallo" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêì Gallo<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">fruta</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="galloProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="galloProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnConejo" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêá Conejo<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">verdura</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="conejoProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="conejoProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <!-- Fila 2 -->
            <button id="btnCerdo" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêñ Cerdo<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">comidas</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="cerdoProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="cerdoProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnPerro" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêï Perro<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">animales</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="perroProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="perroProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnCaballo" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêé Caballo<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">deportes</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="caballoProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="caballoProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <!-- Fila 3 -->
            <button id="btnBuey" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêÇ Buey<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">hobbies</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="bueyProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="bueyProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnCabra" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêê Cabra<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">ropa</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="cabraProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="cabraProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnSerpiente" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêç Serpiente<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">casa</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="serpienteProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="serpienteProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <!-- Fila 4 -->
            <button id="btnMono" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêí Mono<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">cuerpo</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="monoProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="monoProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnTigre" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêÖ Tigre<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">profesi√≥n</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="tigreProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="tigreProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
            <button id="btnDragon" class="px-2 py-2 rounded-xl font-semibold text-black jersey-font-dropdown relative" style="font-size: clamp(14px, 5vw, 18px); min-height: 60px; line-height: 1.1;">
              <div class="mb-1">
                <span style="font-size: clamp(14px, 4vw, 20px);">üêâ Drag√≥n<br>
                <span style="font-size: clamp(14px, 5vw, 18px);">emociones</span></div>
              <div class="flex items-center gap-1 mt-1">
                <div class="flex-1 bg-gray-600 rounded-full h-2 overflow-hidden relative horoscope-progress-container">
                  <div id="dragonProgressBar" class="h-full bg-white transition-all duration-500 relative" style="width: 0%">
                    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/30 to-transparent rounded-full"></div>
                  </div>
                </div>
                <span id="dragonProgressText" class="text-black min-w-[25px]" style="font-size: clamp(16px, 4vw, 18px);">0/0</span>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
    
  </header>

  <script>
  // === UTILIDADES ===
  // Funci√≥n para copiar texto al portapapeles
  function copyToClipboard(text, successMessage) {
    navigator.clipboard.writeText(text).then(() => {
      // Mostrar notificaci√≥n de √©xito
      showNotification(successMessage || 'Copiado al portapapeles!', 'success');
    }).catch(err => {
      console.error('Error al copiar:', err);
      showNotification('Error al copiar', 'error');
    });
  }
  
  // Funci√≥n para mostrar notificaciones temporales
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg font-semibold text-white transition-all duration-300 ${
      type === 'success' ? 'bg-green-600' : 
      type === 'error' ? 'bg-red-600' : 
      'bg-blue-600'
    }`;
    notification.textContent = message;
    notification.style.transform = 'translateX(100%)';
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
      notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Eliminar despu√©s de 3 segundos
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  }

  // === SISTEMA DE LOGROS ===
  function calculateTotalScore() {
    // ‚úÖ USAR LA MISMA F√ìRMULA QUE EL BACKEND (leaderboard)
    // Puntaje base: suma de (1 + challengeStreak) por cada car√°cter conocido
    let charScore = 0;
    for (const c of cards) {
      if (c.known) {
        charScore += 1 + (c.challengeStreak || 0);
      }
    }
    
    // Bonificadores
    const currentStreak = streak || 0;
    const currentLevel = getCurrentLevel(xpPoints);
    
    // F√≥rmula: charScore * (1 + streak/100) * (1 + level * 0.05)
    const totalScore = Math.round(charScore * (1 + currentStreak / 100) * (1 + currentLevel * 0.05));
    
    return totalScore;
  }

  function updateAchievements() {
    // Definir logros y sus condiciones
    const achievements = {
      // Desaf√≠os principales
      desafioN1: {
        completed: desafioN1Completed,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 1',
        description: 'Completar el primer desaf√≠o'
      },
      desafioN2: {
        completed: desafioN2Completed,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 2', 
        description: 'Completar el desaf√≠o de nivel 2'
      },
      desafioN3: {
        completed: desafioN3Completed,
        icon: 'üéØ',
        title: 'Desaf√≠o Nivel 3',
        description: 'Completar el desaf√≠o de nivel 3'
      },
      
      // Jefes Finales
      ultimate: {
        completed: horoscopeMaster,
        icon: 'üëë',
        title: 'Ultimate Challenge',
        description: 'Completar el desaf√≠o final del hor√≥scopo'
      },
      'cruzar-mar': {
        completed: cruzarMarCompleted,
        icon: 'üåä',
        title: 'Cruzar el Mar',
        description: 'Derrotar al jefe Cruzar el Mar'
      },
      'cruzar-cielo': {
        completed: cruzarCieloCompleted,
        icon: '‚òÅÔ∏è',
        title: 'Cruzar el Cielo',
        description: 'Derrotar al jefe Cruzar el Cielo'
      },
      bestias12: {
        completed: bestias12Completed,
        icon: 'üêâ',
        title: '12 Bestias',
        description: 'Derrotar al jefe 12 Bestias'
      },
      emperatriz: {
        completed: emperatrizCompleted,
        icon: 'üë∏',
        title: 'La Emperatriz',
        description: 'Derrotar a la Emperatriz'
      }
    };

    // Actualizar elementos de logros principales
    Object.keys(achievements).forEach(key => {
      const element = document.getElementById(`achievement-${key}`);
      if (element) {
        const achievement = achievements[key];
        element.className = `achievement-item ${achievement.completed ? 'completed' : 'incomplete'}`;
        
        const statusSpan = element.querySelector('.achievement-status');
        if (statusSpan) {
          statusSpan.textContent = achievement.completed ? '‚úÖ Completado' : 'Pendiente';
          statusSpan.className = `achievement-status ${achievement.completed ? 'completed' : 'incomplete'}`;
        }
      }
    });

    // Actualizar logros del hor√≥scopo
    updateHoroscopeAchievements();
    
    // Actualizar logros de caracteres conocidos
    updateCharsAchievements();
    
    // Actualizar logros de niveles
    updateLevelsAchievements();
    
    // Actualizar logros de XP
    updateXPAchievements();
    
    // Actualizar logros de Score
    updateScoreAchievements();
    
    // Actualizar estad√≠sticas del jugador
    updatePlayerStats();
  }

  function updateHoroscopeAchievements() {
    const horoscopeContainer = document.getElementById('horoscope-achievements');
    if (!horoscopeContainer) return;

    const categories = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    
    horoscopeContainer.innerHTML = '';
    
    categories.forEach(category => {
      const isCompleted = horoscopeAnimalsUnlocked.includes(category);
      const categoryNames = {
        colores: 'de la Rata (Colores)', fruta: 'del gallo (Frutas)', verduras: 'del Conejo (Verduras)', 
        comidas: 'del Cerdo (Comidas)', animales: 'del Perro (Animales)', deportes: 'del Caballo (Deportes)',
        hobbies: 'del Buey (Hobbies)', ropa: 'de la Cabra (Ropa)', casa: 'de la Serpiente (Casa)', 
        cuerpo: 'del Mono (Cuerpo)', profesiones: 'del Tigre (Profesiones)', emociones: 'del Drag√≥n(Emociones)'
      };
      
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center">
          <span class="achievement-icon">üê≤</span>
          <div class="flex-1 achievement-title">  Completar Desaf√≠o ${categoryNames[category]}</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : 'Pendiente'}
          </span>
        </div>
      `;
      horoscopeContainer.appendChild(div);
    });
  }

  function updateCharsAchievements() {
    const charsContainer = document.getElementById('chars-achievements');
    if (!charsContainer) return;

    const charsMilestones = [50, 100, 200, 300, 400, 500];
    const knownCharsCount = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo').length;
    charsContainer.innerHTML = '';
    
    charsMilestones.forEach(milestone => {
      const isCompleted = knownCharsCount >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üìö</span>
          <div class="flex-1 achievement-title">Conocer ${milestone} caracteres</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${knownCharsCount}/${milestone}`}
          </span>
        </div>
      `;
      charsContainer.appendChild(div);
    });
  }

  function updateLevelsAchievements() {
    const levelsContainer = document.getElementById('levels-achievements');
    if (!levelsContainer) return;

    const levelMilestones = [10, 30, 50, 100];
    levelsContainer.innerHTML = '';
    
    levelMilestones.forEach(milestone => {
      // Buscar si hay al menos un car√°cter que haya alcanzado este nivel
      const hasCharAtLevel = cards.some(c => 
        c.known && 
        !c.isHoroscopeAnimal && 
        c.unit !== 'horoscopo' && 
        (c.challengeStreak || 0) >= milestone
      );
      
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${hasCharAtLevel ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üìà</span>
          <div class="flex-1 achievement-title">Tener 1 car√°cter en nivel ${milestone}</div>
          <span class="achievement-status ${hasCharAtLevel ? 'completed' : 'incomplete'}">
            ${hasCharAtLevel ? '‚úÖ Completado' : 'Pendiente'}
          </span>
        </div>
      `;
      levelsContainer.appendChild(div);
    });
  }

  function updateXPAchievements() {
    const xpContainer = document.getElementById('xp-achievements');
    if (!xpContainer) return;

    const xpMilestones = [100, 500, 1000, 1500, 2000, 3000];
    xpContainer.innerHTML = '';
    
    xpMilestones.forEach(milestone => {
      const isCompleted = xpPoints >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">‚≠ê</span>
          <div class="flex-1 achievement-title">Alcanzar ${milestone} puntos de experiencia</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${xpPoints}/${milestone}`}
          </span>
        </div>
      `;
      xpContainer.appendChild(div);
    });
  }

  function updateScoreAchievements() {
    const scoreContainer = document.getElementById('score-achievements');
    if (!scoreContainer) return;

    const scoreMilestones = [50, 100, 500, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000];
    const currentScore = calculateTotalScore();
    scoreContainer.innerHTML = '';
    
    scoreMilestones.forEach(milestone => {
      const isCompleted = currentScore >= milestone;
      const div = document.createElement('div');
      div.className = `achievement-item achievement-objective ${isCompleted ? 'completed' : 'incomplete'}`;
      div.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="achievement-icon">üéñÔ∏è</span>
          <div class="flex-1 achievement-title">Alcanzar ${milestone} puntos totales</div>
          <span class="achievement-status ${isCompleted ? 'completed' : 'incomplete'}">
            ${isCompleted ? '‚úÖ Completado' : `${currentScore}/${milestone}`}
          </span>
        </div>
      `;
      scoreContainer.appendChild(div);
    });
  }

  // Funci√≥n para actualizar las estad√≠sticas del jugador
  function updatePlayerStats() {
    // Obtener datos actuales (usar las mismas variables globales del juego)
    const currentXP = xpPoints || 0;
    const knownCharacters = cards.filter(c => c.known).length;
    const totalCharacters = cards.length;
    const currentStreak = streak || 0; // usar la variable global 'streak'
    const xpLevel = getCurrentLevel(currentXP); // usar la funci√≥n real del juego
    
    // Actualizar elementos b√°sicos
    const statsXP = document.getElementById('statsXP');
    const statsStreak = document.getElementById('statsStreak');
    const statsLevel = document.getElementById('statsLevel');
    const statsUsername = document.getElementById('statsUsername');
    
    if (statsXP) statsXP.textContent = currentXP.toLocaleString();
    if (statsStreak) statsStreak.textContent = currentStreak.toLocaleString();
    if (statsLevel) statsLevel.textContent = xpLevel;
    
    // Actualizar nombre de usuario
    if (statsUsername) {
      const username = window.username || localStorage.getItem('username') || 'Usuario';
      statsUsername.textContent = `(${username})`;
    }
    
    // Calcular caracteres por nivel
    console.log('üìä DEBUG: Total de cards en el array:', cards.length);
    console.log('üìä DEBUG: Muestra de primeras 5 cartas:', cards.slice(0, 5).map(c => ({ unit: c.unit, known: c.known, hanzi: c.hanzi })));
    
    // DEBUG: Ver TODAS las unidades √∫nicas que existen
    const allUnits = [...new Set(cards.map(c => c.unit))].sort();
    console.log('üìä DEBUG: TODAS las unidades √∫nicas encontradas (' + allUnits.length + '):', allUnits);
    
    // Nivel 1: unit2 a unit9 (seg√∫n los datasets)
    const nivel1Units = ['unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9'];
    const n1Cards = cards.filter(c => nivel1Units.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG N1: Total cards N1:', n1Cards.length);
    console.log('üìä DEBUG N1: Unidades encontradas:', [...new Set(n1Cards.map(c => c.unit))]);
    
    // Nivel 2: unit1N2 a unit9N2
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const n2Cards = cards.filter(c => nivel2Units.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG N2: Total cards N2:', n2Cards.length);
    console.log('üìä DEBUG N2: Unidades encontradas:', [...new Set(n2Cards.map(c => c.unit))]);
    
    // Nivel 3: unit1N3 a unit9N3
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const n3Cards = cards.filter(c => nivel3Units.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG N3: Total cards N3:', n3Cards.length);
    console.log('üìä DEBUG N3: Unidades encontradas:', [...new Set(n3Cards.map(c => c.unit))]);
    
    // Hor√≥scopo: todos los animales del hor√≥scopo (por categor√≠as)
    const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    const horoscopeCards = cards.filter(c => horoscopeUnits.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG HOROSCOPO: Total cards Hor√≥scopo:', horoscopeCards.length);
    console.log('üìä DEBUG HOROSCOPO: Unidades encontradas:', [...new Set(horoscopeCards.map(c => c.unit))]);
    
    // HSK3: HSK3unit1 a HSK3unit9
    const hsk3Units = ['HSK3unit1', 'HSK3unit2', 'HSK3unit3', 'HSK3unit4', 'HSK3unit5', 'HSK3unit6', 'HSK3unit7', 'HSK3unit8', 'HSK3unit9'];
    const hsk3Cards = cards.filter(c => hsk3Units.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG HSK3: Total cards HSK3:', hsk3Cards.length);
    
    // HSK4: HSK4unit1 a HSK4unit20
    const hsk4Units = ['HSK4unit1', 'HSK4unit2', 'HSK4unit3', 'HSK4unit4', 'HSK4unit5', 'HSK4unit6', 'HSK4unit7', 'HSK4unit8', 'HSK4unit9', 'HSK4unit10', 'HSK4unit11', 'HSK4unit12', 'HSK4unit13', 'HSK4unit14', 'HSK4unit15', 'HSK4unit16', 'HSK4unit17', 'HSK4unit18', 'HSK4unit19', 'HSK4unit20'];
    const hsk4Cards = cards.filter(c => hsk4Units.some(u => c.unit.split('|').includes(u)));
    console.log('üìä DEBUG HSK4: Total cards HSK4:', hsk4Cards.length);
    
    const n1Known = n1Cards.filter(c => c.known).length;
    const n2Known = n2Cards.filter(c => c.known).length;
    const n3Known = n3Cards.filter(c => c.known).length;
    const horoscopeKnown = horoscopeCards.filter(c => c.known).length;
    const hsk3Known = hsk3Cards.filter(c => c.known).length;
    const hsk4Known = hsk4Cards.filter(c => c.known).length;
    
    const n1Total = n1Cards.length;
    const n2Total = n2Cards.length;
    const n3Total = n3Cards.length;
    const horoscopeTotal = horoscopeCards.length;
    const hsk3Total = hsk3Cards.length;
    const hsk4Total = hsk4Cards.length;
    
    console.log('üìä DEBUG RESULTADOS:');
    console.log('  N1:', n1Known, '/', n1Total);
    console.log('  N2:', n2Known, '/', n2Total);
    console.log('  N3:', n3Known, '/', n3Total);
    console.log('  Hor√≥scopo:', horoscopeKnown, '/', horoscopeTotal);
    console.log('  HSK3:', hsk3Known, '/', hsk3Total);
    console.log('  HSK4:', hsk4Known, '/', hsk4Total);
    
    // Actualizar contadores de texto
    const statsN1 = document.getElementById('statsN1Characters');
    const statsN2 = document.getElementById('statsN2Characters');
    const statsN3 = document.getElementById('statsN3Characters');
    const statsHoroscope = document.getElementById('statsHoroscopeCharacters');
    const statsHSK3 = document.getElementById('statsHSK3Characters');
    const statsHSK4 = document.getElementById('statsHSK4Characters');
    
    if (statsN1) statsN1.textContent = `${n1Known}/${n1Total}`;
    if (statsN2) statsN2.textContent = `${n2Known}/${n2Total}`;
    if (statsN3) statsN3.textContent = `${n3Known}/${n3Total}`;
    if (statsHoroscope) statsHoroscope.textContent = `${horoscopeKnown}/${horoscopeTotal}`;
    if (statsHSK3) statsHSK3.textContent = `${hsk3Known}/${hsk3Total}`;
    if (statsHSK4) statsHSK4.textContent = `${hsk4Known}/${hsk4Total}`;
    
    // Mostrar/ocultar containers HSK seg√∫n estado de desbloqueo
    const hsk3Container = document.getElementById('hsk3ProgressContainer');
    const hsk4Container = document.getElementById('hsk4ProgressContainer');
    if (hsk3Container) hsk3Container.style.display = hskUnlocked ? 'block' : 'none';
    if (hsk4Container) hsk4Container.style.display = hskUnlocked ? 'block' : 'none';
    
    // Actualizar barras de progreso
    const n1Bar = document.getElementById('n1ProgressBar');
    const n2Bar = document.getElementById('n2ProgressBar');
    const n3Bar = document.getElementById('n3ProgressBar');
    const horoscopeBar = document.getElementById('horoscopeProgressBar');
    const hsk3Bar = document.getElementById('hsk3ProgressBar');
    const hsk4Bar = document.getElementById('hsk4ProgressBar');
    
    if (n1Bar) {
      const percentage = n1Total > 0 ? Math.round((n1Known / n1Total) * 100) : 0;
      setTimeout(() => {
        n1Bar.style.width = `${percentage}%`;
      }, 100);
    }
    
    if (n2Bar) {
      const percentage = n2Total > 0 ? Math.round((n2Known / n2Total) * 100) : 0;
      setTimeout(() => {
        n2Bar.style.width = `${percentage}%`;
      }, 200);
    }
    
    if (n3Bar) {
      const percentage = n3Total > 0 ? Math.round((n3Known / n3Total) * 100) : 0;
      setTimeout(() => {
        n3Bar.style.width = `${percentage}%`;
      }, 300);
    }
    
    if (horoscopeBar) {
      const percentage = horoscopeTotal > 0 ? Math.round((horoscopeKnown / horoscopeTotal) * 100) : 0;
      setTimeout(() => {
        horoscopeBar.style.width = `${percentage}%`;
      }, 400);
    }
    
    if (hsk3Bar && hskUnlocked) {
      const percentage = hsk3Total > 0 ? Math.round((hsk3Known / hsk3Total) * 100) : 0;
      setTimeout(() => {
        hsk3Bar.style.width = `${percentage}%`;
      }, 500);
    }
    
    if (hsk4Bar && hskUnlocked) {
      const percentage = hsk4Total > 0 ? Math.round((hsk4Known / hsk4Total) * 100) : 0;
      setTimeout(() => {
        hsk4Bar.style.width = `${percentage}%`;
      }, 600);
    }
    
    // Calcular con la f√≥rmula correcta: 5% por Ê∞¥Âπ≥ y 1% por racha
    const levelMultiplier = 1 + (xpLevel * 0.05); // 5% por cada nivel Ê∞¥Âπ≥
    const streakMultiplier = 1 + (currentStreak * 0.01); // 1% por cada punto de racha
    
    // Calcular componentes del puntaje
    const totalLevels = cards.filter(c => c.known).reduce((sum, c) => sum + (c.challengeStreak || 0), 0);
    const baseScore = knownCharacters + totalLevels;
    const finalScore = Math.floor(baseScore * levelMultiplier * streakMultiplier);
    
    // Calcular porcentajes de bonificaci√≥n (sin el 100% base)
    const levelBonus = xpLevel * 5; // 5% x nivel
    const streakBonus = currentStreak * 1; // 1% x racha
    
    // Actualizar f√≥rmula
    // Actualizar elementos de la f√≥rmula
    const formulaChars = document.getElementById('formulaChars');
    const formulaLevels = document.getElementById('formulaLevels');
    const formulaLevelPercent = document.getElementById('formulaLevelPercent');
    const formulaLevelMult = document.getElementById('formulaLevelMult');
    const formulaLevelResult = document.getElementById('formulaLevelResult');
    const formulaStreakPercent = document.getElementById('formulaStreakPercent');
    const formulaStreakMult = document.getElementById('formulaStreakMult');
    const formulaStreakResult = document.getElementById('formulaStreakResult');
    const formulaResult = document.getElementById('formulaResult');
    
    // Actualizar valores y data-to para animaci√≥n
    if (formulaChars) {
      formulaChars.textContent = knownCharacters.toLocaleString();
      formulaChars.setAttribute('data-to', knownCharacters.toString());
    }
    if (formulaLevels) {
      formulaLevels.textContent = totalLevels.toLocaleString();
      formulaLevels.setAttribute('data-to', totalLevels.toString());
    }
    
    // Multiplicador de Ê∞¥Âπ≥
    if (formulaLevelPercent) {
      formulaLevelPercent.textContent = '5';
      formulaLevelPercent.setAttribute('data-from', '0');
      formulaLevelPercent.setAttribute('data-to', '5');
    }
    if (formulaLevelMult) {
      formulaLevelMult.textContent = xpLevel.toString();
      formulaLevelMult.setAttribute('data-from', '0');
      formulaLevelMult.setAttribute('data-to', xpLevel.toString());
    }
    if (formulaLevelResult) {

      formulaLevelResult.textContent = levelBonus.toString();
      formulaLevelResult.setAttribute('data-from', '0');
      formulaLevelResult.setAttribute('data-to', levelBonus.toString());
    }
    
    // Multiplicador de racha
    if (formulaStreakPercent) {
      formulaStreakPercent.textContent = '1';
      formulaStreakPercent.setAttribute('data-from', '0');
      formulaStreakPercent.setAttribute('data-to', '1');
    }
    if (formulaStreakMult) {
      formulaStreakMult.textContent = currentStreak.toString();
      formulaStreakMult.setAttribute('data-from', '0');
      formulaStreakMult.setAttribute('data-to', currentStreak.toString());
    }
    if (formulaStreakResult) {

      formulaStreakResult.textContent = streakBonus.toString();
      formulaStreakResult.setAttribute('data-from', '0');
      formulaStreakResult.setAttribute('data-to', streakBonus.toString());
    }
    
    // Resultado final
    if (formulaResult) {
      formulaResult.textContent = finalScore.toLocaleString();
      formulaResult.setAttribute('data-to', finalScore.toString());
    }
  }

  // ========= SISTEMA DE ANIMACI√ìN DE N√öMEROS EN ESTAD√çSTICAS =========
  
  // ========= AUDIO CONTEXT SIMPLE (FUNCIONA EN iOS) =========
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  async function ensureAudio(){ 
    try { 
      const estadoAntes = audioCtx.state;
      if(audioCtx.state !== 'running') {
        console.log(`üîß ensureAudio: AudioContext ${estadoAntes} ‚Üí intentando resume()`);
        await audioCtx.resume();
        console.log(`üîß ensureAudio: resultado ${audioCtx.state}`);
      }
    } catch(e){
      console.error('‚ùå ensureAudio fall√≥:', e);
    } 
  }

  
  function createNumberTickSound() {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      // Sonido m√°s grave y satisfactorio tipo "clic" mec√°nico
      oscillator.type = 'triangle';
      oscillator.frequency.setValueAtTime(220 + Math.random() * 80, audioCtx.currentTime); // M√°s grave (220-300Hz)
      oscillator.frequency.exponentialRampToValueAtTime(180, audioCtx.currentTime + 0.02); // Baja r√°pido
      gainNode.gain.setValueAtTime(0.085, audioCtx.currentTime); // Volumen mucho m√°s alto
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
      
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.03);
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }
  
  function createNumberPopSound(isSpecial = false) {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      if (isSpecial) {
        // ÔøΩ SONIDO CHIN - Simple y satisfactorio
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1760, audioCtx.currentTime); // Agudo met√°lico
        oscillator.frequency.exponentialRampToValueAtTime(2093, audioCtx.currentTime + 0.06); // M√°s agudo
        gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime); // Volumen alto para satisfacci√≥n
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.25);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.25);
      } else {
        // Usar el mismo sonido √©pico pero con menos volumen para pops normales
        
        // Oscilador principal (tono fundamental) - versi√≥n reducida
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(261.63, audioCtx.currentTime); // Do (C4)
        oscillator.frequency.exponentialRampToValueAtTime(329.63, audioCtx.currentTime + 0.1); // Mi (E4)
        oscillator.frequency.exponentialRampToValueAtTime(392.00, audioCtx.currentTime + 0.25); // Sol (G4)
        gainNode.gain.setValueAtTime(0.012, audioCtx.currentTime); // Menos volumen que especial
        gainNode.gain.exponentialRampToValueAtTime(0.02, audioCtx.currentTime + 0.08);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.35);
        
        // Oscilador de armon√≠a m√°s sutil
        const oscillator2 = audioCtx.createOscillator();
        const gainNode2 = audioCtx.createGain();
        oscillator2.connect(gainNode2);
        gainNode2.connect(audioCtx.destination);
        
        oscillator2.type = 'sine';
        oscillator2.frequency.setValueAtTime(392.00, audioCtx.currentTime); // Sol (G4)
        oscillator2.frequency.exponentialRampToValueAtTime(493.88, audioCtx.currentTime + 0.1); // Si (B4)
        oscillator2.frequency.exponentialRampToValueAtTime(523.25, audioCtx.currentTime + 0.25); // Do (C5)
        gainNode2.gain.setValueAtTime(0.008, audioCtx.currentTime);
        gainNode2.gain.exponentialRampToValueAtTime(0.015, audioCtx.currentTime + 0.08);
        gainNode2.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.35);
        
        oscillator2.start(audioCtx.currentTime);
        oscillator2.stop(audioCtx.currentTime + 0.35);
      }
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }

  // Sonido satisfactorio para modal de resultados del desaf√≠o
  function createChallengeResultsSound() {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      
      // Crear un acorde mayor satisfactorio con progresi√≥n arm√≥nica
      const notes = [
        { freq: 261.63, delay: 0.0 },    // Do (C4)
        { freq: 329.63, delay: 0.1 },    // Mi (E4) 
        { freq: 392.00, delay: 0.15 },   // Sol (G4)
        { freq: 523.25, delay: 0.25 }    // Do agudo (C5)
      ];
      
      notes.forEach((note, index) => {
        setTimeout(() => {
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(note.freq, audioCtx.currentTime);
          
          // Envelope suave y satisfactorio
          gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.08, audioCtx.currentTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
          
          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.8);
        }, note.delay * 1000);
      });
      
    } catch (e) {
      // Fallar silenciosamente si no hay audio
    }
  }

  // 10 Sonidos de impacto tipo pu√±o/espada para golpes
  function createHitSound() {
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      
      const now = audioCtx.currentTime;
      
      // STRIKE - Golpe preciso (√∫nico sonido)

      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      const filter = audioCtx.createBiquadFilter();
      
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.exponentialRampToValueAtTime(110, now + 0.08);
      
      filter.type = 'highpass';
      filter.frequency.setValueAtTime(150, now);
      
      gain.gain.setValueAtTime(0.12, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
      
      osc.start(now);
      osc.stop(now + 0.1);
      
      
    } catch (e) {
      console.error('Error creando sonido de impacto:', e);
    }
  }
  
  function animateStatsNumbers() {
    const animateElements = document.querySelectorAll('.animate-number');
    
    let currentIndex = 0;
    
    function animateNext() {
      if (currentIndex >= animateElements.length) {
        return;
      }
      
      const element = animateElements[currentIndex];
      
      // Verificar si ya se anim√≥ para evitar repetir
      if (element.getAttribute('data-animated') === 'true') {
        currentIndex++;
        setTimeout(animateNext, 100);
        return;
      }
      
      // Detectar grupos simult√°neos espec√≠ficos
      let elementsToAnimate = [element];
      let elementsToSkip = 0;
      
      // GRUPO INICIAL: Caracteres conocidos y niveles de caracteres (empiezan juntos)
      if (element.id === 'formulaChars' || element.id === 'formulaLevels') {
        console.log('üéØ Animando GRUPO INICIAL: Caracteres y Niveles juntos');
        
        // Encontrar AMBOS elementos del grupo inicial que a√∫n NO han sido animados
        const grupoInicialIDs = ['formulaChars', 'formulaLevels'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupoInicialIDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      
      // GRUPO 1: Los 4 elementos de bonificaciones (porcentajes + multiplicadores)
      else if (element.id === 'formulaLevelPercent' || element.id === 'formulaStreakPercent' || 
          element.id === 'formulaLevelMult' || element.id === 'formulaStreakMult') {
        console.log('üéØ Animando GRUPO 1: Porcentajes y Multiplicadores juntos');
        
        // Encontrar TODOS los elementos del grupo 1 que a√∫n NO han sido animados
        const grupo1IDs = ['formulaLevelPercent', 'formulaStreakPercent', 'formulaLevelMult', 'formulaStreakMult'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupo1IDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      
      // GRUPO 2: Los 2 resultados de bonificaciones
      else if (element.id === 'formulaLevelResult' || element.id === 'formulaStreakResult') {
        console.log('üéØ Animando GRUPO 2: Resultados de bonificaciones juntos');
        
        // Encontrar TODOS los elementos del grupo 2 que a√∫n NO han sido animados
        const grupo2IDs = ['formulaLevelResult', 'formulaStreakResult'];
        elementsToAnimate = []; // Limpiar para reconstruir
        
        grupo2IDs.forEach(id => {
          const el = document.getElementById(id);
          if (el && el.getAttribute('data-animated') !== 'true') {
            elementsToAnimate.push(el);
          }
        });
      }
      

      
      // Contador para el callback
      let completedAnimations = 0;
      const totalAnimations = elementsToAnimate.length;
      
      // Funci√≥n de callback que maneja la finalizaci√≥n
      const handleAnimationComplete = () => {
        completedAnimations++;
        if (completedAnimations === totalAnimations) {
          // Marcar todos como animados
          elementsToAnimate.forEach(el => el.setAttribute('data-animated', 'true'));
          
          // Avanzar el √≠ndice hasta despu√©s de todos los elementos animados
          // Buscar el pr√≥ximo elemento no animado
          do {
            currentIndex++;
          } while (currentIndex < animateElements.length && 
                   animateElements[currentIndex].getAttribute('data-animated') === 'true');
          
          // Esperar menos tiempo para el siguiente grupo
          setTimeout(animateNext, 150);
        }
      };
      
      // Animar todos los elementos del grupo simult√°neamente
      elementsToAnimate.forEach((el, index) => {
        const fromValue = el.getAttribute('data-from') || '0';
        let toValue = el.getAttribute('data-to') || el.textContent;
        
        // Obtener valor actual real
        const currentDisplayValue = el.textContent;
        if (currentDisplayValue && currentDisplayValue !== '0') {
          toValue = currentDisplayValue;
          el.setAttribute('data-to', toValue);
        }
        

        
        // Animar seg√∫n el tipo de valor
        if (fromValue.includes('/') || toValue.includes('/')) {
          animateSlashValue(el, fromValue, toValue, handleAnimationComplete);
        } else if (fromValue.includes('%') || toValue.includes('%')) {
          animatePercentageValue(el, fromValue, toValue, handleAnimationComplete);
        } else {
          const fromNum = parseInt(fromValue) || 0;
          const toNum = parseInt(toValue) || 0;
          animateNumberValue(el, fromNum, toNum, handleAnimationComplete);
        }
      });
    }
    
    animateNext();
  }
  
  function animateNumberValue(element, from, to, callback) {
    
    // Duraciones diferentes seg√∫n el tipo de elemento
    let duration = 400; // Default
    if (element.id.includes('Percent')) {
      duration = 300; // M√°s r√°pido para porcentajes (5%, 1%)
    } else if (element.id.includes('Mult')) {
      duration = 300; // R√°pido para multiplicadores (Ê∞¥Âπ≥, ÁÅ´)
    } else if (element.id.includes('Result') && element.id !== 'formulaResult') {
      duration = 200; // Medio para resultados parciales (35%, 7%)
    } else if (element.id === 'formulaResult') {
      duration = 300; // M√°s lento para el resultado final (dram√°tico)
    }
    
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 40; // Tocar sonido cada 40ms
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // Easing suave (ease-out)
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(from + (to - from) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente (solo si el n√∫mero est√° cambiando)
      if (elapsed - lastSoundTime > soundInterval && currentValue !== from && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      // Para n√∫meros peque√±os (sin separadores de miles en f√≥rmula)
      if (to < 1000 && element.style.minWidth) {
        element.textContent = currentValue.toString();
      } else {
        element.textContent = currentValue.toLocaleString();
      }
      

      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {

        // Para n√∫meros peque√±os (sin separadores de miles en f√≥rmula)
        if (to < 1000 && element.style.minWidth) {
          element.textContent = to.toString();
        } else {
          element.textContent = to.toLocaleString();
        }
        // Efecto "pop" al terminar
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function animateSlashValue(element, from, to, callback) {
    const fromParts = from.split('/').map(p => parseInt(p) || 0);
    const toParts = to.split('/').map(p => parseInt(p) || 0);
    
    const duration = 1200; // M√°s r√°pido para valores con "/"
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 100; // Sonidos cada 100ms para valores con slash
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentFirst = Math.floor(fromParts[0] + (toParts[0] - fromParts[0]) * easeProgress);
      const currentSecond = Math.floor(fromParts[1] + (toParts[1] - fromParts[1]) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente
      if (elapsed - lastSoundTime > soundInterval && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      element.textContent = `${currentFirst}/${currentSecond}`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        element.textContent = to;
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function animatePercentageValue(element, from, to, callback) {
    const fromNum = parseInt(from.replace('%', '')) || 100;
    const toNum = parseInt(to.replace('%', '')) || 100;
    
    const duration = 800; // M√°s r√°pido para porcentajes
    const startTime = performance.now();
    let lastSoundTime = 0;
    const soundInterval = 90; // Sonido cada 90ms para porcentajes
    
    function animate(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeProgress = 1 - Math.pow(1 - progress, 3);
      const currentValue = Math.floor(fromNum + (toNum - fromNum) * easeProgress);
      
      // Tocar sonido de tick peri√≥dicamente
      if (elapsed - lastSoundTime > soundInterval && progress < 0.95) {
        createNumberTickSound();
        lastSoundTime = elapsed;
      }
      
      element.textContent = `${currentValue}%`;
      
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        element.textContent = to;
        popAnimation(element, callback);
      }
    }
    
    requestAnimationFrame(animate);
  }
  
  function popAnimation(element, callback) {
    // Tocar sonido especial para el resultado final, normal para otros
    const isSpecial = element.id === 'formulaResult';
    createNumberPopSound(isSpecial);
    
    // Efecto "pop" con escalado (m√°s dram√°tico para resultado final)
    const scale = isSpecial ? '1.3' : '1.2';
    element.style.transform = `scale(${scale})`;
    element.style.transition = 'transform 0.2s ease-out';
    
    // Llamar al callback ANTES de terminar la wave para solapar animaciones
    if (callback && !isSpecial) {
      setTimeout(callback, 100); // Callback temprano para solapar
    }
    
    setTimeout(() => {
      element.style.transform = 'scale(1)';
      
      // Onda d√≠gito por d√≠gito
      setTimeout(() => {
        digitWaveEffect(element, isSpecial ? callback : null); // Solo callback para especial
      }, 200);
    }, isSpecial ? 250 : 200); // Mantener el scale un poco m√°s para resultado final
  }
  
  function digitWaveEffect(element, callback) {
    const text = element.textContent;
    const chars = text.split('');
    
    // Crear spans para cada car√°cter
    element.innerHTML = chars.map(char => 
      `<span style="display: inline-block;">${char}</span>`
    ).join('');
    
    const charElements = element.querySelectorAll('span');
    
    // Animar cada car√°cter con delay secuencial
    charElements.forEach((charEl, index) => {
      setTimeout(() => {
        charEl.style.transform = 'scale(1.3)';
        charEl.style.color = '#fbbf24'; // Amarillo
        charEl.style.transition = 'all 0.15s ease-out';
        
        setTimeout(() => {
          charEl.style.transform = 'scale(1)';
          charEl.style.color = ''; // Volver al color original
        }, 150);
      }, index * 50);
    });
    
    // Callback despu√©s de completar la onda
    setTimeout(() => {
      if (callback) callback();
    }, chars.length * 50 + 300);
  }

  // Event listeners para el modal de logros
  document.addEventListener('DOMContentLoaded', () => {
    // === FUERZA JERSEY 10 V√çA JAVASCRIPT ===
    const forceJerseyFont = () => {
      const jerseyButtons = [
        'btnNiveles', 'btnNivel1', 'btnNivel2', 'btnNivel3',
        'btnAchievements', 'btnDonation', 'btnHoroscopo',
        'btnChallenge', 'btnChangeGroup', 'btnKnownTable',
        'btnShowHanzi', 'btnShowPinyin', 'btnShowMeaning',
        'btnCatAll', 'btnCatS', 'btnCatA', 'btnCatV', 'btnCatP', 'btnCatE'
      ];
      
      jerseyButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
          btn.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          btn.style.fontWeight = "400";
          
          // Tambi√©n fuerza a todos los elementos hijos
          const children = btn.querySelectorAll('*');
          children.forEach(child => {
            child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
            child.style.fontWeight = "400";
          });
        }
      });
      
      // Fuerza tambi√©n elementos con clases jersey-font
      const jerseyElements = document.querySelectorAll('[class*="jersey-font"]');
      jerseyElements.forEach(el => {
        el.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
        el.style.fontWeight = "400";
        
        // Tambi√©n fuerza elementos hijos
        const children = el.querySelectorAll('*');
        children.forEach(child => {
          child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          child.style.fontWeight = "400";
        });
      });
      
      // Fuerza espec√≠ficamente elementos de Mi Colecci√≥n
      const knownCount = document.getElementById('knownCount');
      if (knownCount) {
        knownCount.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
      }
      
      // Fuerza elementos din√°micos en knownGrid
      const knownGrid = document.getElementById('knownGrid');
      if (knownGrid) {
        const cards = knownGrid.querySelectorAll('.card-hanzi, .trading-card');
        cards.forEach(card => {
          card.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          const children = card.querySelectorAll('*');
          children.forEach(child => {
            child.style.fontFamily = "'Jersey 10', 'Courier New', monospace";
          });
        });
      }
    };
    
    // === FUNCI√ìN PARA APLICAR ANTI-ZOOM SOLAMENTE ===
    const applyMobileAntiZoom = () => {
      // Detectar si es m√≥vil
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return;
      

      
      // Solo aplicar propiedades anti-zoom, NO cambiar font-size
      const allElements = document.querySelectorAll('*');
      allElements.forEach(el => {
        el.style.webkitTextSizeAdjust = 'none';
        el.style.textSizeAdjust = 'none';
      });
      

    };
    
    // Ejecutar funciones inmediatamente
    forceJerseyFont();
    applyMobileAntiZoom();
    // updateUnitProgressCounters(); // Movido para despu√©s de cargar cards
    
    // Y tambi√©n despu√©s de que carguen las fuentes
    document.fonts.ready.then(() => {
      setTimeout(() => {
        forceJerseyFont();
        applyMobileAntiZoom();
        // updateUnitProgressCounters(); // Movido para despu√©s de cargar cards
      }, 100);
    });
    
    // Re-aplicar en cambios de orientaci√≥n
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        applyMobileAntiZoom();
        forceJerseyFont();
        // updateUnitProgressCounters(); // Se ejecutar√° cuando cards est√© listo
      }, 300);
    });
    
    // Re-aplicar en resize
    window.addEventListener('resize', () => {
      setTimeout(() => {
        applyMobileAntiZoom();
        // updateUnitProgressCounters(); // Se ejecutar√° cuando cards est√© listo
      }, 100);
    });

    const btnAchievements = document.getElementById('btnAchievements');
    const achievementsModal = document.getElementById('achievementsModal');
    const closeAchievementsModal = document.getElementById('closeAchievementsModal');

    if (btnAchievements && achievementsModal && closeAchievementsModal) {
      btnAchievements.onclick = () => {
        // üîù PRIMERO hacer scroll al top inmediatamente
        window.scrollTo({ top: 0, behavior: 'instant' });
        document.body.scrollTop = 0; // Para Safari
        document.documentElement.scrollTop = 0; // Para otros browsers
        
        updateAchievements();
        
        // Resetear todos los n√∫meros a 0 antes de mostrar el modal
        document.querySelectorAll('.animate-number').forEach(el => {
          el.textContent = '0';
          el.removeAttribute('data-animated');
        });
        
        achievementsModal.classList.remove('hidden');
        

        
        // Iniciar animaciones de n√∫meros (dar tiempo para que el modal se muestre)
        setTimeout(() => {

          animateStatsNumbers();
        }, 100);
        
        // Asegurar que el contenido del modal est√© en el top
        setTimeout(() => {
          const modalContent = achievementsModal.querySelector('.overflow-y-auto');
          if (modalContent) {
            modalContent.scrollTop = 0;
          }
        }, 10);
      };

      closeAchievementsModal.onclick = () => {
        achievementsModal.classList.add('hidden');
      };

      // Cerrar al hacer clic fuera del modal
      achievementsModal.onclick = (e) => {
        if (e.target === achievementsModal) {
          achievementsModal.classList.add('hidden');
        }
      };
    }
  });
  
  // --- Login autom√°tico ---
  function showLoginForm() {
    const loginDiv = document.createElement('div');
    loginDiv.style.position = 'fixed';
    loginDiv.style.top = '0';
    loginDiv.style.left = '0';
    loginDiv.style.width = '100vw';
    loginDiv.style.height = '100vh';
    loginDiv.style.background = 'linear-gradient(45deg, rgba(0,0,0,0.8) 25%, rgba(20,20,20,0.8) 25%, rgba(20,20,20,0.8) 50%, rgba(0,0,0,0.8) 50%, rgba(0,0,0,0.8) 75%, rgba(20,20,20,0.8) 75%)';
    loginDiv.style.backgroundSize = '20px 20px';
    loginDiv.style.zIndex = '9999';
    loginDiv.style.display = 'flex';
    loginDiv.style.alignItems = 'center';
    loginDiv.style.justifyContent = 'center';
    loginDiv.innerHTML = `
      <form id="loginForm" style="
        background: linear-gradient(45deg, #ffd700, #ffed4e, #fbbf24, #f59e0b);
        border: 3px solid #d97706;
        border-radius: 0px;
        box-shadow: 8px 8px 0px #000, inset 0 0 0 2px #fde047, inset 4px 4px 8px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.4);
        padding: 24px; 
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-width: 320px;
        font-family: 'Jersey 10', monospace;
        image-rendering: pixelated;
      ">
        <h2 style="
          color: #fff;
          font-size: 24px;
          font-family: 'Jersey 10', monospace;
          text-align: center;
          margin: 0 0 16px 0;
          text-shadow: 2px 2px 0px #000;
          letter-spacing: 2px;
        ">INICIAR SESI√ìN</h2>
        
        <input id="loginUser" type="text" placeholder="USUARIO" style="
          padding: 12px;
          border: 3px solid #666;
          border-radius: 0px;
          background: #f0f0f0;
          color: #000;
          font-size: 16px;
          font-family: 'Jersey 10', monospace;
          font-weight: bold;
          box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
          image-rendering: pixelated;
        " required />
        
        <input id="loginPass" type="text" placeholder="CONTRASE√ëA" style="
          padding: 12px;
          border: 3px solid #666;
          border-radius: 0px;
          background: #f0f0f0;
          color: #000;
          font-size: 16px;
          font-family: 'Jersey 10', monospace;
          font-weight: bold;
          box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
          image-rendering: pixelated;
        " required />
        
        <button type="submit" style="
          padding: 12px 0;
          border: 3px solid #4CAF50;
          border-radius: 0px;
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: #fff;
          font-weight: bold;
          font-size: 18px;
          font-family: 'Jersey 10', monospace;
          text-shadow: 1px 1px 0px #2d5a2d;
          box-shadow: 4px 4px 0px #2d5a2d;
          cursor: pointer;
          transition: all 0.1s;
          image-rendering: pixelated;
        " onmouseover="this.style.transform='translate(-2px, -2px)'; this.style.boxShadow='6px 6px 0px #2d5a2d';" onmouseout="this.style.transform='translate(0, 0)'; this.style.boxShadow='4px 4px 0px #2d5a2d';">
          ‚ñ∂ ENTRAR ‚óÄ
        </button>
        
        <button id="btnCreateUser" type="button" style="
          padding: 10px 0;
          border: 3px solid #ff9800;
          border-radius: 0px;
          background: linear-gradient(135deg, #ff9800, #e68900);
          color: #fff;
          font-weight: bold;
          font-size: 16px;
          font-family: 'Jersey 10', monospace;
          text-shadow: 1px 1px 0px #b8660a;
          box-shadow: 3px 3px 0px #b8660a;
          cursor: pointer;
          transition: all 0.1s;
          image-rendering: pixelated;
        " onmouseover="this.style.transform='translate(-1px, -1px)'; this.style.boxShadow='4px 4px 0px #b8660a';" onmouseout="this.style.transform='translate(0, 0)'; this.style.boxShadow='3px 3px 0px #b8660a';">
          ‚ûï CREAR USUARIO NUEVO
        </button>
        
        <div id="loginError" style="
          color: #ff4444;
          font-size: 14px;
          font-family: 'Jersey 10', monospace;
          text-align: center;
          font-weight: bold;
          text-shadow: 1px 1px 0px #000;
        "></div>
      </form>
      <div id="registerBox" style="
        display: none;
        margin-top: 24px;
        background: linear-gradient(45deg, #00ff41, #00d93d, #39ff14, #00ff41);
        border: 3px solid #00cc33;
        border-radius: 0px;
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ff88, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.5),
          0 0 20px rgba(0, 255, 65, 0.4),
          0 0 40px rgba(0, 255, 65, 0.2);
        padding: 20px;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        max-width: 400px;
        min-width: 280px;
        box-sizing: border-box;
        margin-left: auto;
        margin-right: auto;
        font-family: 'Jersey 10', monospace;
        image-rendering: pixelated;
      ">
        <h3 style="
          color: #fff;
          font-size: 20px;
          font-family: 'Jersey 10', monospace;
          text-align: center;
          margin: 0 0 16px 0;
          text-shadow: 2px 2px 0px #000;
          letter-spacing: 1px;
        ">üë§ REGISTRO DE USUARIO üë§</h3>
        
        <div id="registerStepCode">
          <input id="registerCode" type="text" placeholder="C√ìDIGO DE INVITACI√ìN" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " />
          
          <button id="btnCheckCode" type="button" style="
            margin-top: 12px;
            padding: 10px 0;
            width: 100%;
            border: 3px solid #9c27b0;
            border-radius: 0px;
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            text-shadow: 1px 1px 0px #4a0e4e;
            box-shadow: 3px 3px 0px #4a0e4e;
            cursor: pointer;
            transition: all 0.1s;
            image-rendering: pixelated;
          " onmouseover="this.style.transform='translate(-1px, -1px)'; this.style.boxShadow='4px 4px 0px #4a0e4e';" onmouseout="this.style.transform='translate(0, 0)'; this.style.boxShadow='3px 3px 0px #4a0e4e';">
            ‚úì VALIDAR C√ìDIGO
          </button>
          
          <div id="registerCodeError" style="
            color: #ff4444;
            font-size: 14px;
            font-family: 'Jersey 10', monospace;
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 0px #000;
            margin-top: 8px;
          "></div>
        </div>
        <form id="registerForm" style="
          display: none;
          flex-direction: column;
          gap: 16px;
          font-family: 'Jersey 10', monospace;
          background: linear-gradient(45deg, #00ff41, #00d93d, #39ff14, #00ff41);
          border: 3px solid #00cc33;
          border-radius: 0px;
          box-shadow: 
            8px 8px 0px #000, 
            inset 0 0 0 2px #00ff88, 
            inset 4px 4px 8px rgba(0, 255, 65, 0.5),
            0 0 20px rgba(0, 255, 65, 0.4);
          padding: 20px;
          margin-top: 16px;
        ">
          <input id="registerUser" type="text" placeholder="USUARIO (LETRAS, N√öMEROS, - y _)" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " pattern="[a-zA-Z0-9_-]{3,}" minlength="3" required />
          
          <input id="registerEmail" type="email" placeholder="EMAIL" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " required />
          
          <input id="registerPass1" type="text" placeholder="CONTRASE√ëA" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " required />
          
          <input id="registerPass2" type="text" placeholder="REPETIR CONTRASE√ëA" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " required />
          
          <select id="registerCountry" style="
            padding: 12px;
            border: 3px solid #666;
            border-radius: 0px;
            background: #f0f0f0;
            color: #000;
            font-size: 16px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            width: 100%;
            box-sizing: border-box;
            box-shadow: inset 3px 3px 0px #ddd, inset -3px -3px 0px #fff;
            image-rendering: pixelated;
          " required>
            <option value="">üåç SELECCIONA TU PA√çS</option>
            <option value="Argentina">üá¶üá∑ Argentina</option>
            <option value="China">üá®üá≥ China</option>
            <option value="M√©xico">üá≤üáΩ M√©xico</option>
            <option value="Espa√±a">üá™üá∏ Espa√±a</option>
            <option value="Chile">üá®üá± Chile</option>
            <option value="Colombia">üá®üá¥ Colombia</option>
            <option value="Per√∫">üáµüá™ Per√∫</option>
            <option value="Uruguay">üá∫üáæ Uruguay</option>
            <option value="Ecuador">üá™üá® Ecuador</option>
            <option value="Bolivia">üáßüá¥ Bolivia</option>
            <option value="Venezuela">üáªüá™ Venezuela</option>
            <option value="Paraguay">üáµüáæ Paraguay</option>
            <option value="Costa Rica">üá®üá∑ Costa Rica</option>
            <option value="Panam√°">üáµüá¶ Panam√°</option>
            <option value="Estados Unidos">üá∫üá∏ Estados Unidos</option>
            <option value="Portugal">üáµüáπ Portugal</option>
            <option value="Francia">üá´üá∑ Francia</option>
            <option value="Guatemala">üá¨üáπ Guatemala</option>
            <option value="Honduras">üá≠üá≥ Honduras</option>
            <option value="El Salvador">üá∏üáª El Salvador</option>
            <option value="Nicaragua">üá≥üáÆ Nicaragua</option>
            <option value="Puerto Rico">üáµüá∑ Puerto Rico</option>
            <option value="Cuba">üá®üá∫ Cuba</option>
            <option value="Rep√∫blica Dominicana">üá©üá¥ Rep√∫blica Dominicana</option>
            <option value="Otro">üåè Otro</option>
          </select>
          
          <button type="submit" style="
            padding: 12px 0;
            border: 3px solid #4CAF50;
            border-radius: 0px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            font-family: 'Jersey 10', monospace;
            text-shadow: 1px 1px 0px #2d5a2d;
            box-shadow: 4px 4px 0px #2d5a2d;
            cursor: pointer;
            transition: all 0.1s;
            image-rendering: pixelated;
          " onmouseover="this.style.transform='translate(-2px, -2px)'; this.style.boxShadow='6px 6px 0px #2d5a2d';" onmouseout="this.style.transform='translate(0, 0)'; this.style.boxShadow='4px 4px 0px #2d5a2d';">
            REGISTRAR USUARIO
          </button>
          
          <div id="registerError" style="
            color: #ff4444;
            font-size: 14px;
            font-family: 'Jersey 10', monospace;
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 0px #000;
            margin-top: 8px;
          "></div>
          
          <button id="btnBackToLogin" type="button" style="
            margin-top: 16px;
            padding: 8px 0;
            width: 100%;
            border: 3px solid #666;
            border-radius: 0px;
            background: linear-gradient(135deg, #666, #555);
            color: white;
            font-size: 14px;
            font-family: 'Jersey 10', monospace;
            font-weight: bold;
            text-shadow: 1px 1px 0px #000;
            box-shadow: 3px 3px 0px #333;
            cursor: pointer;
            transition: all 0.1s;
            image-rendering: pixelated;
          " onmouseover="this.style.transform='translate(-1px, -1px)'; this.style.boxShadow='4px 4px 0px #333';" onmouseout="this.style.transform='translate(0, 0)'; this.style.boxShadow='3px 3px 0px #333';">
            ‚Üê VOLVER AL LOGIN
          </button>
        </form>
      </div>
    `;
    document.body.appendChild(loginDiv);
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPass').value;
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = '';
      try {
        const res = await fetch(`${window.API_BASE}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if(res.ok){
          const data = await res.json();
          jwtToken = data.token;
          window.username = data.username || username;
          localStorage.setItem('jwtToken', jwtToken);
          localStorage.setItem('username', window.username);
          loginDiv.remove();
          
          // Mostrar pantalla de carga tras login exitoso
          showLoadingScreen();
          
          console.log('üîê Login exitoso, iniciando carga completa...');
          updateLoadingProgress(5, 'Iniciando sesi√≥n...');
          
          // Cargar todos los datos del usuario
          await loadAll();
          
          updateLoadingProgress(80, 'Cargando leaderboard...');
          await renderLeaderboard();
          
          updateLoadingProgress(90, 'Finalizando...');
          
          // Activar preload secundario despu√©s del login exitoso
          setTimeout(() => {
            if (typeof preloadSecondaryImages === 'function') {
              preloadSecondaryImages();
              console.log('üéØ Preload secundario activado post-login');
            }
          }, 1500);
          
          // Esperar un momento para asegurar que todo est√© renderizado
          setTimeout(() => {
            updateLoadingProgress(100, '¬°Listo!');
            setTimeout(() => {
              hideLoadingScreen();
              console.log('‚úÖ Login completado - pantalla de carga oculta');
            }, 300);
          }, 500);
          
        } else {
          errorDiv.textContent = 'Usuario o contrase√±a incorrectos.';
        }
      } catch(err){
        errorDiv.textContent = 'Error de conexi√≥n.';
      }
    };

    // --- Registro de usuario ---
    document.getElementById('btnCreateUser').onclick = function() {
      // Ocultar el formulario de login temporalmente
      document.getElementById('loginForm').style.display = 'none';
      // Mostrar el registro
      const registerBox = document.getElementById('registerBox');
      registerBox.style.display = 'flex';
      registerBox.style.position = 'relative';
      registerBox.style.marginTop = '0';
    };
    document.getElementById('btnCheckCode').onclick = function() {
      const code = document.getElementById('registerCode').value.trim();
      const codeError = document.getElementById('registerCodeError');
      if(code !== 'macaymanu33') {
        codeError.textContent = 'C√≥digo incorrecto.';
        return;
      }
      codeError.textContent = '';
      document.getElementById('registerStepCode').style.display = 'none';
      document.getElementById('registerForm').style.display = 'flex';
    };
    document.getElementById('registerForm').onsubmit = async function(e) {
      e.preventDefault();
      const user = document.getElementById('registerUser').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const pass1 = document.getElementById('registerPass1').value;
      const pass2 = document.getElementById('registerPass2').value;
      const country = document.getElementById('registerCountry').value;
      const errorDiv = document.getElementById('registerError');
      errorDiv.textContent = '';
      // Validar nombre de usuario
      if(user.length < 3) {
        errorDiv.textContent = 'El usuario debe tener al menos 3 caracteres.';
        return;
      }
      if(!/^[a-zA-Z0-9_-]+$/.test(user)) {
        errorDiv.textContent = 'El usuario solo puede contener letras, n√∫meros, guiones (-) y guiones bajos (_).';
        return;
      }
      if(/\s/.test(user)) {
        errorDiv.textContent = 'El usuario no puede contener espacios.';
        return;
      }
      // Validar email
      if(!email || !email.includes('@') || !email.includes('.')) {
        errorDiv.textContent = 'Ingresa un email v√°lido.';
        return;
      }
      if(pass1.length < 4) {
        errorDiv.textContent = 'La contrase√±a debe tener al menos 4 caracteres.';
        return;
      }
      if(pass1 !== pass2) {
        errorDiv.textContent = 'Las contrase√±as no coinciden.';
        return;
      }
      if(!country) {
        errorDiv.textContent = 'Selecciona tu pa√≠s.';
        return;
      }
      try {
        const res = await fetch(`${window.API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, email: email, password: pass1, country })
        });
        if(res.ok){
          errorDiv.style.color = '#22c55e';
          errorDiv.textContent = 'Usuario creado correctamente. Ahora puedes iniciar sesi√≥n.';
          setTimeout(()=>{ 
            document.getElementById('registerBox').style.display = 'none';
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('registerError').textContent = '';
          }, 1800);
        } else {
          const data = await res.json();
          errorDiv.textContent = data.error || 'No se pudo crear el usuario.';
        }
      } catch(err){
        errorDiv.textContent = 'Error de conexi√≥n.';
      }
    };

    // Agregar validaci√≥n en tiempo real para el campo usuario
    document.getElementById('registerUser').addEventListener('input', function(e) {
      const user = e.target.value;
      const errorDiv = document.getElementById('registerError');
      
      // Limpiar error anterior
      if (errorDiv.style.color !== '#22c55e') {
        errorDiv.textContent = '';
      }
      
      // Validar en tiempo real
      if (user.length > 0) {
        if (user.length < 3) {
          errorDiv.textContent = 'M√≠nimo 3 caracteres';
          errorDiv.style.color = '#ff4444';
        } else if (!/^[a-zA-Z0-9_-]+$/.test(user)) {
          errorDiv.textContent = 'Solo letras, n√∫meros, - y _';
          errorDiv.style.color = '#ff4444';
        } else if (/\s/.test(user)) {
          errorDiv.textContent = 'Sin espacios permitidos';
          errorDiv.style.color = '#ff4444';
        } else {
          errorDiv.textContent = '‚úì Usuario v√°lido';
          errorDiv.style.color = '#22c55e';
        }
      }
    });

    // Bot√≥n para volver al login desde el registro
    document.getElementById('btnBackToLogin').onclick = function() {
      // Ocultar el registro
      document.getElementById('registerBox').style.display = 'none';
      // Mostrar el formulario de login nuevamente
      document.getElementById('loginForm').style.display = 'flex';
      // Limpiar errores del registro
      document.getElementById('registerError').textContent = '';
    };
  }

  window.addEventListener('DOMContentLoaded', async () => {
    // üçé ACTIVAR AUDIO EN iOS CON PRIMERA INTERACCI√ìN
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      console.log('üçé iOS detectado: Configurando activaci√≥n de audio');
      
      // Funci√≥n para activar audio con primera interacci√≥n
      const activateAudio = async () => {
        try {
          await ensureAudio();
          console.log('üçé iOS: AudioContext activado exitosamente');
          
          // Crear un audio silencioso para "despertar" el sistema de audio
          const silentAudio = new Audio();
          silentAudio.src = 'data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAAFN3aXRjaCBQbHVzIMKpIE5DSCBTb2Z0d2FyZQBUSVQyAAAABgAAAzIyAFRQRTEAAAARAAAAU3dpdGNoIFBsdXMgMi4wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
          silentAudio.volume = 0;
          silentAudio.play().catch(() => {}); // Ignorar errores
          
          console.log('üçé iOS: Sistema de audio preparado');
          
          // Remover listeners despu√©s de activar
          document.removeEventListener('touchstart', activateAudio);
          document.removeEventListener('click', activateAudio);
        } catch (e) {
          console.log('üçé iOS: Error activando audio:', e);
        }
      };
      
      // Agregar listeners para primera interacci√≥n
      document.addEventListener('touchstart', activateAudio, { once: true, passive: true });
      document.addEventListener('click', activateAudio, { once: true, passive: true });
    }
    
    // Mostrar pantalla de carga al inicio si hay token
    if (jwtToken) {
      updateLoadingProgress(5, 'Iniciando aplicaci√≥n...');
    }
    
    // Inicializar controles
    initializeControls();
    
    // Inicializar pools de sonidos (solo celebration y congratulation - correct usa sonido sint√©tico)
    initCelebrationSoundPool();
    initCongratulationSoundPool();
    
    // OCULTAR BOTONES DE QUIZ AL INICIO (no hay modo seleccionado)
    const quizModeButtons = document.getElementById('quizModeButtons');
    if (quizModeButtons) {
      quizModeButtons.classList.add('hidden');
      console.log('üéØ DEBUG: Botones de quiz ocultados al inicio');
    }
    
    // Ejecutar actualizaci√≥n inicial de botones del hor√≥scopo despu√©s de un momento
    setTimeout(() => {
      console.log('üîÑ Ejecutando updateHoroscopeButtonsState inicial en DOMContentLoaded...');
      if (typeof updateHoroscopeButtonsState === 'function') {
        updateHoroscopeButtonsState();
      }
    }, 1000);
    
    // Scroll al top al cargar la p√°gina
    window.scrollTo(0, 0);
    
    // Tambi√©n forzar scroll al top en pageshow (bot√≥n atr√°s del navegador)
    window.addEventListener('pageshow', () => {
      window.scrollTo(0, 0);
    });

    // === INICIALIZAR SISTEMA DE IM√ÅGENES OPTIMIZADO ===
    console.log('üñºÔ∏è Iniciando sistema de optimizaci√≥n de im√°genes...');
    
    // Iniciar preload cr√≠tico inmediatamente
    preloadCriticalImages();
    
    // Programar preload secundario
    setTimeout(() => {
      preloadSecondaryImages();
    }, 1000);
    
    // Configurar limpieza peri√≥dica del cache
    setInterval(() => {
      optimizeImageCache();
    }, 60000); // Cada minuto
    

    
    // Service Worker removido - ya no se necesita
    
    // Configurar URL base del API
    // Para desarrollo local, siempre usar localhost:4000
    console.log('Hostname actual:', window.location.hostname);
    console.log('Protocol actual:', window.location.protocol);
    
    if (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      window.API_BASE = 'http://localhost:4000';
    } else {
      // En producci√≥n, usar el mismo dominio (Railway maneja el puerto internamente)
      window.API_BASE = window.location.origin;
    }
    
    console.log('API_BASE configurado como:', window.API_BASE);
    
    // Modo documental: siempre cargar directamente (sin login)
    if(!jwtToken){
      hideLoadingScreen();
      console.log('‚ö†Ô∏è No hay token, esto no deber√≠a pasar en modo documental');
    } else {
      await loadAll();
      await renderLeaderboard();
      // Mostrar el bot√≥n y box de Nivel 2 si est√° desbloqueado
      if(nivel2Unlocked) {
        // Mostrar directamente sin llamar la funci√≥n que puede no estar definida a√∫n
        const nivel2Wrap = document.getElementById('nivel2Wrap');
        if(nivel2Wrap) nivel2Wrap.style.display = '';
        const btnNivel2 = document.getElementById('btnNivel2');
        if(btnNivel2) btnNivel2.style.display = '';
        const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
        if(nivel2ProgressWrap) nivel2ProgressWrap.style.display = 'flex';
        console.log('‚úÖ Nivel 2 mostrado en loadAll');
      }
      
      // Forzar scroll al top despu√©s de cargar todos los datos
      setTimeout(() => {
        window.scrollTo(0, 0);
      }, 100);
    }
  });
  </script>

        
      </div>
    </header>

    <!-- Barra de experiencia (XP) -->
    <div id="xpBarWrap" class="mt-4 mb-2 mx-8">
      <div class="flex items-center justify-between gap-2 mb-1">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <span id="xpLabel" class="font-bold text-2xl whitespace-nowrap" style="font-family: 'Jersey 10', monospace;">Ê∞¥Âπ≥ <span id="xpLevel">1</span></span>
          <span id="xpToNext" class="text-lg lg:text-lg flex-1 min-w-0" style="font-family: 'Jersey 10', monospace; font-weight: bold;"></span>
        </div>
      </div>
      <div class="xp-bar-container">
        <div id="xpBar" class="xp-bar-fill" style="width:0%"></div>
      </div>
    </div>

    <!-- ---------- Estado ---------- -->
  
    <section class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2 text-lg mx-8">
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-none">Faltan</div>
        <div id="statInSession" class="text-lg font-semibold leading-none">0</div>
      </div>
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-none">Revisadas</div>
        <div id="statToday" class="text-lg font-semibold leading-none">0</div>
      </div>
      <div id="statBox" style="background-color: #2e3856;" class="rounded-xl py-1 px-2 jersey-font-leaderboard">
        <div class="text-slate-400 text-xl leading-none">Modo Actual</div>
        <div id="statMission" class="text-lg font-semibold leading-none">‚Äî</div>
      </div>
      <div style="background-color: #2e3856;" class="rounded-xl py-1 px-2 cursor-pointer jersey-font-leaderboard" id="streakBox">
        <div class="text-slate-400 flex items-center gap-1 text-xl leading-none">
          Rachas <span id="streakCount" class="font-bold text-orange-400">0</span> <span style="font-size:1.1em;vertical-align:middle;">üî•</span>
        </div>
        <div id="streakStatus" class="text-sm font-semibold text-orange-300 leading-none">‚Äî</div>
      </div>
    </section>

     <!-- ---------- Tarjeta ---------- -->
    <!-- Pantalla de precarga para videos -->
    <div id="videoPreloader" style="display: none;">
      <div class="preloader-overlay">
        <div class="preloader-content">
          <div class="preloader-spinner"></div>
          <h2 class="preloader-title">Cargando Desaf√≠o</h2>
          <p class="preloader-text">¬°Entrando a salvar este mundo!</p>
          <div class="preloader-progress">
            <div class="preloader-progress-bar" id="preloadProgress"></div>
          </div>
        </div>
        <!-- Cuenta regresiva -->
        <div class="countdown-content" id="countdownContent" style="display: none;">
          <h2 class="countdown-title">¬øEst√°s listo?</h2>
          <div class="countdown-number" id="countdownNumber">3</div>
          <p class="countdown-text">¬°Prep√°rate para ganar!</p>
        </div>
      </div>
    </div>

    <main class="mt-2 mx-6 sm:mx-12 lg:mx-20 xl:mx-32">
      <div id="cardWrap" class="relative h-56 sm:h-80 select-none perspective">
        <div id="card" class="absolute inset-0 rounded-3xl ring-1 ring-white/10 shadow-xl flex items-center justify-center text-center preserve-3d transition-transform duration-300 will-change-transform" style="background-color: #2e3856;">
          <div id="cardFront" class="absolute inset-0 flex items-center justify-center backface-hidden text-6xl font-bold"></div>
          <div id="cardBack" class="absolute inset-0 flex flex-col items-center justify-center rotateY180 backface-hidden text-2xl leading-relaxed whitespace-pre-line"></div>
        </div>
      </div>

      <!-- Controles modo FLASH -->
      <div id="flashRow" class="mt-4 grid grid-cols-3 gap-2 mx-2 sm:mx-4">
        <button id="btnDontKnow" class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">No la s√©</button>
        <button id="btnFlip"     class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">Voltear</button>
        <button id="btnKnow"     class="py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500 border-2 border-black/60 border-b-4 border-b-black/60 shadow-md transition-all duration-200 hover:translate-y-0.5 hover:border-b-2">La s√©</button>
      </div>

      <!-- Controles modo QUIZ (opciones din√°micas) -->
      <div id="quizRow" class="mt-4 grid grid-cols-2 gap-2 hidden mx-2 sm:mx-4"></div>
      
      
      <!-- Indicador de controles de teclado para desktop 
      <div id="keyboardHint" class="mt-2 text-center text-xs text-gray-400 hidden">
        üíª Desktop: Usa las teclas <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">1</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">2</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">3</kbd> <kbd class="px-1 py-0.5 bg-gray-700 rounded text-xs">4</kbd>
      </div>-->
      
      <!-- Botones de Quiz - Solo aparecen en modos espec√≠ficos -->
      <div id="quizModeButtons" class="mt-4 grid grid-cols-3 gap-2 hidden mx-2 sm:mx-4">
        <button id="btnQuizPinyin" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Pinyin</span>
        </button>
        <button id="btnQuizMeaning" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Trad</span>
        </button>
        <button id="btnQuizHanzi" class="px-1 py-1 rounded-2xl font-semibold min-h-[50px] flex items-center justify-center" style="font-size: clamp(8px, 3vw, 14px);">
          <span class="whitespace-nowrap">Quiz Hanzi</span>
        </button>
      </div>


    </main>
  </div>

  <!-- ========= Overlay: Leaderboard y Tabla Conocidas ========= -->
  <section class="mt-16 mx-2 sm:mx-8">
    <!-- üèÜ Leaderboard primero -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-2 flex-wrap">
        
        <span class="text-lg font-bold" style="color: #FFD700; font-family: 'Jersey 10', monospace; text-shadow: 2px 2px 0px #b8860b; font-size: 20px;">üèÜ LEADERBOARD</span>
        <button id="btnReloadLeaderboard" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-semibold transition-all border-2 border-black/60 border-b-4 border-b-black/60 shadow-md hover:translate-y-0.5 hover:border-b-2 jersey-font-leaderboard" title="Actualizar leaderboard">
          Actualizar
        </button>
        <button id="btnShowMyContext" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-semibold transition-all border-2 border-black/60 border-b-4 border-b-black/60 shadow-md hover:translate-y-0.5 hover:border-b-2 jersey-font-leaderboard" title="Ver mi contexto en el ranking">
          üéØ Mi contexto
        </button>
        <select id="leaderboardCountryFilter" class="px-3 py-2 rounded-xl bg-slate-800 text-white font-semibold border border-slate-700 transition-colors hover:bg-slate-700 jersey-font-dropdown">
          <option value="">üåé Todos los pa√≠ses</option>
          <option value="Argentina">üá¶üá∑ Argentina</option>
          <option value="China">üá®üá≥ China</option>
          <option value="M√©xico">üá≤üáΩ M√©xico</option>
          <option value="Espa√±a">üá™üá∏ Espa√±a</option>
          <option value="Chile">üá®üá± Chile</option>
          <option value="Colombia">üá®üá¥ Colombia</option>
          <option value="Per√∫">üáµüá™ Per√∫</option>
          <option value="Uruguay">üá∫üáæ Uruguay</option>
          <option value="Ecuador">üá™üá® Ecuador</option>
          <option value="Bolivia">üáßüá¥ Bolivia</option>
          <option value="Venezuela">üáªüá™ Venezuela</option>
          <option value="Paraguay">üáµüáæ Paraguay</option>
          <option value="Costa Rica">üá®üá∑ Costa Rica</option>
          <option value="Panam√°">üáµüá¶ Panam√°</option>
          <option value="Estados Unidos">üá∫üá∏ Estados Unidos</option>
          <option value="Portugal">üáµüáπ Portugal</option>
          <option value="Francia">üá´üá∑ Francia</option>
          <option value="Guatemala">üá¨üáπ Guatemala</option>
          <option value="Honduras">üá≠üá≥ Honduras</option>
          <option value="El Salvador">üá∏üáª El Salvador</option>
          <option value="Nicaragua">üá≥üáÆ Nicaragua</option>
          <option value="Puerto Rico">üáµüá∑ Puerto Rico</option>
          <option value="Cuba">üá®üá∫ Cuba</option>
          <option value="Rep√∫blica Dominicana">üá©üá¥ Rep√∫blica Dominicana</option>
        </select>
        <select id="leaderboardGroupFilter" class="px-3 py-2 rounded-xl bg-slate-800 text-white font-semibold border border-slate-700 transition-colors hover:bg-slate-700 jersey-font-dropdown">
          <option value="">üë• Todos los grupos</option>
          <option value="N1">üî¥ N1</option>
          <option value="N2">üü† N2</option>
          <option value="N3">üü° N3</option>
          <option value="N4">üü¢ N4</option>
          <option value="N5">üîµ N5</option>
          <option value="S">‚≠ê S</option>
          <option value="HSK3">üèÆ HSK3</option>
          <option value="No">‚ùå No</option>
        </select>
        <div class="relative">
          <button id="btnChangeGroup" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-sm text-white font-semibold transition-colors jersey-font-acciones">
            Mi Grupo
          </button>
          <div id="groupSelector" class="absolute left-0 mt-2 bg-slate-800 border border-slate-700 rounded-xl shadow-lg p-2 flex-col gap-1 z-30 hidden min-w-[140px]">
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N1">üî¥ N1</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N2">üü† N2</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N3">üü° N3</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N4">üü¢ N4</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="N5">üîµ N5</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="S">‚≠ê S</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="HSK3">üèÆ HSK3</button>
            <button class="group-option px-3 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold transition-colors jersey-font-dropdown" data-group="No">‚ùå No</button>
          </div>
        </div>
      </div>
      <div id="leaderboardTable" class="overflow-x-auto"></div>
    </div>
    
    <!-- üìä Tabla de conocidas despu√©s del leaderboard -->
    <div class="mt-8">
      <div class="flex items-center gap-3 mb-2">
        <h2 class="text-lg font-bold jersey-font-coleccion-title" style="color: #FFD700; text-shadow: 2px 2px 0px #b8860b;">üìñ MI COLECCION</h2>

      </div>
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <span id="knownCount" class="text-slate-400 jersey-font-coleccion-counter">0</span>
        <div class="flex items-center gap-2">
          <button id="btnShowHanzi" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Ê±âÂ≠ó</button>
          <button id="btnShowPinyin" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Pinyin</button>
          <button id="btnShowMeaning" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10 jersey-font-coleccion-buttons">Significado</button>
        </div>
        <div class="flex items-center gap-1 ml-4">
          <button id="btnCatAll" class="px-2 py-1 rounded bg-slate-700 font-bold jersey-font-coleccion-filters">Todos</button>
          <button id="btnCatS" class="px-2 py-1 rounded bg-green-700 font-bold jersey-font-coleccion-filters">S</button>
          <button id="btnCatA" class="px-2 py-1 rounded bg-orange-600 font-bold jersey-font-coleccion-filters">A</button>
          <button id="btnCatV" class="px-2 py-1 rounded bg-red-700 font-bold jersey-font-coleccion-filters">V</button>
          <button id="btnCatP" class="px-2 py-1 rounded bg-yellow-600 font-bold jersey-font-coleccion-filters">P</button>
          <button id="btnCatE" class="px-2 py-1 rounded bg-blue-700 font-bold jersey-font-coleccion-filters">E</button>
        </div>
      </div>
      
      <!-- Barra de progreso de caracteres conocidos -->
      <div class="mb-4 space-y-2">
        <div class="flex items-center gap-2 justify-center">
          <span class="text-xl">üìñ</span>
          <span class="text-slate-300 font-bold jersey-font-coleccion-filters">Progreso:</span>
          <span id="miColeccionCharacters" class="text-white font-bold jersey-font-coleccion-filters">0/0</span>
          <span class="text-slate-400">-</span>
          <span id="miColeccionProgressText" class="text-yellow-400 text-sm font-bold jersey-font-coleccion-filters" style="text-shadow: 0 0 4px rgba(251, 191, 36, 0.6);">0% Coleccionados</span>
        </div>
        
        <!-- Barra de progreso de caracteres -->
        <div class="w-full bg-gray-800 rounded-lg h-3 overflow-hidden border border-yellow-600/50">
          <div id="miColeccionProgressBar" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);"></div>
        </div>
        
        <!-- Texto informativo debajo de la barra de progreso -->
        <div class="text-center mt-2">
          <p class="text-slate-300" style="font-size: 20px; font-family: 'Jersey 10', monospace; line-height: 1;">
            Sube los niveles de tus Caracteres para hacer m√°s da√±o a los Jefes y subir tu Puntaje en el Leaderboard.
          </p>
        </div>
      </div>
      
      <div id="knownGrid" class="w-full max-w-full overflow-hidden mb-16"></div>
    </div>
    
    <!-- Botones de administraci√≥n al final -->
    <div class="mt-16 pt-8 border-t border-slate-800">
      
      <!-- Contenedor principal de botones -->
      <div id="mainButtonsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg mx-auto">
        <button id="btnUnlockCode" class="px-4 py-3 rounded-2xl bg-purple-600 hover:bg-purple-500 text-white font-semibold transition-colors text-center" style="font-family: 'Jersey 10', monospace;">
          üîë C√≥digo
        </button>
        <button id="btnShowResetOptions" class="px-4 py-3 rounded-2xl bg-orange-600 hover:bg-orange-500 font-semibold transition-colors text-center" style="font-family: 'Jersey 10', monospace;">
          ‚ö†Ô∏è PERDER MI PROGRESO
        </button>
        <button id="btnLogout" class="px-4 py-3 rounded-2xl bg-red-700 hover:bg-red-600 text-white font-semibold transition-colors text-center" style="font-family: 'Jersey 10', monospace;">
          Cerrar sesi√≥n
        </button>
      </div>
    </div>
    
    <div style="height: 70px;"></div>
  </section>

  <!-- ========= NUEVO MODAL: Reiniciar Progreso Completo ========= -->
  <div id="nuevoResetModal" class="fixed inset-0 bg-black/95 hidden z-[10000] flex items-center justify-center p-4">
    <div class="w-full max-w-lg bg-gradient-to-br from-red-950 to-black border-4 border-red-600 rounded-3xl shadow-2xl" style="box-shadow: 0 0 40px rgba(220, 38, 38, 0.7);">
      <!-- Header -->
      <div class="bg-red-900/50 p-6 text-center border-b-2 border-red-600">
        <div class="text-5xl mb-2">‚ö†Ô∏è</div>
        <p class="text-red-300 text-xl mt-2" style="font-family: 'Jersey 10', monospace;">
          Reinicio Total de Cuenta
        </p>
      </div>
      
      <!-- Contenido -->
      <div class="p-6 space-y-4">
        <p class="text-white text-center text-lg font-bold">
          Esta acci√≥n es <span class="text-red-400 text-2xl">IRREVERSIBLE</span>
        </p>
        
        <div class="bg-red-900/40 border-2 border-red-700 rounded-xl p-4">
          <p class="text-red-300 font-bold text-center mb-3 text-lg">üìâ PERDER√ÅS TODO:</p>
          <ul class="space-y-2.5 text-white text-base">
            <li class="flex items-center gap-3">
              <span class="text-red-500 text-xl">‚ùå</span>
              <span><strong>Ê∞¥Âπ≥ y XP</strong> - Nivel 0</span>
            </li>
            <li class="flex items-center gap-3">
              <span class="text-red-500 text-xl">‚ùå</span>
              <span><strong>Caracteres conocidos</strong> - Todo borrado</span>
            </li>
            <li class="flex items-center gap-3">
              <span class="text-red-500 text-xl">‚ùå</span>
              <span><strong>Niveles y rachas (ÁÅ´)</strong> - Todo a 0</span>
            </li>
          </ul>
        </div>
      </div>
      
      <!-- Botones -->
      <div class="p-6 space-y-3">
        <button id="confirmarNuevoReset" class="w-full px-6 py-4 rounded-xl bg-gradient-to-r from-red-700 to-red-900 hover:from-red-600 hover:to-red-800 border-2 border-red-500 text-white text-xl font-bold transition-all duration-300 shadow-lg" style="font-family: 'Jersey 10', monospace;">
          üóëÔ∏è S√ç, BORRAR TODO
        </button>
        <button id="cancelarNuevoReset" class="w-full px-6 py-4 rounded-xl bg-gradient-to-r from-green-700 to-green-900 hover:from-green-600 hover:to-green-800 border-2 border-green-500 text-white text-xl font-bold transition-all duration-300 shadow-lg" style="font-family: 'Jersey 10', monospace;">
          ‚ùå CANCELAR
        </button>
      </div>
    </div>
  </div>

  <!-- ========= SEGUNDO MODAL: Confirmaci√≥n Final ========= -->
  <div id="confirmacionFinalModal" class="fixed inset-0 bg-black/98 hidden z-[10001] flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-gradient-to-br from-red-900 to-red-950 border-4 border-red-500 rounded-3xl shadow-2xl animate-pulse-slow" style="box-shadow: 0 0 60px rgba(220, 38, 38, 0.9), 0 0 100px rgba(220, 38, 38, 0.5);">
      <!-- Header -->
      <div class="bg-red-800/70 p-8 text-center border-b-4 border-red-400">
        <div class="text-6xl mb-3 animate-bounce">üö®</div>
        <h2 class="text-4xl font-bold text-red-300 mb-2" style="font-family: 'Jersey 10', monospace; text-shadow: 0 0 20px rgba(239, 68, 68, 1), 3px 3px 0px #7f1d1d;">
          ¬øEST√ÅS 100% SEGURO?
        </h2>
      </div>
      
      <!-- Contenido -->
      <div class="p-8 space-y-6">
        <div class="bg-black/50 border-4 border-red-600 rounded-2xl p-6 text-center">
          <p class="text-white text-2xl font-bold mb-4">
            Se borrar√°:
          </p>
          <div class="text-red-300 text-7xl font-bold mb-4" style="font-family: 'Jersey 10', monospace;">
            TODO
          </div>
          <p class="text-red-400 text-xl font-bold">
            No hay vuelta atr√°s
          </p>
        </div>
      </div>
      
      <!-- Botones -->
      <div class="p-8 space-y-4">
        <button id="confirmarDefinitivo" class="w-full px-8 py-5 rounded-2xl bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 border-4 border-red-400 text-white text-2xl font-bold transition-all duration-300 shadow-2xl animate-pulse" style="font-family: 'Jersey 10', monospace;">
          üíÄ ELIMINAR TODO AHORA
        </button>
        <button id="cancelarDefinitivo" class="w-full px-8 py-5 rounded-2xl bg-gradient-to-r from-gray-700 to-gray-900 hover:from-gray-600 hover:to-gray-800 border-4 border-gray-500 text-white text-2xl font-bold transition-all duration-300 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
          üõ°Ô∏è NO, DETENER
        </button>
      </div>
    </div>
  </div>

  <!-- ========= Modal: Logros y Objetivos ========= -->
  <div id="achievementsModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-2xl max-h-[80vh] flex flex-col" style="
      background: linear-gradient(135deg, #1f2937 0%, #111827 50%, #1f2937 100%);
      border: 3px solid #fbbf24;
      border-radius: 24px;
      box-shadow: 
        0 0 20px rgba(251, 191, 36, 0.5),
        0 0 40px rgba(251, 191, 36, 0.3),
        inset 0 2px 4px rgba(255, 255, 255, 0.1);
      overflow: hidden;
      ">
      <!-- Header fijo -->
      <div class="flex items-center justify-between p-4 flex-shrink-0" style="
        border-bottom: 2px solid #fbbf24;
        background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
        ">
        <h2 style="
          font-family: 'Jersey 10', monospace;
          font-size: 28px;
          color: #fbbf24;
          text-shadow: 0 0 8px rgba(251, 191, 36, 0.8), 2px 2px 0px #b45309;
          filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.6));
          ">
          üèÖ LOGROS Y OBJETIVOS
        </h2>        
        <button id="closeAchievementsModal" class="text-yellow-400 hover:text-yellow-200 font-bold" style="
          font-family: 'Jersey 10', monospace;
          font-size: 24px;
          text-shadow: 0 0 4px rgba(251, 191, 36, 0.6);
          transition: all 0.3s ease;
          " 
          onmouseover="this.style.transform='scale(1.1) rotate(90deg)'; this.style.textShadow='0 0 8px rgba(251, 191, 36, 0.9)'"
          onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.textShadow='0 0 4px rgba(251, 191, 36, 0.6)'">‚úï</button>
      </div>
      
      <!-- Content con scroll -->
      <div class="flex-1 overflow-y-auto" style="border-radius: 0 0 21px 21px;">
        <div class="p-6 space-y-8" style="
          background: linear-gradient(180deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.9) 100%);
          border-radius: 0 0 21px 21px;
          ">
        
        <!-- Mis Estad√≠sticas -->
        <div class="achievement-category">
          <h3 class="text-lg font-semibold mb-3 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.7), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            üìä MIS ESTAD√çSTICAS <span id="statsUsername" style="color: #fbbf24; text-shadow: 0 0 6px rgba(251, 191, 36, 0.7), 1px 1px 0px #f59e0b;"></span>
          </h3>
          
          <!-- Estad√≠sticas compactas -->
          <div class="mb-4 text-lg jersey-font-coleccion-cards space-y-3">
            <!-- L√≠nea superior con XP, Racha y Nivel -->
            <div class="flex flex-wrap gap-x-6 gap-y-2">
              <div class="flex items-center gap-1">
                <span class="text-xl">‚ö°</span>
                <span class="text-cyan-300 font-bold">XP:</span>
                <span id="statsXP" class="text-white font-bold">0</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-xl">üî•</span>
                <span class="text-cyan-300 font-bold">Racha:</span>
                <span id="statsStreak" class="text-white font-bold">0</span>
              </div>
              <div class="flex items-center gap-1">
                <span class="text-cyan-300 font-bold">Ê∞¥Âπ≥:</span>
                <span id="statsLevel" class="text-white font-bold">1</span>
              </div>
            </div>
            
            <!-- Secci√≥n de Caracteres por Nivel -->
            <div class="space-y-3">
              <!-- Nivel 1 -->
              <div class="space-y-1">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">Nivel 1</span>
                  <span id="statsN1Characters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-yellow-600/50">
                  <div id="n1ProgressBar" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);"></div>
                </div>
              </div>
              
              <!-- Nivel 2 -->
              <div class="space-y-1">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">Nivel 2</span>
                  <span id="statsN2Characters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-yellow-600/50">
                  <div id="n2ProgressBar" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);"></div>
                </div>
              </div>
              
              <!-- Nivel 3 -->
              <div class="space-y-1">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">Nivel 3</span>
                  <span id="statsN3Characters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-yellow-600/50">
                  <div id="n3ProgressBar" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);"></div>
                </div>
              </div>
              
              <!-- Hor√≥scopo -->
              <div class="space-y-1">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">Hor√≥scopo</span>
                  <span id="statsHoroscopeCharacters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-yellow-600/50">
                  <div id="horoscopeProgressBar" class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);"></div>
                </div>
              </div>
              
              <!-- HSK3 (solo visible si est√° desbloqueado) -->
              <div id="hsk3ProgressContainer" class="space-y-1" style="display: none;">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">HSK3</span>
                  <span id="statsHSK3Characters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-amber-600/50">
                  <div id="hsk3ProgressBar" class="h-full bg-gradient-to-r from-amber-700 to-amber-600 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(120, 53, 15, 0.6);"></div>
                </div>
              </div>
              
              <!-- HSK4 (solo visible si est√° desbloqueado) -->
              <div id="hsk4ProgressContainer" class="space-y-1" style="display: none;">
                <div class="flex items-center justify-between">
                  <span class="text-cyan-300 font-bold text-sm">HSK4</span>
                  <span id="statsHSK4Characters" class="text-white font-bold text-sm">0/0</span>
                </div>
                <div class="w-full bg-gray-800 rounded-lg h-2.5 overflow-hidden border border-amber-600/50">
                  <div id="hsk4ProgressBar" class="h-full bg-gradient-to-r from-amber-700 to-amber-600 transition-all duration-500 ease-out" style="width: 0%; box-shadow: 0 0 10px rgba(120, 53, 15, 0.6);"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- F√≥rmula de Puntajes Totales -->
          <div class="bg-gradient-to-r from-slate-900/80 to-slate-800/80 rounded-lg p-2 border-2 border-yellow-500/50">
            <div class="text-xl jersey-font-coleccion-cards space-y-3">
              <!-- L√≠neas de la f√≥rmula por separado -->
              <div class="bg-slate-900/50 p-2 rounded space-y-2">
                <!-- Base: caracteres + niveles -->
                <div class="text-gray-300">
                  (<span id="formulaChars" class="text-cyan-400 font-bold animate-number" data-from="0" data-to="0" style="min-width: 1.5em; display: inline-block; text-align: right;">0</span> caracteres + 
                  <span id="formulaLevels" class="text-cyan-400 font-bold animate-number" data-from="0" data-to="0" style="min-width: 1.7em; display: inline-block; text-align: right;">0</span> niveles de caracter)
                </div>
                <!-- Multiplicador de los Ê∞¥Âπ≥ -->
                <div class="text-green-400 font-bold">
                  √ó (<span id="formulaLevelPercent" class="animate-number" data-from="0" data-to="0" style="min-width: 1.3em; display: inline-block; text-align: right;">0</span>% x <span id="formulaLevelMult" class="animate-number" data-from="0" data-to="0" style="min-width: 0.5em; display: inline-block; text-align: right;">0</span>Ê∞¥Âπ≥ = <span id="formulaLevelResult" class="animate-number" data-from="0" data-to="0" style="min-width: 1em; display: inline-block; text-align: right;">0</span>%)
                </div>
                <!-- Multiplicador de rachas -->
                <div class="text-orange-400 font-bold">
                  √ó (<span id="formulaStreakPercent" class="animate-number" data-from="0" data-to="0" style="min-width: 1.3em; display: inline-block; text-align: right;">0</span>% x <span id="formulaStreakMult" class="animate-number" data-from="0" data-to="0" style="min-width: 0.5em; display: inline-block; text-align: right;">0</span>ÁÅ´ = <span id="formulaStreakResult" class="animate-number" data-from="0" data-to="0" style="min-width: 1em; display: inline-block; text-align: right;">0</span>%)
                </div>
                <!-- Resultado final -->
                <div class="border-t border-gray-600 pt-2 mt-3">
                  <span class="text-yellow-300">PUNTAJE TOTAL = </span>
                  <span id="formulaResult" class="text-yellow-300 font-bold text-xl animate-number" data-from="0" data-to="0" style="min-width: 2em; display: inline-block; text-align: right;">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Desaf√≠os Principales -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.6), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            ‚öîÔ∏è DESAF√çOS PRINCIPALES
          </h3>
          <div class="grid gap-2">
            <div id="achievement-desafioN1" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 1</div>
                <span class="achievement-status"></span>
              </div>
            </div>
            
            <div id="achievement-desafioN2" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 2</div>


                <span class="achievement-status"></span>
              </div>
            </div>
            
            <div id="achievement-desafioN3" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üéØ</span>
                <div class="flex-1 achievement-title">Completar Desaf√≠o Nivel 3</div>
                <span class="achievement-status"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Jefes Finales -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #f87171;
            text-shadow: 0 0 6px rgba(248, 113, 113, 0.6), 1px 1px 0px #dc2626;
            font-size: 20px;
            ">
            üëë JEFES FINALES
          </h3>
          <div class="grid gap-2">
            <div id="achievement-cruzar-mar" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üåä</span>
                <div class="flex-1 achievement-title">Derrotar a Cruzar el Mar</div>
                <span class="achievement-status"></span>
              </div>
            </div>
            <div id="achievement-cruzar-cielo" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">‚òÅÔ∏è</span>
                <div class="flex-1 achievement-title">Derrotar a Cruzar el Cielo</div>
                <span class="achievement-status"></span>
              </div>
            </div>
            <div id="achievement-bestias12" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üêâ</span>
                <div class="flex-1 achievement-title">Derrotar a la Bestia</div>
                <span class="achievement-status"></span>
              </div>
            </div>
            <div id="achievement-emperatriz" class="achievement-item achievement-objective">
              <div class="flex items-center gap-3">
                <span class="achievement-icon">üë∏</span>
                <div class="flex-1 achievement-title">Derrotar a la Emperatriz</div>
                <span class="achievement-status"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Los 12 del Hor√≥scopo -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #a855f7;
            text-shadow: 0 0 6px rgba(168, 85, 247, 0.6), 1px 1px 0px #7c3aed;
            font-size: 20px;
            ">
            üê≤ LOS 12 DEL HOR√ìSCOPO
          </h3>
          <div class="grid gap-2" id="horoscope-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Caracteres Conocidos -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #06b6d4;
            text-shadow: 0 0 6px rgba(6, 182, 212, 0.6), 1px 1px 0px #0891b2;
            font-size: 20px;
            ">
            üìö CARACTERES CONOCIDOS
          </h3>
          <div class="grid gap-2" id="chars-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Niveles de Caracteres -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #fb923c;
            text-shadow: 0 0 6px rgba(251, 146, 60, 0.6), 1px 1px 0px #ea580c;
            font-size: 20px;
            ">
            üìà NIVELES DE DOMINIO
          </h3>
          <div class="grid gap-2" id="levels-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Progreso XP -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #4ade80;
            text-shadow: 0 0 6px rgba(74, 222, 128, 0.6), 1px 1px 0px #16a34a;
            font-size: 20px;
            ">
            ‚≠ê EXPERIENCIA
          </h3>
          <div class="grid gap-2" id="xp-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Score Total -->
        <div class="achievement-category">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2" style="
            font-family: 'Jersey 10', monospace;
            color: #60a5fa;
            text-shadow: 0 0 6px rgba(96, 165, 250, 0.6), 1px 1px 0px #2563eb;
            font-size: 20px;
            ">
            üéñÔ∏è PUNTUACI√ìN TOTAL
          </h3>
          <div class="grid gap-2" id="score-achievements">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        </div>
      </div>
    </div>
  </div>

  <script>
  /* ========= SISTEMA DE HISTORIA MOVIDO A story.html ========= */
  // El sistema de historia completo ahora est√° en story.html y se carga autom√°ticamente
  // mediante iframe oculto en el head del documento.

  /* ========= Estado y setup ========= */
  // Variable para controlar el estado del leaderboard
  let showingMyContext = false;
  
  // --- Leaderboard logic (Modo Documental - Datos Ficticios) ---
  
  // Datos ficticios del leaderboard (18 usuarios hardcodeados)
  function getFakeLeaderboardData() {
    return [
      { username: 'Messi', country: 'Argentina', group: 'N1', xp: 230, knownCharsCount: 200, streak: 30, level: 5 },
      { username: 'Ronaldo', country: 'Portugal', group: 'N1', xp: 220, knownCharsCount: 180, streak: 28, level: 5 },
      { username: 'MacaLaoshi', country: 'China', group: 'N1', xp: 210, knownCharsCount: 170, streak: 25, level: 4 },
      { username: 'MrBeast', country: 'Estados Unidos', group: 'N1', xp: 200, knownCharsCount: 160, streak: 22, level: 4 },
      { username: 'JackieChan', country: 'China', group: 'N2', xp: 190, knownCharsCount: 150, streak: 20, level: 4 },
      { username: 'Yaoming', country: 'China', group: 'N2', xp: 180, knownCharsCount: 140, streak: 18, level: 4 },
      { username: 'Agustinaaprende', country: 'Argentina', group: 'N2', xp: 170, knownCharsCount: 130, streak: 15, level: 3 },
      { username: 'LeonardoDV', country: 'Estados Unidos', group: 'N2', xp: 160, knownCharsCount: 120, streak: 14, level: 3 },
      { username: 'ManuShi', country: 'Argentina', group: 'N2', xp: 120, knownCharsCount: 80, streak: 10, level: 3 },
      { username: 'Gero', country: 'Colombia', group: 'N2', xp: 110, knownCharsCount: 70, streak: 8, level: 2 },
      { username: 'Antoniobanderas', country: 'Espa√±a', group: 'N3', xp: 100, knownCharsCount: 60, streak: 7, level: 2 },
      { username: 'GuillermoBull', country: 'Chile', group: 'N3', xp: 90, knownCharsCount: 50, streak: 6, level: 2 },
      { username: 'Jermaioni', country: 'M√©xico', group: 'N3', xp: 80, knownCharsCount: 45, streak: 5, level: 2 },
      { username: 'Tomyjerry', country: 'Panam√°', group: 'N3', xp: 70, knownCharsCount: 40, streak: 4, level: 2 },
      { username: 'Joshi', country: 'M√©xico', group: 'N3', xp: 60, knownCharsCount: 30, streak: 3, level: 1 },
      { username: 'Marioelbross', country: 'Espa√±a', group: 'N3', xp: 50, knownCharsCount: 25, streak: 2, level: 1 },
      { username: 'Mikewasaoski', country: 'Estados Unidos', group: 'N3', xp: 30, knownCharsCount: 15, streak: 1, level: 1 },
      { username: 'Peterpedro', country: 'Panam√°', group: 'N3', xp: 20, knownCharsCount: 10, streak: 1, level: 1 }
    ];
  }
  
  async function fetchLeaderboard(groupFilter = '', countryFilter = '') {
    // Retornar datos ficticios filtrados
    let data = getFakeLeaderboardData();
    
    // Aplicar filtros
    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }
    
    // Calcular score y ranking
    data = data.map(u => {
      const score = calcScore(u);
      return { ...u, totalScore: score };
    });
    
    // Ordenar por score
    data.sort((a, b) => b.totalScore - a.totalScore);
    
    // Asignar posiciones
    data.forEach((u, i) => {
      u.rank = i + 1;
    });
    
    console.log('üèÜ Leaderboard ficticio generado:', data.length, 'usuarios');
    return data.slice(0, 10); // Top 10
  }

  async function fetchLeaderboardFull(groupFilter = '', countryFilter = '') {
    // Igual que fetchLeaderboard pero retorna todos
    let data = getFakeLeaderboardData();
    
    if (groupFilter && groupFilter.trim() !== '') {
      data = data.filter(u => u.group === groupFilter);
    }
    if (countryFilter && countryFilter.trim() !== '') {
      data = data.filter(u => u.country === countryFilter);
    }
    
    data = data.map(u => {
      const score = calcScore(u);
      return { ...u, totalScore: score };
    });
    
    data.sort((a, b) => b.totalScore - a.totalScore);
    
    data.forEach((u, i) => {
      u.rank = i + 1;
    });
    
    return data; // Todos los usuarios
  }

  function calcScore(user) {
    // NUEVA F√ìRMULA: (conocidas + XP) * (1 + 0.01*racha) * (1 + 0.05*nivel)
    const xp = user.xp || 0;
    const known = user.knownCharsCount || 0;
    const streak = user.streak || 0;
    const level = user.level || 1;
    
    const baseScore = known + xp;
    const streakMultiplier = 1 + (0.01 * streak);
    const levelMultiplier = 1 + (0.05 * level);
    
    const finalScore = Math.round(baseScore * streakMultiplier * levelMultiplier);
    
    return finalScore;
  }

  async function showMyContextInLeaderboard() {
    // Obtener filtros actuales
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    // Actualizar estilos de los filtros seg√∫n si est√°n activos
    updateFilterButtonStyles(countryFilterEl, selectedCountry);
    updateFilterButtonStyles(groupFilterEl, selectedGroup);
    
    // Solicitar lista completa para poder mostrar contexto (filtros ya aplicados en backend)
    const filteredLeaderboard = await fetchLeaderboardFull(selectedGroup, selectedCountry);
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      document.getElementById('leaderboardTable').innerHTML = '<div class="text-center text-slate-400 py-4">No hay datos para mostrar contexto</div>';
      return;
    }
    
    // El backend ya se encarga de incluir al usuario actual y ordenar correctamente
    const currentUser = window.username || (window.jwtTokenUser || null);
    
    const myUserIndex = filteredLeaderboard.findIndex(u => u.username === currentUser);
    
    console.log('Debug Mi contexto:');
    console.log('Usuario actual:', currentUser);
    console.log('Mi √≠ndice:', myUserIndex);
    console.log('Total usuarios filtrados:', filteredLeaderboard.length);
    
    if (myUserIndex === -1) {
      document.getElementById('leaderboardTable').innerHTML = '<div class="text-center text-slate-400 py-4">No se encontr√≥ tu posici√≥n en el ranking actual</div>';
      return;
    }
    
    // Obtener 5 usuarios arriba y 5 abajo (o los que haya disponibles)
    const startIndex = Math.max(0, myUserIndex - 5);
    const endIndex = Math.min(filteredLeaderboard.length, myUserIndex + 6); // usuario actual + 5 abajo
    
    console.log('Start index:', startIndex);
    console.log('End index:', endIndex);
    console.log('Usuarios que se van a mostrar:', endIndex - startIndex);
    
    const contextUsers = filteredLeaderboard.slice(startIndex, endIndex);
    
    console.log('Context users length:', contextUsers.length);
    console.log('Context users:', contextUsers.map(u => `${u.username} (pos ${u.rank})`));
    
    renderLeaderboardTable(contextUsers, currentUser, true);
  }

  async function toggleLeaderboardView() {
    const btnShowMyContext = document.getElementById('btnShowMyContext');
    
    if (!showingMyContext) {
      // Cambiar a "mi contexto"
      await showMyContextInLeaderboard();
      showingMyContext = true;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üîù Ver top';
        btnShowMyContext.title = 'Volver al leaderboard completo';
      }
    } else {
      // Cambiar a "ver top"
      await renderLeaderboard();
      showingMyContext = false;
      if (btnShowMyContext) {
        btnShowMyContext.innerHTML = 'üéØ Mi contexto';
        btnShowMyContext.title = 'Ver mi contexto en el ranking';
      }
    }
  }

  // Actualizar estilos visuales de los filtros del leaderboard
  function updateFilterButtonStyles(filterElement, filterValue) {
    if (!filterElement) return;
    
    // Si hay un filtro activo (valor no vac√≠o), poner en rojo
    if (filterValue && filterValue.trim() !== '') {
      filterElement.classList.remove('bg-slate-800', 'hover:bg-slate-700');
      filterElement.classList.add('bg-red-600', 'hover:bg-red-500');
      filterElement.style.borderColor = '#dc2626'; // border-red-600
    } else {
      // Si est√° en default (todos los pa√≠ses/grupos), estilo normal
      filterElement.classList.remove('bg-red-600', 'hover:bg-red-500');
      filterElement.classList.add('bg-slate-800', 'hover:bg-slate-700');
      filterElement.style.borderColor = '#374151'; // border-slate-700
    }
  }

  async function renderLeaderboard() {
    // Obtener filtros seleccionados
    const groupFilterEl = document.getElementById('leaderboardGroupFilter');
    const countryFilterEl = document.getElementById('leaderboardCountryFilter');
    let selectedGroup = '';
    let selectedCountry = '';
    if (groupFilterEl) selectedGroup = groupFilterEl.value;
    if (countryFilterEl) selectedCountry = countryFilterEl.value;
    
    // Actualizar estilos de los filtros seg√∫n si est√°n activos
    updateFilterButtonStyles(countryFilterEl, selectedCountry);
    updateFilterButtonStyles(groupFilterEl, selectedGroup);
    
    console.log('Filtros seleccionados - Grupo:', selectedGroup, 'Pa√≠s:', selectedCountry); // Debug
    
    // El backend aplica todos los filtros y ordenamientos
    const filteredLeaderboard = await fetchLeaderboard(selectedGroup, selectedCountry);
    console.log('Leaderboard recibido del backend:', filteredLeaderboard); // Debug
    
    if(!filteredLeaderboard || filteredLeaderboard.length === 0) {
      let message = 'No hay usuarios';
      if (selectedGroup) message += ` en el grupo ${selectedGroup}`;
      if (selectedCountry) message += ` en ${selectedCountry}`;
      if (!selectedGroup && !selectedCountry) message = 'No recib√≠ nada';
      
      document.getElementById('leaderboardTable').innerHTML = `<div class="text-center text-slate-400 py-4">${message}<br><span class='text-xs break-all text-yellow-400'>JWT: ${jwtToken}</span></div>`;
      return;
    }
    
    // El backend ya incluye al usuario actual y maneja el ordenamiento
    const currentUser = window.username || (window.jwtTokenUser || null);
    
    renderLeaderboardTable(filteredLeaderboard, currentUser, false);
    
    // Eventos para los filtros
    const countryFilterEl2 = document.getElementById('leaderboardCountryFilter');
    if (countryFilterEl2) {
      countryFilterEl2.onchange = renderLeaderboard;
      // Aplicar estilo inicial
      updateFilterButtonStyles(countryFilterEl2, countryFilterEl2.value);
    }
    
    const groupFilterEl2 = document.getElementById('leaderboardGroupFilter');
    if (groupFilterEl2) {
      groupFilterEl2.onchange = renderLeaderboard;
      // Aplicar estilo inicial
      updateFilterButtonStyles(groupFilterEl2, groupFilterEl2.value);
    }
  }

  // Funciones utilitarias para el leaderboard
  function countryToEmoji(country) {
    switch((country||'').toLowerCase()) {
      case 'argentina': return 'üá¶üá∑';
      case 'm√©xico': return 'üá≤üáΩ';
      case 'espa√±a': return 'üá™üá∏';
      case 'chile': return 'üá®üá±';
      case 'colombia': return 'üá®üá¥';
      case 'per√∫': return 'üáµüá™';
      case 'uruguay': return 'üá∫üáæ';
      case 'ecuador': return 'üá™üá®';
      case 'bolivia': return 'üáßüá¥';
      case 'venezuela': return 'üáªüá™';
      case 'paraguay': return 'üáµüáæ';
      case 'costa rica': return 'üá®üá∑';
      case 'panam√°': return 'üáµüá¶';
      case 'estados unidos': return 'üá∫üá∏';
      case 'portugal': return 'üáµüáπ';
      case 'francia': return 'üá´üá∑';
      case 'guatemala': return 'üá¨üáπ';
      case 'honduras': return 'üá≠üá≥';
      case 'el salvador': return 'üá∏üáª';
      case 'nicaragua': return 'üá≥üáÆ';
      case 'puerto rico': return 'üáµüá∑';
      case 'cuba': return 'üá®üá∫';
      case 'rep√∫blica dominicana': return 'üá©üá¥';
      case 'china': return 'üá®üá≥';
      default: return 'üåé';
    }
  }
  
  function groupToDisplay(group) {
    switch(group || '') {
      case 'N1': return 'üî¥ N1';
      case 'N2': return 'üü† N2';
      case 'N3': return 'üü° N3';
      case 'N4': return 'üü¢ N4';
      case 'N5': return 'üîµ N5';
      case 'S': return '‚≠ê S';
      case 'HSK3': return 'üèÆ HSK3';
      case 'No': return '‚ùå No';
      default: return '‚ö´ ‚Äî';
    }
  }
  
  function renderLeaderboardTable(users, currentUser, isContextView) {
    const headerText = isContextView ? 'Mi contexto en el ranking' : 'Leaderboard completo';
    let html = `<table class="min-w-[320px] w-full text-xs sm:text-sm bg-slate-900 rounded-xl overflow-hidden" style="border: 3px solid #ffa726;">`;
    
    if (isContextView) {
      html += `<caption class="text-center text-blue-400 font-bold py-2 text-sm sm:text-lg">${headerText}</caption>`;
    }
    
    html += `<thead><tr class="bg-slate-800 text-yellow-400">
      <th class="py-1 px-1 text-xs sm:text-sm">#</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Usuario</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Pa√≠s</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Grupo</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Niv</th>
      <th class="py-1 px-1 text-xs sm:text-sm">XP</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Conoc</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Racha</th>
      <th class="py-1 px-1 text-xs sm:text-sm">Score</th>
    </tr></thead><tbody>`;
    
    users.forEach((u)=>{
      const score = calcScore(u);
      const known = Array.isArray(u.knownChars) ? u.knownChars.filter(c=>c.known).length : (u.knownCharsCount || 0);
      const lvl = u.level || (typeof getCurrentLevel==='function' ? getCurrentLevel(u.xp||0) : '-');
      
      // Resaltar usuario actual siempre en amarillo
      const isCurrentUser = u.username === currentUser;
      const highlightClass = isCurrentUser ? 'bg-yellow-100 text-black font-bold' : '';
      
      html += `<tr${highlightClass ? ` class="${highlightClass}"` : ''}>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.rank}</td>
        <td class="py-1 px-1 text-xs sm:text-sm max-w-[60px] sm:max-w-none truncate">${u.username}${isCurrentUser && isContextView ? ' üë§' : ''}</td>
        <td class="py-1 px-1 text-center text-xs">${countryToEmoji(u.country)}</td>
        <td class="py-1 px-1 text-center text-xs">${groupToDisplay(u.group)}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${lvl}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.xp||0}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${known}</td>
        <td class="py-1 px-1 text-center text-xs sm:text-sm">${u.streak||0}</td>
        <td class="py-1 px-1 text-center font-bold text-xs sm:text-sm">${u.totalScore || score}</td>
      </tr>`;
    });
    
    html += '</tbody></table>';
    
    if (isContextView) {
      html += '<div class="text-center mt-2">' +
              '<button id="btnBackToFullLeaderboard" class="px-3 py-1 rounded bg-gray-600 hover:bg-gray-500 text-white text-xs">' +
              '‚Üê Volver al leaderboard completo</button></div>';
    }
    
    document.getElementById('leaderboardTable').innerHTML = html;
    
    // Agregar evento para volver al leaderboard completo
    if (isContextView) {
      const btnBack = document.getElementById('btnBackToFullLeaderboard');
      if (btnBack) btnBack.onclick = renderLeaderboard;
    }
  }
  
  const btnReload = document.getElementById('btnReloadLeaderboard');
  if (btnReload) btnReload.onclick = renderLeaderboard;
  const btnStar = document.getElementById('btnStarLeaderboard');
  if (btnStar) btnStar.onclick = renderLeaderboard;
  
  // Agregar evento para bot√≥n de contexto
  const btnShowMyContext = document.getElementById('btnShowMyContext');
  if (btnShowMyContext) btnShowMyContext.onclick = toggleLeaderboardView;

  // --- Funcionalidad para cambiar grupo (DESHABILITADO - Versi√≥n Documental) ---
  async function changeUserGroup(group) {
    // En la versi√≥n documental no necesitamos cambiar grupos en el backend
    console.log('‚ö†Ô∏è changeUserGroup deshabilitado en versi√≥n documental');
    // Simplemente refrescar el leaderboard ficticio
    await renderLeaderboard();
    showGroupChangeMessage(group);
  }

  function showGroupChangeMessage(group) {
    let msg = document.getElementById('groupChangeMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'groupChangeMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-2xl shadow-lg text-sm font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      document.body.appendChild(msg);
    }
    
    const groupDisplay = {
      'N1': 'üî¥ N1',
      'N2': 'üü† N2', 
      'N3': 'üü° N3',
      'N4': 'üü¢ N4',
      'N5': 'üîµ N5',
      'S': '‚≠ê S',
      'HSK3': 'üèÆ HSK3',
      'No': '‚ùå No'
    }[group] || group;
    
    msg.textContent = `Grupo cambiado a: ${groupDisplay}`;
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 2000);
  }

  // Manejar selector de grupo
  window.addEventListener('DOMContentLoaded', function() {
    const btnChangeGroup = document.getElementById('btnChangeGroup');
    const groupSelector = document.getElementById('groupSelector');
    
    if(btnChangeGroup && groupSelector) {
      btnChangeGroup.onclick = (e) => {
        e.stopPropagation();
        groupSelector.style.display = groupSelector.style.display === 'none' ? 'flex' : 'none';
      };
      
      // Cerrar selector al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!groupSelector.contains(e.target) && e.target !== btnChangeGroup) {
          groupSelector.style.display = 'none';
        }
      });
      
      // Manejar selecci√≥n de grupo
      const groupOptions = document.querySelectorAll('.group-option');
      groupOptions.forEach(option => {
        option.onclick = async (e) => {
          e.stopPropagation();
          const selectedGroup = option.getAttribute('data-group');
          await changeUserGroup(selectedGroup);
          groupSelector.style.display = 'none';
        };
      });
    }
  });
 
   // --- Logout button handler ---
   window.addEventListener('DOMContentLoaded', function() {
     var btnLogout = document.getElementById('btnLogout');
     if (btnLogout) {
       btnLogout.onclick = function() {
         localStorage.removeItem('jwtToken');
         jwtToken = null;
         location.reload();
       };
     }
     
     // Agregar evento para bot√≥n de contexto
     const btnShowMyContext = document.getElementById('btnShowMyContext');
     if (btnShowMyContext) {
       btnShowMyContext.onclick = toggleLeaderboardView;
     }
   });
  window.addEventListener('DOMContentLoaded', renderLeaderboard);
  // Backend sync system
  let xpPoints = 0;
  let cards = []; // Global cards array
  
  // Performance monitor stub
  const performanceMonitor = {
    startMonitoring: () => { /* stub */ },
    stopMonitoring: () => { /* stub */ }
  };
  

  
  // ...existing code...
  let unlockedUnits = [];
  let nivel2Unlocked = true; // ‚úÖ DESBLOQUEADO DESDE EL INICIO
  let nivel3Unlocked = true; // ‚úÖ DESBLOQUEADO DESDE EL INICIO
  
  // HSK3 y HSK4 DESBLOQUEADO (requiere c√≥digo)
  let hskUnlocked = true; // ‚úÖ DESBLOQUEADO DESDE EL INICIO
  
  // MAESTRO DEL HOR√ìSCOPO - Ultimate Challenge
  let horoscopeMaster = false;
  let horoscopeMasterAt = null;
  let ultimateChallengeCompletedCount = 0;
  
  // DESAF√çO N3 COMPLETADO
  let desafioN3Completed = false;
  let desafioN3CompletedAt = null;
  
  // DESAF√çO LA EMPERATRIZ COMPLETADO
  let emperatrizCompleted = false;
  let emperatrizCompletedAt = null;
  
  // DESAF√çO 12 BESTIAS COMPLETADO
  let bestias12Completed = false;
  let bestias12CompletedAt = null;
  
  // DESAF√çO CRUZAR EL MAR COMPLETADO
  let cruzarMarCompleted = false;
  let cruzarMarCompletedAt = null;

  // DESAF√çO CRUZAR EL CIELO COMPLETADO
  
  // ========== SISTEMA DE ASISTENCIA (LILI) ==========
  // Nota: En las versiones demo/documentales, Lili no exist√≠a todav√≠a.
  // Mantenemos stubs (no-op) para evitar errores por llamadas existentes.
  let assistanceUsesRemaining = 0;
  let assistanceEnabled = false;
  let assistanceUsedThisQuestion = false;
  let practiceAssistanceEnabled = false;
  let practiceAssistanceUsedThisQuestion = false;

  function showAssistanceButton() {}
  function hideAssistanceButton() {}
  function updateAssistanceButton() {}
  function clearEliminatedOptions() {}
  function showAssistanceDialog() {}
  function showExhaustedDialog() {}
  function startLiliImageRotation() {}
  function stopLiliImageRotation() {}
  function useAssistance() { return; }
  function usePracticeAssistance() { return; }

  function initAssistanceForChallenge() {
    assistanceUsesRemaining = 0;
    assistanceEnabled = false;
    assistanceUsedThisQuestion = false;
  }

  function disableAssistance() {
    assistanceUsesRemaining = 0;
    assistanceEnabled = false;
    assistanceUsedThisQuestion = false;
  }

  function enablePracticeAssistance() {
    practiceAssistanceEnabled = false;
    practiceAssistanceUsedThisQuestion = false;
  }

  function disablePracticeAssistance() {
    practiceAssistanceEnabled = false;
    practiceAssistanceUsedThisQuestion = false;
  }
  
  let cruzarCieloCompleted = false;
  let cruzarCieloCompletedAt = null;

  // DESAF√çO CRUZAR HSK3 COMPLETADO
  let cruzarHSK3Completed = false;
  let cruzarHSK3CompletedAt = null;

  // DESAF√çO CRUZAR HSK4 COMPLETADO
  let cruzarHSK4Completed = false;
  let cruzarHSK4CompletedAt = null;

  // DESAF√çO N1 COMPLETADO
  let desafioN1Completed = false;
  let desafioN1CompletedAt = null;
  
  // DESAF√çO N2 COMPLETADO
  let desafioN2Completed = false;
  let desafioN2CompletedAt = null;
  
  let streak = 0;
  let lastChallengeAt = null;
  let jwtToken = null;
  
  // Variables de control para activaci√≥n de m√∫sica (evitar listeners duplicados)
  let musicActivationAttempts = 0;
  let musicActivationListenerAdded = false;
  
  // Array separado para badges del hor√≥scopo (no se mezclan con cards)
  // IMPORTANTE: Usar window.horoscopeBadges para que sea accesible desde story.html
  window.horoscopeBadges = [];

  // === SISTEMA AVANZADO DE OPTIMIZACI√ìN DE IM√ÅGENES ===
  const imageCache = new Map();
  const preloadQueue = new Set();
  const imageLoadTimes = new Map();
  let isSlowConnection = false;
  let networkQuality = 'good';

  // Detectar calidad de conexi√≥n
  if ('connection' in navigator) {
    const conn = navigator.connection;
    isSlowConnection = conn.effectiveType === 'slow-2g' || 
                      conn.effectiveType === '2g' ||
                      conn.saveData;
    networkQuality = conn.effectiveType || 'unknown';
    console.log(`üåê Conexi√≥n: ${networkQuality}, SaveData: ${conn.saveData}`);
  }

  // Funci√≥n optimizada de carga con cache y fallbacks
  function preloadImage(src) {
    if (imageCache.has(src)) {
      return Promise.resolve(imageCache.get(src));
    }
    
    if (preloadQueue.has(src)) {
      return new Promise((resolve) => {
        const checkCache = () => {
          if (imageCache.has(src)) {
            resolve(imageCache.get(src));
          } else {
            setTimeout(checkCache, 10);
          }
        };
        checkCache();
      });
    }
    
    preloadQueue.add(src);
    const startTime = performance.now();
    
    return new Promise((resolve, reject) => {
      const img = new Image();
      
      // Optimizaciones de carga
      img.loading = 'eager';
      img.decoding = 'async';
      img.crossOrigin = 'anonymous';
      
      img.onload = () => {
        const loadTime = performance.now() - startTime;
        imageCache.set(src, img);
        imageLoadTimes.set(src, loadTime);
        preloadQueue.delete(src);
        
        console.log(`‚ö° ${src.split('/').pop()} cargado en ${loadTime.toFixed(2)}ms`);
        resolve(img);
      };
      
      img.onerror = () => {
        preloadQueue.delete(src);
        console.warn(`‚ùå Error: ${src}`);
        
        // Fallback autom√°tico WebP ‚Üí PNG
        if (src.includes('.webp')) {
          const pngSrc = src.replace('.webp', '.png');
          console.log(`üîÑ Fallback PNG: ${pngSrc}`);
          
          const fallbackImg = new Image();
          fallbackImg.onload = () => {
            imageCache.set(src, fallbackImg);
            resolve(fallbackImg);
          };
          fallbackImg.onerror = () => reject(new Error(`Fallback failed: ${src}`));
          fallbackImg.src = pngSrc;
        } else {
          reject(new Error(`Failed: ${src}`));
        }
      };
      
      img.src = src;
    });
  }

  // Preload inteligente por prioridades
  function preloadCriticalImages() {
    const images = [
      { src: 'img/master.webp', priority: 1 },
      { src: 'img/fuerte.png', priority: 1 },
      { src: 'img/rata1.webp', priority: 2 },
      { src: 'img/gallo1.webp', priority: 2 },
      { src: 'img/conejo1.webp', priority: 2 },
      { src: 'img/cerdo1.webp', priority: 3 },
      { src: 'img/perro1.webp', priority: 3 },
      { src: 'img/caballo1.webp', priority: 3 }
    ];
    
    const maxConcurrent = isSlowConnection ? 2 : 4;
    const delay = isSlowConnection ? 200 : 50;
    
    // Agrupar por prioridad
    const groups = {};
    images.forEach(img => {
      if (!groups[img.priority]) groups[img.priority] = [];
      groups[img.priority].push(img.src);
    });
    
    // Cargar por grupos de prioridad
    Object.keys(groups).sort().forEach((priority, groupIndex) => {
      setTimeout(() => {
        const group = groups[priority];
        for (let i = 0; i < group.length; i += maxConcurrent) {
          const batch = group.slice(i, i + maxConcurrent);
          batch.forEach((src, index) => {
            setTimeout(() => {
              preloadImage(src).catch(err => console.warn('Preload failed:', err));
            }, index * 25);
          });
        }
      }, groupIndex * delay);
    });
    
    console.log(`üñºÔ∏è Iniciando preload (${networkQuality})`);
  }

  // Preload secundario diferido
  function preloadSecondaryImages() {
    const secondaryImages = [
      'img/vaca1.webp',
      'img/cabra1.webp', 
      'img/serpiente1.webp',
      'img/mono1.webp',
      'img/tigre1.webp',
      'img/dragon1.webp'
    ];
    
    setTimeout(() => {
      secondaryImages.forEach((src, index) => {
        setTimeout(() => {
          preloadImage(src).catch(err => console.warn('Secondary preload failed:', err));
        }, index * (isSlowConnection ? 200 : 100));
      });
      console.log('üñºÔ∏è Preload secundario iniciado');
    }, isSlowConnection ? 5000 : 2000);
  }

  // Funci√≥n para usar cache en asignaciones de im√°genes
  function setImageFromCache(element, src, fallbackSrc = null) {
    if (!element) return Promise.reject(new Error('Element not found'));
    
    // Usar cache si est√° disponible
    if (imageCache.has(src)) {
      const cachedImg = imageCache.get(src);
      if (element.tagName === 'DIV') {
        element.style.backgroundImage = `url(${cachedImg.src})`;
      } else {
        element.src = cachedImg.src;
      }
      return Promise.resolve(cachedImg);
    }
    
    // Cargar con optimizaciones
    return preloadImage(src).then(img => {
      if (element.tagName === 'DIV') {
        element.style.backgroundImage = `url(${img.src})`;
      } else {
        element.src = img.src;
      }
      return img;
    }).catch(err => {
      if (fallbackSrc) {
        console.log(`üîÑ Using fallback for ${src}: ${fallbackSrc}`);
        return setImageFromCache(element, fallbackSrc);
      }
      throw err;
    });
  }

  // Gesti√≥n de memoria del cache
  function optimizeImageCache() {
    const maxSize = isSlowConnection ? 10 : 20;
    
    if (imageCache.size > maxSize) {
      const keep = ['img/master.webp', 'img/fuerte.png'];
      const newCache = new Map();
      
      keep.forEach(src => {
        if (imageCache.has(src)) {
          newCache.set(src, imageCache.get(src));
        }
      });
      
      // Mantener las 5 m√°s recientes
      Array.from(imageCache.keys()).slice(-5).forEach(src => {
        if (!newCache.has(src)) {
          newCache.set(src, imageCache.get(src));
        }
      });
      
      imageCache.clear();
      newCache.forEach((value, key) => imageCache.set(key, value));
      
      console.log(`üßπ Cache optimizado: ${newCache.size}/${maxSize}`);
    }
  }
  // ========== MODO DOCUMENTAL: Usuario hardcodeado ==========
  // Hardcodear username y token ficticio
  window.username = 'ManuShi';
  jwtToken = 'documental-local-token';
  localStorage.setItem('jwtToken', jwtToken);
  localStorage.setItem('username', window.username);
  console.log('üë§ Usuario hardcodeado: ManuShi (modo documental)');
  // ==========================================================

  // Sistema de pantalla de carga
  function showLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const gameArea = document.getElementById('gameArea');
    const progressBar = document.getElementById('loadingProgressBar');
    
    if (loadingScreen) {
      loadingScreen.style.display = 'flex';
      loadingScreen.classList.remove('fade-out');
      console.log('üîÑ Mostrando pantalla de carga');
    }
    
    if (gameArea) {
      gameArea.classList.add('hidden');
    }
    
    // Resetear barra de progreso
    if (progressBar) {
      progressBar.style.width = '0%';
    }
  }
  
  function updateLoadingProgress(percentage, message = null) {
    const progressBar = document.getElementById('loadingProgressBar');
    const subtitle = document.querySelector('.loading-subtitle');
    
    if (progressBar) {
      progressBar.style.width = percentage + '%';
    }
    
    if (message && subtitle) {
      subtitle.textContent = message;
    }
    
    console.log(`üìä Loading progress: ${percentage}% - ${message || 'Cargando...'}`);
  }
  
  function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    const gameArea = document.getElementById('gameArea');
    
    if (loadingScreen && gameArea) {
      console.log('‚úÖ Ocultando pantalla de carga y mostrando juego');
      loadingScreen.classList.add('fade-out');
      
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        gameArea.classList.remove('hidden');
        
        // üí° MOSTRAR TIP INICIAL CON FADE IN/OUT Y EXPANSI√ìN
        console.log('üí° DEBUG: Juego visible, mostrando tip inicial...');
        setTimeout(() => {
          let initialTipContainer = document.getElementById('initialTipContainer');
          
          // Fallback con querySelector si getElementById falla
          if (!initialTipContainer) {
            console.log('üí° DEBUG: Intentando querySelector como fallback...');
            initialTipContainer = document.querySelector('#initialTipContainer');
          }
          
          console.log('üí° DEBUG: initialTipContainer encontrado:', !!initialTipContainer);
          console.log('üí° DEBUG: gameArea visible:', !gameArea.classList.contains('hidden'));
          
          if (initialTipContainer) {
            console.log('üí° DEBUG: initialTipContainer existe, programando animaci√≥n...');
            
            // Expandir y mostrar (fade in)
            setTimeout(() => {
              initialTipContainer.style.maxHeight = '120px';
              initialTipContainer.style.opacity = '1';
              initialTipContainer.style.marginBottom = '8px';
              console.log('üí° Tip inicial expandido y mostrado');
            }, 500);
            
            // Contraer y ocultar (fade out) despu√©s de 14 segundos
            setTimeout(() => {
              initialTipContainer.style.maxHeight = '0';
              initialTipContainer.style.opacity = '0';
              initialTipContainer.style.marginBottom = '0';
              console.log('üí° Tip inicial colapsando');
            }, 14000);
            
            // Eliminar del DOM despu√©s de 15 segundos
            setTimeout(() => {
              initialTipContainer.remove();
              console.log('üí° Tip inicial eliminado del DOM');
            }, 15000);
          } else {
            console.error('‚ùå ERROR: No se encontr√≥ el elemento initialTipContainer');
            console.error('‚ùå DEBUG: HTML del gameArea:', gameArea ? gameArea.innerHTML.substring(0, 500) : 'gameArea no existe');
          }
        }, 1000);
        
        // üéµ REPRODUCIR M√öSICA DE BIENVENIDA - Solo una vez cuando todo est√° listo
        playWelcomeMusic();
      }, 500);
    }
  }
  
  // Variable de control global para m√∫sica
  let welcomeMusicAttempted = false;
  
  // Funci√≥n para reproducir m√∫sica de bienvenida
  function playWelcomeMusic() {
    // Solo intentar una vez
    if (welcomeMusicAttempted) {
      console.log('üö´ M√∫sica ya fue intentada anteriormente');
      return;
    }
    
    welcomeMusicAttempted = true;
    console.log('üéµ Intentando reproducir m√∫sica de bienvenida...');
    console.log('üìÇ Archivo: music/bonfiremusic.mp3');
    
  // Crear y configurar audio
  const audio = new Audio('music/bonfiremusic.mp3');
    audio.volume = 0.8; // Aumentar volumen para test
    audio.loop = false;
    
    // Guardar referencia global para poder detenerla despu√©s
    window.bonfireAudio = audio;
    audio.addEventListener('ended', () => {
      if (window.bonfireAudio === audio) {
        window.bonfireAudio = null;
      }
    });

    // Event listeners para debugging
    audio.addEventListener('loadstart', () => {
      console.log('üîÑ Audio: Iniciando carga del archivo');
    });
    
    audio.addEventListener('canplay', () => {
      console.log('‚úÖ Audio: Archivo cargado, listo para reproducir');
      console.log('üîä Volumen configurado a:', audio.volume);
    });
    
    audio.addEventListener('ended', () => {
      console.log('üèÅ Audio: Reproducci√≥n terminada');
    });
    
    audio.addEventListener('error', (e) => {
      console.log('üí• Error al cargar el archivo de audio:', e);
      console.log('üîç Detalles del error:', e.target.error);
    });
    
    // Intentar reproducir - solo UNA vez
    audio.play()
      .then(() => {
        console.log('‚úÖ M√∫sica de bienvenida reproducida exitosamente');
        console.log('üéº Duraci√≥n del audio:', audio.duration, 'segundos');
      })
      .catch((error) => {
        console.log('‚ùå Error al reproducir m√∫sica:', error.message);
        console.log('üîç Tipo de error:', error.name);
      });
  }

  // Funci√≥n para inicializar caracteres (Versi√≥n Documental - localStorage)
  async function initializeCharactersIfNeeded() {
    // Si no hay tarjetas o hay muy pocas, inicializar desde datasets del frontend
    if (!cards || cards.length < 10) {
      console.log('‚ö†Ô∏è localStorage vac√≠o o incompleto - inicializando desde datasets...');
      cards = initializeAllCharacters();
      
      // Guardar inmediatamente en localStorage
      await saveUserState();
      console.log('‚úÖ Tarjetas inicializadas y guardadas en localStorage');
    } else {
      console.log('‚úÖ Tarjetas ya cargadas desde localStorage:', cards.length);
    }
  }

  // Cargar estado del usuario desde localStorage (Modo Documental)
  async function loadUserState(token) {
    updateLoadingProgress(20, 'Cargando desde localStorage...');
    
    jwtToken = token;
    
    // CARGAR TODO DESDE LOCALSTORAGE
    const savedData = localStorage.getItem('macaFlashcards_userData');
    
    updateLoadingProgress(40, 'Procesando datos guardados...');
    
    if(savedData) {
      try {
        const data = JSON.parse(savedData);
        console.log('üíæ Datos cargados desde localStorage');
        
        updateLoadingProgress(60, 'Procesando tarjetas...');
        
        xpPoints = data.xp || 0;
        cards = data.knownChars || [];
        
        // üéØ APLICAR L√çMITE M√ÅXIMO DE NIVEL 100 a todos los caracteres cargados
        cards.forEach(card => {
          if (card.challengeStreak > 100) {
            card.challengeStreak = 100;
          }
        });
        console.log('üéØ L√≠mite de nivel 100 aplicado a los caracteres cargados');
        
        unlockedUnits = data.unlockedUnits || [];
        nivel2Unlocked = !!data.nivel2Unlocked;
        nivel3Unlocked = !!data.nivel3Unlocked;
        
        // HSK3/HSK4 DESBLOQUEADO
        hskUnlocked = !!data.hskUnlocked;
        console.log('üîë HSK3/HSK4 desbloqueado:', hskUnlocked);
        
        // MAESTRO DEL HOR√ìSCOPO - Ultimate Challenge
        horoscopeMaster = !!data.horoscopeMaster;
        horoscopeMasterAt = data.horoscopeMasterAt || null;
        ultimateChallengeCompletedCount = data.ultimateChallengeCompleted || 0;
        console.log('üèÜ Maestro del Hor√≥scopo cargado:', horoscopeMaster);
        console.log('üéØ Ultimate Challenge completado veces:', ultimateChallengeCompletedCount);
        
        // üîß INICIALIZAR ESTADO PARA EVITAR ANIMACIONES FALSAS AL ABRIR "MI COLECCI√ìN"
        initializeKnownState();
        console.log('üîß Estado inicial de colecci√≥n configurado');
        
        // DESAF√çOS COMPLETADOS
        desafioN3Completed = !!data.desafioN3Completed;
        emperatrizCompleted = !!data.emperatrizCompleted;
        bestias12Completed = !!data.bestias12Completed;
        cruzarMarCompleted = !!data.cruzarMarCompleted;
        cruzarCieloCompleted = !!data.cruzarCieloCompleted;
        cruzarHSK3Completed = !!data.cruzarHSK3Completed;
        cruzarHSK4Completed = !!data.cruzarHSK4Completed;
        desafioN1Completed = !!data.desafioN1Completed;
        desafioN2Completed = !!data.desafioN2Completed;
        
        // üèÖ Actualizar bot√≥n Niveles de Aprendizaje con medallas
        updateNivelesButtonText();
        
        streak = data.streak || 0;
        lastChallengeAt = data.lastChallengeAt || null;
        horoscopeAnimalsUnlocked = data.horoscopeAnimals || [];
        console.log('üéÜ Animales del hor√≥scopo cargados:', horoscopeAnimalsUnlocked);
        
        // üìñ Cargar progreso de historia
        window.storyProgress = data.storyProgress || {
          chapter1: false,
          chapter6: false,
          chapter7: false,
          chapter8: false,
          chapter9: false,
          chapter10: false,
          chapter11: false,
          chapter12: false
        };
        console.log('üìñ Progreso de historia cargado:', window.storyProgress);
      
      // üéñÔ∏è Inicializar window.horoscopeBadges desde horoscopeAnimalsUnlocked
      window.horoscopeBadges = [];
      const horoscopeAnimals = {
        'colores': { name: 'Èº† Rata (Colores)', hanzi: 'Èº†', pinyin: 'sh«î', spanish: 'rata', image: 'img/rata1.webp' },
        'hobbies': { name: 'Áâõ Buey (Hobbies)', hanzi: 'Áâõ', pinyin: 'ni√∫', spanish: 'buey', image: 'img/vaca1.webp' },
        'profesiones': { name: 'Ëôé Tigre (Profesiones)', hanzi: 'Ëôé', pinyin: 'h«î', spanish: 'tigre', image: 'img/tigre1.webp' },
        'verduras': { name: 'ÂÖî Conejo (Verduras)', hanzi: 'ÂÖî', pinyin: 't√π', spanish: 'conejo', image: 'img/conejo1.webp' },
        'emociones': { name: 'Èæô Drag√≥n (Emociones)', hanzi: 'Èæô', pinyin: 'l√≥ng', spanish: 'drag√≥n', image: 'img/dragon1.webp' },
        'casa': { name: 'Ëõá Serpiente (Casa)', hanzi: 'Ëõá', pinyin: 'sh√©', spanish: 'serpiente', image: 'img/serpiente1.webp' },
        'deportes': { name: 'È©¨ Caballo (Deportes)', hanzi: 'È©¨', pinyin: 'm«é', spanish: 'caballo', image: 'img/caballo1.webp' },
        'ropa': { name: 'Áæä Cabra (Ropa)', hanzi: 'Áæä', pinyin: 'y√°ng', spanish: 'cabra', image: 'img/cabra1.webp' },
        'cuerpo': { name: 'Áå¥ Mono (Cuerpo)', hanzi: 'Áå¥', pinyin: 'h√≥u', spanish: 'mono', image: 'img/mono1.webp' },
        'fruta': { name: 'È∏° Gallo (Fruta)', hanzi: 'È∏°', pinyin: 'jƒ´', spanish: 'gallo', image: 'img/gallo1.webp' },
        'animales': { name: 'Áãó Perro (Animales)', hanzi: 'Áãó', pinyin: 'g«íu', spanish: 'perro', image: 'img/perro1.webp' },
        'comidas': { name: 'Áå™ Cerdo (Comidas)', hanzi: 'Áå™', pinyin: 'zh≈´', spanish: 'cerdo', image: 'img/cerdo1.webp' }
      };
      
      horoscopeAnimalsUnlocked.forEach(categoria => {
        if (horoscopeAnimals[categoria]) {
          const animal = horoscopeAnimals[categoria];
          const badge = {
            id: `horoscope_${categoria}`,
            hanzi: animal.hanzi,
            pinyin: animal.pinyin,
            spanish: animal.spanish,
            unit: categoria,
            level: 100,
            isHoroscopeAnimal: true,
            animalImage: animal.image,
            animalCategory: categoria
          };
          window.horoscopeBadges.push(badge);
        }
      });
      console.log('üéñÔ∏è Badges del hor√≥scopo inicializados:', window.horoscopeBadges.length);
      
      // üê≤ Actualizaci√≥n del bot√≥n 12 Bestias INMEDIATAMENTE despu√©s de cargar datos
      setTimeout(() => {
        const btnBestias12Init = document.getElementById('btnBestias12');
        console.log('üê≤ INIT: Actualizando 12 Bestias');
        console.log('üê≤ INIT: btnBestias12Init:', btnBestias12Init);
        
        if (btnBestias12Init) {
          // ‚úÖ SIN REQUISITOS - Siempre desbloqueado
          btnBestias12Init.style.opacity = '1';
          btnBestias12Init.style.filter = 'none';
          const lockIcon = btnBestias12Init.querySelector('.lock-icon');
          if (lockIcon) lockIcon.remove();
          console.log('‚úÖ 12 Bestias siempre desbloqueado');
        } else {
          console.error('‚ùå INIT: btnBestias12 NO ENCONTRADO');
        }
        
        // üëë Actualizaci√≥n del bot√≥n La Emperatriz
        const btnEmperatrizInit = document.getElementById('btnLaEmperatriz');
        console.log('üëë INIT: Actualizando La Emperatriz');
        console.log('üëë INIT: btnEmperatrizInit:', btnEmperatrizInit);
        
        if (btnEmperatrizInit) {
          // ‚úÖ SIN REQUISITOS - Siempre desbloqueado
          btnEmperatrizInit.style.opacity = '1';
          btnEmperatrizInit.style.filter = 'none';
          const lockIcon = btnEmperatrizInit.querySelector('.lock-icon');
          if (lockIcon) lockIcon.remove();
          console.log('‚úÖ La Emperatriz siempre desbloqueada');
        } else {
          console.error('‚ùå INIT: btnLaEmperatriz NO ENCONTRADO');
        }
      }, 150);
      
      // Actualizar UI despu√©s de cargar datos
      setTimeout(() => {
        updateUltimateChallengeButton();
        updateHoroscopeMasterBadge();
        updateHistoryButtonProgress(); // Actualizar progreso de Historia
        updateHSKButtonsVisibility(); // Actualizar visibilidad de botones HSK
      }, 100);
      
      // üìñ SINCRONIZAR PROGRESO DE LA HISTORIA CON DESAF√çOS COMPLETADOS
      setTimeout(() => {
        syncStoryProgressWithChallenges();
      }, 500);
      
      // Mostrar Nivel 2 si est√° desbloqueado
      if(nivel2Unlocked) {
        console.log('üîì Nivel 2 ya estaba desbloqueado, mostrando bot√≥n...');
        setTimeout(() => {
          const nivel2Wrap = document.getElementById('nivel2Wrap');
          const btnNivel2 = document.getElementById('btnNivel2');
          const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
          if(nivel2Wrap) nivel2Wrap.style.display = '';
          if(btnNivel2) btnNivel2.style.display = '';
          if(nivel2ProgressWrap) nivel2ProgressWrap.style.display = 'flex';
          console.log('‚úÖ Nivel 2 mostrado en loadUserState');
        }, 100);
      }
      
      // üîß FIX: Si complet√≥ Cruzar el Cielo pero nivel3Unlocked es false, corregirlo
      if (cruzarCieloCompleted && !nivel3Unlocked) {
        console.log('üîß CORRECCI√ìN: cruzarCieloCompleted=true pero nivel3Unlocked=false. Desbloqueando Nivel 3...');
        nivel3Unlocked = true;
        saveUserState(); // Guardar la correcci√≥n
      }
      
      // Mostrar Nivel 3 si est√° desbloqueado
      if(nivel3Unlocked) {
        console.log('üîì Nivel 3 ya estaba desbloqueado, mostrando bot√≥n...');
        setTimeout(() => {
          const nivel3Wrap = document.getElementById('nivel3Wrap');
          const btnNivel3 = document.getElementById('btnNivel3');
          const nivel3ProgressWrap = document.getElementById('nivel3ProgressWrap');
          if(nivel3Wrap) nivel3Wrap.style.display = '';
          if(btnNivel3) btnNivel3.style.display = '';
          if(nivel3ProgressWrap) nivel3ProgressWrap.style.display = 'flex';
          console.log('‚úÖ Nivel 3 mostrado en loadUserState');
          
          // Actualizar estado de botones del hor√≥scopo
          setTimeout(() => {
            if (typeof updateHoroscopeButtonsState === 'function') {
              updateHoroscopeButtonsState();
            }
          }, 500);
        }, 100);
      } else {
        // Si nivel 3 no est√° desbloqueado, asegurar que los botones est√©n bloqueados
        setTimeout(() => {
          if (typeof updateHoroscopeButtonsState === 'function') {
            updateHoroscopeButtonsState();
          }
        }, 500);
      }
      
      // SIEMPRE ejecutar actualizaci√≥n de botones del hor√≥scopo
      setTimeout(() => {
        if (typeof updateHoroscopeButtonsState === 'function') {
          updateHoroscopeButtonsState();
        }
      }, 600);
      
      // Actualizar estado del bot√≥n Cruzar el Mar
      const btnCruzarMar = document.getElementById('btnCruzarMar');
      if(btnCruzarMar) {
        // ‚úÖ SIN REQUISITOS - Siempre desbloqueado
        btnCruzarMar.disabled = false;
        btnCruzarMar.style.opacity = '1';
        btnCruzarMar.style.cursor = 'pointer';
        btnCruzarMar.style.filter = 'none';
        
        const lockIcon = btnCruzarMar.querySelector('.lock-icon');
        if(lockIcon) lockIcon.remove();
        
        console.log('‚úÖ Cruzar el Mar siempre desbloqueado');
      }
      
      // Actualizar estado del bot√≥n Cruzar el Cielo
      const btnCruzarCielo = document.getElementById('btnCruzarCielo');
      console.log('üîç Verificando estado de Cruzar el Cielo...');
      console.log('üîç btnCruzarCielo:', btnCruzarCielo);
      
      if(btnCruzarCielo) {
        // ‚úÖ SIN REQUISITOS - Siempre desbloqueado
        btnCruzarCielo.disabled = false;
        btnCruzarCielo.style.opacity = '1';
        btnCruzarCielo.style.cursor = 'pointer';
        btnCruzarCielo.style.filter = 'none';
        
        const lockIcon = btnCruzarCielo.querySelector('.lock-icon');
        if(lockIcon) {
          lockIcon.remove();
          console.log('üóëÔ∏è Candado removido de Cruzar el Cielo');
        }
        
        console.log('‚úÖ Cruzar el Cielo siempre desbloqueado');
        
        // üîì ACTUALIZAR el bot√≥n "Los Hor√≥scopo"
        if (typeof window.updateLosHoroscopoButton === 'function') {
          console.log('üåü Llamando updateLosHoroscopoButton()');
          window.updateLosHoroscopoButton();
        }
      } else {
        console.warn('‚ö†Ô∏è btnCruzarCielo no encontrado');
      }
      
      // Actualizar estado del bot√≥n Cruzar HSK3 (TEMPORALMENTE DESBLOQUEADO PARA PRUEBAS)
      const btnCruzarHSK3 = document.getElementById('btnCruzarHSK3');
      console.log('üîç Verificando estado de Cruzar HSK3...');
      console.log('üîç btnCruzarHSK3:', btnCruzarHSK3);
      
      if(btnCruzarHSK3) {
        // TEMPORALMENTE SIEMPRE DESBLOQUEADO
        btnCruzarHSK3.disabled = false;
        btnCruzarHSK3.style.opacity = '1';
        btnCruzarHSK3.style.cursor = 'pointer';
        btnCruzarHSK3.style.filter = 'none';
        
        const lockIcon = btnCruzarHSK3.querySelector('.lock-icon');
        if(lockIcon) {
          lockIcon.remove();
        }
        console.log('‚úÖ Cruzar HSK3 DESBLOQUEADO TEMPORALMENTE PARA PRUEBAS');
      }
      
      // Actualizar estado del bot√≥n Cruzar HSK4 (TEMPORALMENTE DESBLOQUEADO PARA PRUEBAS)
      const btnCruzarHSK4 = document.getElementById('btnCruzarHSK4');
      console.log('üîç Verificando estado de Cruzar HSK4...');
      console.log('üîç btnCruzarHSK4:', btnCruzarHSK4);
      
      if(btnCruzarHSK4) {
        // TEMPORALMENTE SIEMPRE DESBLOQUEADO
        btnCruzarHSK4.disabled = false;
        btnCruzarHSK4.style.opacity = '1';
        btnCruzarHSK4.style.cursor = 'pointer';
        btnCruzarHSK4.style.filter = 'none';
        
        const lockIcon = btnCruzarHSK4.querySelector('.lock-icon');
        if(lockIcon) {
          lockIcon.remove();
        }
        console.log('‚úÖ Cruzar HSK4 DESBLOQUEADO TEMPORALMENTE PARA PRUEBAS');
      }
      
      } catch(error) {
        console.error('‚ùå Error cargando datos desde localStorage:', error);
        // Inicializar valores por defecto en caso de error
        xpPoints = 0;
        cards = [];
        unlockedUnits = [];
        nivel2Unlocked = false;
        nivel3Unlocked = false;
        streak = 0;
        lastChallengeAt = null;
        horoscopeAnimalsUnlocked = [];
      }
    } else {
      // Si no hay datos, inicializar como antes
      xpPoints = 0;
      cards = [];
      unlockedUnits = [];
      nivel2Unlocked = false;
      nivel3Unlocked = false;
      streak = 0;
      lastChallengeAt = null;
      horoscopeAnimalsUnlocked = [];
    }
    
    // Inicializar caracteres si es necesario
    updateLoadingProgress(80, 'Inicializando contenido...');
    await initializeCharactersIfNeeded();
    
    updateLoadingProgress(90, 'Finalizando carga...');
    
    // Actualizar estad√≠sticas
    setTimeout(() => {
      updateStats();
      updateLoadingProgress(100, '¬°Listo!');
      
      // Ocultar pantalla de carga despu√©s de completar
      setTimeout(() => {
        hideLoadingScreen();
      }, 800);
    }, 200);
  }

  // Guardar estado del usuario en backend
  // Completar Ultimate Challenge y convertirse en Maestro del Hor√≥scopo (Versi√≥n Documental)
  async function completeUltimateChallenge() {
    console.log('üéâ Completando Ultimate Challenge (Versi√≥n Documental - localStorage)');
    
    try {
      // Actualizar variables locales directamente
      const isFirstTime = !horoscopeMaster;
      horoscopeMaster = true;
      ultimateChallengeCompletedCount = (ultimateChallengeCompletedCount || 0) + 1;
      
      if (isFirstTime) {
        horoscopeMasterAt = new Date();
        console.log('üéä ¬°Primera vez completando Ultimate Challenge!');
      }
      
      console.log('üéâ NUEVO ESTADO (localStorage):', {
        horoscopeMaster,
        ultimateChallengeCompletedCount,
        horoscopeMasterAt,
        isFirstTime
      });
      
      // Guardar en localStorage
      await saveUserState();
      
      return {
        success: true,
        horoscopeMaster,
        ultimateChallengeCompleted: ultimateChallengeCompletedCount,
        horoscopeMasterAt,
        isFirstTime
      };
    } catch (error) {
      console.error('‚ùå Error en Ultimate Challenge (localStorage):', error);
      throw error;
    }
  }

  async function saveUserState() {
    // üìä DEBUG: Contador de requests para monitoreo
    if (!window.saveRequestCount) window.saveRequestCount = 0;
    window.saveRequestCount++;
    console.warn(`üö® DIRECT SAVE REQUEST #${window.saveRequestCount} - Esto deber√≠a pasar por SaveQueue!`);
    console.trace('Stack trace:'); // Ver desde d√≥nde se llama
    
    if(!jwtToken) {
      console.error('‚ùå saveUserState: No hay jwtToken');
      return;
    }
    
    // üì¶ DEBUG: Calcular tama√±o del payload
    const payload = {
      xp: xpPoints,
      knownChars: cards,
      unlockedUnits,
      nivel2Unlocked,
      nivel3Unlocked,
      // HSK DESBLOQUEADO
      hskUnlocked: hskUnlocked,
      streak,
      lastChallengeAt,
      horoscopeAnimals: horoscopeAnimalsUnlocked,
      // MAESTRO DEL HOR√ìSCOPO
      horoscopeMaster: horoscopeMaster,
      ultimateChallengeCompleted: ultimateChallengeCompletedCount,
      // DESAF√çO N3 COMPLETADO
      desafioN3Completed: desafioN3Completed,
      // DESAF√çO LA EMPERATRIZ COMPLETADO
      emperatrizCompleted: emperatrizCompleted,
      // DESAF√çO 12 BESTIAS COMPLETADO
      bestias12Completed: bestias12Completed,
      // DESAF√çO CRUZAR EL MAR COMPLETADO
      cruzarMarCompleted: cruzarMarCompleted,
      // DESAF√çO CRUZAR EL CIELO COMPLETADO
      cruzarCieloCompleted: cruzarCieloCompleted,
      // DESAF√çO N1 COMPLETADO
      desafioN1Completed: desafioN1Completed,
      // DESAF√çO N2 COMPLETADO
      desafioN2Completed: desafioN2Completed,
      // DESAF√çO CRUZAR HSK3 COMPLETADO
      cruzarHSK3Completed: cruzarHSK3Completed,
      // DESAF√çO CRUZAR HSK4 COMPLETADO
      cruzarHSK4Completed: cruzarHSK4Completed,
      // üìä ESTAD√çSTICAS DE ACIERTOS Y ERRORES
      correctAnswers: sessionCorrectAccumulated,
      wrongAnswers: sessionWrongAccumulated
    };
    
    const payloadSize = JSON.stringify(payload).length;
    console.log(`üì¶ Payload size: ${(payloadSize / 1024).toFixed(2)} KB (${cards.length} tarjetas)`);
    
    // GUARDAR EN LOCALSTORAGE (Modo Documental)
    try {
      localStorage.setItem('macaFlashcards_userData', JSON.stringify(payload));
      console.log('‚úÖ Progreso guardado en localStorage');
      console.log('üíæ Datos guardados: XP=' + xpPoints + ', Cards=' + cards.length);
      
      // Resetear acumuladores despu√©s de guardar exitosamente
      sessionCorrectAccumulated = 0;
      sessionWrongAccumulated = 0;
    } catch(error) {
      console.error('‚ùå Error guardando en localStorage:', error);
    }
  }

  /* ========================================
     üîÑ SISTEMA DE COLA DE GUARDADO (SaveQueue)
     ======================================== */
  
  const SaveQueue = (() => {
    const STORAGE_KEY = 'macaFlashcards_pendingOps';
    const MAX_OPS_BEFORE_FLUSH = 15; // L√≠mite de ops antes de flush autom√°tico
    let queue = [];
    let isFlushing = false;

    // Cargar cola desde localStorage al iniciar
    function loadQueue() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          queue = JSON.parse(stored);
          console.log(`üì¶ SaveQueue inicializado: ${queue.length} ops pendientes en localStorage`);
        }
      } catch (error) {
        console.error('‚ùå Error cargando cola desde localStorage:', error);
        queue = [];
      }
    }

    // Guardar cola en localStorage
    function saveQueue() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(queue));
      } catch (error) {
        console.error('‚ùå Error guardando cola en localStorage:', error);
      }
    }

    // Generar ID √∫nico para operaci√≥n
    function generateOpId() {
      return 'op-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    // Encolar una operaci√≥n
    function enqueue(type, payload = {}) {
      const op = {
        id: generateOpId(),
        type,
        payload,
        timestamp: Date.now()
      };

      queue.push(op);
      saveQueue();
      
      console.log(`‚ûï Op encolada [${type}]: ${op.id} (cola: ${queue.length} ops)`);
      updateSaveButton();

      // Si llegamos al l√≠mite, flush autom√°tico
      if (queue.length >= MAX_OPS_BEFORE_FLUSH) {
        console.log(`‚ö° L√≠mite de ${MAX_OPS_BEFORE_FLUSH} ops alcanzado, flush autom√°tico`);
        flush();
      }

      return op.id;
    }

    // Enviar cola al servidor
    async function flush() {
      if (isFlushing) {
        console.log('‚è∏Ô∏è Flush ya en progreso, saltando');
        return;
      }

      if (queue.length === 0) {
        console.log('‚úÖ Cola vac√≠a, nada que guardar');
        updateSaveButton('success-instant');
        return;
      }

      if (!jwtToken) {
        console.warn('‚ö†Ô∏è No hay jwtToken, no se puede guardar');
        updateSaveButton('error');
        return;
      }

      isFlushing = true;
      updateSaveButton('flushing');

      const opsToSend = [...queue]; // Copiar cola
      console.log(`üöÄ Flush iniciado: ${opsToSend.length} ops`);

      // üìä DEBUG: Contador de flushes
      if (!window.flushCount) window.flushCount = 0;
      window.flushCount++;
      console.log(`‚úÖ FLUSH #${window.flushCount} - Enviando cola completa`);

      try {
        // Llamar a saveUserState() que env√≠a todo el estado actual
        await saveUserState();
        
        // Si el guardado fue exitoso, limpiar cola
        queue = [];
        saveQueue();
        localStorage.removeItem(STORAGE_KEY); // Limpiar localStorage
        
        console.log(`‚úÖ Flush completado exitosamente`);
        updateSaveButton('success');
        
      } catch (error) {
        console.error('‚ùå Error en flush:', error);
        updateSaveButton('error');
      } finally {
        isFlushing = false;
      }
    }

    // Actualizar estado del bot√≥n "Guardar"
    function updateSaveButton(state) {
      const btn = document.getElementById('btnSaveProgress');
      const textSpan = document.getElementById('btnSaveText');
      const spinner = document.getElementById('btnSaveSpinner');
      
      if (!btn || !textSpan) return;

      const queueSize = queue.length;

      if (state === 'flushing') {
        // Guardando: mostrar solo spinner
        textSpan.classList.add('hidden');
        if (spinner) spinner.classList.remove('hidden');
        btn.disabled = true;
        btn.style.backgroundColor = '#ffc853'; // Amarillo
        btn.style.cursor = 'not-allowed';
        
      } else if (state === 'success' || state === 'success-instant') {
        // √âxito: mostrar "√âxito" por 3s
        textSpan.textContent = '√âxito';
        textSpan.classList.remove('hidden');
        if (spinner) spinner.classList.add('hidden');
        btn.disabled = true;
        btn.style.backgroundColor = '#ffc853'; // Amarillo (no cambia color)
        btn.style.cursor = 'default';
        
        // Volver a estado default despu√©s de 3s
        setTimeout(() => {
          updateSaveButton('default');
        }, 3000);
        
      } else if (state === 'error') {
        // Error: mostrar "Error" en rojo, sticky
        textSpan.textContent = 'Error';
        textSpan.classList.remove('hidden');
        if (spinner) spinner.classList.add('hidden');
        btn.disabled = false;
        btn.style.backgroundColor = '#dc2626'; // Rojo
        btn.style.cursor = 'pointer';
        
      } else {
        // Default: mostrar "Guardar" o "‚úÖ Guardar"
        if (queueSize > 0) {
          textSpan.textContent = 'Guardar';
        } else {
          textSpan.textContent = '‚úÖ Guardar';
        }
        textSpan.classList.remove('hidden');
        if (spinner) spinner.classList.add('hidden');
        btn.disabled = false;
        btn.style.backgroundColor = '#ffc853'; // Amarillo
        btn.style.cursor = 'pointer';
      }
    }

    // Obtener tama√±o de cola
    function getQueueSize() {
      return queue.length;
    }

    // Limpiar cola (para cuando se carga estado del servidor)
    function clearQueue() {
      queue = [];
      saveQueue();
      localStorage.removeItem(STORAGE_KEY);
      console.log('üßπ Cola limpiada');
      updateSaveButton('default');
    }

    // üìä DEBUG: Funci√≥n para mostrar estad√≠sticas
    function showStats() {
      const directRequests = window.saveRequestCount || 0;
      const flushRequests = window.flushCount || 0;
      const queuedOps = queue.length;
      
      console.log('\nüìä ===== ESTAD√çSTICAS DE GUARDADO =====');
      console.log(`üö® Requests DIRECTOS (sin cola): ${directRequests}`);
      console.log(`‚úÖ Requests por FLUSH (con cola): ${flushRequests}`);
      console.log(`üì¶ Operaciones en cola: ${queuedOps}`);
      console.log(`üìà Ratio: ${directRequests}/${flushRequests} = ${flushRequests > 0 ? (directRequests / flushRequests).toFixed(2) : 'N/A'} directs por flush`);
      console.log(`üí° IDEAL: 0 directos, solo flushes en checkpoints`);
      console.log('=====================================\n');
      
      return { directRequests, flushRequests, queuedOps };
    }

    // Inicializar
    loadQueue();

    return {
      enqueue,
      flush,
      getQueueSize,
      clearQueue,
      showStats,
      updateButton: updateSaveButton
    };
  })();

  // Reemplazar funciones locales
  function saveXP() { SaveQueue.enqueue(); }
  function loadXP() { /* XP se carga con loadUserState */ }
  function xpForLevel(level) {
    // Level 1: 10, Level 2: 50, Level 3: 100, Level 4: 200, Level 5: 300, etc.
    if(level === 1) return 10;
    if(level === 2) return 50;
    if(level === 3) return 100;
    return (level - 1) * 100;
  }
  function getCurrentLevel(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    return lvl;
  }
  function getLevelProgress(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    // xpNeeded: lo que requiere este nivel
    // total: xp acumulado hasta el nivel anterior
    return {
      lvl,
      prev: total,
      next: total + xpNeeded,
      progress: xp - total,
      needed: (total + xpNeeded) - xp,
      percent: Math.max(0, Math.min(100, ((xp - total) / xpNeeded) * 100))
    };
  }
  // Colores por nivel
  const xpColors = [
    // Celeste claro ‚Üí verde claro ‚Üí naranja
    {bar:'#7dd3fc', text:'#7dd3fc', bg:'#bae6fd', glow:'#e0f2fe'}, // 1 celeste claro
    {bar:'#38bdf8', text:'#38bdf8', bg:'#a5f3fc', glow:'#bae6fd'}, // 2 celeste
    {bar:'#5eead4', text:'#5eead4', bg:'#a7f3d0', glow:'#d1fae5'}, // 3 verde agua
    {bar:'#34d399', text:'#34d399', bg:'#bbf7d0', glow:'#d1fae5'}, // 4 verde claro
    {bar:'#fbbf24', text:'#fbbf24', bg:'#fef9c3', glow:'#fde68a'}, // 5 amarillo-naranja
    {bar:'#fb923c', text:'#fb923c', bg:'#fed7aa', glow:'#fdba74'}, // 6 naranja claro
    {bar:'#f97316', text:'#f97316', bg:'#fdba74', glow:'#fb923c'}, // 7 naranja
    {bar:'#ea580c', text:'#ea580c', bg:'#fb923c', glow:'#f97316'}, // 8 naranja intenso
  ];
  let lastLevel = null;
  function renderXPBar(levelUpAnim=false) {
    const { lvl, needed, percent } = getLevelProgress(xpPoints);
    const oldPercent = parseInt(document.getElementById('xpBar').style.width) || 0;
    
    document.getElementById('xpLevel').textContent = lvl;
    document.getElementById('xpBar').style.width = percent+"%";
    document.getElementById('xpToNext').textContent = `Faltan ${needed} xp para subir Ê∞¥Âπ≥`;
    
    // Colores por nivel
    const color = xpColors[(lvl-1)%xpColors.length];
    const xpBar = document.getElementById('xpBar');
    const xpBarWrap = document.getElementById('xpBarWrap');
    const xpLevel = document.getElementById('xpLevel');
    const xpToNext = document.getElementById('xpToNext');
    
    // Aplicar color din√°mico a la barra pixel art
    xpBar.style.setProperty('--xp-bar-color', color.bar);
    
    const container = xpBarWrap.querySelector('.xp-bar-container');
    if (container) {
      container.style.borderColor = color.bar;
    }
    xpLevel.style.color = color.text;
    xpToNext.style.color = color.text;
    const xpLabel = document.getElementById('xpLabel');
    if(xpLabel) xpLabel.style.color = color.text;
    const btnResetXP = document.getElementById('btnResetXP');
    if(btnResetXP) {
      btnResetXP.style.background = '#1e293b'; // azul oscuro
      btnResetXP.style.color = '#fff';
      btnResetXP.style.borderColor = '#1e293b';
    }
    // Set CSS vars for glow
    xpBar.style.setProperty('--xp-bar', color.bar);
    xpBar.style.setProperty('--xp-glow', color.glow);
    xpBarWrap.style.setProperty('--xp-glow', color.glow);
    
    // Animaci√≥n de brillo al subir de nivel y sonido de triunfo
    if(levelUpAnim) {
      xpBar.classList.add('xp-gain');
      soundLevelUpTrumpet();
      
      // IMPORTANTE: No bloquear la funcionalidad durante level up
      setTimeout(()=>{
        xpBar.classList.remove('xp-gain');
      }, 800);
    } 
    // Animaci√≥n de ganancia de XP cuando hay avance pero NO level up
    else if (percent > oldPercent) {
      xpBar.classList.add('xp-gain');
      setTimeout(()=>{
        xpBar.classList.remove('xp-gain');
      }, 800);
      createXPParticles(color.bar);
    }
    
    lastLevel = lvl;
  }

  // Funci√≥n para crear part√≠culas de XP - BURST DIRECCIONAL
  function createXPParticles(color) {
    const xpBar = document.getElementById('xpBar');
    if (!xpBar) return;
    
    // Desactivar part√≠culas durante modos Emperatriz y Bestias para mejor rendimiento
    if (currentMission === 'emperatriz' || currentMission === 'bestias12') {
      console.log('üö´ Part√≠culas XP desactivadas durante modo:', currentMission);
      return;
    }
    
    const particleCount = 8; // M√°s part√≠culas para mejor efecto burst
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = 'xp-particle-burst';
      particle.style.background = color;
      
      // Posici√≥n inicial: extremo derecho de la barra
      particle.style.left = '100%';
      particle.style.top = '50%';
      particle.style.marginLeft = '-2px';
      particle.style.marginTop = '-2px';
      
      // BURST DIRECCIONAL: Cono hacia arriba-derecha (momentum del progreso)
      const burstAngle = -45 + (Math.random() * 90 - 45); // -90¬∞ a 0¬∞ (cono hacia arriba-derecha)
      const velocity = 30 + Math.random() * 40; // Velocidad aleatoria 30-70px
      const angleRad = burstAngle * Math.PI / 180;
      
      // Calcular trayectoria en el cono direccional
      const finalX = Math.cos(angleRad) * velocity;
      const finalY = Math.sin(angleRad) * velocity;
      
      // Variaci√≥n adicional para naturalidad
      const scatter = 15;
      const scatterX = (Math.random() - 0.5) * scatter;
      const scatterY = (Math.random() - 0.5) * scatter;
      
      particle.style.setProperty('--burst-x', (finalX + scatterX) + 'px');
      particle.style.setProperty('--burst-y', (finalY + scatterY) + 'px');
      
      // Rotaci√≥n aleatoria para efecto din√°mico
      const rotation = Math.random() * 360;
      particle.style.setProperty('--burst-rotation', rotation + 'deg');
      
      // Scale aleatorio para variedad visual
      const scale = 0.8 + Math.random() * 0.6; // 0.8 a 1.4
      particle.style.setProperty('--burst-scale', scale);
      
      // Delay escalonado para efecto de r√°faga
      particle.style.animationDelay = (i * 20) + 'ms';
      particle.style.animation = 'xpBurstFloat 600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
      
      xpBar.appendChild(particle);
      
      // Remover part√≠cula despu√©s de la animaci√≥n
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 800);
    }
  }
  // CSS para animaci√≥n de brillo
  const xpGlowStyle = document.createElement('style');
  xpGlowStyle.textContent = `
    @keyframes softGlow {
    0%   { opacity: 1;   transform: scale(1);   }
    40%  { opacity: 0.94; transform: scale(1.03); }
    100% { opacity: 1;   transform: scale(1);   }
  }

  /* Si quer√©s conservar una SOMBRA SUAVE, dejala fija (no animada) en el elemento XP */
  .xp-halo-static {
    /* ajust√° color con --xp-glow o --xp-bar si ya las us√°s */
    box-shadow: 0 0 14px 4px var(--xp-glow, rgba(255,255,255,.5)),
                0 0 0 2px var(--xp-bar, rgba(255,255,255,.6));
  }

  /* Reemplazo de .xp-glow-anim (antes animaba box-shadow) */
  .xp-glow-anim {
    animation: softGlow 1.1s cubic-bezier(.4,2,.6,1) 1;
    will-change: transform, opacity; /* hint al compositor */
  }

  /* Reemplazo de .xp-glow-anim-bg (antes animaba filter/brightness) */
  .xp-glow-anim-bg {
    animation: softGlow 1.1s cubic-bezier(.4,2,.6,1) 1;
    will-change: transform, opacity;
  }

    /* Animaci√≥n de part√≠culas XP */
    .xp-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #0ea5e9;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
    }
    @keyframes xpParticleFloat {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(var(--particle-x, 20px), var(--particle-y, -20px)) scale(1.2);
        opacity: 0.8;
      }
      100% {
        transform: translate(var(--particle-x2, 40px), var(--particle-y2, -40px)) scale(0);
        opacity: 0;
      }
    }

    /* ========== BURST DIRECCIONAL - Nuevas part√≠culas ========== */
    .xp-particle-burst {
      position: absolute;
      width: 5px;
      height: 5px;
      background: #0ea5e9;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      box-shadow: 0 0 3px rgba(255,255,255,0.5);
    }

    @keyframes xpBurstFloat {
      0% {
        transform: translate(0, 0) scale(var(--burst-scale, 1)) rotate(0deg);
        opacity: 1;
        filter: brightness(1.5);
      }
      20% {
        transform: translate(calc(var(--burst-x, 30px) * 0.3), calc(var(--burst-y, -30px) * 0.3)) 
                  scale(calc(var(--burst-scale, 1) * 1.2)) 
                  rotate(calc(var(--burst-rotation, 90deg) * 0.3));
        opacity: 1;
        filter: brightness(1.8);
      }
      70% {
        transform: translate(calc(var(--burst-x, 30px) * 0.9), calc(var(--burst-y, -30px) * 0.9)) 
                  scale(calc(var(--burst-scale, 1) * 0.8)) 
                  rotate(calc(var(--burst-rotation, 90deg) * 0.8));
        opacity: 0.6;
        filter: brightness(1.2);
      }
      100% {
        transform: translate(var(--burst-x, 30px), var(--burst-y, -30px)) 
                  scale(0) 
                  rotate(var(--burst-rotation, 90deg));
        opacity: 0;
        filter: brightness(1);
      }
    }

    /* Animaci√≥n para botones que aparecen en m√≥vil */
    @keyframes mobileButtonFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .mobile-fade-in {
      animation: mobileButtonFadeIn 300ms ease-out forwards;
    }

    @keyframes mobileButtonFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }

    .mobile-fade-out {
      animation: mobileButtonFadeOut 400ms ease-in forwards;
    }
    
    /* CSS para fade-out selectivo */
    @keyframes fadeOutButtons {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.95); }
    }
    
    .quiz-fade-out {
      animation: fadeOutButtons 300ms ease-out forwards;
    }
    
    .quiz-fade-out-delayed {
      animation: fadeOutButtons 300ms ease-out forwards;
      animation-delay: 200ms;
    }
    
    /* Botones invisibles desde el inicio */
    .quiz-invisible {
      opacity: 0 !important;
      pointer-events: none;
    }

    /* Animaci√≥n para el bot√≥n parlante */
    @keyframes speakerGlow {
      0% { 
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 20px 4px rgba(34, 197, 94, 0.8), 0 0 40px 8px rgba(34, 197, 94, 0.4);
        transform: scale(1.1);
      }
      100% { 
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        transform: scale(1);
      }
    }
    
    .speaker-glow-active {
      animation: speakerGlow 600ms ease-out;
    }
    
    /* Pulso suave mientras reproduce */
    @keyframes speakerPulse {
      0%, 100% { 
        box-shadow: 0 0 15px 3px rgba(34, 197, 94, 0.6);
        transform: scale(1.05);
      }
      50% { 
        box-shadow: 0 0 25px 6px rgba(34, 197, 94, 0.9);
        transform: scale(1.08);
      }
    }

    /* Animaciones optimizadas para tarjetas m√≠ticas - Solo 2 ciclos */
    @keyframes legendaryWave {
      0% { 
        background-position: 0% 50%; 
      }
      50% { 
        background-position: 100% 50%; 
      }
      100% { 
        background-position: 0% 50%; 
      }
    }

    @keyframes legendaryPulse {
      0% {
        box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5), 0 0 0 0 rgba(255, 215, 0, 0.4);
        transform: scale(1);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), 0 0 20px 5px rgba(255, 215, 0, 0.2);
        transform: scale(1.02);
      }
    }

    @keyframes pulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.05);
        opacity: 0.8;
      }
    }

    @keyframes neonPulse {
      0% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ff88, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.5),
          0 0 20px rgba(0, 255, 65, 0.4),
          0 0 40px rgba(0, 255, 65, 0.2);
        border-color: #00cc33;
      }
      50% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ffaa, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.8),
          0 0 30px rgba(0, 255, 65, 0.7),
          0 0 60px rgba(0, 255, 65, 0.4),
          0 0 80px rgba(57, 255, 20, 0.3);
        border-color: #00ff55;
        transform: scale(1.02);
      }
      100% {
        box-shadow: 
          8px 8px 0px #000, 
          inset 0 0 0 2px #00ff88, 
          inset 4px 4px 8px rgba(0, 255, 65, 0.5),
          0 0 20px rgba(0, 255, 65, 0.4),
          0 0 40px rgba(0, 255, 65, 0.2);
        border-color: #00cc33;
      }
    }
    
    .speaker-playing {
      animation: speakerPulse 1.2s ease-in-out infinite;
    }

    /* ===== TRADING CARDS STYLES ===== */
    .trading-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
      cursor: pointer;
      font-family: 'Jersey 10', monospace;
      overflow: hidden;
    }

    .trading-card:hover {
      transform: rotateX(5deg) rotateY(5deg) scale(1.05);
      z-index: 10;
    }

    /* Rareza Com√∫n (Streak 0-2) */
    .card-common {
      background: linear-gradient(135deg, #f3f4f6, #d1d5db);
      border: 2px solid #9ca3af;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .card-common:hover {
      box-shadow: 0 8px 25px rgba(156, 163, 175, 0.4);
    }

    /* Rareza Poco Com√∫n (Streak 3-5) */
    .card-uncommon {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      border: 2px solid #22c55e;
      box-shadow: 0 4px 8px rgba(34, 197, 94, 0.2);
    }

    .card-uncommon:hover {
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.5);
    }

    /* Rareza Rara (Streak 6-10) */
    .card-rare {
      background: linear-gradient(135deg, #dbeafe, #93c5fd);
      border: 2px solid #3b82f6;
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
      /* animation: rareShimmer 3s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .card-rare:hover {
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.6);
    }

    /* Rareza √âpica (Streak 11-20) */
    .card-epic {
      background: linear-gradient(135deg, #f3e8ff, #c4b5fd);
      border: 2px solid #8b5cf6;
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4);
      /* animation: epicGlow 2s ease-in-out infinite alternate; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .card-epic:hover {
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.7);
    }

    /* Rareza Legendaria (Streak 21+) */
    .card-legendary {
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b);
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      /* animation: legendaryPulse 3.5s ease-in-out infinite alternate; - REMOVIDA PARA MEJOR RENDIMIENTO */
      position: relative;
    }

    .card-legendary:hover {
      box-shadow: 0 12px 35px rgba(217, 119, 6, 0.8);
    }

    .card-legendary::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      /* animation: legendaryBorder 5s ease infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    /* Contenido de la carta */
    .card-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 8px;
      position: relative;
      z-index: 2;
    }

    .card-hanzi {
      font-size: clamp(28px, 5vw, 48px);
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
      margin-bottom: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .card-legendary .card-hanzi {
      color: white;
      text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
    }

    /* Badge de streak mejorado */
    .card-streak-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      min-width: 24px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      color: white;
      z-index: 3;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .card-common .card-streak-badge {
      background: #6b7280;
    }

    .card-uncommon .card-streak-badge {
      background: #16a34a;
    }

    .card-rare .card-streak-badge {
      background: #2563eb;
    }

    .card-epic .card-streak-badge {
      background: #7c3aed;
    }

    .card-legendary .card-streak-badge {
      background: linear-gradient(45deg, #dc2626, #ea580c);
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    }

    /* Badge de categor√≠a mejorado */
    .card-category-badge {
      position: absolute;
      bottom: 6px;
      left: 6px;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: bold;
      z-index: 3;
      backdrop-filter: blur(8px);
    }

    .card-common .card-category-badge {
      background: rgba(107, 114, 128, 0.8);
      color: white;
    }

    .card-uncommon .card-category-badge {
      background: rgba(22, 163, 74, 0.8);
      color: white;
    }

    .card-rare .card-category-badge {
      background: rgba(37, 99, 235, 0.8);
      color: white;
    }

    .card-epic .card-category-badge {
      background: rgba(124, 58, 237, 0.8);
      color: white;
    }

    .card-legendary .card-category-badge {
      background: rgba(220, 38, 38, 0.9);
      color: #fef3c7;
    }

    /* Animaciones */
    @keyframes rareShimmer {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes epicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      }
      100% {
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
    }

    @keyframes legendaryPulse {
      0% {
        box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5), 0 0 0 0 rgba(255, 215, 0, 0.4);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), 0 0 20px 5px rgba(255, 215, 0, 0.2);
      }
    }

    @keyframes legendaryBorder {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Efecto de nueva carta */
    @keyframes newCardAppear {
      0% {
        transform: scale(0) rotateY(180deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) rotateY(90deg);
        opacity: 0.8;
      }
      100% {
        transform: scale(1) rotateY(0deg);
        opacity: 1;
      }
    }

    .new-card {
      animation: newCardAppear 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ===== MYTHIC HOROSCOPE CARDS - Estilo Legendario ===== */
    .card-mythic-animal {
      position: relative;
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b, #d97706, #fbbf24, #fef3c7);
      background-size: 300% 300%;
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      animation: legendaryPulse 3.5s ease-in-out 2 alternate;
      overflow: hidden;
    }

    .card-mythic-animal::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      animation: legendaryWave 4s ease-in-out 2;
    }

    .card-mythic-animal::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
      transform: translate(-50%, -50%);
      /* animation: mythicPulse 2s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
      pointer-events: none;
    }

    .card-mythic-animal:hover {
      box-shadow: 0 12px 35px rgba(217, 119, 6, 0.8);
    }

    /* Master Card - Ultra Legendaria */
    .card-ultra-master {
      position: relative;
      background: linear-gradient(45deg, #ffd700, #fbbf24, #84cc16, #22c55e);
      border: 1px solid #ffd700;
      background-clip: padding-box;
      overflow: hidden;
    }

    .card-ultra-master:hover {
      transform: rotateX(15deg) rotateY(15deg) scale(1.12);
      z-index: 30;
      box-shadow: 0 25px 50px rgba(34, 197, 94, 0.8), 0 0 60px rgba(132, 204, 22, 0.5);
    }

    /* Badges m√≠ticos */
    .mythic-streak-badge {
      background: linear-gradient(45deg, #dc2626, #ea580c);
      color: #fff;
      box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .master-streak-badge {
      background: linear-gradient(45deg, #ffd700, #ff6b35);
      color: #000;
      box-shadow: 0 3px 10px rgba(255, 215, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      font-weight: 900;
    }

    .mythic-category-badge {
      background: rgba(217, 119, 6, 0.9) !important;
      color: #fef3c7 !important;
      border: 1px solid rgba(255, 215, 0, 0.8);
      box-shadow: 0 2px 4px rgba(217, 119, 6, 0.3);
    }

    .master-category-badge {
      background: rgba(255, 215, 0, 0.95) !important;
      color: #8B4513 !important;
      border: 1px solid rgba(255, 107, 53, 0.8);
      box-shadow: 0 2px 6px rgba(255, 215, 0, 0.4);
      font-weight: bold;
    }

    /* Animaciones m√≠ticas */
    @keyframes mythicFlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes mythicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(217, 119, 6, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), inset 0 1px 0 rgba(255, 215, 0, 0.5);
      }
    }

    @keyframes mythicBorder {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes mythicPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.3; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.1; }
    }

    @keyframes masterFlow {
      0%, 100% { background-position: 0% 50%; }
      33% { background-position: 100% 0%; }
      66% { background-position: 0% 100%; }
    }

    @keyframes masterRadiance {
      0% {
        box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 107, 53, 0.3);
      }
      100% {
        box-shadow: 0 12px 35px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 107, 53, 0.6);
      }
    }

    @keyframes masterBorder {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    /* Estilos para modales de hor√≥scopo din√°micos - Exactamente como badges legendarios */
    .horoscope-modal-image {
      position: relative;
      display: inline-block;
      background: linear-gradient(-45deg, #fff9e0, #fcc842, #faac25, #e08f31, #ffc940, #fff9e0);
      background-size: 500% 500%;
      border: 3px solid #d97706;
      box-shadow: 0 6px 16px rgba(217, 119, 6, 0.5);
      /* animation: legendaryPulse 3.5s ease-in-out infinite alternate, legendaryWave 7s ease-in-out infinite; - REMOVIDA */
      border-radius: 9px;
      overflow: hidden;
    }

    .horoscope-modal-image::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ff6b35, #ffd700, #ff6b35);
      background-size: 400% 400%;
      border-radius: 14px;
      z-index: -1;
      /* animation: legendaryBorder 5s ease infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    .horoscope-modal-image img {
      display: block;
      border-radius: 9px;
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .horoscope-modal-container {
      background: linear-gradient(135deg, #fef3c7, #fbbf24, #f59e0b, #d97706);
      background-size: 400% 400%;
      /* animation: legendaryFlow 6s ease-in-out infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
      border: 4px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .horoscope-modal-container::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffd700, #f59e0b, #d97706, #92400e, #ffd700);
      background-size: 300% 300%;
      border-radius: 24px;
      z-index: -1;
      /* animation: legendaryBorder 4s linear infinite; - REMOVIDA PARA MEJOR RENDIMIENTO */
    }

    @keyframes mythicFlow {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes mythicGlow {
      0% {
        box-shadow: 0 4px 8px rgba(217, 119, 6, 0.4), inset 0 1px 0 rgba(255, 215, 0, 0.2);
      }
      100% {
        box-shadow: 0 8px 25px rgba(217, 119, 6, 0.7), inset 0 1px 0 rgba(255, 215, 0, 0.5);
      }
    }

    @keyframes legendaryBorder {
      0% { background-position: 0% 50%; }
      25% { background-position: 100% 0%; }
      50% { background-position: 100% 100%; }
      75% { background-position: 0% 100%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes legendaryWave {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes sparkle {
      0%, 100% { transform: rotate(0deg) scale(1); opacity: 1; }
      50% { transform: rotate(180deg) scale(1.2); opacity: 0.7; }
    }
  `;
  document.head.appendChild(xpGlowStyle);
  const STORAGE_KEY = 'srs_unidades_v7_es';

  // Eliminada declaraci√≥n duplicada de cards
  let sessionQueue = [];
  let currentCard = null;
  let flipped = false;
  let todayReviewed = 0;
  let currentMission = ''; // 'unit2'..'unit9'|'known'|'revise1'|'revise2'|'challenge'
  window.horoscopeAnimalsUnlocked = []; // Array de categor√≠as desbloqueadas: ['colores', 'fruta', etc.] - GLOBAL para acceso desde story.html

  // Variables para el Desaf√≠o Final
  let ultimateChallengeActive = false;
  let ultimateChallengeCards = [];

  /* ========= FUNCIONES DE PROGRESO DE NIVELES ========= */
  function getNivel1Progress() {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    const nivel1Units = ['unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9'];
    const totalCards = cards.filter(card => nivel1Units.some(u => card.unit.split('|').includes(u)));
    const knownCards = totalCards.filter(card => card.known);
    
    return { known: knownCards.length, total: totalCards.length };
  }

  function getNivel2Progress() {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const totalCards = cards.filter(card => nivel2Units.some(u => card.unit.split('|').includes(u)));
    const knownCards = totalCards.filter(card => card.known);
    
    return { known: knownCards.length, total: totalCards.length };
  }

  function getNivel3Progress() {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const totalCards = cards.filter(card => nivel3Units.some(u => card.unit.split('|').includes(u)));
    const knownCards = totalCards.filter(card => card.known);
    
    return { known: knownCards.length, total: totalCards.length };
  }

  function getNivelHSK3Progress() {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    const HSK3Units = ['HSK3unit1', 'HSK3unit2', 'HSK3unit3', 'HSK3unit4', 'HSK3unit5', 'HSK3unit6', 'HSK3unit7', 'HSK3unit8', 'HSK3unit9', 'HSK3unit10', 'HSK3unit11', 'HSK3unit12', 'HSK3unit13', 'HSK3unit14', 'HSK3unit15', 'HSK3unit16', 'HSK3unit17', 'HSK3unit18', 'HSK3unit19', 'HSK3unit20'];
    const totalCards = cards.filter(card => HSK3Units.some(u => card.unit.split('|').includes(u)));
    const knownCards = totalCards.filter(card => card.known);
    
    return { known: knownCards.length, total: totalCards.length };
  }

  function getNivelHSK4Progress() {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    const HSK4Units = ['HSK4unit1', 'HSK4unit2', 'HSK4unit3', 'HSK4unit4', 'HSK4unit5', 'HSK4unit6', 'HSK4unit7', 'HSK4unit8', 'HSK4unit9', 'HSK4unit10', 'HSK4unit11', 'HSK4unit12', 'HSK4unit13', 'HSK4unit14', 'HSK4unit15', 'HSK4unit16', 'HSK4unit17', 'HSK4unit18', 'HSK4unit19', 'HSK4unit20'];
    const totalCards = cards.filter(card => HSK4Units.some(u => card.unit.split('|').includes(u)));
    const knownCards = totalCards.filter(card => card.known);
    
    return { known: knownCards.length, total: totalCards.length };
  }

  function updateNivelesProgressBars() {
    // Actualizar Nivel 1
    const nivel1Progress = getNivel1Progress();
    const nivel1Percentage = nivel1Progress.total > 0 ? (nivel1Progress.known / nivel1Progress.total) * 100 : 0;
    
    const nivel1ProgressBar = document.getElementById('nivel1ProgressBar');
    const nivel1ProgressText = document.getElementById('nivel1ProgressText');
    
    if (nivel1ProgressBar) {
      nivel1ProgressBar.style.width = `${nivel1Percentage}%`;
    }
    if (nivel1ProgressText) {
      nivel1ProgressText.textContent = `${nivel1Progress.known}/${nivel1Progress.total}`;
    }

    // Actualizar Nivel 2
    const nivel2Progress = getNivel2Progress();
    const nivel2Percentage = nivel2Progress.total > 0 ? (nivel2Progress.known / nivel2Progress.total) * 100 : 0;
    
    const nivel2ProgressBar = document.getElementById('nivel2ProgressBar');
    const nivel2ProgressText = document.getElementById('nivel2ProgressText');
    
    if (nivel2ProgressBar) {
      nivel2ProgressBar.style.width = `${nivel2Percentage}%`;
    }
    if (nivel2ProgressText) {
      nivel2ProgressText.textContent = `${nivel2Progress.known}/${nivel2Progress.total}`;
    }

    // Actualizar Nivel 3
    const nivel3Progress = getNivel3Progress();
    const nivel3Percentage = nivel3Progress.total > 0 ? (nivel3Progress.known / nivel3Progress.total) * 100 : 0;
    
    const nivel3ProgressBar = document.getElementById('nivel3ProgressBar');
    const nivel3ProgressText = document.getElementById('nivel3ProgressText');
    
    if (nivel3ProgressBar) {
      nivel3ProgressBar.style.width = `${nivel3Percentage}%`;
    }
    if (nivel3ProgressText) {
      nivel3ProgressText.textContent = `${nivel3Progress.known}/${nivel3Progress.total}`;
    }

    // Actualizar HSK3
    const HSK3Progress = getNivelHSK3Progress();
    const HSK3Percentage = HSK3Progress.total > 0 ? (HSK3Progress.known / HSK3Progress.total) * 100 : 0;
    
    const HSK3ProgressBar = document.getElementById('HSK3ProgressBar');
    const HSK3ProgressText = document.getElementById('HSK3ProgressText');
    
    if (HSK3ProgressBar) {
      HSK3ProgressBar.style.width = `${HSK3Percentage}%`;
    }
    if (HSK3ProgressText) {
      HSK3ProgressText.textContent = `${HSK3Progress.known}/${HSK3Progress.total}`;
    }

    // Actualizar HSK4
    const HSK4Progress = getNivelHSK4Progress();
    const HSK4Percentage = HSK4Progress.total > 0 ? (HSK4Progress.known / HSK4Progress.total) * 100 : 0;
    
    const HSK4ProgressBar = document.getElementById('HSK4ProgressBar');
    const HSK4ProgressText = document.getElementById('HSK4ProgressText');
    
    if (HSK4ProgressBar) {
      HSK4ProgressBar.style.width = `${HSK4Percentage}%`;
    }
    if (HSK4ProgressText) {
      HSK4ProgressText.textContent = `${HSK4Progress.known}/${HSK4Progress.total}`;
    }
  }

  /* ========= FUNCIONES DE PROGRESO DE ANIMALES DEL HOR√ìSCOPO ========= */
  function getHoroscopeAnimalProgress(category) {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    // Filtrar cartas de esta categor√≠a
    const categoryCards = cards.filter(card => card.unit.split('|').includes(category));
    
    // Crear Sets para contar caracteres √∫nicos (no duplicados)
    const uniqueHanzi = new Set();
    const knownUniqueHanzi = new Set();
    
    categoryCards.forEach(card => {
      // Agregar al set de totales (caracteres √∫nicos)
      uniqueHanzi.add(card.hanzi);
      
      // Si est√° conocida, agregar al set de conocidas
      if (card.known) {
        knownUniqueHanzi.add(card.hanzi);
      }
    });
    
    return { 
      known: knownUniqueHanzi.size, 
      total: uniqueHanzi.size 
    };
  }

  function updateHoroscopeProgressBars() {
    const animals = [
      { id: 'rata', category: 'colores' },
      { id: 'gallo', category: 'fruta' },
      { id: 'conejo', category: 'verduras' },
      { id: 'cerdo', category: 'comidas' },
      { id: 'perro', category: 'animales' },
      { id: 'caballo', category: 'deportes' },
      { id: 'buey', category: 'hobbies' },
      { id: 'cabra', category: 'ropa' },
      { id: 'serpiente', category: 'casa' },
      { id: 'mono', category: 'cuerpo' },
      { id: 'tigre', category: 'profesiones' },
      { id: 'dragon', category: 'emociones' }
    ];

    animals.forEach(animal => {
      const progress = getHoroscopeAnimalProgress(animal.category);
      const percentage = progress.total > 0 ? (progress.known / progress.total) * 100 : 0;
      const isComplete = progress.total > 0 && progress.known === progress.total;
      
      const progressBar = document.getElementById(`${animal.id}ProgressBar`);
      const progressText = document.getElementById(`${animal.id}ProgressText`);
      
      if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        
        // Cambiar color seg√∫n si est√° completado o no
        if (isComplete) {
          // Verde cuando est√° completo (100%)
          progressBar.style.backgroundColor = '#22c55e'; // green-500
        } else {
          // Blanco cuando no est√° completo
          progressBar.style.backgroundColor = '#ffffff'; // white
        }
      }
      if (progressText) {
        progressText.textContent = `${progress.known}/${progress.total}`;
      }
    });
  }

  // Funciones para progreso de unidades individuales
  function getUnitProgress(unitName) {
    if (!cards || !Array.isArray(cards)) return { known: 0, total: 0 };
    
    // Filtrar cartas de esta unidad
    const unitCards = cards.filter(card => card.unit.split('|').includes(unitName));
    
    // Crear Sets para contar caracteres √∫nicos (no duplicados)
    const uniqueHanzi = new Set();
    const knownUniqueHanzi = new Set();
    
    unitCards.forEach(card => {
      // Agregar al set de totales (caracteres √∫nicos)
      uniqueHanzi.add(card.hanzi);
      
      // Si est√° conocida, agregar al set de conocidas
      if (card.known) {
        knownUniqueHanzi.add(card.hanzi);
      }
    });
    
    return { 
      known: knownUniqueHanzi.size, 
      total: uniqueHanzi.size 
    };
  }

  function updateUnitProgressCounters() {
    // Nivel 1 (unit2 a unit9)
    for (let i = 2; i <= 9; i++) {
      const progress = getUnitProgress(`unit${i}`);
      const element = document.getElementById(`unit${i}Progress`);
      const button = document.getElementById(`btnUnit${i}`);
      
      if (element) {
        element.textContent = `${progress.known}/${progress.total}`;
      }
      
      // Cambiar color si est√° completado
      if (button && progress.total > 0 && progress.known === progress.total) {
        button.style.setProperty('color', '#fbbf24', 'important'); // Amarillo con !important
      } else if (button) {
        button.style.setProperty('color', '#ffffff', 'important'); // Blanco por defecto con !important
      }
    }

    // Nivel 2 (unit1N2 a unit9N2)
    for (let i = 1; i <= 9; i++) {
      const progress = getUnitProgress(`unit${i}N2`);
      const element = document.getElementById(`unit${i}N2Progress`);
      const button = document.getElementById(`btnUnit${i}N2`);
      
      if (element) {
        element.textContent = `${progress.known}/${progress.total}`;
      }
      
      // Cambiar color si est√° completado
      if (button && progress.total > 0 && progress.known === progress.total) {
        button.style.setProperty('color', '#fbbf24', 'important'); // Amarillo con !important
      } else if (button) {
        button.style.setProperty('color', '#ffffff', 'important'); // Blanco por defecto con !important
      }
    }

    // Nivel 3 (unit1N3 a unit9N3)
    for (let i = 1; i <= 9; i++) {
      const progress = getUnitProgress(`unit${i}N3`);
      const element = document.getElementById(`unit${i}N3Progress`);
      const button = document.getElementById(`btnUnit${i}N3`);
      
      if (element) {
        element.textContent = `${progress.known}/${progress.total}`;
      }
      
      // Cambiar color si est√° completado
      if (button && progress.total > 0 && progress.known === progress.total) {
        button.style.setProperty('color', '#fbbf24', 'important'); // Amarillo con !important
      } else if (button) {
        button.style.setProperty('color', '#ffffff', 'important'); // Blanco por defecto con !important
      }
    }

    // HSK3 (HSK3unit1 a HSK3unit20)
    for (let i = 1; i <= 20; i++) {
      const progress = getUnitProgress(`HSK3unit${i}`);
      const element = document.getElementById(`HSK3unit${i}Progress`);
      const progressBar = document.getElementById(`HSK3unit${i}ProgressBar`);
      const button = document.getElementById(`btnHSK3unit${i}`);
      
      if (element) {
        element.textContent = `${progress.known}/${progress.total}`;
      }
      
      // Actualizar barra de progreso individual
      if (progressBar && progress.total > 0) {
        const percentage = (progress.known / progress.total) * 100;
        progressBar.style.width = `${percentage}%`;
      }
      
      // Cambiar color si est√° completado
      if (button && progress.total > 0 && progress.known === progress.total) {
        button.style.setProperty('color', '#fbbf24', 'important'); // Amarillo con !important
      } else if (button) {
        button.style.setProperty('color', '#000000', 'important'); // Negro por defecto con !important
      }
    }

    // HSK4 (HSK4unit1 a HSK4unit20)
    for (let i = 1; i <= 20; i++) {
      const progress = getUnitProgress(`HSK4unit${i}`);
      const element = document.getElementById(`HSK4unit${i}Progress`);
      const progressBar = document.getElementById(`HSK4unit${i}ProgressBar`);
      const button = document.getElementById(`btnHSK4unit${i}`);
      
      if (element) {
        element.textContent = `${progress.known}/${progress.total}`;
      }
      
      // Actualizar barra de progreso individual
      if (progressBar && progress.total > 0) {
        const percentage = (progress.known / progress.total) * 100;
        progressBar.style.width = `${percentage}%`;
      }
      
      // Cambiar color si est√° completado
      if (button && progress.total > 0 && progress.known === progress.total) {
        button.style.setProperty('color', '#fbbf24', 'important'); // Amarillo con !important
      } else if (button) {
        button.style.setProperty('color', '#000000', 'important'); // Negro por defecto con !important
      }
    }
  }

  let ultimateChallengeCurrentAnimal = '';
  let ultimateChallengeAnimalIndex = 0;
  let ultimateChallengeCardIndex = 0;
  let ultimateChallengeHearts = 3; // Sistema de vidas para Ultimate Challenge
  let ultimateChallengeTimer = 500; // Tiempo en segundos (8 min 20 seg)
  let ultimateChallengeTimerInterval = null; // Intervalo del timer

  // ====== VARIABLES PARA LA EMPERATRIZ ======
  let emperatrizActive = false;
  let emperatrizHP = 15000; // Vida de la Emperatriz
  let emperatrizMaxHP = 15000; // Vida m√°xima (para calcular porcentaje)
  let emperatrizTimer = 300; // 5 minutos = 300 segundos
  let emperatrizTimerInterval = null;
  let emperatrizLives = 3; // Tres vidas
  let emperatrizCardsAnswered = 0; // Contador para power-ups (cada 5)
  let emperatrizPowerUps = []; // Power-ups activos acumulables
  let emperatrizLastStandTriggered = false; // Para activar solo una vez por desaf√≠o
  let emperatrizShowingPowerUpModal = false; // Flag para evitar m√∫ltiples modals
  let emperatrizInvulnerableCards = 0; // Cartas restantes de invulnerabilidad
  let emperatrizAbsorbingDamage = 0; // Turnos restantes de absorci√≥n de da√±o
  
  // ‚è±Ô∏è TIEMPO REAL DEL DESAF√çO - Timestamp de inicio
  let challengeStartTime = null; // Se setea cuando inicia el desaf√≠o
  
  // Variables duplicadas para Desaf√≠o 12 Bestias
  let bestias12Active = false;
  let bestias12HP = 10000; // Vida de las 12 Bestias
  let bestias12MaxHP = 10000; // Vida m√°xima (para calcular porcentaje)
  let bestias12Timer = 300; // 5 minutos = 300 segundos
  let bestias12TimerInterval = null;
  let bestias12Lives = 3; // Tres vidas
  let bestias12CardsAnswered = 0; // Contador para power-ups (cada 5)
  let bestias12PowerUps = []; // Power-ups activos acumulables
  let bestias12ShowingPowerUpModal = false; // Flag para evitar m√∫ltiples modals
  let bestias12DamageMultiplier = 1.0; // Multiplicador de da√±o acumulativo
  let bestias12TimeBonus = 0; // Bonus de tiempo acumulativo
  let bestias12Level = 1; // Nivel del jugador
  
  // Sistema de timer y vidas para Desaf√≠os N1, N2, N3
  let desafioNActive = false;
  let desafioNTimerInterval = null;
  let desafioNTimeLeft = 120; // 2 minutos = 120 segundos
  let desafioNHearts = 3; // 3 vidas para desaf√≠os N

  // Sistema de timer2 y vidas2 para Desaf√≠os Cl√°sicos (clasico, menos, mas)
  let desafioClasico2Active = false;
  let desafioClasico2TimerInterval = null;
  let desafioClasico2TimeLeft = 90; // 1 minuto y medio = 90 segundos
  let desafioClasico2Hearts = 2; // 2 vidas para desaf√≠os cl√°sicos
  let previousKnownCount = 0; // Para detectar cambios en el contador de conocidas
  
  // Sistema de notificaciones post-desaf√≠o
  let challengeStartState = []; // Estado de cartas al iniciar desaf√≠o
  let challengeEndState = []; // Estado de cartas al finalizar desaf√≠o

  // --- Mapeo de categor√≠as del hor√≥scopo a animales chinos ---
  const horoscopeAnimals = {
    'colores': { name: 'Rata', image: 'rata1.webp', chinese: 'Èº†' },
    'fruta': { name: 'Gallo', image: 'gallo1.webp', chinese: 'È∏°' },
    'verduras': { name: 'Conejo', image: 'conejo1.webp', chinese: 'ÂÖî' },
    'comidas': { name: 'Cerdo', image: 'cerdo1.webp', chinese: 'Áå™' },
    'animales': { name: 'Perro', image: 'perro1.webp', chinese: 'Áãó' },
    'deportes': { name: 'Caballo', image: 'caballo1.webp', chinese: 'È©¨' },
    'hobbies': { name: 'Buey', image: 'vaca1.webp', chinese: 'Áâõ' },
    'ropa': { name: 'Cabra', image: 'cabra1.webp', chinese: 'Áæä' },
    'casa': { name: 'Serpiente', image: 'serpiente1.webp', chinese: 'Ëõá' },
    'cuerpo': { name: 'Mono', image: 'mono1.webp', chinese: 'Áå¥' },
    'profesiones': { name: 'Tigre', image: 'tigre1.webp', chinese: 'Ëôé' },
    'emociones': { name: 'Drag√≥n', image: 'dragon1.webp', chinese: 'Èæô' }
  };

  // Orden fijo de animales para el Desaf√≠o Final (12 animales x 5 cartas = 60 total)
  const ultimateChallengeOrder = [
    { animal: 'Rata', categoria: 'colores' },
    { animal: 'Gallo', categoria: 'fruta' },
    { animal: 'Conejo', categoria: 'verduras' },
    { animal: 'Cerdo', categoria: 'comidas' },
    { animal: 'Perro', categoria: 'animales' },
    { animal: 'Caballo', categoria: 'deportes' },
    { animal: 'Buey', categoria: 'hobbies' },
    { animal: 'Cabra', categoria: 'ropa' },
    { animal: 'Serpiente', categoria: 'casa' },
    { animal: 'Mono', categoria: 'cuerpo' },
    { animal: 'Tigre', categoria: 'profesiones' },
    { animal: 'Drag√≥n', categoria: 'emociones' }
  ];

  let sessionTotal = 0;
  let sessionCorrect = 0;
  // Variables para acumular aciertos/errores de la sesi√≥n actual (para enviar al servidor)
  let sessionCorrectAccumulated = 0;
  let sessionWrongAccumulated = 0;
  // 'flash' | 'quizPinyin' | 'quizMeaning'
  let mode = 'flash';

  /* ========= DOM ========= */
  const bodyEl  = document.getElementById('body');
  const cardEl  = document.getElementById('card');
  const frontEl = document.getElementById('cardFront');
  const backEl  = document.getElementById('cardBack');

  const statInSession = document.getElementById('statInSession');
  const statToday     = document.getElementById('statToday');
  const statMission   = document.getElementById('statMission');
  const statBox       = document.getElementById('statBox');
  const streakBox = document.getElementById('streakBox');
  const streakCount = document.getElementById('streakCount');
  const streakStatus = document.getElementById('streakStatus');

  const flashRow = document.getElementById('flashRow');
  const quizRow  = document.getElementById('quizRow');

  const btnKnownBox   = document.getElementById('btnKnown');
  const btnRevise1Box = document.getElementById('btnRevise1');
  const btnRevise2Box = document.getElementById('btnRevise2');

  /* Overlay conocidos */
  const knownOverlay  = document.getElementById('knownOverlay');
  const knownGrid     = document.getElementById('knownGrid');
  const knownCount    = document.getElementById('knownCount');

  /* ========= Utils ========= */
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function hoursSince(ts){ if(!ts) return null; const diffMs = Date.now() - ts; return Math.floor(diffMs / 3600000); }
  function saveAll(){ SaveQueue.enqueue(); }
  

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  
  /* ========= SISTEMA INTELIGENTE DE OPCIONES ========= */
  
  // Detectar n√∫mero de s√≠labas en pinyin
  function getSyllableCount(pinyin) {
    if (!pinyin) return 1;
    return pinyin.trim().split(/\s+/).length;
  }
  
  // Generar opciones inteligentes basadas en s√≠labas y contexto
  function generateSmartOptions(correctCard, availablePool, debugMode = false, numDistractors = 3) {
    const targetSyllables = getSyllableCount(correctCard.pinyin);
    const strategy = Math.random() < 0.5 ? 'unit' : 'category';
    
    if (debugMode) {
      console.log(`üß† SMART OPTIONS:
        Tarjeta: ${correctCard.hanzi} (${correctCard.pinyin}) - ${targetSyllables} s√≠labas
        Distractores necesarios: ${numDistractors}
        Estrategia: ${strategy}
        Pool disponible: ${availablePool.length} opciones`);
    }
    
    // PASO 1: Filtrar por n√∫mero de s√≠labas (ESTRICTO)
    let sameSyllablePool = availablePool.filter(card => 
      card.hanzi !== correctCard.hanzi && 
      getSyllableCount(card.pinyin) === targetSyllables
    );
    
    if (debugMode) {
      console.log(`‚úÖ Pool con ${targetSyllables} s√≠labas: ${sameSyllablePool.length} opciones`);
    }
    
    // PASO 2: Si hay muy pocas de la misma cantidad de s√≠labas, usar fallback
    if (targetSyllables >= 3 && sameSyllablePool.length < numDistractors) {
      // Para 3+ s√≠labas, mezclar con 2 s√≠labas
      const twoSyllablePool = availablePool.filter(card => 
        card.hanzi !== correctCard.hanzi && 
        getSyllableCount(card.pinyin) === 2
      );
      sameSyllablePool = [...sameSyllablePool, ...twoSyllablePool];
      
      if (debugMode) {
        console.log(`üîÑ Fallback aplicado: agregando palabras de 2 s√≠labas. Total: ${sameSyllablePool.length}`);
      }
    }
    
    if (sameSyllablePool.length < numDistractors) {
      if (debugMode) {
        console.log(`‚ö†Ô∏è Pool insuficiente, usando opciones aleatorias`);
      }
      // Fallback extremo: usar cualquier opci√≥n disponible
      return shuffle(availablePool.filter(card => card.hanzi !== correctCard.hanzi))
        .slice(0, numDistractors)
        .map(card => ({
          ...card,
          debugInfo: `${getSyllableCount(card.pinyin)}syl-fallback`
        }));
    }
    
    // PASO 3: Aplicar estrategia elegida
    let contextualOptions = [];
    let randomOptions = [];
    
    if (strategy === 'unit') {
      // Estrategia por UNIDAD/TEM√ÅTICA
      contextualOptions = sameSyllablePool.filter(card => 
        card.unit === correctCard.unit
      );
      if (debugMode) {
        console.log(`üìö Opciones de misma unidad (${correctCard.unit}): ${contextualOptions.length}`);
      }
    } else {
      // Estrategia por CATEGOR√çA GRAMATICAL
      contextualOptions = sameSyllablePool.filter(card => 
        card.cat === correctCard.cat
      );
      if (debugMode) {
        console.log(`üî§ Opciones de misma categor√≠a (${correctCard.cat}): ${contextualOptions.length}`);
      }
    }
    
    // Preparar opciones aleatorias (del pool de s√≠labas correctas)
    randomOptions = sameSyllablePool.filter(card => 
      !contextualOptions.some(ctx => ctx.hanzi === card.hanzi)
    );
    
    // PASO 4: Seleccionar distractores - ajustar proporci√≥n seg√∫n cantidad necesaria
    // Para 3 distractores: 2 contextuales + 1 aleatoria
    // Para 5 distractores: 3 contextuales + 2 aleatorias
    const contextualCount = Math.ceil(numDistractors * 0.6); // 60% contextuales
    const randomCount = numDistractors - contextualCount; // 40% aleatorias
    
    const selectedContextual = shuffle([...contextualOptions]).slice(0, contextualCount);
    const selectedRandom = shuffle([...randomOptions]).slice(0, randomCount);
    
    const finalOptions = [
      ...selectedContextual.map(card => ({
        ...card,
        debugInfo: `${getSyllableCount(card.pinyin)}syl-${strategy}`
      })),
      ...selectedRandom.map(card => ({
        ...card,
        debugInfo: `${getSyllableCount(card.pinyin)}syl-random`
      }))
    ];
    
    // Si no tenemos suficientes, completar con aleatorias
    while (finalOptions.length < numDistractors && sameSyllablePool.length > 0) {
      const extraCard = sameSyllablePool.shift();
      if (!finalOptions.some(opt => opt.hanzi === extraCard.hanzi)) {
        finalOptions.push({
          ...extraCard,
          debugInfo: `${getSyllableCount(extraCard.pinyin)}syl-extra`
        });
      }
    }
    
    if (debugMode) {
      console.log(`‚úÖ Opciones finales generadas (${finalOptions.length}/${numDistractors}):`, 
        finalOptions.map(opt => `${opt.hanzi}(${opt.pinyin})-${opt.debugInfo}`));
    }
    
    return finalOptions.slice(0, numDistractors);
  }
  
  // Funci√≥n espec√≠fica para Ultimate Challenge (SIEMPRE estrategia tem√°tica)
  function generateSmartOptionsUltimate(correctCard, availablePool, field, debugMode = true, numDistractors = 3) {
    const targetSyllables = getSyllableCount(correctCard.pinyin);
    
    if (debugMode) {
      console.log(`üèÜ ULTIMATE CHALLENGE SMART OPTIONS:
        Tarjeta: ${correctCard.hanzi} (${correctCard.pinyin}) - ${targetSyllables} s√≠labas
        Estrategia: TEM√ÅTICA (unit) - FORZADA
        Pool disponible: ${availablePool.length} opciones
        Unidad: ${correctCard.unit}
        Campo: ${field}
        Distractores necesarios: ${numDistractors}`);
    }
    
    // PASO 1: Filtrar por n√∫mero de s√≠labas (ESTRICTO)
    let sameSyllablePool = availablePool.filter(card => 
      getSyllableCount(card.pinyin) === targetSyllables
    );
    

    
    // PASO 2: Fallback si hay pocas de 3+ s√≠labas
    if (targetSyllables >= 3 && sameSyllablePool.length < numDistractors) {
      const twoSyllablePool = availablePool.filter(card => 
        getSyllableCount(card.pinyin) === 2
      );
      sameSyllablePool = [...sameSyllablePool, ...twoSyllablePool];
      
      if (debugMode) {
        console.log(`üîÑ Ultimate Challenge - Fallback aplicado: agregando 2 s√≠labas. Total: ${sameSyllablePool.length}`);
      }
    }
    
    if (sameSyllablePool.length < numDistractors) {
      if (debugMode) {
        console.log(`‚ö†Ô∏è Ultimate Challenge - Pool insuficiente, usando opciones aleatorias`);
      }
      return shuffle(availablePool)
        .slice(0, numDistractors)
        .map(card => card[field])
        .filter(val => val);
    }
    
    // PASO 3: ESTRATEGIA TEM√ÅTICA FORZADA (por unidad)
    let contextualOptions = sameSyllablePool.filter(card => 
      card.unit === correctCard.unit
    );
    
    if (debugMode) {
      console.log(`üé® Ultimate Challenge - Opciones de misma tem√°tica (${correctCard.unit}): ${contextualOptions.length}`);
    }
    
    // Opciones aleatorias (del pool de s√≠labas correctas, pero diferentes tem√°ticas)
    let randomOptions = sameSyllablePool.filter(card => 
      card.unit !== correctCard.unit
    );
    
    // PASO 4: Seleccionar seg√∫n proporci√≥n (ej: para 3 distractores -> 2 tem√°ticos + 1 aleatorio)
    // Para 5 distractores -> 3 tem√°ticos + 2 aleatorios
    const numContextual = Math.ceil(numDistractors * 0.67); // ~67% tem√°ticos
    const numRandom = numDistractors - numContextual;
    
    const selectedContextual = shuffle([...contextualOptions]).slice(0, numContextual);
    const selectedRandom = shuffle([...randomOptions]).slice(0, numRandom);
    
    let finalOptions = [
      ...selectedContextual.map(card => card[field]),
      ...selectedRandom.map(card => card[field])
    ].filter(val => val);
    
    // Completar con opciones aleatorias si falta
    while (finalOptions.length < numDistractors && sameSyllablePool.length > 0) {
      const extraCard = sameSyllablePool.shift();
      const extraValue = extraCard[field];
      if (extraValue && !finalOptions.includes(extraValue)) {
        finalOptions.push(extraValue);
      }
    }
    
    if (debugMode) {
      console.log(`‚úÖ Ultimate Challenge - Opciones finales:`, 
        finalOptions.map((opt, i) => `${opt}(${getSyllableCount(correctCard.pinyin)}syl-${i < numContextual ? 'tem√°tica' : 'aleatorio'})`));
    }
    
    return finalOptions.slice(0, numDistractors);
  }
  
  function dedupeByHanzi(rows){
    const seen = new Set(); const out = [];
    for(const r of rows){ const key = r[0]; if(seen.has(key)) continue; seen.add(key); out.push(r); }
    return out;
  }

  /* ========= Audio (WebAudio) ========= */

  // Audio sint√©tico - ya no requiere pool de MP3

  // Inicializar pool de sonidos
  function initCorrectSoundPool() {
    // Ya no necesitamos pool de audio - ahora usamos sonido sint√©tico
    console.log('‚úÖ Audio sint√©tico listo - no se requiere pool de soundcorrect.mp3');
  }

  // Ya no necesitamos obtener audio del pool - usamos sonido sint√©tico
  function getNextCorrectSound() {
    return null; // Siempre null para forzar uso de sonido sint√©tico
  }

  // Ya no necesitamos reinicializar pool - usamos sonido sint√©tico
  function refreshCorrectSoundPool() {
    console.log('‚úÖ Refresh completado - usando sonido sint√©tico');
  }

  /* ========= M√∫sica de fondo para modo desaf√≠o ========= */
  let desafioMusic = null;
  async function playDesafioMusic(desafioType = null) {
    console.log('üéº DEBUG playDesafioMusic() iniciado para:', desafioType);
    console.log('üéº AudioContext state ANTES de m√∫sica:', audioCtx.state);
    
    // Detener m√∫sica de bienvenida si sigue activa
    if (window.bonfireAudio && !window.bonfireAudio.paused) {
      try { window.bonfireAudio.pause(); window.bonfireAudio.currentTime = 0; } catch (e) {}
      window.bonfireAudio = null;
      console.log('üîá bonfiremusic detenida para iniciar m√∫sica de desaf√≠o');
    }

    // Reset music activation counters for new challenge
    musicActivationAttempts = 0;
    musicActivationListenerAdded = false;
    
    if (desafioMusic) {
      console.log('üéº Pausando m√∫sica anterior');
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
    }
    
    // Seleccionar track y volumen seg√∫n el tipo de desaf√≠o
    let trackFile = 'music/trackchin3.mp3'; // Default para challenge y desaf√≠o cl√°sico
    let volume = 0.6; // Volumen por defecto

    // üéµ PRIORIDAD: Si hay un boss challenge configurado activo, usar su m√∫sica
    if (currentChallengeConfig && currentChallengeConfig.music) {
      trackFile = `music/${currentChallengeConfig.music}.mp3`;
      volume = currentChallengeConfig.musicVolume || 0.6;
      console.log(`üéµ Boss Challenge ${currentChallengeConfig.name}: usando ${currentChallengeConfig.music} (volumen ${volume})`);
    } else if (desafioType === 'desafioN1') {
      trackFile = 'music/track4.mp3';
      volume = 0.6;
    } else if (desafioType === 'desafioN2') {
      trackFile = 'music/track2.mp3';
      volume = 0.6;
    } else if (desafioType === 'desafioN3') {
      trackFile = 'music/track3.mp3';
      volume = 0.6;
    } else if (desafioType === 'ultimateChallenge') {
      trackFile = 'music/track2.mp3';
      volume = 0.8;
    } else if (desafioType === 'emperatriz') {
      // Verificar si hay un desaf√≠o personalizado activo
      if (currentChallengeConfig && currentChallengeConfig.music) {
        trackFile = `music/${currentChallengeConfig.music}.mp3`;
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${currentChallengeConfig.name}: usando ${currentChallengeConfig.music}`);
      } else {
        // Fallback a la m√∫sica original de La Emperatriz
        trackFile = 'music/musiceleste.mp3';
        volume = 0.6;
        console.log('üéµ Desaf√≠o La Emperatriz: usando musiceleste');
      }
    } else if (desafioType === 'bestias12') {
      trackFile = 'music/musi12.mp3';
      volume = 0.6;
      console.log('üéµ Desaf√≠o Las Bestias 12: usando musi12');
      console.log('üê≤ DEBUG bestias12: desafioType recibido:', desafioType);
      console.log('üê≤ DEBUG bestias12: trackFile asignado:', trackFile);
    } else if (desafioType && desafioType.includes && desafioType.includes('desafioHoroscopo-')) {
      // Desaf√≠os del hor√≥scopo por categor√≠a espec√≠fica - NUEVO MAPEO DE M√öSICAS
      const categoria = desafioType.replace('desafioHoroscopo-', '');
      
      // musirose.mp3 para cerdo y conejo
      if (['comidas', 'verduras'].includes(categoria)) {
        trackFile = 'music/musirose.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria} (Cerdo/Conejo): usando musirose`);
      }
      // musiverde.mp3 para drag√≥n y tigre  
      else if (['emociones', 'profesiones'].includes(categoria)) {
        trackFile = 'music/musiverde.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria} (Drag√≥n/Tigre): usando musiverde`);
      }
      // musiazulo.mp3 para mono y serpiente
      else if (['cuerpo', 'casa'].includes(categoria)) {
        trackFile = 'music/musiazulo.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria} (Mono/Serpiente): usando musiazulo`);
      }
      // musiepic.mp3 para buey y cabra
      else if (['hobbies', 'ropa'].includes(categoria)) {
        trackFile = 'music/musiepic.mp3';
        volume = 0.7;
        console.log(`üéµ Desaf√≠o ${categoria} (Buey/Cabra): usando musiepic`);
      }
      // musiceleste.mp3 para rata y gallo
      else if (['colores', 'fruta'].includes(categoria)) {
        trackFile = 'music/musiceleste.mp3';
        volume = 0.6;
        console.log(`üéµ Desaf√≠o ${categoria} (Rata/Gallo): usando musiceleste`);
      }
      // trackchin1.mp3 para perro y caballo
      else if (['animales', 'deportes'].includes(categoria)) {
        trackFile = 'music/trackchin1.mp3';
        volume = 0.7;
        console.log(`üéµ Desaf√≠o ${categoria} (Perro/Caballo): usando trackchin1`);
      }
      else {
        // Fallback para desaf√≠os del hor√≥scopo sin categor√≠a espec√≠fica
        trackFile = 'music/musiceleste.mp3';
        volume = 0.5;
        console.log(`üéµ Desaf√≠o hor√≥scopo gen√©rico: usando musiceleste (fallback)`);
      }
    }
    
    console.log(`üéº Creando nueva instancia de m√∫sica: ${trackFile}`);
    // Detener m√∫sica de bienvenida si est√° activa antes de iniciar una nueva
    if (window.bonfireAudio && !window.bonfireAudio.paused) {
      try { window.bonfireAudio.pause(); window.bonfireAudio.currentTime = 0; } catch (e) {}
      window.bonfireAudio = null;
      console.log('üîá bonfiremusic detenida antes de iniciar m√∫sica de desaf√≠o');
    }
    
    // Activar AudioContext
    await ensureAudio();
    
    // Crear nueva instancia de m√∫sica
    desafioMusic = new Audio(trackFile);
    desafioMusic.loop = true;
    desafioMusic.volume = volume;
    desafioMusic.preload = 'auto';
    
    // üçé iOS: Configuraci√≥n espec√≠fica
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
      desafioMusic.playsInline = true;
    }
    
    // Intentar reproducir m√∫sica
    try {
      await desafioMusic.play();
      console.log('‚úÖ M√∫sica iniciada exitosamente');
    } catch (error) {
      console.error('‚ùå Error iniciando m√∫sica:', error);
      
      if (isIOS && musicActivationAttempts < 3 && !musicActivationListenerAdded) {
        musicActivationAttempts++;
        musicActivationListenerAdded = true;
        
        console.log(`üçé iOS: Intento ${musicActivationAttempts}/3 - Guardando m√∫sica para activar con pr√≥xima interacci√≥n`);
        
        // Activar m√∫sica con la pr√≥xima interacci√≥n del usuario
        const activateMusic = () => {
          desafioMusic.play().then(() => {
            console.log('üçé iOS: M√∫sica activada exitosamente con interacci√≥n del usuario');
            // Reset counters on success
            musicActivationAttempts = 0;
            musicActivationListenerAdded = false;
          }).catch(e => {
            console.log(`üçé iOS: Fall√≥ activar m√∫sica (intento ${musicActivationAttempts}/3):`, e);
            // Allow next attempt
            musicActivationListenerAdded = false;
          });
          // Remover listener despu√©s de usar
          document.removeEventListener('touchstart', activateMusic);
          document.removeEventListener('click', activateMusic);
        };
        
        document.addEventListener('touchstart', activateMusic, { once: true, passive: true });
        document.addEventListener('click', activateMusic, { once: true, passive: true });
      } else if (musicActivationAttempts >= 3) {
        console.log('üçé iOS: Se alcanzaron 3 intentos m√°ximos para activar m√∫sica. Saltando...');
      }
    }
  }
  function stopDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
      desafioMusic = null;
    }
    // üßπ LIMPIAR COUNTDOWN AL PARAR LA M√öSICA
    cleanupCountdown();
  }
  
  // ================== BADGES LEGENDARIOS SIN ANIMACI√ìN ==================
  // Las animaciones de badges legendarios fueron removidas para mejor rendimiento
  // Los badges mantienen su est√©tica dorada pero sin consumir recursos de CPU
  
  // ================== FUNCIONES DE VIDEO DE FONDO ==================
  let challengeVideoElement = null;
  
  function createChallengeVideo(challengeType = 'default') {
    // Si ya existe, no crear otro
    if (challengeVideoElement) return;
    
    challengeVideoElement = document.createElement('video');
    
    // Seleccionar el video seg√∫n el tipo de desaf√≠o - SIN FALLBACKS
    let videoSrc;
    
    switch(challengeType) {
      case 'desafioN1':
        videoSrc = 'img/fondonegro.mp4';
        break;
      case 'desafioN2':
        videoSrc = 'img/fondo2.mp4';
        break;
      case 'desafioN3':
        videoSrc = 'img/fondon3.mp4';
        break;
      case 'bestias12':
        videoSrc = 'img/fondofinal.mp4';
        break;
      case 'emperatriz':
        videoSrc = 'img/testok.mp4';
        break;
      case 'cruzarMar':
        videoSrc = 'img/cruzarelmar.mp4';
        break;
      case 'cruzarCielo':
        videoSrc = 'img/cruzaelcielo.mp4';
        break;  
      case 'desafioHoroscopo':
        videoSrc = 'img/dust.mp4'; // Hor√≥scopo usa dust.mp4
        break;
      // === ANIMALES DEL HOR√ìSCOPO ===
      case 'desafioColores':      // üêÄ Rata
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioFruta':        // üêì Gallo
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioVerduras':     // üê∞ Conejo
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioComidas':      // üê∑ Cerdo
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioAnimales':     // üê∂ Perro
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioDeportes':     // üê¥ Caballo
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioHobbies':      // üêÇ Buey/Vaca
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioRopa':         // üêê Cabra
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioCasa':         // üêç Serpiente
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioCuerpo':       // üêµ Mono
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioProfesiones':  // üêÖ Tigre
        videoSrc = 'img/animal.mp4';
        break;
      case 'desafioEmociones':    // üê≤ Drag√≥n
        videoSrc = 'img/animal.mp4';
        break;
      case 'ultimateChallenge':
        videoSrc = 'img/animal.mp4';
        break;
      // === DESAF√çOS CL√ÅSICOS ===
      case 'clasico':             // Desaf√≠o cl√°sico
      case 'menos':               // Desaf√≠o - (nivel 0 y 1)
      case 'mas':                 // Desaf√≠o + (nivel 2+)
        videoSrc = 'img/dust.mp4';
        break;
      case 'challenge':
        videoSrc = 'img/dust.mp4'; // Challenge usa dust.mp4
        break;
    }
    
    challengeVideoElement.src = videoSrc;
    challengeVideoElement.className = 'challenge-video-bg';
    challengeVideoElement.autoplay = true;
    challengeVideoElement.loop = true;
    challengeVideoElement.muted = true; // Para evitar problemas de autoplay
    challengeVideoElement.playsInline = true; // Para m√≥viles
    
    // Insertar el video al body
    document.body.appendChild(challengeVideoElement);
    
    console.log(`üé¨ Video de fondo de desaf√≠o creado: ${videoSrc}`);
  }
  
  // ================== SISTEMA DE PRECARGA DE VIDEOS ==================
  
  // Variables para controlar cu√°ndo pueden iniciarse los timers
  let preloadingChallenge = false;
  let pendingTimerCallbacks = [];
  let countdownInterval = null;
  let countdownActive = false;
  
  // FUNCI√ìN ELIMINADA - Era redundante con createChallengeBackgroundVideo()
  // Toda la l√≥gica de videos se maneja en createChallengeBackgroundVideo()
  
  function showVideoPreloader(challengeType) {
    const preloader = document.getElementById('videoPreloader');
    const progressBar = document.getElementById('preloadProgress');
    
    preloader.style.display = 'flex';
    progressBar.style.width = '0%';
    
    // Mostrar mensaje espec√≠fico de carga
    const loadingText = preloader.querySelector('p') || preloader;
    if (loadingText.tagName === 'P') {
      loadingText.textContent = 'Cargando video de fondo...';
    }
    
    return new Promise((resolve, reject) => {
      // Obtener la fuente del video usando la misma l√≥gica que createChallengeBackgroundVideo
      let videoSrc;
      switch(challengeType) {
        case 'desafioN1': videoSrc = 'img/fondonegro.mp4'; break;
        case 'desafioN2': videoSrc = 'img/fondo2.mp4'; break;
        case 'desafioN3': videoSrc = 'img/fondon3.mp4'; break;
        case 'bestias12': videoSrc = 'img/fondobestias.mp4'; break;
        case 'emperatriz': videoSrc = 'img/testok.mp4'; break;
        case 'desafioHoroscopo': videoSrc = 'img/dust.mp4'; break;
        case 'cruzarMar': videoSrc = 'img/cruzarelmar.mp4'; break;
        case 'cruzarCielo': videoSrc = 'img/cruzaelcielo.mp4'; break;
        case 'cruzarHSK3': videoSrc = 'img/cruzarhsk3.mp4'; break;
        case 'cruzarHSK4': videoSrc = 'img/cruzarhsk4.mp4'; break;
        case 'desafioColores': videoSrc = 'img/animal.mp4'; break;
        case 'desafioFruta': videoSrc = 'img/animal.mp4'; break;
        case 'desafioVerduras': videoSrc = 'img/animal.mp4'; break;
        case 'desafioComidas': videoSrc = 'img/animal.mp4'; break;
        case 'desafioAnimales': videoSrc = 'img/animal.mp4'; break;
        case 'desafioDeportes': videoSrc = 'img/animal.mp4'; break;
        case 'desafioHobbies': videoSrc = 'img/animal.mp4'; break;
        case 'desafioRopa': videoSrc = 'img/animal.mp4'; break;
        case 'desafioCasa': videoSrc = 'img/animal.mp4'; break;
        case 'desafioCuerpo': videoSrc = 'img/animal.mp4'; break;
        case 'desafioProfesiones': videoSrc = 'img/animal.mp4'; break;
        case 'desafioEmociones': videoSrc = 'img/animal.mp4'; break;
        case 'ultimateChallenge': videoSrc = 'img/fondofinal.mp4'; break;
        case 'clasico':
        case 'menos':
  case 'mas': videoSrc = 'img/dust.mp4'; break;
  case 'challenge': videoSrc = 'img/dust.mp4'; break;
        default: 
          console.error(`‚ùå TIPO DE DESAF√çO NO RECONOCIDO: ${challengeType}`);
          reject(new Error(`Tipo de desaf√≠o no reconocido: ${challengeType}`));
          return;
      }
      let video = null;
      let progressInterval = null;
      let loadTimeout = null;
      let isResolved = false;
      
      // Funci√≥n para manejar √©xito
      function handleSuccess(videoElement) {
        if (isResolved) return;
        isResolved = true;
        
        clearInterval(progressInterval);
        clearTimeout(loadTimeout);
        
        progressBar.style.width = '100%';
        console.log('‚úÖ Video cargado y verificado exitosamente:', videoSrc);
        
        // Test final: intentar reproducir el video
        videoElement.currentTime = 0;
        const playPromise = videoElement.play();
        
        if (playPromise) {
          playPromise.then(() => {
            videoElement.pause();
            videoElement.currentTime = 0;
            console.log('‚úÖ Video puede reproducirse correctamente');
            
            showCountdown(challengeType).then(() => {
              preloader.style.display = 'none';
              resolve(videoElement);
            });
          }).catch((e) => {
            console.error('‚ùå Video cargado pero no puede reproducirse:', e);
            handleError('Video no puede reproducirse');
          });
        } else {
          // Navegadores antiguos sin promesas
          videoElement.pause();
          videoElement.currentTime = 0;
          showCountdown(challengeType).then(() => {
            preloader.style.display = 'none';
            resolve(videoElement);
          });
        }
      }
      
      // Funci√≥n para manejar errores
      function handleError(reason) {
        if (isResolved) return;
        isResolved = true;
        
        clearInterval(progressInterval);
        clearTimeout(loadTimeout);
        
        console.error('‚ùå Error cargando video:', videoSrc, reason);
        
        // Mostrar alerta espec√≠fica al usuario
        const errorMsg = `No se pudo cargar el video de fondo para este desaf√≠o.\n\nRaz√≥n: ${reason}\nVideo: ${videoSrc}\n\n¬øDeseas continuar sin video de fondo?`;
        
        if (confirm(errorMsg)) {
          showCountdown(challengeType).then(() => {
            preloader.style.display = 'none';
            resolve(null);
          });
        } else {
          preloader.style.display = 'none';
          // No continuar con el desaf√≠o
          reject(new Error('Usuario cancel√≥ debido a error de video'));
        }
      }
      
      // Crear elemento de video
      video = document.createElement('video');
      video.src = videoSrc;
      video.loop = true;
      video.muted = true;
      video.playsInline = true;
      video.preload = 'auto';
      // No usar crossOrigin para evitar problemas de CORS en servidor local
      
      // Progreso simulado m√°s lento y realista
      let progress = 0;
      progressInterval = setInterval(() => {
        if (progress < 85) {
          progress += Math.random() * 5;
          progressBar.style.width = Math.min(progress, 85) + '%';
        }
      }, 300);
      
      // M√∫ltiples eventos para asegurar carga completa
      let canPlayThrough = false;
      let loadedData = false;
      let loadedMetadata = false;
      
      function checkIfFullyLoaded() {
        if (canPlayThrough && loadedData && loadedMetadata && video.readyState >= 3) {
          handleSuccess(video);
        }
      }
      
      video.addEventListener('loadedmetadata', () => {
        loadedMetadata = true;
        console.log('üìä Video metadata cargada');
        checkIfFullyLoaded();
      });
      
      video.addEventListener('loadeddata', () => {
        loadedData = true;
        console.log('üìä Video data cargada');
        checkIfFullyLoaded();
      });
      
      video.addEventListener('canplaythrough', () => {
        canPlayThrough = true;
        console.log('üìä Video puede reproducirse completamente');
        checkIfFullyLoaded();
      });
      
      video.addEventListener('error', (e) => {
        const error = video.error;
        let errorMsg = 'Error desconocido';
        if (error) {
          switch(error.code) {
            case 1: errorMsg = 'Carga abortada'; break;
            case 2: errorMsg = 'Error de red'; break;
            case 3: errorMsg = 'Error de decodificaci√≥n'; break;
            case 4: errorMsg = 'Formato no soportado'; break;
          }
        }
        handleError(errorMsg);
      });
      
      video.addEventListener('stalled', () => {
        console.warn('‚ö†Ô∏è Video stalled (conexi√≥n lenta)');
      });
      
      video.addEventListener('waiting', () => {
        console.warn('‚ö†Ô∏è Video esperando m√°s datos');
      });
      
      // Timeout extendido pero con opci√≥n de cancelar
      loadTimeout = setTimeout(() => {
        if (!isResolved) {
          const timeoutMsg = 'El video est√° tardando m√°s de 30 segundos en cargar.\n\n¬øDeseas seguir esperando o continuar sin video?';
          if (confirm(timeoutMsg)) {
            // Dar 30 segundos m√°s
            loadTimeout = setTimeout(() => {
              handleError('Timeout despu√©s de 60 segundos');
            }, 30000);
          } else {
            handleError('Usuario cancel√≥ por timeout');
          }
        }
      }, 30000);
      
      // Iniciar carga
      console.log('üé¨ Iniciando carga estricta de video:', videoSrc);
      video.load();
    });
  }
  
  function showCountdown(challengeType = null) {
    return new Promise(async (resolve) => {
      // üõ°Ô∏è PREVENIR M√öLTIPLES EJECUCIONES
      if (countdownActive) {
        console.log('‚ö†Ô∏è Countdown ya est√° activo, ignorando llamada duplicada');
        return resolve();
      }
      
      countdownActive = true;
      console.log('üöÄ Iniciando countdown √∫nico para:', challengeType);
      console.log('üê≤ DEBUG countdown - challengeType tipo:', typeof challengeType);
      console.log('üê≤ DEBUG countdown - challengeType valor exacto:', JSON.stringify(challengeType));
      
      const preloaderContent = document.querySelector('.preloader-content');
      const countdownContent = document.getElementById('countdownContent');
      const countdownNumber = document.getElementById('countdownNumber');
      
      // Ocultar contenido de carga y mostrar countdown
      preloaderContent.style.display = 'none';
      countdownContent.style.display = 'block';
      
      // Aplicar fuente Jersey 10 con estilo pixel
      countdownNumber.style.fontFamily = 'Jersey 10, monospace';
      countdownNumber.style.fontSize = '8rem';
      countdownNumber.style.fontWeight = 'bold';
      countdownNumber.style.letterSpacing = '4px';
      countdownNumber.style.textShadow = '0 0 20px rgba(74, 222, 128, 0.8), 4px 4px 0px rgba(0, 0, 0, 0.8)';
      
      let count = 3;
      countdownNumber.textContent = count;
      
      // ‚ú® INICIAR M√öSICA - COMPORTAMIENTO ESPECIAL PARA iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isMobileWidth = window.innerWidth <= 768;
      
      if (challengeType && !desafioMusic) {
        if (isIOS && isMobileWidth) {
          // üçé iOS M√ìVIL: NO iniciar m√∫sica durante countdown para evitar conflicto con beeps
          console.log('üçé iOS m√≥vil detectado: m√∫sica se iniciar√° DESPU√âS del countdown');
          console.log('üéµ audioCtx.state conservado:', audioCtx.state);
          // Almacenar el tipo para iniciar despu√©s
          window.pendingMusicType = challengeType;
        } else {
          // üñ•Ô∏è DESKTOP/ANDROID: iniciar m√∫sica normalmente durante countdown
          console.log('üéµ ANTES de iniciar m√∫sica - audioCtx.state:', audioCtx.state);
          await playDesafioMusic(challengeType);
          console.log('üéµ DESPU√âS de iniciar m√∫sica - audioCtx.state:', audioCtx.state);
          console.log('üéµ M√∫sica iniciada para:', challengeType);
        }
      } else if (desafioMusic) {
        console.log('üéµ M√∫sica ya est√° reproduci√©ndose, no reiniciar');
        console.log('üéµ Estado actual - audioCtx.state:', audioCtx.state);
      }
      
      countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownNumber.textContent = count;
          // Reiniciar animaci√≥n
          countdownNumber.style.animation = 'none';
          setTimeout(() => {
            countdownNumber.style.animation = 'countdownPulse 0.5s ease-in-out';
          }, 10);
        } else {
          // üßπ LIMPIAR COMPLETAMENTE EL COUNTDOWN
          clearInterval(countdownInterval);
          countdownInterval = null;
          
          // Mostrar "¬°GO!" brevemente
          countdownNumber.textContent = 'ÂºÄÂßã';
          countdownNumber.style.color = '#4ade80';
          countdownNumber.style.animation = 'countdownPulse 0.5s ease-in-out';
          
          setTimeout(async () => {
            // Restaurar estado original para pr√≥ximas veces
            preloaderContent.style.display = 'block';
            countdownContent.style.display = 'none';
            countdownNumber.style.color = '#ffffff';
            countdownNumber.style.fontFamily = '';
            countdownNumber.style.fontSize = '';
            countdownNumber.style.letterSpacing = '';
            countdownNumber.style.textShadow = '';
            
            // üîí MARCAR COUNTDOWN COMO TERMINADO
            countdownActive = false;
            console.log('‚úÖ Countdown completado y limpiado');
            
            // üçé iOS M√ìVIL: Iniciar m√∫sica DESPU√âS del countdown
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isMobileWidth = window.innerWidth <= 768;
            
            if (isIOS && isMobileWidth && window.pendingMusicType && !desafioMusic) {
              console.log('üçé iOS: Iniciando m√∫sica DESPU√âS del countdown para:', window.pendingMusicType);
              await playDesafioMusic(window.pendingMusicType);
              window.pendingMusicType = null; // Limpiar
            }
            
            resolve();
          }, 600);
        }
      }, 700); // ‚è±Ô∏è 0.7 segundos en lugar de 1 segundo
    });
  }
  
  async function createChallengeVideoWithPreload(challengeType = 'default', onReadyCallback = null) {
    // Marcar que estamos precargando
    preloadingChallenge = true;
    
    // Si ya existe, no crear otro
    if (challengeVideoElement) {
      // Si ya existe el video, ejecutar callback inmediatamente
      preloadingChallenge = false;
      executePendingTimers();
      if (onReadyCallback) onReadyCallback();
      return true;
    }
    
    try {
      // Mostrar preloader y esperar a que el video cargue
      const preloadedVideo = await showVideoPreloader(challengeType);
      
      if (preloadedVideo) {
        challengeVideoElement = preloadedVideo;
        challengeVideoElement.className = 'challenge-video-bg';
        challengeVideoElement.autoplay = true;
        
        document.body.appendChild(challengeVideoElement);
        challengeVideoElement.play();
        
        let videoName;
        switch (challengeType) {
            case 'desafioN1':
                videoName = 'fondonegro.mp4';
                break;
            case 'desafioN3':
                videoName = 'fondon3.mp4';
                break;
            case 'desafioPortal':
                videoName = 'fondoportal.mp4';
                break;
            case 'desafioTigre':
                videoName = 'fondotigre.mp4';
                break;
            case 'desafioCaballo':
                videoName = 'fondocaballo.mp4';
                break;
            case 'horoscopeChallenge':
                videoName = 'fondohoroscopo.mp4';
                break;
            case 'desafioFinal':
                videoName = 'fondofinal.mp4';
                break;
            case 'challengeType1':
            case 'challengeType2':
            case 'challengeType3':
                videoName = 'fondochallenge.mp4';
                break;
            case 'clasico':
            case 'menos':
            case 'mas':
                videoName = 'dust.mp4';
                break;
            default:
                videoName = 'fondo2.mp4';
                break;
        }
        console.log(`üé¨ Video de fondo precargado y listo: ${videoName}`);
        
        // Marcar que la precarga termin√≥ y ejecutar timers pendientes
        preloadingChallenge = false;
        executePendingTimers();
        
        // Ejecutar callback despu√©s de que el video est√© listo
        if (onReadyCallback) onReadyCallback();
        
        return true;
      } else {
        console.log('üé¨ Continuando sin video de fondo');
        
        // Marcar que la precarga termin√≥ aunque no haya video
        preloadingChallenge = false;
        executePendingTimers();
        
        // Ejecutar callback aunque no haya video
        if (onReadyCallback) onReadyCallback();
        
        return false;
      }
    } catch (error) {
      console.error('Error en precarga de video:', error);
      
      // Marcar que la precarga termin√≥ aunque haya error
      preloadingChallenge = false;
      executePendingTimers();
      
      // Ejecutar callback aunque haya error
      if (onReadyCallback) onReadyCallback();
      
      return false;
    }
  }
  
  function executePendingTimers() {
    console.log(`üéØ Ejecutando ${pendingTimerCallbacks.length} timers pendientes`);
    const callbacks = [...pendingTimerCallbacks];
    pendingTimerCallbacks = [];
    callbacks.forEach(callback => callback());
  }
  
  function cleanupCountdown() {
    // üßπ FUNCI√ìN DE LIMPIEZA COMPLETA DEL COUNTDOWN
    if (countdownInterval) {
      console.log('üßΩ Limpiando countdown interval activo');
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    countdownActive = false;
    console.log('üîí Countdown limpiado y desbloqueado');
  }
  
  function removeChallengeVideo() {
    if (challengeVideoElement) {
      challengeVideoElement.pause();
      challengeVideoElement.remove();
      challengeVideoElement = null;
      console.log('üé¨ Video de fondo de desaf√≠o removido');
    }
  }
  
  // Funci√≥n helper para limpiar todos los temas de desaf√≠o
  function clearAllChallengeThemes() {
    const bodyEl = document.querySelector('body');
    const statBox = document.getElementById('statBox');
    if(bodyEl) {
      bodyEl.classList.remove('challenge-bg', 'challenge-n2-bg', 'challenge-n3-bg', 'horoscope-bg');
    }
    if(statBox) {
      statBox.classList.remove('challenge-stat', 'challenge-n2-stat', 'challenge-n3-stat');
    }
    
    // LIMPIAR COLORES ESPECIALES DE TARJETAS
    const cardEl = document.getElementById('card');
    if (cardEl) {
      // Remover todas las clases de colores especiales de La Emperatriz y Las Bestias 12
      cardEl.classList.remove(
        'emperatriz-orange', 'emperatriz-cyan', 'emperatriz-crimson', 'emperatriz-turquoise',
        'bestias12-orange', 'bestias12-cyan', 'bestias12-crimson', 'bestias12-turquoise'
      );
      console.log('üßπ Colores especiales de tarjetas limpiados');
    }
    
    // Remover video de fondo si existe
    removeChallengeVideo();
  }
  function beep(freq=440, duration=0.12, type='sine', gain=0.05){
    try {
      ensureAudio(); // Activar AudioContext si est√° suspendido
      
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
      o.stop(audioCtx.currentTime + duration);
    } catch (error) {
      console.error(`‚ùå ERROR en beep() - freq:${freq}:`, error);
      console.log('üîç Estado detallado del error:');
      console.log('- audioCtx:', audioCtx);
      console.log('- audioCtx.state:', audioCtx?.state);
      console.log('- desafioMusic activa:', !!desafioMusic && !desafioMusic?.paused);
    }
  }
  
  // Contador global para beeps secuenciales
  let currentBeepIndex = 0;

  // 10 diferentes composiciones de beep satisfactorias para desaf√≠os m√≥viles
  function playSequentialChallengeBeep() {
    const beepPatterns = [
      // Beep 6: Acordes r√°pidos
      () => {
        // Acorde C mayor
        beep(523, 0.08, 'sine', 0.2);       // C5
        beep(659, 0.08, 'sine', 0.2);       // E5
        beep(784, 0.08, 'sine', 0.2);       // G5
        setTimeout(() => {
          // Acorde F mayor
          beep(698, 0.12, 'sine', 0.3);     // F5
          beep(880, 0.12, 'sine', 0.3);     // A5
          beep(1047, 0.12, 'sine', 0.3);    // C6
        }, 120);
      },
    ];
    
    // Reproducir el beep actual seg√∫n el √≠ndice
    beepPatterns[currentBeepIndex]();
    
    // Incrementar √≠ndice para el pr√≥ximo beep (circular)
    currentBeepIndex = (currentBeepIndex + 1) % 10;
    
    console.log(`üéµ Reproduciendo beep de desaf√≠o #${currentBeepIndex === 0 ? 10 : currentBeepIndex} en m√≥vil`);
  }

  async function soundCorrect(){
    // üö® INTENTAR REACTIVAR AUDIOCONTEXT ANTES DEL BEEP
    try {
      if (audioCtx.state !== 'running') {
        console.log('‚ö†Ô∏è AudioContext suspendido, intentando reactivar...');
        await audioCtx.resume();
        console.log('‚úÖ AudioContext reactivado, nuevo estado:', audioCtx.state);
      }
    } catch (error) {
      console.error('‚ùå Error reactivando AudioContext:', error);
    }
    
    // Usar siempre el sonido sint√©tico para todos los dispositivos (m√≥vil, tablet, desktop)
    // Beep #6: Acordes r√°pidos - C mayor ‚Üí F mayor
    beep(523, 0.08, 'sine', 0.2);       // C5
    beep(659, 0.08, 'sine', 0.2);       // E5
    beep(784, 0.08, 'sine', 0.2);       // G5
    setTimeout(() => {
      // Acorde F mayor
      beep(698, 0.12, 'sine', 0.3);     // F5
      beep(880, 0.12, 'sine', 0.3);     // A5
      beep(1047, 0.12, 'sine', 0.3);    // C6
    }, 120);
  }

  // Pool de audios para celebraci√≥n (similar al de correcto)
  let celebrationSoundPool = [];
  let celebrationSoundIndex = 0;
  
  // Pool de sonidos de felicitaci√≥n (feichanghao, feichangbang, etc.)
  let congratulationSoundPool = [];
  let congratulationSoundIndex = 0;
  const congratulationSounds = ['feichanghao.mp3', 'feichangbang.mp3', 'niubi.mp3', 'tebiehao.mp3'];
  
  function initCelebrationSoundPool() {
    celebrationSoundPool = [];
    for(let i = 0; i < 3; i++) {
      try {
        const audio = new Audio('music/complete.mp3');
        audio.volume = 0.5; // Volumen un poco m√°s alto para celebraci√≥n
        audio.preload = 'auto';
        celebrationSoundPool.push(audio);
      } catch(e) {
        console.log('Error creando audio de celebraci√≥n:', e);
      }
    }
  }
  
  function initCongratulationSoundPool() {
    congratulationSoundPool = [];
    // Crear m√∫ltiples instancias de cada sonido de felicitaci√≥n
    congratulationSounds.forEach(soundFile => {
      for(let i = 0; i < 2; i++) {
        try {
          const audio = new Audio(`music/${soundFile}`);
          audio.preload = 'auto';
          audio.volume = 0.6;
          congratulationSoundPool.push(audio);
        } catch(e) {
          console.log(`Error creando audio ${soundFile}:`, e);
        }
      }
    });
    congratulationSoundIndex = 0;
  }

  // Sonido de celebraci√≥n para x/x correctas
  function soundCelebration(){
    try {
      // Inicializar pools si no existen
      if(celebrationSoundPool.length === 0) {
        initCelebrationSoundPool();
      }
      if(congratulationSoundPool.length === 0) {
        initCongratulationSoundPool();
      }
      
      // Reproducir complete.mp3
      const completeAudio = celebrationSoundPool[celebrationSoundIndex];
      celebrationSoundIndex = (celebrationSoundIndex + 1) % celebrationSoundPool.length;
      
      if(completeAudio) {
        completeAudio.currentTime = 0;
        completeAudio.play().catch(e => {
          console.log('Error reproduciendo complete.mp3:', e);
        });
      }
      
      // Reproducir uno de los sonidos de felicitaci√≥n al azar
      const randomIndex = Math.floor(Math.random() * congratulationSounds.length);
      const congratulationFile = congratulationSounds[randomIndex];
      
      // Buscar una instancia disponible de ese sonido
      const availableAudio = congratulationSoundPool.find(audio => 
        audio.src.includes(congratulationFile) && (audio.paused || audio.ended)
      );
      
      if(availableAudio) {
        availableAudio.currentTime = 0;
        // Peque√±o delay para que no se superpongan completamente
        setTimeout(() => {
          availableAudio.play().catch(e => {
            console.log(`Error reproduciendo ${congratulationFile}:`, e);
          });
        }, 200);
      }
      
    } catch(e) {
      console.log('Error en soundCelebration:', e);
      fallbackCelebrationSound();
    }
  }
  
  function fallbackCelebrationSound() {
    // Sonido sint√©tico de respaldo
    beep(523, 0.14, 'triangle', 0.19); // C5
    setTimeout(() => beep(659, 0.13, 'triangle', 0.17), 60); // E5
    setTimeout(() => beep(784, 0.13, 'triangle', 0.15), 120); // G5
    setTimeout(() => beep(1046, 0.11, 'triangle', 0.13), 180); // C6
    setTimeout(() => beep(1568, 0.09, 'triangle', 0.11), 240); // G6
    setTimeout(() => beep(2093, 0.18, 'triangle', 0.13), 320); // C7
  }
  function soundWrong(){
    // Efecto digital tipo "fart" corto
    // Secuencia descendente y distorsionada
    ensureAudio(); // Activar AudioContext si est√° suspendido
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(110, audioCtx.currentTime);
  o.frequency.linearRampToValueAtTime(55, audioCtx.currentTime + 0.18);
  g.gain.setValueAtTime(0.108, audioCtx.currentTime); // -40%
  g.gain.linearRampToValueAtTime(0.006, audioCtx.currentTime + 0.18); // -40%
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.19);
    // "pop" final
  setTimeout(() => beep(70, 0.07, 'triangle', 0.038), 170); // -40%
  }

  // Datasets de caracteres (igual que en frontend)
function unit2Sample() {
  return [
    ['‰∏Ä','yƒ´','uno','unit2','S'],
    ['‰∫å','√®r','dos','unit2','S'],
    ['‰∏â','sƒÅn','tres','unit2','S'],
    ['Âõõ','s√¨','cuatro','unit2','S'],
    ['‰∫î','w«î','cinco','unit2','S'],
    ['ÂÖ≠','li√π','seis','unit2','S'],
    ['‰∏É','qƒ´','siete','unit2','S'],
    ['ÂÖ´','bƒÅ','ocho','unit2','S'],
    ['‰πù','ji«î','nueve','unit2','S'],
    ['ÂçÅ','sh√≠','diez','unit2','S'],
    ['Ë∞¢Ë∞¢','xi√® xie','gracias','unit2','E'],
    ['‰∏çÂÆ¢Ê∞î','b√∫ k√® qi','de nada','unit2','E'],
    ['ÂØπ‰∏çËµ∑','du√¨ bu q«ê','perd√≥n / lo siento','unit2','E'],
    ['Ê≤°ÂÖ≥Á≥ª','m√©i guƒÅn x√¨','no pasa nada','unit2','E'],
    ['Â§ßÂÆ∂Â•Ω','d√† jiƒÅ h«éo','hola a todos','unit2','E'],
  ];
}

function unit3Sample() {
  return [
    ['‰Ω†','n«ê','t√∫','unit3','P'],
    ['Êàë','w«í','yo','unit3','P'],
    ['ÊòØ','sh√¨','ser','unit3','V'],
    ['Âæà','hƒõn','muy','unit3','E'],
    ['È´òÂÖ¥','gƒÅo x√¨ng','contento / feliz','unit3','A'],
    ['ËÆ§ËØÜ','r√®n shi','conocer','unit3','V'],
    ['Âë¢','ne','part√≠cula de seguimiento','unit3','E'],
    ['Âêó','ma','part√≠cula interrogativa','unit3','E'],
    ['‰πü','yƒõ','tambi√©n','unit3','E'],
    ['ÊÇ®','n√≠n','usted (formal)','unit3','P'],
    ['ÂñúÊ¨¢','x«ê huan','gustar','unit3','V'],
    ['Â≠¶','xu√©','aprender / estudiar','unit3','V'],
    ['Ê±âËØ≠','h√†n y«î','chino (idioma)','unit3','S'],
    ['Â≠¶Áîü','xu√© sheng','estudiante','unit3','S'],
    ['ËÄÅÂ∏à','l«éo shƒ´','profesor','unit3','S'],
    ['ÂÜçËßÅ','z√†i ji√†n','adi√≥s','unit3','E'],
  ];
}

function unit4Sample() {
  return [
    ['Âè´','ji√†o','llamarse / llamar','unit4','V'],
    ['‰ªÄ‰πà','sh√©n me','qu√©','unit4','E'],
    ['ÂêçÂ≠ó','m√≠ng zi','nombre','unit4','S'],
    ['Â§öÂ§ß','du≈ç d√†','qu√© edad / cu√°n grande','unit4','E'],
    ['Â≤Å','su√¨','a√±os (de edad)','unit4','S'],
    ['‰∫∫','r√©n','persona / gente','unit4','S'],
    ['‰∏≠ÂõΩ','Zh≈çng gu√≥','China','unit4','S'],
    ['‰∏ç','b√π','no (negaci√≥n)','unit4','E'],
    ['Âì™','n«é','cu√°l (de) / qu√© lugar','unit4','E'],
  ];
}

function unit5Sample() {
  return [
    ['ÊÉ≥','xi«éng','querer / pensar','unit5','V'],
    ['ÂêÉ','chƒ´','comer','unit5','V'],
    ['ÂÅö','zu√≤','hacer','unit5','V'],
    ['È•≠','f√†n','comida','unit5','S'],
    ['Âñù','hƒì','beber','unit5','V'],
    ['Ëå∂','ch√°','t√©','unit5','S'],
    ['Ê∞¥','shu«ê','agua','unit5','S'],
    ['ÂíñÂï°','kƒÅ fƒìi','caf√© (bebida)','unit5','S'],
    ['ËØ¥','shu≈ç','hablar / decir','unit5','V'],
    ['Âî±','ch√†ng','cantar','unit5','V'],
    ['Ê≠å','gƒì','canci√≥n','unit5','S'],
    ['Áúã','k√†n','ver / mirar','unit5','V'],
    ['‰π¶','sh≈´','libro','unit5','S'],
    ['ÁîµÂΩ±','di√†n y«êng','pel√≠cula','unit5','S'],
    ['ÁîµËßÜÂâß','di√†n sh√¨ j√π','serie de TV','unit5','S'],
    ['Âê¨','tƒ´ng','escuchar','unit5','V'],
    ['Èü≥‰πê','yƒ´n yu√®','m√∫sica','unit5','S'],
    ['ËßÜÈ¢ë','sh√¨ p√≠n','v√≠deo','unit5','S'],
    ['‰Ωú‰∏ö','zu√≤ y√®','tarea','unit5','S'],
  ];
}

function unit6Sample() {
  return [
    ['‰ªñ','tƒÅ','√©l','unit6','P'],
    ['Â•π','tƒÅ','ella','unit6','P'],
    ['‰ª¨','men','sufijo plural','unit6','E'],
    ['Ë∞Å','sh√©i','qui√©n','unit6','E'],
    ['ÁöÑ','de','part√≠cula posesiva','unit6','E'],
    ['ÊúãÂèã','p√©ng you','amigo / amiga','unit6','S'],
    ['Áî∑','n√°n','hombre / masculino','unit6','S'],
    ['Â•≥','n«ö','mujer / femenino','unit6','S'],
    ['Â•≥ÊúãÂèã','n«ö p√©ng you','novia','unit6','S'],
    ['Áî∑ÊúãÂèã','n√°n p√©ng you','novio','unit6','S'],
    ['Áà∏Áà∏','b√† ba','pap√°','unit6','S'],
    ['Â¶àÂ¶à','mƒÅ ma','mam√°','unit6','S'],
    ['Âì•Âì•','gƒì ge','hermano mayor','unit6','S'],
    ['ÂºüÂºü','d√¨ di','hermano menor','unit6','S'],
    ['ÂßêÂßê','jiƒõ jie','hermana mayor','unit6','S'],
    ['Â¶πÂ¶π','m√®i mei','hermana menor','unit6','S'],
    ['ÂÑøÂ≠ê','√©r zi','hijo (var√≥n)','unit6','S'],
    ['Â•≥ÂÑø','n«ö √©r','hija','unit6','S'],
    ['Â∏Ö','shu√†i','guapo','unit6','A'],
    ['ÊºÇ‰∫Æ','pi√†o liang','bonita / guapa','unit6','A'],
    ['ËÅ™Êòé','c≈çng ming','inteligente','unit6','A'],
    ['ËÄÅÂÖ¨','l«éo g≈çng','esposo','unit6','S'],
    ['ËÄÅÂ©Ü','l«éo po','esposa','unit6','S']
  ];
}

function unit7Sample() {
  return [
    ['ÁâπÂà´','t√® bi√©','especialmente / muy','unit7','E'],
    ['ÈùûÂ∏∏','fƒìi ch√°ng','muy / much√≠simo','unit7','E'],
    ['ËßâÂæó','ju√© de','creer / opinar / sentir que','unit7','V'],
    ['ÊÄé‰πàÊ†∑','zƒõn me y√†ng','qu√© tal','unit7','E'],
    ['Â•ΩÁúã','h«éo k√†n','bonito (de ver)','unit7','A'],
    ['Â•ΩÂêÉ','h«éo chƒ´','rico (de comer)','unit7','A'],
    ['Â•ΩÂê¨','h«éo tƒ´ng','agradable de o√≠r','unit7','A'],
    ['ÊúâÊÑèÊÄù','y«íu y√¨ si','interesante','unit7','A'],
    ['Ëøô','zh√®','este / esta','unit7','P'],
    ['ÈÇ£','n√†','ese / esa / aquel','unit7','P'],
    ['‰∏™','g√®','clasificador general','unit7','E'],
    ['Êú¨','bƒõn','clasificador de libros','unit7','E'],
    ['È¶ñ','sh«íu','clasificador de canciones','unit7','E'],
    ['ÊùØ','bƒìi','clasificador: vaso / taza','unit7','E'],
    ['‰∏§','li«éng','dos (contar)','unit7','E'],
  ];
}

function unit8Sample() {
  return [
    ['‰∏∫‰ªÄ‰πà','w√®i sh√©n me','por qu√©','unit8','E'],
    ['Âõ†‰∏∫','yƒ´n w√®i','porque','unit8','E'],
    ['ÊºîÂëò','y«én yu√°n','actor / actriz','unit8','S'],
    ['Ê≠åÊâã','gƒì sh«íu','cantante','unit8','S'],
    ['ÁΩëÁ∫¢','w«éng h√≥ng','influencer','unit8','S'],
    ['ÂèØÁà±','kƒõ √†i','tierno / adorable','unit8','A'],
    ['ÊúâÂêç','y«íu m√≠ng','famoso','unit8','A'],
    ['Êµ™Êº´','l√†ng m√†n','rom√°ntico','unit8','A'],
    ['ÊÑüÂä®‰∫∫','g«én d√≤ng r√©n','conmovedor','unit8','A'],
    ['Ê£í','b√†ng','genial','unit8','A'],
    ['ÈÖ∑','k√π','cool','unit8','A'],
    ['Êúâ','y«íu','haber / tener','unit8','V'],
    ['Âíå','h√©','y (conjunci√≥n)','unit8','E'],
    ['Ê≤°','m√©i','no hay / no tener','unit8','E'],
    ['Âè™','zhƒ´','clasif mascota / solo','unit8','E'],
    ['Áãó','g«íu','perro','unit8|animales','S'],
    ['Áå´','mƒÅo','gato','unit8|animales','S'],
    ['‰∏ë','ch«íu','feo','unit8','A'],
    ['ÁÅ´','hu«í','fuego','unit8','S'],
  ];
}

function unit9Sample() {
  return [
    ['Âú®','z√†i','estar / en','unit9','V'],
    ['ÂÆ∂','jiƒÅ','casa / hogar','unit9','S'],
    ['Â≠¶Ê†°','xu√© xi√†o','escuela','unit9','S'],
    ['ÁîµÂΩ±Èô¢','di√†n y«êng yu√†n','cine','unit9','S'],
    ['ÂïÜÂ∫ó','shƒÅng di√†n','tienda','unit9','S'],
    ['ÂíñÂï°Â∫ó','kƒÅ fƒìi di√†n','cafeter√≠a','unit9','S'],
    ['È•≠Â∫ó','f√†n di√†n','restaurante / hotel','unit9','S'],
    ['Ë∂ÖÂ∏Ç','chƒÅo sh√¨','supermercado','unit9','S'],
    ['ÂÖ¨Âõ≠','g≈çng yu√°n','parque','unit9','S'],
    ['Â∑•‰Ωú','g≈çng zu√≤','trabajar / trabajo','unit9','V'],
    ['‰π∞','m«éi','comprar','unit9','V'],
    ['‰∏úË•ø','d≈çng xi','cosas / objetos','unit9','S'],
    ['ËøôÂÑø','zh√®r','aqu√≠','unit9','P'],
    ['ÈÇ£ÂÑø','n√†r','all√≠','unit9','P'],
    ['Âì™ÂÑø','n«ér','d√≥nde','unit9','E'],
    ['ÊâãÊú∫','sh«íu jƒ´','tel√©fono m√≥vil','unit9','S'],
    ['ÁîµËÑë','di√†n n«éo','computadora','unit9','S'],
    ['Ê∞¥Êûú','shu«ê gu«í','fruta','unit9','S'],
    ['ÂåªÈô¢','yƒ´ yu√†n','hospital','unit9','S'],
    ['‰Ωè','zh√π','vivir','unit9','V'],
  ];
}

// Nivel 2
function unit1N2Sample() {
  return [
    ['Êó©‰∏ä','z«éo shang','por la ma√±ana','unit1N2','S'],
    ['‰∏äÂçà','sh√†ng w«î','media ma√±ana','unit1N2','S'],
    ['‰∏ãÂçà','xi√† w«î','tarde','unit1N2','S'],
    ['Êôö‰∏ä','w«én shang','noche','unit1N2','S'],
    ['‰∏≠Âçà','zh≈çng w«î','mediod√≠a','unit1N2','S'],
    ['‰ªäÂ§©','jƒ´n tiƒÅn','hoy','unit1N2','S'],
    ['ÊòéÂ§©','m√≠ng tiƒÅn','ma√±ana (d√≠a siguiente)','unit1N2','S'],
    ['Áé∞Âú®','xi√†n z√†i','ahora','unit1N2','S'],
    ['‰∏Ä‰ºöÂÑø','y√≠ hu√¨r','un rato','unit1N2','S'],
    ['Âá†ÁÇπ','j«ê di«én','qu√© hora','unit1N2','E'],
    ['Âçä','b√†n','media','unit1N2','S'],
    ['ÂàÜ','fƒìn','minuto','unit1N2','S'],
    ['Áù°Ëßâ','shu√¨ ji√†o','dormir','unit1N2','V'],
    ['‰ªÄ‰πàÊó∂ÂÄô','sh√©n me sh√≠ hou','cu√°ndo','unit1N2','E']
  ];
}

function unit2N2Sample() {
  return [
    ['Â§öÂ∞ë','du≈ç shao','cu√°nto','unit2N2','E'],['Èí±','qi√°n','dinero','unit2N2','S'],['ÊÉ≥Ë¶Å','xi«éng y√†o','querer pedir','unit2N2','V'],['ËØ∑ÈóÆ','q«êng w√®n','disculpe','unit2N2','P'],['ÂùóÈí±','ku√†i qi√°n','pesos','unit2N2','S'],['ÂÖÉ','yu√°n','yuan','unit2N2','S'],['Áôæ','b«éi','cien','unit2N2','S'],['Ë¥µ','gu√¨','caro','unit2N2','A'],['‰æøÂÆú','pi√°n yi','barato','unit2N2','A'],['ÁâõÂ•∂','ni√∫ n«éi','leche','unit2N2','S'],['Â•∂Ëå∂','n«éi ch√°','t√© con leche','unit2N2','S'],['ËØ∑ÂÆ¢','q«êng k√®','invitar','unit2N2','V'],['ËßÅ','ji√†n','ver','unit2N2','V'],['ÂºÄÂßã','kƒÅi sh«ê','empezar','unit2N2','V'],['Âéª','q√π','ir','unit2N2','V'],['ÂõûÂÆ∂','hu√≠ jiƒÅ','volver a casa','unit2N2','V'],['Âêß','ba','part√≠cula sugerencia','unit2N2','P'],['ÁªøËå∂','l«ú ch√°','t√© verde','unit2N2','S'],['Á∫¢Ëå∂','h√≥ng ch√°','t√© rojo','unit2N2','S']
  ];
}

function unit3N2Sample() {
  return [
    ['ÊØî','b«ê','comparado a','unit3N2','V'],['ÊØîËæÉ','b«ê ji√†o','comparar general','unit3N2','V'],['‰∏âÊòéÊ≤ª','sƒÅn m√≠ng zh√¨','s√°ndwich','unit3N2','S'],['ËõãÁ≥ï','d√†n gƒÅo','pastel','unit3N2','S'],['Èù¢ÂåÖ','mi√†n bƒÅo','pan','unit3N2','S'],['ÁÇπÂøÉ','di«én xƒ´n','snack','unit3N2','S'],['‰∏ÄÊ†∑','y√≠ y√†ng','igual','unit3N2','A'],['È´ò','gƒÅo','alto','unit3N2','A'],['ÁüÆ','«éi','bajo','unit3N2','A'],['Â§ß','d√†','grande','unit3N2','A'],['Â∞è','xi«éo','peque√±o','unit3N2','A']
  ];
}

function unit4N2Sample() {
  return [
    ['Âπ¥','ni√°n','a√±o','unit4N2','S'],['Êúà','yu√®','mes','unit4N2','S'],['Âè∑','h√†o','n√∫mero','unit4N2','S'],['Êó•','r√¨','d√≠a','unit4N2','S'],['ÊòüÊúüÂ§©','xƒ´ng qƒ´ tiƒÅn','domingo','unit4N2','S'],['ÊòüÊúüÂÖ≠','xƒ´ng qƒ´ li√π','s√°bado','unit4N2','S'],['Âë®Êú´','zh≈çu m√≤','fin de semana','unit4N2','S'],['ÊòüÊúü','xƒ´ng qƒ´','semana','unit4N2','S'],['ÊòüÊúüÂá†','xƒ´ng qƒ´ j«ê','qu√© d√≠a de la semana','unit4N2','E'],['Âá†Êúà','j«ê yu√®','qu√© mes','unit4N2','E'],['Âá†Âè∑','j«ê h√†o','qu√© n√∫mero','unit4N2','E'],['‰ªäÂπ¥','jƒ´n ni√°n','este a√±o','unit4N2','S'],['ÊòéÂπ¥','m√≠ng ni√°n','el a√±o que viene','unit4N2','S'],['‰∏ã‰∏™','xi√† ge','el siguiente','unit4N2','P'],['ÁîüÊó•','shƒìng r√¨','cumplea√±os','unit4N2','S'],['Âø´‰πê','ku√†i l√®','feliz','unit4N2','A'],['Á©∫','k√≤ng','libre','unit4N2','A'],['Á•ù‰Ω†','zh√π n«ê','te deseo','unit4N2','V']
  ];
}

function unit5N2Sample() {
  return [
    ['Ë∑ü','gƒìn','con','unit5N2','P'],['‰∏ÄËµ∑','y√¨ q«ê','juntos','unit5N2','P'],['ËÆ°Âàí','j√¨ hu√†','plan','unit5N2','S'],['ÊúâÁ©∫','y«íu k√≤ng','tener tiempo libre','unit5N2','A'],['Êù•','l√°i','venir','unit5N2','V'],['Ê≤°ÊúâÁ©∫','m√©i y«íu k√≤ng','no tener tiempo','unit5N2','A']
  ];
}

function unit6N2Sample() {
  return [
    ['ÂæÆ‰ø°','wƒìi x√¨n','WeChat','unit6N2','S'],
    ['‰ø°ÊÅØ','x√¨n xƒ´','mensaje','unit6N2','S'],
    ['Âèë','fƒÅ','enviar','unit6N2','V'],
    ['Âè∑Á†Å','h√†o m«é','n√∫mero','unit6N2','S'],
    ['ÁîµËØù','di√†n hu√†','tel√©fono','unit6N2','S'],
    ['ÊâìÁîµËØù','d«é di√†n hu√†','llamar por tel√©fono','unit6N2','V'],
    ['Áªô','gƒõi','dar','unit6N2','V'],
    ['ÊâãÊú∫Âè∑Á†Å','sh«íu jƒ´ h√†o m«é','n√∫mero de m√≥vil','unit6N2','S'],
    ['ÂΩì','dƒÅng','ser / convertirse','unit6N2','V'],
    ['ÂèØ‰ª•','kƒõ y«ê','poder','unit6N2','V'],
    ['Èõ∂','l√≠ng','cero','unit6N2','S'],
    ['Âπ∫','yƒÅo','uno (en n√∫meros)','unit6N2','S']
  ];
}

function unit7N2Sample() {
  return [
    ['ÈÉΩ','d≈çu','todos','unit7N2','P'],
    ['Áü•ÈÅì','zhƒ´ d√†o','saber','unit7N2','V'],
    ['‰ºö','hu√¨','saber (habilidad)','unit7N2','V'],
    ['‰∏ÄÁÇπÂÑø','y√¨ di«énr','un poco','unit7N2','S'],
    ['‰∏Ä‰∫õ','y√¨ xiƒì','algunos','unit7N2','S'],
    ['ÂºÄËΩ¶','kƒÅi chƒì','conducir','unit7N2','V'],
    ['Áî®','y√≤ng','usar','unit7N2','V'],
    ['Âï§ÈÖí','p√≠ ji«î','cerveza','unit7N2','S'],
    ['Á∫¢ÈÖí','h√≥ng ji«î','vino tinto','unit7N2','S'],
    ['ÁôΩÈÖí','b√°i ji«î','licor blanco','unit7N2','S'],
    ['È•ø','√®','hambriento','unit7N2','A'],
    ['Ê∏¥','kƒõ','sediento','unit7N2','A'],
    ['Á¥Ø','l√®i','cansado','unit7N2','A'],
    ['ÊÄï','p√†','tener miedo','unit7N2','A'],
    ['ÁîüÊ∞î','shƒìngq√¨','enojado','unit7N2','A']
  ];
}

function unit8N2Sample() {
  return [
    ['Ê°åÂ≠ê','zhu≈ç zi','mesa','unit8N2','S'],['‰∏äÈù¢','sh√†ng mi√†n','encima','unit8N2','P'],['‰∏ãÈù¢','xi√† mi√†n','debajo','unit8N2','P'],['Ê§ÖÂ≠ê','y«ê zi','silla','unit8N2','S'],['ÂâçÈù¢','qi√°n mi√†n','delante','unit8N2','P'],['ÂêéÈù¢','h√≤u mi√†n','detr√°s','unit8N2','P'],['‰π¶ÂåÖ','sh≈´ bƒÅo','mochila','unit8N2','S'],['ÈáåÈù¢','l«ê mi√†n','dentro','unit8N2','P'],['Â§ñÈù¢','w√†i mi√†n','fuera','unit8N2','P'],['ÂØπÈù¢','du√¨ mi√†n','enfrente','unit8N2','P'],['Â∑¶Ëæπ','zu«í biƒÅn','izquierda','unit8N2','P'],['Âè≥Ëæπ','y√≤u biƒÅn','derecha','unit8N2','P'],['ÊóÅËæπ','p√°ng biƒÅn','al lado','unit8N2','P'],['ÁõíÂ≠ê','h√© zi','caja','unit8N2','S']
  ];
}

function unit9N2Sample() {
  return [
    ['Â§©Ê∞î','tiƒÅn q√¨','clima','unit9N2','S'],['ÂÜ∑','lƒõng','fr√≠o','unit9N2','A'],['ÁÉ≠','r√®','calor','unit9N2','A'],['Êò®Â§©','zu√≥ tiƒÅn','ayer','unit9N2','S'],['‰∏çÂÜ∑‰∏çÁÉ≠','b√π lƒõng b√π r√®','ni fr√≠o ni calor','unit9N2','A'],['Â§™‰∫Ü','t√†i le','demasiado','unit9N2','A'],['Âåó‰∫¨','bƒõi jƒ´ng','Beijing','unit9N2','S'],['‰∏äÊµ∑','sh√†ng h«éi','Shanghai','unit9N2','S'],['ÂπøÂ∑û','gu«éng zh≈çu','Guangzhou','unit9N2','S'],['È¶ôÊ∏Ø','xiƒÅng g«éng','Hong Kong','unit9N2','S'],['ËΩ¶','chƒì','auto','unit9N2','S'],['ÂÖ¨ÂÖ±Ê±ΩËΩ¶','g≈çng g√≤ng q√¨chƒì','autob√∫s','unit9N2','S'],['Âú∞ÈìÅ','d√¨ tiƒõ','metro','unit9N2','S'],['ÁÅ´ËΩ¶','hu«í chƒì','tren','unit9N2','S'],['Âá∫ÁßüËΩ¶','ch≈´ z≈´ chƒì','taxi','unit9N2','S'],['Êª¥Êª¥','Dƒ´ dƒ´','Didi (app)','unit9N2','S'],['È£ûÊú∫','fƒìi jƒ´','avi√≥n','unit9N2','S'],['Ëàπ','chu√°n','barco','unit9N2','S'],['Âùê','zu√≤','sentarse / viajar en','unit9N2','V'],['È™ë','q√≠','montar','unit9N2','V'],['Ëá™Ë°åËΩ¶','z√¨ x√≠ng chƒì','bicicleta','unit9N2','S'],['Êë©ÊâòËΩ¶','m√≥ tu≈ç chƒì','moto','unit9N2','S']
  ];
}

// Nivel 3
function unit1N3Sample() {
  return [
    ['Áôæ','b«éi','cien','unit1N3','S'],['ÂçÉ','qiƒÅn','mil','unit1N3','S'],['ÂÖ¨Êñ§','g≈çng jƒ´n','kilogramo','unit1N3','S'],['Ê¨°','c√¨','vez','unit1N3','S'],['‰ª∂','ji√†n','pieza / prenda','unit1N3','S'],['Âº†','zhƒÅng','hoja (papel)','unit1N3','S'],['È¢ò','t√≠','pregunta / problema','unit1N3','S'],['ÊúÄ','zu√¨','m√°s / el m√°s','unit1N3','E'],['Âæó','de','part√≠cula de resultado','unit1N3','E'],['Á≠â','dƒõng','esperar','unit1N3','V'],['ÂÜç','z√†i','otra vez','unit1N3','E']
  ];
}

function unit2N3Sample() {
  return [
    ['Ëèú','c√†i','verdura / comida','unit2N3','S'],['È∏°Ëõã','jƒ´ d√†n','huevo','unit2N3','S'],['Á±≥È•≠','m«ê f√†n','arroz','unit2N3|comidas','S'],['ËãπÊûú','p√≠ng gu«í','manzana','unit2N3|fruta','S'],['Ë•øÁìú','xƒ´ guƒÅ','sand√≠a','unit2N3|fruta','S'],['ÁæäËÇâ','y√°ng r√≤u','carne de cordero','unit2N3','S'],['Âçñ','m√†i','vender','unit2N3','V'],['‰π∞','m«éi','comprar','unit2N3','V'],['Ë¶Å','y√†o','querer / necesitar','unit2N3','V'],['ËçØ','y√†o','medicina','unit2N3','S'],['Âñù','hƒì','beber','unit2N3','V'],['È±º','y√∫','pez / pescado','unit2N3|comidas','S']
  ];
}

function unit3N3Sample() {
  return [
    ['ÊàøÈó¥','f√°ng jiƒÅn','habitaci√≥n','unit3N3','S'],['Èó®','m√©n','puerta','unit3N3','S'],['Ë∑Ø','l√π','camino / calle','unit3N3','S'],['ÁÅ´ËΩ¶Á´ô','hu«í chƒì zh√†n','estaci√≥n de tren','unit3N3','S'],['Êú∫Âú∫','jƒ´ ch«éng','aeropuerto','unit3N3','S'],['Ê°åÂ≠ê','zhu≈ç zi','mesa','unit3N3','S'],['Ê§ÖÂ≠ê','y«ê zi','silla','unit3N3','S'],['‰∏ä','sh√†ng','arriba / subir','unit3N3','V'],['‰∏ã','xi√†','abajo / bajar','unit3N3','V'],['Èáå','l«ê','dentro','unit3N3','P'],['Â§ñ','w√†i','fuera','unit3N3','P'],['Ëøë','j√¨n','cerca','unit3N3','A']
  ];
}

function unit4N3Sample() {
  return [
    ['ÊúçÂä°Âëò','f√∫ w√π yu√°n','camarero/a','unit4N3','S'],['ÂÖàÁîü','xiƒÅn sheng','se√±or','unit4N3','S'],['Â∞èÂßê','xi«éo jiƒõ','se√±orita','unit4N3','S'],['‰∏àÂ§´','zh√†ng fu','esposo','unit4N3','S'],['Â≠©Â≠ê','h√°i zi','ni√±o/a','unit4N3','S'],['ÂÆÉ','tƒÅ','el(animal/cosa)','unit4N3','P'],['ÂåªÁîü','yƒ´ shƒìng','doctor','unit4N3','S'],['ÁúºÁùõ','y«én jƒ´ng','ojos','unit4N3','S'],['ÊÄß','x√¨ng','sexo / g√©nero','unit4N3','S'],['Ë∫´‰Ωì','shƒìn t«ê','cuerpo','unit4N3','S'],['ÂêåÂ≠¶','t√≥ng xu√©','compa√±ero de clase','unit4N3','S']
  ];
}

function unit5N3Sample() {
  return [
    ['Âá∫','ch≈´','salir','unit5N3','V'],['Á©ø','chuƒÅn','usar (ropa)','unit5N3','V'],['Ë∑ëÊ≠•','p«éo b√π','correr','unit5N3','V'],['Ê∏∏Ê≥≥','y√≥u y«íng','nadar','unit5N3','V'],['Ë∏¢Ë∂≥ÁêÉ','tƒ´ z√∫ qi√∫','jugar f√∫tbol','unit5N3','V'],['ÊâìÁØÆÁêÉ','d«é l√°n qi√∫','jugar b√°squet','unit5N3','V'],['Ë∑≥Ëàû','ti√†o w«î','bailar','unit5N3','V'],['Áé©','w√°n','jugar','unit5N3','V'],['ÂÆå','w√°n','terminar','unit5N3','V'],['ÂºÄ','kƒÅi','abrir / conducir','unit5N3','V'],['Ëøõ','j√¨n','entrar','unit5N3','V'],['Âêë','xi√†ng','hacia','unit5N3','P'],['Êâæ','zh«éo','buscar','unit5N3','V']
  ];
}

function unit6N3Sample() {
  return [
    ['ÊØè','mƒõi','cada','unit6N3','E'],['Â∞èÊó∂','xi«éo sh√≠','hora','unit6N3','S'],['ÂéªÂπ¥','q√π ni√°n','el a√±o pasado','unit6N3','S'],['Â∑≤Áªè','y«ê jƒ´ng','ya','unit6N3','E'],['‰∫Ü','le','part√≠cula perfectiva','unit6N3','E'],['Ëøá','gu√≤','part√≠cula experiencial','unit6N3','E'],['Ëøò','h√°i','todav√≠a','unit6N3','E'],['Â∞±','ji√π','entonces / solo','unit6N3','E'],['Ê≠£Âú®','zh√®ng z√†i','estar + gerundio','unit6N3','E'],['ÂáÜÂ§á','zh«în b√®i','preparar','unit6N3','V'],['ÂºÄÂßã','kƒÅi sh«ê','empezar','unit6N3','V'],['Êó©‰∏ä','z«éo shang','ma√±ana','unit6N3','S'],['Êò®Â§©','zu√≥ tiƒÅn','ayer','unit6N3','S']
  ];
}

function unit7N3Sample() {
  return [
    ['Êô¥','q√≠ng','soleado','unit7N3','A'],['‰∏ãÈõ®','xi√† y«î','llover','unit7N3','V'],['Èõ™','xuƒõ','nieve','unit7N3','S'],['Èò¥','yƒ´n','nublado','unit7N3','A'],['ÁÉ≠','r√®','caliente','unit7N3','A'],['ÂÜ∑','lƒõng','fr√≠o','unit7N3','A'],['Â§©Ê∞î','tiƒÅn q√¨','clima','unit7N3','S'],['È¢úËâ≤','y√°n s√®','color','unit7N3','S']
  ];
}

function unit8N3Sample() {
  return [
    ['ÁîüÁóÖ','shƒìng b√¨ng','enfermarse','unit8N3','V'],['Á¥Ø','l√®i','cansado','unit8N3','A'],['Âøô','m√°ng','ocupado','unit8N3','A'],['ÊÖ¢','m√†n','lento','unit8N3','A'],['Âø´','ku√†i','r√°pido','unit8N3','A'],['È´òÂÖ¥','gƒÅo x√¨ng','feliz','unit8N3','A'],['ÁùÄÊÄ•','zh√°o j√≠','preocupado','unit8N3','A'],['Ê¨¢Ëøé','huƒÅn y√≠ng','dar la bienvenida','unit8N3','V'],['Â∏åÊúõ','xƒ´ w√†ng','esperar / desear','unit8N3','V'],['Á¨ë','xi√†o','re√≠r','unit8N3','V'],['Áúü','zhƒìn','verdaderamente','unit8N3','E'],['ÊáÇ','d«íng','entender','unit8N3','V'],['ÊÑèÊÄù','y√¨ si','significado','unit8N3','S']
  ];
}

function unit9N3Sample() {
  return [
    ['Êä•Á∫∏','b√†o zh«ê','peri√≥dico','unit9N3','S'],['Â∏ÆÂä©','bƒÅng zh√π','ayudar','unit9N3','V'],['Âà´','bi√©','no (imperativo)','unit9N3','E'],['‰ΩÜÊòØ','d√†n sh√¨','pero','unit9N3','E'],['ËØª','d√∫','leer','unit9N3','V'],['ÂØπ','du√¨','correcto / hacia','unit9N3','A'],['ÂëäËØâ','g√†o su','decir / contar','unit9N3','V'],['ÂõûÁ≠î','hu√≠ d√°','responder','unit9N3','V'],['ÁúãËßÅ','k√†n ji√†n','ver','unit9N3','V'],['ËÄÉËØï','k«éo sh√¨','examen','unit9N3','S'],['ÂèØËÉΩ','kƒõ n√©ng','posible','unit9N3','A'],['ÂèØ‰ª•','kƒõ y«ê','poder','unit9N3','V'],['ÈóÆ','w√®n','preguntar','unit9N3','V'],['ÈóÆÈ¢ò','w√®n t√≠','pregunta / problema','unit9N3','S'],['ËØ¥ËØù','shu≈ç hu√†','hablar','unit9N3','V']
  ];
}



// ========= HOR√ìSCOPO - Los 12 animales =========

// Rata - Colores
function coloresSample() {
  return [
    ['È¢úËâ≤','y√°n s√®','color','colores','S'],
    ['Á∫¢','h√≥ng','rojo','colores','S'],
    ['Ëìù','l√°n','azul','colores','S'],
    ['Áªø','l«ú','verde','colores','S'],
    ['ÈªÑ','hu√°ng','amarillo','colores','S'],
    ['Èªë','hƒìi','negro','colores','S'],
    ['ÁôΩ','b√°i','blanco','colores','S'],
    ['ÁÅ∞','huƒ´','gris','colores','S'],
    ['Ê£ïËâ≤','z≈çng s√®','marr√≥n','colores','S'],
    ['Á≤âËâ≤','fƒõn s√®','rosa','colores','S'],
    ['Á¥´Ëâ≤','z«ê s√®','morado','colores','S'],
    ['Ê©ôËâ≤','ch√©ng s√®','naranja','colores','S'],
    ['ÈáëËâ≤','jƒ´n s√®','dorado','colores','S'],
    ['‰∫Æ','li√†ng','brillante','colores','A'],
    ['Êöó','√†n','oscuro','colores','A'],
    ['Ëâ∫ÊúØ','y√¨ sh√π','arte','colores','S']
  ];
}

// Gallo - Fruta
function frutaSample() {
  return [
    ['Ê∞¥Êûú','shu«ê gu«í','fruta','fruta','S'],
    // ['ËãπÊûú','p√≠ng gu«í','manzana','fruta','S'], // DUPLICADO - ahora en unit2N3|fruta
    ['È¶ôËïâ','xiƒÅng jiƒÅo','banana','fruta','S'],
    ['Ê©ôÂ≠ê','ch√©ng zi','naranja','fruta','S'],
    // ['Ë•øÁìú','xƒ´ guƒÅ','sand√≠a','fruta','S'], // DUPLICADO - ahora en unit2N3|fruta
    ['Ëë°ËêÑ','p√∫ tao','uva','fruta','S'],
    ['ËçâËéì','c«éo m√©i','frutilla','fruta','S'],
    ['Ê¢®','l√≠','pera','fruta','S'],
    ['Ê°ÉÂ≠ê','t√°o zi','durazno','fruta','S'],
    ['Êü†Ê™¨','n√≠ng m√©ng','lim√≥n','fruta','S'],
    ['ËäíÊûú','m√°ng gu«í','mango','fruta','S'],
    ['Ëè†Ëêù','b≈ç lu√≥','pi√±a','fruta','S'],
    ['ÊüöÂ≠ê','y√≤u zi','pomelo','fruta','S'],
    ['ÊûúÊ±Å','gu«í zhƒ´','jugo','fruta','S'],
    ['Áîú','ti√°n','dulce','fruta','A'],
    ['ÈÖ∏','suƒÅn','√°cido','fruta','A'],
    ['Ëã¶','k«î','amargo','fruta','A']
  ];
}

// Conejo - Verdura
function verdurasSample() {
  return [
    ['Ëî¨Ëèú','sh≈´ c√†i','verdura','verduras','S'],
    ['ÂúüË±Ü','t«î d√≤u','papa','verduras','S'],
    ['Ë•øÁ∫¢Êüø','xƒ´ h√≥ng sh√¨','tomate','verduras','S'],
    ['ÈªÑÁìú','hu√°ng guƒÅ','pepino','verduras','S'],
    ['ËÉ°ËêùÂçú','h√∫ lu√≥ bo','zanahoria','verduras','S'],
    ['Ê¥ãËë±','y√°ng c≈çng','cebolla','verduras','S'],
    ['ÁîüËèú','shƒìng c√†i','lechuga','verduras','S'],
    ['ÁôΩËèú','b√°i c√†i','col china','verduras','S'],
    ['Â§ßËíú','d√† su√†n','ajo','verduras','S'],
    ['Á∫¢ËñØ','h√≥ng sh«î','batata/ camote','verduras','S'],
    ['Ë±ÜËÖê','d√≤u fu','tofu','verduras','S'],
    ['ËåÑÂ≠ê','qi√© zi','berenjena','verduras','S'],
    ['Ëæ£Ê§í','l√† jiƒÅo','aj√≠','verduras','S'],
    ['ÂçóÁìú','n√°n guƒÅ','calabaza','verduras','S'],
    ['ÁéâÁ±≥','y√π m«ê','choclo/ ma√≠z','verduras','S'],
    ['Êñ∞È≤ú','xƒ´n xiƒÅn','fresco','verduras','A']
  ];
}

// Cerdo - Comidas
function comidasSample() {
  return [
    ['È•≠','f√†n','comida, arroz','comidas','S'],
    // ['Á±≥È•≠','m«ê f√†n','arroz','comidas','S'], // DUPLICADO - ahora en unit2N3|comidas
    ['Èù¢ÂåÖ','mi√†n bƒÅo','pan','comidas','S'],
    ['Èù¢Êù°','mi√†n ti√°o','fideos','comidas','S'],
    ['ÂåÖÂ≠ê','bƒÅo zi','baozi','comidas','S'],
    ['È•∫Â≠ê','ji«éo zi','dumpling','comidas','S'],
    ['Ê±§','tƒÅng','sopa','comidas','S'],
    ['ËÇâ','r√≤u','carne','comidas','S'],
    // ['È±º','y√∫','pescado','comidas','S'], // DUPLICADO - ahora en unit2N3|comidas
    ['ËõãÁ≥ï','d√†n gƒÅo','pastel','comidas','S'],
    ['‰∏âÊòéÊ≤ª','sƒÅn m√≠ng zh√¨','sandwich','comidas','S'],
    ['Â∑ßÂÖãÂäõ','qi«éo k√® l√¨','chocolate','comidas','S'],
    ['Ê±âÂ†°','h√†n b«éo','hamburguesa','comidas','S'],
    ['Êä´Ëê®','pƒ´ s√†','pizza','comidas','S'],
    ['ÁÇ∏È∏°','zh√° jƒ´','pollo frito','comidas','S'],
    ['Ê≤ôÊãâ','shƒÅ lƒÅ','ensalada','comidas','S'],
    ['ÁÉ§ËÇâ','k«éo r√≤u','carne asada','comidas','S'],
    ['ÂØøÂè∏','sh√≤u sƒ´','sushi','comidas','S'],
    ['Âø´È§ê','ku√†i cƒÅn','comida r√°pida','comidas','S'],
    ['Êñπ‰æøÈù¢','fƒÅng bi√†n mi√†n','fideos instant√°neos','comidas','S']
  ];
}

// Perro - Animales
function animalesSample() {
  return [
    ['Âä®Áâ©','d√≤ng w√π','animal','animales','S'],
    ['Èº†','sh«î','rata','animales','S'],
    ['Áâõ','ni√∫','buey/vaca','animales','S'],
    ['Ëôé','h«î','tigre','animales','S'],
    ['ÂÖî','t√π','conejo','animales','S'],
    ['Èæô','l√≥ng','drag√≥n','animales','S'],
    ['Ëõá','sh√©','serpiente','animales','S'],
    ['È©¨','m«é','caballo','animales','S'],
    ['Áæä','y√°ng','cabra/oveja','animales','S'],
    ['Áå¥','h√≥u','mono','animales','S'],
    ['È∏°','jƒ´','gallo/gallina','animales','S'],
    // ['Áãó','g«íu','perro','animales','S'], // DUPLICADO - ahora en unit8|animales
    ['Áå™','zh≈´','cerdo','animales','S'],
    ['ÁÜäÁå´','xi√≥ng mƒÅo','oso panda','animales','S'],
    ['ÁãÆÂ≠ê','shƒ´ zi','le√≥n','animales','S'],
    ['ÈïøÈ¢àÈπø','ch√°ng j«êng l√π','jirafa','animales','S'],
    ['È≤®È±º','shƒÅ y√∫','tibur√≥n','animales','S'],
    ['Áãº','l√°ng','lobo','animales','S'],
    ['Â§ßÁå©Áå©','d√† xƒ´ng xing','gorila','animales','S'],
    ['Â§ßË±°','d√† xi√†ng','elefante','animales','S'],
    ['È∏ü','ni«éo','p√°jaro','animales','S']
  ];
}

// Caballo - Deportes
function deportesSample() {
  return [
    ['ËøêÂä®','y√πn d√≤ng','deporte','deportes','S'],
    ['Ë∂≥ÁêÉ','z√∫ qi√∫','f√∫tbol','deportes','S'],
    ['ÁØÆÁêÉ','l√°n qi√∫','baloncesto','deportes','S'],
    ['ÁΩëÁêÉ','w«éng qi√∫','tenis','deportes','S'],
    ['‰πí‰πìÁêÉ','pƒ´ng pƒÅng qi√∫','ping pong','deportes','S'],
    ['ÊéíÁêÉ','p√°i qi√∫','voleibol','deportes','S'],
    ['Ê∏∏Ê≥≥','y√≥u y«íng','nadar','deportes','V'],
    ['Ë∑ëÊ≠•','p«éo b√π','correr','deportes','V'],
    ['È™ëËΩ¶','q√≠ chƒì','andar en bicicleta','deportes','V'],
    ['Êâì','d«é','jugar/golpear (deportes)','deportes','V'],
    ['Ë∏¢','tƒ´','patear (jugar f√∫tbol)','deportes','V'],
    ['ÁªÉ‰π†','li√†n x√≠','practicar','deportes','V'],
    ['ÊØîËµõ','b«ê s√†i','partido/competencia','deportes','S'],
    ['ÂÅ•Ë∫´','ji√†n shƒìn','hacer ejercicio','deportes','V'],
    ['ÁêÉÂú∫','qi√∫ ch«éng','cancha','deportes','S'],
    ['Èòü','du√¨','equipo','deportes','S'],
    ['ÂÜ†ÂÜõ','gu√†n j≈´n','campe√≥n','deportes','S'],
    ['Âä™Âäõ','n«î l√¨','esforzarse','deportes','V'],
    ['Â••Ëøê‰ºö','√†o y√πn hu√¨','juegos ol√≠mpicos','deportes','S']
  ];
}

// Buey - Hobbies
function hobbiesSample() {
  return [
    ['Áà±Â•Ω','√†i h√†o','hobby','hobbies','S'],
    ['Áúã‰π¶','k√†n sh≈´','leer libros','hobbies','V'],
    ['ÁúãÁîµÂΩ±','k√†n di√†n y«êng','ver pel√≠culas','hobbies','V'],
    ['Âî±Ê≠å','ch√†ng gƒì','cantar','hobbies','V'],
    ['Ë∑≥Ëàû','ti√†o w«î','bailar','hobbies','V'],
    ['ÁîªÁîª','hu√† hu√†','dibujar/pintar','hobbies','V'],
    ['ÊãçÁÖß','pƒÅi zh√†o','sacar fotos','hobbies','V'],
    ['ÊóÖÊ∏∏','l«ö y√≥u','viajar','hobbies','V'],
    ['ÊâìÊ∏∏Êàè','d«é y√≥u x√¨','jugar videojuegos','hobbies','V'],
    ['Ë¥≠Áâ©','g√≤u w√π','ir de compras','hobbies','V'],
    ['‰∏äÁΩë','sh√†ng w«éng','navegar en internet','hobbies','V'],
    ['ËÅäÂ§©','li√°o tiƒÅn','charlar','hobbies','V'],
    ['Â≠¶ËØ≠Ë®Ä','xu√© y«î y√°n','aprender idioma','hobbies','V'],
    ['Êî∂Ëóè','sh≈çu c√°ng','coleccionar','hobbies','V'],
    ['Âõ≠Ëâ∫','yu√°n y√¨','jardiner√≠a','hobbies','S'],
    ['Ê≠¶ÊúØ','w«î sh√π','artes marciales','hobbies','S'],
    ['Ê°åÊ∏∏','zhu≈ç y√≥u','juego de mesa','hobbies','S']
  ];
}

// Cabra - Ropa
function ropaSample() {
  return [
    ['Ë°£Êúç','yƒ´ fu','ropa','ropa','S'],
    ['Ë£§Â≠ê','k√π zi','pantal√≥n','ropa','S'],
    ['Ë°¨Ë°´','ch√®n shƒÅn','camisa','ropa','S'],
    ['Â§ñÂ•ó','w√†i t√†o','abrigo','ropa','S'],
    ['Èûã','xi√©','zapatos','ropa','S'],
    ['È´òË∑üÈûã','gƒÅo gƒìn xi√©','tacones','ropa','S'],
    ['Ë¢úÂ≠ê','w√† zi','medias','ropa','S'],
    ['ÁöÆÂ∏¶','p√≠ d√†i','cintur√≥n','ropa','S'],
    ['Ë•øË£Ö','xƒ´ zhuƒÅng','traje','ropa','S'],
    ['ËøûË°£Ë£ô','li√°n yƒ´ q√∫n','vestido','ropa','S'],
    ['ÊØõË°£','m√°o yƒ´','sweater','ropa','S'],
    ['Âç´Ë°£','w√®i yƒ´','buzo','ropa','S'],
    ['ËøêÂä®Êúç','y√πn d√≤ng f√∫','ropa deportiva','ropa','S'],
    ['Â∏ΩÂ≠ê','m√†o zi','sombrero/gorra','ropa','S'],
    ['ÁúºÈïú','y«én j√¨ng','lentes / anteojos','ropa','S'],
    ['Á©ø','chuƒÅn','ponerse (ropa)','ropa','V'],
    ['Êà¥','d√†i','poner (accesorios)','ropa','V'],
    ['ËØï','sh√¨','probarse','ropa','V']
  ];
}

// Serpiente - Casa
function casaSample() {
  return [
    ['ÂÆ∂','jiƒÅ','hogar, familia','casa','S'],
    ['ÊàøÂ≠ê','f√°ng zi','casa (edificio)','casa','S'],
    ['ÊàøÈó¥','f√°ng jiƒÅn','habitaci√≥n','casa','S'],
    ['ÂçßÂÆ§','w√≤ sh√¨','dormitorio','casa','S'],
    ['Âé®Êàø','ch√∫ f√°ng','cocina','casa','S'],
    ['ÂÆ¢ÂéÖ','k√® tƒ´ng','sala de estar','casa','S'],
    ['Ê¥óÊâãÈó¥','x«ê sh«íu jiƒÅn','ba√±o','casa','S'],
    ['Èò≥Âè∞','y√°ng t√°i','balc√≥n','casa','S'],
    ['Ëä±Âõ≠','huƒÅ yu√°n','jard√≠n','casa','S'],
    ['Ê°åÂ≠ê','zhu≈ç zi','mesa','casa','S'],
    ['Ê§ÖÂ≠ê','y«ê zi','silla','casa','S'],
    ['Â∫ä','chu√°ng','cama','casa','S'],
    ['Ê≤ôÂèë','shƒÅ fƒÅ','sof√°','casa','S'],
    ['ÁÅØ','dƒìng','l√°mpara','casa','S'],
    ['Èó®','m√©n','puerta','casa','S'],
    ['Á™óÊà∑','chuƒÅng hu','ventana','casa','S'],
    ['ÈïúÂ≠ê','j√¨ng zi','espejo','casa','S'],
    ['ÂÜ∞ÁÆ±','bƒ´ng xiƒÅng','refrigerador','casa','S'],
    ['ÂÆ∂ÂÖ∑','jiƒÅ j√π','muebles','casa','S']
  ];
}

// Mono - Cuerpo
function cuerpoSample() {
  return [
    ['Â§¥','t√≥u','cabeza','cuerpo','S'],
    ['ËÑ∏','li«én','cara','cuerpo','S'],
    ['Â§¥Âèë','t√≥u fa','cabello','cuerpo','S'],
    ['ÁúºÁùõ','y«én jing','ojo','cuerpo','S'],
    ['ÈºªÂ≠ê','b√≠ zi','nariz','cuerpo','S'],
    ['Âò¥','zu«ê','boca','cuerpo','S'],
    ['ËÄ≥Êúµ','ƒõr duo','oreja','cuerpo','S'],
    ['ËÑñÂ≠ê','b√≥ zi','cuello','cuerpo','S'],
    ['ËÇ©ËÜÄ','jiƒÅn b«éng','hombro','cuerpo','S'],
    ['Êâã','sh«íu','mano','cuerpo','S'],
    ['ÊâãÊåá','sh«íu zh«ê','dedo','cuerpo','S'],
    ['ËÉ≥ËÜä','gƒì bo','brazo','cuerpo','S'],
    ['ËÖø','tu«ê','pierna','cuerpo','S'],
    ['ËÑö','ji«éo','pie','cuerpo','S'],
    ['ËÉå','b√®i','espalda','cuerpo','S'],
    ['Áâô','y√°','dientes','cuerpo','S'],
    ['ËàåÂ§¥','sh√© tou','lengua','cuerpo','S'],
    ['ËÇöÂ≠ê','d√π zi','panza','cuerpo','S'],
    ['ÁöÆËÇ§','p√≠ f≈´','piel','cuerpo','S'],
    ['Â£∞Èü≥','shƒìng yƒ´n','voz / sonido','cuerpo','S']
  ];
}

// Tigre - Profesiones
function profesionesSample() {
  return [
    ['ËÄÅÂ∏à','l«éo shƒ´','profesor','profesiones','S'],
    ['Â≠¶Áîü','xu√© shƒìng','estudiante','profesiones','S'],
    ['ÂåªÁîü','yƒ´ shƒìng','doctor','profesiones','S'],
    ['Â∑•‰∫∫','g≈çng r√©n','obrero','profesiones','S'],
    ['Âè∏Êú∫','sƒ´ jƒ´','chofer','profesiones','S'],
    ['Ë≠¶ÂØü','j«êng ch√°','polic√≠a','profesiones','S'],
    ['ÊúçÂä°Âëò','f√∫ w√π yu√°n','mesero','profesiones','S'],
    ['ÁªèÁêÜ','jƒ´ng l«ê','gerente','profesiones','S'],
    ['ÂæãÂ∏à','l«ú shƒ´','abogado','profesiones','S'],
    ['ÂïÜ‰∫∫','shƒÅng r√©n','empresario','profesiones','S'],
    ['Â∑•Á®ãÂ∏à','g≈çng ch√©ng shƒ´','ingeniero','profesiones','S'],
    ['ËÆ∞ËÄÖ','j√¨ zhƒõ','periodista','profesiones','S'],
    ['ÊºîÂëò','y«én yu√°n','actor','profesiones','S'],
    ['Ê≠åÊâã','gƒì sh«íu','cantante','profesiones','S'],
    ['ÁîªÂÆ∂','hu√† jiƒÅ','pintor','profesiones','S'],
    ['Âé®Â∏à','ch√∫ shƒ´','cocinero','profesiones','S'],
    ['Á®ãÂ∫èÂëò','ch√©ng x√π yu√°n','programador','profesiones','S'],
    ['ÁΩëÁ∫¢','w«éng h√≥ng','influencer','profesiones','S']
  ];
}

// Drag√≥n - Emociones
function emocionesSample() {
  return [
    ['È´òÂÖ¥','gƒÅo x√¨ng','feliz','emociones','A'],
    ['Âø´‰πê','ku√†i l√®','alegre','emociones','A'],
    ['ÈöæËøá','n√°n gu√≤','triste','emociones','A'],
    ['ÁîüÊ∞î','shƒìng q√¨','enojado','emociones','A'],
    ['Á¥ßÂº†','j«ên zhƒÅng','nervioso','emociones','A'],
    ['ÂÆ≥ÊÄï','h√†i p√†','asustado','emociones','A'],
    ['ÊãÖÂøÉ','dƒÅn xƒ´n','preocupado','emociones','A'],
    ['Á¥Ø','l√®i','cansado','emociones','A'],
    ['Êó†ËÅä','w√∫ li√°o','aburrido','emociones','A'],
    ['ÊîæÊùæ','f√†ng s≈çng','relajado','emociones','A'],
    ['Êª°ÊÑè','m«én y√¨','satisfecho','emociones','A'],
    ['ÁîüÁóÖ','shƒìng b√¨ng','enfermo','emociones','V'],
    ['ÊÑüÂä®','g«én d√≤ng','conmovido','emociones','A'],
    ['Ëá™‰ø°','z√¨ x√¨n','confiado','emociones','A'],
    ['ÂÆ≥Áæû','h√†i xi≈´','t√≠mido','emociones','A'],
    ['ÁÉ≠ÊÉÖ','r√® q√≠ng','amable','emociones','A'],
    ['Âπ∏Á¶è','x√¨ng f√∫','feliz, dichoso','emociones','A']
  ];
}

// ========= FUNCI√ìN DE INICIALIZACI√ìN AUTOM√ÅTICA =========
// Crea todas las tarjetas desde los datasets cuando localStorage est√° vac√≠o
function initializeAllCharacters() {
  console.log('üîÑ Inicializando todas las tarjetas desde datasets del frontend...');
  
  const allRows = dedupeByHanzi([
    ...unit2Sample(), ...unit3Sample(), ...unit4Sample(), ...unit5Sample(),
    ...unit6Sample(), ...unit7Sample(), ...unit8Sample(), ...unit9Sample(),
    ...unit1N2Sample(), ...unit2N2Sample(), ...unit3N2Sample(), ...unit4N2Sample(),
    ...unit5N2Sample(), ...unit6N2Sample(), ...unit7N2Sample(), ...unit8N2Sample(), ...unit9N2Sample(),
    ...unit1N3Sample(), ...unit2N3Sample(), ...unit3N3Sample(), ...unit4N3Sample(),
    ...unit5N3Sample(), ...unit6N3Sample(), ...unit7N3Sample(), ...unit8N3Sample(), ...unit9N3Sample(),
    ...coloresSample(), ...frutaSample(), ...verdurasSample(), ...comidasSample(),
    ...animalesSample(), ...deportesSample(), ...hobbiesSample(), ...ropaSample(),
    ...casaSample(), ...cuerpoSample(), ...profesionesSample(), ...emocionesSample()
  ]);
  
  const initializedCards = allRows.map(row => ({
    id: uid(),
    hanzi: row[0],
    pinyin: row[1],
    meaning: row[2],
    unit: row[3],
    cat: row[4],
    dkAddedAt: 0,
    revise1: false,
    revise2: false,
    known: false,
    challengeStreak: 0,
    challengeBest: 0,
    lastChallengeAt: 0,
    level: row[3].includes('N3') ? 3 : (row[3].includes('N2') ? 2 : 1)
  }));
  
  console.log(`‚úÖ ${initializedCards.length} tarjetas inicializadas desde datasets`);
  return initializedCards;
}

  // üèÖ Actualizar texto del bot√≥n Niveles de Aprendizaje seg√∫n desaf√≠os completados
  function updateNivelesButtonText() {
    const nivelesText = document.getElementById('nivelesText');
    if (!nivelesText) return;
    
    let medals = '';
    if (desafioN1Completed) medals += 'üèÖ';
    if (desafioN2Completed) medals += 'üèÖ';
    if (desafioN3Completed) medals += 'üèÖ';
    
    if (medals) {
      nivelesText.textContent = `üìñ Coleccionar Caracteres ${medals}`;
    } else {
      nivelesText.textContent = 'üìñ Coleccionar Caracteres';
    }
    
    console.log(`üèÖ Bot√≥n Niveles actualizado con medallas: ${medals || 'ninguna'}`);
  }

  /* ========= Cargas ========= */
  async function loadAll(){
    console.log('üöÄ Iniciando carga completa de la aplicaci√≥n...');
    updateLoadingProgress(10, 'Iniciando sesi√≥n...');
    
    await loadUserState(jwtToken);
    
    // Renderizar barra de XP al final de la carga
    renderXPBar();
    
    // Mostrar SIEMPRE todos los niveles (bloqueados o no)
    setTimeout(() => {
      console.log('üîç Mostrando todos los niveles (estado nivel2Unlocked:', nivel2Unlocked, ', nivel3Unlocked:', nivel3Unlocked, ')');
      console.log('üîç cruzarMarCompleted:', cruzarMarCompleted, '(desbloquea Nivel 2)');
      
      // Determinar si Nivel 2 est√° realmente desbloqueado
      const isNivel2ReallyUnlocked = cruzarMarCompleted || nivel2Unlocked;
      
      // Mostrar siempre Nivel 2
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
      if(nivel2Wrap) {
        nivel2Wrap.style.display = '';
        console.log('‚úÖ nivel2Wrap siempre mostrado');
      }
      if(btnNivel2) {
        btnNivel2.style.display = '';
        console.log('‚úÖ btnNivel2 siempre mostrado');
      }
      if(nivel2ProgressWrap) {
        nivel2ProgressWrap.style.display = isNivel2ReallyUnlocked ? 'flex' : 'none';
        console.log('‚úÖ nivel2ProgressWrap:', isNivel2ReallyUnlocked ? 'mostrado' : 'oculto');
      }

      // Mostrar siempre Nivel 3
      const nivel3Wrap = document.getElementById('nivel3Wrap');
      const btnNivel3 = document.getElementById('btnNivel3');
      const nivel3ProgressWrap = document.getElementById('nivel3ProgressWrap');
      if(nivel3Wrap) {
        nivel3Wrap.style.display = '';
        console.log('‚úÖ nivel3Wrap siempre mostrado');
      }
      if(btnNivel3) {
        btnNivel3.style.display = '';
        console.log('‚úÖ btnNivel3 siempre mostrado');
      }
      if(nivel3ProgressWrap) {
        nivel3ProgressWrap.style.display = nivel3Unlocked ? 'flex' : 'none';
        console.log('‚úÖ nivel3ProgressWrap:', nivel3Unlocked ? 'mostrado' : 'oculto');
      }
    }, 200);
    
    // Actualizar barras de progreso despu√©s de cargar
    setTimeout(() => {
      updateNivelesProgressBars();
      updateHoroscopeProgressBars();
      updateUnitProgressCounters();
    }, 250);
    
    // Asegurar que est√© en el top despu√©s de cargar todo
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 300);
  }

  /* ========= L√≥gica ========= */
  // üéØ Funci√≥n helper: Obtener pool filtrado para unidades normales basado en desbloqueos
  function getPoolForCurrentMission(missionType) {
    console.log(`üîç getPoolForCurrentMission(${missionType}) - N2: ${nivel2Unlocked}, N3: ${nivel3Unlocked}, HSK: ${hskUnlocked}`);
    
    const nivel1Units = ['unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', 'unit10', 'unit11', 'unit12'];
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    
    let allowedUnits = [];
    
    // üéØ Determinar unidades permitidas seg√∫n lo desbloqueado
    // La unidad actual siempre se incluye
    if (hskUnlocked) {
      // Tiene HSK ‚Üí Pool m√°ximo (N1+N2+N3+Hor√≥scopo+HSK)
      allowedUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
      for (let i = 1; i <= 20; i++) {
        allowedUnits.push(`HSK3unit${i}`);
        allowedUnits.push(`HSK4unit${i}`);
      }
      console.log(`‚úÖ Pool HSK: Todas las unidades disponibles`);
    } else if (nivel3Unlocked) {
      // Tiene N3 ‚Üí N1+N2+N3+Hor√≥scopo
      allowedUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
      console.log(`‚úÖ Pool N3: N1+N2+N3+Hor√≥scopo`);
    } else if (nivel2Unlocked) {
      // Tiene N2 ‚Üí N1+N2
      allowedUnits = [...nivel1Units, ...nivel2Units];
      console.log(`‚úÖ Pool N2: N1+N2`);
    } else {
      // Solo N1
      allowedUnits = [...nivel1Units];
      console.log(`‚úÖ Pool N1: Solo Nivel 1`);
    }
    
    // üé¥ Filtrar cartas seg√∫n unidades permitidas
    const filteredCards = cards.filter(c => {
      // Excluir badges del hor√≥scopo
      if (c.isHoroscopeAnimal || c.unit === 'horoscopo') return false;
      
      // Verificar que la carta est√© en las unidades permitidas
      const isInAllowedUnits = allowedUnits.some(u => c.unit.split('|').includes(u));
      return isInAllowedUnits;
    });
    
    console.log(`üì¶ Pool filtrado para ${missionType}: ${filteredCards.length} cartas disponibles`);
    return filteredCards;
  }
  
  // üéØ Funci√≥n helper: Obtener pool din√°mico basado en desbloqueos
  function getDynamicChallengePool(desafioType) {
    console.log(`üîç getDynamicChallengePool(${desafioType}) - N2: ${nivel2Unlocked}, N3: ${nivel3Unlocked}, HSK: ${hskUnlocked}`);
    
    const nivel1Units = ['unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', 'unit10', 'unit11', 'unit12'];
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    
    let allowedUnits = [];
    
    // üéØ DETERMINAR SI SOLO USAMOS CONOCIDAS (para challenge, menos, mas)
    const isClassicChallenge = desafioType === 'challenge' || desafioType === 'menos' || desafioType === 'mas';
    
    // üéØ L√ìGICA DE POOLS DIN√ÅMICOS
    if (desafioType === 'challenge' || desafioType === 'menos' || desafioType === 'mas' || desafioType === 'desafioN3') {
      // Desaf√≠o N3 / Challenge / Menos / Mas: El pool M√ÅS GRANDE posible seg√∫n desbloqueos
      if (hskUnlocked) {
        // Tiene HSK ‚Üí Incluir TODO (N1+N2+N3+Hor√≥scopo+HSK3+HSK4)
        allowedUnits = [
          ...nivel1Units, 
          ...nivel2Units, 
          ...nivel3Units, 
          ...horoscopeUnits
        ];
        // Agregar HSK3 y HSK4
        for (let i = 1; i <= 20; i++) {
          allowedUnits.push(`HSK3unit${i}`);
          allowedUnits.push(`HSK4unit${i}`);
        }
        console.log(`‚úÖ Pool completo: N1+N2+N3+Hor√≥scopo+HSK3+HSK4`);
      } else if (nivel3Unlocked) {
        // NO tiene HSK pero S√ç tiene N3 ‚Üí N1+N2+N3+Hor√≥scopo
        allowedUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
        console.log(`‚úÖ Pool N3: N1+N2+N3+Hor√≥scopo`);
      } else if (nivel2Unlocked) {
        // NO tiene N2 pero S√ç tiene N2 ‚Üí Solo N1+N2
        allowedUnits = [...nivel1Units, ...nivel2Units];
        console.log(`‚úÖ Pool N2: N1+N2`);
      } else {
        // NO tiene N2 ‚Üí Solo N1
        allowedUnits = [...nivel1Units];
        console.log(`‚úÖ Pool N1: Solo Nivel 1`);
      }
    } else if (desafioType === 'desafioN2') {
      // Desaf√≠o N2: Pool de N2 adaptativo
      if (nivel3Unlocked) {
        // Tiene N3 ‚Üí N1+N2+N3
        allowedUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units];
        console.log(`‚úÖ Pool N2 con N3: N1+N2+N3`);
      } else {
        // NO tiene N3 ‚Üí Solo N1+N2
        allowedUnits = [...nivel1Units, ...nivel2Units];
        console.log(`‚úÖ Pool N2: N1+N2`);
      }
    } else if (desafioType === 'desafioN1') {
      // Desaf√≠o N1: Pool de N1 adaptativo
      if (nivel2Unlocked) {
        // Tiene N2 ‚Üí N1+N2
        allowedUnits = [...nivel1Units, ...nivel2Units];
        console.log(`‚úÖ Pool N1 con N2: N1+N2`);
      } else {
        // NO tiene N2 ‚Üí Solo N1
        allowedUnits = [...nivel1Units];
        console.log(`‚úÖ Pool N1: Solo Nivel 1`);
      }
    }
    
    // üé¥ FILTRAR CARTAS: Para challenge/menos/mas SOLO cartas conocidas
    const filteredCards = cards.filter(c => {
      // Excluir badges del hor√≥scopo
      if (c.isHoroscopeAnimal || c.unit === 'horoscopo') return false;
      
      // Verificar que la carta est√© en las unidades permitidas
      const isInAllowedUnits = allowedUnits.some(u => c.unit.split('|').includes(u));
      if (!isInAllowedUnits) return false;
      
      // üî• REGLA CR√çTICA: Para desaf√≠os cl√°sicos, SOLO cartas conocidas
      if (isClassicChallenge && !c.known) return false;
      
      return true;
    });
    
    console.log(`üé¥ Pool din√°mico creado: ${filteredCards.length} cartas para ${desafioType} ${isClassicChallenge ? '(SOLO CONOCIDAS)' : ''}`);
    return filteredCards;
  }

  function buildQueue(type){
      // DEBUG: Log para HSK3
      if(type.startsWith('HSK3')) {
        const filtered = cards.filter(c=>c.unit.split('|').includes(type));
        console.log(`üîç DEBUG buildQueue(${type}):`, filtered.length, 'caracteres encontrados');
        console.log(`üìä Total cards disponibles:`, cards.length);
        console.log(`üéØ Caracteres HSK3 totales:`, cards.filter(c=>c.unit.includes('HSK3')).length);
        if(filtered.length > 0) {
          console.log(`‚úÖ Primeros 3 caracteres de ${type}:`, filtered.slice(0,3).map(c => c.hanzi));
        } else {
          console.log(`‚ùå No se encontraron caracteres para ${type}`);
          console.log(`üìù Ejemplo de units en cards:`, cards.slice(0,5).map(c => c.unit));
        }
      }
      
      // DEBUG: Log para caracteres multi-unidad
      if(type==='unit2N3' || type==='fruta') {
        const filtered = cards.filter(c=>c.unit.split('|').includes(type));
        console.log(`üîç DEBUG buildQueue(${type}):`, filtered.length, 'caracteres');
        filtered.forEach(c => {
          if(c.hanzi === 'ËãπÊûú' || c.hanzi === 'Ë•øÁìú') {
            console.log(`  - ${c.hanzi}: unit="${c.unit}", split:`, c.unit.split('|'));
          }
        });
      }
      
      if(type==='todoN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].some(u=>c.unit.split('|').includes(u))));
      
      // üéØ DESAF√çOS CL√ÅSICOS CON POOLS DIN√ÅMICOS
      if(type==='desafioN1') return shuffle(getDynamicChallengePool('desafioN1')).slice(0,20);
      if(type==='desafioN2') return shuffle(getDynamicChallengePool('desafioN2')).slice(0,20);
      if(type==='desafioN3') return shuffle(getDynamicChallengePool('desafioN3')).slice(0,20);
      if(type==='challenge') return shuffle(getDynamicChallengePool('challenge')).slice(0,10);
      if(type==='menos') return shuffle(getDynamicChallengePool('menos')).slice(0,10);
      if(type==='mas') return shuffle(getDynamicChallengePool('mas')).slice(0,10);
      
      if(type==='unit2') return cards.filter(c=>c.unit.split('|').includes('unit2'));
      if(type==='unit3') return cards.filter(c=>c.unit.split('|').includes('unit3'));
      if(type==='unit4') return cards.filter(c=>c.unit.split('|').includes('unit4'));
      if(type==='unit5') return cards.filter(c=>c.unit.split('|').includes('unit5'));
      if(type==='unit6') return cards.filter(c=>c.unit.split('|').includes('unit6'));
      if(type==='unit7') return cards.filter(c=>c.unit.split('|').includes('unit7'));
      if(type==='unit8') return cards.filter(c=>c.unit.split('|').includes('unit8'));
      if(type==='unit9') return cards.filter(c=>c.unit.split('|').includes('unit9'));
      // Nivel 2
      if(type==='todoN2') return shuffle(cards.filter(c=>[
        'unit1N2','unit2N2','unit3N2','unit4N2','unit5N2','unit6N2','unit7N2','unit8N2','unit9N2'
      ].some(u=>c.unit.split('|').includes(u))));
      if(type==='unit1N2') return cards.filter(c=>c.unit.split('|').includes('unit1N2'));
      if(type==='unit2N2') return cards.filter(c=>c.unit.split('|').includes('unit2N2'));
      if(type==='unit3N2') return cards.filter(c=>c.unit.split('|').includes('unit3N2'));
      if(type==='unit4N2') return cards.filter(c=>c.unit.split('|').includes('unit4N2'));
      if(type==='unit5N2') return cards.filter(c=>c.unit.split('|').includes('unit5N2'));
      if(type==='unit6N2') return cards.filter(c=>c.unit.split('|').includes('unit6N2'));
      if(type==='unit7N2') return cards.filter(c=>c.unit.split('|').includes('unit7N2'));
      if(type==='unit8N2') return cards.filter(c=>c.unit.split('|').includes('unit8N2'));
      if(type==='unit9N2') return cards.filter(c=>c.unit.split('|').includes('unit9N2'));

      // Nivel 3
      if(type==='todoN3') return shuffle(cards.filter(c=>[
        'unit1N3','unit2N3','unit3N3','unit4N3','unit5N3','unit6N3','unit7N3','unit8N3','unit9N3'
      ].some(u=>c.unit.split('|').includes(u))));
      if(type==='unit1N3') return cards.filter(c=>c.unit.split('|').includes('unit1N3'));
      if(type==='unit2N3') return cards.filter(c=>c.unit.split('|').includes('unit2N3'));
      if(type==='unit3N3') return cards.filter(c=>c.unit.split('|').includes('unit3N3'));
      if(type==='unit4N3') return cards.filter(c=>c.unit.split('|').includes('unit4N3'));
      if(type==='unit5N3') return cards.filter(c=>c.unit.split('|').includes('unit5N3'));
      if(type==='unit6N3') return cards.filter(c=>c.unit.split('|').includes('unit6N3'));
      if(type==='unit7N3') return cards.filter(c=>c.unit.split('|').includes('unit7N3'));
      if(type==='unit8N3') return cards.filter(c=>c.unit.split('|').includes('unit8N3'));
      if(type==='unit9N3') return cards.filter(c=>c.unit.split('|').includes('unit9N3'));

      // HSK3 - 20 Unidades
      if(type==='HSK3unit1') return cards.filter(c=>c.unit.split('|').includes('HSK3unit1'));
      if(type==='HSK3unit2') return cards.filter(c=>c.unit.split('|').includes('HSK3unit2'));
      if(type==='HSK3unit3') return cards.filter(c=>c.unit.split('|').includes('HSK3unit3'));
      if(type==='HSK3unit4') return cards.filter(c=>c.unit.split('|').includes('HSK3unit4'));
      if(type==='HSK3unit5') return cards.filter(c=>c.unit.split('|').includes('HSK3unit5'));
      if(type==='HSK3unit6') return cards.filter(c=>c.unit.split('|').includes('HSK3unit6'));
      if(type==='HSK3unit7') return cards.filter(c=>c.unit.split('|').includes('HSK3unit7'));
      if(type==='HSK3unit8') return cards.filter(c=>c.unit.split('|').includes('HSK3unit8'));
      if(type==='HSK3unit9') return cards.filter(c=>c.unit.split('|').includes('HSK3unit9'));
      if(type==='HSK3unit10') return cards.filter(c=>c.unit.split('|').includes('HSK3unit10'));
      if(type==='HSK3unit11') return cards.filter(c=>c.unit.split('|').includes('HSK3unit11'));
      if(type==='HSK3unit12') return cards.filter(c=>c.unit.split('|').includes('HSK3unit12'));
      if(type==='HSK3unit13') return cards.filter(c=>c.unit.split('|').includes('HSK3unit13'));
      if(type==='HSK3unit14') return cards.filter(c=>c.unit.split('|').includes('HSK3unit14'));
      if(type==='HSK3unit15') return cards.filter(c=>c.unit.split('|').includes('HSK3unit15'));
      if(type==='HSK3unit16') return cards.filter(c=>c.unit.split('|').includes('HSK3unit16'));
      if(type==='HSK3unit17') return cards.filter(c=>c.unit.split('|').includes('HSK3unit17'));
      if(type==='HSK3unit18') return cards.filter(c=>c.unit.split('|').includes('HSK3unit18'));
      if(type==='HSK3unit19') return cards.filter(c=>c.unit.split('|').includes('HSK3unit19'));
      if(type==='HSK3unit20') return cards.filter(c=>c.unit.split('|').includes('HSK3unit20'));

      // HSK4 - 20 Unidades
      if(type==='HSK4unit1') return cards.filter(c=>c.unit.split('|').includes('HSK4unit1'));
      if(type==='HSK4unit2') return cards.filter(c=>c.unit.split('|').includes('HSK4unit2'));
      if(type==='HSK4unit3') return cards.filter(c=>c.unit.split('|').includes('HSK4unit3'));
      if(type==='HSK4unit4') return cards.filter(c=>c.unit.split('|').includes('HSK4unit4'));
      if(type==='HSK4unit5') return cards.filter(c=>c.unit.split('|').includes('HSK4unit5'));
      if(type==='HSK4unit6') return cards.filter(c=>c.unit.split('|').includes('HSK4unit6'));
      if(type==='HSK4unit7') return cards.filter(c=>c.unit.split('|').includes('HSK4unit7'));
      if(type==='HSK4unit8') return cards.filter(c=>c.unit.split('|').includes('HSK4unit8'));
      if(type==='HSK4unit9') return cards.filter(c=>c.unit.split('|').includes('HSK4unit9'));
      if(type==='HSK4unit10') return cards.filter(c=>c.unit.split('|').includes('HSK4unit10'));
      if(type==='HSK4unit11') return cards.filter(c=>c.unit.split('|').includes('HSK4unit11'));
      if(type==='HSK4unit12') return cards.filter(c=>c.unit.split('|').includes('HSK4unit12'));
      if(type==='HSK4unit13') return cards.filter(c=>c.unit.split('|').includes('HSK4unit13'));
      if(type==='HSK4unit14') return cards.filter(c=>c.unit.split('|').includes('HSK4unit14'));
      if(type==='HSK4unit15') return cards.filter(c=>c.unit.split('|').includes('HSK4unit15'));
      if(type==='HSK4unit16') return cards.filter(c=>c.unit.split('|').includes('HSK4unit16'));
      if(type==='HSK4unit17') return cards.filter(c=>c.unit.split('|').includes('HSK4unit17'));
      if(type==='HSK4unit18') return cards.filter(c=>c.unit.split('|').includes('HSK4unit18'));
      if(type==='HSK4unit19') return cards.filter(c=>c.unit.split('|').includes('HSK4unit19'));
      if(type==='HSK4unit20') return cards.filter(c=>c.unit.split('|').includes('HSK4unit20'));

      // HOR√ìSCOPO - Los 12 animales
      // HOR√ìSCOPO - Los 12 animales del hor√≥scopo
      if(type==='colores') return cards.filter(c=>c.unit.split('|').includes('colores'));
      if(type==='fruta') return cards.filter(c=>c.unit.split('|').includes('fruta'));
      if(type==='verduras') return cards.filter(c=>c.unit.split('|').includes('verduras'));
      if(type==='comidas') return cards.filter(c=>c.unit.split('|').includes('comidas'));
      if(type==='animales') return cards.filter(c=>c.unit.split('|').includes('animales'));
      if(type==='deportes') return cards.filter(c=>c.unit.split('|').includes('deportes'));
      if(type==='hobbies') return cards.filter(c=>c.unit.split('|').includes('hobbies'));
      if(type==='ropa') return cards.filter(c=>c.unit.split('|').includes('ropa'));
      if(type==='casa') return cards.filter(c=>c.unit.split('|').includes('casa'));
      if(type==='cuerpo') return cards.filter(c=>c.unit.split('|').includes('cuerpo'));
      if(type==='profesiones') return cards.filter(c=>c.unit.split('|').includes('profesiones'));
      if(type==='emociones') return cards.filter(c=>c.unit.split('|').includes('emociones'));

      // DESAF√çOS DEL HOR√ìSCOPO - Solo palabras conocidas de cada categor√≠a (EXCLUIR badges del hor√≥scopo)
      if(type==='desafioColores') return shuffle(cards.filter(c=>c.unit.split('|').includes('colores') && !c.isHoroscopeAnimal));
      if(type==='desafioFruta') return shuffle(cards.filter(c=>c.unit.split('|').includes('fruta') && !c.isHoroscopeAnimal));
      if(type==='desafioVerduras') return shuffle(cards.filter(c=>c.unit.split('|').includes('verduras') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioComidas') return shuffle(cards.filter(c=>c.unit.split('|').includes('comidas') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioAnimales') return shuffle(cards.filter(c=>c.unit.split('|').includes('animales') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioDeportes') return shuffle(cards.filter(c=>c.unit.split('|').includes('deportes') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioHobbies') return shuffle(cards.filter(c=>c.unit.split('|').includes('hobbies') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioRopa') return shuffle(cards.filter(c=>c.unit.split('|').includes('ropa') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioCasa') return shuffle(cards.filter(c=>c.unit.split('|').includes('casa') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioCuerpo') return shuffle(cards.filter(c=>c.unit.split('|').includes('cuerpo') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioProfesiones') return shuffle(cards.filter(c=>c.unit.split('|').includes('profesiones') && c.known && !c.isHoroscopeAnimal)).slice(0,10);
      if(type==='desafioEmociones') return shuffle(cards.filter(c=>c.unit.split('|').includes('emociones') && c.known && !c.isHoroscopeAnimal)).slice(0,10);

      if(type==='known') return shuffle(cards.filter(c=>c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      if(type==='revise1') return shuffle(cards.filter(c=>c.revise1 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      if(type==='revise2') return shuffle(cards.filter(c=>c.revise2 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
      // challenge, menos, mas ya est√°n manejados arriba con getDynamicChallengePool()
      if(type==='emperatriz') {
        // Solo usar Nivel 1, Nivel 2, Nivel 3 y Hor√≥scopo (excluir HSK3 y HSK4)
        const nivel1Units = ['unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9'];
        const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
        const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
        const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
        
        const allowedUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
        const sourceCards = window.challengeCards || cards;
        return shuffle(sourceCards.filter(c => 
          !c.isHoroscopeAnimal && 
          c.unit !== 'horoscopo' && 
          allowedUnits.some(u => c.unit.split('|').includes(u))
        ));
      }
      if(type==='bestias12') return shuffle(cards.filter(c=>['colores','fruta','verduras','comidas','animales','deportes','hobbies','ropa','casa','cuerpo','profesiones','emociones'].some(u=>c.unit.split('|').includes(u)))); // Solo las 12 unidades del hor√≥scopo
      return [];
    }
  document.getElementById('btnDesafioN1').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N1 clickeado!');
    showDesafioNNotification('desafioN1', 'Nivel 1', 'desbloquear el desaf√≠o "Cruzar el Mar" üåä');
  };
  document.getElementById('btnTodoN1').onclick = () => startMission('todoN1');

  // Event listener para el bot√≥n de Desaf√≠o N2
  document.getElementById('btnDesafioN2').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N2 clickeado!');
    showDesafioNNotification('desafioN2', 'Nivel 2', 'desbloquear el desaf√≠o "Cruzar el Cielo" ‚òÅÔ∏è');
  };

  // Event listener para el bot√≥n de Desaf√≠o N3
  document.getElementById('btnDesafioN3').onclick = () => {
    console.log('üéØ DEBUG: Bot√≥n Desaf√≠o N3 clickeado!');
    showDesafioNNotification('desafioN3', 'Nivel 3', 'Pr√≥ximo Nivel (Pr√≥ximamente)');
  };

  // Funci√≥n para controlar la visibilidad de los botones de quiz
  function updateQuizButtonsVisibility(missionType) {
    const quizModeButtons = document.getElementById('quizModeButtons');
    if (!quizModeButtons) return;
    
    console.log('üéØ DEBUG: Actualizando visibilidad botones quiz para misi√≥n:', missionType);
    
    // NEVER show quiz buttons in Ultimate Challenge
    if (missionType === 'ultimateChallenge' || ultimateChallengeActive) {
      console.log('‚ùå Ultimate Challenge activo - ocultando botones de quiz');
      quizModeButtons.classList.add('hidden');
      return;
    }
    
    // NEVER show quiz buttons in Desaf√≠o M√°s/Menos
    if (missionType === 'menos' || missionType === 'mas') {
      console.log('‚ùå Desaf√≠o M√°s/Menos activo - ocultando botones de quiz');
      quizModeButtons.classList.add('hidden');
      return;
    }
    
    // Lista de modos donde S√ç deben aparecer los botones de quiz
    const allowedModes = [
      'known', 'revise1', 'revise2', // Modos b√°sicos
      'unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', // Unidades N1
      'todoN1', // Todo N1
      'unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2','todoN2', // Unidades N2
      'unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3','unit7N3','unit8N3','unit9N3','todoN3', // Unidades N3
      // HSK3 - 20 Unidades
      'HSK3unit1', 'HSK3unit2', 'HSK3unit3', 'HSK3unit4', 'HSK3unit5', 'HSK3unit6', 'HSK3unit7', 'HSK3unit8', 'HSK3unit9', 'HSK3unit10',
      'HSK3unit11', 'HSK3unit12', 'HSK3unit13', 'HSK3unit14', 'HSK3unit15', 'HSK3unit16', 'HSK3unit17', 'HSK3unit18', 'HSK3unit19', 'HSK3unit20',
      // HSK4 - 20 Unidades
      'HSK4unit1', 'HSK4unit2', 'HSK4unit3', 'HSK4unit4', 'HSK4unit5', 'HSK4unit6', 'HSK4unit7', 'HSK4unit8', 'HSK4unit9', 'HSK4unit10',
      'HSK4unit11', 'HSK4unit12', 'HSK4unit13', 'HSK4unit14', 'HSK4unit15', 'HSK4unit16', 'HSK4unit17', 'HSK4unit18', 'HSK4unit19', 'HSK4unit20',
      'colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', // Hor√≥scopo modos normales
      'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'
    ];
    
    if (allowedModes.includes(missionType)) {
      console.log('‚úÖ Mostrando botones de quiz');
      quizModeButtons.classList.remove('hidden');
    } else {
      console.log('‚ùå Ocultando botones de quiz');
      quizModeButtons.classList.add('hidden');
    }
  }

  async function startMission(type){
    // ÔøΩ CHECKPOINT: Guardar antes de cambiar de misi√≥n
    console.log(`üî¥ CHECKPOINT INICIO [startMission(${type})]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
    SaveQueue.flush();
    
    // ÔøΩüîß LIMPIEZA CR√çTICA: Resetear estado de precarga y callbacks pendientes
    if (preloadingChallenge) {
      console.log('üßπ CR√çTICO: Limpiando estado de precarga bloqueado al cambiar de modo');
      preloadingChallenge = false;
      pendingTimerCallbacks = [];
    }
    
    // üîß LIMPIEZA CR√çTICA: Limpiar countdown y desbloquear sistema
    if (countdownActive) {
      console.log('üßπ CR√çTICO: Limpiando countdown activo al cambiar de modo');
      cleanupCountdown();
    }
    
    // üßπ LIMPIEZA CR√çTICA: Limpiar colores especiales de tarjetas al cambiar de modo
    clearAllChallengeThemes();
    
    // Limpiar Ultimate Challenge si est√° activo
    if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
      console.log('üßπ Limpiando Ultimate Challenge al cambiar de modo');
      ultimateChallengeActive = false;
      hideUltimateChallengeHearts();
      stopUltimateChallengeTimer();
    }
    
    // Limpiar sistema de desaf√≠os N si no es un desaf√≠o N
    if (desafioNActive && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3') {
      console.log('üßπ Limpiando sistema de desaf√≠os N al cambiar de modo');
      desafioNActive = false;
      stopDesafioNTimer();
      hideDesafioNHearts();
    }
    
    // Limpiar sistema de desaf√≠os cl√°sicos si no es un desaf√≠o cl√°sico
    if (desafioClasico2Active && type !== 'challenge' && type !== 'clasico' && type !== 'menos' && type !== 'mas') {
      console.log('üßπ Limpiando sistema de desaf√≠os cl√°sicos al cambiar de modo');
      desafioClasico2Active = false;
      stopDesafioClasico2Timer();
      hideDesafioClasico2Hearts();
      disableAssistance(); // Limpiar asistencia al salir del desaf√≠o
    }

    // Limpiar Desaf√≠o La Emperatriz si no es modo emperatriz
    if (emperatrizActive && type !== 'emperatriz') {
      console.log('üßπ Limpiando sistema de La Emperatriz al cambiar de modo');
      emperatrizActive = false;
      clearInterval(emperatrizTimerInterval);
      hideEmperatrizUI();
    }

    // Limpiar Desaf√≠o 12 Bestias si no es modo bestias12
    if (bestias12Active && type !== 'bestias12') {
      console.log('üßπ Limpiando sistema de 12 Bestias al cambiar de modo');
      bestias12Active = false;
      clearInterval(bestias12TimerInterval);
      hideBestias12UI();
    }
    
    // üêæ Limpiar sistema de desaf√≠os N si no es un desaf√≠o N ni del hor√≥scopo
    if (desafioNActive && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3' && !type.startsWith('desafio')) {
      console.log('üßπ Limpiando sistema de desaf√≠os N al cambiar de modo');
      desafioNActive = false;
      stopDesafioNTimer();
      hideDesafioNHearts();
      disableAssistance(); // Limpiar asistencia al salir del desaf√≠o
    }
    
    // ÔøΩ Limpiar asistencia de pr√°ctica al cambiar de misi√≥n
    if (practiceAssistanceEnabled && !['known', 'revise1', 'revise2'].includes(type)) {
      console.log('üßπ Limpiando asistencia de pr√°ctica al cambiar de modo');
      disablePracticeAssistance();
    }
    
    // ÔøΩüéπ Limpiar controles de teclado al cambiar de misi√≥n
    if (window.quizKeyboardHandler) {
      document.removeEventListener('keydown', window.quizKeyboardHandler);
      window.quizKeyboardHandler = null;
      
      // Ocultar indicador de teclado
      const keyboardHint = document.getElementById('keyboardHint');
      if (keyboardHint) {
        keyboardHint.classList.add('hidden');
      }
      
      console.log('üßπ Controles de teclado limpiados al cambiar de misi√≥n');
    }
    
    currentMission = type;
    sessionQueue = buildQueue(type).slice();
    todayReviewed = 0;
    sessionTotal = sessionQueue.length;
    sessionCorrect = 0;

    // Actualizar statMission para desaf√≠os N desde startMission
    console.log('üìã DEBUG: startMission actualizando statMission para type:', type);
    const statMission = document.getElementById('statMission');
    if (statMission && (type === 'desafioN1' || type === 'desafioN2' || type === 'desafioN3')) {
      const desafioNames = {
        'desafioN1': 'Desaf√≠o N1',
        'desafioN2': 'Desaf√≠o N2', 
        'desafioN3': 'Desaf√≠o N3'
      };
      const newText = desafioNames[type] || 'Desaf√≠o N';
      console.log('üìã DEBUG: Actualizando statMission desde startMission - anterior:', statMission.textContent, 'nuevo:', newText);
      statMission.textContent = newText;
      statMission.style.color = '#f2e5b1';
      statMission.style.fontWeight = 'bold';
      statMission.style.fontSize = '14px';
      console.log('üìã DEBUG: statMission actualizado desde startMission:', statMission.textContent);
    }

    // Capturar estado inicial para desaf√≠os
    if (type === 'challenge' || type === 'desafioN1' || type === 'desafioN2' || type === 'desafioN3' || type === 'emperatriz' || type === 'bestias12' || type.startsWith('desafio')) {
      console.log('üì∑ Capturando estado pre-desaf√≠o para:', type);
      capturePreChallengeState();
    }

    // ACTUALIZAR VISIBILIDAD DE BOTONES DE QUIZ
    updateQuizButtonsVisibility(type);

    // LIMPIAR CLASES DE DESAF√çO AL INICIAR CUALQUIER MISI√ìN
    clearAllChallengeThemes();
    // DETENER M√öSICA DE DESAF√çO SI NO ES MODO DESAF√çO
    if(type !== 'challenge' && type !== 'desafioN1' && type !== 'desafioN2' && type !== 'desafioN3' && type !== 'emperatriz' &&  type !== 'bestias12' && !type.startsWith('desafio')) {
      stopDesafioMusic();
    }
    
    // AUTO-SCROLL AL √ÅREA DE JUEGO EN M√ìVIL - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset adicional para Android - asegurar que la barra quede arriba
        setTimeout(() => {
          const rect = xpElement.getBoundingClientRect();
          const offset = rect.top - 10; // 10px de margen superior
          if (offset !== 0) {
            window.scrollBy({ top: offset, behavior: 'smooth' });
          }
        }, 400);
      }
    }, 100);

    // M√∫sica de fondo se inicia en countdown - removido de aqu√≠
    if(type==='challenge' || type==='desafioN1' || type==='desafioN2' || type==='desafioN3' || type==='emperatriz' || type==='bestias12' || type.startsWith('desafio')){
      // playDesafioMusic(type); // ‚ú® MOVIDO AL COUNTDOWN
      setMode(type==='challenge' ? 'quizMeaning' : (Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin'));
      
      // Aplicar tema visual y precargar video seg√∫n tipo de desaf√≠o
      if(type==='desafioN2') {
        bodyEl.classList.add('challenge-n2-bg');
        statBox.classList.add('challenge-n2-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para N2 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(type==='desafioN3') {
        bodyEl.classList.add('challenge-n3-bg');
        statBox.classList.add('challenge-n3-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para N3 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(isHoroscopeChallenge(type)) {
        // Desaf√≠os del hor√≥scopo usan tema monochrome harmony
        bodyEl.classList.add('horoscope-bg');
        statBox.classList.add('challenge-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para hor√≥scopo no hay timer especial en startMission
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(type === 'emperatriz') {
        // Desaf√≠o La Emperatriz - tema especial naranja/dorado
        bodyEl.classList.add('challenge-bg'); // Usar tema morado como base
        statBox.classList.add('challenge-stat');
        // Elegir video seg√∫n el desaf√≠o activo (Emperatriz, Cruzar el Mar, o Cruzar el Cielo)
        let videoType = 'emperatriz'; // Por defecto
        console.log('üîç DEBUG VIDEO: currentChallengeConfig:', currentChallengeConfig);
        console.log('üîç DEBUG VIDEO: currentChallengeConfig.name:', currentChallengeConfig?.name);
        if (currentChallengeConfig) {
          if (currentChallengeConfig.name === 'CRUZAR EL MAR') {
            videoType = 'cruzarMar';
            console.log('‚úÖ DEBUG VIDEO: Seleccionado cruzarMar');
          } else if (currentChallengeConfig.name === 'cruzarCielo') {
            videoType = 'cruzarCielo';
            console.log('‚úÖ DEBUG VIDEO: Seleccionado cruzarCielo');
          } else if (currentChallengeConfig.name === 'Cruzar HSK3') {
            videoType = 'cruzarHSK3';
            console.log('‚úÖ DEBUG VIDEO: Seleccionado cruzarHSK3');
          } else if (currentChallengeConfig.name === 'Cruzar HSK4') {
            videoType = 'cruzarHSK4';
            console.log('‚úÖ DEBUG VIDEO: Seleccionado cruzarHSK4');
          }
        }
        console.log('üé¨ DEBUG VIDEO: videoType final:', videoType);
        await createChallengeVideoWithPreload(videoType, () => {
          // Para La Emperatriz inicializar el juego normalmente
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      } else if(type === 'bestias12') {
        // Desaf√≠o 12 Bestias - tema especial naranja/dorado
        bodyEl.classList.add('challenge-bg'); // Usar tema morado como base
        statBox.classList.add('challenge-stat');
        await createChallengeVideoWithPreload('bestias12', () => {
          // Para 12 Bestias inicializar el juego normalmente
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n        
      } else {
        // challenge, desafioN1 usan tema morado por defecto con video
        bodyEl.classList.add('challenge-bg');
        statBox.classList.add('challenge-stat');
        await createChallengeVideoWithPreload(type, () => {
          // Para challenge/desafioN1 no hay timer especial, solo iniciar juego
          nextCard();
          updateStats();
        });
        return; // Salir temprano para evitar doble ejecuci√≥n
      }
      // Timer y vidas se manejan en startDesafioNWithSystem()
      // Ocultar la tabla de conocidas y cerrar overlay si est√° abierto
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = 'none';
      const knownOverlay = document.getElementById('knownOverlay');
      if(knownOverlay) knownOverlay.remove();
    } else {
      stopDesafioMusic();
      setMode('flash');
      clearAllChallengeThemes();
      // Mostrar la tabla de conocidas
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = '';
    }

    // Iniciar el juego despu√©s de la precarga (para desaf√≠os) o inmediatamente (para otros modos)
    nextCard();
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones al iniciar misi√≥n
  }

// --- Sistema de Timer para Desaf√≠os N1, N2, N3 ---
function startDesafioNTimer() {
  stopDesafioNTimer(); // Limpiar timer anterior
  
  desafioNTimeLeft = 120; // 2 minutos
  console.log('üïê DEBUG: Tiempo configurado:', desafioNTimeLeft);
  showDesafioNTimer();
  
  desafioNTimerInterval = setInterval(() => {
    if (!desafioNActive) {
      stopDesafioNTimer();
      return;
    }
    
    desafioNTimeLeft--;
    updateDesafioNTimer();
    
    if (desafioNTimeLeft <= 0) {
      console.log('‚è∞ Tiempo agotado en desaf√≠o N');
      stopDesafioNTimer();
      
      // Todos los desaf√≠os N usan el modal de desaf√≠o cl√°sico que funciona bien
      showDesafioClasico2Failed('Tiempo agotado');
    }
  }, 1000);
  
  console.log('‚è±Ô∏è Timer de desaf√≠o N iniciado: 2 minutos');
}

function showDesafioNTimer() {
  // Remover timer anterior si existe
  hideDesafioNTimer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'desafioNTimer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateDesafioNTimer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer de desaf√≠o N mostrado');
}

function stopDesafioNTimer() {
  if (desafioNTimerInterval) {
    clearInterval(desafioNTimerInterval);
    desafioNTimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer de desaf√≠o N detenido');
  }
  hideDesafioNTimer();
}

function updateDesafioNTimer() {
  const timerDisplay = document.getElementById('desafioNTimer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(desafioNTimeLeft / 60);
  const seconds = desafioNTimeLeft % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Usar contenido con ancho fijo
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animation = '';
  
  if (desafioNTimeLeft <= 30) {
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animation = 'animation: pulse 1s infinite;';
  } else if (desafioNTimeLeft <= 60) {
    icon = '‚ö†';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
  }
  
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = desafioNTimeLeft <= 30 ? 'pulse 1s infinite' : '';
  timerDisplay.innerHTML = `${icon} ${timeString}`;
}

function hideDesafioNTimer() {
  const timerDisplay = document.getElementById('desafioNTimer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('üôà Timer de desaf√≠o N ocultado');
  }
}

// --- Sistema de Vidas para Desaf√≠os N1, N2, N3 ---
function showDesafioNHearts() {
  console.log('‚ù§Ô∏è DEBUG: showDesafioNHearts iniciado');
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'desafioNHeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas agregado al DOM');
  }
  
  updateDesafioNHearts();
  console.log('‚ù§Ô∏è Vidas de desaf√≠o N mostradas');
}

function updateDesafioNHearts() {
  const heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < desafioNHearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideDesafioNHearts() {
  const heartsContainer = document.getElementById('desafioNHeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
    console.log('üôà Vidas de desaf√≠o N ocultadas');
  }
  
  // ========= DESACTIVAR SISTEMA DE ASISTENCIA =========
  disableAssistance();
}

function loseDesafioNLife() {
  if (desafioNHearts > 0) {
    desafioNHearts--;
    updateDesafioNHearts();
    console.log(`üíÄ Vida perdida en desaf√≠o N! Vidas restantes: ${desafioNHearts}`);
    
    if (desafioNHearts <= 0) {
      console.log('‚ò†Ô∏è Sin vidas en desaf√≠o N');
      stopDesafioNTimer();
      hideDesafioNHearts();
      showDesafioClasico2Failed('Sin vidas restantes');
    }
  }
}

function showDesafioNFailed(razon) {
  // Detener timer y limpiar sistema
  desafioNActive = false;
  stopDesafioNTimer();
  hideDesafioNHearts();
  
  // Detectar si es desaf√≠o del hor√≥scopo para cambiar comportamiento del bot√≥n
  const isHoroscope = isHoroscopeChallenge(currentMission);
  const buttonText = isHoroscope ? 'VOLVER AL MEN√ö' : 'REINTENTAR';
  const buttonAction = isHoroscope ? 
    `this.parentElement.parentElement.remove(); 
     // Limpiar cualquier overlay residual
     document.querySelectorAll('[style*="z-index"]').forEach(el => {
       if (parseInt(el.style.zIndex) > 1000) el.remove();
     });
     // Ir directamente a revise1 (como tocar el bot√≥n revise1)
     document.getElementById('btnRevise1').click();` :
    'this.parentElement.parentElement.remove(); location.reload()';
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    font-family: 'Jersey 10', monospace;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 50%, #7f1d1d 100%);
    border: 3px solid #ef4444;
    padding: 30px;
    text-align: center;
    max-width: 400px;
    margin: 20px;
    box-shadow: 
      0 0 20px rgba(239, 68, 68, 0.5),
      0 0 40px rgba(239, 68, 68, 0.3);
  `;
  
  const title = document.createElement('h2');
  title.style.cssText = `
    color: #fca5a5;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
    margin-bottom: 20px;
  `;
  title.textContent = 'üíÄ DESAF√çO FALLIDO';
  
  const message = document.createElement('p');
  message.style.cssText = `color: #fed7d7; font-size: 16px; margin-bottom: 20px;`;
  message.innerHTML = `<strong>${razon}</strong><br>${isHoroscope ? '¬°Vuelve al men√∫ para seleccionar otro desaf√≠o!' : '¬°Int√©ntalo de nuevo cuando est√©s listo!'}`;
  
  const button = document.createElement('button');
  button.style.cssText = `
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    font-family: 'Jersey 10', monospace;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.3);
  `;
  button.textContent = buttonText;
  
  // Event listeners para el bot√≥n
  button.onmouseover = function() { this.style.transform = 'translateY(-1px)'; };
  button.onmouseout = function() { this.style.transform = 'translateY(0px)'; };
  
  if (isHoroscope) {
    button.onclick = function() {
      modal.remove();
      // üéÆ MOSTRAR UI ELEMENTOS AL FALLAR DESAF√çO HOR√ìSCOPO
      showUIElementsForNormalMode();
      // Limpiar cualquier overlay residual
      document.querySelectorAll('[style*="z-index"]').forEach(el => {
        if (parseInt(el.style.zIndex) > 1000) el.remove();
      });
      // Ir directamente a revise1
      const btnRevise1 = document.getElementById('btnRevise1');
      if (btnRevise1) btnRevise1.click();
    };
  } else {
    button.onclick = function() {
      modal.remove();
      // üéÆ MOSTRAR UI ELEMENTOS AL FALLAR DESAF√çO N
      showUIElementsForNormalMode();
      location.reload();
    };
  }
  
  modalContent.appendChild(title);
  modalContent.appendChild(message);
  modalContent.appendChild(button);
  modal.appendChild(modalContent);
  
  document.body.appendChild(modal);
}
function showDesafioPerdido(){
  let msg = document.getElementById('desafioPerdidoMsg');
  if(!msg){
    msg = document.createElement('div');
    msg.id = 'desafioPerdidoMsg';
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-rose-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.textContent = 'Te has quedado sin tiempo, perdiste el desaf√≠o';
  msg.onclick = () => { location.reload(); };
    document.body.appendChild(msg);
  }
  msg.style.opacity = '1';
}

// --- Sistema de Timer2 para Desaf√≠os Cl√°sicos (clasico, menos, mas) ---
function startDesafioClasico2Timer() {
  stopDesafioClasico2Timer(); // Limpiar timer anterior
  
  desafioClasico2TimeLeft = 90; // 1 minuto y medio
  showDesafioClasico2Timer();
  
  desafioClasico2TimerInterval = setInterval(() => {
    if (!desafioClasico2Active) {
      stopDesafioClasico2Timer();
      return;
    }
    
    desafioClasico2TimeLeft--;
    updateDesafioClasico2Timer();
    
    if (desafioClasico2TimeLeft <= 0) {
      console.log('‚è∞ Tiempo agotado en desaf√≠o cl√°sico');
      stopDesafioClasico2Timer();
      showDesafioClasico2Failed('Tiempo agotado');
    }
  }, 1000);
  
  console.log('‚è±Ô∏è Timer2 de desaf√≠o cl√°sico iniciado: 90 segundos (1:30)');
}

function showDesafioClasico2Timer() {
  // Remover timer anterior si existe
  hideDesafioClasico2Timer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'desafioClasico2Timer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateDesafioClasico2Timer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer2 de desaf√≠o cl√°sico mostrado');
}

function stopDesafioClasico2Timer() {
  if (desafioClasico2TimerInterval) {
    clearInterval(desafioClasico2TimerInterval);
    desafioClasico2TimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer2 de desaf√≠o cl√°sico detenido');
  }
  hideDesafioClasico2Timer();
}

function updateDesafioClasico2Timer() {
  const timerDisplay = document.getElementById('desafioClasico2Timer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(desafioClasico2TimeLeft / 60);
  const seconds = desafioClasico2TimeLeft % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Configurar estilos y animaciones seg√∫n tiempo restante
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animationStyle = '';
  
  if (desafioClasico2TimeLeft <= 15) {
    // üö® ALERTA CR√çTICA: √öltimos 15 segundos - Rojo intenso con pulse
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animationStyle = 'pulse 1s infinite';
    console.log('üö® ALERTA CR√çTICA: ‚â§15 segundos');
  } else if (desafioClasico2TimeLeft <= 30) {
    // ‚ö†Ô∏è ADVERTENCIA: 30 segundos - Naranja/rojo
    icon = '‚ö†Ô∏è';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
    animationStyle = '';
    console.log('‚ö†Ô∏è ADVERTENCIA: ‚â§30 segundos');
  } else {
    // ‚è±Ô∏è NORMAL: M√°s de 30 segundos - Negro
    icon = '‚è±Ô∏è';
    bgStyle = 'rgba(0, 0, 0, 0.8)';
    animationStyle = '';
  }
  
  // Aplicar estilos
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = animationStyle;
  timerDisplay.innerHTML = `${icon} ${timeString}`;
}

function hideDesafioClasico2Timer() {
  const timerDisplay = document.getElementById('desafioClasico2Timer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('üôà Timer2 de desaf√≠o cl√°sico ocultado');
  }
}

// --- Sistema de Vidas2 para Desaf√≠os Cl√°sicos (clasico, menos, mas) ---
function showDesafioClasico2Hearts() {
  console.log('‚ù§Ô∏è DEBUG: showDesafioClasico2Hearts iniciado');
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'desafioClasico2HeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas2 agregado al DOM');
  }
  
  updateDesafioClasico2Hearts();
  console.log('‚ù§Ô∏è Vidas2 de desaf√≠o cl√°sico mostradas');
}

function updateDesafioClasico2Hearts() {
  const heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < desafioClasico2Hearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideDesafioClasico2Hearts() {
  const heartsContainer = document.getElementById('desafioClasico2HeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
    console.log('üôà Vidas2 de desaf√≠o cl√°sico ocultadas');
  }
}

function loseDesafioClasico2Life() {
  if (desafioClasico2Hearts > 0) {
    desafioClasico2Hearts--;
    updateDesafioClasico2Hearts();
    console.log(`üíÄ Vida2 perdida en desaf√≠o cl√°sico! Vidas restantes: ${desafioClasico2Hearts}`);
    
    if (desafioClasico2Hearts <= 0) {
      console.log('‚ò†Ô∏è Sin vidas2 en desaf√≠o cl√°sico');
      stopDesafioClasico2Timer();
      hideDesafioClasico2Hearts();
      showDesafioClasico2Failed('Sin vidas restantes');
    }
  }
}

function showDesafioClasico2Failed(razon) {
  // Detener timer y limpiar sistema
  desafioClasico2Active = false;
  stopDesafioClasico2Timer();
  hideDesafioClasico2Hearts();
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    ">
      <h2 style="
        color: #ff6b6b;
        font-size: 24px;
        margin-bottom: 15px;
        text-shadow: 0 0 8px rgba(255, 107, 107, 0.8);
      ">üíÄ DESAF√çO CL√ÅSICO FALLIDO</h2>
      
      <p style="
        color: #ffffff;
        font-size: 18px;
        margin-bottom: 20px;
        line-height: 1.4;
      ">${razon}</p>
      
      <button onclick="cleanupAndGoToRevise()" style="
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        IR A REPASAR
      </button>
    </div>
  `;
  
  document.body.appendChild(modal); 
  
  // Limpiar flags y asegurar que no hay bloqueos
  desafioClasico2Active = false;
  desafioClasico2Hearts = 2; // Reset para pr√≥ximo intento
  
  // Asegurar que no hay elementos bloqueando la interacci√≥n
  document.body.style.pointerEvents = '';
  document.body.style.overflow = '';
  
  // Limpiar cualquier elemento con pointer-events none que pueda estar bloqueando
  const blockedElements = document.querySelectorAll('[style*="pointer-events: none"]');
  blockedElements.forEach(el => {
    if (el.id === 'cardWrap' || el.id === 'flashRow') {
      el.style.pointerEvents = '';
    }
  });
}

// =============================== FUNCIONES DE LA EMPERATRIZ ===============================

function initEmperatrizUI() {
  console.log('üëë Inicializando UI de La Emperatriz');
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Mostrar HP bar de la jefa
  showEmperatrizHPBar();
  
  // Mostrar timer especial
  showEmperatrizTimer();
  
  // Mostrar vidas del jugador
  showEmperatrizLives();
  
  // Mostrar indicador de poder-ups
  showEmperatrizPowerUpIndicator();
  
  // Mostrar box de power-ups y f√≥rmula de da√±o
  showEmperatrizPowerUpBox();
}

function initBestias12UI() {
  console.log('üê≤ Inicializando UI de Desaf√≠o 12 Bestias');
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Mostrar HP bar de las bestias
  showBestias12HPBar();
  
  // Mostrar timer especial
  showBestias12Timer();
  
  // Mostrar vidas del jugador
  showBestias12Lives();
  
  // Mostrar indicador de poder-ups
  showBestias12PowerUpIndicator();
  
  // Mostrar box de power-ups y f√≥rmula de da√±o
  showBestias12PowerUpBox();
}

function showEmperatrizHPBar() {
  // Remover HP bar anterior si existe
  const existingHP = document.getElementById('emperatrizHPBar');
  if (existingHP) existingHP.remove();
  
  const hpBar = document.createElement('div');
  hpBar.id = 'emperatrizHPBar';
  hpBar.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99998;
    background: rgba(0, 0, 0, 0.9);
    padding: 12px 20px;
    border-radius: 15px;
    border: 2px solid #ff8c42;
    box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
    font-family: 'Jersey 10', monospace;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    min-width: 200px;
  `;
  
  updateEmperatrizHPBar();
  document.body.appendChild(hpBar);
}

function updateEmperatrizHPBar() {
  const hpBar = document.getElementById('emperatrizHPBar');
  if (!hpBar) return;
  
  const maxHP = typeof emperatrizMaxHP === 'number' ? emperatrizMaxHP : 15000;
  const hpPercentage = (emperatrizHP / maxHP) * 100;
  const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
  const titleText = currentChallengeConfig ? `${currentChallengeConfig.emoji} ${currentChallengeConfig.name} ${currentChallengeConfig.emoji}` : 'üëë LA EMPERATRIZ üëë';
  hpBar.innerHTML = `
    <div style="color: #ff8c42; margin-bottom: 6px; font-size: 14px;">${titleText}</div>
    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 4px;">
      <div style="
        background: linear-gradient(90deg, ${hpColor}, ${hpColor}88);
        height: 100%;
        width: ${hpPercentage}%;
        transition: width 0.3s ease;
      "></div>
    </div>
    <div style="color: white; font-size: 20px;">${emperatrizHP} / ${emperatrizMaxHP} HP</div>
    ${emperatrizInvulnerableCards > 0 ? `
    <div style="
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">üõ°Ô∏è INVULNERABLE (${emperatrizInvulnerableCards} cartas)</div>
    ` : ''}
    ${emperatrizAbsorbingDamage > 0 ? `
    <div style="
      background: linear-gradient(135deg, #9f1239, #7f1d1d);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(159, 18, 57, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">ü©∏ ABSORCI√ìN VAMP√çRICA (${emperatrizAbsorbingDamage} turnos)</div>
    ` : ''}
  `;
}

// Variable para almacenar el HP anterior para animaci√≥n
let previousEmperatrizHP = (typeof emperatrizMaxHP === 'number' ? emperatrizMaxHP : 15000);

function animateEmperatrizHPChange(newHP) {
  const hpBar = document.getElementById('emperatrizHPBar');
  if (!hpBar) return;
  
  const hpDisplay = hpBar.querySelector('.hp-number-display');
  if (!hpDisplay) {
    // Si no existe el elemento, crear la estructura inicial
    updateEmperatrizHPBar();
    return;
  }
  
  const startHP = previousEmperatrizHP;
  const endHP = newHP;
  const duration = 800; // 800ms de animaci√≥n
  const startTime = performance.now();
  
  // Detectar si es curaci√≥n y aplicar glow turquesa al box
  const isHealing = endHP > startHP;
  if (isHealing) {
    hpBar.style.animation = 'none';
    void hpBar.offsetWidth; // Forzar reflow
    hpBar.style.animation = 'hpBoxHealGlow 0.8s ease-out';
    setTimeout(() => {
      hpBar.style.animation = '';
    }, 800);
  }
  
  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Funci√≥n de easing (ease-out)
    const easeProgress = 1 - Math.pow(1 - progress, 3);
    
    // Calcular HP actual en la animaci√≥n
    const currentHP = Math.round(startHP + (endHP - startHP) * easeProgress);
    
    // Actualizar solo el n√∫mero, mantener la barra
  const maxHP = typeof emperatrizMaxHP === 'number' ? emperatrizMaxHP : 15000;
  const hpPercentage = (currentHP / maxHP) * 100;
    const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
    
    // Actualizar la barra de progreso
    const progressBar = hpBar.querySelector('.hp-progress-bar');
    if (progressBar) {
      progressBar.style.width = `${hpPercentage}%`;
      progressBar.style.background = `linear-gradient(90deg, ${hpColor}, ${hpColor}88)`;
    }
    
    // Actualizar el n√∫mero con efectos
    const isIncreasing = currentHP > startHP;
    const isDecreasing = currentHP < startHP;
    
    let numberColor = 'white'; // Siempre blanco durante la animaci√≥n
    let numberEffect = '';
    let scaleEffect = 1;
    
    if (isIncreasing && progress < 1) {
      numberColor = '#10b981'; // Verde para curaci√≥n
      numberEffect = 'text-shadow: 0 0 10px rgba(16, 185, 129, 0.8);';
      scaleEffect = 1 + (0.05 * Math.sin(progress * Math.PI)); // Peque√±a pulsaci√≥n
    } else if (isDecreasing && progress < 1) {
      // Para da√±o: mantener blanco, sin efectos especiales durante la animaci√≥n
      numberColor = 'white';
      numberEffect = '';
      scaleEffect = 1; // Sin pulsaci√≥n durante la bajada
    }
    
  hpDisplay.innerHTML = `${currentHP} / ${emperatrizMaxHP} HP`;
    hpDisplay.style.color = numberColor;
    hpDisplay.style.textShadow = isIncreasing && progress < 1 ? numberEffect.replace('text-shadow: ', '').replace(';', '') : 'none';
    hpDisplay.style.transform = `scale(${scaleEffect})`;
    hpDisplay.style.transition = 'transform 0.1s ease';
    
    if (progress < 1) {
      requestAnimationFrame(animate);
    } else {
      // Animaci√≥n completada - agregar efecto "pop"
      const wasDecreasing = endHP < startHP;
      const wasIncreasing = endHP > startHP;
      
      if (wasDecreasing) {
        // Efecto pop para da√±o: r√°pido escalado hacia arriba y vuelta
        hpDisplay.style.transition = 'transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        hpDisplay.style.transform = 'scale(1.15)';
        
        setTimeout(() => {
          hpDisplay.style.transition = 'transform 0.2s ease-out';
          hpDisplay.style.transform = 'scale(1)';
          hpDisplay.style.color = 'white';
          hpDisplay.style.textShadow = 'none';
        }, 150);
      } else if (wasIncreasing) {
        // Efecto pop para curaci√≥n: m√°s suave
        hpDisplay.style.transition = 'transform 0.2s ease-out, color 0.3s ease-out, text-shadow 0.3s ease-out';
        hpDisplay.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
          hpDisplay.style.transform = 'scale(1)';
          hpDisplay.style.color = 'white';
          hpDisplay.style.textShadow = 'none';
        }, 200);
      } else {
        // Sin cambio de HP
        hpDisplay.style.color = 'white';
        hpDisplay.style.textShadow = 'none';
        hpDisplay.style.transform = 'scale(1)';
      }
    }
  }
  
  requestAnimationFrame(animate);
  previousEmperatrizHP = newHP;
}

function updateEmperatrizHPBarImmediate(currentDisplayHP, actualHP) {
  // Actualiza solo la barra de progreso inmediatamente, mantiene los n√∫meros del HP anterior
  const hpBar = document.getElementById('emperatrizHPBar');
  if (!hpBar) return;
  
  // Detectar si hubo da√±o
  const wasDamaged = actualHP < currentDisplayHP;
  
  const maxHP = typeof emperatrizMaxHP === 'number' ? emperatrizMaxHP : 15000;
  const hpPercentage = (actualHP / maxHP) * 100;
  const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
  const titleText = currentChallengeConfig ? `${currentChallengeConfig.emoji} ${currentChallengeConfig.name} ${currentChallengeConfig.emoji}` : 'üëë LA EMPERATRIZ üëë';
  hpBar.innerHTML = `
    <div style="color: #ff8c42; margin-bottom: 6px; font-size: 14px;">${titleText}</div>
    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 4px;">
      <div class="hp-progress-bar" style="
        background: linear-gradient(90deg, ${hpColor}, ${hpColor}88);
        height: 100%;
        width: ${hpPercentage}%;
        transition: width 0.5s ease;
      "></div>
    </div>
    <div class="hp-number-display" style="color: white; font-size: 20px; transition: color 0.2s ease;">${currentDisplayHP} / ${emperatrizMaxHP} HP</div>
    ${emperatrizInvulnerableCards > 0 ? `
    <div style="
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">üõ°Ô∏è INVULNERABLE (${emperatrizInvulnerableCards} cartas)</div>
    ` : ''}
    ${emperatrizAbsorbingDamage > 0 ? `
    <div style="
      background: linear-gradient(135deg, #9f1239, #7f1d1d);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(159, 18, 57, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">ü©∏ ABSORCI√ìN VAMP√çRICA (${emperatrizAbsorbingDamage} turnos)</div>
    ` : ''}
  `;
  
  // Aplicar animaci√≥n de glow rojo al box cuando hay da√±o
  if (wasDamaged) {
    hpBar.style.animation = 'none';
    // Forzar reflow para reiniciar la animaci√≥n
    void hpBar.offsetWidth;
    hpBar.style.animation = 'hpBoxDamageGlow 0.8s ease-out';
    
    // Limpiar la animaci√≥n despu√©s de que termine
    setTimeout(() => {
      hpBar.style.animation = '';
    }, 800);
  }
}

function animateEmperatrizHPNumbers(startHP, endHP) {
  // Anima solo los n√∫meros de HP, no la barra
  const hpBar = document.getElementById('emperatrizHPBar');
  if (!hpBar) return;
  
  const hpDisplay = hpBar.querySelector('.hp-number-display');
  if (!hpDisplay) return;
  
  const duration = 800;
  const startTime = performance.now();
  const wasDecreasing = endHP < startHP;
  
  // Aplicar efecto "pop" inmediatamente al comenzar la animaci√≥n (si es da√±o)
  if (wasDecreasing) {
    hpDisplay.style.transition = 'transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
    hpDisplay.style.transform = 'scale(1.15)';
    
    setTimeout(() => {
      hpDisplay.style.transition = 'transform 0.2s ease-out';
      hpDisplay.style.transform = 'scale(1)';
    }, 150);
  }
  
  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Funci√≥n de easing (ease-out)
    const easeProgress = 1 - Math.pow(1 - progress, 3);
    
    // Calcular HP actual en la animaci√≥n
    const currentHP = Math.round(startHP + (endHP - startHP) * easeProgress);
    
    // Actualizar solo el n√∫mero
    hpDisplay.innerHTML = `${currentHP} / ${emperatrizMaxHP} HP`;
    
    if (progress < 1) {
      requestAnimationFrame(animate);
    }
  }
  
  requestAnimationFrame(animate);
}

function updateEmperatrizHPBar() {
  const hpBar = document.getElementById('emperatrizHPBar');
  if (!hpBar) return;
  
  const maxHP = typeof emperatrizMaxHP === 'number' ? emperatrizMaxHP : 15000;
  const hpPercentage = (emperatrizHP / maxHP) * 100;
  const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
  const titleText = currentChallengeConfig ? `${currentChallengeConfig.emoji} ${currentChallengeConfig.name} ${currentChallengeConfig.emoji}` : 'üëë LA EMPERATRIZ üëë';
  hpBar.innerHTML = `
    <div style="color: #ff8c42; margin-bottom: 6px; font-size: 14px;">${titleText}</div>
    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 4px;">
      <div class="hp-progress-bar" style="
        background: linear-gradient(90deg, ${hpColor}, ${hpColor}88);
        height: 100%;
        width: ${hpPercentage}%;
        transition: width 0.3s ease;
      "></div>
    </div>
    <div class="hp-number-display" style="color: white; font-size: 20px; transition: color 0.2s ease;">${emperatrizHP} / ${emperatrizMaxHP} HP</div>
    ${emperatrizInvulnerableCards > 0 ? `
    <div style="
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">üõ°Ô∏è INVULNERABLE (${emperatrizInvulnerableCards} cartas)</div>
    ` : ''}
    ${emperatrizAbsorbingDamage > 0 ? `
    <div style="
      background: linear-gradient(135deg, #9f1239, #7f1d1d);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 4px;
      box-shadow: 0 0 10px rgba(159, 18, 57, 0.5);
      animation: invulnerablePulse 1s ease-in-out infinite alternate;
    ">ü©∏ ABSORCI√ìN VAMP√çRICA (${emperatrizAbsorbingDamage} turnos)</div>
    ` : ''}
  `;
  
  // Actualizar HP anterior para futuras animaciones
  previousEmperatrizHP = emperatrizHP;
}

function showBestias12HPBar() {
  // Remover HP bar anterior si existe
  const existingHP = document.getElementById('bestias12HPBar');
  if (existingHP) existingHP.remove();
  
  const hpBar = document.createElement('div');
  hpBar.id = 'bestias12HPBar';
  hpBar.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99998;
    background: rgba(0, 0, 0, 0.9);
    padding: 12px 20px;
    border-radius: 15px;
    border: 2px solid #ff8c42;
    box-shadow: 0 4px 15px rgba(255, 140, 66, 0.4);
    font-family: 'Jersey 10', monospace;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    min-width: 200px;
  `;
  
  updateBestias12HPBar();
  document.body.appendChild(hpBar);
}

function animateBestias12HPNumbers(startHP, endHP) {
  // Anima solo los n√∫meros de HP, no la barra
  const hpBar = document.getElementById('bestias12HPBar');
  if (!hpBar) return;
  
  const hpDisplay = hpBar.querySelector('.hp-number-display');
  if (!hpDisplay) return;
  
  const duration = 800;
  const startTime = performance.now();
  const wasDecreasing = endHP < startHP;
  
  // Aplicar efecto "pop" inmediatamente al comenzar la animaci√≥n (si es da√±o)
  if (wasDecreasing) {
    hpDisplay.style.transition = 'transform 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
    hpDisplay.style.transform = 'scale(1.15)';
    
    setTimeout(() => {
      hpDisplay.style.transition = 'transform 0.2s ease-out';
      hpDisplay.style.transform = 'scale(1)';
    }, 150);
  }
  
  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Funci√≥n de easing (ease-out)
    const easeProgress = 1 - Math.pow(1 - progress, 3);
    
    // Calcular HP actual en la animaci√≥n
    const currentHP = Math.round(startHP + (endHP - startHP) * easeProgress);
    
    // Actualizar solo el n√∫mero
    hpDisplay.innerHTML = `${currentHP} / 5000 HP`;
    
    if (progress < 1) {
      requestAnimationFrame(animate);
    }
  }
  
  requestAnimationFrame(animate);
}

function updateBestias12HPBarImmediate(startHP, endHP) {
  // Actualizar la barra inmediatamente pero mantener el n√∫mero inicial para animaci√≥n
  const hpBar = document.getElementById('bestias12HPBar');
  if (!hpBar) return;
  
  // Detectar si hubo da√±o o curaci√≥n
  const wasDamaged = endHP < startHP;
  const wasHealed = endHP > startHP;
  
  const hpPercentage = (endHP / bestias12MaxHP) * 100;
  const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
  
  hpBar.innerHTML = `
    <div style="color: #ff8c42; margin-bottom: 6px; font-size: 14px;">üê≤ DESAF√çO 12 BESTIAS</div>
    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 4px;">
      <div class="hp-progress-bar" style="
        background: linear-gradient(90deg, ${hpColor}, ${hpColor}88);
        height: 100%;
        width: ${hpPercentage}%;
        transition: width 0.3s ease;
      "></div>
    </div>
    <div class="hp-number-display" style="color: white; font-size: 20px;">${startHP} / ${bestias12MaxHP} HP</div>
  `;
  
  // Aplicar animaci√≥n de glow rojo al box cuando hay da√±o
  if (wasDamaged) {
    hpBar.style.animation = 'none';
    void hpBar.offsetWidth;
    hpBar.style.animation = 'hpBoxDamageGlow 0.8s ease-out';
    setTimeout(() => {
      hpBar.style.animation = '';
    }, 800);
  }
  // Aplicar animaci√≥n de glow turquesa al box cuando hay curaci√≥n
  else if (wasHealed) {
    hpBar.style.animation = 'none';
    void hpBar.offsetWidth;
    hpBar.style.animation = 'hpBoxHealGlow 0.8s ease-out';
    setTimeout(() => {
      hpBar.style.animation = '';
    }, 800);
  }
}

function updateBestias12HPBar() {
  const hpBar = document.getElementById('bestias12HPBar');
  if (!hpBar) return;
  
  const hpPercentage = (bestias12HP / bestias12MaxHP) * 100;
  const hpColor = hpPercentage > 60 ? '#22d3ee' : hpPercentage > 30 ? '#f59e0b' : '#ef4444';
  
  hpBar.innerHTML = `
    <div style="color: #ff8c42; margin-bottom: 6px; font-size: 14px;">üê≤ DESAF√çO 12 BESTIAS</div>
    <div style="background: #333; border-radius: 8px; overflow: hidden; height: 12px; margin-bottom: 4px;">
      <div class="hp-progress-bar" style="
        background: linear-gradient(90deg, ${hpColor}, ${hpColor}88);
        height: 100%;
        width: ${hpPercentage}%;
        transition: width 0.3s ease;
      "></div>
    </div>
    <div class="hp-number-display" style="color: white; font-size: 20px;">${bestias12HP} / ${bestias12MaxHP} HP</div>
  `;
}

function showEmperatrizTimer() {
  // Remover timer anterior si existe
  const existingTimer = document.getElementById('emperatrizTimer');
  if (existingTimer) existingTimer.remove();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'emperatrizTimer';
  timerDisplay.style.cssText = `
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 99998;
    background: rgba(0, 0, 0, 0.9);
    color: #22d3ee;
    padding: 12px 20px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid #22d3ee;
    box-shadow: 0 4px 12px rgba(34, 211, 238, 0.4);
    font-family: 'Jersey 10', monospace;
    text-shadow: 1px 1px 0px #0891b2;
    width: 80px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  updateEmperatrizTimer();
  document.body.appendChild(timerDisplay);
}

function updateEmperatrizTimer() {
  const timerDisplay = document.getElementById('emperatrizTimer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(emperatrizTimer / 60);
  const seconds = emperatrizTimer % 60;
  const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
  const timeColor = emperatrizTimer > 120 ? '#22d3ee' : emperatrizTimer > 60 ? '#f59e0b' : '#ef4444';
  
  timerDisplay.style.color = timeColor;
  timerDisplay.style.borderColor = timeColor;
  timerDisplay.innerHTML = `<span style="font-size: 2.2em; line-height: 1;">${timeString}</span>`;
}

function showBestias12Timer() {
  // Remover timer anterior si existe
  const existingTimer = document.getElementById('bestias12Timer');
  if (existingTimer) existingTimer.remove();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'bestias12Timer';
  timerDisplay.style.cssText = `
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 99998;
    background: rgba(0, 0, 0, 0.9);
    color: #22d3ee;
    padding: 12px 20px;
    border-radius: 15px;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid #22d3ee;
    box-shadow: 0 4px 12px rgba(34, 211, 238, 0.4);
    font-family: 'Jersey 10', monospace;
    text-shadow: 1px 1px 0px #0891b2;
    width: 80px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  updateBestias12Timer();
  document.body.appendChild(timerDisplay);
}

function updateBestias12Timer() {
  const timerDisplay = document.getElementById('bestias12Timer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(bestias12Timer / 60);
  const seconds = bestias12Timer % 60;
  const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  
  const timeColor = bestias12Timer > 120 ? '#22d3ee' : bestias12Timer > 60 ? '#f59e0b' : '#ef4444';
  
  timerDisplay.style.color = timeColor;
  timerDisplay.style.borderColor = timeColor;
  timerDisplay.innerHTML = `<span style="font-size: 2.2em; line-height: 1;">${timeString}</span>`;
}

function showEmperatrizPowerUpIndicator() {
  // OCULTO: No mostrar indicador de power-up seg√∫n solicitud del usuario
  // Remover indicador si existe
  const existing = document.getElementById('emperatrizPowerUpIndicator');
  if (existing) existing.remove();
}

function updateEmperatrizPowerUpIndicator() {
  const indicator = document.getElementById('emperatrizPowerUpIndicator');
  if (!indicator) return;
  
  const cardsUntilPowerUp = 5 - (emperatrizCardsAnswered % 5);
  
  indicator.innerHTML = `
    <div>üí™ Poder en: ${cardsUntilPowerUp}</div>
    <div style="font-size: 12px; margin-top: 2px;">Nivel: ${emperatrizLevel}</div>
  `;
}

function showBestias12PowerUpIndicator() {
  // OCULTO: No mostrar indicador de power-up seg√∫n solicitud del usuario
  // Remover indicador si existe
  const existing = document.getElementById('bestias12PowerUpIndicator');
  if (existing) existing.remove();
}

function updateBestias12PowerUpIndicator() {
  const indicator = document.getElementById('bestias12PowerUpIndicator');
  if (!indicator) return;
  
  const cardsUntilPowerUp = 5 - (bestias12CardsAnswered % 5);
  
  indicator.innerHTML = `
    <div>üí™ Poder en: ${cardsUntilPowerUp}</div>
    <div style="font-size: 12px; margin-top: 2px;">Nivel: ${bestias12Level}</div>
  `;
}

function startEmperatrizTimer() {
  // Limpiar timer anterior
  if (emperatrizTimerInterval) {
    clearInterval(emperatrizTimerInterval);
    emperatrizTimerInterval = null;
  }
  
  emperatrizTimerInterval = setInterval(() => {
    if (!emperatrizActive) {
      clearInterval(emperatrizTimerInterval);
      emperatrizTimerInterval = null;
      return;
    }
    
    emperatrizTimer--;
    updateEmperatrizTimer();
    
    if (emperatrizTimer <= 0) {
      console.log('üëë Tiempo agotado en Desaf√≠o La Emperatriz');
      emperatrizTimeOut();
    }
  }, 1000);
  
  console.log('üëë Timer de La Emperatriz iniciado: 300 segundos (5:00)');
}

function startBestias12Timer() {
  // Limpiar timer anterior
  if (bestias12TimerInterval) {
    clearInterval(bestias12TimerInterval);
    bestias12TimerInterval = null;
  }
  
  bestias12TimerInterval = setInterval(() => {
    if (!bestias12Active) {
      clearInterval(bestias12TimerInterval);
      bestias12TimerInterval = null;
      return;
    }
    
    bestias12Timer--;
    updateBestias12Timer();
    
    if (bestias12Timer <= 0) {
      console.log('üê≤ Tiempo agotado en Desaf√≠o 12 Bestias');
      bestias12TimeOut();
    }
  }, 1000);
  
  console.log('üê≤ Timer de 12 Bestias iniciado: 300 segundos (5:00)');
}

function emperatrizTimeOut() {
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  // Ocultar solo HUD, mantener m√∫sica/fondo hasta que el usuario confirme
  hideEmperatrizUI({ deferCleanup: true });
  
  showEmperatrizResult(false, 'Tiempo agotado');
}

function bestias12TimeOut() {
  bestias12Active = false;
  clearInterval(bestias12TimerInterval);
  hideBestias12UI();
  
  showBestias12Result(false, 'Tiempo agotado');
}

function hideEmperatrizUI() {
  const elements = ['emperatrizHPBar', 'emperatrizTimer', 'emperatrizPowerUpIndicator', 'emperatrizLives', 'emperatrizPowerUpBox'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });
  
  // ========= DESACTIVAR SISTEMA DE ASISTENCIA =========
  disableAssistance();
  
  // ÔøΩ RESTAURAR CARTAS ORIGINALES si fueron filtradas
  if (window.originalCards) {
    console.log('üé¥ Restaurando pool de cartas original');
    cards = [...window.originalCards];
    window.originalCards = null;
  }
  
  // ÔøΩüéÆ MOSTRAR UI ELEMENTOS AL SALIR DEL DESAF√çOs EMPERATRIZ
  showUIElementsForNormalMode();
}

// Funci√≥n para limpiar estado de desaf√≠os boss
function cleanupBossChallenge() {
  // üé¥ LIMPIAR POOL TEMPORAL DE CARTAS (NO restaurar, solo limpiar)
  if (window.challengeCards) {
    console.log('üé¥ Limpiando pool temporal de cartas del desaf√≠o');
    window.challengeCards = null;
  }
  
  // üé® RESTAURAR FONDO ORIGINAL
  changeGameBackground('restore');
  
  // REMOVER VIDEO DE FONDO DEL DESAF√çO
  removeChallengeVideo();
  
  // DETENER M√öSICA ESPECIAL si existe
  if (window.currentGameAudio) {
    console.log('üîá Deteniendo m√∫sica del desaf√≠o boss');
    window.currentGameAudio.pause();
    window.currentGameAudio.currentTime = 0;
    window.currentGameAudio = null;
  }
  
  // DETENER M√öSICA DE DESAF√çO
  console.log('üîá Deteniendo m√∫sica de desaf√≠o (desafioMusic)');
  stopDesafioMusic();
  
  // üîÑ RESETEAR CONFIGURACI√ìN DEL DESAF√çO
  currentChallengeConfig = null;
  
  console.log('üßπ Estado del desaf√≠o boss limpiado completamente');
}

// Funci√≥n hideEmperatrizUI mejorada que incluye limpieza completa
function hideEmperatrizUI(options = {}) {
  const { deferCleanup = false } = options;
  const elements = ['emperatrizHPBar', 'emperatrizTimer', 'emperatrizPowerUpIndicator', 'emperatrizLives', 'emperatrizPowerUpBox'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });

  if (deferCleanup) {
    // No restaurar m√∫sica/fondo/cartas todav√≠a; se har√° al salir del modal
    console.log('‚è∏Ô∏è Limpieza diferida de Emperatriz: manteniendo m√∫sica y fondo hasta confirmar salida');
    // ========= DESACTIVAR SISTEMA DE ASISTENCIA INCLUSO EN MODO DIFERIDO =========
    disableAssistance();
    return;
  }

  // ========= DESACTIVAR SISTEMA DE ASISTENCIA =========
  disableAssistance();

  // Restaurar cartas originales si fueron filtradas por otros modos
  if (window.originalCards) {
    console.log('üé¥ Restaurando pool de cartas original');
    cards = [...window.originalCards];
    window.originalCards = null;
  }

  // üßπ LIMPIAR ESTADO DEL DESAF√çO BOSS (detiene m√∫sica y restaura fondo)
  cleanupBossChallenge();

  // üéÆ MOSTRAR UI ELEMENTOS AL SALIR DEL DESAF√çO
  showUIElementsForNormalMode();
}

function hideBestias12UI() {
  const elements = ['bestias12HPBar', 'bestias12Timer', 'bestias12PowerUpIndicator', 'bestias12Lives', 'bestias12PowerUpBox'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });
  
  // ========= DESACTIVAR SISTEMA DE ASISTENCIA =========
  disableAssistance();
  
  // üéÆ MOSTRAR UI ELEMENTOS AL SALIR DEL DESAF√çO BESTIAS 12
  showUIElementsForNormalMode();
}

// Funciones auxiliares que faltan para bestias12 (referencias simples)
function showBestias12Lives() {
  // Duplicar l√≥gica de showEmperatrizLives pero con IDs de bestias12
  const existingLives = document.getElementById('bestias12Lives');
  if (existingLives) existingLives.remove();
  
  const livesDisplay = document.createElement('div');
  livesDisplay.id = 'bestias12Lives';
  livesDisplay.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99998;
    background: rgba(0, 0, 0, 0.8);
    color: #f472b6;
    padding: 8px 12px;
    border-radius: 8px;
    font-family: 'Jersey 10', monospace;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid #f472b6;
    box-shadow: 0 4px 8px rgba(244, 114, 182, 0.3);
    text-shadow: 1px 1px 0px #be185d;
  `;
  updateBestias12LivesDisplay(livesDisplay);
  
  document.body.appendChild(livesDisplay);
}

function updateBestias12LivesDisplay(livesEl = null) {
  if (!livesEl) {
    livesEl = document.getElementById('bestias12Lives');
  }
  if (livesEl) {
    const hearts = 'ü©∑'.repeat(bestias12Lives);
    livesEl.innerHTML = hearts;
  }
}

function showBestias12PowerUpBox() {
  // Remover box anterior si existe
  const existingBox = document.getElementById('bestias12PowerUpBox');
  if (existingBox) existingBox.remove();
  
  const powerUpBox = document.createElement('div');
  powerUpBox.id = 'bestias12PowerUpBox';
  powerUpBox.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99997;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.9));
    border: 2px solid #22c55e;
    border-radius: 12px;
    padding: ${isMobile() ? '10px' : '15px'};
    max-width: 90%;
    width: ${isMobile() ? '95%' : '600px'};
    max-height: ${isMobile() ? '120px' : 'auto'};
    overflow-y: ${isMobile() ? 'auto' : 'visible'};
    font-family: 'Jersey 10', monospace;
    font-size: ${isMobile() ? '12px' : '14px'};
    color: white;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  `;
  
  updateBestias12PowerUpBox(powerUpBox);
  document.body.appendChild(powerUpBox);
}

function updateBestias12PowerUpBox(boxEl = null) {
  if (!boxEl) {
    boxEl = document.getElementById('bestias12PowerUpBox');
  }
  if (!boxEl) return;
  
  // No actualizar si no hay carta actual (evita mostrar f√≥rmula durante la carga)
  if (!currentCard) {
    boxEl.innerHTML = `
      <div style="text-align: center;">
        <div style="color: #22c55e; font-size: 16px; margin-bottom: 10px; font-weight: bold;">
          üê≤ PODER ACUMULADO üê≤
        </div>
        <div style="color: #666;">Preparando batalla...</div>
      </div>
    `;
    return;
  }
  
  // Obtener el car√°cter actual para mostrar su nivel (usar la variable global currentCard)
  const card = currentCard;
  const cardLevel = card.challengeStreak || 0;
  const playerLevel = getCurrentLevel(xpPoints);
  const dailyStreak = streak; // Usar racha diaria global, no nivel del car√°cter
  
  // Calcular da√±o actual usando la f√≥rmula correcta:
  // (nivel del car√°cter + (Ê∞¥Âπ≥ x 5) + (racha diaria x 1)) x multiplicadores
  const baseDamage = cardLevel + (playerLevel * 5) + (dailyStreak * 1);
  const totalDamage = Math.floor(baseDamage * bestias12DamageMultiplier);
  
  let powerUpsHtml = '';
  if (bestias12PowerUps.length > 0) {
    // En m√≥vil, mostrar solo un resumen compacto si hay muchos power-ups
    if (isMobile() && bestias12PowerUps.length > 3) {
      const totalMultiplier = (bestias12DamageMultiplier * 100).toFixed(0);
      powerUpsHtml = `<span style="color: #22c55e; border: 1px solid #22c55e; padding: 2px 6px; border-radius: 4px; font-size: 12px;">üê≤ ${bestias12PowerUps.length} Poderes Activos (${totalMultiplier}%)</span>`;
    } else {
      powerUpsHtml = bestias12PowerUps.map(pu => 
        `<span style="color: ${pu.color}; border: 1px solid ${pu.color}; padding: 2px 6px; border-radius: 4px; margin: 2px; display: inline-block; font-size: 12px;">${pu.name}</span>`
      ).join('');
    }
  } else {
    powerUpsHtml = '<span style="color: #666;">Juega 5 tarjetas</span>';
  }
  
  // Solo mostrar f√≥rmula de da√±o, sin power-ups
  boxEl.innerHTML = `
    <div style="text-align: center; padding-bottom: 3px; line-height: 0.9;">      
      <div style="margin-bottom: 4px;">
        (<span style="color: #10b981; font-size: 22px;">Niv ${cardLevel}</span> + 
        <span style="color: #8b5cf6; font-size: 16px;">Ê∞¥Âπ≥</span><span style="color: #8b5cf6; font-size: 22px;">(${playerLevel*5})</span> + 
        <span style="color: #22d3ee; font-size: 22px;">üî•(${dailyStreak})</span>) √ó 
        <span style="color: #ef4444; font-size: 25px;">Poderes (${(bestias12DamageMultiplier * 100).toFixed(0)}%)</span><br>
        = <strong style="color: #ff6b6b; font-size: 25px;">${totalDamage} da√±o</strong> si respondes bien
      </div>
    </div>
  `;
}

function showBestias12Effect(text, color) {
  const effect = document.createElement('div');
  effect.style.cssText = `
    position: fixed;
    top: 160px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    font-size: 32px;
    font-weight: bold;
    color: ${color};
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    animation: effectFloat 2s ease-out forwards;
  `;
  effect.textContent = text;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    if(effect.parentNode) effect.parentNode.removeChild(effect);
  }, 2000);
}

function grantBestias12PowerUp() {
  // Librer√≠a completa de power-ups con probabilidades
  const powerUpLibrary = [
    // Power-ups de da√±o (colores rojos/naranjas)
    { type: 'damage', name: 'Fuerza Her√≥ica', description: '+10% da√±o', multiplier: 1.1, color: '#ef4444', weight: 15 },
    { type: 'damage', name: 'Fuerza Maestra', description: '+20% da√±o', multiplier: 1.2, color: '#dc2626', weight: 10 },
    { type: 'damage', name: 'Fuerza Celestial', description: '+100% da√±o', multiplier: 2.0, color: '#f58c36', weight: 1 },
    
    // Power-ups de tiempo (colores celestes/azules)
    { type: 'time', name: 'Ganarle al tiempo', description: '+10 segundos', bonus: 10, color: '#22d3ee', weight: 12 },
    { type: 'time', name: 'Dominar al tiempo', description: '+20 segundos', bonus: 20, color: '#0891b2', weight: 8 },
    { type: 'time', name: 'Controlar al tiempo', description: '+30 segundos', bonus: 30, color: '#0e7490', weight: 4 },

    // Power-ups especiales (colores dorados/morados)
    { type: 'special', name: 'Intercambio', description: '+25% da√±o y -20 segs', damageMulti: 1.25, timeBonus: -20, color: '#f59e0b', weight: 8 },
    { type: 'special', name: 'Conf√≠o en m√≠', description: '+40% da√±o y -35 segs', damageMulti: 1.4, timeBonus: -35, color: '#d97706', weight: 7 },
    { type: 'special', name: 'A todo o nada', description: '+100% da√±o y -60 segs', damageMulti: 2.0, timeBonus: -60, color: '#b45309', weight: 4 },

    // Power-ups arriesgados (colores verde turquesa)
    { type: 'risky', name: 'Sacrificio del Poder', description: '+25% da√±o y -1 vida', damageMulti: 1.25, livesLost: 1, color: '#14b8a6', weight: 6 },
    { type: 'risky', name: 'Sacrificio del Tiempo', description: '+25 segs y -1 vida', timeBonus: 25, livesLost: 1, color: '#0d9488', weight: 6 },
    { type: 'risky', name: 'Cueste lo que cueste', description: '+60% da√±o y -1 vida', damageMulti: 1.6, livesLost: 1, color: '#0f766e', weight: 3 },
    { type: 'risky', name: 'Rescate', description: '-20s y +1 vida', timeBonus: -20, livesGained: 1, color: '#0891b2', weight: 4 },
    { type: 'risky', name: 'Iluminaci√≥n Divina', description: '+25% da√±o, +20 segs y +1 vida', damageMulti: 1.25, timeBonus: 20, livesGained: 1, color: '#134e4a', weight: 2 }
  ];
  
  // Generar 3 opciones aleatorias basadas en peso
  const options = getBestias12RandomPowerUpOptions(powerUpLibrary, 3);
  
  // Mostrar modal de selecci√≥n
  showBestias12PowerUpSelectionModal(options);
}

function getBestias12RandomPowerUpOptions(library, count) {
  // Crear pool basado en pesos
  const weightedPool = [];
  library.forEach(powerUp => {
    for(let i = 0; i < powerUp.weight; i++) {
      weightedPool.push(powerUp);
    }
  });
  
  const options = [];
  const usedIndices = [];
  
  while(options.length < count && options.length < library.length) {
    const randomIndex = Math.floor(Math.random() * weightedPool.length);
    const selectedPowerUp = weightedPool[randomIndex];
    
    // Evitar duplicados
    if(!options.find(opt => opt.name === selectedPowerUp.name)) {
      options.push({...selectedPowerUp}); // Crear copia
    }
  }
  
  return options;
}

function showBestias12PowerUpSelectionModal(options) {
  // Pausar el timer mientras se selecciona
  const wasTimerRunning = bestias12TimerInterval;
  if(wasTimerRunning) {
    clearInterval(bestias12TimerInterval);
  }
  
  const modal = document.createElement('div');
  modal.id = 'bestias12PowerUpModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.85);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Jersey 10', monospace;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    text-align: center;
    border: 3px solid #22c55e;
    box-shadow: 0 20px 40px rgba(0,0,0,0.7);
  `;
  
  modalContent.innerHTML = `
    <div style="font-size: 28px; color: #22c55e; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
      üê≤ ELIGE TU PODER üê≤
    </div>
    <div style="font-size: 20px; color: #ccc; margin-bottom: 15px;">
      Selecciona un Power-Up
    </div>
    <div style="margin-bottom: 20px;">
      <div style="font-size: 20px; color: #ff6b6b; margin-bottom: 8px;">‚è∞ Tiempo restante: <span id="bestias12PowerUpTimer">10</span>s</div>
      <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
        <div id="bestias12PowerUpTimerBar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #10b981, #22c55e, #ef4444); transition: width 0.1s linear;"></div>
      </div>
    </div>
    <div id="bestias12PowerUpOptions" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
    </div>
  `;
  
  const optionsContainer = modalContent.querySelector('#bestias12PowerUpOptions');
  
  options.forEach((powerUp, index) => {
    const optionBtn = document.createElement('button');
    optionBtn.style.cssText = `
      background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(30,30,30,0.7));
      border: 2px solid ${powerUp.color};
      border-radius: 7px;
      padding: 10px;
      min-width: 160px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Jersey 10', monospace;
      color: white;
    `;
    
    optionBtn.innerHTML = `
      <div style="font-size: 18px; color: ${powerUp.color}; margin-bottom: 4px; font-weight: bold;">
        ${powerUp.name}
      </div>
      <div style="font-size: 22px; color: #ccc; line-height: 1.3;">
        ${powerUp.description}
      </div>
    `;
    
    // Hover effectss
    optionBtn.addEventListener('mouseenter', () => {
      optionBtn.style.transform = 'scale(1.05)';
      optionBtn.style.boxShadow = `0 0 20px ${powerUp.color}66`;
    });
    
    optionBtn.addEventListener('mouseleave', () => {
      optionBtn.style.transform = 'scale(1)';
      optionBtn.style.boxShadow = 'none';
    });
    
    // Click handler
    optionBtn.addEventListener('click', () => {
      selectBestias12PowerUp(powerUp, wasTimerRunning);
      modal.remove();
    });
    
    optionsContainer.appendChild(optionBtn);
  });
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Iniciar timer de 10 segundos
  let timeLeft = 10;
  const timerDisplay = modal.querySelector('#bestias12PowerUpTimer');
  const timerBar = modal.querySelector('#bestias12PowerUpTimerBar');
  
  const powerUpTimerInterval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    timerBar.style.width = `${(timeLeft / 10) * 100}%`;
    
    // Cambiar color seg√∫n tiempo restante
    if (timeLeft <= 3) {
      timerBar.style.background = '#ef4444'; // Rojo cr√≠tico
    } else if (timeLeft <= 6) {
      timerBar.style.background = '#f59e0b'; // Amarillo advertencia
    }
    
    if (timeLeft <= 0) {
      clearInterval(powerUpTimerInterval);
      // No seleccionar nada, cerrar modal
      modal.remove();
      // Reanudar timer si estaba corriendo
      if(wasTimerRunning && bestias12Active) {
        startBestias12Timer();
      }
    }
  }, 1000);
  
  // Limpiar timer si se selecciona una opci√≥n
  modal.addEventListener('click', () => {
    clearInterval(powerUpTimerInterval);
  });
}

function selectBestias12PowerUp(powerUp, wasTimerRunning) {
  // Agregar power-up a la lista
  bestias12PowerUps.push(powerUp);
  
  // Aplicar efectos seg√∫n tipo
  if(powerUp.type === 'damage') {
    bestias12DamageMultiplier *= powerUp.multiplier;
    console.log(`üí™ Power-up obtenido: ${powerUp.name} - Multiplicador total: ${bestias12DamageMultiplier}`);
  } else if(powerUp.type === 'time') {
    bestias12Timer += powerUp.bonus;
    updateBestias12Timer();
    console.log(`‚è∞ Power-up obtenido: ${powerUp.name} - Tiempo a√±adido: ${powerUp.bonus}s`);
    
    // Aplicar glow celeste al timer
    const timerDisplay = document.getElementById('bestias12Timer');
    if (timerDisplay) {
      timerDisplay.style.animation = 'none';
      void timerDisplay.offsetWidth;
      timerDisplay.style.animation = 'timerTimeGainGlow 0.8s ease-out';
      setTimeout(() => {
        timerDisplay.style.animation = '';
      }, 800);
    }
  } else if(powerUp.type === 'special') {
    bestias12DamageMultiplier *= powerUp.damageMulti;
    bestias12Timer += powerUp.timeBonus;
    
    // Mostrar efecto de glow en timer
    if(powerUp.timeBonus < 0) {
      showBestias12TimerGlow('#ef4444'); // Rojo para p√©rdida de tiempo
      showBestias12TimeChangeNotification(powerUp.timeBonus);
    }
    
    updateBestias12Timer();
    console.log(`‚ú® Power-up especial: ${powerUp.name} - Da√±o: ${powerUp.damageMulti}x, Tiempo: ${powerUp.timeBonus}s`);
  } else if(powerUp.type === 'risky') {
    // Power-ups arriesgados
    if(powerUp.damageMulti) {
      bestias12DamageMultiplier *= powerUp.damageMulti;
    }
    
    if(powerUp.timeBonus) {
      bestias12Timer += powerUp.timeBonus;
      // Mostrar glow verde para ganancia de tiempo
      showBestias12TimerGlow('#10b981');
      showBestias12TimeChangeNotification(powerUp.timeBonus);
    }
    
    // Manejo de vidas
    if(powerUp.livesLost) {
      bestias12Lives = Math.max(0, bestias12Lives - powerUp.livesLost);
      updateBestias12LivesDisplay();
      console.log(`üíÄ Perdiste ${powerUp.livesLost} vida(s) - Vidas restantes: ${bestias12Lives}`);
      
      // Verificar si se acabaron las vidas
      if(bestias12Lives <= 0) {
        setTimeout(() => {
          showBestias12Result(false, 'Sin vidas restantes');
        }, 1000);
      }
    }
    
    if(powerUp.livesGained) {
      bestias12Lives += powerUp.livesGained;
      updateBestias12LivesDisplay();
      console.log(`‚ù§Ô∏è Ganaste ${powerUp.livesGained} vida(s) - Vidas totales: ${bestias12Lives}`);
    }
    
    updateBestias12Timer();
    console.log(`üé≤ Power-up arriesgado: ${powerUp.name}`);
  }
  
  // Mostrar notificaci√≥n de confirmaci√≥n
  showBestias12PowerUpConfirmation(powerUp);
  
  // Reanudar timer si estaba corriendo
  if(wasTimerRunning && bestias12Active) {
    startBestias12Timer();
  }
  
  // Actualizar indicador de power-ups
  updateBestias12PowerUpIndicator();
  
  // Actualizar box de power-ups
  updateBestias12PowerUpBox();
}

function showBestias12TimerGlow(color) {
  const timerEl = document.getElementById('bestias12Timer');
  if(timerEl) {
    // Si el color es verde/celeste (ganancia de tiempo), usar la animaci√≥n de glow celeste
    if (color === '#10b981' || color === '#22d3ee') {
      timerEl.style.animation = 'none';
      void timerEl.offsetWidth;
      timerEl.style.animation = 'timerTimeGainGlow 0.8s ease-out';
      setTimeout(() => {
        timerEl.style.animation = '';
      }, 800);
    } else {
      // Para otros colores (rojo, p√©rdida de tiempo), usar el m√©todo anterior
      timerEl.style.boxShadow = `0 0 20px ${color}`;
      timerEl.style.borderColor = color;
      
      // Quitar el glow despu√©s de 2 segundos
      setTimeout(() => {
        timerEl.style.boxShadow = '0 4px 8px rgba(34,197,94,0.3)';
        timerEl.style.borderColor = '#22c55e';
      }, 2000);
    }
  }
}

function showBestias12TimeChangeNotification(timeChange) {
  const isPositive = timeChange > 0;
  const text = isPositive ? `+${timeChange}s` : `${timeChange}s`;
  const color = isPositive ? '#10b981' : '#ef4444';
  
  // Buscar la tarjeta actual para posicionar el efecto cerca del timer
  const timerEl = document.getElementById('bestias12Timer');
  if (!timerEl) return;
  
  const timerRect = timerEl.getBoundingClientRect();
  
  const effect = document.createElement('div');
  effect.style.cssText = `
    position: fixed;
    top: ${timerRect.top - 30}px;
    left: ${timerRect.left + timerRect.width/2}px;
    transform: translateX(-50%);
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    font-size: 24px;
    font-weight: bold;
    color: ${color};
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    animation: damageFloat 2s ease-out forwards;
  `;
  effect.textContent = text;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    if(effect.parentNode) effect.parentNode.removeChild(effect);
  }, 2000);
}

function showBestias12PowerUpConfirmation(powerUp) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100001;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.9));
    border: 3px solid ${powerUp.color};
    border-radius: 15px;
    padding: 15px 20px;
    text-align: center;
    font-family: 'Jersey 10', monospace;
    font-size: 18px;
    font-weight: bold;
    color: ${powerUp.color};
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px ${powerUp.color}33;
    animation: powerUpPulse 2s ease-out forwards;
    max-width: 85vw;
    min-width: 280px;
  `;
  
  notification.innerHTML = `
    <div style="font-size: 22px; margin-bottom: 8px; line-height: 1.2;">üê≤ ¬°PODER<br>OBTENIDO! üê≤</div>
    <div style="font-size: 20px; margin-bottom: 6px; line-height: 1.2;">${powerUp.name}</div>
    <div style="font-size: 18px; color: #ccc; line-height: 1.3;">${powerUp.description}</div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if(notification.parentNode) notification.parentNode.removeChild(notification);
  }, 2000);
}

// Funci√≥n para sincronizar progreso de historia con desaf√≠os completados
async function syncStoryProgressWithChallenges() {
  console.log('üìñ Sincronizando progreso de historia con desaf√≠os completados...');
  
  // Mapeo de desaf√≠os a cap√≠tulos
  const challengeToChapter = {
    cruzarMarCompleted: 'chapter6',      // Cap√≠tulo 6: Cruzar el Mar
    cruzarCieloCompleted: 'chapter7',    // Cap√≠tulo 7: Cruzar el Cielo
    cruzarHSK3Completed: 'chapter8',     // Cap√≠tulo 8: Cruzar HSK3
    cruzarHSK4Completed: 'chapter9',     // Cap√≠tulo 9: Cruzar HSK4
    bestias12Completed: 'chapter10',     // Cap√≠tulo 10: Los 12 del Hor√≥scopo
    emperatrizCompleted: 'chapter11'     // Cap√≠tulo 11: La Emperatriz
  };
  
  // Verificar si window.markChapterAsCompleted existe
  if (!window.markChapterAsCompleted) {
    console.log('‚ö†Ô∏è markChapterAsCompleted no est√° disponible a√∫n');
    return;
  }
  
  // Marcar cap√≠tulos seg√∫n desaf√≠os completados
  let syncedChapters = 0;
  
  if (cruzarMarCompleted) {
    console.log('‚úÖ Cruzar el Mar completado - sincronizando chapter6');
    await window.markChapterAsCompleted('chapter6');
    syncedChapters++;
  }
  
  if (cruzarCieloCompleted) {
    console.log('‚úÖ Cruzar el Cielo completado - sincronizando chapter7');
    await window.markChapterAsCompleted('chapter7');
    syncedChapters++;
  }
  
  if (cruzarHSK3Completed) {
    console.log('‚úÖ Cruzar HSK3 completado - sincronizando chapter8');
    await window.markChapterAsCompleted('chapter8');
    syncedChapters++;
  }
  
  if (cruzarHSK4Completed) {
    console.log('‚úÖ Cruzar HSK4 completado - sincronizando chapter9');
    await window.markChapterAsCompleted('chapter9');
    syncedChapters++;
  }
  
  if (bestias12Completed) {
    console.log('‚úÖ 12 Bestias completado - sincronizando chapter10');
    await window.markChapterAsCompleted('chapter10');
    syncedChapters++;
  }
  
  if (emperatrizCompleted) {
    console.log('‚úÖ La Emperatriz completada - sincronizando chapter11');
    await window.markChapterAsCompleted('chapter11');
    syncedChapters++;
  }
  
  console.log(`üìñ Sincronizaci√≥n completa: ${syncedChapters} cap√≠tulos actualizados`);
  
  // Actualizar el bot√≥n de Historia con el progreso
  updateHistoryButtonProgress();
}

// Funci√≥n para actualizar el bot√≥n "Historia y Tutorial" con el progreso (x/13)
function updateHistoryButtonProgress() {
  const btnHistoria = document.getElementById('btnHistoria');
  if (!btnHistoria) return;
  
  // Usar window.storyProgress que se carga desde el backend
  const storyProgress = window.storyProgress || {
    chapter1: false,
    chapter6: false,
    chapter7: false,
    chapter8: false,
    chapter9: false,
    chapter10: false,
    chapter11: false,
    chapter12: false
  };
  
  // Calcular progreso (13 milestones totales)
  const totalMilestones = 13;
  const completedCount = [
    storyProgress.chapter1,    // 1. Cap√≠tulo 1 (narrativa)
    cruzarMarCompleted,         // 2. Cruzar el Mar
    storyProgress.chapter6,    // 3. Cap√≠tulo 6 (narrativa)
    storyProgress.chapter7,    // 4. Cap√≠tulo 7 (narrativa)
    storyProgress.chapter8,    // 5. Cap√≠tulo 8 (narrativa)
    cruzarCieloCompleted,       // 6. Cruzar el Cielo
    storyProgress.chapter9,    // 7. Cap√≠tulo 9 (narrativa)
    window.horoscopeBadges.length >= 12, // 8. Meta-milestone: 12 Guardianes desbloqueados (usa BADGES no horoscopeAnimalsUnlocked)
    storyProgress.chapter10,   // 9. Cap√≠tulo 10 (narrativa)
    bestias12Completed,         // 10. 12 Bestias
    storyProgress.chapter11,   // 11. Cap√≠tulo 11 (narrativa)
    emperatrizCompleted,        // 12. La Emperatriz
    storyProgress.chapter12    // 13. Cap√≠tulo 12 (narrativa - final)
  ].filter(Boolean).length;
  
  // Actualizar texto del bot√≥n
  btnHistoria.innerHTML = `Modo Historia (${completedCount}/${totalMilestones})`;
  
  console.log(`üìñ Bot√≥n Historia actualizado: ${completedCount}/${totalMilestones}`);
}

// Funci√≥n para calcular el m√°ximo % de poder acumulado por power-ups
function calculateFinalPowerPercent(damageMultiplier) {
  // Convertir el multiplicador de da√±o a porcentaje
  // Por ejemplo: damageMultiplier = 5.4 ‚Üí 540%
  return Math.round(damageMultiplier * 100);
}

// Modal simplificado para desaf√≠os N1, N2, N3 (solo felicitaci√≥n y respuestas correctas)
function showSimpleChallengeVictoryModal(config) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    padding: 20px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, ${config.secondaryColor}, ${config.primaryColor});
      color: white;
      border: 3px solid ${config.borderColor};
      border-radius: 20px;
      padding: 35px 25px;
      text-align: center;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 10px 40px ${config.borderColor}66;
      animation: victoryGlow 2s ease-in-out infinite alternate;
    ">
      <h2 style="
        color: ${config.borderColor};
        font-size: clamp(24px, 6vw, 32px);
        margin-bottom: 15px;
        text-shadow: 0 0 12px ${config.borderColor};
      ">${config.title}</h2>
      
      <p style="
        color: #fef3c7;
        font-size: clamp(16px, 4vw, 20px);
        margin-bottom: 25px;
        line-height: 1.4;
        font-weight: bold;
      ">${config.subtitle}</p>
      
      <!-- Solo Respuestas Correctas -->
      <div style="
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px solid rgba(255, 255, 255, 0.2);
      ">
        <div style="margin-bottom: 12px;">
          <span style="color: #a5f3fc; font-size: clamp(16px, 4vw, 20px);">‚úÖ Respuestas Correctas</span>
        </div>
        <div style="color: #22c55e; font-size: clamp(28px, 7vw, 40px); font-weight: bold;">${config.correctAnswers}/${config.totalAnswers}</div>
        <div style="color: #fef3c7; font-size: clamp(14px, 3.5vw, 16px); margin-top: 8px;">${Math.round((config.correctAnswers/config.totalAnswers)*100)}% de aciertos</div>
      </div>
      
      <button onclick="goToRevise1FromVictory()" style="
        background: linear-gradient(135deg, ${config.borderColor}, ${config.secondaryColor});
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-family: 'Jersey 10', monospace;
        font-size: clamp(16px, 4vw, 18px);
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        width: 100%;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.4)';">
        üè† Ir a Inicio
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Modal gen√©rico de victoria para desaf√≠os
function showChallengeVictoryModal(config) {
  console.log('üèÜ ============ showChallengeVictoryModal INICIADO ============');
  console.log('üèÜ Config recibido:', config);
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    padding: 20px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, ${config.secondaryColor}, ${config.primaryColor});
      color: white;
      border: 3px solid ${config.borderColor};
      border-radius: 20px;
      padding: 35px 25px;
      text-align: center;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 10px 40px ${config.borderColor}66;
      animation: victoryGlow 2s ease-in-out infinite alternate;
    ">
      <h2 style="
        color: ${config.borderColor};
        font-size: clamp(24px, 6vw, 32px);
        margin-bottom: 15px;
        text-shadow: 0 0 12px ${config.borderColor};
      ">${config.title}</h2>
      
      <p style="
        color: #fef3c7;
        font-size: clamp(16px, 4vw, 20px);
        margin-bottom: 25px;
        line-height: 1.4;
        font-weight: bold;
      ">${config.subtitle}</p>
      
      <!-- Estad√≠sticas -->
      <div style="
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px solid rgba(255, 255, 255, 0.2);
      ">
        <div style="margin-bottom: 12px;">
          <span style="color: #a5f3fc; font-size: clamp(14px, 3.5vw, 18px);">‚è±Ô∏è Tiempo: </span>
          <span style="color: #fef3c7; font-size: clamp(16px, 4vw, 20px); font-weight: bold;">${config.timeText}</span>
        </div>
        
        <div style="margin-bottom: 12px;">
          <span style="color: #a5f3fc; font-size: clamp(14px, 3.5vw, 18px);">‚úÖ Respuestas Correctas: </span>
          <span style="color: #22c55e; font-size: clamp(16px, 4vw, 20px); font-weight: bold;">${config.correctAnswers}</span>
        </div>
        
        <div style="margin-bottom: 12px;">
          <span style="color: #a5f3fc; font-size: clamp(14px, 3.5vw, 18px);">‚ö° Power-ups Obtenidos: </span>
          <span style="color: #fbbf24; font-size: clamp(16px, 4vw, 20px); font-weight: bold;">${config.powerUpsCount}</span>
        </div>
        
        <div>
          <span style="color: #a5f3fc; font-size: clamp(14px, 3.5vw, 18px);">üî• Mayor % de Poder: </span>
          <span style="color: #ef4444; font-size: clamp(16px, 4vw, 20px); font-weight: bold;">${config.maxPowerPercent}%</span>
        </div>
      </div>
      
      <button onclick="goToRevise1FromVictory()" style="
        background: linear-gradient(135deg, ${config.borderColor}, ${config.secondaryColor});
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-family: 'Jersey 10', monospace;
        font-size: clamp(16px, 4vw, 18px);
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        width: 100%;
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.4)';">
        üè† Ir a Inicio
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  console.log('üèÜ Modal agregado al body exitosamente');
  console.log('üèÜ ============ showChallengeVictoryModal COMPLETADO ============');
}

// Funci√≥n para ir a revise1 desde el modal de victoria
function goToRevise1FromVictory() {
  console.log('üè† goToRevise1FromVictory - INICIADO');
  
  // Detener m√∫sica del desaf√≠o
  stopDesafioMusic();
  
  // Limpiar todo el estado del desaf√≠o
  if (typeof cleanupBossChallenge === 'function') {
    console.log('üßπ Ejecutando cleanupBossChallenge()');
    cleanupBossChallenge();
  }
  
  // Cerrar cualquier modal con z-index alto
  const modals = document.querySelectorAll('[style*="z-index"]');
  modals.forEach(m => {
    const zIndex = parseInt(m.style.zIndex);
    if (zIndex >= 99999) {
      console.log('üóëÔ∏è Removiendo modal con z-index:', zIndex);
      if (m.parentNode) m.parentNode.removeChild(m);
    }
  });
  
  // Tambi√©n buscar por clase
  const modalsByClass = document.querySelectorAll('.ultimate-gameover-overlay');
  modalsByClass.forEach(m => {
    console.log('üóëÔ∏è Removiendo modal por clase');
    if (m.parentNode) m.parentNode.removeChild(m);
  });
  
  console.log('üè† Cambiando a revise1');
  
  // Actualizar botones del hor√≥scopo si la funci√≥n est√° disponible
  if (typeof updateHoroscopeButtonsState === 'function') {
    updateHoroscopeButtonsState();
    console.log('‚úÖ Botones del hor√≥scopo actualizados');
  }
  
  // Ir a modo revise1
  currentMission = 'revise1';
  onMissionChange();
  
  console.log('üè† goToRevise1FromVictory - COMPLETADO');
}

function showBestias12Victory() {
  console.log('üê≤ ============ 12 BESTIAS VICTORIA ============');
  
  bestias12Active = false;
  clearInterval(bestias12TimerInterval);
  hideBestias12UI();
  
  // ‚è±Ô∏è CALCULAR TIEMPO Y ESTAD√çSTICAS PRIMERO
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  const finalPowerPercent = calculateFinalPowerPercent(bestias12DamageMultiplier);
  
  // üéâ PRIORIDAD 1: MOSTRAR MODAL INMEDIATAMENTE
  console.log('üéâ MOSTRANDO MODAL DE VICTORIA...');
  try {
    showChallengeVictoryModal({
      title: 'üê≤ ¬°VICTORIA!',
      subtitle: '¬°Has derrotado a las 12 Bestias!',
      timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
      correctAnswers: sessionCorrect,
      totalAnswers: sessionTotal,
      powerUpsCount: bestias12PowerUps.length,
      maxPowerPercent: finalPowerPercent,
      primaryColor: '#32CD32',
      secondaryColor: '#228B22',
      borderColor: '#32CD32'
    });
    console.log('‚úÖ Modal de victoria mostrado exitosamente');
  } catch (error) {
    console.error('‚ùå Error mostrando modal de victoria:', error);
  }
  
  // üíæ PRIORIDAD 2: GUARDAR PROGRESO (as√≠ncrono, no bloquea UI)
  setTimeout(() => {
    try {
      console.log('üíæ Iniciando guardado de progreso...');
      
      // ¬°MARCAR 12 BESTIAS COMO COMPLETADO!
      if (!bestias12Completed) {
        bestias12Completed = true;
        bestias12CompletedAt = new Date();
        console.log('üê≤ ¬°12 Bestias completado por primera vez!');
        
        // üíæ GUARDAR EN BASE DE DATOS (CR√çTICO)
        console.log('üíæ Guardando en base de datos...');
        try {
          saveUserState();
          console.log('‚úÖ saveUserState() ejecutado');
        } catch (saveError) {
          console.error('‚ùå ERROR CR√çTICO guardando estado:', saveError);
          // Reintentar
          setTimeout(() => {
            console.log('üîÑ Reintentando guardar estado...');
            try {
              saveUserState();
              console.log('‚úÖ saveUserState() reintento exitoso');
            } catch (retryError) {
              console.error('‚ùå ERROR CR√çTICO en reintento:', retryError);
            }
          }, 1000);
        }
        
        // üìñ MARCAR CAP√çTULO DE LA HISTORIA COMO COMPLETADO (no cr√≠tico)
        try {
          if (window.markChapterAsCompleted) {
            console.log('üìñ Marcando chapter8 (12 Bestias) como completado');
            window.markChapterAsCompleted('chapter8');
          }
        } catch (chapterError) {
          console.error('‚ö†Ô∏è Error marcando cap√≠tulo:', chapterError);
        }
      } else {
        console.log('‚ÑπÔ∏è 12 Bestias ya estaba completado, saltando guardado inicial');
      }
      
      console.log('‚úÖ Proceso de guardado completado');
    } catch (error) {
      console.error('‚ùå ERROR GENERAL en proceso de guardado:', error);
      try {
        saveUserState();
      } catch (finalError) {
        console.error('‚ùå ERROR FATAL - No se pudo guardar:', finalError);
      }
    }
  }, 50);
  
  console.log('üê≤ ============ FUNCI√ìN showBestias12Victory COMPLETADA ============');
}

function showBestias12Result(victory, reason) {
  // üî¥ CHECKPOINT: Guardar al terminar desaf√≠o 12 Bestias
  console.log(`üî¥ CHECKPOINT [showBestias12Result]: HAGO FLUSH - Victoria: ${victory}, Cola: ${SaveQueue.getQueueSize()} ops`);
  SaveQueue.flush();
  
  // Similar a showEmperatrizResult pero con tem√°tica de bestias
  bestias12Active = false;
  clearInterval(bestias12TimerInterval);
  hideBestias12UI();
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
  `;
  
  const borderColor = victory ? '#32CD32' : '#ef4444';
  const titleText = victory ? 'üê≤ ¬°VICTORIA!' : 'üíÄ DERROTA';
  const titleColor = victory ? '#32CD32' : '#ef4444';
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #228B22, #006400);
      color: white;
      border: 3px solid ${borderColor};
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 30px ${borderColor}66;
    ">
      <h2 style="
        color: ${titleColor};
        font-size: 24px;
        margin-bottom: 15px;
        text-shadow: 0 0 8px ${borderColor};
      ">${titleText}</h2>
      
      <p style="
        color: #ffffff;
        font-size: 18px;
        margin-bottom: 20px;
        line-height: 1.4;
      ">${reason}</p>
      
      <button onclick="cleanupAndGoToRevise()" style="
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
      ">
        IR A REPASAR
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function showBestias12Punishment(lostCard) {
  // Usar la misma funci√≥n de castigo de La Emperatriz
  showEmperatrizPunishment(lostCard);
}

// Funci√≥n para mostrar el modal de elecci√≥n de castigo cada 20 cartas
function showBestias12PunishmentChoice() {
  // Librer√≠a de castigos para Las 12 Bestias
  const punishmentLibrary = [
    // P√©rdida de da√±o
    { type: 'cursed_damage', name: 'Garras Debilitadas', description: '-40% da√±o', multiplier: 0.6, color: '#b53145', weight: 8 },
    { type: 'cursed_damage', name: 'Fuerza Reducida', description: '-50% da√±o', multiplier: 0.5, color: '#b53145', weight: 10 },
    
    // P√©rdida de tiempo
    { type: 'cursed_time', name: 'Rugido Temporal', description: '-40 segundos', bonus: -40, color: '#447eab', weight: 10 },
    { type: 'cursed_time', name: 'Aliento Eterno', description: '-25 segundos', bonus: -25, color: '#447eab', weight: 8 },
    
    // P√©rdida de vidas
    { type: 'cursed_lives', name: 'Mordida Feroz', description: '-1 vida', livesLost: 1, color: '#374151', weight: 8 }, 

    // Recuperaci√≥n de las Bestias
    { type: 'cursed_heal', name: 'Regeneraci√≥n Bestial', description: 'Bestias se curan +25% faltante', healPercent: 25, color: '#31c469', weight: 8 },
    { type: 'cursed_heal', name: 'Poder Ancestral', description: 'Bestias se curan +40% faltante, tu ganas 15 segs', healPercent: 40, timeBonus: 15, color: '#31c469', weight: 9 },
    { type: 'cursed_heal', name: 'Bendici√≥n Divina', description: 'Bestias se curan +80% faltante, tu ganas 20 segs', healPercent: 80, timeBonus: 20, color: '#31c469', weight: 9 },

    // Invulnerabilidad de las Bestias
    { type: 'cursed_invulnerable', name: 'Escudo Sagrado', description: 'Bestias invulnerables por 2 cartas', cardsProtected: 2, color: '#bd6937', weight: 12 },
    { type: 'cursed_invulnerable', name: 'Armadura Celestial', description: 'Bestias invulnerables por 3 cartas', cardsProtected: 3, color: '#bd6937', weight: 12 },
  ];
  
  // Pausar timer mientras se selecciona
  const wasTimerRunning = bestias12TimerInterval;
  if(wasTimerRunning) {
    clearInterval(bestias12TimerInterval);
  }
  
  // Generar 3 opciones aleatorias basadas en peso
  const options = getRandomPowerUpOptions(punishmentLibrary, 3);
  
  const modal = document.createElement('div');
  modal.id = 'bestias12PunishmentModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Jersey 10', monospace;
    animation: cursedModalAppear 0.5s ease-out forwards;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #2d1f1a, #3d2818);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    text-align: center;
    border: 3px solid #D9B38C;
    box-shadow: 0 20px 40px rgba(217, 179, 140, 0.5), 0 0 30px rgba(217, 179, 140, 0.3);
    animation: cursedPulse 2s ease-in-out infinite alternate;
  `;
  
  const title = document.createElement('h2');
  title.style.cssText = `
    color: #D9B38C;
    font-size: 28px;
    margin-bottom: 7px;
    text-shadow: 0 0 10px rgba(217, 179, 140, 0.8);
    text-transform: uppercase;
  `;
  
  const subtitle = document.createElement('p');
  subtitle.style.cssText = `
    color: #F5DEB3;
    font-size: 20px;
    margin-bottom: 10px;
    text-shadow: 0 0 5px rgba(245, 222, 179, 0.6);
  `;
  subtitle.textContent = '¬°Debes elegir tu castigo!';
  
  const optionsContainer = document.createElement('div');
  optionsContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 7px;
    margin-bottom: 10px;
  `;
  
  options.forEach((punishment, index) => {
    const optionButton = document.createElement('button');
    optionButton.style.cssText = `
      background: linear-gradient(135deg, ${punishment.color}, ${punishment.color}dd);
      color: white;
      border: 2px solid ${punishment.color};
      border-radius: 7px;
      padding: 10px;
      font-family: 'Jersey 10', monospace;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    `;
    
    optionButton.innerHTML = `
      <div style="font-size: 20px; margin-bottom: 4px;">${punishment.name}</div>
      <div style="font-size: 24px; opacity: 0.9;">${punishment.description}</div>
    `;
    
    optionButton.onmouseenter = () => {
      optionButton.style.transform = 'translateY(-3px)';
      optionButton.style.boxShadow = `0 8px 25px ${punishment.color}40`;
    };
    
    optionButton.onmouseleave = () => {
      optionButton.style.transform = 'translateY(0)';
      optionButton.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
    };
    
    optionButton.onclick = () => {
      selectBestias12Punishment(punishment, wasTimerRunning);
    };
    
    optionsContainer.appendChild(optionButton);
  });
  
  modalContent.appendChild(title);
  modalContent.appendChild(subtitle);
  modalContent.appendChild(optionsContainer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
}

function selectBestias12Punishment(punishment, wasTimerRunning) {
  // Aplicar el castigo seleccionado
  console.log(`üê≤ Castigo seleccionado:`, punishment);
  
  // Cerrar modal
  const modal = document.getElementById('bestias12PunishmentModal');
  if(modal) modal.remove();
  
  // Aplicar efectos seg√∫n tipo
  switch(punishment.type) {
    case 'cursed_damage':
      bestias12DamageMultiplier *= punishment.multiplier;
      console.log(`‚öîÔ∏è Da√±o reducido a ${(bestias12DamageMultiplier * 100).toFixed(0)}%`);
      showBestias12Effect(punishment.description, punishment.color);
      break;
      
    case 'cursed_time':
      bestias12Timer = Math.max(0, bestias12Timer + punishment.bonus);
      console.log(`‚è∞ Tiempo ajustado: ${punishment.bonus} segundos`);
      showBestias12Effect(punishment.description, punishment.color);
      updateBestias12Timer();
      break;
      
    case 'cursed_lives':
      bestias12Lives -= punishment.livesLost;
      console.log(`üíî Vidas perdidas: ${punishment.livesLost}`);
      showBestias12Effect(punishment.description, punishment.color);
      updateBestias12LivesDisplay();
      
      // Verificar game over
      if(bestias12Lives <= 0) {
        console.log('‚ò†Ô∏è Sin vidas - Las Bestias han ganado!');
        setTimeout(() => {
          showBestias12Result(false, 'Te quedaste sin vidas');
        }, 2000);
        return;
      }
      break;
      
    case 'cursed_heal':
      const missingHP = bestias12MaxHP - bestias12HP;
      const healAmount = Math.floor(missingHP * (punishment.healPercent / 100));
      bestias12HP = Math.min(bestias12MaxHP, bestias12HP + healAmount);
      console.log(`üíö Bestias curadas: +${healAmount} HP`);
      showBestias12Effect(`+${healAmount} HP`, punishment.color);
      updateBestias12HPBar();
      
      if(punishment.timeBonus) {
        bestias12Timer += punishment.timeBonus;
        console.log(`‚è∞ Bonus de tiempo: +${punishment.timeBonus} segundos`);
        updateBestias12Timer();
      }
      break;
      
    case 'cursed_invulnerable':
      bestias12PowerUps.push({
        type: 'invulnerable',
        cardsRemaining: punishment.cardsProtected,
        name: punishment.name
      });
      console.log(`üõ°Ô∏è Bestias invulnerables por ${punishment.cardsProtected} cartas`);
      showBestias12Effect(punishment.description, punishment.color);
      updateBestias12PowerUpIndicator();
      break;
  }
  
  // Reanudar timer
  if(wasTimerRunning) {
    startBestias12Timer();
  }
}


function showEmperatrizLives() {
  // Remover vidas anteriores si existen
  const existingLives = document.getElementById('emperatrizLives');
  if (existingLives) existingLives.remove();
  
  const livesDisplay = document.createElement('div');
  livesDisplay.id = 'emperatrizLives';
  livesDisplay.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 99998;
    background: rgba(0, 0, 0, 0.8);
    color: #f472b6;
    padding: 8px 12px;
    border-radius: 8px;
    font-family: 'Jersey 10', monospace;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid #f472b6;
    box-shadow: 0 4px 8px rgba(244, 114, 182, 0.3);
    text-shadow: 1px 1px 0px #be185d;
  `;
  updateEmperatrizLivesDisplay(livesDisplay);
  
  document.body.appendChild(livesDisplay);
}

function updateEmperatrizLivesDisplay(livesEl = null) {
  if (!livesEl) {
    livesEl = document.getElementById('emperatrizLives');
  }
  if (livesEl) {
    // Usar corazones pixelados sin n√∫meros
    const hearts = 'ü©∑'.repeat(emperatrizLives);
    livesEl.innerHTML = hearts;
  }
}

function showEmperatrizPowerUpBox() {
  // Remover box anterior si existe
  const existingBox = document.getElementById('emperatrizPowerUpBox');
  if (existingBox) existingBox.remove();
  
  const powerUpBox = document.createElement('div');
  powerUpBox.id = 'emperatrizPowerUpBox';
  powerUpBox.style.cssText = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 99997;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.9));
    border: 2px solid #f59e0b;
    border-radius: 7px;
    padding: ${isMobile() ? '5px' : '1px'};
    max-width: 90%;
    width: ${isMobile() ? '95%' : '600px'};
    max-height: ${isMobile() ? '120px' : 'auto'};
    overflow-y: ${isMobile() ? 'auto' : 'visible'};
    font-family: 'Jersey 10', monospace;
    font-size: ${isMobile() ? '12px' : '14px'};
    color: white;
    box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  `;
  
  updateEmperatrizPowerUpBox(powerUpBox);
  document.body.appendChild(powerUpBox);
}

function updateEmperatrizPowerUpBox(boxEl = null) {
  if (!boxEl) {
    boxEl = document.getElementById('emperatrizPowerUpBox');
  }
  if (!boxEl) return;
  
  // No actualizar si no hay carta actual (evita mostrar f√≥rmula durante la carga)
  if (!currentCard) {
    boxEl.innerHTML = `
      <div style="text-align: center;">
        <div style="color: #f59e0b; font-size: 16px; margin-bottom: 10px; font-weight: bold;">
          ‚ö° PODER ACUMULADO ‚ö°
        </div>
        <div style="color: #666;">Preparando batalla...</div>
      </div>
    `;
    return;
  }
  
  // Obtener el car√°cter actual para mostrar su nivel (usar la variable global currentCard)
  const card = currentCard;
  const cardLevel = card.challengeStreak || 0;
  const playerLevel = getCurrentLevel(xpPoints);
  const dailyStreak = streak; // Usar racha diaria global, no nivel del car√°cter
  
  // Calcular da√±o actual usando la f√≥rmula correcta:
  // (nivel del car√°cter + (Ê∞¥Âπ≥ x 5) + (racha diaria x 1)) x multiplicadores
  const baseDamage = cardLevel + (playerLevel * 5) + (dailyStreak * 1);
  const totalDamage = Math.floor(baseDamage * emperatrizDamageMultiplier);
  
  let powerUpsHtml = '';
  if (emperatrizPowerUps.length > 0) {
    // En m√≥vil, mostrar solo un resumen compacto si hay muchos power-ups
    if (isMobile() && emperatrizPowerUps.length > 3) {
      const totalMultiplier = (emperatrizDamageMultiplier * 100).toFixed(0);
      powerUpsHtml = `<span style="color: #22d3ee; border: 1px solid #22d3ee; padding: 2px 6px; border-radius: 4px; font-size: 12px;">‚ö° ${emperatrizPowerUps.length} Poderes Activos (${totalMultiplier}%)</span>`;
    } else {
      powerUpsHtml = emperatrizPowerUps.map(pu => 
        `<span style="color: ${pu.color}; border: 1px solid ${pu.color}; padding: 2px 6px; border-radius: 4px; margin: 2px; display: inline-block; font-size: 12px;">${pu.name}</span>`
      ).join('');
    }
  } else {
    powerUpsHtml = '<span style="color: #666;">Juega 5 tarjetas</span>';
  }
  
  // Solo mostrar f√≥rmula de da√±o, sin power-ups
  boxEl.innerHTML = `
    <div style="text-align: center; padding-bottom: 4px;">      
        (<span style="color: #10b981; font-size: 22px;">Niv ${cardLevel}</span> <span style="font-size: 20px;"> + </span>
        <span style="color: #8b5cf6; font-size: 16px;">Ê∞¥Âπ≥</span><span style="color: #8b5cf6; font-size: 22px;">(${playerLevel*5})</span> <span style="font-size: 20px;"> + </span>
        <span style="color: #22d3ee; font-size: 22px;">üî•(${dailyStreak})</span>) <span style="font-size: 20px;"> x </span>
        <span style="color: #ef4444; font-size: 25px;">Poderes (${(emperatrizDamageMultiplier * 100).toFixed(0)}%)</span><br>
        = <strong style="color: #ff6b6b; font-size: 25px;">${totalDamage} da√±o</strong> <span style="font-size: 20px;">si respondes bien</span>
    </div>
  `;
}

// =============================== FUNCIONES AUXILIARES DE TARJETAS ESPECIALES ===============================

// =============================== FUNCIONES DE GESTI√ìN DE UI EN DESAF√çOS ===============================

function hideUIElementsForChallenges() {
  // Ocultar leaderboard y tabla de conocidas completa
  const leaderboardSection = document.querySelector('section.mt-16');
  if (leaderboardSection) {
    leaderboardSection.style.display = 'none';
    console.log('üéÆ Leaderboard ocultado');
  }
  
  // Ocultar botones de cerrar sesi√≥n
  const logoutButtons = document.querySelectorAll('#btnLogout, [id*="logout"], [class*="logout"]');
  logoutButtons.forEach(btn => {
    if (btn) btn.style.display = 'none';
  });
  
  // Crear espacios en blanco para scroll
  createScrollSpaces();
  
  console.log('üéÆ UI ocultada para modo desaf√≠o:', currentMission);
}

function showUIElementsForNormalMode() {
  // Mostrar leaderboard y tabla de conocidas
  const leaderboardSection = document.querySelector('section.mt-16');
  if (leaderboardSection) {
    leaderboardSection.style.display = 'block';
  }
  
  // Mostrar botones de cerrar sesi√≥n
  const logoutButtons = document.querySelectorAll('#btnLogout, [id*="logout"], [class*="logout"]');
  logoutButtons.forEach(btn => {
    if (btn) btn.style.display = 'block';
  });
  
  // ========= ASEGURAR QUE EL BOT√ìN DE ASISTENCIA EST√â OCULTO =========
  const assistanceContainer = document.getElementById('assistanceButtonContainer');
  if (assistanceContainer && assistanceContainer.style.display !== 'none') {
    console.log('üÜò Ocultando bot√≥n de asistencia desde showUIElementsForNormalMode()');
    hideAssistanceButton();
  }
  
  // Remover espacios en blanco
  removeScrollSpaces();
  
  console.log('üè† UI restaurada para modo normal');
}

function createScrollSpaces() {
  // Remover espacios existentes antes de crear nuevos
  removeScrollSpaces();
  
  // Crear espacio en blanco al final del body para permitir scroll
  const scrollSpace = document.createElement('div');
  scrollSpace.id = 'challengeScrollSpace';
  scrollSpace.style.cssText = `
    height: 400px;
    background: transparent;
    margin-top: 100px;
  `;
  
  // Agregar al final del body
  document.body.appendChild(scrollSpace);
}

function removeScrollSpaces() {
  const existingSpace = document.getElementById('challengeScrollSpace');
  if (existingSpace) {
    existingSpace.remove();
  }
}

function removeOtherSpecialClasses(keepClass) {
  const cardEl = document.getElementById('card');
  const allSpecialClasses = [
    'legendary-red', 'mythic-violet', 'premium-gold',
    'emperatriz-orange', 'emperatriz-cyan', 'emperatriz-crimson', 'emperatriz-turquoise',
    'bestias12-orange', 'bestias12-cyan', 'bestias12-crimson', 'bestias12-turquoise'
  ];
  
  allSpecialClasses.forEach(cls => {
    if (cls !== keepClass) {
      cardEl.classList.remove(cls);
    }
  });
  
  // Actualizar el label de power-up despu√©s de cambiar las clases
  if (typeof addPowerUpLabel === 'function') {
    addPowerUpLabel();
  }
}

function removeAllSpecialClasses() {
  const cardEl = document.getElementById('card');
  const allSpecialClasses = [
    'legendary-red', 'mythic-violet', 'premium-gold',
    'emperatriz-orange', 'emperatriz-cyan', 'emperatriz-crimson', 'emperatriz-turquoise',
    'bestias12-orange', 'bestias12-cyan', 'bestias12-crimson', 'bestias12-turquoise'
  ];
  
  allSpecialClasses.forEach(cls => {
    cardEl.classList.remove(cls);
  });
  
  // Remover label de power-up al limpiar todas las clases especiales
  if (typeof addPowerUpLabel === 'function') {
    addPowerUpLabel();
  }
}

// =============================== EFECTOS Y POWER-UPS DE LA EMPERATRIZ ===============================

function showDamageEffect(damage) {
  // Reproducir el WHOMP PROFUNDO elegido
  createHitSound();
  
  // Buscar la tarjeta actual para posicionar el efecto sobre ella
  const cardEl = document.getElementById('card');
  
  let topPos, leftPos;
  
  if (cardEl && cardEl.offsetParent) {
    const cardRect = cardEl.getBoundingClientRect();
    topPos = cardRect.top + cardRect.height/2 - 30;
    leftPos = cardRect.left + cardRect.width/2;
  } else {
    // Fallback: posici√≥n central de la pantalla
    topPos = window.innerHeight * 0.4;
    leftPos = window.innerWidth * 0.5;
  }
  
  const effect = document.createElement('div');
  effect.style.cssText = `
    position: fixed;
    top: ${topPos - 30}px;
    left: ${leftPos}px;
    transform: translateX(-50%);
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    font-size: 50px;
    font-weight: bold;
    color: #ef4444;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    animation: damageFloat 2s ease-out forwards;
    white-space: nowrap;
    line-height: 0.9;
  `;
  effect.textContent = `Da√±o: ${damage}`;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    if(effect.parentNode) effect.parentNode.removeChild(effect);
  }, 2000);
  
  console.log(`üí• Mostrando efecto de da√±o: ${damage} en posici√≥n: ${topPos}, ${leftPos}`);
}

function showEmperatrizEffect(text, color) {
  // Buscar la tarjeta actual para posicionar el efecto sobre ella (igual que showDamageEffect)
  const cardEl = document.getElementById('card');
  
  let topPos, leftPos;
  
  if (cardEl && cardEl.offsetParent) {
    const cardRect = cardEl.getBoundingClientRect();
    topPos = cardRect.top + cardRect.height/2 - 30;
    leftPos = cardRect.left + cardRect.width/2;
  } else {
    // Fallback: posici√≥n central de la pantalla
    topPos = window.innerHeight * 0.4;
    leftPos = window.innerWidth * 0.5;
  }
  
  // Ajustar posici√≥n espec√≠fica para "Invulnerabilidad perdida" para evitar sobreposici√≥n
  const offsetY = text.toLowerCase().includes('invulnerabilidad') ? 35 : -10;
  
  const effect = document.createElement('div');
  effect.style.cssText = `
    position: fixed;
    top: ${topPos + offsetY}px;
    left: ${leftPos}px;
    transform: translateX(-50%);
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    font-size: 44px;
    font-weight: bold;
    color: ${color};
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    animation: effectFloat 2s ease-out forwards;
    white-space: nowrap;
  `;
  effect.textContent = text;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    if(effect.parentNode) effect.parentNode.removeChild(effect);
  }, 2000);
}

function grantEmperatrizPowerUp() {
  // Librer√≠a completa de power-ups con probabilidades
  const powerUpLibrary = [
    // Power-ups de da√±o (colores rojos/naranjas)
    { type: 'damage', name: 'Fuerza Her√≥ica', description: '+10% da√±o', multiplier: 1.1, color: '#ef4444', weight: 15 },
    { type: 'damage', name: 'Fuerza Maestra', description: '+20% da√±o', multiplier: 1.2, color: '#dc2626', weight: 10 },
    { type: 'damage', name: 'Fuerza Celestial', description: '+100% da√±o', multiplier: 2.0, color: '#991b1b', weight: 1 },
    
    // Power-ups de tiempo (colores celestes/azules)
    { type: 'time', name: 'Ganarle al tiempo', description: '+10 segundos', bonus: 10, color: '#22d3ee', weight: 12 },
    { type: 'time', name: 'Dominar al tiempo', description: '+20 segundos', bonus: 20, color: '#0891b2', weight: 8 },
    { type: 'time', name: 'Controlar al tiempo', description: '+30 segundos', bonus: 30, color: '#0e7490', weight: 4 },

    // Power-ups especiales (colores dorados/morados)
    { type: 'special', name: 'Intercambio', description: '+25% da√±o y -20s', damageMulti: 1.25, timeBonus: -20, color: '#f59e0b', weight: 8 },
    { type: 'special', name: 'Conf√≠o en m√≠', description: '+40% da√±o y -35s', damageMulti: 1.4, timeBonus: -35, color: '#d97706', weight: 7 },
    { type: 'special', name: 'A todo o nada', description: '+100% da√±o y -60s', damageMulti: 2.0, timeBonus: -60, color: '#db2323', weight: 4 },

    // Power-ups arriesgados (colores verde turquesa)
    { type: 'risky', name: 'Sacrificio del Poder', description: '+25% da√±o y -1 vida', damageMulti: 1.25, livesLost: 1, color: '#14b8a6', weight: 6 },
    { type: 'risky', name: 'Sacrificio del Tiempo', description: '+25s y -1 vida', timeBonus: 25, livesLost: 1, color: '#0d9488', weight: 6 },
    { type: 'risky', name: 'Cueste lo que cueste', description: '+60% da√±o y -1 vida', damageMulti: 1.6, livesLost: 1, color: '#0f766e', weight: 3 },
    { type: 'risky', name: 'Toma mi tiempo', description: '-20s y +1 vida', timeBonus: -20, livesGained: 1, color: '#0891b2', weight: 4 },
    { type: 'risky', name: 'Iluminaci√≥n Divina', description: '+25% da√±o, +20s y +1 vida', damageMulti: 1.25, timeBonus: 20, livesGained: 1, color: '#ffeeba', weight: 2 }
  ];
  
  // Generar 3 opciones aleatorias basadas en peso
  const options = getRandomPowerUpOptions(powerUpLibrary, 3);
  
  // Mostrar modal de selecci√≥n
  showPowerUpSelectionModal(options);
}

function getRandomPowerUpOptions(library, count) {
  // Crear pool basado en pesos
  const weightedPool = [];
  library.forEach(powerUp => {
    for(let i = 0; i < powerUp.weight; i++) {
      weightedPool.push(powerUp);
    }
  });
  
  const options = [];
  const usedIndices = [];
  
  while(options.length < count && options.length < library.length) {
    const randomIndex = Math.floor(Math.random() * weightedPool.length);
    const selectedPowerUp = weightedPool[randomIndex];
    
    // Evitar duplicados
    if(!options.find(opt => opt.name === selectedPowerUp.name)) {
      options.push({...selectedPowerUp}); // Crear copia
    }
  }
  
  return options;
}

function showPowerUpSelectionModal(options) {
  // Pausar el timer mientras se selecciona
  const wasTimerRunning = emperatrizTimerInterval;
  if(wasTimerRunning) {
    clearInterval(emperatrizTimerInterval);
  }
  
  const modal = document.createElement('div');
  modal.id = 'powerUpModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.85);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Jersey 10', monospace;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    text-align: center;
    border: 3px solid #f59e0b;
    box-shadow: 0 20px 40px rgba(0,0,0,0.7);
  `;
  
  modalContent.innerHTML = `
    <div style="font-size: 25px; color: #f59e0b; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
      ‚ö° ELIGE TU PODER ‚ö°
    </div>
    <div style="font-size: 20px; color: #ccc; margin-bottom: 15px;">
      Selecciona un Power-Up
    </div>
    <div style="margin-bottom: 20px;">
      <div style="font-size: 14px; color: #ff6b6b; margin-bottom: 8px;">‚è∞ Tiempo restante: <span id="powerUpTimer">10</span>s</div>
      <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden;">
        <div id="powerUpTimerBar" style="width: 100%; height: 100%; background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); transition: width 0.1s linear;"></div>
      </div>
    </div>
    <div id="powerUpOptions" style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
    </div>
  `;
  
  const optionsContainer = modalContent.querySelector('#powerUpOptions');
  
  options.forEach((powerUp, index) => {
    const optionBtn = document.createElement('button');
    optionBtn.style.cssText = `
      background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(30,30,30,0.7));
      border: 2px solid ${powerUp.color};
      border-radius: 7px;
      padding: 10px;
      min-width: 160px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Jersey 10', monospace;
      color: white;
    `;
    
    optionBtn.innerHTML = `
      <div style="font-size: 18px; color: ${powerUp.color}; margin-bottom: 4px; font-weight: bold;">
        ${powerUp.name}
      </div>
      <div style="font-size: 22px; color: #ccc; line-height: 1;">
        ${powerUp.description}
      </div>
    `;
    
    // Hover effects
    optionBtn.addEventListener('mouseenter', () => {
      optionBtn.style.transform = 'scale(1.05)';
      optionBtn.style.boxShadow = `0 0 20px ${powerUp.color}66`;
    });
    
    optionBtn.addEventListener('mouseleave', () => {
      optionBtn.style.transform = 'scale(1)';
      optionBtn.style.boxShadow = 'none';
    });
    
    // Click handler
    optionBtn.addEventListener('click', () => {
      selectPowerUp(powerUp, wasTimerRunning);
      modal.remove();
    });
    
    optionsContainer.appendChild(optionBtn);
  });
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // Iniciar timer de 10 segundos
  let timeLeft = 10;
  const timerDisplay = modal.querySelector('#powerUpTimer');
  const timerBar = modal.querySelector('#powerUpTimerBar');
  
  const powerUpTimerInterval = setInterval(() => {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    timerBar.style.width = `${(timeLeft / 10) * 100}%`;
    
    // Cambiar color seg√∫n tiempo restante
    if (timeLeft <= 3) {
      timerBar.style.background = '#ef4444'; // Rojo cr√≠tico
    } else if (timeLeft <= 6) {
      timerBar.style.background = '#f59e0b'; // Amarillo advertencia
    }
    
    if (timeLeft <= 0) {
      clearInterval(powerUpTimerInterval);
      // No seleccionar nada, cerrar modal
      modal.remove();
      // Reanudar timer si estaba corriendo
      if(wasTimerRunning && emperatrizActive) {
        startEmperatrizTimer();
      }
    }
  }, 1000);
  
  // Limpiar timer si se selecciona una opci√≥n
  modal.addEventListener('click', () => {
    clearInterval(powerUpTimerInterval);
  });
}

function selectPowerUp(powerUp, wasTimerRunning) {
  // Agregar power-up a la lista
  emperatrizPowerUps.push(powerUp);
  
  // Aplicar efectos seg√∫n tipo
  if(powerUp.type === 'damage') {
    emperatrizDamageMultiplier *= powerUp.multiplier;
    console.log(`üí™ Power-up obtenido: ${powerUp.name} - Multiplicador total: ${emperatrizDamageMultiplier}`);
  } else if(powerUp.type === 'time') {
    emperatrizTimer += powerUp.bonus;
    updateEmperatrizTimer();
    console.log(`‚è∞ Power-up obtenido: ${powerUp.name} - Tiempo a√±adido: ${powerUp.bonus}s`);
    
    // Aplicar glow celeste al timer
    const timerDisplay = document.getElementById('emperatrizTimer');
    if (timerDisplay) {
      timerDisplay.style.animation = 'none';
      void timerDisplay.offsetWidth;
      timerDisplay.style.animation = 'timerTimeGainGlow 0.8s ease-out';
      setTimeout(() => {
        timerDisplay.style.animation = '';
      }, 800);
    }
  } else if(powerUp.type === 'special') {
    emperatrizDamageMultiplier *= powerUp.damageMulti;
    emperatrizTimer += powerUp.timeBonus;
    
    // Mostrar efecto de glow en timer
    if(powerUp.timeBonus < 0) {
      showTimerGlow('#ef4444'); // Rojo para p√©rdida de tiempo
      showTimeChangeNotification(powerUp.timeBonus);
    }
    
    updateEmperatrizTimer();
    console.log(`‚ú® Power-up especial: ${powerUp.name} - Da√±o: ${powerUp.damageMulti}x, Tiempo: ${powerUp.timeBonus}s`);
  } else if(powerUp.type === 'risky') {
    // Power-ups arriesgados
    if(powerUp.damageMulti) {
      emperatrizDamageMultiplier *= powerUp.damageMulti;
    }
    
    if(powerUp.timeBonus) {
      emperatrizTimer += powerUp.timeBonus;
      // Mostrar glow verde para ganancia de tiempo
      showTimerGlow('#10b981');
      showTimeChangeNotification(powerUp.timeBonus);
    }
    
    // Manejo de vidas
    if(powerUp.livesLost) {
      emperatrizLives = Math.max(0, emperatrizLives - powerUp.livesLost);
      updateEmperatrizLivesDisplay();
      console.log(`üíÄ Perdiste ${powerUp.livesLost} vida(s) - Vidas restantes: ${emperatrizLives}`);
      
      // Verificar si se acabaron las vidas
      if(emperatrizLives <= 0) {
        setTimeout(() => {
          showEmperatrizResult(false, 'Sin vidas restantes');
        }, 1000);
      }
    }
    
    if(powerUp.livesGained) {
      emperatrizLives += powerUp.livesGained;
      updateEmperatrizLivesDisplay();
      console.log(`‚ù§Ô∏è Ganaste ${powerUp.livesGained} vida(s) - Vidas totales: ${emperatrizLives}`);
    }
    
    updateEmperatrizTimer();
    console.log(`üé≤ Power-up arriesgado: ${powerUp.name}`);
  }
  
  // Mostrar notificaci√≥n de confirmaci√≥n
  showPowerUpConfirmation(powerUp);
  
  // Reanudar timer si estaba corriendo
  if(wasTimerRunning && emperatrizActive) {
    startEmperatrizTimer();
  }
  
  // Actualizar indicador de power-ups
  updateEmperatrizPowerUpIndicator();
  
  // Actualizar box de power-ups
  updateEmperatrizPowerUpBox();
}

// === POWER-UPS MALDITOS PARA LA EMPERATRIZ ===
function grantEmperatrizCursedPowerUp() {
  // Librer√≠a de power-ups malditos (aparecen cada 5 rondas: 5, 10, 15, 20...)
  const cursedPowerUpLibrary = [
    // P√©rdida de da√±o (colores morados oscuros)
    { type: 'cursed_damage', name: 'Reducci√≥n de Fuerza', description: '-35% da√±o', multiplier: 0.65, color: '#b53145', weight: 8 },
    { type: 'cursed_damage', name: 'Volverse D√©bil', description: '-50% da√±o', multiplier: 0.5, color: '#b53145', weight: 10 },
    
    // P√©rdida de tiempo (colores rojos oscuros)
    { type: 'cursed_time', name: 'Volverse viejo', description: '-45 segundos', bonus: -45, color: '#447eab', weight: 10 },
    { type: 'cursed_time', name: 'Dame tu tiempo', description: '-30 segundos', bonus: -30, color: '#447eab', weight: 8 },
    
    // P√©rdida de vidas (colores negros/grises)
    { type: 'cursed_lives', name: 'Recibir Da√±o', description: '-1 vida', livesLost: 1, color: '#374151', weight: 8 }, 

    // Recuperaci√≥n de la Emperatriz (colores verdes oscuros)
    { type: 'cursed_heal', name: 'Regeneraci√≥n', description: 'Emperatriz se cura +25% faltante', healPercent: 25, color: '#31c469', weight: 8 },
    { type: 'cursed_heal', name: 'El tiempo dir√°', description: 'Emperatriz se cura +40% faltante, tu ganas 20 segs', healPercent: 40, timeBonus: 20, color: '#31c469', weight: 9 },
    { type: 'cursed_heal', name: 'Injusticia', description: 'Emperatriz se cura +99% faltante, tu ganas 20 segs', healPercent: 99, timeBonus: 20, color: '#31c469', weight: 9 },


    // Invulnerabilidad de la Emperatriz (colores dorados oscuros)
    { type: 'cursed_invulnerable', name: 'Invencible', description: 'Emperatriz invulnerable por 2 cartas', cardsProtected: 2, color: '#bd6937', weight: 12 },
    { type: 'cursed_invulnerable', name: 'In√∫til', description: 'Emperatriz invulnerable por 3 cartas', cardsProtected: 3, color: '#bd6937', weight: 12 },



  ];
  
  // Generar 3 opciones aleatorias basadas en peso
  const options = getRandomPowerUpOptions(cursedPowerUpLibrary, 3);
  
  // Mostrar modal de selecci√≥n con tema maldito
  showCursedPowerUpSelectionModal(options);
}

function showCursedPowerUpSelectionModal(options) {
  // Pausar timer mientras se selecciona
  const wasTimerRunning = emperatrizTimerInterval;
  if(wasTimerRunning) {
    clearInterval(emperatrizTimerInterval);
  }
  
  const modal = document.createElement('div');
  modal.id = 'cursedPowerUpModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Jersey 10', monospace;
    animation: cursedModalAppear 0.5s ease-out forwards;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: linear-gradient(135deg, #1f1f1f, #2d1b2d);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    text-align: center;
    border: 3px solid #dc2626;
    box-shadow: 0 20px 40px rgba(220, 38, 38, 0.5), 0 0 30px rgba(220, 38, 38, 0.3);
    animation: cursedPulse 2s ease-in-out infinite alternate;
  `;
  
  const title = document.createElement('h2');
  title.style.cssText = `
    color: #dc2626;
    font-size: 28px;
    margin-bottom: 7px;
    text-shadow: 0 0 10px rgba(220, 38, 38, 0.8);
    text-transform: uppercase;
  `;  
  const subtitle = document.createElement('p');
  subtitle.style.cssText = `
    color: #ef4444;
    font-size: 20px;
    margin-bottom: 10px;
    text-shadow: 0 0 5px rgba(239, 68, 68, 0.6);
  `;
  subtitle.textContent = '¬°Debes elegir tu castigo!';
  
  const optionsContainer = document.createElement('div');
  optionsContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 7px;
    margin-bottom: 10px;
  `;
  
  options.forEach((powerUp, index) => {
    const optionButton = document.createElement('button');
    optionButton.style.cssText = `
      background: linear-gradient(135deg, ${powerUp.color}, ${powerUp.color}dd);
      color: white;
      border: 2px solid ${powerUp.color};
      border-radius: 7px;
      padding: 10px;
      font-family: 'Jersey 10', monospace;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    `;
    
    optionButton.innerHTML = `
      <div style="font-size: 20px; margin-bottom: 4px;">${powerUp.name}</div>
      <div style="font-size: 24px; opacity: 0.9;">${powerUp.description}</div>
    `;
    
    optionButton.onmouseenter = () => {
      optionButton.style.transform = 'translateY(-3px)';
      optionButton.style.boxShadow = `0 8px 25px ${powerUp.color}40`;
    };
    
    optionButton.onmouseleave = () => {
      optionButton.style.transform = 'translateY(0)';
      optionButton.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
    };
    
    optionButton.onclick = () => {
      selectCursedPowerUp(powerUp, wasTimerRunning);
    };
    
    optionsContainer.appendChild(optionButton);
  });
  
  modalContent.appendChild(title);
  modalContent.appendChild(subtitle);
  modalContent.appendChild(optionsContainer);
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // A√±adir estilos de animaci√≥n
  const style = document.createElement('style');
  style.textContent = `
    @keyframes cursedModalAppear {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes cursedPulse {
      from { box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3), 0 0 20px rgba(220, 38, 38, 0.2); }
      to { box-shadow: 0 20px 40px rgba(220, 38, 38, 0.7), 0 0 40px rgba(220, 38, 38, 0.5); }
    }
  `;
  document.head.appendChild(style);
}

function selectCursedPowerUp(powerUp, wasTimerRunning) {
  // Remover modal
  const modal = document.getElementById('cursedPowerUpModal');
  if(modal) modal.remove();
  
  // Agregar power-up maldito a la lista
  emperatrizPowerUps.push(powerUp);
  
  // Aplicar efectos malditos seg√∫n tipo
  if(powerUp.type === 'cursed_damage') {
    emperatrizDamageMultiplier *= powerUp.multiplier;
    console.log(`üíÄ Maldici√≥n aplicada: ${powerUp.name} - Multiplicador total: ${emperatrizDamageMultiplier}`);
  } else if(powerUp.type === 'cursed_time') {
    emperatrizTimer += powerUp.bonus; // bonus es negativo
    updateEmperatrizTimer();
    showTimerGlow('#dc2626'); // Rojo para p√©rdida de tiempo
    showTimeChangeNotification(powerUp.bonus);
    console.log(`‚è∞ Tiempo maldito: ${powerUp.name} - Tiempo perdido: ${Math.abs(powerUp.bonus)}s`);
  } else if(powerUp.type === 'cursed_lives') {
    emperatrizLives = Math.max(0, emperatrizLives - powerUp.livesLost);
    updateEmperatrizLivesDisplay();
    console.log(`üíÄ Vidas perdidas: ${powerUp.livesLost} - Vidas restantes: ${emperatrizLives}`);
    
    // Verificar si se acabaron las vidas
    if(emperatrizLives <= 0) {
      setTimeout(() => {
        showEmperatrizResult(false, 'Sin vidas restantes');
      }, 1000);
    }
  } else if(powerUp.type === 'cursed_heal') {
    // La Emperatriz recupera HP
    const oldHP = emperatrizHP;
    const healAmount = Math.floor((emperatrizMaxHP - emperatrizHP) * (powerUp.healPercent / 100));
    const newHP = Math.min(emperatrizMaxHP, emperatrizHP + healAmount);
    emperatrizHP = newHP;
    previousEmperatrizHP = oldHP;
    animateEmperatrizHPChange(newHP);
    showEmperatrizEffect(`+${healAmount} HP`, '#16a34a');
    console.log(`ü©π Emperatriz sanada: +${healAmount} HP (${powerUp.healPercent}%)`);
    
    // Si el power-up tambi√©n tiene timeBonus, aplicarlo al jugador
    if(powerUp.timeBonus) {
      emperatrizTimer += powerUp.timeBonus;
      updateEmperatrizTimer();
      showTimerGlow('#10b981'); // Verde para ganancia de tiempo
      showTimeChangeNotification(powerUp.timeBonus);
      console.log(`‚è∞ Tiempo bonificado: +${powerUp.timeBonus}s`);
    }
  } else if(powerUp.type === 'cursed_invulnerable') {
    // La Emperatriz se vuelve invulnerable por X cartas
    emperatrizInvulnerableCards = powerUp.cardsProtected;
    showEmperatrizEffect(`¬°INVULNERABLE ${powerUp.cardsProtected} CARTAS!`, '#f59e0b');
    console.log(`üõ°Ô∏è Emperatriz invulnerable por ${powerUp.cardsProtected} cartas`);
  }
  
  // Mostrar notificaci√≥n de maldici√≥n aplicada
  showCursedPowerUpConfirmation(powerUp);
  
  // Reanudar timer si estaba corriendo
  if(wasTimerRunning && emperatrizActive) {
    startEmperatrizTimer();
  }
  
  // Actualizar indicador de power-ups
  updateEmperatrizPowerUpIndicator();
  
  // Actualizar box de power-ups
  updateEmperatrizPowerUpBox();
}

function showCursedPowerUpConfirmation(powerUp) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100001;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.9));
    border: 3px solid ${powerUp.color};
    border-radius: 15px;
    padding: 20px 30px;
    text-align: center;
    font-family: 'Jersey 10', monospace;
    font-size: 18px;
    font-weight: bold;
    color: ${powerUp.color};
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px ${powerUp.color}33;
    animation: cursedPowerUpPulse 2s ease-out forwards;
    max-width: 90vw;
    min-width: 320px;
  `;
  
  notification.innerHTML = `
    <div style="font-size: 24px; margin-bottom: 10px; line-height: 1.2;">üíÄ ¬°La Emperatriz<br>Ataca! üíÄ</div>
    <div style="font-size: 22px; margin-bottom: 8px; line-height: 1.2;">${powerUp.name}</div>
    <div style="font-size: 20px; color: #ccc; line-height: 1.3;">${powerUp.description}</div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if(notification.parentNode) notification.parentNode.removeChild(notification);
  }, 2500);
  
  // A√±adir animaci√≥n espec√≠fica para maldiciones
  const style = document.createElement('style');
  style.textContent = `
    @keyframes cursedPowerUpPulse {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      15% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      30% { transform: translate(-50%, -50%) scale(0.95); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
}

function showTimerGlow(color) {
  const timerEl = document.getElementById('emperatrizTimer');
  if(timerEl) {
    // Si el color es verde/celeste (ganancia de tiempo), usar la animaci√≥n de glow celeste
    if (color === '#10b981' || color === '#22d3ee') {
      timerEl.style.animation = 'none';
      void timerEl.offsetWidth;
      timerEl.style.animation = 'timerTimeGainGlow 0.8s ease-out';
      setTimeout(() => {
        timerEl.style.animation = '';
      }, 800);
    } else {
      // Para otros colores (rojo, p√©rdida de tiempo), usar el m√©todo anterior
      timerEl.style.boxShadow = `0 0 20px ${color}`;
      timerEl.style.borderColor = color;
      
      // Quitar el glow despu√©s de 2 segundos
      setTimeout(() => {
        timerEl.style.boxShadow = '0 4px 8px rgba(255,140,66,0.3)';
        timerEl.style.borderColor = '#ff8c42';
      }, 2000);
    }
  }
}

function showTimeChangeNotification(timeChange) {
  const isPositive = timeChange > 0;
  const text = isPositive ? `+${timeChange}s` : `${timeChange}s`;
  const color = isPositive ? '#10b981' : '#ef4444';
  
  // Buscar la tarjeta actual para posicionar el efecto cerca del timer
  const timerEl = document.getElementById('emperatrizTimer');
  if (!timerEl) return;
  
  const timerRect = timerEl.getBoundingClientRect();
  
  const effect = document.createElement('div');
  effect.style.cssText = `
    position: fixed;
    top: ${timerRect.top - 30}px;
    left: ${timerRect.left + timerRect.width/2}px;
    transform: translateX(-50%);
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
    font-size: 24px;
    font-weight: bold;
    color: ${color};
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    pointer-events: none;
    animation: damageFloat 2s ease-out forwards;
  `;
  effect.textContent = text;
  
  document.body.appendChild(effect);
  
  setTimeout(() => {
    if(effect.parentNode) effect.parentNode.removeChild(effect);
  }, 2000);
}

function showEmperatrizPunishment(lostCard) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100000;
    background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(185,28,28,0.95));
    border: 3px solid #ef4444;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    font-family: 'Jersey 10', monospace;
    color: white;
    box-shadow: 0 10px 30px rgba(239,68,68,0.5);
    animation: punishmentShake 3s ease-out forwards;
    max-width: 350px;
  `;
  
  notification.innerHTML = `
    <div style="font-size: 24px; margin-bottom: 15px;">üíÄ ¬°CASTIGO DE LA EMPERATRIZ! üíÄ</div>
    <div style="font-size: 18px; margin-bottom: 10px;">Has perdido una vida</div>
    <div style="font-size: 16px; margin-bottom: 15px;">
      Car√°cter eliminado de tu colecci√≥n:
    </div>
    <div style="
      font-size: 32px; 
      background: rgba(0,0,0,0.3); 
      padding: 10px; 
      border-radius: 8px; 
      margin-bottom: 10px;
    ">
      ${lostCard.hanzi}
    </div>
    <div style="font-size: 14px; color: #ffcccb;">
      ${lostCard.pinyin} - ${lostCard.meaning}
    </div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if(notification.parentNode) notification.parentNode.removeChild(notification);
  }, 4000);
}

function showPowerUpConfirmation(powerUp) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100001;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.9));
    border: 3px solid ${powerUp.color};
    border-radius: 10px;
    padding: 10px 10px;
    text-align: center;
    font-family: 'Jersey 10', monospace;
    font-size: 18px;
    font-weight: bold;
    color: ${powerUp.color};
    box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 20px ${powerUp.color}33;
    animation: powerUpPulse 2s ease-out forwards;
    max-width: 85vw;
    min-width: 280px;
  `;
  
  notification.innerHTML = `
    <div style="font-size: 22px; margin-bottom: 8px; line-height: 1.2;">‚ö° ¬°PODER<br>OBTENIDO! ‚ö°</div>
    <div style="font-size: 22px; margin-bottom: 6px; line-height: 1.2;">${powerUp.name}</div>
    <div style="font-size: 20px; color: #ccc; line-height: 1.3;">${powerUp.description}</div>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    if(notification.parentNode) notification.parentNode.removeChild(notification);
  }, 2000);
}

function showEmperatrizVictory() {
  console.log('üëë ============ LA EMPERATRIZ VICTORIA ============');
  
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  // Ocultar solo HUD, mantener m√∫sica/fondo hasta que el usuario confirme
  hideEmperatrizUI({ deferCleanup: true });
  
  // ‚è±Ô∏è CALCULAR TIEMPO Y ESTAD√çSTICAS PRIMERO
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  
  // üéâ PRIORIDAD 1: MOSTRAR MODAL INMEDIATAMENTE
  console.log('üéâ MOSTRANDO MODAL DE VICTORIA...');
  try {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100001;
      font-family: 'Jersey 10', monospace;
    `;
    
    modal.innerHTML = `
      <div style="
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 3px solid #10b981;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        animation: victoryGlow 2s ease-in-out infinite alternate;
      ">
        <h2 style="
          color: #10b981;
          font-size: 28px;
          margin-bottom: 15px;
          text-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        ">üëë ¬°VICTORIA √âPICA! üëë</h2>
        
        <div style="color: #ff8c42; font-size: 20px; margin-bottom: 15px;">
          ¬°Has derrotado a La Emperatriz!
        </div>
        
        <div style="color: white; font-size: 18px; margin-bottom: 20px; line-height: 1.6;">
          ¬°Has demostrado ser digno de enfrentar a la poderosa Emperatriz y has salido victorioso!
          <br><br>
          <span style="color: #ff8c42;">Power-ups obtenidos: ${emperatrizPowerUps.length}</span>
          <br>
          <span style="color: #22d3ee;">Tiempo: ${minutes}:${seconds.toString().padStart(2,'0')}</span>
        </div>
        
        <button onclick="cleanupAndGoToRevise()" style="
          background: linear-gradient(135deg, #10b981, #059669);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-family: 'Jersey 10', monospace;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        ¬°CONTINUAR AVENTURA!
      </button>
    </div>
  `;
  
    document.body.appendChild(modal);
    console.log('‚úÖ Modal de victoria mostrado exitosamente');
  } catch (error) {
    console.error('‚ùå Error mostrando modal de victoria:', error);
  }
  
  // üíæ PRIORIDAD 2: GUARDAR PROGRESO (as√≠ncrono, no bloquea UI)
  setTimeout(() => {
    try {
      console.log('üíæ Iniciando guardado de progreso...');
      
      // ¬°MARCAR LA EMPERATRIZ COMO COMPLETADA!
      if (!emperatrizCompleted) {
        emperatrizCompleted = true;
        emperatrizCompletedAt = new Date();
        console.log('üëë ¬°La Emperatriz completada por primera vez!');
        
        // üíæ GUARDAR EN BASE DE DATOS (CR√çTICO)
        console.log('üíæ Guardando en base de datos...');
        try {
          saveUserState();
          console.log('‚úÖ saveUserState() ejecutado');
        } catch (saveError) {
          console.error('‚ùå ERROR CR√çTICO guardando estado:', saveError);
          // Reintentar
          setTimeout(() => {
            console.log('üîÑ Reintentando guardar estado...');
            try {
              saveUserState();
              console.log('‚úÖ saveUserState() reintento exitoso');
            } catch (retryError) {
              console.error('‚ùå ERROR CR√çTICO en reintento:', retryError);
            }
          }, 1000);
        }
        
        // üìñ MARCAR CAP√çTULO DE LA HISTORIA COMO COMPLETADO (no cr√≠tico)
        try {
          if (window.markChapterAsCompleted) {
            console.log('üìñ Marcando chapter9 (La Emperatriz) como completado');
            window.markChapterAsCompleted('chapter9');
          }
        } catch (chapterError) {
          console.error('‚ö†Ô∏è Error marcando cap√≠tulo:', chapterError);
        }
      } else {
        console.log('‚ÑπÔ∏è La Emperatriz ya estaba completada, saltando guardado inicial');
      }
      
      console.log('‚úÖ Proceso de guardado completado');
    } catch (error) {
      console.error('‚ùå ERROR GENERAL en proceso de guardado:', error);
      try {
        saveUserState();
      } catch (finalError) {
        console.error('‚ùå ERROR FATAL - No se pudo guardar:', finalError);
      }
    }
  }, 50);
  
  console.log('üëë ============ FUNCI√ìN showEmperatrizVictory COMPLETADA ============');
}

function showCruzarMarVictory() {
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  // Ocultar solo HUD, mantener m√∫sica/fondo hasta que el usuario confirme
  hideEmperatrizUI({ deferCleanup: true });
  
  // ¬°MARCAR CRUZAR EL MAR COMO COMPLETADO!
  if (!cruzarMarCompleted) {
    cruzarMarCompleted = true;
    cruzarMarCompletedAt = new Date();
    console.log('üåä ¬°Cruzar el Mar completado por primera vez!');
    
    // üîì DESBLOQUEAR NIVEL 2 INMEDIATAMENTE (ANTES DEL MODAL)
    if (!nivel2Unlocked) {
      console.log('üîì Desbloqueando Nivel 2 por completar Cruzar el Mar...');
      nivel2Unlocked = true;
      
      // Forzar actualizaci√≥n visual INMEDIATA del Nivel 2
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
      
      if(nivel2Wrap) {
        nivel2Wrap.style.display = 'block';
        console.log('‚úÖ nivel2Wrap mostrado inmediatamente');
      }
      if(btnNivel2) {
        btnNivel2.style.display = 'block';
        console.log('‚úÖ btnNivel2 mostrado inmediatamente');
      }
      if(nivel2ProgressWrap) {
        nivel2ProgressWrap.style.display = 'flex';
        console.log('‚úÖ nivel2ProgressWrap mostrado inmediatamente');
      }
      
      console.log('‚úÖ Nivel 2 desbloqueado y UI actualizada');
    }
    
    // Guardar despu√©s de actualizar la UI
    saveUserState();
    
    // üìñ MARCAR CAP√çTULO 2 DE LA HISTORIA COMO COMPLETADO
    if (window.markChapterAsCompleted) {
      console.log('üìñ Marcando chapter6 (Cruzar el Mar) como completado');
      window.markChapterAsCompleted('chapter6');
    }
  }
  
  // ‚è±Ô∏è CALCULAR TIEMPO REAL TRANSCURRIDO (no depende del timer del juego)
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  const finalPowerPercent = calculateFinalPowerPercent(emperatrizDamageMultiplier);
  
  showChallengeVictoryModal({
    title: 'üåä ¬°VICTORIA!',
    subtitle: '¬°Has cruzado el mar con √©xito!<br>üöÄ ¬°NIVEL 2 DESBLOQUEADO! üöÄ',
    timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    correctAnswers: sessionCorrect,
    totalAnswers: sessionTotal,
    powerUpsCount: emperatrizPowerUps.length,
    maxPowerPercent: finalPowerPercent,
    primaryColor: '#06b6d4',
    secondaryColor: '#0891b2',
    borderColor: '#06b6d4'
  });
}

function showCruzarCieloVictory() {
  console.log('‚òÅÔ∏è ============ CRUZAR EL CIELO VICTORIA ============');
  
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  // Ocultar solo HUD, mantener m√∫sica/fondo hasta que el usuario confirme
  hideEmperatrizUI({ deferCleanup: true });
  
  // ‚è±Ô∏è CALCULAR TIEMPO Y ESTAD√çSTICAS PRIMERO
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  const finalPowerPercent = calculateFinalPowerPercent(emperatrizDamageMultiplier);
  
  // üéâ PRIORIDAD 1: MOSTRAR MODAL INMEDIATAMENTE (sin esperar nada)
  console.log('üéâ MOSTRANDO MODAL DE VICTORIA...');
  try {
    showChallengeVictoryModal({
      title: '‚òÅÔ∏è ¬°VICTORIA!',
      subtitle: '¬°Has cruzado el cielo!<br>üéä ¬°NIVEL 3 DESBLOQUEADO! üéä',
      timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
      correctAnswers: sessionCorrect,
      totalAnswers: sessionTotal,
      powerUpsCount: emperatrizPowerUps.length,
      maxPowerPercent: finalPowerPercent,
      primaryColor: '#f472b6',
      secondaryColor: '#db2777',
      borderColor: '#f472b6'
    });
    console.log('‚úÖ Modal de victoria mostrado exitosamente');
  } catch (error) {
    console.error('‚ùå Error mostrando modal de victoria:', error);
  }
  
  // üíæ PRIORIDAD 2: GUARDAR PROGRESO INMEDIATAMENTE (as√≠ncrono, no bloquea UI)
  setTimeout(() => {
    try {
      console.log('üíæ Iniciando guardado de progreso...');
      
      // ¬°MARCAR CRUZAR EL CIELO COMO COMPLETADO!
      if (!cruzarCieloCompleted) {
        cruzarCieloCompleted = true;
        cruzarCieloCompletedAt = new Date();
        console.log('‚òÅÔ∏è ¬°Cruzar el Cielo completado por primera vez!');
        
        // üîì DESBLOQUEAR NIVEL 3
        if (!nivel3Unlocked) {
          console.log('üîì Desbloqueando Nivel 3 por completar Cruzar el Cielo...');
          nivel3Unlocked = true;
          
          // Forzar actualizaci√≥n visual INMEDIATA del Nivel 3
          try {
            const nivel3Wrap = document.getElementById('nivel3Wrap');
            const btnNivel3 = document.getElementById('btnNivel3');
            const nivel3ProgressWrap = document.getElementById('nivel3ProgressWrap');
            
            if(nivel3Wrap) {
              nivel3Wrap.style.display = 'block';
              console.log('‚úÖ nivel3Wrap mostrado');
            }
            if(btnNivel3) {
              btnNivel3.style.display = 'block';
              console.log('‚úÖ btnNivel3 mostrado');
            }
            if(nivel3ProgressWrap) {
              nivel3ProgressWrap.style.display = 'flex';
              console.log('‚úÖ nivel3ProgressWrap mostrado');
            }
          } catch (uiError) {
            console.error('‚ö†Ô∏è Error actualizando UI de Nivel 3:', uiError);
          }
          
          // Desbloquear botones del hor√≥scopo (no cr√≠tico, con protecci√≥n)
          try {
            if (typeof updateHoroscopeButtonsState === 'function') {
              updateHoroscopeButtonsState();
              console.log('‚úÖ Botones del hor√≥scopo actualizados');
            } else {
              console.warn('‚ö†Ô∏è updateHoroscopeButtonsState no disponible, programando reintento...');
              setTimeout(() => {
                if (typeof updateHoroscopeButtonsState === 'function') {
                  updateHoroscopeButtonsState();
                  console.log('‚úÖ Botones del hor√≥scopo actualizados (reintento)');
                }
              }, 200);
            }
          } catch (horoscopeError) {
            console.error('‚ö†Ô∏è Error actualizando botones del hor√≥scopo:', horoscopeError);
          }
          
          console.log('‚úÖ Nivel 3 desbloqueado y UI actualizada');
        }
        
        // üíæ GUARDAR EN BASE DE DATOS (CR√çTICO)
        console.log('üíæ Guardando en base de datos...');
        try {
          saveUserState();
          console.log('‚úÖ saveUserState() ejecutado');
        } catch (saveError) {
          console.error('‚ùå ERROR CR√çTICO guardando estado:', saveError);
          // Intentar guardar de nuevo despu√©s de 1 segundo
          setTimeout(() => {
            console.log('üîÑ Reintentando guardar estado...');
            try {
              saveUserState();
              console.log('‚úÖ saveUserState() reintento exitoso');
            } catch (retryError) {
              console.error('‚ùå ERROR CR√çTICO en reintento:', retryError);
            }
          }, 1000);
        }
        
        // üìñ MARCAR CAP√çTULO DE LA HISTORIA COMO COMPLETADO (no cr√≠tico)
        try {
          if (window.markChapterAsCompleted) {
            console.log('üìñ Marcando chapter7 (Cruzar el Cielo) como completado');
            window.markChapterAsCompleted('chapter7');
          }
        } catch (chapterError) {
          console.error('‚ö†Ô∏è Error marcando cap√≠tulo:', chapterError);
        }
      } else {
        console.log('‚ÑπÔ∏è Cruzar el Cielo ya estaba completado, saltando guardado inicial');
      }
      
      console.log('‚úÖ Proceso de guardado completado');
    } catch (error) {
      console.error('‚ùå ERROR GENERAL en proceso de guardado:', error);
      // √öltimo intento de guardar algo
      try {
        saveUserState();
      } catch (finalError) {
        console.error('‚ùå ERROR FATAL - No se pudo guardar:', finalError);
      }
    }
  }, 50); // Peque√±o delay para no bloquear el render del modal
  
  console.log('‚òÅÔ∏è ============ FUNCI√ìN showCruzarCieloVictory COMPLETADA ============');
}

function showCruzarHSK3Victory() {
  console.log('üéì ============ showCruzarHSK3Victory INICIADO ============');
  console.log('üéì emperatrizTimer:', emperatrizTimer);
  console.log('üéì sessionCorrect:', sessionCorrect);
  console.log('üéì sessionTotal:', sessionTotal);
  console.log('üéì emperatrizPowerUps:', emperatrizPowerUps);
  
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  
  // üéµ DETENER M√öSICA INMEDIATAMENTE
  stopDesafioMusic();
  
  hideEmperatrizUI({ deferCleanup: true });
  
  if (!cruzarHSK3Completed) {
    cruzarHSK3Completed = true;
    cruzarHSK3CompletedAt = new Date();
    console.log('üéì ¬°Cruzar HSK3 completado por primera vez!');
    saveUserState(); // CORREGIDO: Era saveProgressToServer
    
    if (window.markChapterAsCompleted) {
      console.log('üìñ Marcando chapter8 (Cruzar HSK3) como completado');
      window.markChapterAsCompleted('chapter8');
    }
  }
  
  // ‚è±Ô∏è CALCULAR TIEMPO REAL TRANSCURRIDO (no depende del timer del juego)
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  const finalPowerPercent = calculateFinalPowerPercent(emperatrizDamageMultiplier);
  
  console.log('üéì Llamando a showChallengeVictoryModal con config:', {
    timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    realTimeElapsed: realTimeElapsed,
    challengeStartTime: challengeStartTime,
    correctAnswers: sessionCorrect,
    totalAnswers: sessionTotal,
    powerUpsCount: emperatrizPowerUps.length,
    maxPowerPercent: finalPowerPercent,
    badgeImage: 'img/badgehsk3.webp'
  });
  
  showChallengeVictoryModal({
    title: 'üéì ¬°VICTORIA!',
    subtitle: '¬°Has dominado el HSK3!<br>‚ú® ¬°BADGE DESBLOQUEADO! ‚ú®',
    timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    correctAnswers: sessionCorrect,
    totalAnswers: sessionTotal,
    powerUpsCount: emperatrizPowerUps.length,
    maxPowerPercent: finalPowerPercent,
    primaryColor: '#a855f7',
    secondaryColor: '#7e22ce',
    borderColor: '#c084fc',
    badgeImage: 'img/badgehsk3.webp',
    badgeName: 'Maestro HSK3'
  });
  
  console.log('üéì ============ showCruzarHSK3Victory COMPLETADO ============');
}

function showCruzarHSK4Victory() {
  console.log('üéØ ============ showCruzarHSK4Victory INICIADO ============');
  console.log('üéØ emperatrizTimer:', emperatrizTimer);
  console.log('üéØ sessionCorrect:', sessionCorrect);
  console.log('üéØ sessionTotal:', sessionTotal);
  console.log('üéØ emperatrizPowerUps:', emperatrizPowerUps);
  
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  
  // üéµ DETENER M√öSICA INMEDIATAMENTE
  stopDesafioMusic();
  
  hideEmperatrizUI({ deferCleanup: true });
  
  if (!cruzarHSK4Completed) {
    cruzarHSK4Completed = true;
    cruzarHSK4CompletedAt = new Date();
    console.log('üéØ ¬°Cruzar HSK4 completado por primera vez!');
    saveUserState(); // CORREGIDO: Era saveProgressToServer
    
    if (window.markChapterAsCompleted) {
      console.log('üìñ Marcando chapter9 (Cruzar HSK4) como completado');
      window.markChapterAsCompleted('chapter9');
    }
  }
  
  // ‚è±Ô∏è CALCULAR TIEMPO REAL TRANSCURRIDO (no depende del timer del juego)
  const realTimeElapsed = challengeStartTime ? Math.floor((Date.now() - challengeStartTime) / 1000) : 0;
  const minutes = Math.floor(realTimeElapsed / 60);
  const seconds = realTimeElapsed % 60;
  const finalPowerPercent = calculateFinalPowerPercent(emperatrizDamageMultiplier);
  
  console.log('üéØ Llamando a showChallengeVictoryModal con config:', {
    timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    realTimeElapsed: realTimeElapsed,
    challengeStartTime: challengeStartTime,
    correctAnswers: sessionCorrect,
    totalAnswers: sessionTotal,
    powerUpsCount: emperatrizPowerUps.length,
    maxPowerPercent: finalPowerPercent,
    badgeImage: 'img/badgehsk4.webp'
  });
  
  showChallengeVictoryModal({
    title: 'üéØ ¬°VICTORIA!',
    subtitle: '¬°Has conquistado el HSK4!<br>üèÜ ¬°BADGE DESBLOQUEADO! üèÜ',
    timeText: `${minutes}:${seconds.toString().padStart(2, '0')}`,
    correctAnswers: sessionCorrect,
    totalAnswers: sessionTotal,
    powerUpsCount: emperatrizPowerUps.length,
    maxPowerPercent: finalPowerPercent,
    primaryColor: '#ec4899',
    secondaryColor: '#be185d',
    borderColor: '#f9a8d4',
    badgeImage: 'img/badgehsk4.webp',
    badgeName: 'Maestro HSK4'
  });
  
  console.log('üéØ ============ showCruzarHSK4Victory COMPLETADO ============');
}

function showEmperatrizResult(victory, reason) {
  // üî¥ CHECKPOINT: Guardar al terminar desaf√≠o Emperatriz/Cruzar el Mar/Cruzar el Cielo
  console.log(`üî¥ CHECKPOINT [showEmperatrizResult]: HAGO FLUSH - Victoria: ${victory}, Cola: ${SaveQueue.getQueueSize()} ops`);
  SaveQueue.flush();
  
  emperatrizActive = false;
  clearInterval(emperatrizTimerInterval);
  // Ocultar solo HUD, mantener m√∫sica/fondo hasta que el usuario confirme
  hideEmperatrizUI({ deferCleanup: true });
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    font-family: 'Jersey 10', monospace;
  `;
  
  const borderColor = victory ? '#10b981' : '#ef4444';
  const titleText = victory ? 'üëë ¬°VICTORIA!' : 'üíÄ DERROTA';
  const titleColor = victory ? '#10b981' : '#ef4444';
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid ${borderColor};
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 30px ${borderColor}66;
    ">
      <h2 style="
        color: ${titleColor};
        font-size: 24px;
        margin-bottom: 15px;
        text-shadow: 0 0 8px ${borderColor};
      ">${titleText}</h2>
      
      <p style="
        color: #ffffff;
        font-size: 18px;
        margin-bottom: 20px;
        line-height: 1.4;
      ">${reason}</p>
      
      <button onclick="cleanupAndGoToRevise()" style="
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        IR A REPASAR
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// =============================== CONFIGURACIONES DE DESAF√çOS ===============================
const challengeConfigs = {
  emperatriz: {
    name: 'LA EMPERATRIZ',
    emoji: 'üëë',
    displayName: 'EMPERATRIZ',
    hp: 15000,
    timer: 300, // 5 minutos
    lives: 3,
    cardPool: 'all', // 'all', 'n1', 'n2', etc.
    hasLastStand: true,
    backgroundColor: 'emperatriz', // Clase CSS del fondo
    music: 'musiceleste', // Archivo de m√∫sica
    musicVolume: 0.8,
    color: '#ff8c42',
    gradient: 'from-teal-600 to-emerald-600'
  },
  
  // Nuevo desaf√≠o - Cruzar el Mar
  cruzarMar: {
    name: 'CRUZAR EL MAR',
    emoji: 'üåä',
    displayName: 'MAR',
    hp: 5000,
    timer: 240, // 4 minutos
    lives: 3,
    cardPool: 'n1', // Solo nivel 1
    hasLastStand: false,
    backgroundColor: 'dust', // Fondo dust
    music: 'musimar', // M√∫sica para Cruzar el Mar
    musicVolume: 0.9,
    color: '#0891b2',
    gradient: 'from-cyan-600 to-blue-600'
  },
  
  // Nuevo desaf√≠o - Cruzar el Cielo
  cruzarCielo: {
    name: 'cruzarCielo',
    emoji: '‚òÅÔ∏è',
    displayName: 'CIELO',
    hp: 6000,
    timer: 300, // 5 minutos
    lives: 3,
    cardPool: 'n2', // Solo nivel 2
    hasLastStand: false,
    backgroundColor: 'cruzaelcielo', // Fondo cruzaelcielo.mp4
    music: 'musirose', // M√∫sica musirosa (naranja)
    musicVolume: 0.9,
    color: '#f97316',
    gradient: 'from-orange-500 to-orange-600'
  },
  
  // Nuevo desaf√≠o - Cruzar HSK3
  cruzarHSK3: {
    name: 'Cruzar HSK3',
    emoji: 'üéì',
    displayName: 'Cruzar HSK3',
    hp: 6000,
    timer: 360, // 6 minutos
    lives: 3,
    cardPool: 'hsk3', // Solo HSK3
    hasLastStand: false,
    backgroundColor: 'cruzarhsk3', // Fondo cruzarhsk3.mp4
    music: 'musiverde', // M√∫sica musirose
    musicVolume: 0.7,
    color: '#78350f',
    gradient: 'from-amber-900 to-amber-950'
  },
  
  // Nuevo desaf√≠o - Cruzar HSK4
  cruzarHSK4: {
    name: 'Cruzar HSK4',
    emoji: 'üéØ',
    displayName: 'Cruzar HSK4',
    hp: 7000,
    timer: 420, // 7 minutos
    lives: 3,
    cardPool: 'hsk4', // Solo HSK4
    hasLastStand: false,
    backgroundColor: 'cruzarhsk4', // Fondo cruzarhsk4.mp4
    music: 'cruzahsk4', // M√∫sica cruzahsk4
    musicVolume: 0.9,
    color: '#1f2937',
    gradient: 'from-gray-800 to-black'
  }
};

// Variable global para el desaf√≠o actual
let currentChallengeConfig = null;

// =============================== FUNCI√ìN GEN√âRICA DE DESAF√çOS ===============================
function startBossChallenge(challengeType) {
  const config = challengeConfigs[challengeType];
  if (!config) {
    console.error(`‚ùå Configuraci√≥n no encontrada para: ${challengeType}`);
    return;
  }
  
  // üî¥ CHECKPOINT: Guardar antes de iniciar desaf√≠o jefe
  console.log(`üî¥ CHECKPOINT [startBossChallenge - ${config.name}]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
  SaveQueue.flush();
  
  currentChallengeConfig = config;
  console.log(`${config.emoji} Iniciando ${config.name}`);
  
  // ‚è±Ô∏è REGISTRAR TIMESTAMP DE INICIO DEL DESAF√çO
  challengeStartTime = Date.now();
  console.log(`‚è±Ô∏è Tiempo de inicio registrado: ${new Date(challengeStartTime).toLocaleTimeString()}`);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Limpiar sistemas de desaf√≠o activos
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  if (desafioNActive || desafioNTimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o N');
    desafioNActive = false;
    stopDesafioNTimer();
    hideDesafioNHearts();
  }
  
  if (desafioClasico2Active || desafioClasico2TimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o Cl√°sico');
    desafioClasico2Active = false;
    stopDesafioClasico2Timer();
    hideDesafioClasico2Hearts();
  }
  
  // Limpiar 12 Bestias si est√° activo
  if (bestias12Active || bestias12TimerInterval) {
    console.log('üßπ Limpiando 12 Bestias');
    bestias12Active = false;
    clearInterval(bestias12TimerInterval);
    hideBestias12UI();
  }
  
  // Configurar variables del desaf√≠o usando la configuraci√≥n
  emperatrizActive = true; // Reutilizamos las mismas variables
  emperatrizHP = config.hp;
  emperatrizMaxHP = config.hp; // ¬°IMPORTANTE! Tambi√©n actualizar el HP m√°ximo
  emperatrizTimer = config.timer;
  emperatrizLives = config.lives;
  emperatrizPowerUps = [];
  emperatrizCardsAnswered = 0;
  emperatrizDamageMultiplier = 1.0;
  emperatrizTimeBonus = 0;
  emperatrizLevel = 1;
  emperatrizLastStandTriggered = false;
  emperatrizInvulnerableCards = 0;
  emperatrizAbsorbingDamage = 0;
  
  // Configurar pool de cartas
  if (config.cardPool !== 'all') {
    console.log(`üé¥ Configurando pool de cartas: ${config.cardPool}`);
    
    // IMPORTANTE: Crear variable temporal para el desaf√≠o sin modificar el array global
    if (config.cardPool === 'n2') {
      // Filtrar cartas de Nivel 2 SIN modificar el array global
      const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
      window.challengeCards = cards.filter(card => nivel2Units.some(u => card.unit.split('|').includes(u)));
      console.log(`üé¥ Pool temporal creado: ${window.challengeCards.length} cartas de Nivel 2`);
    } else if (config.cardPool === 'n1') {
      // Filtrar cartas de Nivel 1 SIN modificar el array global
      const nivel1Units = ['unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', 'unit10', 'unit11', 'unit12'];
      window.challengeCards = cards.filter(card => nivel1Units.some(u => card.unit.split('|').includes(u)));
      console.log(`üé¥ Pool temporal creado: ${window.challengeCards.length} cartas de Nivel 1`);
    } else if (config.cardPool === 'hsk3') {
      // Filtrar cartas de HSK3 SIN modificar el array global
      window.challengeCards = cards.filter(card => card.unit && card.unit.startsWith('HSK3unit'));
      console.log(`üé¥ Pool temporal creado: ${window.challengeCards.length} cartas de HSK3`);
    } else if (config.cardPool === 'hsk4') {
      // Filtrar cartas de HSK4 SIN modificar el array global
      window.challengeCards = cards.filter(card => card.unit && card.unit.startsWith('HSK4unit'));
      console.log(`üé¥ Pool temporal creado: ${window.challengeCards.length} cartas de HSK4`);
    } else if (config.cardPool === 'horoscopo') {
      // Filtrar cartas del hor√≥scopo SIN modificar el array global
      const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
      window.challengeCards = cards.filter(card => horoscopeUnits.some(u => card.unit.split('|').includes(u)));
      console.log(`üé¥ Pool temporal creado: ${window.challengeCards.length} cartas del Hor√≥scopo`);
    }
  } else {
    // Para 'all', usar N1 + N2 + N3 + Hor√≥scopo (NO HSK3/HSK4)
    const nivel1Units = ['unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', 'unit10', 'unit11', 'unit12'];
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    const allUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
    window.challengeCards = cards.filter(card => {
      // Verificar si la unidad de la carta est√° en las unidades permitidas
      return allUnits.some(u => card.unit.split('|').includes(u));
    });
    console.log(`üé¥ Pool temporal creado (ALL): ${window.challengeCards.length} cartas (N1+N2+N3+Hor√≥scopo)`);
  }
  
  // ‚ùå NO CAMBIAR M√öSICA AQU√ç - Se inicia en el countdown
  // La m√∫sica se maneja autom√°ticamente en playDesafioMusic() durante el countdown
  // if (config.music && config.music !== 'trackchin1') {
  //   changeGameMusic(config.music);
  // }
  
  // Cambiar fondo si es diferente
  if (config.backgroundColor && config.backgroundColor !== 'emperatriz') {
    changeGameBackground(config.backgroundColor);
  }
  
  // Iniciar modo desaf√≠o
  startMission('emperatriz'); // Reutilizamos el sistema existente
  
  // Sobrescribir currentMission con el nombre real del desaf√≠o para quiz options
  currentMission = config.name;
  console.log(`‚úÖ currentMission establecido a: ${config.name}`);
  
  // Inicializar UI especial
  initEmperatrizUI();
  
  // ========= ACTIVAR SISTEMA DE ASISTENCIA (LILI AYUDA) =========
  initAssistanceForChallenge();
  console.log(`üÜò Sistema de asistencia activado para ${config.name}`);
  
  // Actualizar statMission con la configuraci√≥n (DESPU√âS de initEmperatrizUI)
  const statMission = document.getElementById('statMission');
  if (statMission) {
    statMission.textContent = config.displayName;
    statMission.style.color = config.color;
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '16px';
    statMission.style.textShadow = `0 0 10px ${config.color}50`;
    console.log(`üéØ Nombre del desaf√≠o actualizado a: ${config.displayName}`);
  }
  
  // Iniciar timer
  const timerCallback = () => {
    startEmperatrizTimer();
    console.log(`${config.emoji} Timer iniciado despu√©s de preload`);
  };

  if (preloadingChallenge) {
    console.log('‚è∞ Desaf√≠o en precarga - agendando timer');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  console.log(`${config.emoji} Desaf√≠o ${config.name} configurado exitosamente`);
}

// Funci√≥n para cambiar m√∫sica del juego
function changeGameMusic(musicName) {
  console.log(`üéµ Cambiando m√∫sica a: ${musicName}`);
  
  // Detener TODA la m√∫sica existente
  if (window.currentGameAudio) {
    window.currentGameAudio.pause();
    window.currentGameAudio.currentTime = 0;
    window.currentGameAudio = null;
  }
  
  // Detener m√∫sica del juego principal si existe
  if (window.gameAudio) {
    window.gameAudio.pause();
    window.gameAudio.currentTime = 0;
  }
  
  // Detener m√∫sica de bienvenida si sigue activa
  if (window.bonfireAudio && !window.bonfireAudio.paused) {
    try { window.bonfireAudio.pause(); window.bonfireAudio.currentTime = 0; } catch (e) {}
    window.bonfireAudio = null;
    console.log('üîá bonfiremusic detenida antes de iniciar m√∫sica del juego');
  }

  // Detener m√∫sica de desaf√≠os cl√°sicos si est√° activa
  if (typeof stopDesafioMusic === 'function') {
    stopDesafioMusic();
  }

  // Detener cualquier otro audio que pueda estar reproduci√©ndose
  const allAudios = document.querySelectorAll('audio');
  allAudios.forEach(audio => {
    audio.pause();
    audio.currentTime = 0;
  });
  
  // Reproducir nueva m√∫sica solo si se especifica
  if (musicName && musicName !== 'none') {
    const audio = new Audio(`music/${musicName}.mp3`);
    audio.loop = true;
    // Volumen por defecto 0.3, pero si hay config activa usar su musicVolume
    const configuredVolume = (currentChallengeConfig && typeof currentChallengeConfig.musicVolume === 'number')
      ? currentChallengeConfig.musicVolume
      : 0.3;
    audio.volume = configuredVolume;
    audio.play().catch(e => console.log('Error reproduciendo m√∫sica:', e));
    window.currentGameAudio = audio;
    console.log(`üéµ M√∫sica ${musicName} iniciada (volumen ${audio.volume})`);
  } else {
    console.log('üîá M√∫sica silenciada');
  }
}

// Funci√≥n para cambiar fondo del juego
function changeGameBackground(backgroundClass) {
  const body = document.body;
  // Guardar el fondo original si no existe
  if (!window.originalBackground) {
    window.originalBackground = body.style.backgroundColor || '#100e37';
  }
  
  if (backgroundClass === 'restore') {
    // Restaurar fondo original
    body.classList.remove('emperatriz-bg', 'dust-bg', 'cruzaelcielo-bg', 'cruzarhsk3-bg', 'cruzarhsk4-bg');
    body.style.backgroundColor = window.originalBackground;
    window.originalBackground = null;
  } else {
    // Remover clases de fondo existentes
    body.classList.remove('emperatriz-bg', 'dust-bg', 'cruzaelcielo-bg', 'cruzarhsk3-bg', 'cruzarhsk4-bg');
    // A√±adir nueva clase de fondo
    body.classList.add(`${backgroundClass}-bg`);
  }
}

// Funciones wrapper para mantener compatibilidad
function startEmperatrizChallenge() {
  startBossChallenge('emperatriz');
}

function startCruzarMarChallenge() {
  startBossChallenge('cruzarMar');
}

function startCruzarCieloChallenge() {
  startBossChallenge('cruzarCielo');
}

function startCruzarHSK3Challenge() {
  startBossChallenge('cruzarHSK3');
}

function startCruzarHSK4Challenge() {
  startBossChallenge('cruzarHSK4');
}

// =============================== LAST STAND DE LA EMPERATRIZ ===============================
function showEmperatrizLastStand() {
  console.log('üíÄ ¬°LAST STAND DE LA EMPERATRIZ ACTIVADO!');
  
  // Opciones FIJAS (siempre aparecen)
  const fixedOptions = [
    {
      id: 'time_loss',
      name: '‚è∞ Distorsi√≥n Temporal',
      description: 'Pierdes 2 minutos',
      effect: 'Tiempo reducido en 120 segundos'
    },
    {
      id: 'life_loss',
      name: 'üíÄ Maldici√≥n Mortal',
      description: 'Pierdes 2 vidas',
      effect: 'Vidas reducidas en 2'
    }
  ];
  
  // Opciones ALEATORIAS (se eligen 2 al azar)
  const randomOptions = [
    {
      id: 'damage_reduction',
      name: 'üê•Te cre√≠as fuerte',
      description: 'Pierdes 90% de tu da√±o',
      effect: 'Multiplicador de da√±o reducido a 0.1x'
    },
    {
      id: 'desperate_gamble',
      name: 'üî• Apuesta Desesperada',
      description: 'Emperatriz se cura 90%, pero obtienes da√±o x2',
      effect: 'Intercambio riesgoso de poder'
    },
    {
      id: 'invulnerability',
      name: 'üõ°Ô∏è Hacer cosquillas',
      description: 'Emperatriz invulnerable por 6 turnos',
      effect: 'Inmunidad temporal completa'
    },
    {
      id: 'damage_absorption',
      name: 'ü©∏ Absorci√≥n Vamp√≠rica',
      description: 'Absorbe tu da√±o por 4 turnos y se cura',
      effect: 'Tu da√±o se convierte en curaci√≥n para la Emperatriz'
    }
  ];
  
  // Seleccionar 2 opciones aleatorias
  const shuffledRandom = [...randomOptions].sort(() => Math.random() - 0.5);
  const selectedRandom = shuffledRandom.slice(0, 2);
  
  // Combinar opciones fijas + aleatorias = 4 total
  const cursedOptions = [...fixedOptions, ...selectedRandom];
  
  console.log('üíÄ Opciones del Last Stand:', cursedOptions.map(o => o.name));

  // Crear modal con tema gris oscuro/siniestro
  const modal = document.createElement('div');
  modal.id = 'emperatrizLastStandModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 100002;
    background: radial-gradient(circle, rgba(20,20,20,0.95), rgba(0,0,0,0.98));
    display: flex;
    align-items: center;
    justify-content: center;
    animation: lastStandFadeIn 1s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      border: 4px solid #666666;
      border-radius: 10px;
      padding: 15px;
      max-width: 90vw;
      width: 600px;
      text-align: center;
      font-family: 'Jersey 10', monospace;
      color: #cccccc;
      box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 30px rgba(102,102,102,0.3);
      animation: lastStandPulse 3s ease-in-out infinite;
    ">
      <div style="font-size: 32px; margin-bottom: 15px; color: #ff4444;">
        üíÄ ¬°FASE FINAL! üíÄ
      </div>
      <div style="font-size: 20px; margin-bottom: 25px; color: #aaaaaa;">
        La Emperatriz desata su poder
      </div>
      
      <div id="lastStandOptions" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
        ${cursedOptions.map(option => `
          <button onclick="applyEmperatrizLastStand('${option.id}')" style="
            background: linear-gradient(135deg, #333333, #555555);
            border: 2px solid #777777;
            border-radius: 7px;
            padding: 10px;
            color: #ffffff;
            font-family: 'Jersey 10', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
          " onmouseover="this.style.background='linear-gradient(135deg, #444444, #666666)'; this.style.borderColor='#999999'" onmouseout="this.style.background='linear-gradient(135deg, #333333, #555555)'; this.style.borderColor='#777777'">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${option.name}</div>
            <div style="font-size: 18px; color: #cccccc; margin-bottom: 5px;">${option.description}</div>
          </button>
        `).join('')}
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

function applyEmperatrizLastStand(optionId) {
  console.log(`üíÄ Aplicando Last Stand: ${optionId}`);
  
  // Cerrar modal
  const modal = document.getElementById('emperatrizLastStandModal');
  if (modal) {
    modal.remove();
  }

  switch(optionId) {
    case 'damage_reduction':
      // Pierdes 90% de tu da√±o (multiplicador 0.1)
      emperatrizDamageMultiplier *= 0.1;
      showEmperatrizEffect('DA√ëO REDUCIDO AL 10%', '#ff4444');
      console.log(`üíî Last Stand - Da√±o reducido: ${emperatrizDamageMultiplier}x`);
      break;
      
    case 'time_loss':
      // Pierdes 2 minutos
      emperatrizTimer = Math.max(0, emperatrizTimer - 120);
      updateEmperatrizTimer();
      showTimerGlow('#ef4444');
      showTimeChangeNotification(-120);
      showEmperatrizEffect('TIEMPO PERDIDO: -2 MIN', '#ff4444');
      break;
      
    case 'life_loss':
      // Pierdes 2 vidas
      emperatrizLives = Math.max(0, emperatrizLives - 2);
      updateEmperatrizLivesDisplay();
      showEmperatrizEffect('VIDAS PERDIDAS: -2', '#ff4444');
      
      // Verificar si se acabaron las vidas
      if(emperatrizLives <= 0) {
        setTimeout(() => {
          showEmperatrizResult(false, 'Sin vidas restantes');
        }, 2000);
      }
      break;
      
    case 'desperate_gamble':
      // Emperatriz se cura 90%, jugador obtiene da√±o x2
      const currentHP = emperatrizHP;
      const healAmount = Math.floor((emperatrizMaxHP - currentHP) * 0.9);
      emperatrizHP = Math.min(emperatrizMaxHP, currentHP + healAmount);
      previousEmperatrizHP = currentHP;
      animateEmperatrizHPChange(emperatrizHP);
      
      // Jugador obtiene x2 da√±o
      emperatrizDamageMultiplier *= 2.0;
      
      showEmperatrizEffect(`EMPERATRIZ +${healAmount} HP`, '#16a34a');
      setTimeout(() => {
        showEmperatrizEffect('TU DA√ëO x2', '#ff8c42');
      }, 1000);
      console.log(`üî• Last Stand - Apuesta desesperada: Emperatriz curada ${healAmount} HP, tu da√±o: ${emperatrizDamageMultiplier}x`);
      break;
      
    case 'invulnerability':
      // Emperatriz invulnerable por 7 turnos
      emperatrizInvulnerableCards = 7;
      showEmperatrizEffect('INVULNERABLE x7 TURNOS', '#f59e0b');
      break;
      
    case 'damage_absorption':
      // Absorbe el da√±o por 4 turnos y se cura con √©l
      emperatrizAbsorbingDamage = 4;
      showEmperatrizEffect('ABSORCI√ìN VAMP√çRICA x4', '#9f1239');
      console.log(`ü©∏ Last Stand - Absorci√≥n vamp√≠rica activada por 4 turnos`);
      break;
  }
  
  console.log(`üíÄ Last Stand aplicado: ${optionId}`);
}

// CSS para las animaciones del Last Stand
const lastStandStyles = `
  @keyframes lastStandFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes lastStandPulse {
    0%, 100% { box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 30px rgba(102,102,102,0.3); }
    50% { box-shadow: 0 20px 60px rgba(0,0,0,0.8), 0 0 50px rgba(255,68,68,0.4); }
  }
`;

// Agregar estilos si no existen
if (!document.getElementById('lastStandStyles')) {
  const styleSheet = document.createElement('style');
  styleSheet.id = 'lastStandStyles';
  styleSheet.textContent = lastStandStyles;
  document.head.appendChild(styleSheet);
}

// =============================== MODAL DE PREVIEW ===============================
function showUnitPreviewModal(unitType, callback) {
  console.log(`üìã Mostrando Modal de Preview para unidad: ${unitType}`);
  
  // Filtrar tarjetas de la unidad espec√≠fica (soporte multi-unidad con |)
  const unitCards = cards.filter(card => card.unit.split('|').includes(unitType));
  
  // Mapear nombres de unidades para el t√≠tulo
  const unitNames = {
    // Nivel 1 - Solo n√∫mero de unidad y nivel
    'unit2': 'Unidad 2 N1',
    'unit3': 'Unidad 3 N1',
    'unit4': 'Unidad 4 N1',
    'unit5': 'Unidad 5 N1',
    'unit6': 'Unidad 6 N1',
    'unit7': 'Unidad 7 N1',
    'unit8': 'Unidad 8 N1',
    'unit9': 'Unidad 9 N1',
    // Nivel 2 - Solo n√∫mero de unidad y nivel
    'unit1N2': 'Unidad 1 N2',
    'unit2N2': 'Unidad 2 N2',
    'unit3N2': 'Unidad 3 N2',
    'unit4N2': 'Unidad 4 N2',
    'unit5N2': 'Unidad 5 N2',
    'unit6N2': 'Unidad 6 N2',
    'unit7N2': 'Unidad 7 N2',
    'unit8N2': 'Unidad 8 N2',
    'unit9N2': 'Unidad 9 N2',
    // Nivel 3 - Solo n√∫mero de unidad y nivel
    'unit1N3': 'Unidad 1 N3',
    'unit2N3': 'Unidad 2 N3',
    'unit3N3': 'Unidad 3 N3',
    'unit4N3': 'Unidad 4 N3',
    'unit5N3': 'Unidad 5 N3',
    'unit6N3': 'Unidad 6 N3',
    'unit7N3': 'Unidad 7 N3',
    'unit8N3': 'Unidad 8 N3',
    'unit9N3': 'Unidad 9 N3',
    // Hor√≥scopo Chinos - Mantener nombres descriptivos
    'colores': 'Colores',
    'fruta': 'Frutas',
    'verduras': 'Verduras',
    'comidas': 'Comidas',
    'animales': 'Animales',
    'deportes': 'Deportes',
    'hobbies': 'Hobbies/Pasatiempos',
    'ropa': 'Ropa y Accesorios',
    'casa': 'Casa y Hogar',
    'cuerpo': 'Partes del Cuerpo',
    'profesiones': 'Profesiones',
    'emociones': 'Emociones y Sentimientos'
  };
  
  const unitDisplayName = unitNames[unitType] || unitType;
  
  // Crear el modal
  const modal = document.createElement('div');
  modal.id = 'unitPreviewModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 100003;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: previewFadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #ffc853, #ffb829);
      border: 3px solid #e6a700;
      border-radius: 15px;
      padding: 25px;
      max-width: 90vw;
      max-height: 90vh;
      width: 800px;
      font-family: 'Jersey 10', monospace;
      color: #2d2d2d;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 30px rgba(255,200,83,0.4);
      overflow-y: auto;
      position: relative;
    ">
      <!-- Header con t√≠tulo y botones -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
          <h2 style="font-size: 24px; font-weight: bold; margin: 0; color: #1a1a1a;">
            ${unitDisplayName}
          </h2>
          <p style="font-size: 16px; margin: 5px 0 0 0; opacity: 0.8;">
            ${unitCards.length} caracteres
          </p>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="continueToUnit()" style="
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: 2px solid #15803d;
            border-bottom: 4px solid #15803d;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Jersey 10', monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: previewPulse 2s infinite;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
            üí™ Entrar a la Unidad
          </button>
          <button onclick="closeUnitPreviewModal()" style="
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 2px solid #b91c1c;
            border-bottom: 4px solid #b91c1c;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: 'Jersey 10', monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'">
            ‚úï
          </button>
        </div>
      </div>
      
      <!-- Grid de tarjetas -->
      <div id="previewCardsGrid" style="
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 12px;
        min-height: 200px;
      ">
        ${unitCards.map(card => {
          const isKnown = card.known;
          const level = card.challengeStreak || 0;
          const category = (card.cat || 'E').toUpperCase();
          
          return `
            <div style="
              background: ${isKnown ? 'linear-gradient(135deg, #fcd34d, #f59e0b)' : 'linear-gradient(135deg, #6b7280, #4b5563)'};
              border: 2px solid ${isKnown ? '#d97706' : '#374151'};
              border-radius: 12px;
              padding: 8px;
              transition: all 0.2s ease;
              cursor: pointer;
              aspect-ratio: 1;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              width: 100%;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
              
              <!-- Hanzi principal centrado -->
              <div style="
                font-size: ${card.hanzi.length <= 2 ? 'clamp(14px, 3.5vw, 20px)' : card.hanzi.length <= 3 ? 'clamp(12px, 3vw, 16px)' : 'clamp(10px, 2.5vw, 14px)'};
                font-weight: bold;
                color: ${isKnown ? '#1f2937' : '#f3f4f6'};
                text-shadow: 1px 1px 2px ${isKnown ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.5)'};
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                line-height: 1.1;
                padding: 6px;
                word-break: keep-all;
                hyphens: none;
                max-width: calc(100% - 24px);
                max-height: calc(100% - 36px);
                overflow: hidden;
              ">
                ${card.hanzi}
              </div>
              
              <!-- Badge de nivel (esquina superior derecha) -->
              <div style="
                position: absolute;
                top: 6px;
                right: 6px;
                min-width: 24px;
                height: 20px;
                border-radius: 10px;
                background: ${isKnown ? '#d97706' : '#6b7280'};
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: bold;
                color: white;
                z-index: 3;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
              ">
                ${level}
              </div>
              
              <!-- Badge de categor√≠a (esquina inferior izquierda) -->
              <div style="
                position: absolute;
                bottom: 6px;
                left: 6px;
                padding: 2px 6px;
                border-radius: 6px;
                background: ${isKnown ? 'rgba(217, 119, 6, 0.9)' : 'rgba(107, 114, 128, 0.8)'};
                color: white;
                font-size: 10px;
                font-weight: bold;
                z-index: 3;
                backdrop-filter: blur(8px);
              ">
                ${category}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <div style="margin-top: 20px; text-align: center; font-size: 14px; opacity: 0.7;">
        üíõ Amarillo = Ya conoces | ‚ö´ Gris = A√∫n no aprendido
      </div>
    </div>
  `;

  // Variables globales para el callback
  window.unitPreviewCallback = callback;
  window.continueToUnit = () => {
    closeUnitPreviewModal();
    if (window.unitPreviewCallback) {
      window.unitPreviewCallback();
    }
  };

  document.body.appendChild(modal);
  
  // Ajustar grid seg√∫n tama√±o de pantalla con ratio cuadrado
  const grid = document.getElementById('previewCardsGrid');
  const updateGridColumns = () => {
    const width = window.innerWidth;
    if (width < 480) {
      grid.style.gridTemplateColumns = 'repeat(3, 1fr)'; // M√≥vil peque√±o: 3 columnas
    } else if (width < 640) {
      grid.style.gridTemplateColumns = 'repeat(4, 1fr)'; // M√≥vil: 4 columnas
    } else if (width < 768) {
      grid.style.gridTemplateColumns = 'repeat(5, 1fr)'; // Tablet peque√±o: 5 columnas
    } else if (width < 1024) {
      grid.style.gridTemplateColumns = 'repeat(6, 1fr)'; // Tablet: 6 columnas
    } else if (width < 1280) {
      grid.style.gridTemplateColumns = 'repeat(7, 1fr)'; // Desktop: 7 columnas
    } else {
      grid.style.gridTemplateColumns = 'repeat(8, 1fr)'; // Desktop grande: 8 columnas
    }
  };
  
  updateGridColumns();
  window.addEventListener('resize', updateGridColumns);
  
  console.log(`üìã Modal de Preview mostrado: ${unitCards.length} tarjetas`);
}

function closeUnitPreviewModal() {
  const modal = document.getElementById('unitPreviewModal');
  if (modal) {
    modal.style.animation = 'previewFadeOut 0.2s ease-in forwards';
    setTimeout(() => {
      modal.remove();
      // Limpiar variables globales (updateGridColumns es local, no necesita limpieza)
      window.unitPreviewCallback = null;
      window.continueToUnit = null;
    }, 200);
  }
}

// CSS para animaciones del Modal de Preview
const previewModalStyles = `
  @keyframes previewFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }
  
  @keyframes previewFadeOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.9); }
  }
  
  @keyframes previewPulse {
    0%, 100% { 
      opacity: 1; 
      transform: scale(1); 
    }
    50% { 
      opacity: 0.85; 
      transform: scale(1.02); 
    }
  }
`;

// Agregar estilos si no existen
if (!document.getElementById('previewModalStyles')) {
  const styleSheet = document.createElement('style');
  styleSheet.id = 'previewModalStyles';
  styleSheet.textContent = previewModalStyles;
  document.head.appendChild(styleSheet);
}

// =============================== DESAF√çO 12 BESTIAS ===============================
function startBestias12Challenge() {
  console.log('üê≤ Iniciando Desaf√≠o 12 Bestias');
  
  // Sin requisitos - cualquiera puede jugar
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Limpiar sistemas de desaf√≠o activos
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  if (desafioNActive || desafioNTimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o N');
    desafioNActive = false;
    stopDesafioNTimer();
    hideDesafioNHearts();
  }
  
  if (desafioClasico2Active || desafioClasico2TimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o Cl√°sico');
    desafioClasico2Active = false;
    stopDesafioClasico2Timer();
    hideDesafioClasico2Hearts();
  }
  
  // Limpiar La Emperatriz si est√° activa
  if (emperatrizActive || emperatrizTimerInterval) {
    console.log('üßπ Limpiando La Emperatriz');
    emperatrizActive = false;
    clearInterval(emperatrizTimerInterval);
    hideEmperatrizUI();
  }
  
  // üé¥ CONFIGURAR POOL DE CARTAS: Solo hor√≥scopo
  const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
  window.challengeCards = cards.filter(card => horoscopeUnits.some(u => card.unit.split('|').includes(u)));
  console.log(`üé¥ Pool de 12 Bestias creado: ${window.challengeCards.length} cartas del Hor√≥scopo`);
  
  // Configurar variables del desaf√≠o
  bestias12Active = true;
  bestias12HP = bestias12MaxHP; // Iniciar con HP m√°ximo (10000)
  bestias12Timer = 300; // 5 minutos
  bestias12Lives = 3; // Vidas del jugador
  bestias12PowerUps = [];
  bestias12CardsAnswered = 0;
  bestias12DamageMultiplier = 1.0;
  bestias12TimeBonus = 0;
  bestias12Level = 1;
  
  // Iniciar modo desaf√≠o con configuraci√≥n especial
  startMission('bestias12');
  
  // Sobrescribir currentMission con el nombre correcto
  currentMission = 'LAS 12 BESTIAS';
  console.log(`‚úÖ currentMission establecido a: ${currentMission}`);
  
  // Actualizar statMission
  const statMission = document.getElementById('statMission');
  if (statMission) {
    statMission.textContent = 'BESTIAS';
    statMission.style.color = '#ff8c42';
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '16px';
    statMission.style.textShadow = '0 0 10px rgba(255,140,66,0.5)';
  }
  
  // Inicializar UI especial de 12 Bestias
  initBestias12UI();
  
  // ========= ACTIVAR SISTEMA DE ASISTENCIA (LILI AYUDA) =========
  initAssistanceForChallenge();
  console.log('üÜò Sistema de asistencia activado para 12 Bestias');
  
  // Iniciar timer de 12 Bestias
  const timerCallback = () => {
    startBestias12Timer();
    console.log('üê≤ Timer de 12 Bestias iniciado despu√©s de preload');
  };

  if (preloadingChallenge) {
    console.log('‚è∞ Desaf√≠o en precarga - agendando timer de 12 Bestias');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  console.log('üê≤ Desaf√≠o 12 Bestias configurado exitosamente');
}

// --- Funci√≥n principal para iniciar desaf√≠os cl√°sicos con sistema Timer2 y Vidas2 ---
function startDesafioClasico2WithSystem(desafioType) {
  console.log('üöÄ DEBUG: startDesafioClasico2WithSystem llamada con:', desafioType);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Ocultar challengeBox
  const challengeBox = document.getElementById('challengeBox');
  if (challengeBox) challengeBox.classList.add('hidden');
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o cl√°sico');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // Limpiar sistema de desaf√≠os N si est√° activo
  if (desafioNActive || desafioNTimerInterval) {
    console.log('üßπ Limpiando Desaf√≠o N al iniciar desaf√≠o cl√°sico');
    desafioNActive = false;
    stopDesafioNTimer();
    hideDesafioNHearts();
  }
  
  // Activar sistema de desaf√≠o cl√°sico
  desafioClasico2Active = true;
  desafioClasico2Hearts = 2;
  desafioClasico2TimeLeft = 90; // 1 minuto y medio
  console.log('‚öôÔ∏è DEBUG: Variables de desaf√≠o cl√°sico configuradas:', { desafioClasico2Active, desafioClasico2Hearts, desafioClasico2TimeLeft });
  
  // Iniciar misi√≥n seg√∫n el tipo
  console.log('üìã DEBUG: Llamando startMission/startChallengeCustom con:', desafioType);
  if (desafioType === 'challenge') {
    startMission('challenge');
  } else if (desafioType === 'menos' || desafioType === 'mas') {
    startChallengeCustom(desafioType);
  }
  
  // Actualizar statMission para mostrar el tipo de desaf√≠o
  console.log('üìä DEBUG: Intentando actualizar statMission para:', desafioType);
  const statMission = document.getElementById('statMission');
  console.log('üìä DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const desafioNames = {
      'challenge': 'Desaf√≠o Cl√°sico',
      'menos': 'Desaf√≠o 0-1',
      'mas': 'Desaf√≠o 2+'
    };
    const newText = desafioNames[desafioType] || 'Desaf√≠o Cl√°sico';
    console.log('üìä DEBUG: Texto anterior:', statMission.textContent);
    console.log('üìä DEBUG: Texto nuevo que se asignar√°:', newText);
    statMission.textContent = newText;
    statMission.style.color = '#f2e5b1';
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '14px';
    console.log('üéØ DEBUG: statMission actualizado exitosamente:', statMission.textContent);
    
    // Verificar que realmente se actualiz√≥
    setTimeout(() => {
      console.log('‚è±Ô∏è DEBUG: Verificaci√≥n posterior - statMission.textContent:', statMission.textContent);
    }, 100);
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission');
  }
  
  // Iniciar timer y vidas del desaf√≠o cl√°sico
  
  // ========= ACTIVAR SISTEMA DE ASISTENCIA (LILI AYUDA) =========
  initAssistanceForChallenge();
  console.log(`üÜò Sistema de asistencia activado para ${desafioType}`);
  
  // Inicializar contador de conocidas para detectar cambios
  previousKnownCount = cards.filter(c => c.known).length;
  console.log('üìä Contador inicial de conocidas:', previousKnownCount);
  
  // Agendar el timer para despu√©s de la precarga si es necesario
  const timerCallback = () => {
    startDesafioClasico2Timer();
    console.log('‚è∞ Timer del desaf√≠o cl√°sico iniciado despu√©s de preload');
  };
  
  if (preloadingChallenge) {
    console.log('‚è≥ Timer agendado para despu√©s de precarga');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  showDesafioClasico2Hearts();
  
  console.log(`üéØ Desaf√≠o Cl√°sico iniciado: ${desafioType} con timer2 y vidas2`);
  console.log('üîç DEBUG: Estado final - desafioClasico2Active:', desafioClasico2Active, 'hearts:', desafioClasico2Hearts, 'timeLeft:', desafioClasico2TimeLeft);
}

function bloquearDesafio(){
  // Bloquear controles de desaf√≠o
  document.getElementById('cardWrap').style.pointerEvents = 'none';
  document.getElementById('flashRow').style.pointerEvents = 'none';
  // El usuario debe elegir otro modo para continuar
}

  function ensureReviseFlags(card){
    if(!card.dkAddedAt){ card.dkAddedAt = now(); }
    card.revise1 = true; card.revise2 = true; card.known = false;
  }

  /* ===== Etiquetas de esquina para tarjetas especiales ===== */
  function addCardCornerLabel() {
    // Limpiar etiqueta anterior si existe
    removeCardCornerLabel();
    
    let labelText = '';
    let labelClass = '';
    
    if (cardEl.classList.contains('premium-gold')) {
      labelText = '+2 NIV';
      labelClass = 'gold';
    } else if (cardEl.classList.contains('mythic-violet')) {
      labelText = '+5 NIV';
      labelClass = 'violet';
    } else if (cardEl.classList.contains('legendary-red')) {
      labelText = 'üí£ BOMBA';
      labelClass = 'red';
    }
    
    if (labelText) {
      const label = document.createElement('div');
      label.className = `card-corner-label ${labelClass}`;
      label.textContent = labelText;
      label.id = 'cardCornerLabel';
      
      // Agregar al contenedor de la carta
      cardEl.appendChild(label);
    }
  }
  
  function removeCardCornerLabel() {
    const existingLabel = document.getElementById('cardCornerLabel');
    if (existingLabel) {
      existingLabel.remove();
    }
  }

  /* ===== Funci√≥n para limpiar y ir a repasar despu√©s de fallar desaf√≠o cl√°sico ===== */
  function cleanupAndGoToRevise() {
    // Limpiar modal
    const modals = document.querySelectorAll('[style*="position: fixed"][style*="z-index"]');
    modals.forEach(modal => {
      if (modal.style.background && modal.style.background.includes('rgba')) {
        modal.remove();
      }
    });
    
    // LIMPIEZA COMPLETA: Desbloquear todo
    document.body.style.pointerEvents = '';
    document.body.style.overflow = '';
    
    // Desbloquear elementos espec√≠ficos
    const cardWrap = document.getElementById('cardWrap');
    const flashRow = document.getElementById('flashRow');
    if (cardWrap) cardWrap.style.pointerEvents = '';
    if (flashRow) flashRow.style.pointerEvents = '';
    
    // Limpiar elementos bloqueados
    const blockedElements = document.querySelectorAll('[style*="pointer-events"]');
    blockedElements.forEach(el => {
      if (el.style.pointerEvents === 'none') {
        el.style.pointerEvents = '';
      }
    });
    
    // Siempre realizar limpieza completa del desaf√≠o (detiene m√∫sica y restaura fondo)
    hideEmperatrizUI();
    
    // üéÆ MOSTRAR UI ELEMENTOS AL LIMPIAR Y SALIR DEL DESAF√çO
    showUIElementsForNormalMode();
    
    // Iniciar revise1 despu√©s de un peque√±o delay
    setTimeout(() => {
      startMission('revise1');
    }, 100);
  }

  /* ===== Feedback visual/sonoro y resaltado de cajas ===== */
  function pulseBox(el, colorClass){
    if(!el) return;
    el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal');
    void el.offsetWidth; // reflow para reiniciar animaci√≥n
    el.classList.add('pulseBadge', colorClass);
    setTimeout(()=>{ el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal'); }, 750);
  }
  // üéÆ FUNCI√ìN PARA MOSTRAR PUNTOS FLOTANTES TIPO GAMER
  function showFloatingPoints() {
    // Determinar puntos seg√∫n el tipo de carta
    let points = 1; // Default
    let baseColor = '#00bfff'; // Celeste gamer por defecto
    let fontSize = '28px'; // Tama√±o base
    
    if (cardEl.classList.contains('premium-gold')) {
      points = 2;
      baseColor = '#ffffff'; // Blanco para mejor contraste
      fontSize = '32px'; // M√°s grande porque es m√°s importante
    } else if (cardEl.classList.contains('mythic-violet')) {
      points = 5;
      baseColor = '#ffffff'; // Negro para mejor contraste
      fontSize = '36px'; // M√°s grande porque es m√°s importante
    } else if (cardEl.classList.contains('legendary-red')) {
      points = 1; // O el valor que corresponda para cartas rojas
      baseColor = '#ffffff'; // Negro para mejor contraste
      fontSize = '28px'; // Tama√±o seg√∫n importancia
    }
    
    // üéÆ DETECTAR MODO DE JUEGO INTELIGENTEMENTE
    let displayText = `+${points}`;
    
    // Detectar si es MODO DESAF√çO (challenge, desafioN1, N2, N3, emperatriz, etc.)
    // Usar variables de estado activo en vez de currentMission para mayor confiabilidad
    const isDesafioMode = (
      currentMission === 'challenge' || 
      emperatrizActive ||
      bestias12Active ||
      currentMission === 'LAS 12 BESTIAS' ||
      currentMission === 'Cruzar HSK3' ||
      currentMission === 'Cruzar HSK4' ||
      currentMission === 'CRUZAR EL MAR' ||
      currentMission === 'cruzarCielo' ||
      currentMission.startsWith('desafio')
    );
    
    // Detectar si es modo Quiz (cualquier quiz)
    const isQuizMode = mode && mode.toLowerCase().includes('quiz');
    
    // Detectar si es modo Flashcard
    const isFlashMode = mode === 'flash';
    
    // Aplicar l√≥gica de texto seg√∫n el modo
    if (isDesafioMode) {
      // MODO DESAF√çO ‚Üí "+X Nivel" o "+X Niveles" (NUNCA XP en desaf√≠os)
      const nivelText = points === 1 ? 'Nivel' : 'Niveles';
      displayText = `+${points} ${nivelText}`;
    } else if (isQuizMode) {
      // Modo Quiz (en unidades, conocidas, revisar) ‚Üí "+X XP" 
      displayText = `+${points} XP`;
    } else if (isFlashMode) {
      // Modo Flashcard (en cualquier misi√≥n) ‚Üí "A la colecci√≥n"
      displayText = 'A la colecci√≥n';
    } else {
      // Fallback para otros casos
      displayText = 'A la colecci√≥n';
    }
    
    // Crear elemento flotante
    const floatingText = document.createElement('div');
    floatingText.textContent = displayText;
    floatingText.style.cssText = `
      position: fixed;
      color: ${baseColor};
      font-size: ${fontSize};
      font-weight: bold;
      font-family: 'Jersey 10', monospace;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      pointer-events: none;
      z-index: 10000;
      opacity: 0;
      transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    `;
    
    // Posicionar cerca de la carta (centrado y un poco m√°s arriba)
    const cardRect = cardEl.getBoundingClientRect();
    floatingText.style.left = (cardRect.left + cardRect.width / 2) + 'px';
    floatingText.style.top = (cardRect.top + cardRect.height / 2 - 30) + 'px';
    floatingText.style.transform = 'translateX(-50%)'; // Centrar horizontalmente
    
    document.body.appendChild(floatingText);
    
    // Animar: fade in + float up (manteniendo centrado)
    requestAnimationFrame(() => {
      floatingText.style.opacity = '1';
      floatingText.style.transform = 'translateX(-50%) translateY(-80px) scale(1.2)';
      
      // Fade out despu√©s de 800ms
      setTimeout(() => {
        floatingText.style.opacity = '0';
        floatingText.style.transform = 'translateX(-50%) translateY(-120px) scale(0.8)';
        
        // Remover del DOM
        setTimeout(() => {
          if (floatingText.parentNode) {
            floatingText.parentNode.removeChild(floatingText);
          }
        }, 400);
      }, 800);
    });
  }

  async function feedbackCorrect(){
    // Reproducir sonido INMEDIATAMENTE junto con la animaci√≥n visual
    soundCorrect();
    
    // üéÆ MOSTRAR PUNTOS FLOTANTES
    showFloatingPoints();
    
    cardEl.classList.remove('shakeAnim'); void cardEl.offsetWidth;
    cardEl.classList.add('popAnim');
    
    // DESHABILITADO: Aplicar override para tarjetas especiales causaba conflictos con transiciones
    /*
    if(cardEl.classList.contains('premium-gold') || 
       cardEl.classList.contains('mythic-violet') || 
       cardEl.classList.contains('legendary-red')) {
      cardEl.classList.add('correct-override');
      // Remover la clase despu√©s de la animaci√≥n
      setTimeout(() => {
        cardEl.classList.remove('correct-override');
      }, 420); // Misma duraci√≥n que popAnim
    }
    */
    
    pulseBox(btnKnownBox, 'pulseGreen');
  }
  async function feedbackWrong(){
    cardEl.classList.remove('popAnim'); void cardEl.offsetWidth;
    soundWrong();
    pulseBox(btnRevise1Box, 'pulseAmber');
    pulseBox(btnRevise2Box, 'pulseTeal');
  }

  // Funci√≥n para mostrar notificaci√≥n de castigo del hor√≥scopo
  function showHoroscopePenaltyNotification(lostCharacters) {
    // Remover notificaci√≥n anterior si existe
    const existingNotification = document.querySelector('.horoscope-penalty-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.className = 'horoscope-penalty-notification';
    
    // Construir contenido
    let charactersHtml = '';
    lostCharacters.forEach(char => {
      charactersHtml += `
        <div class="penalty-character">
          <div>
            <span class="penalty-hanzi">${char.hanzi}</span>
            <div class="penalty-meaning">${char.meaning}</div>
          </div>
          <div class="penalty-streak">Nivel ${char.challengeStreak || 0}</div>
        </div>
      `;
    });
    
    notification.innerHTML = `
      <div class="penalty-header">
        <span style="font-size: 24px;">üê≤‚öîÔ∏è</span>
        <span>CASTIGO DEL HOR√ìSCOPO</span>
      </div>
      ${charactersHtml}
      <div style="
        font-size: 14px; 
        margin-top: 5px; 
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        text-align: center;
        padding: 5px;
        background: rgba(255, 107, 107, 0.1);
        border-radius: 8px;
        border: 1px solid #ff6b6b;
      ">
        üíÄ PERDISTE ${lostCharacters.length} CARACTER${lostCharacters.length > 1 ? 'ES' : ''} üíÄ
      </div>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    // Ocultar despu√©s de 4 segundos
    setTimeout(() => {
      notification.classList.add('fadeout');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 500);
    }, 4000);
  }

  function showBombPenaltyNotification(lostCharacters) {
    // Remover notificaci√≥n anterior si existe
    const existingNotification = document.querySelector('.bomb-penalty-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.className = 'bomb-penalty-notification';
    
    // Construir contenido
    let charactersHtml = '';
    lostCharacters.forEach(char => {
      charactersHtml += `
        <div class="penalty-character">
          <div>
            <span class="penalty-hanzi">${char.hanzi}</span>
            <div class="penalty-meaning">${char.meaning}</div>
          </div>
          <div class="penalty-streak">Nivel ${char.challengeStreak || 0}</div>
        </div>
      `;
    });
    
    notification.innerHTML = `
      <div class="penalty-header">
        <span style="font-size: 24px;">üí£üí•</span>
        <span>¬°BOMBA ACTIVADA!</span>
      </div>
      ${charactersHtml}
      <div style="
        font-size: 14px; 
        margin-top: 5px; 
        color: #ff3333;
        font-family: 'Jersey 10', monospace;
        text-align: center;
        padding: 5px;
        background: rgba(255, 51, 51, 0.1);
        border-radius: 8px;
        border: 1px solid #ff3333;
      ">
        üíÄ PERDISTE ${lostCharacters.length} CARACTER${lostCharacters.length > 1 ? 'ES' : ''} üíÄ
      </div>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    // Ocultar despu√©s de 4 segundos
    setTimeout(() => {
      notification.classList.add('fadeout');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 500);
    }, 4000);
  }

  // Llama feedback y pasa a siguiente tras una breve pausa
  function respond(knew){
    if(knew) feedbackCorrect();
    else {
      // Todo el feedback visual y de estado a la vez
      feedbackWrong(); // sonido y glow
      cardEl.classList.add('cardWrong','shakeAnim'); // shake y fondo rojo
      // Si es incorrecto, agregar flags de repaso/confirmar inmediatamente
      if(currentCard) ensureReviseFlags(currentCard);
      setTimeout(()=>{
        cardEl.classList.add('cardWrongFade');
        // Fade out a las opciones tras 1s
        const quizBtns = Array.from(quizRow.children);
        quizBtns.forEach(b=>{
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
      }, 1500);
      setTimeout(()=>{
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
      }, 2000);
      return;
    }
    setTimeout(()=>{ answer(knew); }, 920); // Aumentado para que el glow dure m√°s
  }

  function answer(knew){
      if(!currentCard) return;
      const c = currentCard;

      if(currentMission==='challenge'){
        // actualizar racha y √∫ltima hora
        c.lastChallengeAt = now();
        if(knew){
          // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
          if(cardEl.classList.contains('mythic-violet')){
            c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
          } else if(cardEl.classList.contains('premium-gold')){
            c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
          } else {
            c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
          }
          c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
        } else {
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            console.log('üî¥üí£ TARJETA BOMBA (Challenge): Perdiendo car√°cter actual + uno al azar');
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Guardar info del car√°cter actual ANTES de modificarlo
            lostCharacters.push({
              hanzi: c.hanzi,
              meaning: c.meaning,
              challengeStreak: c.challengeStreak
            });
            
            c.known = false;
            c.challengeStreak = 0;
            
            // 2. Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              const randomChar = knownChars[idx];
              
              // Guardar info ANTES de modificarlo
              lostCharacters.push({
                hanzi: randomChar.hanzi,
                meaning: randomChar.meaning,
                challengeStreak: randomChar.challengeStreak
              });
              
              console.log(`üéØ Car√°cter aleatorio perdido: ${randomChar.hanzi} (${randomChar.meaning})`);
              randomChar.known = false;
              randomChar.challengeStreak = 0;
            }
            
            // 3. Mostrar notificaci√≥n de castigo con los caracteres perdidos
            if(lostCharacters.length > 0) {
              showBombPenaltyNotification(lostCharacters);
              console.log(`üí£ BOMBA ACTIVADA: Perdiste ${lostCharacters.length} caracteres total`);
            }
          }
          c.challengeStreak = 0;
          ensureReviseFlags(c); // sale de conocidas -> repaso/confirmar
        }
      } else if(currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3'){
        // Sistema de vidas activo para desaf√≠os N

        
        if(knew){
          // Respuesta correcta
          if(c.known) {
            // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
        } else {
          // Respuesta incorrecta - perder vida solo en desaf√≠os N1, N2, N3 (no en hor√≥scopo)
          if (desafioNActive && (currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3')) {
            loseDesafioNLife();
          }
          
          if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
      } else if(currentMission==='challenge' || currentMission==='clasico' || currentMission==='menos' || currentMission==='mas'){
        // Sistema de vidas2 activo para desaf√≠os cl√°sicos

        
        if(knew){
          // Respuesta correcta
          if(c.known) {
            // Si la tarjeta es m√≠tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
        } else {
          // Respuesta incorrecta - aplicar efectos especiales y modificar tarjeta
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            console.log('üî¥üí£ TARJETA BOMBA: Perdiendo car√°cter actual + uno al azar');
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Guardar info del car√°cter actual ANTES de modificarlo
            if(c.known) {
              lostCharacters.push({
                hanzi: c.hanzi,
                meaning: c.meaning,
                challengeStreak: c.challengeStreak
              });
            }
            
            c.known = false;
            c.challengeStreak = 0;
            ensureReviseFlags(c);
            
            // 2. Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              const randomChar = knownChars[idx];
              
              // Guardar info ANTES de modificarlo
              lostCharacters.push({
                hanzi: randomChar.hanzi,
                meaning: randomChar.meaning,
                challengeStreak: randomChar.challengeStreak
              });
              
              console.log(`üéØ Car√°cter aleatorio perdido: ${randomChar.hanzi} (${randomChar.meaning})`);
              randomChar.known = false;
              randomChar.challengeStreak = 0;
              ensureReviseFlags(randomChar);
            }
            
            // 3. Mostrar notificaci√≥n de castigo con los caracteres perdidos
            if(lostCharacters.length > 0) {
              showBombPenaltyNotification(lostCharacters);
              console.log(`üí£ BOMBA ACTIVADA: Perdiste ${lostCharacters.length} caracteres total`);
            }
          } else if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
          }
          
          if(c.known) {
            ensureReviseFlags(c);
          }
        }
      } else if(currentMission==='desafioColores' || currentMission==='desafioFruta' || currentMission==='desafioVerduras' ||
                 currentMission==='desafioComidas' || currentMission==='desafioAnimales' || currentMission==='desafioDeportes' ||
                 currentMission==='desafioHobbies' || currentMission==='desafioRopa' || currentMission==='desafioCasa' ||
                 currentMission==='desafioCuerpo' || currentMission==='desafioProfesiones' || currentMission==='desafioEmociones'){
        // üê≤ DESAF√çOS DEL HOR√ìSCOPO: Castigo especial por equivocarse
        console.log(`üîç DEBUG: Desaf√≠o hor√≥scopo - Misi√≥n: ${currentMission}, Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}`);
        
        if(c.known) {
          if(knew){
            // Si ya la conoc√≠a y responde bien: sumar nivel
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            // üí• CASTIGO ESPECIAL: Perder car√°cter actual + 2 aleatorios de la colecci√≥n
            console.log('üê≤‚öîÔ∏è Castigo del hor√≥scopo: perdiendo car√°cter actual + 2 aleatorios');
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Perder el car√°cter actual (guardar info antes de modificarlo)
            const currentCharInfo = {
              hanzi: c.hanzi,
              meaning: c.meaning,
              challengeStreak: c.challengeStreak
            };
            lostCharacters.push(currentCharInfo);
            
            c.known = false;
            c.challengeStreak = 0;
            ensureReviseFlags(c);
            
            // 2. Perder 2 caracteres aleatorios adicionales de la colecci√≥n (excluyendo animales del hor√≥scopo)
            const knownChars = cards.filter(card => 
              card.known && 
              card.id !== c.id && 
              !card.isHoroscopeAnimal // No perder animales coleccionados del hor√≥scopo
            );
            
            console.log(`üéØ Caracteres disponibles para castigo: ${knownChars.length}`);
            
            // Perder hasta 2 caracteres aleatorios (si hay suficientes)
            const charactersToLose = Math.min(2, knownChars.length);
            
            for(let i = 0; i < charactersToLose; i++) {
              if(knownChars.length > 0) {
                const randomIndex = Math.floor(Math.random() * knownChars.length);
                const lostChar = knownChars.splice(randomIndex, 1)[0]; // Remover del array para evitar duplicados
                
                // Guardar info antes de modificarlo
                lostCharacters.push({
                  hanzi: lostChar.hanzi,
                  meaning: lostChar.meaning,
                  challengeStreak: lostChar.challengeStreak
                });
                
                lostChar.known = false;
                lostChar.challengeStreak = 0;
                ensureReviseFlags(lostChar);
                console.log(`üíÄ Perdido: ${lostChar.hanzi} (${lostChar.meaning})`);
              }
            }
            
            // Mostrar notificaci√≥n visual
            if(lostCharacters.length > 0) {
              showHoroscopePenaltyNotification(lostCharacters);
              console.log(`‚ö†Ô∏è CASTIGO APLICADO: Perdiste ${lostCharacters.length} caracteres total`);
            } else {
              console.log(`‚ö†Ô∏è No hab√≠a caracteres adicionales para perder`);
            }
          }
        } else if(!knew) {
          // üî• CASTIGO ALTERNATIVO: Si el car√°cter no estaba en conocidas pero fall√≥ en desaf√≠o hor√≥scopo
          console.log('üê≤‚öîÔ∏è Castigo alternativo: car√°cter no conocido pero perdiendo 2 aleatorios');
          
          // Array para recopilar caracteres perdidos para la notificaci√≥n
          const lostCharacters = [];
          
          const knownChars = cards.filter(card => 
            card.known && 
            card.id !== c.id && 
            !card.isHoroscopeAnimal
          );
          
          console.log(`üéØ Caracteres disponibles para castigo alternativo: ${knownChars.length}`);
          
          const charactersToLose = Math.min(2, knownChars.length);
          
          for(let i = 0; i < charactersToLose; i++) {
            if(knownChars.length > 0) {
              const randomIndex = Math.floor(Math.random() * knownChars.length);
              const lostChar = knownChars.splice(randomIndex, 1)[0];
              
              // Guardar info antes de modificarlo
              lostCharacters.push({
                hanzi: lostChar.hanzi,
                meaning: lostChar.meaning,
                challengeStreak: lostChar.challengeStreak
              });
              
              lostChar.known = false;
              lostChar.challengeStreak = 0;
              ensureReviseFlags(lostChar);
              console.log(`üíÄ Perdido (castigo alternativo): ${lostChar.hanzi} (${lostChar.meaning})`);
            }
          }
          
          // Mostrar notificaci√≥n visual
          if(lostCharacters.length > 0) {
            showHoroscopePenaltyNotification(lostCharacters);
            console.log(`‚ö†Ô∏è CASTIGO ALTERNATIVO APLICADO: Perdiste ${lostCharacters.length} caracteres`);
          }
        }
        // Si no est√° en conocidas y responde bien: no hacer nada
      } else if(currentMission === 'ultimateChallenge' && ultimateChallengeActive){
        // üèÜ ULTIMATE CHALLENGE: Sistema de vidas (3 corazones)
        console.log(`üèÜ DEBUG: Ultimate Challenge - Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, Vidas: ${ultimateChallengeHearts}`);
        
        if(c.known) {
          if(knew){
            // Respuesta correcta: sumar nivel como en otros desaf√≠os
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            // üí• RESPUESTA INCORRECTA: Perder 1 vida + castigo de 2 caracteres aleatorios
            ultimateChallengeHearts--;
            updateUltimateChallengeHearts();
            console.log(`üíÄ Vida perdida! Vidas restantes: ${ultimateChallengeHearts}`);
            
            // Array para recopilar caracteres perdidos para la notificaci√≥n
            const lostCharacters = [];
            
            // 1. Perder el car√°cter actual (guardar info antes de modificarlo)
            const currentCharInfo = {
              hanzi: c.hanzi,
              meaning: c.meaning,
              challengeStreak: c.challengeStreak
            };
            lostCharacters.push(currentCharInfo);
            
            c.known = false;
            c.challengeStreak = 0;
            ensureReviseFlags(c);
            
            // 2. Perder 2 caracteres aleatorios adicionales de la colecci√≥n
            const knownChars = cards.filter(card => 
              card.known && 
              card.id !== c.id && 
              !card.isHoroscopeAnimal // No perder animales coleccionados del hor√≥scopo
            );
            
            console.log(`üéØ Caracteres disponibles para castigo Ultimate: ${knownChars.length}`);
            
            const charactersToLose = Math.min(2, knownChars.length);
            
            for(let i = 0; i < charactersToLose; i++) {
              if(knownChars.length > 0) {
                const randomIndex = Math.floor(Math.random() * knownChars.length);
                const lostChar = knownChars.splice(randomIndex, 1)[0];
                
                lostCharacters.push({
                  hanzi: lostChar.hanzi,
                  meaning: lostChar.meaning,
                  challengeStreak: lostChar.challengeStreak
                });
                
                lostChar.known = false;
                lostChar.challengeStreak = 0;
                ensureReviseFlags(lostChar);
                console.log(`üíÄ Ultimate perdido: ${lostChar.hanzi} (${lostChar.meaning})`);
              }
            }
            
            // Mostrar notificaci√≥n de caracteres perdidos
            if(lostCharacters.length > 0) {
              showHoroscopePenaltyNotification(lostCharacters);
              console.log(`‚ö†Ô∏è CASTIGO ULTIMATE APLICADO: Perdiste ${lostCharacters.length} caracteres`);
            }
            
            // Verificar si perdi√≥ todas las vidas
            if(ultimateChallengeHearts <= 0) {
              console.log('üíÄ GAME OVER - Todas las vidas perdidas');
              setTimeout(() => {
                showUltimateChallengeGameOver();
              }, 2000); // Delay para que vea el castigo primero
              return; // Salir sin continuar
            }
          }
        } else if(!knew) {
          // Car√°cter no conocido pero respuesta incorrecta: solo perder vida + 2 aleatorios
          ultimateChallengeHearts--;
          updateUltimateChallengeHearts();
          console.log(`üíÄ Vida perdida (car√°cter no conocido)! Vidas restantes: ${ultimateChallengeHearts}`);
          
          const lostCharacters = [];
          const knownChars = cards.filter(card => 
            card.known && 
            card.id !== c.id && 
            !card.isHoroscopeAnimal
          );
          
          const charactersToLose = Math.min(2, knownChars.length);
          
          for(let i = 0; i < charactersToLose; i++) {
            if(knownChars.length > 0) {
              const randomIndex = Math.floor(Math.random() * knownChars.length);
              const lostChar = knownChars.splice(randomIndex, 1)[0];
              
              lostCharacters.push({
                hanzi: lostChar.hanzi,
                meaning: lostChar.meaning,
                challengeStreak: lostChar.challengeStreak
              });
              
              lostChar.known = false;
              lostChar.challengeStreak = 0;
              ensureReviseFlags(lostChar);
              console.log(`üíÄ Ultimate perdido (alternativo): ${lostChar.hanzi} (${lostChar.meaning})`);
            }
          }
          
          if(lostCharacters.length > 0) {
            showHoroscopePenaltyNotification(lostCharacters);
          }
          
          // Verificar game over
          if(ultimateChallengeHearts <= 0) {
            console.log('üíÄ GAME OVER - Todas las vidas perdidas');
            setTimeout(() => {
              showUltimateChallengeGameOver();
            }, 2000);
            return;
          }
        }
      } else if(currentMission.startsWith('unit') || currentMission.startsWith('HSK3') || currentMission.startsWith('HSK4') ||
                 currentMission==='todoN1' || currentMission==='todoN2' || currentMission==='todoN3' ||
                 currentMission==='colores' || currentMission==='fruta' || currentMission==='verduras' ||
                 currentMission==='comidas' || currentMission==='animales' || currentMission==='deportes' ||
                 currentMission==='hobbies' || currentMission==='ropa' || currentMission==='casa' ||
                 currentMission==='cuerpo' || currentMission==='profesiones' || currentMission==='emociones'){
        // DEBUG para HSK3 y HSK4
        if(currentMission.startsWith('HSK3') || currentMission.startsWith('HSK4')) {
          console.log(`üîç DEBUG ${currentMission.startsWith('HSK3') ? 'HSK3' : 'HSK4'}: Respuesta ${knew ? 'CORRECTA' : 'INCORRECTA'} - ${c.hanzi} (${c.meaning})`);
          console.log(`  Antes: known=${c.known}, revise1=${c.revise1}, revise2=${c.revise2}`);
        }
        
        if(knew){ c.known = true; }
        else    { ensureReviseFlags(c); }
        
        // DEBUG para HSK3 y HSK4
        if(currentMission.startsWith('HSK3') || currentMission.startsWith('HSK4')) {
          console.log(`  Despu√©s: known=${c.known}, revise1=${c.revise1}, revise2=${c.revise2}`);
        }
      } else if(currentMission==='known'){
        if(knew){ c.known = true; }
        else {
          // Solo agrega a revise1 y revise2, pero NO elimina de conocidas ni reinicia challengeStreak
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
          c.known = true; // Asegura que nunca se elimine de conocidas
          // NO modificar challengeStreak
        }
      } else if(currentMission==='revise1'){
        if(knew){ c.revise1 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1/revise2
          if(!c.revise1) c.revise1 = true;  
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      } else if(currentMission==='revise2'){
        if(knew){ c.revise2 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1 y revise2
          if(!c.revise2) c.revise2 = true;
          if(!c.revise1) c.revise1 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      } else if((currentMission === 'emperatriz' || currentMission === 'Cruzar HSK3' || currentMission === 'Cruzar HSK4' || 
                 currentMission === 'CRUZAR EL MAR' || currentMission === 'cruzarCielo' || currentMission === 'bestias12' || 
                 currentMission === 'LAS 12 BESTIAS' || currentMission === 'LA EMPERATRIZ') && emperatrizActive) {
        // üëë DESAF√çO TIPO BOSS: Sistema de jefa con HP (Emperatriz, Cruzar el Mar, Cruzar el Cielo, CruzarHSK3, CruzarHSK4, 12 Bestias)
        const desafioName = currentChallengeConfig ? currentChallengeConfig.displayName : 'La Emperatriz';
        console.log(`üëë DEBUG: ${desafioName} - Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, HP: ${emperatrizHP}`);
        
        if(knew) {
          // Respuesta correcta: infligir da√±o a la jefa
          emperatrizCardsAnswered++;
          
          // Calcular da√±o base seg√∫n f√≥rmula correcta:
          // (nivel del car√°cter + (Ê∞¥Âπ≥ x 5) + (racha diaria x 1)) x power ups de da√±o x buff/debuff de tarjeta
          const cardLevel = c.challengeStreak || 0; // nivel del car√°cter
          const playerLevel = getCurrentLevel(xpPoints); // Ê∞¥Âπ≥ del jugador
          const dailyStreak = streak; // racha diaria global, no nivel del car√°cter
          
          let damage = cardLevel + (playerLevel * 5) + (dailyStreak * 1);
          
          // Aplicar multiplicadores de power-ups
          damage = Math.floor(damage * emperatrizDamageMultiplier);
          
          // Efectos de tarjetas especiales (Emperatriz)
          if(cardEl.classList.contains('emperatriz-orange')) {
            damage *= 2; // Buff: doble da√±o
            console.log('üî• Tarjeta NARANJA: Doble da√±o aplicado!');
            showEmperatrizEffect('¬°DOBLE DE DA√ëO!', '#ff8c42');
          } else if(cardEl.classList.contains('emperatriz-cyan')) {
            emperatrizTimer += 20; // Bonus de tiempo
            console.log('‚è∞ Tarjeta CELESTE: +20 segundos a√±adidos!');
            showEmperatrizEffect('+20 SEGUNDOS', '#22d3ee');
            updateEmperatrizTimer();
            
            // Aplicar glow celeste al timer
            const timerDisplay = document.getElementById('emperatrizTimer');
            if (timerDisplay) {
              timerDisplay.style.animation = 'none';
              void timerDisplay.offsetWidth;
              timerDisplay.style.animation = 'timerTimeGainGlow 0.8s ease-out';
              setTimeout(() => {
                timerDisplay.style.animation = '';
              }, 800);
            }
          } else if(cardEl.classList.contains('emperatriz-crimson')) {
            damage = Math.floor(damage * 0.5); // Debuff: mitad de da√±o
            console.log('üíî Tarjeta BORDO: Da√±o reducido a la mitad!');
            showEmperatrizEffect('DA√ëO A LA MITAD', '#9f1239');
          } else if(cardEl.classList.contains('emperatriz-turquoise')) {
            // Tarjeta Turquesa: Absorci√≥n - el da√±o se convierte en curaci√≥n
            const oldHP = emperatrizHP;
            emperatrizHP = Math.min(emperatrizHP + damage, emperatrizMaxHP);
            const newHP = emperatrizHP;
            console.log(`üíô Tarjeta TURQUESA: Absorci√≥n de ${damage} HP!`);
            showEmperatrizEffect(`CURACI√ìN +${damage} HP`, '#14b8a6');
            
            // Aplicar animaci√≥n de curaci√≥n con glow turquesa
            previousEmperatrizHP = oldHP;
            animateEmperatrizHPChange(newHP);
            
            damage = 0; // No hacer da√±o, ya se convirti√≥ en curaci√≥n
          }
          
          // Verificar invulnerabilidad antes de aplicar da√±o
          if(emperatrizInvulnerableCards > 0) {
            emperatrizInvulnerableCards--;
            console.log(`üõ°Ô∏è ¬°Emperatriz INVULNERABLE! Cartas restantes: ${emperatrizInvulnerableCards}`);
            showEmperatrizEffect('¬°INVULNERABLE!', '#f59e0b');
            damage = 0; // No da√±o
            if(emperatrizInvulnerableCards <= 0) {
              showEmperatrizEffect('Invulnerabilidad perdida', '#ef4444');
            }
            // Actualizar la barra para mostra cambios en invulnerabilidad
            updateEmperatrizHPBar();
          } else if(emperatrizAbsorbingDamage > 0) {
            // Absorci√≥n vamp√≠rica: el da√±o se convierte en curaci√≥n
            emperatrizAbsorbingDamage--;
            const healAmount = damage; // La cantidad que iba a ser da√±o se convierte en curaci√≥n
            const oldHP = emperatrizHP;
            const newHP = Math.min(emperatrizMaxHP, emperatrizHP + healAmount);
            emperatrizHP = newHP;
            
            console.log(`ü©∏ ¬°ABSORCI√ìN VAMP√çRICA! Curaci√≥n: ${healAmount}, turnos restantes: ${emperatrizAbsorbingDamage}`);
            showEmperatrizEffect(`+${healAmount} HP ABSORBIDO`, '#9f1239');
            
            if(emperatrizAbsorbingDamage <= 0) {
              showEmperatrizEffect('Absorci√≥n terminada', '#ef4444');
            }
            
            // Animar curaci√≥n con glow turquesa
            previousEmperatrizHP = oldHP;
            animateEmperatrizHPChange(newHP);
            damage = 0; // No da√±o, solo curaci√≥n
          } else {
            // Aplicar da√±o a la jefa
            const oldHP = emperatrizHP;
            const newHP = Math.max(0, emperatrizHP - damage);
            emperatrizHP = newHP;
            
            // üíÄ VERIFICAR LAST STAND (10% de vida o menos, solo una vez por desaf√≠o)
            const hpPercentage = (newHP / emperatrizMaxHP) * 100;
            // Solo activar Last Stand si el desaf√≠o actual lo permite
            const shouldTriggerLastStand = currentChallengeConfig ? currentChallengeConfig.hasLastStand : true;
            if (hpPercentage <= 10 && !emperatrizLastStandTriggered && newHP > 0 && shouldTriggerLastStand) {
              console.log(`üíÄ TRIGGER: Last Stand activado - HP: ${newHP}/${emperatrizMaxHP} (${hpPercentage.toFixed(1)}%)`);
              emperatrizLastStandTriggered = true;
              
              // Mostrar Last Stand despu√©s de las animaciones de da√±o
              setTimeout(() => {
                showEmperatrizLastStand();
              }, 1000);
            }
            
            // Actualizar inmediatamente la barra de progreso pero mantener n√∫meros del HP anterior
            updateEmperatrizHPBarImmediate(oldHP, newHP);
            
            // Animar los n√∫meros junto con el efecto de da√±o (300ms para que inicie simult√°neamente)
            setTimeout(() => {
              animateEmperatrizHPNumbers(oldHP, newHP);
            }, 300);
          }
          
          console.log(`‚öîÔ∏è Da√±o infligido: ${damage}, HP restante: ${emperatrizHP}`);
          
          // Mostrar efecto de da√±o inmediatamente despu√©s del "+X Nivel" (que se muestra en feedbackCorrect)
          // El "+X Nivel" se muestra inmediatamente en feedbackCorrect(), el da√±o debe aparecer 300ms despu√©s
          setTimeout(() => {
            showDamageEffect(damage);
          }, 300);
          
          // Actualizar racha del car√°cter
          if(c.known) {
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
          
          // Nota: updateEmperatrizPowerUpBox() se llama en nextCard() con la carta correcta
          
          // Verificar victoria PRIMERO antes de mostrar power-ups
          if(emperatrizHP <= 0) {
            console.log('üëë ¬°BOSS DERROTADO!');
            console.log('üîç currentChallengeConfig:', currentChallengeConfig);
            console.log('üîç currentChallengeConfig.name:', currentChallengeConfig?.name);
            setTimeout(() => {
              // Detectar qu√© desaf√≠o est√° activo y mostrar el modal correspondiente
              if (currentChallengeConfig) {
                console.log(`üéâ Victoria en: ${currentChallengeConfig.name}`);
                if (currentChallengeConfig.name === 'CRUZAR EL MAR') {
                  console.log('üåä Llamando a showCruzarMarVictory()...');
                  showCruzarMarVictory();
                } else if (currentChallengeConfig.name === 'cruzarCielo') {
                  console.log('‚òÅÔ∏è Llamando a showCruzarCieloVictory()...');
                  showCruzarCieloVictory();
                } else if (currentChallengeConfig.name === 'Cruzar HSK4') {
                  console.log('üéØ Llamando a showCruzarHSK4Victory()...');
                  showCruzarHSK4Victory();
                } else if (currentChallengeConfig.name === 'Cruzar HSK3') {
                  console.log('üéì Llamando a showCruzarHSK3Victory()...');
                  showCruzarHSK3Victory();
                } else if (currentChallengeConfig.name === 'LA EMPERATRIZ') {
                  console.log('üëë Llamando a showEmperatrizVictory()...');
                  showEmperatrizVictory();
                } else if (currentChallengeConfig.name === 'LAS 12 BESTIAS') {
                  console.log('üê≤ Llamando a showBestias12Victory()...');
                  showBestias12Victory();
                } else {
                  console.log('‚ö†Ô∏è Desaf√≠o no reconocido, usando Emperatriz por defecto');
                  showEmperatrizVictory();
                }
              } else {
                console.log('‚ö†Ô∏è No hay currentChallengeConfig, usando Emperatriz por defecto');
                // Fallback a Emperatriz si no hay config
                showEmperatrizVictory();
              }
            }, 2000);
            return;
          }
          
          // Verificar power-ups cada 5 cartas
          if(emperatrizCardsAnswered % 5 === 0) {
            const roundNumber = emperatrizCardsAnswered / 5;
            
            // Power-ups MALDITOS cada 4 rondas: 4, 8, 12, 16, 20, 24...
            // Power-ups NORMALES en otras rondas m√∫ltiplo de 5
            
            // Cada 5 cartas respondidas correctamente = 1 ronda de power-up
            // Ronda 1 (carta 5): Normal
            // Ronda 2 (carta 10): Normal
            // Ronda 3 (carta 15): Normal
            // Ronda 4 (carta 20): MALDITO ‚Üê Primera vez (cada 4)
            // Ronda 5 (carta 25): Normal
            // Ronda 6 (carta 30): Normal
            // Ronda 7 (carta 35): Normal
            // Ronda 8 (carta 40): MALDITO ‚Üê Cada 4 rondas
            // Ronda 9-11: Normal
            // Ronda 12 (carta 60): MALDITO ‚Üê Cada 4 rondas
            
            if(roundNumber % 4 === 0 && roundNumber >= 4) {
              // Cada 4 rondas a partir de la 4ta: 4, 8, 12, 16, 20...
              console.log(`üíÄ Ronda ${roundNumber}: Power-ups MALDITOS activados (carta ${emperatrizCardsAnswered})`);
              grantEmperatrizCursedPowerUp();
            } else {
              // Todas las dem√°s rondas m√∫ltiplo de 5
              console.log(`‚ö° Ronda ${roundNumber}: Power-ups NORMALES activados (carta ${emperatrizCardsAnswered})`);
              grantEmperatrizPowerUp();
            }
          }
          
        } else {
          // Respuesta incorrecta: la jefa se fortalece
          console.log('üëë Respuesta incorrecta - La Emperatriz se fortalece!');
          
          // Perder una vida
          emperatrizLives--;
          updateEmperatrizLivesDisplay();
          
          // Eliminar un car√°cter aleatorio de la colecci√≥n (castigo)
          const knownCards = cards.filter(card => card.known && !card.isHoroscopeAnimal && card.unit !== 'horoscopo');
          if (knownCards.length > 0) {
            const randomCard = knownCards[Math.floor(Math.random() * knownCards.length)];
            randomCard.known = false;
            randomCard.challengeStreak = 0;
            ensureReviseFlags(randomCard);
            
            // Mostrar notificaci√≥n del castigo
            showEmperatrizPunishment(randomCard);
          }
          
          // Verificar si se acabaron las vidas
          if (emperatrizLives <= 0) {
            console.log('‚ò†Ô∏è Sin vidas - La Emperatriz ha ganado!');
            setTimeout(() => {
              showEmperatrizResult(false, 'Te quedaste sin vidas');
            }, 2000);
            return;
          }
          
          // Efectos especiales de tarjetas en respuesta incorrecta
          if(cardEl.classList.contains('emperatriz-crimson')) {
            // Tarjeta bordo: castigo extra - perder tiempo
            emperatrizTimer = Math.max(0, emperatrizTimer - 15);
            console.log('üíî Tarjeta BORDO fall√≥: -15 segundos de tiempo!');
            showEmperatrizEffect('-15 SEGUNDOS', '#ef4444');
            updateEmperatrizTimer();
          }
          
          // Reiniciar racha del car√°cter si estaba en conocidas
          if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
        
        // Actualizar indicadores
        updateEmperatrizPowerUpIndicator();
      } else if(bestias12Active) {
        // üê≤ DESAF√çO 12 BESTIAS: Sistema de jefa con HP (id√©ntico a emperatriz)
        console.log(`üê≤ DEBUG: 12 Bestias - Car√°cter conocido: ${c.known}, Respuesta: ${knew ? 'CORRECTA' : 'INCORRECTA'}, HP Bestias: ${bestias12HP}`);
        
        if(knew) {
          // Respuesta correcta: infligir da√±o a las bestias
          bestias12CardsAnswered++;
          
          // Calcular da√±o base seg√∫n f√≥rmula correcta:
          // (nivel del car√°cter + (Ê∞¥Âπ≥ x 5) + (racha diaria x 1)) x power ups de da√±o x buff/debuff de tarjeta
          const cardLevel = c.challengeStreak || 0; // nivel del car√°cter
          const playerLevel = getCurrentLevel(xpPoints); // Ê∞¥Âπ≥ del jugador
          const dailyStreak = streak; // racha diaria global, no nivel del car√°cter
          
          let damage = cardLevel + (playerLevel * 5) + (dailyStreak * 1);
          
          // Aplicar multiplicadores de power-ups
          damage = Math.floor(damage * bestias12DamageMultiplier);
          
          // Efectos de tarjetas especiales (Bestias12)
          if(cardEl.classList.contains('bestias12-orange')) {
            damage *= 2; // Buff: doble da√±o
            console.log('üî• Tarjeta NARANJA: Doble da√±o aplicado!');
            showBestias12Effect('¬°DOBLE DA√ëO!', '#ff8c42');
          } else if(cardEl.classList.contains('bestias12-cyan')) {
            bestias12Timer += 20; // Bonus de tiempo
            console.log('‚è∞ Tarjeta CELESTE: +20 segundos a√±adidos!');
            showBestias12Effect('+20 SEGUNDOS', '#22d3ee');
            updateBestias12Timer();
            
            // Aplicar glow celeste al timer
            const timerDisplay = document.getElementById('bestias12Timer');
            if (timerDisplay) {
              timerDisplay.style.animation = 'none';
              void timerDisplay.offsetWidth;
              timerDisplay.style.animation = 'timerTimeGainGlow 0.8s ease-out';
              setTimeout(() => {
                timerDisplay.style.animation = '';
              }, 800);
            }
          } else if(cardEl.classList.contains('bestias12-crimson')) {
            damage = Math.floor(damage * 0.5); // Debuff: mitad de da√±o
            console.log('üíî Tarjeta BORDO: Da√±o reducido a la mitad!');
            showBestias12Effect('DA√ëO REDUCIDO', '#9f1239');
          } else if(cardEl.classList.contains('bestias12-turquoise')) {
            // Tarjeta Turquesa: Las bestias absorben tu ataque y se curan
            const oldHP = bestias12HP;
            const healAmount = damage; // El da√±o que ibas a hacer se convierte en curaci√≥n para las bestias
            bestias12HP = Math.min(bestias12MaxHP, bestias12HP + healAmount);
            const newHP = bestias12HP;
            
            console.log(`üíô Tarjeta TURQUESA: Las bestias absorben ${healAmount} HP!`);
            showBestias12Effect(`BESTIAS +${healAmount} HP`, '#14b8a6');
            
            // Animar curaci√≥n con glow turquesa
            updateBestias12HPBarImmediate(oldHP, newHP);
            setTimeout(() => {
              animateBestias12HPNumbers(oldHP, newHP);
            }, 300);
            
            damage = 0; // No hacer da√±o adicional
          }
          
          // Aplicar da√±o a las bestias (solo si no fue tarjeta turquesa)
          if (damage > 0) {
            const oldHP = bestias12HP;
            bestias12HP = Math.max(0, bestias12HP - damage);
            const newHP = bestias12HP;
          
            // Actualizar barra inmediatamente pero mantener n√∫meros para animaci√≥n
            if (oldHP !== newHP) {
              updateBestias12HPBarImmediate(oldHP, newHP);
              
              // Animar los n√∫meros junto con el efecto de da√±o (300ms para que inicie simult√°neamente)
              setTimeout(() => {
                animateBestias12HPNumbers(oldHP, newHP);
              }, 300);
            }
          
            console.log(`‚öîÔ∏è Da√±o infligido: ${damage}, HP restante: ${bestias12HP}`);
            
            // Mostrar efecto de da√±o inmediatamente despu√©s del "+X Nivel"
            setTimeout(() => {
              showDamageEffect(damage);
            }, 300);
          }
          
          // Actualizar racha del car√°cter
          if(c.known) {
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak = Math.min(c.challengeStreak + 5, 100);
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak = Math.min(c.challengeStreak + 2, 100);
            } else {
              c.challengeStreak = Math.min(c.challengeStreak + 1, 100);
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          }
          
          // Verificar victoria PRIMERO antes de mostrar power-ups o castigos
          if(bestias12HP <= 0) {
            console.log('üê≤ ¬°LAS 12 BESTIAS HAN SIDO DERROTADAS!');
            setTimeout(() => {
              showBestias12Victory();
            }, 2000);
            return;
          }
          
          // Verificar power-ups cada 5 cartas (EXCEPTO cuando hay castigo cada 20)
          if(bestias12CardsAnswered % 5 === 0 && bestias12CardsAnswered % 20 !== 0) {
            grantBestias12PowerUp();
          }
          
          // CASTIGO CADA 20 TARJETAS: Elegir un castigo aleatorio
          if(bestias12CardsAnswered % 20 === 0 && bestias12CardsAnswered > 0) {
            console.log(`üíÄ ¬°CASTIGO! Has respondido ${bestias12CardsAnswered} cartas correctamente`);
            showBestias12PunishmentChoice();
          }
          
        } else {
          // Respuesta incorrecta: las bestias se fortalecen
          console.log('üê≤ Respuesta incorrecta - Las 12 Bestias se fortalecen!');
          
          // Perder una vida
          bestias12Lives--;
          updateBestias12LivesDisplay();
          
          // Eliminar un car√°cter aleatorio de la colecci√≥n (castigo)
          const knownCards = cards.filter(card => card.known && !card.isHoroscopeAnimal && card.unit !== 'horoscopo');
          if (knownCards.length > 0) {
            const randomCard = knownCards[Math.floor(Math.random() * knownCards.length)];
            randomCard.known = false;
            randomCard.challengeStreak = 0;
            ensureReviseFlags(randomCard);
            
            // Mostrar notificaci√≥n del castigo
            showBestias12Punishment(randomCard);
          }
          
          // Verificar si se acabaron las vidas
          if (bestias12Lives <= 0) {
            console.log('‚ò†Ô∏è Sin vidas - Las 12 Bestias han ganado!');
            setTimeout(() => {
              showBestias12Result(false, 'Te quedaste sin vidas');
            }, 2000);
            return;
          }
          
          // Efectos especiales de tarjetas en respuesta incorrecta
          if(cardEl.classList.contains('emperatriz-crimson')) {
            // Tarjeta bordo: castigo extra - perder tiempo
            bestias12Timer = Math.max(0, bestias12Timer - 15);
            console.log('üíî Tarjeta BORDO fall√≥: -15 segundos de tiempo!');
            showBestias12Effect('-15 SEGUNDOS', '#ef4444');
            updateBestias12Timer();
          }
          
          // Reiniciar racha del car√°cter si estaba en conocidas
          if(c.known) {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
        
        // Actualizar indicadores
        updateBestias12PowerUpIndicator();
      }

      if(knew) {
        sessionCorrect++;
        sessionCorrectAccumulated++; // üìä Acumular para estad√≠sticas
        // Sumar XP si es modo quiz
        if(mode === 'quizPinyin' || mode === 'quizMeaning' || mode === 'quizHanzi') {
          const prevLevel = getCurrentLevel(xpPoints);
          xpPoints++;
          saveXP();
          const newLevel = getCurrentLevel(xpPoints);
          
          // Hacer la animaci√≥n del level up ASINCRONA para no bloquear nextCard()
          setTimeout(() => {
            renderXPBar(newLevel > prevLevel);
          }, 0); // Ejecutar en el siguiente tick del event loop
        }
      } else {
        sessionWrongAccumulated++; // üìä Acumular errores para estad√≠sticas
      }
      todayReviewed++;
      saveAll();
      nextCard();
    }

  function nextCard(){
    // Reset flag de respuesta para nueva carta
    window.isAnswering = false;

    // ========= LIMPIAR OPCIONES ELIMINADAS DE ASISTENCIA =========
    if (assistanceEnabled || practiceAssistanceEnabled) {
      clearEliminatedOptions();
    }
    
    // DESTRUIR CASILLAS ANTES DEL FLIP (solo en m√≥vil para evitar titileo)
    if(isMobile()) {
      const quizRow = document.getElementById('quizRow');
      if(quizRow) {
        // Guardar altura para evitar saltos
        const currentHeight = quizRow.offsetHeight;
        quizRow.style.minHeight = currentHeight + 'px';
        // Limpiar casillas
        quizRow.innerHTML = '';
      }
    }
    
    // Delay m√≠nimo antes de iniciar la animaci√≥n de flip
    setTimeout(() => {
      cardEl.classList.add('card-flip-vert', 'flipping');
      setTimeout(() => {
        // En el punto medio del flip, cambiar el contenido
        flipped = false; cardEl.classList.remove('flip');
        // DESAF√çO FINAL: Usar su propio pool de cartas
        if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
          console.log('üîÑ DEBUG: Ultimate Challenge nextCard()');
          console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
          console.log('- ultimateChallengeCards.length:', ultimateChallengeCards.length);
          
          if (ultimateChallengeCardIndex >= ultimateChallengeCards.length) {
            console.warn('‚ùå Ultimate Challenge: No m√°s cartas');
            finishUltimateChallenge();
            return;
          }
          
          currentCard = ultimateChallengeCards[ultimateChallengeCardIndex];
          console.log('üÉã Carta seleccionada:', currentCard);
          
          // Actualizar animal si es necesario (cada 5 cartas)
          const animalIndex = Math.floor(ultimateChallengeCardIndex / 5);
          if (animalIndex !== ultimateChallengeAnimalIndex) {
            ultimateChallengeAnimalIndex = animalIndex;
            console.log('üêæ Cambiando a animal √≠ndice:', ultimateChallengeAnimalIndex);
          }
          
          // SOLO actualizar contador, NO incrementar √≠ndice aqu√≠ (lo hace handleUltimateChallengeAnswer)
          console.log('üìä Llamando updateUltimateChallengeCounter() desde nextCard()');
          updateUltimateChallengeCounter();
        } else {
          currentCard = sessionQueue.shift() || null;
        }
        
        // LIMPIAR CLASES DE BOTONES QUIZ PARA EVITAR CASILLAS SEMI-MARCADAS EN M√ìVIL
        const quizBtns = Array.from(document.querySelectorAll('#quizRow button'));
        quizBtns.forEach(b => {
          // Limpiar todas las clases de estado
          b.classList.remove('optCorrect', 'optWrong', 'optCorrectFade', 'optWrongFade');
          // Limpiar estilos inline que puedan quedar
          b.style.backgroundColor = '';
          b.style.borderColor = '';
          b.style.color = '';
          b.style.opacity = '';
          // Resetear al estado por defecto y habilitar
          b.disabled = false;
          b.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-lg';
          // FORZAR RE-RENDER COMPLETO para eliminar estados hover persistentes
          b.style.display = 'none';
          b.offsetHeight; // Trigger reflow
          b.style.display = '';
        });
        
        // Si estamos en challenge o desafios (incluyendo hor√≥scopo, emperatriz, bestias12 y todos los jefes finales), elegir aleatoriamente entre quizMeaning, quizPinyin o quizHanzi
        if((currentMission==='challenge' || currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3' || currentMission.startsWith('desafio') || currentMission==='LA EMPERATRIZ' || currentMission==='bestias12' || currentMission==='LAS 12 BESTIAS' || currentMission==='CRUZAR EL MAR' || currentMission==='cruzarCielo' || currentMission==='Cruzar HSK3' || currentMission==='Cruzar HSK4' || currentMission==='menos' || currentMission==='mas') && currentCard) {
          const quizModes = ['quizMeaning', 'quizPinyin', 'quizHanzi'];
          setMode(quizModes[Math.floor(Math.random() * quizModes.length)]);
          
          console.log(`üé≤ MODO ALEATORIO APLICADO: ${mode} para ${currentMission} - Tarjeta ${currentCard.hanzi}`);
          
          // üîß CR√çTICO: Llamar a setupQuizChoices() DESPU√âS de setMode() para boss challenges
          // Esto asegura que las opciones se generen con el modo correcto y smart options
          if (currentMission === 'LA EMPERATRIZ' || currentMission === 'CRUZAR EL MAR' || 
              currentMission === 'cruzarCielo' || currentMission === 'Cruzar HSK3' || 
              currentMission === 'Cruzar HSK4' || currentMission === 'bestias12' || 
              currentMission === 'LAS 12 BESTIAS') {
            console.log(`üéØ Boss challenge detectado: llamando setupQuizChoices() para ${currentMission}`);
            setTimeout(() => {
              setupQuizChoices();
            }, 20);
          }
          
          // M√ìVIL: Crear casillas DESPU√âS de configurar el modo (solo para desaf√≠os del hor√≥scopo, NO Ultimate Challenge)
          if (isMobile() && currentMission.startsWith('desafio') && currentMission !== 'ultimateChallenge') {
            setTimeout(() => {
              createQuizButtonsAfterFlip();
            }, 15);
          }
          
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        } else if(['quizPinyin','quizMeaning','quizHanzi'].includes(mode) && currentCard) {
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        }
        // Premium gold (20%), mythic violet (10%) y legendary red (5%) en modo desaf√≠o
        if ((currentMission==='challenge'||currentMission==='desafioN1'||currentMission==='desafioN2'||currentMission==='desafioN3'||currentMission.startsWith('desafio')||currentMission==='LA EMPERATRIZ'||currentMission==='bestias12'||currentMission==='LAS 12 BESTIAS'||currentMission==='Cruzar HSK3'||currentMission==='Cruzar HSK4'||currentMission==='CRUZAR EL MAR'||currentMission==='cruzarCielo') && currentCard) {
          const rand = Math.random();
          
          // Tarjetas especiales de La Emperatriz (solo en modo emperatriz y desaf√≠os tipo boss)
          if ((currentMission === 'LA EMPERATRIZ' || currentMission === 'Cruzar HSK3' || currentMission === 'Cruzar HSK4' || currentMission === 'CRUZAR EL MAR' || currentMission === 'cruzarCielo' || currentMission === 'bestias12' || currentMission === 'LAS 12 BESTIAS') && emperatrizActive) {
            if (rand < 0.10) {
              // 10% Tarjeta Naranja - Buff de da√±o
              cardEl.classList.add('emperatriz-orange');
              removeOtherSpecialClasses('emperatriz-orange');
            } else if (rand < 0.15) {
              // 5% Tarjeta Celeste - Bonus de tiempo
              cardEl.classList.add('emperatriz-cyan');
              removeOtherSpecialClasses('emperatriz-cyan');
            } else if (rand < 0.25) {
              // 10% Tarjeta Bordo - Debuff de da√±o
              cardEl.classList.add('emperatriz-crimson');
              removeOtherSpecialClasses('emperatriz-crimson');
            } else if (rand < 0.35) {
              // 10% Tarjeta Turquesa - Absorci√≥n de da√±o
              cardEl.classList.add('emperatriz-turquoise');
              removeOtherSpecialClasses('emperatriz-turquoise');
            } else if (rand < 0.42) {
              // 7% Legendary red (mantener mec√°nica original)
              cardEl.classList.add('legendary-red');
              removeOtherSpecialClasses('legendary-red');
            } else if (rand < 0.47) {
              // 5% Mythic violet (mantener mec√°nica original)
              cardEl.classList.add('mythic-violet');
              removeOtherSpecialClasses('mythic-violet');
            } else if (rand < 0.57) {
              // 10% Premium gold (mantener mec√°nica original)
              cardEl.classList.add('premium-gold');
              removeOtherSpecialClasses('premium-gold');
            } else {
              // 43% Tarjeta normal
              removeAllSpecialClasses();
            }
          // Tarjetas especiales de 12 Bestias (solo en modo bestias12)
          } else if (bestias12Active) {
            if (rand < 0.10) {
              // 10% Tarjeta Naranja - Buff de da√±o
              cardEl.classList.add('bestias12-orange');
              removeOtherSpecialClasses('bestias12-orange');
            } else if (rand < 0.15) {
              // 5% Tarjeta Celeste - Bonus de tiempo
              cardEl.classList.add('bestias12-cyan');
              removeOtherSpecialClasses('bestias12-cyan');
            } else if (rand < 0.25) {
              // 10% Tarjeta Bordo - Debuff de da√±o
              cardEl.classList.add('bestias12-crimson');
              removeOtherSpecialClasses('bestias12-crimson');
            } else if (rand < 0.35) {
              // 10% Tarjeta Turquesa - Absorci√≥n de da√±o
              cardEl.classList.add('bestias12-turquoise');
              removeOtherSpecialClasses('bestias12-turquoise');
            } else if (rand < 0.42) {
              // 7% Legendary red (mantener mec√°nica original)
              cardEl.classList.add('legendary-red');
              removeOtherSpecialClasses('legendary-red');
            } else if (rand < 0.47) {
              // 5% Mythic violet (mantener mec√°nica original)
              cardEl.classList.add('mythic-violet');
              removeOtherSpecialClasses('mythic-violet');
            } else if (rand < 0.57) {
              // 10% Premium gold (mantener mec√°nica original)
              cardEl.classList.add('premium-gold');
              removeOtherSpecialClasses('premium-gold');
            } else {
              // 43% Tarjeta normal
              removeAllSpecialClasses();
            }
          } else {
            // L√≥gica original para otros modos de desaf√≠o
            if (rand < 0.15) {
              cardEl.classList.add('legendary-red');
              cardEl.classList.remove('mythic-violet');
              cardEl.classList.remove('premium-gold');
            } else if (rand < 0.2) {
              cardEl.classList.add('mythic-violet');
              cardEl.classList.remove('legendary-red');
              cardEl.classList.remove('premium-gold');
            } else if (rand < 0.50) {
              cardEl.classList.add('premium-gold');
              cardEl.classList.remove('legendary-red');
              cardEl.classList.remove('mythic-violet');
            } else {
              cardEl.classList.remove('legendary-red');
              cardEl.classList.remove('premium-gold');
              cardEl.classList.remove('mythic-violet');
            }
          }
          
          // üè∑Ô∏è Agregar etiquetas de esquina para tarjetas especiales
          addCardCornerLabel();
        } else {
          cardEl.classList.remove('legendary-red');
          cardEl.classList.remove('premium-gold');
          cardEl.classList.remove('mythic-violet');
          
          // Limpiar etiquetas de esquina
          removeCardCornerLabel();
        }
        
        // DESAF√çO FINAL: Renderizado especial
        if (ultimateChallengeActive && currentMission === 'ultimateChallenge' && currentCard) {
          renderUltimateChallengeCard(currentCard);
        } else {
          renderCard();
        }
        
        // üëë ACTUALIZAR CAJA DE POWER-UPS DE LA EMPERATRIZ Y DESAF√çOS TIPO BOSS CON LA NUEVA CARTA
        if (emperatrizActive && (currentMission === 'LA EMPERATRIZ' || currentMission === 'Cruzar HSK3' || currentMission === 'Cruzar HSK4' || currentMission === 'CRUZAR EL MAR' || currentMission === 'cruzarCielo') && currentCard) {
          updateEmperatrizPowerUpBox();
        }
        
        // üê≤ ACTUALIZAR CAJA DE POWER-UPS DE 12 BESTIAS CON LA NUEVA CARTA
        if (bestias12Active && (currentMission === 'bestias12' || currentMission === 'LAS 12 BESTIAS') && currentCard) {
          updateBestias12PowerUpBox();
        }
        
        updateStats();
        // limpiar animaciones para la pr√≥xima
        cardEl.classList.remove('popAnim','shakeAnim'); // 'correct-override' removido - ya no se usa
        // Completar el flip
        cardEl.classList.remove('flipping');
        cardEl.classList.add('flipped');
        setTimeout(() => {
          cardEl.classList.remove('card-flip-vert', 'flipped');
          // SOLUCI√ìN M√ìVIL: Crear casillas por primera vez despu√©s del flip 
          // (NO para desaf√≠os que ya se manejan arriba, Ultimate Challenge se maneja arriba tambi√©n)
          setTimeout(() => {
            if (isMobile() && currentMission !== 'ultimateChallenge' && !currentMission.startsWith('desafio') && currentMission !== 'challenge' && currentMission !== 'desafioN1' && currentMission !== 'desafioN2' && currentMission !== 'desafioN3') {
              createQuizButtonsAfterFlip();
            }
          }, 50);
        }, 440);
      }, 220); // punto medio del flip
    }, 100); // delay m√≠nimo antes de iniciar la animaci√≥n
}

  // Funci√≥n para agregar labels de power-up en la esquina
  function addPowerUpLabel() {
    // Remover label existente si hay uno
    const existingLabel = cardEl.querySelector('.power-up-label');
    if (existingLabel) {
      existingLabel.remove();
    }
    
    let labelText = '';
    let labelClass = '';
    
    // Detectar tipo de tarjeta especial y asignar texto
    if (cardEl.classList.contains('emperatriz-orange') || cardEl.classList.contains('bestias12-orange')) {
      labelText = 'DA√ëO CR√çTICO';
      labelClass = 'critico';
    } else if (cardEl.classList.contains('emperatriz-cyan') || cardEl.classList.contains('bestias12-cyan')) {
      labelText = 'GANAS 20 SEGS';
      labelClass = 'tiempo';
    } else if (cardEl.classList.contains('emperatriz-crimson') || cardEl.classList.contains('bestias12-crimson')) {
      labelText = 'DA√ëO REDUCIDO';
      labelClass = 'reduccion';
    } else if (cardEl.classList.contains('emperatriz-turquoise') || cardEl.classList.contains('bestias12-turquoise')) {
      labelText = 'DA√ëO ABSORBIDO';
      labelClass = 'absorcion';
    }
    
    // Crear y agregar el label si hay un tipo detectado
    if (labelText) {
      const label = document.createElement('div');
      label.className = `power-up-label ${labelClass}`;
      label.textContent = labelText;
      cardEl.appendChild(label);
    }
  }

  function renderCard(){
    if(!currentCard){
      // üî¥ CHECKPOINT: Guardar al terminar desaf√≠o (completado o fallado)
      console.log(`üî¥ CHECKPOINT [renderCard - Desaf√≠o terminado]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
      SaveQueue.flush();
      
      const n = sessionTotal, x = sessionCorrect;
      const percent = n > 0 ? Math.round((x / n) * 100) : 0;
      backEl.textContent = '';
      frontEl.innerHTML = `<div class="text-3xl font-semibold">${x} / ${n} correctas</div>`;
      // Prevent flipping on results card
      cardEl.classList.remove('flip');
      cardEl.onclick = null;
      document.getElementById('btnFlip').disabled = true;
      
      // ========= DESACTIVAR SISTEMA DE ASISTENCIA AL TERMINAR CUALQUIER DESAF√çO =========
      console.log('üÜò Desactivando asistencia al terminar desaf√≠o');
      disableAssistance();
      
      // üî• FINALIZAR TIMER2 Y VIDAS2 PARA DESAF√çOS CL√ÅSICOS
      if (desafioClasico2Active && (currentMission === 'challenge' || currentMission === 'clasico' || currentMission === 'menos' || currentMission === 'mas')) {
        console.log('üèÅ FINALIZANDO DESAF√çO CL√ÅSICO: Deteniendo timer2 y ocultando vidas2');
        desafioClasico2Active = false;
        stopDesafioClasico2Timer();
        hideDesafioClasico2Hearts();
      }
      
      // üêæ FINALIZAR SOLO TIMER N PARA DESAF√çOS DEL HOR√ìSCOPO (SIN VIDAS)
      if (desafioNActive && currentMission.startsWith('desafio') && 
          currentMission !== 'desafioN1' && currentMission !== 'desafioN2' && currentMission !== 'desafioN3') {
        console.log('üèÅ FINALIZANDO DESAF√çO HOR√ìSCOPO: Deteniendo solo timer N (sin vidas)');
        desafioNActive = false;
        stopDesafioNTimer();
        // No ocultar vidas N porque no se muestran en desaf√≠os del hor√≥scopo
      }
      
      // Capturar estado final para desaf√≠os y mostrar notificaci√≥n de cambios
      if (currentMission === 'challenge' || currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3' || currentMission.startsWith('desafio')) {
        console.log('üìä Capturando estado post-desaf√≠o y mostrando cambios');
        setTimeout(() => capturePostChallengeState(), 2000); // Delay para que se vean las celebraciones primero
      }
      
      // Sonido y confetti de celebraci√≥n si >= 85%
      if (percent >= 85) {
        showConfetti();
        soundCelebration();
        // GIF animations removed for cleaner UX
        // const gifs = [
        //   'img/cat1.gif',
        //   'img/cat4.gif',
        //   'img/cat5.gif'
        // ];
        // const chosen = gifs[Math.floor(Math.random() * gifs.length)];
        // showCelebrationGif(chosen);
        // Actualizar racha global en backend si est√° en modo desaf√≠o y aprueba
        if (currentMission === 'challenge' || currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3' || currentMission.startsWith('desafio')) {
          console.log(`üî• Actualizando racha global en backend (${percent}% aprobado)`);
          // PRIMERO actualizar la racha global (esto actualiza streak y lastChallengeAt)
          actualizarRacha(percent).then(() => {
            console.log('‚úÖ Racha global actualizada');
            // ‚úÖ NO guardamos aqu√≠ - El checkpoint ya hizo flush antes
          }).catch(err => {
            console.error('‚ùå Error actualizando racha global:', err);
          });
        }
        
        // Marcar Desaf√≠o N3 como completado si se aprob√≥
        if (currentMission === 'desafioN3') {
          console.log('üéØ Desaf√≠o N3 finalizado con', percent, '% de aciertos');
          completarDesafioN3();
        }
        
        // DESBLOQUEAR ANIMAL DEL HOR√ìSCOPO si es un desaf√≠o del hor√≥scopo exitoso
        console.log(`üîç DEBUG Desbloqueo: percent=${percent}, currentMission=${currentMission}`);
        console.log(`üîç Es desaf√≠o hor√≥scopo?: ${isHoroscopeChallenge(currentMission)}`);
        
        if (percent >= 85 && isHoroscopeChallenge(currentMission)) {
          const categoria = getHoroscopeCategoryFromMission(currentMission);
          console.log(`üéâ DESBLOQUEANDO ANIMAL: ${categoria}`);
          unlockHoroscopeAnimal(categoria);
        } else {
          console.log(`‚ùå No se desbloquea: percent < 85 o no es desaf√≠o hor√≥scopo`);
        }
        
        // MENSAJE ESPECIAL PARA DESAF√çO N3
        if (currentMission === 'desafioN3') {
          showDesafioN3Message();
        }
      }
// Llama al backend para actualizar la racha si aprueba el desaf√≠o
async function actualizarRacha(percent) {
  // Versi√≥n Documental: actualizar racha localmente y guardar en localStorage
  console.log('üî• Actualizando racha (localStorage):', { percent, streakActual: streak });
  
  try {
    // Verificar si puede hacer desaf√≠o hoy
    const ahora = Date.now();
    const unDia = 24 * 60 * 60 * 1000;
    const pasaronMasDe24Horas = !lastChallengeAt || (ahora - lastChallengeAt >= unDia);
    
    if (pasaronMasDe24Horas && percent >= 70) {
      // Incrementar racha
      streak = (streak || 0) + 1;
      lastChallengeAt = ahora;
      console.log('‚úÖ Racha incrementada:', streak);
      
      updateStreakBox();
      animarStreakFire();
      
      // Guardar en localStorage
      await saveUserState();
    } else {
      console.log('‚ö†Ô∏è Ya complet√≥ el desaf√≠o hoy o no alcanz√≥ 70%');
      // Solo actualizar UI
      updateStreakBox();
    }
  } catch (e) {
    console.error('‚ùå Error actualizando racha (localStorage):', e);
  }
}

// Animaci√≥n de fuego en el box de racha
function animarStreakFire() {
  const box = document.getElementById('streakBox');
  if (!box) return;
  box.classList.add('streak-fire-anim');
  // Solo animaci√≥n visual, sin emoji
  soundFireEffect();
  setTimeout(() => {
    box.classList.remove('streak-fire-anim');
  }, 1500);
}

// Sonido especial de fuego
function soundFireEffect() {
  // Sonido glorioso tipo coro: acorde mayor y fade
  beep(523, 0.22, 'triangle', 0.13); // C5
  beep(659, 0.22, 'triangle', 0.11); // E5
  beep(784, 0.22, 'triangle', 0.10); // G5
  setTimeout(() => beep(1046, 0.18, 'triangle', 0.09), 120); // C6
  setTimeout(() => beep(1568, 0.13, 'triangle', 0.08), 220); // G6
}

/* Animaci√≥n CSS para el box de racha */
const streakFireStyle = document.createElement('style');
streakFireStyle.textContent = `
  .streak-fire-anim {
    box-shadow: 0 0 32px 8px #f87171, 0 0 0 4px #f59e42;
    background: linear-gradient(90deg, #f59e42 0%, #f87171 100%);
    transition: box-shadow 0.3s, background 0.3s;
  }
`;
document.head.appendChild(streakFireStyle);
// Muestra un GIF adorable en el centro de la pantalla por 2 segundos
function showCelebrationGif(src) {
  let gif = document.getElementById('celebrationGif');
  if (!gif) {
    gif = document.createElement('img');
    gif.id = 'celebrationGif';
    gif.src = src;
    gif.style.position = 'fixed';
    // Ubicaci√≥n: centrado horizontal, posicionamiento optimizado para m√≥vil
    const card = document.getElementById('card');
    if (card) {
      const rect = card.getBoundingClientRect();
      gif.style.left = (rect.left + rect.width/2) + 'px';
      
      // Ajuste especial para m√≥vil: evitar que se corte
      if (isMobile()) {
        // En m√≥vil: posicionar en el centro vertical de la tarjeta
        gif.style.top = (rect.top + rect.height/2) + 'px';
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        // En desktop: posici√≥n original debajo de la tarjeta
        gif.style.top = (rect.bottom) + 'px';
        gif.style.transform = 'translate(-50%, 0)';
      }
    } else {
      gif.style.left = '50%';
      if (isMobile()) {
        gif.style.top = '50%'; // Centro en m√≥vil
        gif.style.transform = 'translate(-50%, -50%)';
      } else {
        gif.style.top = '80%'; // Posici√≥n original en desktop
        gif.style.transform = 'translate(-50%, 0)';
      }
    }
    gif.style.zIndex = '99999';
  // Tama√±o por defecto
  let gifWidth = 270;
  
  // Ajuste para m√≥vil: reducir tama√±o para que no se salga de pantalla
  if (isMobile()) {
    gifWidth = Math.min(gifWidth, window.innerWidth * 0.6); // M√°ximo 60% del ancho de pantalla
  }
  
  // Ajuste especial para cat1, cat4 y cat5
  if (src.includes('cat1')) gifWidth = Math.round(gifWidth * 1.3); // 30% m√°s grande
  if (src.includes('cat4')) gifWidth = Math.round(gifWidth * 0.75); // 35% m√°s peque√±o
  if (src.includes('cat5')) gifWidth = Math.round(gifWidth * 0.5);  // 50% m√°s peque√±o
  gif.style.width = gifWidth + 'px';
    gif.style.height = 'auto';
    gif.style.opacity = '1';
    gif.style.transition = 'opacity 0.7s';
    document.body.appendChild(gif);
  } else {
    gif.src = src;
    gif.style.opacity = '1';
    gif.style.display = '';
  }
  setTimeout(() => {
    gif.style.opacity = '0';
    setTimeout(() => { if (gif) gif.style.display = 'none'; }, 700);
  }, 2000);
}
      // --- L√≥gica para mostrar bot√≥n Nivel 2 e insignia ---
      if(currentMission==='desafioN1'){
        // Limpiar sistema de desaf√≠o N
        desafioNActive = false;
        stopDesafioNTimer();
        hideDesafioNHearts();
        
        if(sessionTotal === 20){
          if(desafioNTimeLeft>0 && percent>=90){
            // ‚úÖ Marcar Desaf√≠o N1 como completado (desbloquea Cruzar el Mar)
            desafioN1Completed = true;
            desafioN1CompletedAt = new Date().toISOString();
            
            // üèÖ Actualizar bot√≥n Niveles con medalla
            updateNivelesButtonText();
            
            // Guardar y actualizar UI (sin modal de victoria)
            saveUserState().then(() => {
              showNivel1Badge();
              showCruzarMarButton(); // Mostrar bot√≥n Cruzar el Mar
            });
          } else if(desafioNTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioNoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioNoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }

      // --- L√≥gica para mostrar bot√≥n Nivel 3 ---
      if(currentMission==='desafioN2'){
        // Limpiar sistema de desaf√≠o N
        desafioNActive = false;
        stopDesafioNTimer();
        hideDesafioNHearts();
        
        if(sessionTotal === 20){
          if(desafioNTimeLeft>0 && percent>=90){
            // ‚úÖ Marcar Desaf√≠o N2 como completado (desbloquea Cruzar el Cielo)
            desafioN2Completed = true;
            desafioN2CompletedAt = new Date().toISOString();
            
            // üèÖ Actualizar bot√≥n Niveles con medalla
            updateNivelesButtonText();
            
            // Guardar y actualizar UI (sin modal de victoria)
            saveUserState().then(() => {
              showNivel2Badge();
              showCruzarCieloButton(); // Mostrar bot√≥n Cruzar el Cielo
            });
          } else if(desafioNTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioN2NoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioN2NoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado el Desaf√≠o N2 (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }
      // Ocultar la tabla de conocidas en modo desaf√≠o
      const knownTableSection = document.querySelector('section.mt-16');
      if(currentMission==='challenge' || currentMission==='desafioN1' || currentMission==='desafioN2' || currentMission==='desafioN3' || currentMission.startsWith('desafio')) {
        if(knownTableSection) knownTableSection.style.display = 'none';
      } else {
        if(knownTableSection) knownTableSection.style.display = '';
      }
  return;
}

// --- Mensaje especial para Desaf√≠o N3 ---
function showDesafioN3Message() {
  // Limpiar sistema de desaf√≠o N
  desafioNActive = false;
  stopDesafioNTimer();
  hideDesafioNHearts();
  
  // No mostrar modal de victoria - solo el modal de cambios de nivel
  // El modal de cambios ya se muestra autom√°ticamente con capturePostChallengeState()
  
  // Sonido especial de logro
  setTimeout(() => {
    beep(523, 0.3, 'sine', 0.2); // C5
    setTimeout(() => beep(659, 0.3, 'sine', 0.18), 150); // E5
    setTimeout(() => beep(784, 0.3, 'sine', 0.16), 300); // G5
    setTimeout(() => beep(1046, 0.4, 'sine', 0.15), 450); // C6
  }, 500);
}

// --- Mostrar bot√≥n Nivel 2 ---
function showNivel2Button(){
  console.log('üîì showNivel2Button() llamada - desbloqueando Nivel 2...');
  
  // Actualizar AMBAS variables por compatibilidad
  nivel2Unlocked = true;
  console.log('‚úÖ nivel2Unlocked actualizada a:', nivel2Unlocked);
  
  // Como Nivel 2 se desbloquea completando Cruzar el Mar, tambi√©n aseguramos que est√© marcado
  if (!cruzarMarCompleted) {
    console.log('‚ö†Ô∏è showNivel2Button llamado pero cruzarMarCompleted es false - esto no deber√≠a pasar');
  }
  
  saveUserState();
  
  // Mostrar el Nivel 2
  const nivel2Wrap = document.getElementById('nivel2Wrap');
  const btnNivel2 = document.getElementById('btnNivel2');
  const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
  
  if(nivel2Wrap) {
    nivel2Wrap.style.display = '';
    console.log('‚úÖ nivel2Wrap mostrado');
  }
  if(btnNivel2) {
    btnNivel2.style.display = '';
    console.log('‚úÖ btnNivel2 mostrado');
  }
  if(nivel2ProgressWrap) {
    nivel2ProgressWrap.style.display = 'flex';
    console.log('‚úÖ nivel2ProgressWrap mostrado');
  }
  
  console.log('‚úÖ Nivel 2 desbloqueado y mostrado completamente');
}

// --- Mostrar bot√≥n Nivel 3 ---
function showNivel3Button(){
  nivel3Unlocked = true;
  saveUserState();
  
  // Mostrar el Nivel 3
  const nivel3Wrap = document.getElementById('nivel3Wrap');
  const btnNivel3 = document.getElementById('btnNivel3');
  const nivel3ProgressWrap = document.getElementById('nivel3ProgressWrap');
  
  if(nivel3Wrap) nivel3Wrap.style.display = '';
  if(btnNivel3) btnNivel3.style.display = '';
  if(nivel3ProgressWrap) nivel3ProgressWrap.style.display = 'flex';
  
  // Desbloquear botones del hor√≥scopo
  updateHoroscopeButtonsState();
  
  // Mostrar mensaje de celebraci√≥n por desbloqueo
  setTimeout(() => {
    showNivel3UnlockedCelebration();
  }, 1000); // Peque√±o delay para que se vea primero el badge del nivel 2
  
  console.log('‚úÖ Nivel 3 desbloqueado y mostrado');
}

// --- Mostrar bot√≥n Cruzar el Mar ---
function showCruzarMarButton(){
  const btnCruzarMar = document.getElementById('btnCruzarMar');
  
  if(btnCruzarMar) {
    // Remover el candado si existe
    const lockIcon = btnCruzarMar.querySelector('.lock-icon');
    if(lockIcon) lockIcon.remove();
    
    // Habilitar el bot√≥n
    btnCruzarMar.disabled = false;
    btnCruzarMar.style.opacity = '1';
    btnCruzarMar.style.cursor = 'pointer';
    btnCruzarMar.style.filter = 'none';
    
    // Mostrar mensaje de celebraci√≥n
    const msg = document.createElement('div');
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.style.cssText = 'font-family: "Jersey 10", monospace; max-width: 90vw; min-width: 320px; text-align: center; line-height: 1.3;';
    msg.innerHTML = 'üåä ¬°CRUZAR EL MAR<br>DESBLOQUEADO! üåä';
    msg.onclick = () => { msg.remove(); };
    document.body.appendChild(msg);
    setTimeout(() => { msg.remove(); }, 3000);
  }
  
  console.log('‚úÖ Cruzar el Mar desbloqueado y mostrado');
}

// Mostrar bot√≥n Cruzar el Cielo (se llama cuando se completa Desaf√≠o N2)
function showCruzarCieloButton(){
  console.log('üåü showCruzarCieloButton() llamada');
  const btnCruzarCielo = document.getElementById('btnCruzarCielo');
  
  if(btnCruzarCielo) {
    // Remover el candado si existe
    const lockIcon = btnCruzarCielo.querySelector('.lock-icon');
    if(lockIcon) {
      lockIcon.remove();
      console.log('‚úÖ Candado removido');
    }
    
    // Habilitar el bot√≥n
    btnCruzarCielo.disabled = false;
    btnCruzarCielo.style.opacity = '1';
    btnCruzarCielo.style.cursor = 'pointer';
    btnCruzarCielo.style.filter = 'none';
    console.log('‚úÖ Estilos del bot√≥n actualizados');
    
    // Mostrar mensaje de celebraci√≥n
    const msg = document.createElement('div');
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-pink-600 to-rose-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.style.cssText = 'font-family: "Jersey 10", monospace; max-width: 90vw; min-width: 320px; text-align: center; line-height: 1.3;';
    msg.innerHTML = '‚òÅÔ∏è ¬°CRUZAR EL CIELO<br>DESBLOQUEADO! ‚òÅÔ∏è';
    msg.onclick = () => { msg.remove(); };
    document.body.appendChild(msg);
    setTimeout(() => { msg.remove(); }, 3000);
  }
  
  console.log('‚úÖ Cruzar el Cielo desbloqueado y mostrado');
}

// Actualizar estado visual de botones del hor√≥scopo
function updateHoroscopeButtonsState() {
  const btnHoroscopo = document.getElementById('btnHoroscopo');
  const btnDesafiosHoroscopo = document.getElementById('btnDesafiosHoroscopo');
  
  console.log('üîÑ Actualizando estado botones hor√≥scopo. Nivel3Unlocked:', nivel3Unlocked);
  
  if (nivel3Unlocked) {
    // Desbloquear: remover clase locked y aplicar estilos desbloqueados IGUAL QUE OTROS BOTONES
    if (btnHoroscopo) {
      btnHoroscopo.classList.remove('locked');
      btnHoroscopo.disabled = false;
      btnHoroscopo.style.opacity = '1';
      btnHoroscopo.style.cursor = 'pointer';
      btnHoroscopo.style.filter = 'none';
      console.log('üîì btnHoroscopo: desbloqueado con estilos inline');
    }
    if (btnDesafiosHoroscopo) {
      btnDesafiosHoroscopo.classList.remove('locked');
      btnDesafiosHoroscopo.disabled = false;
      btnDesafiosHoroscopo.style.opacity = '1';
      btnDesafiosHoroscopo.style.cursor = 'pointer';
      btnDesafiosHoroscopo.style.filter = 'none';
      console.log('üîì btnDesafiosHoroscopo: desbloqueado con estilos inline');
    }
    console.log('üîì Botones del hor√≥scopo desbloqueados y estilos restaurados');
  } else {
    // Bloquear: agregar clase locked
    if (btnHoroscopo) {
      btnHoroscopo.classList.add('locked');
    }
    if (btnDesafiosHoroscopo) {
      btnDesafiosHoroscopo.classList.add('locked');
    }
    console.log('üîí Botones del hor√≥scopo bloqueados');
  }
  
  // Actualizar el bot√≥n "Los Hor√≥scopo" si est√° disponible
  if (typeof window.updateLosHoroscopoButton === 'function') {
    console.log('üåü Actualizando bot√≥n Los Hor√≥scopo');
    window.updateLosHoroscopoButton();
  }
  
  // Actualizar el bot√≥n "12 Bestias" - ‚úÖ SIN REQUISITOS
  const btnBestias12 = document.getElementById('btnBestias12');
  console.log('üê≤ DEBUG btnBestias12:', btnBestias12);
  
  if (btnBestias12) {
    // ‚úÖ Siempre desbloqueado
    btnBestias12.disabled = false;
    btnBestias12.style.opacity = '1';
    btnBestias12.style.cursor = 'pointer';
    btnBestias12.style.filter = 'none';
    
    const lockIcon = btnBestias12.querySelector('.lock-icon');
    if (lockIcon) {
      lockIcon.remove();
      console.log('üóëÔ∏è Candado removido de 12 Bestias');
    }
    console.log('‚úÖ 12 Bestias siempre desbloqueado');
  } else {
    console.error('‚ùå btnBestias12 NO ENCONTRADO en el DOM');
  }
  
  // Actualizar el bot√≥n "La Emperatriz" - ‚úÖ SIN REQUISITOS
  const btnLaEmperatriz = document.getElementById('btnLaEmperatriz');
  console.log('üëë DEBUG btnLaEmperatriz:', btnLaEmperatriz);
  
  if (btnLaEmperatriz) {
    // ‚úÖ Siempre desbloqueada
    btnLaEmperatriz.disabled = false;
    btnLaEmperatriz.style.opacity = '1';
    btnLaEmperatriz.style.cursor = 'pointer';
    btnLaEmperatriz.style.filter = 'none';
    
    const lockIcon = btnLaEmperatriz.querySelector('.lock-icon');
    if (lockIcon) {
      lockIcon.remove();
      console.log('üóëÔ∏è Candado removido de La Emperatriz');
    }
    console.log('‚úÖ La Emperatriz siempre desbloqueada');
  } else {
    console.error('‚ùå btnLaEmperatriz NO ENCONTRADO en el DOM');
  }
}

// Mostrar el bot√≥n Nivel 2 si est√° desbloqueado al cargar la p√°gina
window.addEventListener('DOMContentLoaded', async () => {
    // Bot√≥n cerrar sesi√≥n al lado de "si se traba"
    const btnTraba = document.getElementById('btnTraba');
    if(btnTraba && !document.getElementById('btnLogout')) {
      const btnLogout = document.createElement('button');
      btnLogout.id = 'btnLogout';
      btnLogout.textContent = 'Cerrar sesi√≥n';
      btnLogout.className = 'ml-2 px-4 py-2 rounded-xl bg-red-700 hover:bg-red-600 text-white font-bold';
      btnLogout.onclick = () => {
        localStorage.removeItem('jwtToken');
        location.reload();
      };
      btnTraba.parentNode.insertBefore(btnLogout, btnTraba.nextSibling);
    }
  await loadAll();
  
  // Mostrar SIEMPRE todos los niveles (la l√≥gica de bloqueo se maneja en los onclick)
  console.log('üéØ DOMContentLoaded: Mostrando todos los niveles siempre');
  const nivel2Wrap = document.getElementById('nivel2Wrap');
  const btnNivel2 = document.getElementById('btnNivel2');
  const nivel2ProgressWrap = document.getElementById('nivel2ProgressWrap');
  const nivel3Wrap = document.getElementById('nivel3Wrap');
  const btnNivel3 = document.getElementById('btnNivel3');
  const nivel3ProgressWrap = document.getElementById('nivel3ProgressWrap');
  
  if(nivel2Wrap) nivel2Wrap.style.display = '';
  if(btnNivel2) btnNivel2.style.display = '';
  if(nivel2ProgressWrap) nivel2ProgressWrap.style.display = nivel2Unlocked ? 'flex' : 'none';
  if(nivel3Wrap) nivel3Wrap.style.display = '';
  if(btnNivel3) btnNivel3.style.display = '';
  if(nivel3ProgressWrap) nivel3ProgressWrap.style.display = nivel3Unlocked ? 'flex' : 'none';
  if(btnNivel3) btnNivel3.style.display = '';
  
  // DEBUG: Verificaci√≥n temporal adicional
  console.log('üîç Estado al cargar p√°gina:');
  console.log('- nivel2Unlocked:', nivel2Unlocked);
  console.log('- xpPoints:', xpPoints);
  
  // Inicializar botones de reinicio
  initializeResetButtons();
  
  // ========= CONFIGURAR BOT√ìN HISTORIA =========
  console.log('üé≠ DEBUG: Configurando bot√≥n Historia en DOMContentLoaded principal');
  
  const btnHistoria = document.getElementById('btnHistoria');
  if (btnHistoria) {
    btnHistoria.onclick = function() {
      console.log('üé≠ DEBUG: ¬°Bot√≥n Historia clickeado!');
      showChapterModal();
    };
    console.log('üé≠ DEBUG: ‚úÖ Event listener del bot√≥n Historia configurado correctamente');
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el bot√≥n Historia en el DOM');
  }
  
  // üê≤ ACTUALIZACI√ìN de bot√≥n 12 Bestias al final del DOMContentLoaded
  setTimeout(() => {
    console.log('üê≤ Actualizando bot√≥n 12 Bestias...');
    const btnBestias12Force = document.getElementById('btnBestias12');
    if (btnBestias12Force) {
      console.log('üê≤ Bot√≥n encontrado, horoscopeAnimalsUnlocked:', horoscopeAnimalsUnlocked);
      // ‚úÖ SIN REQUISITOS - Bot√≥n siempre disponible, no agregar candado
      console.log('‚úÖ 12 Bestias siempre disponible sin requisitos');
    } else {
      console.error('‚ùå btnBestias12 NO encontrado en forzado');
    }
  }, 2000);
});

// --- Mostrar insignia de Nivel 1 aprobado ---
function showNivel1Badge(){
  // Eliminado: insignia estrella
}

// --- Mostrar insignia de Nivel 2 aprobado ---
function showNivel2Badge(){
  // Eliminado: insignia estrella
}
    // Frente: siempre hanzi, con bot√≥n de parlante si no es desaf√≠o
    frontEl.innerHTML = '';
    // Contenedor relativo para posicionar el parlante
    const frontWrap = document.createElement('div');
    frontWrap.style.position = 'relative';
    frontWrap.style.width = '100%';
    frontWrap.style.height = '100%';
    // Hanzi centrado
    const hanziSpan = document.createElement('span');
    hanziSpan.textContent = currentCard.hanzi;
    hanziSpan.style.display = 'inline-block';
    hanziSpan.style.position = 'absolute';
    hanziSpan.style.top = '50%';
    hanziSpan.style.left = '50%';
    hanziSpan.style.transform = 'translate(-50%, -50%)';
    frontWrap.appendChild(hanziSpan);
    
    // Mostrar nivel del car√°cter en La Emperatriz
    if(currentMission === 'emperatriz' && currentCard) {
      const levelBadge = document.createElement('div');
      levelBadge.style.cssText = `
        position: absolute;
        top: 8px;
        left: 8px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 4px 8px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 12px;
        font-weight: bold;
        border: 1px solid #b45309;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 10;
      `;
      levelBadge.textContent = `Nv.${currentCard.challengeStreak || 0}`;
      frontWrap.appendChild(levelBadge);
    }
    
    // Agregar texto descriptivo para tarjetas especiales de La Emperatriz
    if(currentMission === 'emperatriz') {
      let specialText = '';
      let specialColor = '';
      
      if(cardEl.classList.contains('emperatriz-orange')) {
        specialText = 'üî• DOBLE DA√ëO';
        specialColor = '#ff8c42';
      } else if(cardEl.classList.contains('emperatriz-cyan')) {
        specialText = '‚è∞ +20 SEGUNDOS';
        specialColor = '#22d3ee';
      } else if(cardEl.classList.contains('emperatriz-crimson')) {
        specialText = 'üíî DA√ëO REDUCIDO';
        specialColor = '#9f1239';
      }
      
      if(specialText) {
        const specialBadge = document.createElement('div');
        specialBadge.style.cssText = `
          position: absolute;
          top: 8px;
          left: 8px;
          background: linear-gradient(135deg, ${specialColor}CC, ${specialColor}AA);
          color: white;
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 10px;
          font-weight: bold;
          border: 1px solid ${specialColor};
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          z-index: 10;
        `;
        specialBadge.textContent = specialText;
        frontWrap.appendChild(specialBadge);
      }
    }
    
    // Agregar texto descriptivo para tarjetas especiales de 12 Bestias
    if(currentMission === 'bestias12') {
      let specialText = '';
      let specialColor = '';
      
      if(cardEl.classList.contains('bestias12-orange')) {
        specialText = 'üî• DOBLE DA√ëO';
        specialColor = '#ff8c42';
      } else if(cardEl.classList.contains('bestias12-cyan')) {
        specialText = '‚è∞ +20 SEGUNDOS';
        specialColor = '#22d3ee';
      } else if(cardEl.classList.contains('bestias12-crimson')) {
        specialText = 'üíî DA√ëO REDUCIDO';
        specialColor = '#9f1239';
      }
      
      if(specialText) {
        const specialBadge = document.createElement('div');
        specialBadge.style.cssText = `
          position: absolute;
          bottom: 8px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0,0,0,0.85);
          color: ${specialColor};
          padding: 4px 8px;
          border-radius: 6px;
          font-family: 'Jersey 10', monospace;
          font-size: 11px;
          font-weight: bold;
          border: 1px solid ${specialColor};
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          z-index: 10;
          text-align: center;
        `;
        specialBadge.textContent = specialText;
        frontWrap.appendChild(specialBadge);
      }
    }
    
    // Bot√≥n parlante (solo si NO es ning√∫n modo de desaf√≠o)
    const isChallengeModeForSpeaker = currentMission && (
      currentMission === 'challenge' ||
      currentMission === 'emperatriz' ||
      currentMission === 'bestias12' ||
      (typeof currentMission === 'string' && currentMission.startsWith('desafio')) ||
      (typeof currentMission === 'string' && currentMission.includes('horoscopo')) ||
      currentMission === 'ultimateChallenge' ||
      currentMission === 'final'
    );
    if(!isChallengeModeForSpeaker) {
      const speakBtn = document.createElement('button');
      speakBtn.title = 'Escuchar pronunciaci√≥n';
      speakBtn.style.position = 'absolute';
      speakBtn.style.top = '10px';
      speakBtn.style.right = '10px';
      speakBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      speakBtn.style.border = 'none';
      speakBtn.style.cursor = 'pointer';
      speakBtn.style.borderRadius = '50%';
      speakBtn.style.padding = '8px';
      speakBtn.style.boxShadow = '0 4px 12px rgba(102,126,234,0.4)';
      speakBtn.style.transition = 'all 0.3s ease';
      speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>';
      speakBtn.onmouseenter = () => {
        speakBtn.style.transform = 'scale(1.1)';
        speakBtn.style.boxShadow = '0 6px 20px rgba(102,126,234,0.6)';
      };
      speakBtn.onmouseleave = () => {
        speakBtn.style.transform = 'scale(1)';
        speakBtn.style.boxShadow = '0 4px 12px rgba(102,126,234,0.4)';
      };
      speakBtn.onclick = (e) => {
        e.stopPropagation();
        speakHanzi(currentCard.hanzi, speakBtn);
      };
      frontWrap.appendChild(speakBtn);
    }
    frontEl.appendChild(frontWrap);

    // Enable flipping for normal cards

    cardEl.onclick = () => {
      if(currentCard && mode==='flash'){
        flipped = !flipped;
        
        // üé≠ APLICAR O REMOVER CLASE FLIP SEG√öN ESTADO
        if(flipped) {
          cardEl.classList.add('flip');
        } else {
          cardEl.classList.remove('flip');
        }
        
        // Cambiar contenido en la mitad de la animaci√≥n (cuando est√° a 90 grados - invisible)
        setTimeout(() => {
          if(flipped) {
            // Mostrar pinyin + meaning con salto de l√≠nea y contra-rotaci√≥n para que se vea bien
            frontEl.innerHTML = `
              <div style="
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                height: 100%; 
                text-align: center;
                padding: 20px;
                transform: rotateY(180deg);
              ">
                <div style="font-size: 2.5rem; margin-bottom: 15px; font-weight: bold; color: #60a5fa;">${currentCard.pinyin}</div>
                <div style="font-size: 1.8rem; line-height: 1.4; color: #e5e7eb;">${currentCard.meaning}</div>
              </div>
            `;
          } else {
            // Restaurar contenido original llamando a renderCard para mantener formato exacto
            renderCard();
          }
        }, 150); // Mitad de la duraci√≥n de la animaci√≥n CSS (300ms/2)
      }
    };
    document.getElementById('btnFlip').disabled = false;

// Pronuncia el Hanzi - DESACTIVADO EN MODO DOCUMENTAL
async function speakHanzi(text, buttonElement = null) {
  console.log('üîá TTS desactivado en modo documental');
  // No hacer nada, TTS desactivado
  return;
}

// Fallback TTS - DESACTIVADO EN MODO DOCUMENTAL
function fallbackSpeakHanziWeb(text, buttonElement = null) {
  console.log('üîá Fallback TTS desactivado en modo documental');
  return Promise.resolve();
}

    if(mode === 'flash'){
          // En modo flash, siempre mostrar hanzi en el frente SIN reemplazar el contenedor (para no borrar el bot√≥n de parlante)
          if (hanziSpan) {
            hanziSpan.textContent = currentCard.hanzi;
            hanziSpan.className = 'text-5xl font-bold';
          } else {
            // Fallback por si cambia el flujo: asegurar contenido visible
            frontEl.innerHTML = `<span class='text-5xl font-bold'>${currentCard.hanzi}</span>`;
          }
          
          // NO mostrar badges de nivel durante el juego (solo interferir√≠an)
          
          backEl.innerHTML = `<div class="mb-2">${currentCard.pinyin}</div><div>${currentCard.meaning}</div>`;
      flashRow.classList.remove('hidden');
      quizRow.classList.add('hidden');
      
      // Agregar label de power-up si la tarjeta tiene clases especiales
      addPowerUpLabel();
    } else {
      backEl.textContent = '';
      flashRow.classList.add('hidden');
      quizRow.classList.remove('hidden');
      
      // ULTIMATE CHALLENGE: Usar setupQuizChoices siempre
      if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
        console.log('üèÜ Ultimate Challenge: Usando setupQuizChoices');
        setupQuizChoices();
      }
      // Usar setupChallengeCard para modo desaf√≠o, setupQuizChoices para el resto
      else if (currentMission === 'challenge' || currentMission === 'desafioN1') {
        if (!setupChallengeCard()) {
          setupQuizChoices(); // fallback si setupChallengeCard falla
        }
      } else {
        setupQuizChoices();
      }
    }
  }

  // Confetti effect for celebration - versi√≥n solo verde
  function showConfetti() {
    let confettiCanvas = document.getElementById('confettiCanvas');
    if (!confettiCanvas) {
      confettiCanvas = document.createElement('canvas');
      confettiCanvas.id = 'confettiCanvas';
      confettiCanvas.style.position = 'fixed';
      confettiCanvas.style.left = '0';
      confettiCanvas.style.top = '0';
      confettiCanvas.style.width = '100vw';
      confettiCanvas.style.height = '100vh';
      confettiCanvas.style.pointerEvents = 'none'; // Asegura que nunca bloquee clics
      confettiCanvas.style.zIndex = '9999';
      document.body.appendChild(confettiCanvas);
    }
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiCanvas.style.pointerEvents = 'none'; // Refuerza pointer-events

    const ctx = confettiCanvas.getContext('2d');
    const colors = ['#22c55e','#16a34a','#10b981','#34d399','#86efac','#166534'];
    const pieces = 17; // Reducido de 140 a 17 para mejor rendimiento
    const confetti = [];

    // Get card position for explosion origin
    const cardRect = cardEl.getBoundingClientRect();
    let originX = cardRect.left + cardRect.width/2;
    let originY;
    
    if (isMobile()) {
      // En m√≥vil: origen en el centro de la tarjeta para evitar cortes
      originY = cardRect.top + cardRect.height/2;
    } else {
      // En desktop: origen debajo de la tarjeta (original)
      originY = cardRect.bottom - 10;
    }

    for (let i = 0; i < pieces; i++) {
      const angle = Math.PI/2 + (Math.random()-0.5)*Math.PI/1.2; // mostly upward
      const speed = Math.random()*7+6;
      confetti.push({
        x: originX,
        y: originY,
        r: Math.random() * 8 + 4,
        c: colors[Math.floor(Math.random() * colors.length)],
        vx: Math.cos(angle)*speed,
        vy: -Math.abs(Math.sin(angle)*speed*1.5), // 50% m√°s alto
        alpha: 1,
        gravity: 0.25 + Math.random()*0.15,
        fade: 0.012 + Math.random()*0.008
      });
    }

    let frames = 0;
    function draw() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (const p of confetti) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = p.c;
        ctx.globalAlpha = p.alpha;
        ctx.fill();
        ctx.restore();

        // Movimiento: primero suben, luego caen y se desvanecen
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.gravity;
        if (frames > 30) p.alpha -= p.fade; // fade out after some frames
        if (p.alpha < 0) p.alpha = 0;
      }
      frames++;
      if (frames < 90) {
        requestAnimationFrame(draw);
      } else {
        // Eliminar canvas y asegurar pointer-events none
        confettiCanvas.style.pointerEvents = 'none';
        if (confettiCanvas.parentNode) confettiCanvas.parentNode.removeChild(confettiCanvas);
      }
    }
    draw();
}


  /* ========= QUIZ ========= */
  
  // Funci√≥n helper: Determinar n√∫mero de opciones seg√∫n el desaf√≠o activo
  function getQuizOptionsCount() {
    const challengeName = currentChallengeConfig ? currentChallengeConfig.name : null;

    // Mantener 6 opciones solo para Cruzar HSK3 / HSK4
    if (challengeName === 'Cruzar HSK3' || challengeName === 'Cruzar HSK4' ||
        currentMission === 'Cruzar HSK3' || currentMission === 'Cruzar HSK4') {
      return 6;
    }

    // Emperatriz siempre con 4 opciones
    return 4;
  }
  
  // Funci√≥n para crear casillas por primera vez despu√©s del flip (solo m√≥vil)
  function createQuizButtonsAfterFlip() {
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) {
      console.error('‚ùå createQuizButtonsAfterFlip: quizRow no encontrado');
      return;
    }
    
    // Limpiar cualquier bot√≥n existente
    quizRow.innerHTML = '';
    
    // Determinar n√∫mero de opciones din√°micamente
    const numOptions = getQuizOptionsCount();
    
    // Crear botones nuevos desde cero INVISIBLES inicialmente
    for(let i = 0; i < numOptions; i++) {
      const btn = document.createElement('button');
      btn.className = 'quizOpt py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-lg';
      btn.style.fontSize = '26px';
      btn.style.outline = 'none';
      btn.style.webkitTapHighlightColor = 'transparent';
      
      // CREAR INVISIBLES para evitar el "1 frame visible"
      btn.style.opacity = '0';
      btn.style.pointerEvents = 'auto'; // Mantener funcionalidad
      
      // Auto-blur inmediato en m√≥vil
      btn.addEventListener('touchend', function() {
        setTimeout(() => this.blur(), 5);
      });
      
      quizRow.appendChild(btn);
    }
    
    // Re-aplicar la l√≥gica de quiz despu√©s de crear
    if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
      setupQuizChoices();
    }
    
    // ACTIVAR FADE-IN en el siguiente frame del navegador
    requestAnimationFrame(() => {
      const buttons = quizRow.querySelectorAll('.quizOpt');
      buttons.forEach((btn, i) => {
        btn.classList.add('mobile-fade-in');
        btn.style.animationDelay = (i * 50) + 'ms';
        // Hacer visible con la animaci√≥n
        btn.style.opacity = '1';
      });
      
      // Limpiar animaciones despu√©s de que terminen
      setTimeout(() => {
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 600);
    });
  }

  // Detectar si estamos en m√≥vil
  function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
           ('ontouchstart' in window) || 
           (navigator.maxTouchPoints > 0);
  }

  // Funci√≥n para recrear completamente los botones de quiz en m√≥vil (elimina cualquier estado focus)
  function forceRecreateQuizButtons() {
    console.log('ÔøΩ RECREACI√ìN M√ìVIL de botones...');
    const quizRow = document.getElementById('quizRow');
    if (!quizRow) return;
    
    // Guardar altura actual para evitar movimiento de contenido
    const currentHeight = quizRow.offsetHeight;
    quizRow.style.minHeight = currentHeight + 'px';
    
    // PASO 1: DESTRUCCI√ìN COMPLETA - Eliminar todo el contenido
    quizRow.innerHTML = '';
    
    // PASO 2: RECREACI√ìN INMEDIATA 
    setTimeout(() => {
      console.log('üÜï Creando botones nuevos sin historial...');
      
      // Determinar n√∫mero de opciones din√°micamente
      const numOptions = getQuizOptionsCount();
      
      // Recrear botones completamente nuevos desde cero con animaci√≥n
      for(let i = 0; i < numOptions; i++) {
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-lg mobile-fade-in';
        btn.style.fontSize = '26px';
        btn.style.outline = 'none';
        btn.style.webkitTapHighlightColor = 'transparent';
        btn.style.animationDelay = (i * 50) + 'ms'; // Delay escalonado para cada bot√≥n
        
        // Auto-blur inmediato en m√≥vil
        btn.addEventListener('touchend', function() {
          setTimeout(() => this.blur(), 5);
        });
        
        quizRow.appendChild(btn);
      }
      
      // Re-aplicar la l√≥gica de quiz despu√©s de recrear
      if (['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(mode) && currentCard) {
        setupQuizChoices();
      }
      
      // Restaurar altura autom√°tica despu√©s de recrear
      setTimeout(() => {
        quizRow.style.minHeight = '';
        
        // Limpiar clases de animaci√≥n despu√©s de que terminen
        const buttons = quizRow.querySelectorAll('.quizOpt');
        buttons.forEach(btn => btn.classList.remove('mobile-fade-in'));
      }, 400); // 300ms de animaci√≥n + 100ms extra
      
      console.log('‚úÖ Botones m√≥vil recreados exitosamente');
    }, 30); // Muy r√°pido pero suficiente para limpiar DOM
  }
  
  
  // Funci√≥n para ajustar tama√±o de fuente seg√∫n el contenido
  function adjustQuizFontSize() {
    const quizButtons = document.querySelectorAll('#quizRow button');
    quizButtons.forEach(btn => {
      btn.style.fontSize = '26px'; // Tama√±o √∫nico para todo: hanzi, pinyin y significado
    });
  }

  function setupQuizChoices(){
    // DEBUG ULTIMATE CHALLENGE
    if (ultimateChallengeActive) {
      console.log('üéÆ setupQuizChoices - Ultimate Challenge Mode');
      console.log('- currentCard:', currentCard);
      console.log('- mode:', mode);
      console.log('- forceSpanishQuestion:', currentCard?.forceSpanishQuestion);
      console.log('- ultimateChallengeMode:', currentCard?.ultimateChallengeMode);
      

    }
    
    // Determinar n√∫mero de opciones din√°micamente DENTRO de la funci√≥n
    const numOptions = getQuizOptionsCount();
    
    // Asegurar el n√∫mero correcto de botones
    if(quizRow.children.length !== numOptions){
      quizRow.innerHTML = '';
      for(let i=0;i<numOptions;i++){
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-lg';
        btn.style.fontSize = '26px';
        
        // En m√≥vil: Solo hacer invisibles si NO es Ultimate Challenge
        // En Ultimate Challenge, las casillas siempre deben ser visibles
        if (isMobile() && !ultimateChallengeActive && !btn.classList.contains('mobile-fade-in')) {
          btn.style.opacity = '0';
          btn.style.pointerEvents = 'none';
        }
        
        quizRow.appendChild(btn);
      }
    }
    
    // Limpiar flag de respuesta
    window.isAnswering = false;
    
    const quizBtns = Array.from(quizRow.children);

    // ULTIMATE CHALLENGE: Configuraci√≥n especial
    if (ultimateChallengeActive && currentCard?.forceSpanishQuestion) {
      console.log('üèÜ ULTIMATE CHALLENGE: Configurando pregunta en espa√±ol');
      
      // MOSTRAR PREGUNTA EN ESPA√ëOL
      frontEl.innerHTML = `<div class='text-3xl sm:text-4xl font-bold flex items-center justify-center h-full text-center p-4'>${currentCard.meaning}</div>`;
      backEl.innerHTML = '';
      
      // OPCIONES: hanzi o pinyin seg√∫n el modo
      const field = currentCard.ultimateChallengeMode === 'hanzi' ? 'hanzi' : 'pinyin';
      const correct = currentCard[field];
      
      console.log(`üìù Campo de respuesta: ${field}`);
      console.log(`‚úÖ Respuesta correcta: ${correct}`);
      
      // üéØ APLICAR SISTEMA INTELIGENTE ESPEC√çFICO PARA ULTIMATE CHALLENGE
      console.log('üèÜ Ultimate Challenge: Aplicando sistema inteligente (SIEMPRE TEM√ÅTICA)');
      
      const source = ultimateChallengeCards.filter(c => c.id !== currentCard.id);
      
      // Determinar n√∫mero de distractores (el n√∫mero ya fue calculado arriba)
      // Generar opciones inteligentes con estrategia FORZADA a 'unit' (tem√°tica)
      const smartOptions = generateSmartOptionsUltimate(currentCard, source, field, true, numDistractors);
      
      // Crear opciones finales
      const options = shuffle([correct, ...smartOptions]);
      console.log('üéØ Ultimate Challenge - Opciones inteligentes generadas:', options);
      
      // Configurar botones
      quizBtns.forEach((btn, idx) => {
        btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
        btn.textContent = options[idx];
        btn.onclick = () => {
          // üçé iOS: Activar m√∫sica si no est√° reproduciendo
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS && desafioMusic && desafioMusic.paused) {
            desafioMusic.play().catch(e => console.log('üçé iOS: Error activando m√∫sica:', e));
          }
          
          // üéµ ACTIVAR EFECTOS DE SONIDO EN PRIMER TOQUE (iOS)
          try {
            ensureAudio();

          } catch (e) {
            console.log('üéµ Warning: No se pudieron activar efectos de sonido:', e);
          }
          
          handleUltimateChallengeAnswer(btn, options[idx], correct, quizBtns, options);
        };
      });
      
      // Ajustar tama√±o de fuente seg√∫n el contenido
      adjustQuizFontSize();
      
      return; // Salir aqu√≠ para Ultimate Challenge
    }

    // MODO NORMAL: Generar opciones inteligentes para todos los desaf√≠os
    
    // üéØ BOSS CHALLENGES: Usar window.challengeCards si existe (pool filtrado por nivel)
    let source;
    if (window.challengeCards && window.challengeCards.length > 0 && 
        (currentMission === 'LA EMPERATRIZ' || currentMission === 'CRUZAR EL MAR' || 
         currentMission === 'cruzarCielo' || currentMission === 'Cruzar HSK3' || 
         currentMission === 'Cruzar HSK4' || currentMission === 'bestias12' || 
         currentMission === 'LAS 12 BESTIAS')) {
      source = window.challengeCards;
      console.log(`üéØ Boss challenge: Usando pool filtrado de ${source.length} cartas`);
    } else if (currentMission === 'revise1' || currentMission === 'revise2') {
      // üîß FIX: Para modos de repaso, usar TODAS las cartas conocidas como pool de opciones
      // No solo las cartas en la cola de repaso (que pueden ser 2-3)
      source = cards.filter(c => c.known);
      console.log(`üìö Modo repaso (${currentMission}): Usando pool completo de ${source.length} cartas conocidas para opciones`);
    } else if (currentMission === 'challenge' || currentMission === 'menos' || currentMission === 'mas' || 
               currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3') {
      // Para desaf√≠os cl√°sicos, buildQueue ya retorna el pool din√°mico correcto
      const pool = buildQueue(currentMission);
      source = pool;
      console.log(`üìö Desaf√≠o ${currentMission}: Usando pool de ${source.length} cartas`);
    } else {
      // üéØ Para unidades normales, usar pool filtrado seg√∫n lo desbloqueado
      source = getPoolForCurrentMission(currentMission);
      console.log(`üìö Unidad ${currentMission}: Usando pool filtrado de ${source.length} cartas`);
    }

    const field   = (mode==='quizPinyin') ? 'pinyin' : (mode==='quizHanzi') ? 'hanzi' : 'meaning';
    const correct = currentCard[field];

    let options;
    
    // Determinar n√∫mero de distractores necesarios (opciones totales - 1 correcta)
    const numDistractors = numOptions - 1;
    
    // üéØ APLICAR SISTEMA INTELIGENTE SIEMPRE (ELIMINADO MODO ALEATORIO)
    // El sistema de opciones inteligentes filtra por n√∫mero de s√≠labas y contexto tem√°tico
    // Esto se aplica a TODOS los modos de quiz sin excepci√≥n
    
    console.log(`üß† Aplicando smart options para ${currentMission} (modo: ${mode})`);
    
    // Filtrar pool para opciones inteligentes
    const availablePool = source.filter(c => c.id !== currentCard.id);
    console.log(`üîç Pool disponible despu√©s de filtrar carta actual: ${availablePool.length} cartas`);
    
    // Generar opciones inteligentes (n√∫mero din√°mico de distractores)
    const smartOptions = generateSmartOptions(currentCard, availablePool, true, numDistractors);
    
    // Extraer los valores del campo espec√≠fico (hanzi, pinyin, o meaning)
    let smartValues = smartOptions.map(opt => opt[field]);
    
    // üîß ASEGURAR DISTRACTORES: Si no hay suficientes, completar con aleatorios
    while (smartValues.length < numDistractors && availablePool.length > smartValues.length) {
      const randomCard = availablePool[Math.floor(Math.random() * availablePool.length)];
      const randomValue = randomCard[field];
      if (randomValue !== correct && !smartValues.includes(randomValue)) {
        smartValues.push(randomValue);
      }
    }
    
    // Tomar solo el n√∫mero necesario de distractores
    smartValues = smartValues.slice(0, numDistractors);
    
    // Crear opciones finales
    options = shuffle([correct, ...smartValues]);
    
    console.log(`‚úÖ Smart options generadas: ${options.length} opciones`);

    // üëë CONFIGURAR LA PREGUNTA SEG√öN EL MODO (INCLUYE LA EMPERATRIZ)
    if (mode === 'quizPinyin') {
      // Mostrar hanzi, responder con pinyin
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
    } else if (mode === 'quizHanzi') {
      // Mostrar pinyin, responder con hanzi
      frontEl.innerHTML = `<div class='text-3xl sm:text-4xl font-bold flex items-center justify-center h-full text-center p-4'>${currentCard.pinyin}</div>`;
    } else if (mode === 'quizMeaning') {
      // Mostrar hanzi, responder con meaning
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
    }
    
    // NO mostrar badges de nivel durante los quiz (solo en modo flash)

    function setDisabledAll(flag){ quizBtns.forEach(b=>b.disabled=flag); }

    quizBtns.forEach((btn, idx) => {
      btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
      btn.textContent = options[idx];
      btn.onclick = () => {
        // üçé iOS: Activar m√∫sica si no est√° reproduciendo
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS && desafioMusic && desafioMusic.paused) {
          desafioMusic.play().catch(e => console.log('üçé iOS: Error activando m√∫sica:', e));
        }
        
        // üéµ ACTIVAR EFECTOS DE SONIDO EN PRIMER TOQUE (iOS)
        try {
          ensureAudio();

        } catch (e) {
          console.log('üéµ Warning: No se pudieron activar efectos de sonido:', e);
        }
        
        // Marcar que estamos respondiendo para que los nuevos botones aparezcan invisibles
        window.isAnswering = true;
        
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        btn.blur();
        const isCorrect = options[idx] === correct;
        setDisabledAll(true);
        
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          
          // En m√≥vil: fade-out de TODAS las casillas juntas despu√©s del glow
          if(isMobile()) {
            setTimeout(() => {
              // TODAS las casillas se desvanecen al mismo tiempo
              quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
            }, 800); // Despu√©s de que el glow tenga tiempo de verse
          }
          
          setTimeout(()=>{
            setDisabledAll(false);
            window.isAnswering = false; // Reset para permitir teclado nuevamente

          }, 450);
        } else {
          btn.classList.add('optWrong');
          quizBtns.forEach((b, i) => {
            if(options[i] === correct) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            quizBtns.forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
            
            // En m√≥vil: fade-out de TODAS las casillas juntas
            if(isMobile()) {
              setTimeout(() => {
                // TODAS las casillas se desvanecen al mismo tiempo
                quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
              }, 900); // Despu√©s de las animaciones de correcto/incorrecto
            }
          }, 1000);
          
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            window.isAnswering = false; // Reset para permitir teclado nuevamente

            answer(false);
          }, 2000);
        }
      };
    });
    
    // Ajustar tama√±o de fuente seg√∫n el contenido
    adjustQuizFontSize();
    
    // üéπ CONTROLES DE TECLADO PARA DESKTOP (NO en Ultimate Challenge)
    if (!isMobile() && !ultimateChallengeActive) {
      // Peque√±o delay para asegurar que los botones est√©n completamente configurados
      setTimeout(() => {
        setupKeyboardControls(quizBtns, options, correct, setDisabledAll);
      }, 50);
    }
  }

  // üéπ Sistema de controles de teclado para desktop
  function setupKeyboardControls(quizBtns, options, correct, setDisabledAll) {
    // Limpiar listeners anteriores
    document.removeEventListener('keydown', window.quizKeyboardHandler);
    
    // Mostrar indicador de teclado
    const keyboardHint = document.getElementById('keyboardHint');
    if (keyboardHint) {
      keyboardHint.classList.remove('hidden');
    }
    

    
    // Crear nuevo handler
    window.quizKeyboardHandler = function(e) {
      // DEBUG: Verificar estado actual
      console.log('üéπ DEBUG: Tecla presionada, modo actual:', mode, 'quizBtns length:', quizBtns.length, 'isAnswering:', window.isAnswering);
      
      // Verificaci√≥n mejorada: Si hay 4 botones con contenido (sin importar si est√°n disabled temporalmente)
      const buttonsWithContent = quizBtns.filter(btn => btn && btn.textContent.trim() !== '');
      console.log('üéπ DEBUG: Botones con contenido:', buttonsWithContent.length);
      console.log('üéπ DEBUG: Estados de botones:', quizBtns.map((btn, i) => `${i+1}: disabled=${btn.disabled}, text="${btn.textContent}"`));
      
      // Solo funcionar si tenemos botones con contenido O si estamos en modo quiz expl√≠cito
      const isQuizMode = ['quizMeaning', 'quizPinyin', 'quizHanzi'].includes(mode) || buttonsWithContent.length === 4;
      if (!isQuizMode) {
        console.log('üéπ DEBUG: No es modo quiz v√°lido. Modo:', mode, 'Botones con contenido:', buttonsWithContent.length);
        return;
      }
      if (quizBtns.length !== 4) {
        console.log('üéπ DEBUG: No hay 4 botones quiz:', quizBtns.length);
        return;
      }
      if (window.isAnswering) {
        console.log('üéπ DEBUG: Bloqueado por isAnswering');
        return;
      }
      
      // Verificaci√≥n adicional: asegurar que los botones existen y est√°n visibles
      const quizRow = document.getElementById('quizRow');
      if (!quizRow || quizRow.classList.contains('hidden')) {
        console.log('üéπ DEBUG: quizRow no visible');
        return;
      }
      
      let buttonIndex = -1;
      
      // Mapear teclas a posiciones:
      // 1 = arriba izquierda (0)  2 = arriba derecha (1)
      // 3 = abajo izquierda (2)   4 = abajo derecha (3)
      switch(e.code) {
        case 'Digit1':
        case 'Numpad1':
          buttonIndex = 0; // Arriba izquierda
          break;
        case 'Digit2':
        case 'Numpad2':
          buttonIndex = 1; // Arriba derecha
          break;
        case 'Digit3':
        case 'Numpad3':
          buttonIndex = 2; // Abajo izquierda
          break;
        case 'Digit4':
        case 'Numpad4':
          buttonIndex = 3; // Abajo derecha
          break;
        default:
          return; // Ignorar otras teclas
      }
      
      // Prevenir comportamiento por defecto
      e.preventDefault();
      
      // Ejecutar la misma l√≥gica que el onclick original
      const button = quizBtns[buttonIndex];
      console.log(`üéπ DEBUG: Intentando activar bot√≥n ${buttonIndex + 1}:`, !!button, 'disabled:', button?.disabled, 'text:', button?.textContent);
      
      if (button && button.textContent.trim() !== '' && options && correct) {
        const selectedOption = options[buttonIndex];
        const isCorrect = selectedOption === correct;
        
        console.log(`üéπ ‚úÖ Evaluando respuesta del bot√≥n ${buttonIndex + 1}:`);
        console.log(`   - Opci√≥n seleccionada: "${selectedOption}"`);
        console.log(`   - Respuesta correcta: "${correct}"`);
        console.log(`   - Es correcta: ${isCorrect}`);
        
        // Marcar que estamos respondiendo
        window.isAnswering = true;
        
        // Efecto visual de "pressed"
        button.style.transform = 'scale(0.95)';
        button.style.backgroundColor = '#374151';
        
        // Deshabilitar todos los botones
        setDisabledAll(true);
        
        // Aplicar la misma l√≥gica que el onclick original
        setTimeout(() => {
          button.style.transform = '';
          button.style.backgroundColor = '';
          
          if(isCorrect){
            button.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out de TODAS las casillas juntas despu√©s del glow
            if(isMobile()) {
              setTimeout(() => {
                quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
              }, 800);
            }
            
            setTimeout(()=>{
              setDisabledAll(false);
              window.isAnswering = false;

            }, 450);
          } else {
            button.classList.add('optWrong');
            quizBtns.forEach((b, i) => {
              if(options[i] === correct) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              quizBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              if(isMobile()) {
                setTimeout(() => {
                  quizBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
                }, 900);
              }
            }, 1000);
            
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              window.isAnswering = false;

              answer(false);
            }, 2000);
          }
        }, 100);
        
        console.log(`üéπ Tecla ${e.code} presionada - Procesando respuesta del bot√≥n ${buttonIndex + 1}`);
      } else {
        console.log('üéπ ‚ùå Bot√≥n no disponible o faltan datos del quiz');
      }
    };
    
    // Agregar listener
    document.addEventListener('keydown', window.quizKeyboardHandler);

  }

  // Actualizar contador de Ultimate Challenge
  function updateUltimateChallengeCounter() {
    console.log('üîç DEBUG updateUltimateChallengeCounter() llamada');
    console.log('- ultimateChallengeActive:', ultimateChallengeActive);
    console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
    console.log('- ultimateChallengeAnimalIndex:', ultimateChallengeAnimalIndex);
    
    if (ultimateChallengeActive) {
      // ACTUALIZAR "FALTAN" - elemento statInSession
      const statInSession = document.getElementById('statInSession');
      console.log('üì¶ Elemento statInSession encontrado:', !!statInSession);
      
      if (statInSession) {
        console.log('üì¶ statInSession.textContent ANTES:', statInSession.textContent);
        const remaining = 60 - ultimateChallengeCardIndex;
        console.log('üßÆ C√°lculo: 60 - ' + ultimateChallengeCardIndex + ' = ' + remaining);
        
        statInSession.textContent = remaining;
        console.log('ÔøΩ statInSession.textContent DESPU√âS:', statInSession.textContent);
        console.log('üéØ VALOR MOSTRADO EN CAJA "FALTAN":', statInSession.textContent);
      } else {
        console.error('‚ùå No se encontr√≥ elemento statInSession');
      }
      
      // ACTUALIZAR "MODO ACTUAL" - solo nombre del animal
      const statMission = document.getElementById('statMission');
      if (statMission) {
        const currentAnimalData = ultimateChallengeOrder[ultimateChallengeAnimalIndex];
        const animalName = currentAnimalData?.animal || 'Desconocido';
        statMission.textContent = `üèÜ ${animalName}`;
        statMission.style.color = '#f2e5b1';
        statMission.style.fontWeight = 'bold';
        console.log(`üêæ Animal actual: ${animalName}`);
      }
      
      console.log('‚úÖ Contador Ultimate Challenge actualizado');
    }
  }

  // Manejar respuesta en Ultimate Challenge
  function handleUltimateChallengeAnswer(btn, selectedValue, correct, allBtns, allOptions) {
    console.log('üéØ Ultimate Challenge - Respuesta seleccionada:', selectedValue);
    console.log('‚úÖ Respuesta correcta:', correct);
    
    window.isAnswering = true;
    btn.blur();
    
    const isCorrect = selectedValue === correct;
    allBtns.forEach(b => b.disabled = true);
    
    if(isCorrect){
      console.log('üéâ ¬°CORRECTO!');
      btn.classList.add('optCorrect');
      respond(true);
      
      if(isMobile()) {
        setTimeout(() => {
          allBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
        }, 800);
      }
      
      setTimeout(() => {
        allBtns.forEach(b => b.disabled = false);
        // INCREMENTAR √çNDICE DESPU√âS DE RESPUESTA CORRECTA
        if (ultimateChallengeActive) {
          ultimateChallengeCardIndex++;
          console.log('üî¢ √çndice incrementado (correcto) a:', ultimateChallengeCardIndex);
          
          // DEBUG INMEDIATO: Verificar valor despu√©s de incrementar
          const statInSession = document.getElementById('statInSession');
          if (statInSession) {
            console.log('üì¶ VALOR INMEDIATO en statInSession despu√©s de incrementar:', statInSession.textContent);
          }
        }
        // Avanzar a la siguiente carta
        nextCard();
      }, 1200);
    } else {
      console.log('‚ùå Incorrecto');
      btn.classList.add('optWrong');
      allBtns.forEach((b, i) => {
        if(allOptions[i] === correct) b.classList.add('optCorrect');
      });
      
      cardEl.classList.add('cardWrong','shakeAnim');
      soundWrong();
      
      setTimeout(() => {
        cardEl.classList.add('cardWrongFade');
        allBtns.forEach(b => {
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
        
        if(isMobile()) {
          setTimeout(() => {
            allBtns.forEach(b => b.classList.add('quiz-fade-out-delayed'));
          }, 900);
        }
      }, 1000);
      
      setTimeout(() => {
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
        // INCREMENTAR √çNDICE DESPU√âS DE RESPUESTA INCORRECTA
        if (ultimateChallengeActive) {
          ultimateChallengeCardIndex++;
          console.log('üî¢ √çndice incrementado (incorrecto) a:', ultimateChallengeCardIndex);
          
          // DEBUG INMEDIATO: Verificar valor despu√©s de incrementar
          const statInSession = document.getElementById('statInSession');
          if (statInSession) {
            console.log('üì¶ VALOR INMEDIATO en statInSession despu√©s de incrementar:', statInSession.textContent);
          }
        }
        // Avanzar a la siguiente carta
        nextCard();
      }, 2500);
    }
  }

  // --- Quiz Hanzi ---
const btnQuizMeaning = document.getElementById('btnQuizMeaning');
if(btnQuizMeaning) {
  let btnQuizHanzi = document.getElementById('btnQuizHanzi');
  if(!btnQuizHanzi) {
    btnQuizHanzi = document.createElement('button');
    btnQuizHanzi.id = 'btnQuizHanzi';
    btnQuizHanzi.className = 'px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 ml-2';
    btnQuizHanzi.textContent = 'Quiz Hanzi';
    btnQuizMeaning.parentNode.insertBefore(btnQuizHanzi, btnQuizMeaning.nextSibling);
  }
  btnQuizHanzi.onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizHanzi');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset adicional para Android - asegurar que la barra quede arriba
        setTimeout(() => {
          const rect = xpElement.getBoundingClientRect();
          const offset = rect.top - 10; // 10px de margen superior
          if (offset !== 0) {
            window.scrollBy({ top: offset, behavior: 'smooth' });
          }
        }, 400);
      }
    }, 100);
  };
}

// --- L√≥gica para modo quizHanzi ---
const oldSetupQuizChoices = window.setupQuizChoices;
window.setupQuizChoices = function() {
  if(mode === 'quizHanzi' && currentCard) {
    // Mostrar pinyin o significado aleatorio en la tarjeta
    const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
    frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
    backEl.innerHTML = '';

    // üéØ OPCIONES INTELIGENTES: 1 correcta + N inteligentes basadas en s√≠labas
    console.log(`üéÆ QUIZ HANZI - Generando opciones inteligentes`);
    
    // Determinar n√∫mero de opciones din√°micamente
    const numOptions = getQuizOptionsCount();
    const numDistractors = numOptions - 1;
    
    console.log(`üìä QUIZ HANZI - Opciones totales: ${numOptions}, Distractores: ${numDistractors}`);
    
    // üéØ Determinar pool disponible seg√∫n el contexto (boss challenges o din√°mico)
    let poolSource;
    if (window.challengeCards && window.challengeCards.length > 0 && 
        (currentMission === 'LA EMPERATRIZ' || currentMission === 'CRUZAR EL MAR' || 
         currentMission === 'cruzarCielo' || currentMission === 'Cruzar HSK3' || 
         currentMission === 'Cruzar HSK4' || currentMission === 'bestias12' || 
         currentMission === 'LAS 12 BESTIAS')) {
      poolSource = window.challengeCards;
      console.log(`üéØ quizHanzi (Boss): Pool filtrado de ${poolSource.length} cartas`);
    } else if (currentMission && (currentMission === 'challenge' || currentMission === 'menos' || currentMission === 'mas' || 
               currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3')) {
      const dynamicPool = buildQueue(currentMission);
      poolSource = dynamicPool;
      console.log(`üìö quizHanzi (Challenge ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
    } else if (currentMission && (currentMission === 'known' || currentMission === 'revise1' || currentMission === 'revise2')) {
      // üéØ Para modos de pr√°ctica, usar pool din√°mico basado en desbloqueos
      const dynamicPool = getDynamicChallengePool('challenge');
      poolSource = dynamicPool;
      console.log(`üìö quizHanzi (Pr√°ctica ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
    } else {
      // üéØ Para unidades normales, filtrar seg√∫n lo desbloqueado
      poolSource = getPoolForCurrentMission(currentMission);
      console.log(`üé¥ quizHanzi (Unidad ${currentMission}): Pool filtrado de ${poolSource.length} cartas`);
    }
    
    let availablePool = poolSource.filter(c => c.hanzi !== currentCard.hanzi);
    
    // Generar opciones inteligentes CON EL N√öMERO CORRECTO
    const smartOptions = generateSmartOptions(currentCard, availablePool, true, numDistractors);
    
    // Crear array final con respuestas correctas + opciones inteligentes
    let hanziOptions = [
      currentCard.hanzi,
      ...smartOptions.map(opt => opt.hanzi)
    ];
    
    // Mezclar todas las opciones
    hanziOptions = shuffle(hanziOptions);
    
    console.log(`üéØ Quiz Hanzi - Opciones finales:`, hanziOptions);

    quizRow.innerHTML = '';
    // Helper para deshabilitar todos los botones hanzi
    function setDisabledAll(flag) {
      Array.from(quizRow.children).forEach(b => b.disabled = flag);
    }
    hanziOptions.forEach(hz => {
      const btn = document.createElement('button');
      btn.className = 'py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
      btn.style.fontSize = '26px';
      btn.textContent = hz;
      btn.disabled = false;
      btn.onclick = function() {
        // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
        this.blur();
        setDisabledAll(true);
        const isCorrect = hz === currentCard.hanzi;
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          // Marcar la opci√≥n correcta
          Array.from(quizRow.children).forEach((b, i) => {
            if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            Array.from(quizRow.children).forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
          }, 1000);
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
            setDisabledAll(false);
            answer(false);
          }, 2000);
        }
      };
      quizRow.appendChild(btn);
    });
    
    // Los botones hanzi ya tienen el tama√±o correcto (23px) hardcodeado
    
    // Configurar controles de teclado para desktop
    if (!isMobile()) {
      const quizBtns = Array.from(quizRow.children);
      setTimeout(() => {
        setupKeyboardControls(quizBtns, hanziOptions, currentCard.hanzi, setDisabledAll);
      }, 50);
      console.log('üéπ quizHanzi - Configurando teclado:', hanziOptions, 'Correcto:', currentCard.hanzi);
    }
    
    quizRow.classList.remove('hidden');
    flashRow.classList.add('hidden');
    return;
  } else {
    // Restaurar fuente original para quizRow y sus hijos
    quizRow.classList.remove('text-3xl','font-bold');
    Array.from(quizRow.children).forEach(btn => {
      btn.classList.remove('text-3xl','font-bold');
    });
    // Restaurar tarjeta frontal
    if(currentCard && (mode === 'quizPinyin' || mode === 'quizMeaning')) {
      frontEl.innerHTML = `<span class='text-5xl font-bold'>${currentCard.hanzi}</span>`;
    }
  }
  if(typeof oldSetupQuizChoices === 'function') oldSetupQuizChoices();
}

// --- Desaf√≠os ---
function setupChallengeCard() {
  if(currentMission === 'challenge' || currentMission === 'desafioN1') {
    // Elegir aleatoriamente el tipo de pregunta
    // 50%: muestra hanzi y opciones pinyin/meaning
    // 50%: muestra pinyin o meaning y opciones hanzi (quiz hanzi style)
    const hanziQuiz = Math.random() < 0.5;
    if(hanziQuiz) {
      // Quiz hanzi: muestra pinyin o significado, opciones hanzi
      const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
      backEl.innerHTML = '';
      
      // Usar sistema inteligente de opciones
      let hanziOptions;
      if (typeof generateSmartOptions === 'function') {
        // Determinar n√∫mero de opciones din√°micamente
        const numOptions = getQuizOptionsCount();
        const numDistractors = numOptions - 1;
        
        // üéØ Determinar pool seg√∫n el contexto (boss challenges o din√°mico)
        let poolSource;
        if (window.challengeCards && window.challengeCards.length > 0 && 
            (currentMission === 'LA EMPERATRIZ' || currentMission === 'CRUZAR EL MAR' || 
             currentMission === 'cruzarCielo' || currentMission === 'Cruzar HSK3' || 
             currentMission === 'Cruzar HSK4' || currentMission === 'bestias12' || 
             currentMission === 'LAS 12 BESTIAS')) {
          poolSource = window.challengeCards;
          console.log(`üéØ hanziQuiz (Boss): Pool filtrado de ${poolSource.length} cartas`);
        } else if (currentMission && (currentMission === 'challenge' || currentMission === 'menos' || currentMission === 'mas' || 
                   currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3')) {
          const dynamicPool = buildQueue(currentMission);
          poolSource = dynamicPool;
          console.log(`üìö hanziQuiz (Challenge ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
        } else if (currentMission && (currentMission === 'known' || currentMission === 'revise1' || currentMission === 'revise2')) {
          // üéØ Para modos de pr√°ctica, usar pool din√°mico basado en desbloqueos
          const dynamicPool = getDynamicChallengePool('challenge');
          poolSource = dynamicPool;
          console.log(`üìö hanziQuiz (Pr√°ctica ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
        } else {
          poolSource = cards;
          console.log(`üé¥ hanziQuiz (Otros): Pool completo de ${poolSource.length} cartas`);
        }
        
        const smartOptions = generateSmartOptions(currentCard, poolSource.filter(c => c.hanzi !== currentCard.hanzi), true, numDistractors);
        hanziOptions = [currentCard.hanzi, ...smartOptions.map(opt => opt.hanzi)];
        hanziOptions = shuffle(hanziOptions);
        console.log(`üß† Challenge (hanziQuiz) - Usando opciones inteligentes (${numOptions} opciones):`, hanziOptions);
      } else {
        // Fallback al sistema legacy si no existe la funci√≥n inteligente
        hanziOptions = [currentCard.hanzi];
        let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
        while(hanziOptions.length < 4 && pool.length > 0) {
          const idx = Math.floor(Math.random() * pool.length);
          hanziOptions.push(pool[idx].hanzi);
          pool.splice(idx,1);
        }
        hanziOptions = shuffle(hanziOptions);
        console.log('‚ö° Challenge (hanziQuiz) - Usando opciones legacy:', hanziOptions);
      }
      quizRow.innerHTML = '';
      hanziOptions.forEach((hz, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.style.fontSize = '26px';
        btn.textContent = hz;
        btn.disabled = false;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        btn.onclick = function() {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          this.blur();
          Array.from(quizRow.children).forEach(b => b.disabled = true);
          const isCorrect = hz === currentCard.hanzi;
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                const challengeBtns = Array.from(quizRow.children);
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            Array.from(quizRow.children).forEach((b, i) => {
              if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              Array.from(quizRow.children).forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  const challengeBtns = Array.from(quizRow.children);
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              Array.from(quizRow.children).forEach(b=>b.disabled=false);
              answer(false);
            }, 2000);
          }
        };
        quizRow.appendChild(btn);
      });
      
      // Los botones hanzi ya tienen el tama√±o correcto (23px) hardcodeado
      
      // Configurar controles de teclado para desktop (hanziQuiz)
      if (!isMobile()) {
        const challengeBtns = Array.from(quizRow.children);
        function setDisabledAll(flag) { challengeBtns.forEach(b => b.disabled = flag); }
        setTimeout(() => {
          setupKeyboardControls(challengeBtns, hanziOptions, currentCard.hanzi, setDisabledAll);
        }, 50);
        console.log('üéπ Challenge (hanziQuiz) - Configurando teclado:', hanziOptions, 'Correcto:', currentCard.hanzi);
      }
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones hanzi
      if (isMobile()) {
        requestAnimationFrame(() => {
          const challengeBtns = Array.from(quizRow.children);
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    } else {
      // Modo cl√°sico: muestra hanzi y opciones pinyin/meaning
      const types = ['pinyin','meaning'];
      const optionsType = types[Math.floor(Math.random()*types.length)];
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
      backEl.innerHTML = '';
      let correct = currentCard[optionsType];
      
      // üéØ OPCIONES INTELIGENTES: Aplicar sistema de s√≠labas para quiz cl√°sico
      console.log(`üéÆ QUIZ CL√ÅSICO (${optionsType}) - Generando opciones inteligentes`);
      
      // Determinar n√∫mero de opciones din√°micamente
      const numOptions = getQuizOptionsCount();
      const numDistractors = numOptions - 1;
      
      // üéØ Determinar pool disponible seg√∫n el contexto (boss challenges o din√°mico)
      let poolSource;
      if (window.challengeCards && window.challengeCards.length > 0 && 
          (currentMission === 'LA EMPERATRIZ' || currentMission === 'CRUZAR EL MAR' || 
           currentMission === 'cruzarCielo' || currentMission === 'Cruzar HSK3' || 
           currentMission === 'Cruzar HSK4' || currentMission === 'bestias12' || 
           currentMission === 'LAS 12 BESTIAS')) {
        poolSource = window.challengeCards;
        console.log(`üéØ Quiz Cl√°sico (Boss): Pool filtrado de ${poolSource.length} cartas`);
      } else if (currentMission && (currentMission === 'challenge' || currentMission === 'menos' || currentMission === 'mas' || 
                 currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3')) {
        const dynamicPool = buildQueue(currentMission);
        poolSource = dynamicPool;
        console.log(`üìö Quiz Cl√°sico (Challenge ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
      } else if (currentMission && (currentMission === 'known' || currentMission === 'revise1' || currentMission === 'revise2')) {
        // üéØ Para modos de pr√°ctica, usar pool din√°mico basado en desbloqueos
        const dynamicPool = getDynamicChallengePool('challenge'); // Usa misma l√≥gica que challenge
        poolSource = dynamicPool;
        console.log(`üìö Quiz Cl√°sico (Pr√°ctica ${currentMission}): Pool din√°mico de ${poolSource.length} cartas`);
      } else {
        poolSource = cards;
        console.log(`üé¥ Quiz Cl√°sico (Otros): Pool completo de ${poolSource.length} cartas`);
      }
      
      let availablePool = poolSource.filter(c => c[optionsType] !== correct);
      
      // Generar opciones inteligentes basadas en la respuesta correcta CON EL N√öMERO CORRECTO
      const smartOptions = generateSmartOptions(currentCard, availablePool, true, numDistractors);
      
      // Crear array final con respuesta correcta + opciones inteligentes
      let options = [
        correct,
        ...smartOptions.map(opt => opt[optionsType])
      ].filter(opt => opt); // Filtrar opciones undefined/null
      
      // Si no tenemos suficientes opciones, completar con aleatorias
      if (options.length < numOptions) {
        const remainingPool = availablePool.filter(c => 
          !options.includes(c[optionsType])
        );
        while(options.length < numOptions && remainingPool.length > 0) {
          const idx = Math.floor(Math.random() * remainingPool.length);
          options.push(remainingPool[idx][optionsType]);
          remainingPool.splice(idx, 1);
        }
      }
      
      options = shuffle(options);
      
      console.log(`üéØ Quiz Cl√°sico (${optionsType}) - Opciones finales:`, options);
      quizRow.innerHTML = '';
      options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.style.fontSize = '26px';
        btn.textContent = opt;
        
        // En m√≥vil: aplicar animaciones de desaf√≠o  
        if (isMobile()) {
          btn.style.opacity = '0'; // Empezar invisible
        }
        
        quizRow.appendChild(btn);
      });
      const challengeBtns = Array.from(quizRow.children);
      function setDisabledAll(flag){ challengeBtns.forEach(b=>b.disabled=flag); }
      challengeBtns.forEach((btn, idx) => {
        btn.onclick = () => {
          // Marcar que estamos respondiendo para animaciones m√≥viles
          window.isAnswering = true;
          
          // QUITAR FOCUS INMEDIATAMENTE PARA EVITAR ESTADO "CLARITO" EN M√ìVIL
          btn.blur();
          const isCorrect = btn.textContent === currentCard[optionsType];
          setDisabledAll(true);
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            
            // En m√≥vil: fade-out sincronizado para desaf√≠o - todas juntas
            if(isMobile()) {
              // TODAS las casillas se van al mismo tiempo con delay
              setTimeout(() => {
                challengeBtns.forEach(b => {
                  b.classList.add('quiz-fade-out-delayed');
                });
              }, 800); // Despu√©s del glow verde
            }
            
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            challengeBtns.forEach((b, i) => {
              if(b.textContent === currentCard[optionsType]) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              challengeBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
              
              // En m√≥vil: fade-out sincronizado para respuesta incorrecta en desaf√≠o
              if(isMobile()) {
                // TODAS las casillas se van al mismo tiempo con delay
                setTimeout(() => {
                  challengeBtns.forEach(b => {
                    b.classList.add('quiz-fade-out-delayed');
                  });
                }, 900); // Despu√©s de las animaciones de correcto/incorrecto
              }
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              challengeBtns.forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              // Avanzar a la siguiente tarjeta
              nextCard();
            }, 2000);
          }
        };
      });
      
      // Los botones de opciones cl√°sicas ya tienen 20px (correcto para pinyin/meaning)
      
      // Configurar controles de teclado para desktop (modo cl√°sico)
      if (!isMobile()) {
        setTimeout(() => {
          setupKeyboardControls(challengeBtns, options, correct, setDisabledAll);
        }, 50);
        console.log('üéπ Challenge (cl√°sico) - Configurando teclado:', options, 'Correcto:', correct);
      }
      
      // Activar fade-in en m√≥vil despu√©s de crear todos los botones del modo cl√°sico
      if (isMobile()) {
        requestAnimationFrame(() => {
          challengeBtns.forEach((btn, i) => {
            btn.classList.add('mobile-fade-in');
            btn.style.animationDelay = (i * 50) + 'ms';
            btn.style.opacity = '1';
          });
          // Limpiar animaciones despu√©s
          setTimeout(() => {
            challengeBtns.forEach(btn => btn.classList.remove('mobile-fade-in'));
          }, 600);
        });
      }
      
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    }
  }
  
  // Agregar label de power-up si la tarjeta tiene clases especiales
  addPowerUpLabel();
  
  return false;
}
  /* ========= Modo/UI ========= */
  function setMode(newMode){
    // En Desaf√≠o, no permitimos modo Flash
    if(currentMission==='challenge' && newMode==='flash'){
      mode = 'quizMeaning';
    } else {
      mode = newMode;
    }
    
    // Pool de audio correctos ya no se requiere (usa sonido sint√©tico)
    
    if(mode!=='flash'){ flipped=false; cardEl.classList.remove('flip'); }
    
    // üéì Detectar si estamos en modos pr√°ctica (conocidas, repasar, confirmar) con modo quiz
    const isPracticeMode = ['known', 'revise1', 'revise2'].includes(currentMission);
    const isQuizMode = ['quizPinyin', 'quizMeaning', 'quizHanzi'].includes(newMode);
    
    // Activar asistencia infinita si estamos en pr√°ctica + quiz
    if (isPracticeMode && isQuizMode) {
      enablePracticeAssistance();
    } else {
      // Desactivar asistencia de pr√°ctica si cambiamos de modo
      if (practiceAssistanceEnabled) {
        disablePracticeAssistance();
      }
    }
    
    // NO llamar renderCard() en Ultimate Challenge porque usa su propio renderizado
    if(currentCard && !ultimateChallengeActive) {
      renderCard();
    }
    
    updateStats();
    updateGameInstructions(); // Actualizar instrucciones seg√∫n el modo
  }

  // Funci√≥n para actualizar las instrucciones del juego seg√∫n el modo
  function updateGameInstructions(){
    const instructionsEl = document.getElementById('gameInstructions');
    if(!instructionsEl) return;
    
    if(currentMission === 'challenge' || currentMission === 'desafioN1'){
      // Modo desaf√≠o
      instructionsEl.innerHTML = `<span class="text-yellow-400">Tarjeta Dorada:</span> + 2 niv al caracter, <span class="text-purple-400">Tarjeta Violeta:</span> + 5 niv al caracter, <span class="text-red-400">Tarjeta Roja:</span> si te equivocas pierdes un caracter extra al azar (con todo su nivel).`;
    } else if(mode === 'flash'){
      // Modo flashcards - personalizar seg√∫n tipo de misi√≥n
      
      // Modos donde S√ç pierdes caracter si te equivocas (unidades de todos los niveles + todoN1/N2/N3)
      const dangerousModes = [
        'todoN1', 'todoN2', 'todoN3',
        'unit1', 'unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9', // N1
        'unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2', // N2
        'unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3' // N3
      ];
      
      // Modos donde NO pierdes caracter si te equivocas
      const safeModes = ['known', 'revise1', 'revise2'];
      
      if(dangerousModes.includes(currentMission)){
        // Modos donde pierdes caracter si te equivocas
        instructionsEl.innerHTML = `<span class="text-red-400">Recuerda:</span> si aciertas o pones "La conozco" se agregar√° a tu colecci√≥n <span class="text-red-400">pero si te equivocas</span> perder√°s el caracter de la colecci√≥n (si ya la tienes) junto a sus niveles.`;
      } else if(safeModes.includes(currentMission)){
        // Modos donde NO pierdes caracter
        instructionsEl.innerHTML = `<span class="text-green-400">Recuerda:</span> en este modo si te equivocas no perder√°s el caracter de tu colecci√≥n. Aparecer√° en "Repasar" y "Confirmar" pero no lo perder√°s. Sumas XP si aciertas en modo Quiz`;
      } else {
        // Otros modos flashcards (instrucciones por defecto)
        instructionsEl.textContent = 'Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la s√©, Espacio = Voltear, Derecha = La sab√≠a.';
      }
    } else {
      // Modo quiz (quizPinyin, quizMeaning, quizHanzi) - Sin texto
      instructionsEl.textContent = '';
    }
  }

  // --- L√≥gica de racha diaria por d√≠a GMT-6 ---
  function getLocalDate(ts) {
    const date = new Date(ts);
    date.setHours(date.getHours() - 6);
    return date.toISOString().slice(0, 10);
  }
  function getRachaStatus(lastChallengeAt) {
    const now = Date.now();
    const today = getLocalDate(now);
    const lastDay = getLocalDate(lastChallengeAt);
    
    if (today === lastDay) {
      // Ya hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 del pr√≥ximo d√≠a
      const nextMidnight = new Date(now);
      nextMidnight.setUTCHours(6, 0, 0, 0); // 00:00 GMT-6 = 06:00 UTC
      if (now >= nextMidnight.getTime()) {
        nextMidnight.setUTCDate(nextMidnight.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((nextMidnight.getTime() - now) / 3600000);
      return { status: 'yaHizo', horasRestantes: Math.min(24, horasRestantes) };
    } else {
      // No hizo el desaf√≠o hoy
      // Calcula horas hasta las 00:00 GMT-6 (fin del d√≠a actual)
      const endOfDay = new Date(now);
      endOfDay.setUTCHours(6, 0, 0, 0); // Pr√≥ximas 00:00 GMT-6
      if (now >= endOfDay.getTime()) {
        endOfDay.setUTCDate(endOfDay.getUTCDate() + 1);
      }
      const horasRestantes = Math.ceil((endOfDay.getTime() - now) / 3600000);
      return { status: 'puedeHacer', horasRestantes: Math.min(24, horasRestantes) };
    }
  }
  function updateStreakBox() {
    if (!streakBox || !streakCount || !streakStatus) return;
    streakCount.textContent = streak || 0;
    // Tomar el √∫ltimo desaf√≠o exitoso
    const lastTs = lastChallengeAt || 0;
    const racha = getRachaStatus(lastTs);
    let horas = racha.horasRestantes;
    streakStatus.style.color = '#fff';
    if (racha.status === 'yaHizo') {
      streakStatus.textContent = `Ya sumaste hoy. Espera ${horas} hs.`;
    } else {
      streakStatus.textContent = `Tienes ${horas} hs para no perder la racha.`;
    }
    // Si quedan menos de 5 horas, fondo naranja de aviso
    if (racha.status === 'puedeHacer' && horas <= 5) {
      streakBox.style.background = '#f54242'; // naranja
      streakStatus.style.color = '#fff';
    } else {
      streakBox.style.background = '';
    }
  }
  // Mostrar mensaje al tocar el box
  if (streakBox) {
    // En demo/documental no mostramos overlays con Lili.
    streakBox.onclick = null;
  }

  // Funci√≥n helper para obtener texto de desaf√≠os de hor√≥scopo
  function getHoroscopeDisplayText(mission) {
    console.log('üêæ getHoroscopeDisplayText llamada para:', mission);
    
    // Extraer categor√≠a del nombre de la misi√≥n (ej: 'desafioColores' -> 'colores')
    const categoria = mission.replace('desafio', '').toLowerCase();
    console.log('üêæ Categor√≠a extra√≠da:', categoria);
    
    const animalData = horoscopeAnimals[categoria];
    const categoryNames = {
      'colores': 'Colores',
      'fruta': 'Frutas', 
      'verduras': 'Verduras',
      'comidas': 'Comidas',
      'animales': 'Animales',
      'deportes': 'Deportes',
      'hobbies': 'Hobbies',
      'ropa': 'Ropa',
      'casa': 'Casa',
      'cuerpo': 'Cuerpo',
      'profesiones': 'Profesiones',
      'emociones': 'Emociones'
    };
    
    if (animalData && categoryNames[categoria]) {
      const displayText = `${animalData.chinese} ${animalData.name} - ${categoryNames[categoria]}`;
      console.log('üêæ Texto generado para hor√≥scopo:', displayText);
      return displayText;
    }
    
    console.log('üêæ No se encontraron datos, retornando texto por defecto');
    return 'Desaf√≠o Hor√≥scopo';
  }

  function updateStats(){


    
    // DEBUG CR√çTICO: Verificar si updateStats() est√° sobrescribiendo statInSession
    const statInSession = document.getElementById('statInSession');
    if (statInSession) {

    }
    
    if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
      console.log('‚ö†Ô∏è SALTANDO actualizaci√≥n de statInSession - Ultimate Challenge activo');
      // NO tocar statInSession en Ultimate Challenge
    } else {
      const newValue = sessionQueue.length + (currentCard ? 1 : 0);

      statInSession.textContent = newValue;
    }
    
    statToday.textContent = todayReviewed;
    
    // NO sobrescribir statMission si estamos en Ultimate Challenge o desaf√≠os tipo boss
    // (lo maneja updateUltimateChallengeCounter o startBossChallenge)
    if (ultimateChallengeActive && currentMission === 'ultimateChallenge') {
      console.log('‚ö†Ô∏è updateStats() saltando statMission - Ultimate Challenge activo');
      // Solo actualizar los otros stats, no statMission
    } else if (emperatrizActive && (currentMission === 'LA EMPERATRIZ' || currentMission === 'Cruzar HSK3' || currentMission === 'Cruzar HSK4' || currentMission === 'CRUZAR EL MAR' || currentMission === 'cruzarCielo')) {
      console.log('‚ö†Ô∏è updateStats() saltando statMission - Desaf√≠o tipo boss activo:', currentMission);
      // No sobrescribir statMission, lo maneja startBossChallenge
    } else if (bestias12Active && (currentMission === 'bestias12' || currentMission === 'LAS 12 BESTIAS')) {
      console.log('‚ö†Ô∏è updateStats() saltando statMission - 12 Bestias activo:', currentMission);
      // No sobrescribir statMission, lo maneja startBestias12Challenge
    } else {

      const statMissionBefore = statMission.textContent;

      
      statMission.textContent = (
      currentMission==='unit2' ? 'Unidad 2' :
      currentMission==='unit3' ? 'Unidad 3' :
      currentMission==='unit4' ? 'Unidad 4' :
      currentMission==='unit5' ? 'Unidad 5' :
      currentMission==='unit6' ? 'Unidad 6' :
      currentMission==='unit7' ? 'Unidad 7' :
      currentMission==='unit8' ? 'Unidad 8' :
      currentMission==='unit9' ? 'Unidad 9' :
      currentMission==='todoN1' ? 'Todo N1' :
      currentMission==='unit1N2' ? 'Unidad 1 (N2)' :
      currentMission==='unit2N2' ? 'Unidad 2 (N2)' :
      currentMission==='unit3N2' ? 'Unidad 3 (N2)' :
      currentMission==='unit4N2' ? 'Unidad 4 (N2)' :
      currentMission==='unit5N2' ? 'Unidad 5 (N2)' :
      currentMission==='unit6N2' ? 'Unidad 6 (N2)' :
      currentMission==='unit7N2' ? 'Unidad 7 (N2)' :
      currentMission==='unit8N2' ? 'Unidad 8 (N2)' :
      currentMission==='unit9N2' ? 'Unidad 9 (N2)' :
      currentMission==='todoN2' ? 'Todo N2' :
      currentMission==='unit1N3' ? 'Unidad 1 (N3)' :
      currentMission==='unit2N3' ? 'Unidad 2 (N3)' :
      currentMission==='unit3N3' ? 'Unidad 3 (N3)' :
      currentMission==='unit4N3' ? 'Unidad 4 (N3)' :
      currentMission==='unit5N3' ? 'Unidad 5 (N3)' :
      currentMission==='unit6N3' ? 'Unidad 6 (N3)' :
      currentMission==='unit7N3' ? 'Unidad 7 (N3)' :
      currentMission==='unit8N3' ? 'Unidad 8 (N3)' :
      currentMission==='unit9N3' ? 'Unidad 9 (N3)' :
      currentMission==='todoN3' ? 'Todo N3' :
      currentMission.startsWith('HSK3unit') ? `HSK3 - Unidad ${currentMission.replace('HSK3unit', '')}` :
      currentMission.startsWith('HSK4unit') ? `HSK4 - Unidad ${currentMission.replace('HSK4unit', '')}` :
      currentMission==='colores' ? 'üê≠ Colores' :
      currentMission==='fruta' ? 'üêî Fruta' :
      currentMission==='verduras' ? 'üê∞ Verduras' :
      currentMission==='comidas' ? 'üê∑ Comidas' :
      currentMission==='animales' ? 'üê∂ Animales' :
      currentMission==='deportes' ? 'üê¥ Deportes' :
      currentMission==='hobbies' ? 'üêÆ Hobbies' :
      currentMission==='ropa' ? 'üêê Ropa' :
      currentMission==='casa' ? 'üêç Casa' :
      currentMission==='cuerpo' ? 'üêµ Cuerpo' :
      currentMission==='profesiones' ? 'üêØ Profesiones' :
      currentMission==='emociones' ? 'üê≤ Emociones' :
      currentMission==='known' ? 'Conocidas' :
      currentMission==='revise1' ? 'A repasar' :
      currentMission==='revise2' ? 'Para confirmar' :
      currentMission==='challenge' ? 'Desaf√≠o' :
      currentMission==='desafioN1' ? 'Desaf√≠o N1' :
      currentMission==='desafioN2' ? 'Desaf√≠o N2' :
      currentMission==='desafioN3' ? 'Desaf√≠o N3' :
      currentMission==='ultimateChallenge' ? 'üèÜ Ultimate Challenge' :
      currentMission.startsWith('desafio') ? getHoroscopeDisplayText(currentMission) : '‚Äî'
      );
      

      
      // Si es un desaf√≠o N o hor√≥scopo, aplicar estilos especiales
      if (currentMission === 'desafioN1' || currentMission === 'desafioN2' || currentMission === 'desafioN3' || currentMission.startsWith('desafio')) {
        statMission.style.color = '#f2e5b1';
        statMission.style.fontWeight = 'bold';
        statMission.style.fontSize = '14px';
        console.log('üìä DEBUG: Estilos especiales aplicados a statMission');
      }
    }
    // Cambiar color de statBox seg√∫n el modo actual
    const modeToBtn = {
      'unit2': 'btnUnit2',
      'unit3': 'btnUnit3',
      'unit4': 'btnUnit4',
      'unit5': 'btnUnit5',
      'unit6': 'btnUnit6',
      'unit7': 'btnUnit7',
      'unit8': 'btnUnit8',
      'unit9': 'btnUnit9',
      'todoN1': 'btnTodoN1',
      'unit1N2': 'btnUnit1N2',
      'unit2N2': 'btnUnit2N2',
      'unit3N2': 'btnUnit3N2',
      'unit4N2': 'btnUnit4N2',
      'unit5N2': 'btnUnit5N2',
      'unit6N2': 'btnUnit6N2',
      'unit7N2': 'btnUnit7N2',
      'unit8N2': 'btnUnit8N2',
      'unit9N2': 'btnUnit9N2',
      'todoN2': 'btnTodoN2',
      'unit1N3': 'btnUnit1N3',
      'unit2N3': 'btnUnit2N3',
      'unit3N3': 'btnUnit3N3',
      'unit4N3': 'btnUnit4N3',
      'unit5N3': 'btnUnit5N3',
      'unit6N3': 'btnUnit6N3',
      'unit7N3': 'btnUnit7N3',
      'unit8N3': 'btnUnit8N3',
      'unit9N3': 'btnUnit9N3',
      'todoN3': 'btnTodoN3',
      'known': 'btnKnown',
      'revise1': 'btnRevise1',
      'revise2': 'btnRevise2',
      'challenge': 'btnChallenge'
    };
    let btnId = modeToBtn[currentMission];
    let btn = btnId ? document.getElementById(btnId) : null;
    if(btn) {
      statBox.style.background = window.getComputedStyle(btn).backgroundColor;
      statBox.style.color = window.getComputedStyle(btn).color;
      statBox.style.borderColor = window.getComputedStyle(btn).borderColor || 'transparent';
    } else {
      statBox.style.background = '';
      statBox.style.color = '';
      statBox.style.borderColor = '';
    }
    // contadores
    const countKnown = cards.filter(c=>c.known).length;
    const countRev1  = cards.filter(c=>c.revise1).length;
    const countRev2  = cards.filter(c=>c.revise2).length;
    
    // üî• DETECTAR CAMBIOS EN CONOCIDAS PARA DESAF√çOS CL√ÅSICOS
    if (desafioClasico2Active && 
        (currentMission === 'challenge' || currentMission === 'clasico' || currentMission === 'menos' || currentMission === 'mas') &&
        previousKnownCount > 0 && countKnown < previousKnownCount) {
      console.log('üíî CAMBIO DETECTADO: Conocidas baj√≥ de', previousKnownCount, 'a', countKnown, '- Perdiendo vida en desaf√≠o cl√°sico');
      loseDesafioClasico2Life();
    }
    
    // Actualizar contador anterior
    previousKnownCount = countKnown;
    
    const elKnown = document.getElementById('countKnown'); if(elKnown) elKnown.textContent = countKnown;
    const elR1    = document.getElementById('countRev1');  if(elR1)   elR1.textContent   = countRev1 === 0 ? '‚úÖ' : countRev1;
    const elR2    = document.getElementById('countRev2');  if(elR2)   elR2.textContent   = countRev2 === 0 ? '‚úÖ' : countRev2;

  updateStreakBox();
  
  // Actualizar barras de progreso de niveles y hor√≥scopo
  updateNivelesProgressBars();
  updateHoroscopeProgressBars();
  updateUnitProgressCounters();
  }

  /* ========= Tabla Conocidas ========= */
  let overlayField = 'hanzi'; // 'hanzi' | 'pinyin' | 'meaning'
  
  // üîÑ Sistema de ciclo individual por carta
  const cardDisplayStates = {}; // Objeto para rastrear el estado de cada carta individual
  
  // Funci√≥n para obtener el siguiente estado en el ciclo
  function getNextDisplayState(currentState) {
    const cycle = ['hanzi', 'pinyin', 'meaning'];
    const currentIndex = cycle.indexOf(currentState);
    return cycle[(currentIndex + 1) % cycle.length];
  }
  
  // Funci√≥n para obtener el valor a mostrar seg√∫n el estado
  function getDisplayValue(card, state) {
    switch(state) {
      case 'pinyin': return card.pinyin;
      case 'meaning': return card.meaning;
      default: return card.hanzi;
    }
  }
let knownCatFilter = 'ALL'; // 'ALL'|'S'|'A'|'V'|'P'|'E'

// Estado previo de conocidas para animaciones
let prevKnownState = [];
window.prevKnownState = prevKnownState;

  // Funci√≥n para inicializar el estado correcto al cargar desde backend
  function initializeKnownState() {
    console.log('üîß initializeKnownState() - Inicializando estado correcto');
    
    // Establecer prevKnownState con los datos actuales (excluyendo badges del hor√≥scopo)
    const currentKnown = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo')
      .map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    
    prevKnownState = currentKnown.map(c => ({ ...c }));
    window.prevKnownState = prevKnownState;
    
    console.log('üîß prevKnownState inicializado con', prevKnownState.length, 'elementos conocidos');
    
    // Actualizar contadores inmediatamente
    updateStats();
    
    console.log('üîß Contadores actualizados - Mi colecci√≥n deber√≠a mostrar el n√∫mero correcto');
  }
  // Overlay removed: no-op

  // Interpolaci√≥n azul -> naranja para la racha
  const COLOR_A = { r: 59, g: 130, b: 246 };   // #3B82F6
  const COLOR_B = { r: 255, g: 134, b: 35  };  // #FF8623
  function lerp(a,b,t){ return a + (b-a)*t; }
  function mixColor(t){
    const r = Math.round(lerp(COLOR_A.r, COLOR_B.r, t));
    const g = Math.round(lerp(COLOR_A.g, COLOR_B.g, t));
    const b = Math.round(lerp(COLOR_A.b, COLOR_B.b, t));
    return `rgb(${r}, ${g}, ${b})`;
  }

  // Ajuste de texto para celdas (binaria para que quepa en ancho/alto)
  function fitCellText(el, minPx=10, maxPx=64){
    const parent = el.parentElement;
    if(!parent) return;
    const pad = 18; // margen de seguridad
    let low = minPx, high = maxPx, best = minPx;
    while(low <= high){
      const mid = Math.floor((low + high)/2);
      el.style.fontSize = mid + 'px';
      // Medimos (fudges con padding)
      const OK = (el.scrollWidth <= parent.clientWidth - pad) && (el.scrollHeight <= parent.clientHeight - pad);
      if(OK){ best = mid; low = mid + 1; } else { high = mid - 1; }
    }
    el.style.fontSize = best + 'px';
  }

  function sizeClassForHanzi(len){
    return len >= 4 ? 'font-bold' : 'font-bold';
  }

  // Actualizar barra de progreso de Mi Colecci√≥n
  function updateMiColeccionProgressBar() {
    // Definir unidades que cuentan para Mi Colecci√≥n
    const nivel1Units = ['unit2', 'unit3', 'unit4', 'unit5', 'unit6', 'unit7', 'unit8', 'unit9'];
    const nivel2Units = ['unit1N2', 'unit2N2', 'unit3N2', 'unit4N2', 'unit5N2', 'unit6N2', 'unit7N2', 'unit8N2', 'unit9N2'];
    const nivel3Units = ['unit1N3', 'unit2N3', 'unit3N3', 'unit4N3', 'unit5N3', 'unit6N3', 'unit7N3', 'unit8N3', 'unit9N3'];
    const horoscopeUnits = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
    const hsk3Units = ['HSK3unit1', 'HSK3unit2', 'HSK3unit3', 'HSK3unit4', 'HSK3unit5', 'HSK3unit6', 'HSK3unit7', 'HSK3unit8', 'HSK3unit9'];
    const hsk4Units = ['HSK4unit1', 'HSK4unit2', 'HSK4unit3', 'HSK4unit4', 'HSK4unit5', 'HSK4unit6', 'HSK4unit7', 'HSK4unit8', 'HSK4unit9', 'HSK4unit10', 'HSK4unit11', 'HSK4unit12', 'HSK4unit13', 'HSK4unit14', 'HSK4unit15', 'HSK4unit16', 'HSK4unit17', 'HSK4unit18', 'HSK4unit19', 'HSK4unit20'];
    
    // Combinar todas las unidades que cuentan
    let relevantUnits = [...nivel1Units, ...nivel2Units, ...nivel3Units, ...horoscopeUnits];
    
    // Si HSK est√° desbloqueado, incluir HSK3 y HSK4
    if (hskUnlocked) {
      relevantUnits = [...relevantUnits, ...hsk3Units, ...hsk4Units];
    }
    
    // Filtrar solo caracteres de las unidades relevantes
    const relevantCards = cards.filter(c => relevantUnits.some(u => c.unit.split('|').includes(u)));
    const knownCharacters = relevantCards.filter(c => c.known).length;
    const totalCharacters = relevantCards.length;
    
    // Elementos de la barra de progreso de Mi Colecci√≥n
    const miColeccionProgressBar = document.getElementById('miColeccionProgressBar');
    const miColeccionProgressText = document.getElementById('miColeccionProgressText');
    const miColeccionCharacters = document.getElementById('miColeccionCharacters');
    
    if (miColeccionCharacters) miColeccionCharacters.textContent = `${knownCharacters}/${totalCharacters}`;
    
    // Actualizar barra de progreso de caracteres
    if (miColeccionProgressBar && miColeccionProgressText) {
      const percentage = totalCharacters > 0 ? Math.round((knownCharacters / totalCharacters) * 100) : 0;
      
      // Agregar efecto de pulsaci√≥n
      miColeccionProgressBar.classList.remove('progress-bar-pulse');
      
      // Animar la barra de progreso
      setTimeout(() => {
        miColeccionProgressBar.style.width = `${percentage}%`;
        miColeccionProgressBar.classList.add('progress-bar-pulse');
        
        // Cambiar colores de la barra seg√∫n el progreso (grados de amarillo a naranja)
        if (percentage >= 90) {
          miColeccionProgressBar.style.background = 'linear-gradient(90deg, #f97316, #ea580c)'; // Naranja intenso
          miColeccionProgressBar.style.boxShadow = '0 0 15px rgba(249, 115, 22, 0.8)';
        } else if (percentage >= 70) {
          miColeccionProgressBar.style.background = 'linear-gradient(90deg, #fb923c, #f97316)'; // Naranja medio
          miColeccionProgressBar.style.boxShadow = '0 0 15px rgba(251, 146, 60, 0.8)';
        } else if (percentage >= 40) {
          miColeccionProgressBar.style.background = 'linear-gradient(90deg, #fbbf24, #f59e0b)'; // Amarillo-naranja
          miColeccionProgressBar.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.8)';
        } else {
          miColeccionProgressBar.style.background = 'linear-gradient(90deg, #fde047, #facc15)'; // Amarillo claro
          miColeccionProgressBar.style.boxShadow = '0 0 15px rgba(253, 224, 71, 0.8)';
        }
        
        // Quitar la clase despu√©s de la animaci√≥n
        setTimeout(() => {
          miColeccionProgressBar.classList.remove('progress-bar-pulse');
        }, 2000);
      }, 100); // Peque√±o delay para que se vea la animaci√≥n
      
      // Actualizar texto de porcentaje con color din√°mico
      miColeccionProgressText.textContent = `${percentage}% completado`;
      
      // Cambiar color seg√∫n el progreso (grados de amarillo a naranja)
      if (percentage >= 90) {
        miColeccionProgressText.style.color = '#f97316'; // Naranja intenso para casi completo
        miColeccionProgressText.style.textShadow = '0 0 4px rgba(249, 115, 22, 0.6)';
      } else if (percentage >= 70) {
        miColeccionProgressText.style.color = '#fb923c'; // Naranja medio
        miColeccionProgressText.style.textShadow = '0 0 4px rgba(251, 146, 60, 0.6)';
      } else if (percentage >= 40) {
        miColeccionProgressText.style.color = '#fbbf24'; // Amarillo-naranja
        miColeccionProgressText.style.textShadow = '0 0 4px rgba(251, 191, 36, 0.6)';
      } else {
        miColeccionProgressText.style.color = '#fde047'; // Amarillo claro para inicio
        miColeccionProgressText.style.textShadow = '0 0 4px rgba(253, 224, 71, 0.6)';
      }
    }
  }

  // Render con animaciones de level up y perdidos
  // Helper function para obtener el nombre de la rareza
  function getRarityName(streak) {
    if (streak >= 15) return 'Legendaria';
    if (streak >= 10) return '√âpica';
    if (streak >= 5) return 'Rara';
    if (streak >= 2) return 'Poco Com√∫n';
    return 'Com√∫n';
  }

  function renderKnownGridWithAnimations(levelUpIds, lostChars, newlyAdded) {
    // EXCLUIR badges del hor√≥scopo del conteo de conocidas normales
    let known = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo');
    if(knownCatFilter !== 'ALL') {
      known = known.filter(c => (c.cat||'E').toUpperCase() === knownCatFilter);
    }
    
    // Conteo total solo de palabras normales (sin badges del hor√≥scopo)
    const totalCount = known.length;
    
    knownCount.textContent = `${totalCount} palabras`;

    // Actualizar barra de progreso de Mi Colecci√≥n
    updateMiColeccionProgressBar();

    // Grid responsivo: 4 columnas en m√≥vil, m√°s en desktop
    knownGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(min(100px, 22vw), 1fr))';

    // ordenar por challengeStreak desc
    known.sort((a,b)=> (b.challengeStreak||0) - (a.challengeStreak||0));
    const maxStreak = Math.max(0, ...known.map(c => c.challengeStreak||0));

    // --- Renderizar animaciones temporales arriba ---
    knownGrid.innerHTML = '';
    
    // üé® Funci√≥n helper para crear cartas de animaci√≥n
    function createAnimationCard(c, type) {
      const cell = document.createElement('div');
      cell.className = `trading-card squareCell ${type}-cell`;
      cell.style.position = 'relative';
      cell.style.opacity = '0';
      cell.style.transition = 'opacity 0.7s cubic-bezier(.4,0,.2,1), transform 0.7s cubic-bezier(.4,0,.2,1)';
      cell.style.transform = 'translateY(20px)';
      
      if(type === 'lost') {
        // Estilo rojo para perdidas
        cell.style.background = 'linear-gradient(135deg, #7f1d1d, #991b1b)';
        cell.style.border = '2px solid #dc2626';
        cell.style.boxShadow = '0 4px 8px rgba(220, 38, 38, 0.3)';
        cell.title = `${c.hanzi} - PERDIDA (Streak: ${c.streak})`;
      } else if(type === 'levelup') {
        // Estilo verde para level up (m√°s claro)
        cell.style.background = 'linear-gradient(135deg, #15803d, #4ade80)';
        cell.style.border = '2px solid #22c55e';
        cell.style.boxShadow = '0 4px 8px rgba(34, 197, 94, 0.4)';
        cell.title = `${c.hanzi} - LEVEL UP! (Streak: ${c.challengeStreak})`;
      } else {
        // Estilo blanco con gradiente y borde verde ne√≥n para caracdteres nuevos
        cell.style.background = 'linear-gradient(135deg, #ffffff, #f0fdf4)';
        cell.style.border = '2px solid #10b981';
        cell.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4), 0 0 8px rgba(16, 185, 129, 0.2)';
        cell.title = `${c.hanzi} - ¬°NUEVO! (Streak: ${c.challengeStreak || c.streak})`;
      }
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Hanzi principal
      const content = document.createElement('div');
      content.className = 'card-hanzi jersey-font-coleccion-cards';
      content.textContent = getDisplayValue(c, cardDisplayStates[c.id] || overlayField);
      
      if(type === 'lost') {
        content.style.color = '#fecaca';
        content.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.8)';
      } else if(type === 'levelup') {
        content.style.color = '#bbf7d0';
        content.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.8)';
      } else {
        content.style.color = '#065f46';
        content.style.textShadow = '1px 1px 2px rgba(255, 255, 255, 0.8)';
      }
      
      cardContent.appendChild(content);
      
      // üìã Cartelito informativo
      const infoLabel = document.createElement('div');
      infoLabel.style.position = 'absolute';
      infoLabel.style.bottom = '8px';
      infoLabel.style.left = '50%';
      infoLabel.style.transform = 'translateX(-50%)';
      infoLabel.style.fontSize = '9px';
      infoLabel.style.fontWeight = 'bold';
      infoLabel.style.padding = '2px 6px';
      infoLabel.style.borderRadius = '8px';
      infoLabel.style.textAlign = 'center';
      infoLabel.style.minWidth = '60px';
      infoLabel.style.whiteSpace = 'nowrap';
      infoLabel.className = 'jersey-font-coleccion-cards';
      
      if(type === 'lost') {
        infoLabel.textContent = 'PERDISTE';
        infoLabel.style.background = 'rgba(153, 27, 27, 0.9)';
        infoLabel.style.color = '#fecaca';
        infoLabel.style.border = '1px solid #dc2626';
      } else if(type === 'levelup') {
        // Calcular cu√°ntos niveles subi√≥
        const prevStreak = window.prevKnownState ? 
          (window.prevKnownState.find(x => x.id === c.id)?.streak || 0) : 0;
        const newStreak = c.challengeStreak || 0;
        const levelsUp = newStreak - prevStreak;
        
        infoLabel.textContent = levelsUp > 1 ? `SUBE ${levelsUp} NIVELES` : 'SUBE 1 NIVEL';
        
        // üé® COLORES SEG√öN NIVELES: Verde (1), Amarillo (2), Naranja (5+)
        if (levelsUp >= 5) {
          // Naranja para 5+ niveles
          infoLabel.style.background = 'rgba(194, 65, 12, 0.9)';
          infoLabel.style.color = '#fed7aa';
          infoLabel.style.border = '1px solid #ea580c';
        } else if (levelsUp === 2) {
          // Amarillo para 2 niveles
          infoLabel.style.background = 'rgba(161, 98, 7, 0.9)';
          infoLabel.style.color = '#fef3c7';
          infoLabel.style.border = '1px solid #d97706';
        } else {
          // Verde para 1 nivel (por defecto)
          infoLabel.style.background = 'rgba(21, 128, 61, 0.9)';
          infoLabel.style.color = '#bbf7d0';
          infoLabel.style.border = '1px solid #22c55e';
        }
      } else {
        infoLabel.textContent = 'A√ëADISTE';
        infoLabel.style.background = 'rgba(5, 150, 105, 0.9)';
        infoLabel.style.color = '#ffffff';
        infoLabel.style.border = '1px solid #10b981';
      }
      
      cardContent.appendChild(infoLabel);
      
      // Badge de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge';
      badge.textContent = c.challengeStreak || c.streak || 0;
      
      if(type === 'lost') {
        badge.style.background = '#7f1d1d';
      } else if(type === 'levelup') {
        badge.style.background = '#166534';
        // Mostrar directamente el nivel final sin animaci√≥n
        const newStreak = c.challengeStreak || 0;
        badge.textContent = newStreak;
      } else {
        badge.style.background = '#059669';
        badge.style.color = '#ffffff';
        // Para nuevos caracteres, mostrar directamente el n√∫mero sin animaci√≥n
        badge.textContent = c.challengeStreak || c.streak || 0;
      }
      
      // Ensamblar carta (sin badge de categor√≠a)
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      
      return cell;
    }
    
    // üîÑ Crear contenedor para animaciones (perdidos + level ups)
    const animationRow = document.createElement('div');
    animationRow.style.display = 'contents';
    animationRow.id = 'animationRow';
    
    // üî¥ Renderizar cartas perdidas (rojas)
    lostChars.forEach(c => {
      const cell = createAnimationCard(c, 'lost');
      animationRow.appendChild(cell);
    });
    
    // üü¢ Renderizar cartas que suben de nivel (verdes)
    if(levelUpIds && levelUpIds.length) {
      levelUpIds.forEach(cardId => {
        const card = cards.find(x => x.id === cardId && x.known);
        if(card) {
          const cell = createAnimationCard(card, 'levelup');
          animationRow.appendChild(cell);
        }
      });
    }
    
    // üîµ Renderizar cartas nuevas a√±adidas (azules)
    if(newlyAdded && newlyAdded.length) {
      newlyAdded.forEach(c => {
        const cell = createAnimationCard(c, 'new');
        animationRow.appendChild(cell);
      });
    }
    
    // Solo agregar las animaciones si hay cartas para mostrar
    if(lostChars.length > 0 || (levelUpIds && levelUpIds.length > 0) || (newlyAdded && newlyAdded.length > 0)) {
      knownGrid.appendChild(animationRow);
      
      // üîä Sonido especial para las animaciones de cargtas
      try {
        const satisfactionSound = new Audio('music/trackcol.mp3');
        satisfactionSound.volume = 0.3;
        satisfactionSound.play().catch(e => console.log('No se pudo reproducir sonido:', e));
      } catch(e) {
        console.log('Error al crear sonido:', e);
      }
      
      // ‚ú® Fade-in inicial despu√©s de 1 segundo (para que se aprecie)
      setTimeout(() => {
        const allAnimationCells = animationRow.querySelectorAll('.lost-cell, .levelup-cell, .new-cell');
        allAnimationCells.forEach(cell => {
          cell.style.opacity = '1';
          cell.style.transform = 'translateY(0)';
        });
      }, 1000);
      
      // ‚è∞ Iniciar fade-out despu√©s de 7s (1s m√°s para apreciar)
      setTimeout(() => {
        const allAnimationCells = animationRow.querySelectorAll('.lost-cell, .levelup-cell, .new-cell');
        allAnimationCells.forEach(cell => {
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-20px)';
        });
        
        // üóëÔ∏è Remover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (animationRow.parentNode) {
            animationRow.parentNode.removeChild(animationRow);
          }
        }, 700);
      }, 7000);
    }

    // --- Badge Ultimate Master si est√° completado ---
    if(knownCatFilter === 'ALL' && horoscopeMaster) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üëë ULTIMATE MASTER - Desaf√≠o Final del Hor√≥scopo Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de master con overlay dorado
      const masterDiv = document.createElement('div');
      masterDiv.className = 'card-hanzi';
      masterDiv.style.display = 'flex';
      masterDiv.style.alignItems = 'center';
      masterDiv.style.justifyContent = 'center';
      masterDiv.style.height = '100%';
      masterDiv.style.position = 'relative';
      
      const masterImg = document.createElement('img');
      masterImg.src = 'img/master.webp';
      masterImg.alt = 'Ultimate Master';
      masterImg.style.width = '100%';
      masterImg.style.height = '100%';
      masterImg.style.objectFit = 'contain';
      masterImg.style.borderRadius = '0';
      masterImg.style.filter = 'none';
      masterImg.style.border = 'none';
      masterImg.style.boxShadow = 'none';
      masterImg.onerror = function() {
        console.log('Error loading master.webp');
        this.style.display = 'none';
      };
      
      masterDiv.appendChild(masterImg);
      cardContent.appendChild(masterDiv);
      
      // Badge m√≠tico de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'MASTER';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      
      // Badge de categor√≠a m√≠tico
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "ULTIMATE";
      catBadge.style.fontSize = '8px';
      
      // Ensamblar carta master
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge La Emperatriz si est√° completado ---
    if(knownCatFilter === 'ALL' && emperatrizCompleted) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üëë LA EMPERATRIZ - Desaf√≠o Boss Battle Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de emperatriz
      const emperatrizDiv = document.createElement('div');
      emperatrizDiv.className = 'card-hanzi';
      emperatrizDiv.style.display = 'flex';
      emperatrizDiv.style.alignItems = 'center';
      emperatrizDiv.style.justifyContent = 'center';
      emperatrizDiv.style.height = '100%';
      emperatrizDiv.style.position = 'relative';
      
      const emperatrizImg = document.createElement('img');
      emperatrizImg.src = 'img/emp.webp';
      emperatrizImg.alt = 'La Emperatriz';
      emperatrizImg.style.width = '120%';
      emperatrizImg.style.height = '120%';
      emperatrizImg.style.objectFit = 'contain';
      emperatrizImg.style.borderRadius = '0';
      emperatrizImg.style.filter = 'none';
      emperatrizImg.style.border = 'none';
      emperatrizImg.style.boxShadow = 'none';
      emperatrizImg.onerror = function() {
        console.log('Error loading emp.webp');
        this.style.display = 'none';
      };
      
      emperatrizDiv.appendChild(emperatrizImg);
      cardContent.appendChild(emperatrizDiv);
      
      // Badge √©pico de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = '√âPICO';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #ff6b35, #ff8c42)';
      
      // Badge de categor√≠a √©pico
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "EMPERATRIZ";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      
      // Ensamblar carta emperatriz
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge 12 Bestias si est√° completado ---
    if(knownCatFilter === 'ALL' && bestias12Completed) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üê≤ 12 BESTIAS - Desaf√≠o del Hor√≥scopo Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de bestias
      const bestiasDiv = document.createElement('div');
      bestiasDiv.className = 'card-hanzi';
      bestiasDiv.style.display = 'flex';
      bestiasDiv.style.alignItems = 'center';
      bestiasDiv.style.justifyContent = 'center';
      bestiasDiv.style.height = '100%';
      bestiasDiv.style.position = 'relative';
      
      const bestiasImg = document.createElement('img');
      bestiasImg.src = 'img/dragonb.webp';
      bestiasImg.alt = '12 Bestias';
      bestiasImg.style.width = '100%';
      bestiasImg.style.height = '100%';
      bestiasImg.style.objectFit = 'contain';
      bestiasImg.style.borderRadius = '0';
      bestiasImg.style.filter = 'none';
      bestiasImg.style.border = 'none';
      bestiasImg.style.boxShadow = 'none';
      bestiasImg.onerror = function() {
        console.log('Error loading bestias12.webp');
        this.style.display = 'none';
      };
      
      bestiasDiv.appendChild(bestiasImg);
      cardContent.appendChild(bestiasDiv);
      
      // Badge legendario de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'BESTIA';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #16a34a, #15803d)';
      
      // Badge de categor√≠a legendario
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "12 BESTIAS";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
      
      // Ensamblar carta bestias
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge Cruzar el Mar si est√° completado ---
    if(knownCatFilter === 'ALL' && cruzarMarCompleted) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üåä CRUZAR EL MAR - Desaf√≠o Marino Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de Cruzar el Mar
      const marDiv = document.createElement('div');
      marDiv.className = 'card-hanzi';
      marDiv.style.display = 'flex';
      marDiv.style.alignItems = 'center';
      marDiv.style.justifyContent = 'center';
      marDiv.style.height = '100%';
      marDiv.style.position = 'relative';
      
      const marImg = document.createElement('img');
      marImg.src = 'img/badgemar.webp';
      marImg.alt = 'Cruzar el Mar';
      marImg.style.width = '100%';
      marImg.style.height = '100%';
      marImg.style.objectFit = 'contain';
      marImg.style.borderRadius = '0';
      marImg.style.filter = 'none';
      marImg.style.border = 'none';
      marImg.style.boxShadow = 'none';
      marImg.onerror = function() {
        console.log('Error loading badgemar.webp');
        this.style.display = 'none';
      };
      
      marDiv.appendChild(marImg);
      cardContent.appendChild(marDiv);
      
      // Badge marino de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'NIVEL 1';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #06b6d4, #0e7490)';
      
      // Badge de categor√≠a marino
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "CRUZAR MAR";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #0891b2, #0369a1)';
      
      // Ensamblar carta Cruzar el Mar
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge Cruzar el Cielo si est√° completado ---
    if(knownCatFilter === 'ALL' && cruzarCieloCompleted) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = '‚òÅÔ∏è CRUZAR EL CIELO - Desaf√≠o Celestial Completado';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de Cruzar el Cielo
      const cieloDiv = document.createElement('div');
      cieloDiv.className = 'card-hanzi';
      cieloDiv.style.display = 'flex';
      cieloDiv.style.alignItems = 'center';
      cieloDiv.style.justifyContent = 'center';
      cieloDiv.style.height = '100%';
      cieloDiv.style.position = 'relative';
      
      const cieloImg = document.createElement('img');
      cieloImg.src = 'img/badgecielo.webp';
      cieloImg.alt = 'Cruzar el Cielo';
      cieloImg.style.width = '100%';
      cieloImg.style.height = '100%';
      cieloImg.style.objectFit = 'contain';
      cieloImg.style.borderRadius = '0';
      cieloImg.style.filter = 'none';
      cieloImg.style.border = 'none';
      cieloImg.style.boxShadow = 'none';
      cieloImg.onerror = function() {
        console.log('Error loading badgecielo.webp');
        this.style.display = 'none';
      };
      
      cieloDiv.appendChild(cieloImg);
      cardContent.appendChild(cieloDiv);
      
      // Badge celestial de streak
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'NIVEL 2';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #ec4899, #db2777)';
      
      // Badge de categor√≠a celestial
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "CRUZAR CIELO";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #db2777, #be185d)';
      
      // Ensamblar carta Cruzar el Cielo
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge Cruzar HSK3 si est√° completado ---
    if(knownCatFilter === 'ALL' && cruzarHSK3Completed) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üìò CRUZAR HSK3 - Dominio del Nivel HSK3';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de Cruzar HSK3
      const hsk3Div = document.createElement('div');
      hsk3Div.className = 'card-hanzi';
      hsk3Div.style.display = 'flex';
      hsk3Div.style.alignItems = 'center';
      hsk3Div.style.justifyContent = 'center';
      hsk3Div.style.height = '100%';
      hsk3Div.style.position = 'relative';
      
      const hsk3Img = document.createElement('img');
      hsk3Img.src = 'img/badgehsk3.webp';
      hsk3Img.alt = 'Cruzar HSK3';
      hsk3Img.style.width = '100%';
      hsk3Img.style.height = '100%';
      hsk3Img.style.objectFit = 'contain';
      hsk3Img.style.borderRadius = '0';
      hsk3Img.style.filter = 'none';
      hsk3Img.style.border = 'none';
      hsk3Img.style.boxShadow = 'none';
      hsk3Img.onerror = function() {
        console.log('Error loading badgehsk3.webp');
        this.style.display = 'none';
      };
      
      hsk3Div.appendChild(hsk3Img);
      cardContent.appendChild(hsk3Div);
      
      // Badge de nivel HSK3
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'HSK3';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
      
      // Badge de categor√≠a HSK3
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "CRUZAR HSK3";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #2563eb, #1d4ed8)';
      
      // Ensamblar carta Cruzar HSK3
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Badge Cruzar HSK4 si est√° completado ---
    if(knownCatFilter === 'ALL' && cruzarHSK4Completed) {
      const cell = document.createElement('div');
      cell.className = 'trading-card card-ultra-master squareCell';
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.zIndex = '1';
      cell.title = 'üìó CRUZAR HSK4 - Maestr√≠a del Nivel HSK4';
      
      // Contenedor del contenido
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Imagen de Cruzar HSK4
      const hsk4Div = document.createElement('div');
      hsk4Div.className = 'card-hanzi';
      hsk4Div.style.display = 'flex';
      hsk4Div.style.alignItems = 'center';
      hsk4Div.style.justifyContent = 'center';
      hsk4Div.style.height = '100%';
      hsk4Div.style.position = 'relative';
      
      const hsk4Img = document.createElement('img');
      hsk4Img.src = 'img/badgehsk4.webp';
      hsk4Img.alt = 'Cruzar HSK4';
      hsk4Img.style.width = '100%';
      hsk4Img.style.height = '100%';
      hsk4Img.style.objectFit = 'contain';
      hsk4Img.style.borderRadius = '0';
      hsk4Img.style.filter = 'none';
      hsk4Img.style.border = 'none';
      hsk4Img.style.boxShadow = 'none';
      hsk4Img.onerror = function() {
        console.log('Error loading badgehsk4.webp');
        this.style.display = 'none';
      };
      
      hsk4Div.appendChild(hsk4Img);
      cardContent.appendChild(hsk4Div);
      
      // Badge de nivel HSK4
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge master-streak-badge';
      badge.textContent = 'HSK4';
      badge.style.fontSize = '8px';
      badge.style.fontWeight = '900';
      badge.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      
      // Badge de categor√≠a HSK4
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge master-category-badge';
      catBadge.textContent = "CRUZAR HSK4";
      catBadge.style.fontSize = '7px';
      catBadge.style.background = 'linear-gradient(135deg, #059669, #047857)';
      
      // Ensamblar carta Cruzar HSK4
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      knownGrid.appendChild(cell);
    }

    // --- Renderizar animales del hor√≥scopo desbloqueados EN ORDEN FIJO ---
    if(knownCatFilter === 'ALL') { // Solo mostrar animales cuando no hay filtro espec√≠fico
      // Orden fijo de animales del hor√≥scopo
      const fixedAnimalOrder = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
      
      // Renderizar solo los animales desbloqueados, pero en el orden fijo
      fixedAnimalOrder.forEach(categoria => {
        // Solo renderizar si el animal ha sido desbloqueado
        if (horoscopeAnimalsUnlocked.includes(categoria)) {
          const animal = horoscopeAnimals[categoria];
          const cell = document.createElement('div');
          cell.className = 'trading-card card-mythic-animal squareCell';
          cell.style.position = 'relative';
          cell.style.pointerEvents = 'auto';
          cell.style.zIndex = '1';
          cell.title = `üêâ ${animal.chinese} ${animal.name} - Animal M√≠tico del Hor√≥scopo`;
          
          // Contenedor del contenido
          const cardContent = document.createElement('div');
          cardContent.className = 'card-content';
          
          // Imagen del animal con efectos
          const imgDiv = document.createElement('div');
          imgDiv.className = 'card-hanzi';
          imgDiv.style.display = 'flex';
          imgDiv.style.justifyContent = 'center';
          imgDiv.style.alignItems = 'center';
          imgDiv.style.height = '100%';
          
          const animalImg = document.createElement('img');
          animalImg.src = `img/${animal.image}`;
          animalImg.alt = animal.name;
          animalImg.className = 'horoscope-animal-image';
          animalImg.style.filter = 'none';
          animalImg.onerror = function() {
            console.log(`Error loading image: img/${animal.image}`);
            this.style.display = 'none';
          };
          
          imgDiv.appendChild(animalImg);
          cardContent.appendChild(imgDiv);
          
          // Badge m√≠tico con car√°cter chino
          const badge = document.createElement('div');
          badge.className = 'card-streak-badge mythic-streak-badge';
          badge.textContent = animal.chinese;
          badge.style.fontSize = '14px';
          badge.style.fontWeight = 'bold';
          
          // Badge de categor√≠a m√≠tico
          const catBadge = document.createElement('div');
          catBadge.className = 'card-category-badge mythic-category-badge';
          catBadge.textContent = "M√çTICO";
          catBadge.style.fontSize = '8px';
          
          // Ensamblar carta m√≠tica
          cell.appendChild(cardContent);
          cell.appendChild(badge);
          cell.appendChild(catBadge);
          
          knownGrid.appendChild(cell);
        }
      });
    }

    // --- Renderizar conocidos normales como Trading Cards ---
    known.forEach(c => {
      // üîÑ Determinar el estado de display para esta carta
      const cardKey = c.id || c.hanzi; // Usar ID si existe, sino hanzi como fallback
      let cardState = cardDisplayStates[cardKey];
      
      // Si no hay estado individual, usar el overlayField global
      if (!cardState) {
        cardState = overlayField;
      }
      
      const value = getDisplayValue(c, cardState);
      const st = c.challengeStreak || 0;
      
      // Determinar rareza basada en streak
      let rarityClass = 'card-common';
      if (st >= 21) rarityClass = 'card-legendary';
      else if (st >= 11) rarityClass = 'card-epic';
      else if (st >= 6) rarityClass = 'card-rare';
      else if (st >= 3) rarityClass = 'card-uncommon';
      
      // Crear la carta
      const cell = document.createElement('div');
      cell.className = `trading-card ${rarityClass} squareCell clickable-card`;
      cell.style.position = 'relative';
      cell.style.pointerEvents = 'auto';
      cell.style.cursor = 'pointer';
      cell.style.zIndex = '1';
      
      // Verificar si es nueva carta para animaci√≥n
      if(levelUpIds && levelUpIds.includes(c.id)) {
        cell.classList.add('new-card');
      }
      
      // Contenedor del contenido de la carta
      const cardContent = document.createElement('div');
      cardContent.className = 'card-content';
      
      // Hanzi principal
      const hanziDiv = document.createElement('div');
      hanziDiv.className = 'card-hanzi jersey-font-coleccion-cards';
      hanziDiv.textContent = value;
      cardContent.appendChild(hanziDiv);
      
      // Badge de streak (esquina superior derecha)
      const badge = document.createElement('div');
      badge.className = 'card-streak-badge';
      badge.textContent = st;
      
      // Sin animaci√≥n de contador - mostrar directamente el nivel final
      if(levelUpIds && levelUpIds.includes(c.id)) {
        badge.classList.add('levelup-anim');
        // Mostrar directamente el nivel final sin animaci√≥n
        badge.textContent = st;
      }
      
      // Badge de categor√≠a (esquina inferior izquierda)
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.className = 'card-category-badge';
      catBadge.textContent = cat;
      
      // Ensamblar la carta
      cell.appendChild(cardContent);
      cell.appendChild(badge);
      cell.appendChild(catBadge);
      
      // üîÑ Event listener para ciclar individualmente
      cell.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        // Obtener estado actual de esta carta
        const currentState = cardDisplayStates[cardKey] || overlayField;
        const nextState = getNextDisplayState(currentState);
        
        // Guardar el nuevo estado individual
        cardDisplayStates[cardKey] = nextState;
        
        // Actualizar solo el contenido de esta carta
        const hanziDiv = cell.querySelector('.card-hanzi');
        if (hanziDiv) {
          hanziDiv.textContent = getDisplayValue(c, nextState);
          // Reajustar tama√±o del texto despu√©s de cambiar el contenido
          // Usar rangos m√°s grandes para hanzi/pinyin, m√°s peque√±os para meaning
          const isHanziOrPinyin = nextState === 'hanzi' || nextState === 'pinyin';
          const minSize = isHanziOrPinyin ? 16 : 12;
          const maxSize = isHanziOrPinyin ? 64 : 32;
          requestAnimationFrame(() => fitCellText(hanziDiv, minSize, maxSize));
        }
        
        // Actualizar tooltip
        cell.title = `${c.hanzi} (${c.pinyin})\n${c.meaning}\nStreak: ${st} - ${getRarityName(st)}\nModo: ${nextState}`;
      });
      
      // Tooltip con informaci√≥n completa
      cell.title = `${c.hanzi} (${c.pinyin})\n${c.meaning}\nStreak: ${st} - ${getRarityName(st)}\nModo: ${cardState}`;
      
      knownGrid.appendChild(cell);
      
      // Ajustar tama√±o del texto para que se adapte a la tarjeta
      // Usar rangos m√°s grandes para hanzi/pinyin, m√°s peque√±os para meaning
      const isHanziOrPinyin = cardState === 'hanzi' || cardState === 'pinyin';
      const minSize = isHanziOrPinyin ? 16 : 12;
      const maxSize = isHanziOrPinyin ? 64 : 32;
      requestAnimationFrame(() => fitCellText(hanziDiv, minSize, maxSize));
    });

    // --- Animar salida de perdidos, luego level up, luego reacomodar ---
    if(lostChars.length) {
      setTimeout(()=>{
        // Sonido removido para evitar conflictos con nuevo sonido de satisfacci√≥n
        lostRow.childNodes.forEach(cell=>{
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-40px)';
        });
        setTimeout(()=>{
          lostRow.remove();
          // Animar level up despu√©s de perdidos
          animateLevelUps(levelUpIds, ()=>{
            // Al terminar animaci√≥n, re-renderizar la tabla normal SIN animaciones para evitar bucle
            setTimeout(()=>renderKnownGridWithAnimations([], [], []), 100);
          });
        }, 700);
      }, 1200);
    } else {
      // Si no hay perdidos, animar level up inmediatamente sin recursi√≥n
      setTimeout(()=>animateLevelUps(levelUpIds), 400);
    }

    // --- Animaci√≥n visual llamativa para level up (brillo verde en celda entera) ---
    function animateLevelUps(levelUpIds, onDone) {
      if(!levelUpIds || !levelUpIds.length) { if(onDone) onDone(); return; }
      
      // Solo verificar si hay level ups para reproducir sonido
      const cells = knownGrid.querySelectorAll('.squareCell');
      let anyLevelUp = false;
      
      cells.forEach(cell => {
        const badge = cell.querySelector('.streak-badge');
        if(!badge) return;
        const hanzi = cell.querySelector('div').textContent;
        const c = cards.find(x => x.hanzi === hanzi && x.known);
        if(c && levelUpIds.includes(c.id)) {
          anyLevelUp = true;
          // NO HAY ANIMACIONES - solo detectamos que hubo level up
        }
      });
      
      // Sonido de gloria si hubo level up
      if(anyLevelUp) soundGlory();
      
      // Llamar onDone inmediatamente (sin esperar animaciones)
      if(onDone) setTimeout(onDone, 100);
    }

    // Sonido para salida de perdidos
    function soundLostKnowns() {
      // Sonido digital descendente, tipo "whoosh triste"
      beep(220,0.18,'triangle',0.11);
      setTimeout(()=>beep(130,0.16,'triangle',0.09),90);
      setTimeout(()=>beep(80,0.13,'sine',0.07),180);
    }
    // Sonido de gloria para level up
    function soundGlory() {
      // Acorde mayor brillante
      beep(523,0.22,'triangle',0.13); // C5
      beep(659,0.22,'triangle',0.11); // E5
      beep(784,0.22,'triangle',0.10); // G5
      setTimeout(() => beep(1046, 0.18, 'triangle', 0.10), 180); // C6
      setTimeout(() => beep(1318, 0.13, 'triangle', 0.08), 320); // E6
    }
    
    // Forzar Jersey 10 font y anti-zoom despu√©s del renderizado
    setTimeout(() => {
      forceJerseyFont();
      applyMobileAntiZoom();
    }, 100);
  }

  /* ========= Controles ========= */
  // Inicializar controles despu√©s de que el DOM est√© listo
  function initializeControls() {
    // === DROPDOWNS ===
    
    // === SISTEMA DE NIVELES UNIFICADO ===
    const btnNiveles = document.getElementById('btnNiveles');
    const nivelesBox = document.getElementById('nivelesBox');
    const nivelesArrow = document.getElementById('nivelesArrow');
    
    // Elementos de cada nivel
    const btnNivel1 = document.getElementById('btnNivel1');
    const nivel1Box = document.getElementById('nivel1Box');
    const nivel1Arrow = document.getElementById('nivel1Arrow');
    
    const btnNivel2 = document.getElementById('btnNivel2');
    const nivel2Box = document.getElementById('nivel2Box');
    const nivel2Arrow = document.getElementById('nivel2Arrow');
    
    const btnNivel3 = document.getElementById('btnNivel3');
    const nivel3Box = document.getElementById('nivel3Box');
    const nivel3Arrow = document.getElementById('nivel3Arrow');
    
    // Funci√≥n para cerrar todos los sub-niveles
    function closeAllNiveles() {
      [nivel1Box, nivel2Box, nivel3Box].forEach(box => {
        if (box && !box.classList.contains('hidden')) {
          box.classList.add('hidden');
        }
      });
      [nivel1Arrow, nivel2Arrow, nivel3Arrow].forEach(arrow => {
        if (arrow) arrow.style.transform = 'rotate(0deg)';
      });
    }
    
    // Bot√≥n principal de Niveles
    if (btnNiveles && nivelesBox) {
      btnNiveles.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivelesBox.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar dropdown principal y todos los sub-niveles
          nivelesBox.classList.add('hidden');
          closeAllNiveles();
          if (nivelesArrow) nivelesArrow.style.transform = 'rotate(0deg)';
        } else {
          // Cerrar otros dropdowns principales antes de abrir este
          closeAllDropdowns(nivelesBox);
          // Abrir dropdown principal
          nivelesBox.classList.remove('hidden');
          if (nivelesArrow) nivelesArrow.style.transform = 'rotate(180deg)';
        }
      };
      
      // Cerrar cuando se hace click fuera
      document.addEventListener('click', (e) => {
        if (!nivelesBox.classList.contains('hidden')) {
          if (!nivelesBox.contains(e.target) && e.target !== btnNiveles) {
            nivelesBox.classList.add('hidden');
            closeAllNiveles();
            if (nivelesArrow) nivelesArrow.style.transform = 'rotate(0deg)';
          }
        }
      });
    }
    
    // Sub-dropdown Nivel 1
    if (btnNivel1 && nivel1Box) {
      btnNivel1.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !nivel1Box.classList.contains('hidden');
        
        // Cerrar otros niveles
        [nivel2Box, nivel3Box].forEach(box => {
          if (box && !box.classList.contains('hidden')) {
            box.classList.add('hidden');
          }
        });
        [nivel2Arrow, nivel3Arrow].forEach(arrow => {
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
        
        if (isOpen) {
          nivel1Box.classList.add('hidden');
          if (nivel1Arrow) nivel1Arrow.style.transform = 'rotate(0deg)';
        } else {
          nivel1Box.classList.remove('hidden');
          if (nivel1Arrow) nivel1Arrow.style.transform = 'rotate(180deg)';
          // Actualizar colores de progreso cuando se abre el nivel
          setTimeout(() => updateUnitProgressCounters(), 50);
        }
      };
    }
    
    // Sub-dropdown Nivel 2
    if (btnNivel2 && nivel2Box) {
      btnNivel2.onclick = (e) => {
        e.stopPropagation();
        
        // Verificar si el nivel 2 est√° desbloqueado (completando Cruzar el Mar)
        const isNivel2Unlocked = cruzarMarCompleted || nivel2Unlocked;
        
        console.log('üîç DEBUG btnNivel2 clicked - cruzarMarCompleted:', cruzarMarCompleted);
        console.log('üîç DEBUG - nivel2Unlocked:', nivel2Unlocked);
        console.log('üîç DEBUG - isNivel2Unlocked:', isNivel2Unlocked);
        
        if (!isNivel2Unlocked) {
          console.log('‚ùå Nivel 2 bloqueado, mostrando modal...');
          showLevel2LockedMessage();
          return;
        }
        
        console.log('‚úÖ Nivel 2 desbloqueado, abriendo dropdown...');
        
        const isOpen = !nivel2Box.classList.contains('hidden');
        
        // Cerrar otros niveles
        [nivel1Box, nivel3Box].forEach(box => {
          if (box && !box.classList.contains('hidden')) {
            box.classList.add('hidden');
          }
        });
        [nivel1Arrow, nivel3Arrow].forEach(arrow => {
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
        
        if (isOpen) {
          nivel2Box.classList.add('hidden');
          if (nivel2Arrow) nivel2Arrow.style.transform = 'rotate(0deg)';
        } else {
          nivel2Box.classList.remove('hidden');
          if (nivel2Arrow) nivel2Arrow.style.transform = 'rotate(180deg)';
          // Actualizar colores de progreso cuando se abre el nivel
          setTimeout(() => updateUnitProgressCounters(), 50);
        }
      };
    }
    
    // Sub-dropdown Nivel 3
    if (btnNivel3 && nivel3Box) {
      btnNivel3.onclick = (e) => {
        e.stopPropagation();
        
        // Verificar si el nivel 3 est√° desbloqueado
        if (!nivel3Unlocked) {
          showLevel3LockedMessage();
          return;
        }
        
        const isOpen = !nivel3Box.classList.contains('hidden');
        
        // Cerrar otros niveles
        [nivel1Box, nivel2Box].forEach(box => {
          if (box && !box.classList.contains('hidden')) {
            box.classList.add('hidden');
          }
        });
        [nivel1Arrow, nivel2Arrow].forEach(arrow => {
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
        
        if (isOpen) {
          nivel3Box.classList.add('hidden');
          if (nivel3Arrow) nivel3Arrow.style.transform = 'rotate(0deg)';
        } else {
          nivel3Box.classList.remove('hidden');
          if (nivel3Arrow) nivel3Arrow.style.transform = 'rotate(180deg)';
          // Actualizar colores de progreso cuando se abre el nivel
          setTimeout(() => updateUnitProgressCounters(), 50);
        }
      };
    }

    // Sub-dropdown HSK3
    const btnHSK3 = document.getElementById('btnHSK3');
    const HSK3Box = document.getElementById('HSK3Box');
    const HSK3Arrow = document.getElementById('HSK3Arrow');
    
    if (btnHSK3 && HSK3Box) {
      btnHSK3.onclick = (e) => {
        e.stopPropagation();
        
        // üîí VERIFICAR SI HSK EST√Å DESBLOQUEADO
        if (!hskUnlocked) {
          showHSKLockedModal();
          return;
        }
        
        const isOpen = !HSK3Box.classList.contains('hidden');
        
        // Cerrar otros niveles
        [nivel1Box, nivel2Box, nivel3Box, HSK4Box].forEach(box => {
          if (box && !box.classList.contains('hidden')) {
            box.classList.add('hidden');
          }
        });
        [nivel1Arrow, nivel2Arrow, nivel3Arrow, HSK4Arrow].forEach(arrow => {
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
        
        if (isOpen) {
          HSK3Box.classList.add('hidden');
          if (HSK3Arrow) HSK3Arrow.style.transform = 'rotate(0deg)';
        } else {
          HSK3Box.classList.remove('hidden');
          if (HSK3Arrow) HSK3Arrow.style.transform = 'rotate(180deg)';
          // Actualizar colores de progreso cuando se abre el nivel
          setTimeout(() => updateUnitProgressCounters(), 50);
        }
      };
    }

    // --- HSK4 dropdown ---
    const btnHSK4 = document.getElementById('btnHSK4');
    const HSK4Box = document.getElementById('HSK4Box');
    const HSK4Arrow = document.getElementById('HSK4Arrow');
    if(btnHSK4 && HSK4Box) {
      btnHSK4.onclick = (e) => {
        e.stopPropagation();
        
        // üîí VERIFICAR SI HSK EST√Å DESBLOQUEADO
        if (!hskUnlocked) {
          showHSKLockedModal();
          return;
        }
        
        const isOpen = !HSK4Box.classList.contains('hidden');
        
        // Cerrar otros niveles
        [nivel1Box, nivel2Box, nivel3Box, HSK3Box].forEach(box => {
          if (box && !box.classList.contains('hidden')) {
            box.classList.add('hidden');
          }
        });
        [nivel1Arrow, nivel2Arrow, nivel3Arrow, HSK3Arrow].forEach(arrow => {
          if (arrow) arrow.style.transform = 'rotate(0deg)';
        });
        
        if (isOpen) {
          HSK4Box.classList.add('hidden');
          if (HSK4Arrow) HSK4Arrow.style.transform = 'rotate(0deg)';
        } else {
          HSK4Box.classList.remove('hidden');
          if (HSK4Arrow) HSK4Arrow.style.transform = 'rotate(180deg)';
          // Actualizar colores de progreso cuando se abre el nivel
          setTimeout(() => updateUnitProgressCounters(), 50);
        }
      };
    }

    // --- Desaf√≠o dropdown ---
    const btnChallenge = document.getElementById('btnChallenge');
    const challengeBox = document.getElementById('challengeBox');
    const challengeArrow = document.getElementById('challengeArrow');
    if(btnChallenge && challengeBox) {
      btnChallenge.onclick = (e) => {
        e.stopPropagation();
        const isOpen = !challengeBox.classList.contains('hidden');
        
        if (isOpen) {
          // Cerrar
          challengeBox.classList.remove('opacity-100', 'scale-y-100');
          challengeBox.classList.add('opacity-0', 'scale-y-95');
          if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
          setTimeout(() => {
            challengeBox.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar todos los otros dropdowns antes de abrir este
          closeAllDropdowns(challengeBox);
          // Abrir
          challengeBox.classList.remove('hidden');
          setTimeout(() => {
            challengeBox.classList.remove('opacity-0', 'scale-y-95');
            challengeBox.classList.add('opacity-100', 'scale-y-100');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(180deg)';
          }, 10);
        }
      };
      
      // Cerrar dropdown al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!challengeBox.classList.contains('hidden')) {
          if (!challengeBox.contains(e.target) && e.target !== btnChallenge) {
            challengeBox.classList.remove('opacity-100', 'scale-y-100');
            challengeBox.classList.add('opacity-0', 'scale-y-95');
            if(challengeArrow) challengeArrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              challengeBox.classList.add('hidden');
            }, 300);
          }
        }
      });
    }
    
    // === BOTONES DE UNIDADES ===
    
    // Botones de unidades Nivel 1
    const btnUnit2 = document.getElementById('btnUnit2');
    if(btnUnit2) btnUnit2.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit2', () => startMission('unit2')); };
    const btnUnit3 = document.getElementById('btnUnit3');
    if(btnUnit3) btnUnit3.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit3', () => startMission('unit3')); };
    const btnUnit4 = document.getElementById('btnUnit4');
    if(btnUnit4) btnUnit4.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit4', () => startMission('unit4')); };
    const btnUnit5 = document.getElementById('btnUnit5');
    if(btnUnit5) btnUnit5.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit5', () => startMission('unit5')); };
    const btnUnit6 = document.getElementById('btnUnit6');
    if(btnUnit6) btnUnit6.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit6', () => startMission('unit6')); };
    const btnUnit7 = document.getElementById('btnUnit7');
    if(btnUnit7) btnUnit7.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit7', () => startMission('unit7')); };
    const btnUnit8 = document.getElementById('btnUnit8');
    if(btnUnit8) btnUnit8.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit8', () => startMission('unit8')); };
    const btnUnit9 = document.getElementById('btnUnit9');
    if(btnUnit9) btnUnit9.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); showUnitPreviewModal('unit9', () => startMission('unit9')); };
    
    // Botones especiales Nivel 1
    const btnTodoN1 = document.getElementById('btnTodoN1');
    if(btnTodoN1) btnTodoN1.onclick = () => { nivel1Box && nivel1Box.classList.add('hidden'); startMission('todoN1'); };
    const btnDesafioN1 = document.getElementById('btnDesafioN1');
    if(btnDesafioN1) btnDesafioN1.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN1 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN1', 'Nivel 1', 'acceso al Nivel 2'); 
    };
    
    // Botones de unidades Nivel 2
    const btnUnit1N2 = document.getElementById('btnUnit1N2');
    if(btnUnit1N2) btnUnit1N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit1N2', () => startMission('unit1N2')); };
    const btnUnit2N2 = document.getElementById('btnUnit2N2');
    if(btnUnit2N2) btnUnit2N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit2N2', () => startMission('unit2N2')); };
    const btnUnit3N2 = document.getElementById('btnUnit3N2');
    if(btnUnit3N2) btnUnit3N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit3N2', () => startMission('unit3N2')); };
    const btnUnit4N2 = document.getElementById('btnUnit4N2');
    if(btnUnit4N2) btnUnit4N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit4N2', () => startMission('unit4N2')); };
    const btnUnit5N2 = document.getElementById('btnUnit5N2');
    if(btnUnit5N2) btnUnit5N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit5N2', () => startMission('unit5N2')); };
    const btnUnit6N2 = document.getElementById('btnUnit6N2');
    if(btnUnit6N2) btnUnit6N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit6N2', () => startMission('unit6N2')); };
    const btnUnit7N2 = document.getElementById('btnUnit7N2');
    if(btnUnit7N2) btnUnit7N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit7N2', () => startMission('unit7N2')); };
    const btnUnit8N2 = document.getElementById('btnUnit8N2');
    if(btnUnit8N2) btnUnit8N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit8N2', () => startMission('unit8N2')); };
    const btnUnit9N2 = document.getElementById('btnUnit9N2');
    if(btnUnit9N2) btnUnit9N2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); showUnitPreviewModal('unit9N2', () => startMission('unit9N2')); };
    const btnTodoN2 = document.getElementById('btnTodoN2');
    if(btnTodoN2) btnTodoN2.onclick = () => { nivel2Box && nivel2Box.classList.add('hidden'); startMission('todoN2'); };
    const btnDesafioN2 = document.getElementById('btnDesafioN2');
    if(btnDesafioN2) btnDesafioN2.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN2 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN2', 'Nivel 2', 'acceso al Nivel 3 y Desaf√≠os del Hor√≥scopo'); 
    };
    
    // Botones de unidades Nivel 3
    const btnUnit1N3 = document.getElementById('btnUnit1N3');
    if(btnUnit1N3) btnUnit1N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit1N3', () => startMission('unit1N3')); };
    const btnUnit2N3 = document.getElementById('btnUnit2N3');
    if(btnUnit2N3) btnUnit2N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit2N3', () => startMission('unit2N3')); };
    const btnUnit3N3 = document.getElementById('btnUnit3N3');
    if(btnUnit3N3) btnUnit3N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit3N3', () => startMission('unit3N3')); };
    const btnUnit4N3 = document.getElementById('btnUnit4N3');
    if(btnUnit4N3) btnUnit4N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit4N3', () => startMission('unit4N3')); };
    const btnUnit5N3 = document.getElementById('btnUnit5N3');
    if(btnUnit5N3) btnUnit5N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit5N3', () => startMission('unit5N3')); };
    const btnUnit6N3 = document.getElementById('btnUnit6N3');
    if(btnUnit6N3) btnUnit6N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit6N3', () => startMission('unit6N3')); };
    const btnUnit7N3 = document.getElementById('btnUnit7N3');
    if(btnUnit7N3) btnUnit7N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit7N3', () => startMission('unit7N3')); };
    const btnUnit8N3 = document.getElementById('btnUnit8N3');
    if(btnUnit8N3) btnUnit8N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit8N3', () => startMission('unit8N3')); };
    const btnUnit9N3 = document.getElementById('btnUnit9N3');
    if(btnUnit9N3) btnUnit9N3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); showUnitPreviewModal('unit9N3', () => startMission('unit9N3')); };
    const btnTodoN3 = document.getElementById('btnTodoN3');
    if(btnTodoN3) btnTodoN3.onclick = () => { nivel3Box && nivel3Box.classList.add('hidden'); startMission('todoN3'); };
    const btnDesafioN3 = document.getElementById('btnDesafioN3');
    if(btnDesafioN3) btnDesafioN3.onclick = () => { 
      console.log('üîÑ DEBUG: btnDesafioN3 click (segunda asignaci√≥n)');
      showDesafioNNotification('desafioN3', 'Nivel 3', 'Pr√≥ximo Nivel (Pr√≥ximamente)'); 
    };
    
    // Botones HSK3
    const btnHSK3unit1 = document.getElementById('btnHSK3unit1');
    if(btnHSK3unit1) btnHSK3unit1.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit1', () => startMission('HSK3unit1')); };
    const btnHSK3unit2 = document.getElementById('btnHSK3unit2');
    if(btnHSK3unit2) btnHSK3unit2.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit2', () => startMission('HSK3unit2')); };
    const btnHSK3unit3 = document.getElementById('btnHSK3unit3');
    if(btnHSK3unit3) btnHSK3unit3.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit3', () => startMission('HSK3unit3')); };
    const btnHSK3unit4 = document.getElementById('btnHSK3unit4');
    if(btnHSK3unit4) btnHSK3unit4.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit4', () => startMission('HSK3unit4')); };
    const btnHSK3unit5 = document.getElementById('btnHSK3unit5');
    if(btnHSK3unit5) btnHSK3unit5.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit5', () => startMission('HSK3unit5')); };
    const btnHSK3unit6 = document.getElementById('btnHSK3unit6');
    if(btnHSK3unit6) btnHSK3unit6.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit6', () => startMission('HSK3unit6')); };
    const btnHSK3unit7 = document.getElementById('btnHSK3unit7');
    if(btnHSK3unit7) btnHSK3unit7.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit7', () => startMission('HSK3unit7')); };
    const btnHSK3unit8 = document.getElementById('btnHSK3unit8');
    if(btnHSK3unit8) btnHSK3unit8.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit8', () => startMission('HSK3unit8')); };
    const btnHSK3unit9 = document.getElementById('btnHSK3unit9');
    if(btnHSK3unit9) btnHSK3unit9.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit9', () => startMission('HSK3unit9')); };
    const btnHSK3unit10 = document.getElementById('btnHSK3unit10');
    if(btnHSK3unit10) btnHSK3unit10.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit10', () => startMission('HSK3unit10')); };
    const btnHSK3unit11 = document.getElementById('btnHSK3unit11');
    if(btnHSK3unit11) btnHSK3unit11.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit11', () => startMission('HSK3unit11')); };
    const btnHSK3unit12 = document.getElementById('btnHSK3unit12');
    if(btnHSK3unit12) btnHSK3unit12.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit12', () => startMission('HSK3unit12')); };
    const btnHSK3unit13 = document.getElementById('btnHSK3unit13');
    if(btnHSK3unit13) btnHSK3unit13.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit13', () => startMission('HSK3unit13')); };
    const btnHSK3unit14 = document.getElementById('btnHSK3unit14');
    if(btnHSK3unit14) btnHSK3unit14.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit14', () => startMission('HSK3unit14')); };
    const btnHSK3unit15 = document.getElementById('btnHSK3unit15');
    if(btnHSK3unit15) btnHSK3unit15.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit15', () => startMission('HSK3unit15')); };
    const btnHSK3unit16 = document.getElementById('btnHSK3unit16');
    if(btnHSK3unit16) btnHSK3unit16.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit16', () => startMission('HSK3unit16')); };
    const btnHSK3unit17 = document.getElementById('btnHSK3unit17');
    if(btnHSK3unit17) btnHSK3unit17.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit17', () => startMission('HSK3unit17')); };
    const btnHSK3unit18 = document.getElementById('btnHSK3unit18');
    if(btnHSK3unit18) btnHSK3unit18.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit18', () => startMission('HSK3unit18')); };
    const btnHSK3unit19 = document.getElementById('btnHSK3unit19');
    if(btnHSK3unit19) btnHSK3unit19.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit19', () => startMission('HSK3unit19')); };
    const btnHSK3unit20 = document.getElementById('btnHSK3unit20');
    if(btnHSK3unit20) btnHSK3unit20.onclick = () => { HSK3Box && HSK3Box.classList.add('hidden'); showUnitPreviewModal('HSK3unit20', () => startMission('HSK3unit20')); };
    
    // Botones de unidades HSK4
    const btnHSK4unit1 = document.getElementById('btnHSK4unit1');
    if(btnHSK4unit1) btnHSK4unit1.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit1', () => startMission('HSK4unit1')); };
    const btnHSK4unit2 = document.getElementById('btnHSK4unit2');
    if(btnHSK4unit2) btnHSK4unit2.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit2', () => startMission('HSK4unit2')); };
    const btnHSK4unit3 = document.getElementById('btnHSK4unit3');
    if(btnHSK4unit3) btnHSK4unit3.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit3', () => startMission('HSK4unit3')); };
    const btnHSK4unit4 = document.getElementById('btnHSK4unit4');
    if(btnHSK4unit4) btnHSK4unit4.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit4', () => startMission('HSK4unit4')); };
    const btnHSK4unit5 = document.getElementById('btnHSK4unit5');
    if(btnHSK4unit5) btnHSK4unit5.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit5', () => startMission('HSK4unit5')); };
    const btnHSK4unit6 = document.getElementById('btnHSK4unit6');
    if(btnHSK4unit6) btnHSK4unit6.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit6', () => startMission('HSK4unit6')); };
    const btnHSK4unit7 = document.getElementById('btnHSK4unit7');
    if(btnHSK4unit7) btnHSK4unit7.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit7', () => startMission('HSK4unit7')); };
    const btnHSK4unit8 = document.getElementById('btnHSK4unit8');
    if(btnHSK4unit8) btnHSK4unit8.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit8', () => startMission('HSK4unit8')); };
    const btnHSK4unit9 = document.getElementById('btnHSK4unit9');
    if(btnHSK4unit9) btnHSK4unit9.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit9', () => startMission('HSK4unit9')); };
    const btnHSK4unit10 = document.getElementById('btnHSK4unit10');
    if(btnHSK4unit10) btnHSK4unit10.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit10', () => startMission('HSK4unit10')); };
    const btnHSK4unit11 = document.getElementById('btnHSK4unit11');
    if(btnHSK4unit11) btnHSK4unit11.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit11', () => startMission('HSK4unit11')); };
    const btnHSK4unit12 = document.getElementById('btnHSK4unit12');
    if(btnHSK4unit12) btnHSK4unit12.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit12', () => startMission('HSK4unit12')); };
    const btnHSK4unit13 = document.getElementById('btnHSK4unit13');
    if(btnHSK4unit13) btnHSK4unit13.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit13', () => startMission('HSK4unit13')); };
    const btnHSK4unit14 = document.getElementById('btnHSK4unit14');
    if(btnHSK4unit14) btnHSK4unit14.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit14', () => startMission('HSK4unit14')); };
    const btnHSK4unit15 = document.getElementById('btnHSK4unit15');
    if(btnHSK4unit15) btnHSK4unit15.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit15', () => startMission('HSK4unit15')); };
    const btnHSK4unit16 = document.getElementById('btnHSK4unit16');
    if(btnHSK4unit16) btnHSK4unit16.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit16', () => startMission('HSK4unit16')); };
    const btnHSK4unit17 = document.getElementById('btnHSK4unit17');
    if(btnHSK4unit17) btnHSK4unit17.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit17', () => startMission('HSK4unit17')); };
    const btnHSK4unit18 = document.getElementById('btnHSK4unit18');
    if(btnHSK4unit18) btnHSK4unit18.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit18', () => startMission('HSK4unit18')); };
    const btnHSK4unit19 = document.getElementById('btnHSK4unit19');
    if(btnHSK4unit19) btnHSK4unit19.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit19', () => startMission('HSK4unit19')); };
    const btnHSK4unit20 = document.getElementById('btnHSK4unit20');
    if(btnHSK4unit20) btnHSK4unit20.onclick = () => { HSK4Box && HSK4Box.classList.add('hidden'); showUnitPreviewModal('HSK4unit20', () => startMission('HSK4unit20')); };
    
    // Botones de desaf√≠o
    const btnDesafioClassico = document.getElementById('btnDesafioClassico');
    if(btnDesafioClassico) btnDesafioClassico.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); showDesafioClassicoInfoModal(); };
    const btnDesafioMenos = document.getElementById('btnDesafioMenos');
    if(btnDesafioMenos) btnDesafioMenos.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); showDesafioNivel01InfoModal(); };
    const btnDesafioMas = document.getElementById('btnDesafioMas');
    if(btnDesafioMas) btnDesafioMas.onclick = () => { challengeBox && challengeBox.classList.add('hidden'); showDesafioNivel2PlusInfoModal(); };

    // Bot√≥n de 12 Bestias
    const btnBestias12 = document.getElementById('btnBestias12');
    if(btnBestias12) btnBestias12.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showBestias12InfoModal(); 
    };

    // Bot√≥n de La Emperatriz
    const btnLaEmperatriz = document.getElementById('btnLaEmperatriz');
    if(btnLaEmperatriz) btnLaEmperatriz.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showEmperatrizInfoModal(); 
    };
    
    // Bot√≥n de Cruzar el Mar
    const btnCruzarMar = document.getElementById('btnCruzarMar');
    if(btnCruzarMar) btnCruzarMar.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showCruzarMarInfoModal(); 
    };
    
    // Bot√≥n Cruzar el Cielo
    const btnCruzarCielo = document.getElementById('btnCruzarCielo');
    if(btnCruzarCielo) btnCruzarCielo.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showCruzarCieloInfoModal(); 
    };
    
    // Bot√≥n Cruzar HSK3
    const btnCruzarHSK3 = document.getElementById('btnCruzarHSK3');
    if(btnCruzarHSK3) btnCruzarHSK3.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showCruzarHSK3InfoModal(); 
    };
    
    // Bot√≥n Cruzar HSK4
    const btnCruzarHSK4 = document.getElementById('btnCruzarHSK4');
    if(btnCruzarHSK4) btnCruzarHSK4.onclick = () => {
      // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
      if (false) {
        showHSKLockedModal();
        return;
      }
      
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showCruzarHSK4InfoModal(); 
    };
    
    // Funci√≥n para cerrar todos los grids
    // Funci√≥n unificada para cerrar TODOS los dropdowns
    function closeAllDropdowns(except = null) {
      // Lista de todos los dropdowns del sistema
      const allDropdowns = [
        // Dropdown principal de Niveles
        { box: document.getElementById('nivelesBox'), arrow: document.getElementById('nivelesArrow'), type: 'simple' },
        // Sub-niveles (simples, sin animaciones complejas)
        { box: document.getElementById('nivel1Box'), arrow: document.getElementById('nivel1Arrow'), type: 'simple' },
        { box: document.getElementById('nivel2Box'), arrow: document.getElementById('nivel2Arrow'), type: 'simple' },
        { box: document.getElementById('nivel3Box'), arrow: document.getElementById('nivel3Arrow'), type: 'simple' },
        { box: document.getElementById('HSK3Box'), arrow: document.getElementById('HSK3Arrow'), type: 'simple' },
        { box: document.getElementById('HSK4Box'), arrow: document.getElementById('HSK4Arrow'), type: 'simple' },
        // Desaf√≠o (usa formato opacity/scale) 
        { box: document.getElementById('challengeBox'), arrow: null, type: 'level' },
        // Hor√≥scopo (usa formato style.opacity/transform)
        { box: document.getElementById('horoscopoBox'), arrow: null, type: 'horoscope' },
        { box: document.getElementById('desafiosHoroscopoBox'), arrow: null, type: 'horoscope' }
      ];
      
      allDropdowns.forEach(dropdown => {
        if (dropdown.box && dropdown.box !== except && !dropdown.box.classList.contains('hidden')) {
          if (dropdown.type === 'simple') {
            // Formato simple para nuevo sistema de niveles
            dropdown.box.classList.add('hidden');
            if (dropdown.arrow) dropdown.arrow.style.transform = 'rotate(0deg)';
          } else if (dropdown.type === 'level') {
            // Formato para desaf√≠o
            dropdown.box.classList.remove('opacity-100', 'scale-y-100');
            dropdown.box.classList.add('opacity-0', 'scale-y-95');
            if (dropdown.arrow) dropdown.arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              dropdown.box.classList.add('hidden');
            }, 300);
          } else if (dropdown.type === 'horoscope') {
            // Formato para hor√≥scopo
            dropdown.box.style.opacity = '0';
            dropdown.box.style.transform = 'scaleY(0.95)';
            if (dropdown.arrow) dropdown.arrow.style.transform = 'rotate(0deg)';
            setTimeout(() => {
              dropdown.box.classList.add('hidden');
            }, 300);
          }
        }
      });
    }

    // Funciones de compatibilidad (para no romper c√≥digo existente)
    function closeAllGrids(except = null) {
      closeAllDropdowns(except);
    }
    
    function closeAllLevelGrids(except = null) {
      closeAllDropdowns(except);
    }
    
    // === MODAL DE DONACI√ìN ===
    const btnDonation = document.getElementById('btnDonation');
    const donationModal = document.getElementById('donationModal');
    const donationArrow = document.getElementById('donationArrow');
    
    if (btnDonation && donationModal && donationArrow) {
      btnDonation.onclick = (e) => {
        e.stopPropagation();
        
        const isVisible = !donationModal.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          donationModal.classList.add('hidden');
          donationArrow.style.transform = 'rotate(0deg)';
        } else {
          // Abrir
          donationModal.classList.remove('hidden');
          donationArrow.style.transform = 'rotate(180deg)';
        }
      };
      
      // Cerrar modal al hacer click fuera
      document.addEventListener('click', (e) => {
        if (!donationModal.classList.contains('hidden')) {
          if (!donationModal.contains(e.target) && e.target !== btnDonation) {
            donationModal.classList.add('hidden');
            donationArrow.style.transform = 'rotate(0deg)';
          }
        }
      });
    }
    
    // HOR√ìSCOPO - Bot√≥n principal y dropdown
    const btnHoroscopo = document.getElementById('btnHoroscopo');
    const horoscopoBox = document.getElementById('horoscopoBox');
    // const horoscopoArrow = document.getElementById('horoscopoArrow'); // ELIMINADO: No hay flecha

    if (btnHoroscopo && horoscopoBox) {
      btnHoroscopo.onclick = (e) => {
        e.stopPropagation();
        
        // ‚úÖ SIN REQUISITOS - Siempre disponible
        
        const isVisible = !horoscopoBox.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          horoscopoBox.style.opacity = '0';
          horoscopoBox.style.transform = 'scaleY(0.95)';
          // horoscopoArrow.style.transform = 'rotate(0deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            horoscopoBox.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids antes de abrir este
          closeAllDropdowns(horoscopoBox);
          // Abrir
          horoscopoBox.classList.remove('hidden');
          // horoscopoArrow.style.transform = 'rotate(180deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            horoscopoBox.style.opacity = '1';
            horoscopoBox.style.transform = 'scaleY(1)';
          }, 10);
        }
      };
      
      // Cerrar cuando se hace click fuera
      document.addEventListener('click', (e) => {
        if (!btnHoroscopo.contains(e.target) && !horoscopoBox.contains(e.target)) {
          horoscopoBox.style.opacity = '0';
          horoscopoBox.style.transform = 'scaleY(0.95)';
          // horoscopoArrow.style.transform = 'rotate(0deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            horoscopoBox.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // HOR√ìSCOPO - Botones de animales
    const btnRata = document.getElementById('btnRata');
    if(btnRata) btnRata.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('colores', () => startMission('colores')); };
    const btnGallo = document.getElementById('btnGallo');
    if(btnGallo) btnGallo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('fruta', () => startMission('fruta')); };
    const btnConejo = document.getElementById('btnConejo');
    if(btnConejo) btnConejo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('verduras', () => startMission('verduras')); };
    const btnCerdo = document.getElementById('btnCerdo');
    if(btnCerdo) btnCerdo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('comidas', () => startMission('comidas')); };
    const btnPerro = document.getElementById('btnPerro');
    if(btnPerro) btnPerro.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('animales', () => startMission('animales')); };
    const btnCaballo = document.getElementById('btnCaballo');
    if(btnCaballo) btnCaballo.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('deportes', () => startMission('deportes')); };
    const btnBuey = document.getElementById('btnBuey');
    if(btnBuey) btnBuey.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('hobbies', () => startMission('hobbies')); };
    const btnCabra = document.getElementById('btnCabra');
    if(btnCabra) btnCabra.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('ropa', () => startMission('ropa')); };
    const btnSerpiente = document.getElementById('btnSerpiente');
    if(btnSerpiente) btnSerpiente.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('casa', () => startMission('casa')); };
    const btnMono = document.getElementById('btnMono');
    if(btnMono) btnMono.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('cuerpo', () => startMission('cuerpo')); };
    const btnTigre = document.getElementById('btnTigre');
    if(btnTigre) btnTigre.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('profesiones', () => startMission('profesiones')); };
    const btnDragon = document.getElementById('btnDragon');
    if(btnDragon) btnDragon.onclick = () => { horoscopoBox && horoscopoBox.classList.add('hidden'); showUnitPreviewModal('emociones', () => startMission('emociones')); };
    
    // DESAF√çOS DEL HOR√ìSCOPO - Bot√≥n principal y dropdown
    const btnDesafiosHoroscopo = document.getElementById('btnDesafiosHoroscopo');
    const desafiosHoroscopoBox = document.getElementById('desafiosHoroscopoBox');
    // const desafiosHoroscopoArrow = document.getElementById('desafiosHoroscopoArrow'); // ELIMINADO: No hay flecha

    if (btnDesafiosHoroscopo && desafiosHoroscopoBox) {
      btnDesafiosHoroscopo.onclick = (e) => {
        e.stopPropagation();
        
        // CAMBIO: Ahora siempre se puede abrir el dropdown
        // Los animales individuales verificar√°n si est√°n desbloqueados
        
        const isVisible = !desafiosHoroscopoBox.classList.contains('hidden');
        
        if (isVisible) {
          // Cerrar
          desafiosHoroscopoBox.style.opacity = '0';
          desafiosHoroscopoBox.style.transform = 'scaleY(0.95)';
          // desafiosHoroscopoArrow.style.transform = 'rotate(0deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            desafiosHoroscopoBox.classList.add('hidden');
          }, 300);
        } else {
          // Cerrar otros grids antes de abrir este
          closeAllDropdowns(desafiosHoroscopoBox);
          // Abrir
          desafiosHoroscopoBox.classList.remove('hidden');
          // desafiosHoroscopoArrow.style.transform = 'rotate(180deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            desafiosHoroscopoBox.style.opacity = '1';
            desafiosHoroscopoBox.style.transform = 'scaleY(1)';
          }, 10);
        }
      };
      
      // Cerrar cuando se hace click fuera
      document.addEventListener('click', (e) => {
        if (!btnDesafiosHoroscopo.contains(e.target) && !desafiosHoroscopoBox.contains(e.target)) {
          desafiosHoroscopoBox.style.opacity = '0';
          desafiosHoroscopoBox.style.transform = 'scaleY(0.95)';
          // desafiosHoroscopoArrow.style.transform = 'rotate(0deg)'; // ELIMINADO: No hay flecha
          setTimeout(() => {
            desafiosHoroscopoBox.classList.add('hidden');
          }, 300);
        }
      });
    }
    
    // ========= NUEVO: Bot√≥n "Los Hor√≥scopo" - Expansor/Colapsor de animales =========
    const btnLosHoroscopo = document.getElementById('btnLosHoroscopo');
    const losHoroscopoContainer = document.getElementById('losHoroscopoContainer');
    const losHoroscopoArrow = document.getElementById('losHoroscopoArrow');
    
    if (btnLosHoroscopo && losHoroscopoContainer && losHoroscopoArrow) {
      let isExpanded = false;
      
      // Funci√≥n para actualizar el estado visual del bot√≥n
      function updateLosHoroscopoButton() {
        // ‚úÖ SIN REQUISITOS - Siempre desbloqueado
        btnLosHoroscopo.disabled = false;
        btnLosHoroscopo.style.opacity = '1';
        btnLosHoroscopo.style.cursor = 'pointer';
        btnLosHoroscopo.style.filter = 'none';
        
        // Remover candado si existe
        const lockIcon = btnLosHoroscopo.querySelector('.lock-icon');
        if(lockIcon) {
          lockIcon.remove();
        }
        
        // Restaurar contenido sin candado
        btnLosHoroscopo.innerHTML = 'LOS 12 HOR√ìSCOPOS <span id="losHoroscopoArrow" class="inline-block transition-transform duration-300 ml-1">‚ñº</span><br><span style="font-size: 0.7em; color: #e9d5ff;">12 desaf√≠os tem√°ticos ‚Ä¢ Cruzar el Cielo</span>';
        console.log('‚úÖ Los Hor√≥scopo siempre desbloqueado');
        // Re-obtener la referencia a la flecha despu√©s de cambiar innerHTML
        const arrowElement = document.getElementById('losHoroscopoArrow');
        if (arrowElement && isExpanded) {
          arrowElement.style.transform = 'rotate(180deg)';
        }
      }
      
      // Actualizar estado inicial
      updateLosHoroscopoButton();
      
      btnLosHoroscopo.onclick = (e) => {
        e.stopPropagation();
        
        // ‚úÖ SIN REQUISITOS - Siempre disponible
        console.log('üåü Toggle Los Hor√≥scopo, estado actual:', isExpanded ? 'expandido' : 'colapsado');
        
        const arrowElement = document.getElementById('losHoroscopoArrow');
        if (isExpanded) {
          // Colapsar
          losHoroscopoContainer.style.maxHeight = '0';
          losHoroscopoContainer.style.opacity = '0';
          if (arrowElement) arrowElement.style.transform = 'rotate(0deg)';
          isExpanded = false;
        } else {
          // Expandir
          losHoroscopoContainer.style.maxHeight = '800px'; // Altura suficiente para 12 botones
          losHoroscopoContainer.style.opacity = '1';
          if (arrowElement) arrowElement.style.transform = 'rotate(180deg)';
          isExpanded = true;
        }
      };
      
      // Exponer funci√≥n para actualizar desde otras partes del c√≥digo
      window.updateLosHoroscopoButton = updateLosHoroscopoButton;
    }
    
    // DESAF√çOS DEL HOR√ìSCOPO - Botones de animales (desaf√≠os especializados)
    
    // Funci√≥n para manejar clicks de animales del hor√≥scopo con verificaci√≥n de desbloqueo
    function handleHoroscopeAnimalClick(category, buttonName) {
      // ‚úÖ REQUISITOS ELIMINADOS - SIEMPRE DISPONIBLE
      console.log(`üîç DEBUG: Click en ${buttonName}`);
      desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden'); 
      showHoroscopeModal(category);
    }
    
    const btnDesafioRata = document.getElementById('btnDesafioRata');
    console.log('üîç DEBUG btnDesafioRata:', btnDesafioRata);
    if(btnDesafioRata) {
      btnDesafioRata.onclick = () => handleHoroscopeAnimalClick('colores', 'btnDesafioRata');
    }
    
    // Bot√≥n Desaf√≠o Final
    const btnDesafioFinal = document.getElementById('btnDesafioFinal');
    if(btnDesafioFinal) {
      btnDesafioFinal.onclick = () => {
        console.log('üèÜ Clic en Desaf√≠o Final desde grid');
        
        // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE
        
        // Si est√° desbloqueado, continuar normalmente
        desafiosHoroscopoBox && desafiosHoroscopoBox.classList.add('hidden');
        
        try {
          startUltimateChallenge();
        } catch (error) {
          console.error('Error:', error);
        }
      };
      // Actualizar visibilidad inicial
      updateUltimateChallengeButton();
      console.log('üèÜ Bot√≥n Desaf√≠o Final configurado');
    } else {
      console.error('‚ö†Ô∏è btnDesafioFinal no encontrado');
    }
    const btnDesafioGallo = document.getElementById('btnDesafioGallo');
    if(btnDesafioGallo) btnDesafioGallo.onclick = () => handleHoroscopeAnimalClick('fruta', 'btnDesafioGallo');
    const btnDesafioConejo = document.getElementById('btnDesafioConejo');
    if(btnDesafioConejo) btnDesafioConejo.onclick = () => handleHoroscopeAnimalClick('verduras', 'btnDesafioConejo');
    const btnDesafioCerdo = document.getElementById('btnDesafioCerdo');
    if(btnDesafioCerdo) btnDesafioCerdo.onclick = () => handleHoroscopeAnimalClick('comidas', 'btnDesafioCerdo');
    const btnDesafioPerro = document.getElementById('btnDesafioPerro');
    if(btnDesafioPerro) btnDesafioPerro.onclick = () => handleHoroscopeAnimalClick('animales', 'btnDesafioPerro');
    const btnDesafioCaballo = document.getElementById('btnDesafioCaballo');
    if(btnDesafioCaballo) btnDesafioCaballo.onclick = () => handleHoroscopeAnimalClick('deportes', 'btnDesafioCaballo');
    const btnDesafioBuey = document.getElementById('btnDesafioBuey');
    if(btnDesafioBuey) btnDesafioBuey.onclick = () => handleHoroscopeAnimalClick('hobbies', 'btnDesafioBuey');
    const btnDesafioCabra = document.getElementById('btnDesafioCabra');
    if(btnDesafioCabra) btnDesafioCabra.onclick = () => handleHoroscopeAnimalClick('ropa', 'btnDesafioCabra');
    const btnDesafioSerpiente = document.getElementById('btnDesafioSerpiente');
    if(btnDesafioSerpiente) btnDesafioSerpiente.onclick = () => handleHoroscopeAnimalClick('casa', 'btnDesafioSerpiente');
    const btnDesafioMono = document.getElementById('btnDesafioMono');
    if(btnDesafioMono) btnDesafioMono.onclick = () => handleHoroscopeAnimalClick('cuerpo', 'btnDesafioMono');
    const btnDesafioTigre = document.getElementById('btnDesafioTigre');
    if(btnDesafioTigre) btnDesafioTigre.onclick = () => handleHoroscopeAnimalClick('profesiones', 'btnDesafioTigre');
    const btnDesafioDragon = document.getElementById('btnDesafioDragon');
    if(btnDesafioDragon) btnDesafioDragon.onclick = () => handleHoroscopeAnimalClick('emociones', 'btnDesafioDragon');
  }

  document.getElementById('btnKnown').onclick   = () => {
    // üî¥ CHECKPOINT: Guardar antes de entrar a "Conocidas"
    console.log(`üî¥ CHECKPOINT [btnKnown]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
    SaveQueue.flush();
    startMission('known');
  };
  // Funci√≥n para actualizar estilos de botones de filtro de Mi Colecci√≥n
  function updateCategoryFilterButtonStyles() {
    const buttons = [
      { id: 'btnCatAll', value: 'ALL' },
      { id: 'btnCatS', value: 'S' },
      { id: 'btnCatA', value: 'A' },
      { id: 'btnCatV', value: 'V' },
      { id: 'btnCatP', value: 'P' },
      { id: 'btnCatE', value: 'E' }
    ];
    
    buttons.forEach(btn => {
      const element = document.getElementById(btn.id);
      if (element) {
        if (knownCatFilter === btn.value) {
          // Bot√≥n seleccionado: agregar glow dorado
          element.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.8), 0 0 25px rgba(255, 215, 0, 0.4)';
          element.style.transform = 'scale(1.05)';
          element.style.opacity = '1';
        } else {
          // Bot√≥n no seleccionado: estilo normal
          element.style.boxShadow = '';
          element.style.transform = 'scale(1)';
          element.style.opacity = '0.8';
        }
      }
    });
  }

  // Filtros de categor√≠a para la tabla de conocidos
  document.getElementById('btnCatAll').onclick = () => { knownCatFilter = 'ALL'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnCatS').onclick   = () => { knownCatFilter = 'S'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnCatA').onclick   = () => { knownCatFilter = 'A'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnCatV').onclick   = () => { knownCatFilter = 'V'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnCatP').onclick   = () => { knownCatFilter = 'P'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnCatE').onclick   = () => { knownCatFilter = 'E'; updateCategoryFilterButtonStyles(); showKnownTableWithAnimations(); };
  document.getElementById('btnRevise1').onclick = () => {
    // üî¥ CHECKPOINT: Guardar antes de entrar a "Repasar"
    console.log(`üî¥ CHECKPOINT [btnRevise1]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
    SaveQueue.flush();
    startMission('revise1');
  };
  document.getElementById('btnRevise2').onclick = () => {
    // üî¥ CHECKPOINT: Guardar antes de entrar a "Confirmar"
    console.log(`üî¥ CHECKPOINT [btnRevise2]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
    SaveQueue.flush();
    startMission('revise2');
  };

  // btnChallenge onclick manejado por dropdown m√°s abajo
  document.getElementById('btnQuizPinyin').onclick  = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizPinyin');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset adicional para Android - asegurar que la barra quede arriba
        setTimeout(() => {
          const rect = xpElement.getBoundingClientRect();
          const offset = rect.top - 10; // 10px de margen superior
          if (offset !== 0) {
            window.scrollBy({ top: offset, behavior: 'smooth' });
          }
        }, 400);
      }
    }, 100);
  };
  document.getElementById('btnQuizMeaning').onclick = () => {
    // LIMPIAR CLASES DE DESAF√çO
    clearAllChallengeThemes();
    stopDesafioMusic();
    setMode('quizMeaning');
    // AUTO-SCROLL AL √ÅREA DE JUEGO - REFERENCIA: BARRA XP  
    setTimeout(() => {
      const xpElement = document.getElementById('xpBarWrap');
      if (xpElement) {
        xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Offset adicional para Android - asegurar que la barra quede arriba
        setTimeout(() => {
          const rect = xpElement.getBoundingClientRect();
          const offset = rect.top - 10; // 10px de margen superior
          if (offset !== 0) {
            window.scrollBy({ top: offset, behavior: 'smooth' });
          }
        }, 400);
      }
    }, 100);
  };

  document.getElementById('btnKnownTable').onclick = () => {
    // üî¥ CHECKPOINT: Guardar antes de abrir "Mi Colecci√≥n"
    console.log(`üî¥ CHECKPOINT [btnKnownTable]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
    SaveQueue.flush();
    
    if (currentMission === 'challenge' || 
        currentMission === 'desafioN1' || 
        currentMission === 'desafioN2' || 
        currentMission === 'desafioN3' || 
        currentMission === 'colores' ||
        currentMission === 'fruta' ||
        currentMission === 'verduras' ||
        currentMission === 'comidas' ||
        currentMission === 'animales' ||
        currentMission === 'deportes' ||
        currentMission === 'hobbies' ||
        currentMission === 'ropa' ||
        currentMission === 'casa' ||
        currentMission === 'cuerpo' ||
        currentMission === 'profesiones' ||
        currentMission === 'emociones' ||
        currentMission === 'desafioColores' ||
        currentMission === 'desafioFruta' ||
        currentMission === 'desafioVerduras' ||
        currentMission === 'desafioComidas' ||
        currentMission === 'desafioAnimales' ||
        currentMission === 'desafioDeportes' ||
        currentMission === 'desafioHobbies' ||
        currentMission === 'desafioRopa' ||
        currentMission === 'desafioCasa' ||
        currentMission === 'desafioCuerpo' ||
        currentMission === 'desafioProfesiones' ||
        currentMission === 'desafioEmociones' ||
        currentMission === 'ultimateChallenge' ||
        ultimateChallengeActive) {
      
      console.log('üö™ SALIENDO del modo desaf√≠o para ver Tabla Conocidas');
      console.log('- currentMission antes:', currentMission);
      console.log('- ultimateChallengeActive antes:', ultimateChallengeActive);
      console.log('- ¬øEs desaf√≠o hor√≥scopo?', currentMission && currentMission.startsWith('desafio'));
      
      // GUARDAR EL MODO ORIGINAL ANTES DE CAMBIAR
      const originalMission = currentMission;
      const wasUltimateChallengeActive = ultimateChallengeActive;
      
      // RESET PARCIAL - cambiar misi√≥n pero recordar el estado original para statBox
      currentMission = 'known'; // Cambiar a modo normal para tabla conocidas
      ultimateChallengeActive = false; // Desactivar Ultimate Challenge temporalmente
      
      // ACTUALIZAR VISIBILIDAD DE BOTONES DE QUIZ
      updateQuizButtonsVisibility('known');
      
      // Limpiar estado de desaf√≠o completamente
      sessionQueue = [];
      sessionCorrect = 0;
      sessionTotal = 0;
      currentCard = null;
      todayReviewed = 0;
      
      // Limpiar clases visuales de desaf√≠o
      clearAllChallengeThemes();
      stopDesafioMusic();
      
      // Ocultar corazones y timer del Ultimate Challenge si est√°n visibles
      hideUltimateChallengeHearts();
      stopUltimateChallengeTimer();
      
      // OCULTAR LA TARJETA ACTUAL pero mantener statBox en desaf√≠os
      const gameBox = document.getElementById('gameBox');
      const statBox = document.getElementById('statBox');
      console.log('üéØ DEBUG: Ocultando gameBox, manteniendo statBox para desaf√≠os');
      
      // Siempre ocultar gameBox (las cartas)
      if (gameBox) {
        gameBox.style.display = 'none';
        console.log('‚úÖ gameBox ocultado');
      }
      
      // Solo ocultar statBox si NO era un desaf√≠o en curso (usar estado original)
      // En desaf√≠os, el usuario debe poder ver el estado actual
      const isChallenge = (
        originalMission === 'challenge' || 
        originalMission === 'desafioN1' || 
        originalMission === 'desafioN2' || 
        originalMission === 'desafioN3' || 
        originalMission.startsWith('desafio') ||
        originalMission === 'ultimateChallenge' ||
        wasUltimateChallengeActive
      );
      
      console.log('üîç DEBUG STATBOX:');
      console.log('- originalMission:', originalMission);
      console.log('- currentMission (ahora):', currentMission);
      console.log('- wasUltimateChallengeActive:', wasUltimateChallengeActive);
      console.log('- ultimateChallengeActive (ahora):', ultimateChallengeActive);
      console.log('- isChallenge:', isChallenge);
      console.log('- statBox existe:', !!statBox);
      
      if (statBox && !isChallenge) {
        statBox.style.display = 'none';
        console.log('‚úÖ statBox ocultado (no es desaf√≠o)');
      } else if (statBox) {
        statBox.style.display = '';
        console.log('üìä statBox mantenido visible (es desaf√≠o)');
      }
      
      // MOSTRAR SECCIONES NORMALES Y UI ELEMENTOS
      showUIElementsForNormalMode();
      const knownTableSection = document.querySelector('section.mt-16');
      console.log('üéØ DEBUG: Mostrando secci√≥n tabla conocidas:', knownTableSection);
      if (knownTableSection) {
        knownTableSection.style.display = 'block';
        console.log('‚úÖ Secci√≥n tabla conocidas mostrada');
      }
      
      // FORZAR MOSTRAR TABLA CONOCIDAS
      overlayField = 'hanzi';
      console.log('üéØ DEBUG: Llamando showKnownTableWithAnimations()');
      showKnownTableWithAnimations();
      
      // CERRAR TODAS LAS OVERLAYS QUE PUEDAN ESTAR ABIERTAS
      const overlays = ['challengeSuccessOverlay', 'challengeFailOverlay', 'ultimateChallengeSuccessOverlay', 'ultimateChallengeFailureOverlay'];
      overlays.forEach(overlayId => {
        const overlay = document.getElementById(overlayId);
        if (overlay) {
          overlay.classList.add('hidden');
          console.log(`‚úÖ Overlay ${overlayId} cerrado`);
        }
      });
      
      console.log('‚úÖ RESET COMPLETO TERMINADO. currentMission ahora:', currentMission);
      
      // Scroll forzado a la tabla despu√©s de un momento
      setTimeout(() => {
        console.log('üéØ DEBUG: Iniciando scroll a tabla conocidas');
        const knownGrid = document.getElementById('knownGrid');
        if (knownGrid) {
          console.log('‚úÖ knownGrid encontrado, haciendo scroll');
          window.scrollTo({ top: knownGrid.offsetTop - 60, behavior: 'smooth' });
        } else {
          console.log('‚ùå knownGrid NO encontrado');
        }
        
        // Verificar estado final
        console.log('üîç ESTADO FINAL:');
        console.log('- currentMission:', currentMission);
        console.log('- gameBox display:', gameBox ? gameBox.style.display : 'no encontrado');
        console.log('- statBox display:', statBox ? statBox.style.display : 'no encontrado');
        console.log('- knownTableSection display:', knownTableSection ? knownTableSection.style.display : 'no encontrado');
      }, 200);
      
    } else {
      // Asegurarse de que statBox est√© visible en modo normal
      const statBox = document.getElementById('statBox');
      if (statBox) {
        statBox.style.display = '';
        console.log('üìä statBox mantenido visible en modo normal');
      }
      
      overlayField = 'hanzi';
      showKnownTableWithAnimations();
      window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
    }
  };

  // Actualizar badge de Maestro del Hor√≥scopo
  function updateHoroscopeMasterBadge() {
    const badge = document.getElementById('horoscopeMasterBadge');
    if (!badge) return;
    
    if (horoscopeMaster) {
      badge.classList.remove('hidden');
      // Si complet√≥ m√∫ltiples veces, mostrar el contador
      if (ultimateChallengeCompletedCount > 1) {
        badge.innerHTML = `üèÜ Maestro del Hor√≥scopo (${ultimateChallengeCompletedCount}x)`;
      } else {
        badge.innerHTML = `üèÜ Maestro del Hor√≥scopo`;
      }
      console.log('üèÜ Badge de Maestro del Hor√≥scopo mostrado');
    } else {
      badge.classList.add('hidden');
      console.log('üîí Badge de Maestro del Hor√≥scopo oculto');
    }
  }

  // Funci√≥n para detectar level up y perdidos y disparar animaciones
  function showKnownTableWithAnimations() {
    // Prevenir llamadas m√∫ltiples simult√°neas
    if(window._animatingKnownTable) return;
    window._animatingKnownTable = true;
    
    // Actualizar badge de maestro del hor√≥scopo
    updateHoroscopeMasterBadge();
    
    // Estado actual (EXCLUIR badges del hor√≥scopo)
    const currentKnown = cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo').map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    // Detectar level up (EXCLUIR animales del hor√≥scopo que no pueden subir de nivel)
    const prevMap = Object.fromEntries(prevKnownState.map(c => [c.id, c]));
    const levelUpIds = [];
    for (const c of currentKnown) {
      // EXCLUIR cartas sin ID (badges del hor√≥scopo) y animales del hor√≥scopo
      if (!c.id) {
        console.log('ÔøΩ Excluido por no tener ID (badge del hor√≥scopo):', c.hanzi);
        continue; // Saltar expl√≠citamente a la siguiente iteraci√≥n
      } else if (prevMap[c.id] && c.streak > prevMap[c.id].streak) {
        // Buscar la tarjeta completa para verificar si es animal del hor√≥scopo
        const fullCard = cards.find(card => card.id === c.id);
        
        console.log(`üîç DEBUG Level Up Check: ${c.hanzi} (ID: ${c.id})`);
        console.log(`   - Streak actual: ${c.streak}, Streak previo: ${prevMap[c.id].streak}`);
        console.log(`   - Tarjeta encontrada:`, fullCard ? {
          hanzi: fullCard.hanzi, 
          unit: fullCard.unit,
          isHoroscopeAnimal: fullCard.isHoroscopeAnimal,
          meaning: fullCard.meaning?.slice(0, 30) + '...'
        } : 'NO ENCONTRADA');
        
        // Solo permitir level up si:
        // 1. La tarjeta existe
        // 2. NO es animal del hor√≥scopo 
        // 3. NO tiene unit 'horoscopo' (badges del hor√≥scopo)
        if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
          console.log(`‚úÖ Level Up confirmado para: ${c.hanzi} (${fullCard.unit})`);
          levelUpIds.push(c.id);
        } else {
          console.log(`üö´ Excluido: ${c.hanzi} - Motivo:`, 
            !fullCard ? 'No encontrada' :
            fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
            fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
        }
      }
    }
    // Detectar perdidos (EXCLUIR animales del hor√≥scopo que no se pueden perder)
    const currentIds = new Set(currentKnown.map(c => c.id));
    const lostChars = prevKnownState.filter(c => {
      if (!currentIds.has(c.id)) {
        const fullCard = cards.find(card => card.id === c.id);
        return !fullCard?.isHoroscopeAnimal;
      }
      return false;
    });
    
    // Detectar caracteres nuevos a√±adidos (EXCLUIR animales del hor√≥scopo)
    const prevIds = new Set(prevKnownState.map(c => c.id));
    const newlyAdded = currentKnown.filter(c => {
      if (!prevIds.has(c.id)) {
        const fullCard = cards.find(card => card.id === c.id);
        return !fullCard?.isHoroscopeAnimal && fullCard?.unit !== 'horoscopo';
      }
      return false;
    });
    
    // Guardar para animaciones siguientes
    window._levelUpIds = levelUpIds;
    window._lostChars = lostChars;
    window._newlyAdded = newlyAdded;
    // Renderizar tabla con animaciones (siguiente paso)
    renderKnownGridWithAnimations(levelUpIds, lostChars, newlyAdded);
    // Guardar nuevo estado previo para la pr√≥xima vez
    prevKnownState = currentKnown.map(c => ({ ...c }));
    window.prevKnownState = prevKnownState;
    
    // Liberar bloqueo despu√©s de un breve delay para permitir que terminen las animaciones
    setTimeout(() => {
      window._animatingKnownTable = false;
    }, 100);
  }
  // üîÑ Botones globales - limpian estados individuales y aplican a todos
  const btnShowHanzi = document.getElementById('btnShowHanzi');
  const btnShowPinyin = document.getElementById('btnShowPinyin');
  const btnShowMeaning = document.getElementById('btnShowMeaning');
  
  if (btnShowHanzi) {
    btnShowHanzi.onclick = ()=>{ 
      overlayField='hanzi'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Hanzi aplicado a todas las cartas');
    };
  }
  
  if (btnShowPinyin) {
    btnShowPinyin.onclick = ()=>{ 
      overlayField='pinyin'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Pinyin aplicado a todas las cartas');
    };
  }
  
  if (btnShowMeaning) {
    btnShowMeaning.onclick = ()=>{ 
      overlayField='meaning'; 
      Object.keys(cardDisplayStates).forEach(key => delete cardDisplayStates[key]); // Limpiar estados individuales
      showKnownTableWithAnimations(); 
      console.log('üîÑ Modo global: Traducci√≥n aplicada a todas las cartas');
    };
  }

  // Verificar que los elementos existan antes de asignar eventos
  const btnKnow = document.getElementById('btnKnow');
  const btnDontKnow = document.getElementById('btnDontKnow');
  
  if (btnKnow) {
    btnKnow.onclick = () => {
      // üçé iOS: Activar m√∫sica si no est√° reproduciendo
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (isIOS && desafioMusic && desafioMusic.paused) {
        desafioMusic.play().catch(e => console.log('üçé iOS: Error activando m√∫sica:', e));
      }
      respond(true);
    };
  }
  if (btnDontKnow) {
    btnDontKnow.onclick = () => {
      // üçé iOS: Activar m√∫sica si no est√° reproduciendo
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (isIOS && desafioMusic && desafioMusic.paused) {
        desafioMusic.play().catch(e => console.log('üçé iOS: Error activando m√∫sica:', e));
      }
      respond(false);
    };
  }
  document.getElementById('btnFlip').onclick     = () => {
    if(mode==='flash'){ 
      flipped = !flipped; 
      
      // üé≠ APLICAR O REMOVER CLASE FLIP SEG√öN ESTADO
      if(flipped) {
        cardEl.classList.add('flip');
      } else {
        cardEl.classList.remove('flip');
      }
      
      // Cambiar contenido en la mitad de la animaci√≥n (cuando est√° a 90 grados - invisible)
      setTimeout(() => {
        if(flipped) {
          // Mostrar pinyin + meaning con salto de l√≠nea y contra-rotaci√≥n para que se vea bien
          frontEl.innerHTML = `
            <div style="
              display: flex; 
              flex-direction: column; 
              align-items: center; 
              justify-content: center; 
              height: 100%; 
              text-align: center;
              padding: 20px;
              transform: rotateY(180deg);
            ">
              <div style="font-size: 2.5rem; margin-bottom: 15px; font-weight: bold; color: #60a5fa;">${currentCard.pinyin}</div>
              <div style="font-size: 1.8rem; line-height: 1.4; color: #e5e7eb;">${currentCard.meaning}</div>
            </div>
          `;
        } else {
          // Mostrar hanzi (contenido original del front)
          frontEl.innerHTML = '';
          const frontWrap = document.createElement('div');
          frontWrap.style.position = 'relative';
          frontWrap.style.width = '100%';
          frontWrap.style.height = '100%';
          const hanziSpan = document.createElement('span');
          hanziSpan.textContent = currentCard.hanzi;
          hanziSpan.style.display = 'inline-block';
          hanziSpan.style.position = 'absolute';
          hanziSpan.style.top = '50%';
          hanziSpan.style.left = '50%';
          hanziSpan.style.transform = 'translate(-50%, -50%)';
          frontWrap.appendChild(hanziSpan);
          // Bot√≥n parlante (solo si no es desaf√≠o)
          if(currentMission !== 'challenge') {
            const speakBtn = document.createElement('button');
            speakBtn.title = 'Escuchar pronunciaci√≥n';
            speakBtn.style.position = 'absolute';
            speakBtn.style.top = '10px';
            speakBtn.style.right = '10px';
            speakBtn.style.background = 'rgba(30,41,59,0.85)';
            speakBtn.style.border = 'none';
            speakBtn.style.cursor = 'pointer';
            speakBtn.style.borderRadius = '50%';
            speakBtn.style.padding = '4px';
            speakBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
            speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5zm7.07 2.93a10 10 0 010 14.14m2.83-2.83a6 6 0 000-8.48"/></svg>';
            speakBtn.onclick = (e) => {
              e.stopPropagation();
              speakHanzi(currentCard.hanzi, speakBtn);
            };
            frontWrap.appendChild(speakBtn);
          }
          frontEl.appendChild(frontWrap);
        }
      }, 150); // Exactamente en el medio del flip (cuando est√° invisible)
    }
  };
  cardEl.onclick = () => {
    if(currentCard && mode==='flash'){
      flipped = !flipped;
      
      // üé≠ APLICAR O REMOVER CLASE FLIP SEG√öN ESTADO
      if(flipped) {
        cardEl.classList.add('flip');
      } else {
        cardEl.classList.remove('flip');
      }
      
      // Cambiar contenido en la mitad de la animaci√≥n (cuando est√° a 90 grados - invisible)
      setTimeout(() => {
        if(flipped) {
          // Mostrar pinyin + meaning con salto de l√≠nea y contra-rotaci√≥n para que se vea bien
          frontEl.innerHTML = `
            <div style="
              display: flex; 
              flex-direction: column; 
              align-items: center; 
              justify-content: center; 
              height: 100%; 
              text-align: center;
              padding: 20px;
              transform: rotateY(180deg);
            ">
              <div style="font-size: 2.5rem; margin-bottom: 15px; font-weight: bold; color: #60a5fa;">${currentCard.pinyin}</div>
              <div style="font-size: 1.8rem; line-height: 1.4; color: #e5e7eb;">${currentCard.meaning}</div>
            </div>
          `;
        } else {
          // Mostrar hanzi (contenido original del front)
          frontEl.innerHTML = '';
          const frontWrap = document.createElement('div');
          frontWrap.style.position = 'relative';
          frontWrap.style.width = '100%';
          frontWrap.style.height = '100%';
          const hanziSpan = document.createElement('span');
          hanziSpan.textContent = currentCard.hanzi;
          hanziSpan.style.display = 'inline-block';
          hanziSpan.style.position = 'absolute';
          hanziSpan.style.top = '50%';
          hanziSpan.style.left = '50%';
          hanziSpan.style.transform = 'translate(-50%, -50%)';
          frontWrap.appendChild(hanziSpan);
          // Bot√≥n parlante (solo si no es desaf√≠o)
          if(currentMission !== 'challenge') {
            const speakBtn = document.createElement('button');
            speakBtn.title = 'Escuchar pronunciaci√≥n';
            speakBtn.style.position = 'absolute';
            speakBtn.style.top = '10px';
            speakBtn.style.right = '10px';
            speakBtn.style.background = 'rgba(30,41,59,0.85)';
            speakBtn.style.border = 'none';
            speakBtn.style.cursor = 'pointer';
            speakBtn.style.borderRadius = '50%';
            speakBtn.style.padding = '4px';
            speakBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
            speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5zm7.07 2.93a10 10 0 010 14.14m2.83-2.83a6 6 0 000-8.48"/></svg>';
            speakBtn.onclick = (e) => {
              e.stopPropagation();
              speakHanzi(currentCard.hanzi, speakBtn);
            };
            frontWrap.appendChild(speakBtn);
          }
          frontEl.appendChild(frontWrap);
        }
      }, 150); // Exactamente en el medio del flip (cuando est√° invisible)
    }
  };


  // Bot√≥n "si se traba" para refrescar la p√°gina (si existe)
  const btnSiSeTraba = document.getElementById('btnSiSeTraba');
  if (btnSiSeTraba) {
    btnSiSeTraba.onclick = () => {
      location.reload();
    };
  }

  // ========= NUEVO SISTEMA DE REINICIO COMPLETO CON DOBLE CONFIRMACI√ìN =========
  const btnShowResetOptions = document.getElementById('btnShowResetOptions');
  const nuevoResetModal = document.getElementById('nuevoResetModal');
  const confirmarNuevoReset = document.getElementById('confirmarNuevoReset');
  const cancelarNuevoReset = document.getElementById('cancelarNuevoReset');
  
  const confirmacionFinalModal = document.getElementById('confirmacionFinalModal');
  const confirmarDefinitivo = document.getElementById('confirmarDefinitivo');
  const cancelarDefinitivo = document.getElementById('cancelarDefinitivo');

  // PASO 1: Abrir primer modal cuando se presiona el bot√≥n
  if (btnShowResetOptions && nuevoResetModal) {
    btnShowResetOptions.onclick = () => {
      console.log('üî¥ Abriendo primer modal de advertencia');
      nuevoResetModal.classList.remove('hidden');
    };
  }

  // Cancelar desde el primer modal
  if (cancelarNuevoReset && nuevoResetModal) {
    cancelarNuevoReset.onclick = () => {
      console.log('‚úÖ Usuario cancel√≥ desde el primer modal');
      nuevoResetModal.classList.add('hidden');
    };
  }

  // PASO 2: Al confirmar en el primer modal, abrir el segundo modal de confirmaci√≥n final
  if (confirmarNuevoReset && nuevoResetModal && confirmacionFinalModal) {
    confirmarNuevoReset.onclick = () => {
      console.log('‚ö†Ô∏è Usuario pas√≥ la primera advertencia, mostrando confirmaci√≥n final...');
      
      // Cerrar primer modal
      nuevoResetModal.classList.add('hidden');
      
      // Abrir segundo modal (confirmaci√≥n final)
      confirmacionFinalModal.classList.remove('hidden');
    };
  }

  // Cancelar desde el segundo modal (confirmaci√≥n final)
  if (cancelarDefinitivo && confirmacionFinalModal) {
    cancelarDefinitivo.onclick = () => {
      console.log('üõ°Ô∏è Usuario se detuvo en la confirmaci√≥n final');
      confirmacionFinalModal.classList.add('hidden');
    };
  }

  // PASO 3: Confirmaci√≥n definitiva - AQU√ç SE BORRA TODO
  if (confirmarDefinitivo && confirmacionFinalModal) {
    confirmarDefinitivo.onclick = async () => {
      console.log('ÔøΩ USUARIO CONFIRM√ì DEFINITIVAMENTE - INICIANDO BORRADO TOTAL...');
      
      // Cerrar modal
      confirmacionFinalModal.classList.add('hidden');
      
      // Resetear TODAS las variables
      cards = [];
      xpPoints = 0;
      nivel2Unlocked = false;
      nivel3Unlocked = false;
      hsk3Unlocked = false;
      hsk4Unlocked = false;
      
      // Resetear desaf√≠os
      desafioN1Completed = false;
      desafioN2Completed = false;
      desafioN3Completed = false;
      emperatrizCompleted = false;
      bestias12Completed = false;
      cruzarMarCompleted = false;
      cruzarCieloCompleted = false;
      cruzarHSK3Completed = false;
      cruzarHSK4Completed = false;
      maestroHoroscopo = false;
      horoscopeAnimalsCompleted = [];
      ultimateChallengeCompletedCount = 0;
      
      console.log('üíæ Guardando estado reiniciado...');
      
      // Guardar estado vac√≠o
      await saveUserState();
      await saveXP();
      
      console.log('üîÑ Recargando aplicaci√≥n...');
      
      // Recargar todo
      await loadAll();
      startMission('unit2');
      
      // Notificaci√≥n
      showNotification('‚úÖ Progreso completamente reiniciado. ¬°Empiezas de nuevo!', 'success');
      
      console.log('‚úÖ Reinicio completado exitosamente');
    };
  }

  // Funci√≥n para inicializar los botones de reinicio (legacy - puede ser eliminada)
  function initializeResetButtons() {
    const btnCancelReset = document.getElementById('btnCancelReset');

    if (btnCancelReset) {
      btnCancelReset.onclick = () => {
        const mainContainer = document.getElementById('mainButtonsContainer');
        const resetContainer = document.getElementById('resetButtonsContainer');
        
        if (mainContainer && resetContainer) {
          // Volver a mostrar botones principales y ocultar opciones de reinicio
          mainContainer.style.display = 'grid';
          resetContainer.style.display = 'none';
        }
      };
    }
  }

  // --- Bot√≥n de C√≥digo para desbloquear HSK3/HSK4 ---
  const btnUnlockCode = document.getElementById('btnUnlockCode');
  if (btnUnlockCode) {
    btnUnlockCode.onclick = () => {
      showUnlockCodeModal();
    };
  }

  // Mensaje temporal para modo desaf√≠o (funci√≥n utilitaria)
  function showChallengeWarning() {
    let msg = document.getElementById('challengeWarningMsg');
    if (!msg) {
      msg = document.createElement('div');
      msg.id = 'challengeWarningMsg';
      msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-rose-700 text-white px-6 py-3 rounded-2xl shadow-lg text-lg font-semibold z-[9999] opacity-0 transition-opacity duration-500';
      msg.textContent = 'Desafio terminado. No se puede ver la tabla cuando est√°s en modo desaf√≠o';
      document.body.appendChild(msg);
    }
    msg.style.opacity = '1';
    setTimeout(() => { msg.style.opacity = '0'; }, 1800);
  }

// --- Funci√≥n para iniciar desaf√≠os personalizados ---
async function startChallengeCustom(tipo) {
  // üî¥ CHECKPOINT: Guardar antes de iniciar desaf√≠o personalizado
  console.log(`üî¥ CHECKPOINT [startChallengeCustom - ${tipo}]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
  SaveQueue.flush();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  let pool;
  if(tipo === 'menos') {
    pool = shuffle(cards.filter(c => c.known && (c.challengeStreak === 0 || c.challengeStreak === 1) && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  } else if(tipo === 'mas') {
    pool = shuffle(cards.filter(c => c.known && c.challengeStreak >= 2 && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  } else {
    pool = shuffle(cards.filter(c => c.known && !c.isHoroscopeAnimal && c.unit !== 'horoscopo'));
  }
  sessionQueue = pool.slice(0,10); // 10 tarjetas por desaf√≠o personalizado
  currentMission = 'challenge';
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  setMode(Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin');
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  
  // ‚ùå Ocultar botones de quiz para desaf√≠os M√°s/Menos
  updateQuizButtonsVisibility(tipo);
  
  // ¬°PRECARGAR VIDEO DE FONDO! (M√∫sica se inicia en countdown)
  await createChallengeVideoWithPreload('challenge');
  // playDesafioMusic('challenge'); // ‚ú® MOVIDO AL COUNTDOWN
  
  // AUTO-SCROLL AL √ÅREA DE JUEGO EN M√ìVIL - REFERENCIA: BARRA XP
  setTimeout(() => {
    const xpElement = document.getElementById('xpBarWrap');
    if (xpElement) {
      xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Offset adicional para Android - asegurar que la barra quede arriba
      setTimeout(() => {
        const rect = xpElement.getBoundingClientRect();
        const offset = rect.top - 10; // 10px de margen superior
        if (offset !== 0) {
          window.scrollBy({ top: offset, behavior: 'smooth' });
        }
      }, 400);
    }
  }, 100);
  
  nextCard();
  updateStats();
}

// --- Funci√≥n para mostrar modal de presentaci√≥n del desaf√≠o ---
function showHoroscopeModal(categoria) {
  console.log(`üîç DEBUG: showHoroscopeModal ejecut√°ndose con: ${categoria}`);
  
  // Filtrar TODAS las palabras de la categor√≠a espec√≠fica (conocidas o no)
  const pool = cards.filter(c => c.unit.split('|').includes(categoria));
  
  // Si no hay palabras de esa categor√≠a, mostrar mensaje
  if(pool.length === 0) {
    alert(`No se encontraron palabras para la categor√≠a "${categoria}".`);
    return;
  }
  
  // Verificar que tenga al menos 10 caracteres conocidos de esta categor√≠a
  const knownInCategory = pool.filter(c => c.known).length;
  
  if(knownInCategory < 10) {
    showChallengeBlockedNotification(categoria, knownInCategory, 10);
    return;
  }
  
  // Mostrar modal con imagen
  const animal = horoscopeAnimals[categoria];
  const unlockedCount = horoscopeAnimalsUnlocked.length;
  
  const modal = document.createElement('div');
  modal.id = 'horoscope-modal-active';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #9c88ff;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(156, 136, 255, 0.3);
      position: relative;
    ">
      <div style="
        display: flex;
        justify-content: center;
        margin-bottom: 2px;
      ">
        <div class="horoscope-modal-image">
          <img src="img/${animal.image}" alt="${animal.name}" style="
            width: 150px;
            height: 180px;
            object-fit: cover;
          ">
        </div>
      </div>
      
      <h2 style="
        color: #9c88ff;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 3px 0;
        text-shadow: 2px 2px 0px #4c1d95;
      ">‚öîÔ∏è DESAF√çO DEL ${animal.chinese} ‚öîÔ∏è</h2>
      
      <h3 style="
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 1px 0;
        text-shadow: 1px 1px 0px #000000;
      ">${animal.name.toUpperCase()}</h3>
      
      <div style="
        background: rgba(156, 136, 255, 0.1);
        border: 2px solid #9c88ff;
        border-radius: 12px;
        padding: 10px 20px;
        margin: 3px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.4;
        text-align: left;
      ">
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ff6b6b;">üíÄ Cada ERROR</span> elimina el car√°cter M√ÅS 2 al AZAR de tu Colecci√≥n</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #87ceeb;">üìä Progreso</span> ${unlockedCount}/12 animales del hor√≥scopo coleccionados</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #FFD700;">üê≤ Colecciona los 12 animales</span> para Desbloquear el Desaf√≠o Final</div>
      </div>
      
      <div style="
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-top: 10px;
      ">
        <button onclick="startHoroscopeChallenge('${categoria}')" style="
          background: linear-gradient(135deg, #9c88ff, #7c3aed);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 6px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(156, 136, 255, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚öîÔ∏è¬°COMENZAR!
        </button>
        
        <button onclick="closeHoroscopeModal()" style="
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 6px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚ùå Cancelar
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  console.log("‚úÖ Modal del hor√≥scopo mostrado exitosamente");
}

// Cerrar modal de desaf√≠o del hor√≥scopo
function closeHoroscopeModal() {
  const modal = document.getElementById('horoscope-modal-active');
  if (modal) {
    modal.remove();
  }
}

// --- Funci√≥n para iniciar desaf√≠o del hor√≥scopo cerrando modal primero ---
function startHoroscopeChallenge(categoria) {
  console.log("üî• CERRANDO MODAL DIRECTAMENTE");
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o hor√≥scopo');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // M√©todo 1: Por ID
  const modalById = document.getElementById('horoscope-modal-active');
  if(modalById) {
    modalById.remove();
    console.log("‚úÖ Modal eliminado por ID");
  }
  
  // M√©todo 2: Por clase (backup)
  const modalByClass = document.querySelector('.horoscope-modal-overlay');
  if(modalByClass) {
    modalByClass.remove();
    console.log("‚úÖ Modal eliminado por clase");
  }
  
  // M√©todo 3: Nuclear - eliminar todos los modals
  const allModals = document.querySelectorAll('[style*="position: fixed"]');
  allModals.forEach(m => {
    if(m.style.zIndex >= 10000) {
      m.remove();
      console.log("üî• Modal eliminado nuclearmente");
    }
  });
  
  console.log("üöÄ Iniciando desaf√≠o:", categoria);
  startDesafioHoroscopo(categoria);
}

// --- Funci√≥n para contar animales desbloqueados ---
function getUnlockedAnimalsCount() {
  return horoscopeAnimalsUnlocked.length;
}

// --- Funci√≥n para verificar si es un desaf√≠o del hor√≥scopo ---
function isHoroscopeChallenge(mission) {
  return mission && (
    mission === 'desafioColores' || mission === 'desafioFruta' || mission === 'desafioVerduras' ||
    mission === 'desafioComidas' || mission === 'desafioAnimales' || mission === 'desafioDeportes' ||
    mission === 'desafioHobbies' || mission === 'desafioRopa' || mission === 'desafioCasa' ||
    mission === 'desafioCuerpo' || mission === 'desafioProfesiones' || mission === 'desafioEmociones'
  );
}

// --- Funci√≥n para obtener categor√≠a desde mission ---
function getHoroscopeCategoryFromMission(mission) {
  const missionToCategory = {
    'desafioColores': 'colores',
    'desafioFruta': 'fruta', 
    'desafioVerduras': 'verduras',
    'desafioComidas': 'comidas',
    'desafioAnimales': 'animales',
    'desafioDeportes': 'deportes',
    'desafioHobbies': 'hobbies',
    'desafioRopa': 'ropa',
    'desafioCasa': 'casa',
    'desafioCuerpo': 'cuerpo',
    'desafioProfesiones': 'profesiones',
    'desafioEmociones': 'emociones'
  };
  return missionToCategory[mission] || null;
}

// --- Funci√≥n para mostrar notificaci√≥n previa de desaf√≠os N ---
function showDesafioNNotification(desafioType, nivelName, recompensa) {
  console.log('üì¢ DEBUG: showDesafioNNotification llamada con:', { desafioType, nivelName, recompensa });
  
  // Configuraci√≥n espec√≠fica por cada desaf√≠os
  const config = {
    desafioN1: {
      title: 'DESAF√çO N1',
      color: 'fuchsia',
      gradient: 'from-fuchsia-900 to-purple-900',
      borderColor: 'fuchsia-500',
      glowColor: 'rgba(217, 70, 239, 0.7)',
      description: 'Demuestra tu dominio del Nivel 1',
      objetivo: '20 palabras aleatorias del Nivel 1',
      recompensa: 'üåä Desbloquea Cruzar el Mar',
      tiempo: '‚è±Ô∏è 2 minutos',
      vidas: '‚ù§Ô∏è 3 vidas'
    },
    desafioN2: {
      title: 'DESAF√çO N2',
      color: 'rose',
      gradient: 'from-rose-900 to-pink-900',
      borderColor: 'rose-500',
      glowColor: 'rgba(244, 63, 94, 0.7)',
      description: 'Demuestra tu dominio del Nivel 2',
      objetivo: '20 palabras aleatorias del Nivel 2',
      recompensa: '‚òÅÔ∏è Desbloquea Cruzar el Cielo',
      tiempo: '‚è±Ô∏è 2 minutos',
      vidas: '‚ù§Ô∏è 3 vidas'
    },
    desafioN3: {
      title: 'DESAF√çO N3',
      color: 'orange',
      gradient: 'from-orange-900 to-amber-900',
      borderColor: 'orange-500',
      glowColor: 'rgba(249, 115, 22, 0.7)',
      description: 'Demuestra tu dominio del Nivel 3',
      objetivo: '20 palabras aleatorias del Nivel 3',
      tiempo: '‚è±Ô∏è 2 minutos',
      vidas: '‚ù§Ô∏è 3 vidas'
    }
  };
  
  const cfg = config[desafioType];
  
  const modal = document.createElement('div');
  console.log('üé≠ DEBUG: Modal creado:', modal);
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b ${cfg.gradient} rounded-xl border-2 border-${cfg.borderColor}/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-${cfg.borderColor}/30 bg-gradient-to-r from-${cfg.color}-900/30 to-purple-900/30">
        <h3 class="text-2xl font-bold text-${cfg.color}-400 text-center flex items-center justify-center gap-3">
          ${cfg.title}
        </h3>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-${cfg.color}-900/20 border-2 border-${cfg.borderColor}/40 rounded-lg p-4 text-${cfg.color}-200 space-y-1 text-left text-xl">
          <div class="text-center text-xl font-bold mb-2">${cfg.description}</div>
          <div>${cfg.objetivo}</div>
          <div class="mt-3 pt-3 border-t border-${cfg.borderColor}/30">
            <div>${cfg.recompensa}</div>
          </div>
          <div class="mt-3 pt-3 border-t border-${cfg.borderColor}/30">
            <div>${cfg.tiempo} para completar</div>
            <div>${cfg.vidas} disponibles</div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-${cfg.borderColor} bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Cancelar
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-${cfg.color}-600 to-${cfg.color}-700 text-white font-bold rounded-lg hover:from-${cfg.color}-700 hover:to-${cfg.color}-800 transition-all text-xl" onclick="startDesafioNWithSystem('${desafioType}'); this.closest('.fixed').remove()">
          üöÄ Iniciar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Funci√≥n para iniciar desaf√≠o N con sistema de timer y vidas ---
function startDesafioNWithSystem(desafioType) {
  console.log('üöÄ DEBUG: startDesafioNWithSystem llamada con:', desafioType);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Ocultar cajas de nivel correspondientes
  const levelBoxes = {
    'desafioN1': 'nivel1Box',
    'desafioN2': 'nivel2Box', 
    'desafioN3': 'nivel3Box'
  };
  
  const levelBox = document.getElementById(levelBoxes[desafioType]);
  if (levelBox) levelBox.classList.add('hidden');
  
  // Limpiar Ultimate Challenge si est√° activo
  if (ultimateChallengeActive || ultimateChallengeTimerInterval) {
    console.log('üßπ Limpiando Ultimate Challenge al iniciar desaf√≠o N');
    ultimateChallengeActive = false;
    hideUltimateChallengeHearts();
    stopUltimateChallengeTimer();
  }
  
  // Activar sistema de desaf√≠o N
  desafioNActive = true;
  desafioNHearts = 3;
  desafioNTimeLeft = 120; // 2 minutos
  console.log('‚öôÔ∏è DEBUG: Variables de desaf√≠o N configuradas:', { desafioNActive, desafioNHearts, desafioNTimeLeft });
  
  // ========= ACTIVAR SISTEMA DE ASISTENCIA =========
  initAssistanceForChallenge();
  
  // Iniciar misi√≥n normal
  console.log('üìã DEBUG: Llamando startMission con:', desafioType);
  startMission(desafioType);
  
  // Actualizar statMission para mostrar el tipo de desaf√≠o N
  console.log('üìä DEBUG: Intentando actualizar statMission para:', desafioType);
  const statMission = document.getElementById('statMission');
  console.log('üìä DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const desafioNames = {
      'desafioN1': 'Desaf√≠o N1',
      'desafioN2': 'Desaf√≠o N2', 
      'desafioN3': 'Desaf√≠o N3'
    };
    const newText = desafioNames[desafioType] || 'Desaf√≠o N';
    console.log('üìä DEBUG: Texto anterior:', statMission.textContent);
    console.log('üìä DEBUG: Texto nuevo que se asignar√°:', newText);
    statMission.textContent = newText;
    statMission.style.color = '#f2e5b1';
    statMission.style.fontWeight = 'bold';
    statMission.style.fontSize = '14px';
    console.log('üéØ DEBUG: statMission actualizado exitosamente:', statMission.textContent);
    
    // Verificar que realmente se actualiz√≥
    setTimeout(() => {
      console.log('‚è±Ô∏è DEBUG: Verificaci√≥n posterior - statMission.textContent:', statMission.textContent);
    }, 100);
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission');
  }
  
  // Iniciar timer y vidas del desaf√≠o N
  // Agendar el timer para despu√©s de la precarga si es necesario
  const timerCallback = () => {
    startDesafioNTimer();
    console.log('‚è∞ Timer del desaf√≠o N iniciado despu√©s de preload');
  };
  
  if (preloadingChallenge) {
    console.log('‚è≥ Timer N agendado para despu√©s de precarga');
    pendingTimerCallbacks.push(timerCallback);
  } else {
    timerCallback();
  }
  
  showDesafioNHearts();
  
  console.log(`üéØ Desaf√≠o N iniciado: ${desafioType} con timer y vidas`);
  console.log('üîç DEBUG: Estado final - desafioNActive:', desafioNActive, 'hearts:', desafioNHearts, 'timeLeft:', desafioNTimeLeft);
}

// --- Funci√≥n para mostrar modal de animal desbloquseado ---
function showAnimalUnlockedModal(categoria) {
  const animal = horoscopeAnimals[categoria];
  const modal = document.createElement('div');
  modal.className = 'horoscope-modal-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(145deg, #FFD700, #32CD32);
      border-radius: 20px;
      padding: 20px;
      max-width: 90vw;
      max-height: 90vh;
      width: 100%;
      max-width: 500px;
      overflow-y: auto;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    ">
      <div style="margin-bottom: 15px;">
        <h2 style="
          font-size: clamp(18px, 5vw, 24px);
          margin: 0 0 15px 0;
          color: #2F4F2F;
        ">üéÜ ¬°Animal Desbloqueado! üéÜ</h2>
      </div>
      
      <div style="margin-bottom: 20px; display: flex; justify-content: center;">
        <div class="horoscope-modal-image">
          <img src="img/${animal.image}" alt="${animal.name}" style="
            width: clamp(120px, 30vw, 180px);
            height: clamp(120px, 30vw, 180px);
            object-fit: cover;
          ">
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        
        <p style="
          font-size: clamp(16px, 4vw, 20px);
          color: #2F4F2F;
          font-weight: bold;
          margin: 10px 0;
        ">üèÜ ¬°Has derrotado al Desaf√≠o y desbloqueado al ${animal.chinese} ${animal.name}! üèÜ</p>
        
        <p style="
          color: #2F4F2F;
          font-size: clamp(14px, 3.5vw, 16px);
          margin: 8px 0;
        ">El ${animal.name} ha sido agregado a tu colecci√≥n.</p>
        
        <p style="
          color: #2F4F2F;
          font-size: clamp(14px, 3.5vw, 16px);
          margin: 8px 0;
        ">üìä Tienes <span style="font-weight: bold;">${horoscopeAnimalsUnlocked.length}/12</span> animales del hor√≥scopo en tu Colecci√≥n</p>
        
        ${horoscopeAnimalsUnlocked.length === 12 ? `
          <p style="
            color: #FF4500;
            font-weight: bold;
            font-size: clamp(14px, 3.5vw, 16px);
            margin: 12px 0;
          ">üéÜ ¬°COLECCI√ìN COMPLETA! Desaf√≠o Final desbloqueado üéÜ</p>
          
          <button onclick="startUltimateChallenge()" style="
            width: 100%;
            margin-top: 15px;
            padding: clamp(10px, 3vw, 15px);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: 3px solid #FF4500;
            border-radius: 12px;
            color: #8B0000;
            font-weight: bold;
            font-size: clamp(14px, 3.5vw, 16px);
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(255,69,0,0.3);
            transition: all 0.3s ease;
          ">
            üèÜ DESAF√çO HOR√ìSCOPO üèÜ<br>
            <span style="font-size: clamp(10px, 2.5vw, 12px); color: #B8860B;">60 tarjetas ‚Ä¢ Todos los Animales</span>
          </button>
        ` : ''}
      </div>
      
      <button onclick="closeAnimalUnlockedModal()" style="
        width: 100%;
        padding: clamp(12px, 3vw, 16px);
        background: linear-gradient(145deg, #32CD32, #228B22);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: bold;
        font-size: clamp(14px, 4vw, 18px);
        cursor: pointer;
        transition: all 0.3s ease;
      ">‚ú® ¬°Genial!</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Auto-cerrar despu√©s de 8 segundos (m√°s tiempo para m√≥vil)
  setTimeout(() => {
    closeAnimalUnlockedModal();
  }, 8000);
}

// --- Funci√≥n para cerrar modal de animal desbloqueado ---
function closeAnimalUnlockedModal() {
  const modal = document.querySelector('.horoscope-modal-overlay');
  if(modal) modal.remove();
}

// === DESAF√çO N3: MARCAR COMO COMPLETADO (Versi√≥n Documental) ===
async function completarDesafioN3() {
  console.log('üéØ Marcando Desaf√≠o N3 como completado (localStorage)...');
  
  if (desafioN3Completed) {
    console.log('‚úÖ Desaf√≠o N3 ya estaba completado anteriormente');
    return;
  }
  
  try {
    // Actualizar estado local
    const isFirstTime = !desafioN3Completed;
    desafioN3Completed = true;
    
    if (isFirstTime) {
      desafioN3CompletedAt = new Date();
      console.log('üéä ¬°Primera vez completando Desaf√≠o N3! (localStorage)');
    }
    
    // üèÖ Actualizar bot√≥n Niveles con medalla
    updateNivelesButtonText();
    
    // Guardar en localStorage
    await saveUserState();
    
    // Actualizar logros para reflejar el cambio
    setTimeout(() => {
      updateAchievements();
      console.log('üèÖ Logros actualizados tras completar Desaf√≠o N3');
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error completando Desaf√≠o N3 (localStorage):', error);
  }
}

// --- Funci√≥n para desbloquear animal del hor√≥scopo ---
function unlockHoroscopeAnimal(categoria) {
  console.log(`üîç DEBUG unlockHoroscopeAnimal: categoria=${categoria}`);
  console.log(`üîç DEBUG horoscopeAnimalsUnlocked actual:`, horoscopeAnimalsUnlocked);
  
  if (!categoria || horoscopeAnimalsUnlocked.includes(categoria)) {
    console.log(`‚ùå No se desbloquea: categoria inv√°lida o ya desbloqueado`);
    return; // Ya desbloqueado o categor√≠a inv√°lida
  }
  
  console.log(`üéâ ¬°Animal desbloqueado: ${horoscopeAnimals[categoria].name}!`);
  
  // Agregar a lista de desbloqueados
  horoscopeAnimalsUnlocked.push(categoria);
  console.log(`‚úÖ Agregado a lista. Nueva lista:`, horoscopeAnimalsUnlocked);
  
  // Crear "car√°cter especial" del animal para la tabla de conocidas
  const animalChar = {
    hanzi: horoscopeAnimals[categoria].chinese,
    pinyin: horoscopeAnimals[categoria].name.toLowerCase(),
    meaning: `Animal ${horoscopeAnimals[categoria].name} (Hor√≥scopo)`,
    unit: 'horoscopo',
    cat: 'ANIMAL',
    known: true,
    challengeStreak: 1,
    challengeBest: 1,
    isHoroscopeAnimal: true,
    animalImage: horoscopeAnimals[categoria].image,
    animalCategory: categoria
  };
  
  // Agregar badge al array separado (NO al array principal cards)
  const existsInBadges = window.horoscopeBadges.some(b => b.hanzi === animalChar.hanzi);
  if (!existsInBadges) {
    window.horoscopeBadges.push(animalChar);
    console.log(`‚úÖ Badge agregado a horoscopeBadges. Total badges: ${window.horoscopeBadges.length}`);
  } else {
    console.log(`‚ùå Badge ya existe en horoscopeBadges`);
  }
  
  // üî¥ CHECKPOINT: Guardar al desbloquear animal del hor√≥scopo
  console.log(`ÔøΩ CHECKPOINT [unlockHoroscopeAnimal - ${categoria}]: HAGO FLUSH - Cola: ${SaveQueue.getQueueSize()} ops`);
  SaveQueue.flush();
  
  // ‚ùå MODAL ELIMINADO - No mostrar modal de desbloqueado
  // showAnimalUnlockedModal(categoria);
  
  // Actualizar bot√≥n del desaf√≠o final
  updateUltimateChallengeButton();
  
  // Actualizar estado del bot√≥n 12 Bestias
  if (typeof updateHoroscopeButtonsState === 'function') {
    console.log('üê≤ Actualizando estado de bot√≥n 12 Bestias');
    updateHoroscopeButtonsState();
  }
  
  // Resetear statMission al completar desaf√≠o hor√≥scopo
  const statMission = document.getElementById('statMission');
  if (statMission) {
    statMission.textContent = '‚Äî';
    statMission.style.color = '';
    statMission.style.fontWeight = '';
    statMission.style.fontSize = '';
    console.log('üîÑ statMission reseteado despu√©s del desaf√≠o hor√≥scopo');
  }
}

// --- Funci√≥n para actualizar apariencia del bot√≥n desaf√≠o final ---
function updateUltimateChallengeButton() {
  const btnDesafioFinal = document.getElementById('btnDesafioFinal');
  if (!btnDesafioFinal) return;
  
  if (horoscopeAnimalsUnlocked.length >= 12) {
    // Desbloquear: apariencia normal
    btnDesafioFinal.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
    btnDesafioFinal.style.opacity = '1';
    btnDesafioFinal.style.cursor = 'pointer';
    btnDesafioFinal.title = 'üèÜ Desaf√≠o Final del Hor√≥scopo - ¬°Desbloqueado!';
    console.log('üèÜ Bot√≥n Desaf√≠o Final desbloqueado');
  } else {
    // Bloqueado: apariencia deshabilitada
    btnDesafioFinal.style.background = 'linear-gradient(135deg, #666, #444)';
    btnDesafioFinal.style.opacity = '0.6';
    btnDesafioFinal.style.cursor = 'not-allowed';
    btnDesafioFinal.title = `üîí Requiere los 12 animales (${horoscopeAnimalsUnlocked.length}/12)`;
    console.log(`üîí Bot√≥n Desaf√≠o Final bloqueado (${horoscopeAnimalsUnlocked.length}/12)`);
  }
}

// --- Funci√≥n para mostrar modal de requerimientos del desaf√≠o final ---
function showUltimateChallengeRequirementModal() {
  const animalsCount = horoscopeAnimalsUnlocked.length;
  const remaining = 12 - animalsCount;
  
  // Crear modal din√°mico
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-md w-full bg-gradient-to-b from-slate-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl">
      <!-- Header -->
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-orange-900/30">
        <h3 class="text-1xl font-bold text-red-400 jersey-font-coleccion-cards text-center flex items-center justify-center gap-2">
          üîí DESAF√çO BLOQUEADO
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/desafiofinal.webp" alt="Desaf√≠o Final" class="w-48 h-80 object-cover rounded-lg shadow-lg" 
             style="border: 3px solid #FFF8DC; 
                    box-shadow: 
                      0 0 20px rgba(255, 248, 220, 0.7),
                      0 0 40px rgba(255, 235, 150, 0.5),
                      0 0 60px rgba(255, 215, 0, 0.3),
                      inset 0 0 10px rgba(255, 248, 220, 0.2);
                    /* Animaci√≥n removida para mejor rendimiento */
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Estilos CSS para la animaci√≥n -->
      <style>
        /* @keyframes goldenGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
      </style>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        
        <div class="text-gray-300 jersey-font-coleccion-cards">
          Para desbloquear el Desaf√≠o Final necesitas coleccionar los <strong>12 animales del hor√≥scopo</strong>
        </div>
        
        <!-- Progress -->
        <div class="bg-slate-700 rounded-full h-4 overflow-hidden">
          <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-full transition-all duration-500" 
               style="width: ${(animalsCount / 12) * 100}%"></div>
        </div>
        
        <div class="text-lg font-bold jersey-font-coleccion-cards">
          <span class="text-cyan-400">${animalsCount}</span><span class="text-gray-400">/</span><span class="text-yellow-400">12</span> animales
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-gray-600 bg-slate-800/50">
        <button class="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all jersey-font-coleccion-cards text-lg" onclick="this.closest('.fixed').remove()">
          ¬°Volver√© m√°s fuerte!
        </button>
      </div>
    </div>
  `;
  
  // Agregar al DOM
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modal informativo para Desaf√≠o La Emperatriz ---
function showEmperatrizInfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-cyan-900 to-slate-900 rounded-xl border-2 border-cyan-400/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Estilos CSS para la animaci√≥n de latido -->
      <style>
        @keyframes emperatrizHeartbeat {
          0%, 100% { 
            box-shadow: 
              0 0 20px rgba(64, 224, 208, 0.7),
              0 0 40px rgba(32, 178, 170, 0.5),
              0 0 60px rgba(0, 139, 139, 0.3),
              inset 0 0 10px rgba(64, 224, 208, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 
              0 0 25px rgba(64, 224, 208, 0.9),
              0 0 50px rgba(32, 178, 170, 0.7),
              0 0 75px rgba(0, 139, 139, 0.5),
              inset 0 0 15px rgba(64, 224, 208, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .emperatriz-heartbeat {
          animation: emperatrizHeartbeat 2.5s ease-in-out infinite;
        }
      </style>
      
      <!-- Header -->
      <div class="p-4 border-b border-cyan-400/30 bg-gradient-to-r from-cyan-900/30 to-teal-900/30">
        <h3 class="text-2xl font-bold text-cyan-300 text-center flex items-center justify-center gap-3">
          üëë LA EMPERATRIZ üëë
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/emper.webp" alt="La Emperatriz" class="w-40 h-64 object-cover rounded-lg shadow-lg emperatriz-heartbeat" 
             style="border: 3px solid #40E0D0; 
                    box-shadow: 
                      0 0 20px rgba(64, 224, 208, 0.7),
                      0 0 40px rgba(32, 178, 170, 0.5),
                      0 0 60px rgba(0, 139, 139, 0.3),
                      inset 0 0 10px rgba(64, 224, 208, 0.2);
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="border-2 border-cyan-400/40 rounded-lg p-4 text-cyan-200 space-y-1 text-left text-xl" style="background-color: transparent;">
          <div><strong>Tienes:</strong> 5 mins y 3 vidas ‚ö°</div>
          <div><strong>Error:</strong> pierde un caracter al azar</div>
          <div><strong><span style="color: orange;">Recomendado:</span></strong> Niv 1,2,3 y Hor√≥scopo</div>
          <div>(Tener Caracteres de Nivel alto)</div>
          <div class="mt-3 pt-3 border-t border-cyan-400/30">
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-cyan-500 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-cyan-500 to-teal-600 text-white font-bold rounded-lg hover:from-cyan-600 hover:to-teal-700 transition-all text-xl" onclick="this.closest('.fixed').remove(); startEmperatrizChallenge();">
          ¬°Empezar!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// Modal de bloqueo para La Emperatriz
function showEmperatrizLockedModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-gray-900/30">
        <h3 class="text-2xl font-bold text-red-400 text-center flex items-center justify-center gap-3">
          üîí LA EMPERATRIZ - BLOQUEADA üîí
        </h3>
      </div>
      
      <!-- Imagen bloqueada -->
      <div class="px-6 pt-4 flex justify-center relative">
        <div class="relative">
          <img src="img/emper.webp" alt="La Emperatriz" class="w-40 h-64 object-cover rounded-lg shadow-lg" 
               style="border: 3px solid #ef4444; opacity: 0.3; filter: grayscale(1);"
               onerror="this.style.display='none'">
          <div class="absolute inset-0 flex items-center justify-center text-8xl">
            üîí
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-red-900/20 border-2 border-red-500/40 rounded-lg p-4 text-red-200 space-y-2 text-left text-xl">
          <div class="text-center text-2xl font-bold mb-3">‚ùå DESAF√çO BLOQUEADO</div>
          <div class="text-center text-xl">Para desbloquear este desaf√≠o debes:</div>
          <div class="bg-amber-800/30 border border-amber-500/40 rounded p-3 mt-2">
            <div class="font-bold text-amber-300">‚úÖ Derrotar a la Bestia (12 Bestias)</div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-red-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-lg hover:from-red-700 hover:to-red-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Volver√© m√°s fuerte
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modal informativo para Desaf√≠o Cruzar el Mar ---
// Modal informativo cuando Cruzar el Mar est√° BLOQUEADO
function showCruzarMarLockedModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-gray-900/30">
        <h3 class="text-2xl font-bold text-red-400 text-center flex items-center justify-center gap-3">
          üîí CRUZAR EL MAR - BLOQUEADO üîí
        </h3>
      </div>
      
      <!-- Imagen bloqueada -->
      <div class="px-6 pt-4 flex justify-center relative">
        <div class="relative">
          <img src="img/cruza.webp" alt="Cruzar el Mar" class="w-40 h-64 object-cover rounded-lg shadow-lg" 
               style="border: 3px solid #ef4444; opacity: 0.3; filter: grayscale(1);"
               onerror="this.style.display='none'">
          <div class="absolute inset-0 flex items-center justify-center text-8xl">
            üîí
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-red-900/20 border-2 border-red-500/40 rounded-lg p-4 text-red-200 space-y-2 text-left text-xl">
          <div class="text-center text-2xl font-bold mb-3">‚ùå DESAF√çO BLOQUEADO</div>
          <div class="text-center text-xl">Para desbloquear este desaf√≠o debes:</div>
          <div class="bg-amber-800/30 border border-amber-500/40 rounded p-3 mt-2">
            <div class="font-bold text-amber-300">‚úÖ Completar Desaf√≠o N1</div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-red-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-lg hover:from-red-700 hover:to-red-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Volver√© m√°s fuerte
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function showBestias12LockedModal() {
  const completedCount = horoscopeAnimalsUnlocked.length;
  const totalCount = 12;
  const percentage = Math.round((completedCount / totalCount) * 100);
  
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-800 to-slate-900 rounded-xl border-2 border-amber-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-amber-500/30 bg-gradient-to-r from-amber-900/30 to-gray-900/30">
        <h3 class="text-2xl font-bold text-amber-400 text-center flex items-center justify-center gap-3">
          üîí DESAF√çO 12 BESTIAS - BLOQUEADO üîí
        </h3>
      </div>
      
      <!-- Imagen bloqueada -->
      <div class="px-6 pt-4 flex justify-center relative">
        <div class="relative">
          <div class="text-9xl opacity-30 grayscale">üê≤</div>
          <div class="absolute inset-0 flex items-center justify-center text-8xl">
            üîí
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-amber-900/20 border-2 border-amber-500/40 rounded-lg p-4 text-amber-200 space-y-3 text-left text-xl">
          <div class="text-center text-xl">Para desbloquear este desaf√≠o debes Completar los 12 Desaf√≠os del Hor√≥scopo</div>
          
          <!-- Barra de progreso -->
          <div class="mt-4 bg-gray-800 rounded-lg p-3 border border-amber-600/40">
            <div class="text-center text-xl font-bold mb-2" style="color: ${percentage === 100 ? '#10b981' : '#fbbf24'};">
              üìä Progreso: ${completedCount}/${totalCount} (${percentage}%)
            </div>
            <div class="w-full bg-gray-700 rounded-full h-6 overflow-hidden border-2 border-gray-600">
              <div class="h-full transition-all duration-500 flex items-center justify-center text-sm font-bold" 
                   style="width: ${percentage}%; background: linear-gradient(90deg, #d97706, #f59e0b, #fbbf24);">
                ${percentage > 15 ? `${percentage}%` : ''}
              </div>
            </div>
            ${completedCount > 0 ? `
              <div class="mt-3 text-sm text-gray-300">
                <div class="font-bold text-green-400 mb-1">‚úÖ Completados:</div>
                <div class="flex flex-wrap gap-1">
                  ${horoscopeAnimalsUnlocked.map(animal => {
                    const animalNames = {
                      'colores': 'üêÅ Rata',
                      'fruta': 'üêì Gallo',
                      'verdura': 'üêá Conejo',
                      'comida': 'üêñ Cerdo',
                      'animales': 'üêï Perro',
                      'deporte': 'üêé Caballo',
                      'hobby': 'üêÇ Buey',
                      'ropa': 'üêê Cabra',
                      'casa': 'üêç Serpiente',
                      'cuerpo': 'üêí Mono',
                      'profesion': 'üêÖ Tigre',
                      'emociones': 'üêâ Drag√≥n'
                    };
                    return `<span class="bg-green-900/40 border border-green-500/40 px-2 py-1 rounded text-xs">${animalNames[animal] || animal}</span>`;
                  }).join('')}
                </div>
              </div>
            ` : ''}
            ${completedCount < totalCount ? `
              <div class="mt-3 text-xl text-gray-400">
                <div class="font-bold text-red-400 mb-1">‚ùå Faltan: ${totalCount - completedCount}</div>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-amber-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold rounded-lg hover:from-amber-700 hover:to-amber-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Volver√© m√°s fuerte
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function showCruzarMarInfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-cyan-900 to-slate-900 rounded-xl border-2 border-cyan-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Estilos CSS para la animaci√≥n de latido -->
      <style>
        @keyframes cruzarMarHeartbeat {
          0%, 100% { 
            box-shadow: 
              0 0 20px rgba(6, 182, 212, 0.7),
              0 0 40px rgba(8, 145, 178, 0.5),
              0 0 60px rgba(14, 116, 144, 0.3),
              inset 0 0 10px rgba(6, 182, 212, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 
              0 0 25px rgba(6, 182, 212, 0.9),
              0 0 50px rgba(8, 145, 178, 0.7),
              0 0 75px rgba(14, 116, 144, 0.5),
              inset 0 0 15px rgba(6, 182, 212, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .cruzarMar-heartbeat {
          animation: cruzarMarHeartbeat 2.5s ease-in-out infinite;
        }
      </style>
      
      <!-- Header -->
      <div class="p-4 border-b border-cyan-500/30 bg-gradient-to-r from-cyan-900/30 to-blue-900/30">
        <h3 class="text-2xl font-bold text-cyan-400 text-center flex items-center justify-center gap-3">
          üåä CRUZAR EL MAR üåä
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/cruza.webp" alt="Cruzar el Mar" class="w-40 h-64 object-cover rounded-lg shadow-lg cruzarMar-heartbeat" 
             style="border: 3px solid #06b6d4; 
                    box-shadow: 
                      0 0 20px rgba(6, 182, 212, 0.7),
                      0 0 40px rgba(8, 145, 178, 0.5),
                      0 0 60px rgba(14, 116, 144, 0.3),
                      inset 0 0 10px rgba(6, 182, 212, 0.2);
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-cyan-900/20 border-2 border-cyan-500/40 rounded-lg p-4 text-cyan-200 space-y-1 text-left text-xl">
          <div>üåä Cruza el Mar para llegar al siguiente continente</div>
          <div><strong>Tienes:</strong> 4 mins y 3 vidas ‚ö°</div>
          <div><strong>Error:</strong> Pierdes un caracter al azar</div>
          <div>Solo caracteres de Nivel 1 üå±</div>
          <div class="mt-3 pt-3 border-t border-cyan-500/30">
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-cyan-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold rounded-lg hover:from-cyan-700 hover:to-blue-700 transition-all text-xl" onclick="this.closest('.fixed').remove(); startCruzarMarChallenge();">
          ¬°Cruzar el Mar!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modales para Cruzar el Cielo ---
function showCruzarCieloLockedModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-gray-900/30">
        <h3 class="text-2xl font-bold text-red-400 text-center flex items-center justify-center gap-3">
          üîí CRUZAR EL CIELO - BLOQUEADO üîí
        </h3>
      </div>
      
      <!-- Imagen bloqueada -->
      <div class="px-6 pt-4 flex justify-center relative">
        <div class="relative">
          <img src="img/imgcielo.webp" alt="Cruzar el Cielo" class="w-40 h-64 object-cover rounded-lg shadow-lg" 
               style="border: 3px solid #ef4444; opacity: 0.3; filter: grayscale(1);"
               onerror="this.style.display='none'">
          <div class="absolute inset-0 flex items-center justify-center text-8xl">
            üîí
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-red-900/20 border-2 border-red-500/40 rounded-lg p-4 text-red-200 space-y-2 text-left text-xl">
          <div class="text-center text-2xl font-bold mb-3">‚ùå DESAF√çO BLOQUEADO</div>
          <div class="text-center text-xl">Para desbloquear este desaf√≠o debes:</div>
          <div class="bg-amber-800/30 border border-amber-500/40 rounded p-3 mt-2">
            <div class="font-bold text-amber-300">‚úÖ Completar Desaf√≠o N2</div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-red-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-lg hover:from-red-700 hover:to-red-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Volver√© m√°s fuerte
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function showCruzarCieloInfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-orange-900 to-slate-900 rounded-xl border-2 border-orange-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Estilos CSS para la animaci√≥n de latido -->
      <style>
        @keyframes cruzarCieloHeartbeat {
          0%, 100% { 
            box-shadow: 
              0 0 20px rgba(249, 115, 22, 0.7),
              0 0 40px rgba(234, 88, 12, 0.5),
              0 0 60px rgba(194, 65, 12, 0.3),
              inset 0 0 10px rgba(249, 115, 22, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 
              0 0 25px rgba(249, 115, 22, 0.9),
              0 0 50px rgba(234, 88, 12, 0.7),
              0 0 75px rgba(194, 65, 12, 0.5),
              inset 0 0 15px rgba(249, 115, 22, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .cruzarCielo-heartbeat {
          animation: cruzarCieloHeartbeat 2.5s ease-in-out infinite;
        }
      </style>
      
      <!-- Header -->
      <div class="p-4 border-b border-orange-500/30 bg-gradient-to-r from-orange-900/30 to-orange-800/30">
        <h3 class="text-2xl font-bold text-orange-400 text-center flex items-center justify-center gap-3">
          ‚òÅÔ∏è CRUZAR EL CIELO ‚òÅÔ∏è
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/imgcielo.webp" alt="Cruzar el Cielo" class="w-40 h-64 object-cover rounded-lg shadow-lg cruzarCielo-heartbeat" 
             style="border: 3px solid #f97316; 
                    box-shadow: 
                      0 0 20px rgba(249, 115, 22, 0.7),
                      0 0 40px rgba(234, 88, 12, 0.5),
                      0 0 60px rgba(194, 65, 12, 0.3),
                      inset 0 0 10px rgba(249, 115, 22, 0.2);
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="bg-orange-900/20 border-2 border-orange-500/40 rounded-lg p-4 text-orange-200 space-y-1 text-left text-xl">
          <div>‚òÅÔ∏è Cruza el Cielo para llegar al tercer continente</div>
          <div><strong>Tienes:</strong> 5 mins y 3 vidas ‚ö°</div>
          <div>Solo caracteres de Nivel 2</div>
          <div><strong>Error:</strong> pierde un caracter al azar</div>
          <div class="mt-3 pt-3 border-t border-orange-500/30">
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-orange-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-orange-700 text-white font-bold rounded-lg hover:from-orange-700 hover:to-orange-800 transition-all text-xl" onclick="this.closest('.fixed').remove(); startCruzarCieloChallenge();">
          ¬°Cruzar el Cielo!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modales para Cruzar HSK3 ---
function showCruzarHSK3LockedModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-800 to-slate-900 rounded-xl border-2 border-red-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <div class="p-4 border-b border-red-500/30 bg-gradient-to-r from-red-900/30 to-gray-900/30">
        <h3 class="text-2xl font-bold text-red-400 text-center flex items-center justify-center gap-3">
          üîí CRUZAR HSK3 - BLOQUEADO üîí
        </h3>
      </div>
      
      <div class="px-6 pt-4 flex justify-center relative">
        <div class="relative">
          <div class="w-40 h-64 bg-gradient-to-b from-purple-900 to-purple-700 rounded-lg shadow-lg flex items-center justify-center" 
               style="border: 3px solid #ef4444; opacity: 0.3; filter: grayscale(1);">
            <span style="font-size: 80px;">üéì</span>
          </div>
          <div class="absolute inset-0 flex items-center justify-center text-8xl">
            üîí
          </div>
        </div>
      </div>
      
      <div class="p-6 text-center space-y-4">
        <div class="bg-red-900/20 border-2 border-red-500/40 rounded-lg p-4 text-red-200 space-y-2 text-left text-xl">
          <div class="text-center text-2xl font-bold mb-3">‚ùå DESAF√çO BLOQUEADO</div>
          <div class="text-center text-xl">Para desbloquear este desaf√≠o debes:</div>
          <div class="bg-amber-800/30 border border-amber-500/40 rounded p-3 mt-2">
            <div class="font-bold text-amber-300">‚úÖ Completar Cruzar el Cielo</div>
            <div class="text-amber-200 text-lg mt-1">Necesitas sobrevivir el desaf√≠o Cruzar el Cielo primero</div>
          </div>
        </div>
      </div>
      
      <div class="p-4 border-t border-red-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-lg hover:from-red-700 hover:to-red-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Volver√© m√°s fuerte
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// --- Modal informativo para Cruzar HSK4 (copiados de HSK3 con colores rosas)
function showCruzarHSK4InfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-gray-900 to-black rounded-xl border-2 border-gray-700/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <style>
        @keyframes cruzarHSK4Heartbeat {
          0%, 100% { 
            box-shadow: 0 0 20px rgba(55, 65, 81, 0.7), 0 0 40px rgba(31, 41, 55, 0.5), 0 0 60px rgba(17, 24, 39, 0.3), inset 0 0 10px rgba(55, 65, 81, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 0 0 25px rgba(55, 65, 81, 0.9), 0 0 50px rgba(31, 41, 55, 0.7), 0 0 75px rgba(17, 24, 39, 0.5), inset 0 0 15px rgba(55, 65, 81, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .cruzarHSK4-heartbeat { animation: cruzarHSK4Heartbeat 2.5s ease-in-out infinite; }
      </style>
      
      <div class="p-4 border-b border-gray-700/30 bg-gradient-to-r from-gray-900/30 to-gray-800/30">
        <h3 class="text-2xl font-bold text-gray-300 text-center flex items-center justify-center gap-3">
          CRUZAR HSK4
        </h3>
      </div>
      
      <div class="px-6 pt-4 flex justify-center">
        <div class="w-40 h-64 bg-gradient-to-b from-gray-900 to-gray-700 rounded-lg shadow-lg cruzarHSK4-heartbeat flex items-center justify-center overflow-hidden" 
             style="border: 3px solid #374151; box-shadow: 0 0 20px rgba(55, 65, 81, 0.7), 0 0 40px rgba(31, 41, 55, 0.5), 0 0 60px rgba(17, 24, 39, 0.3), inset 0 0 10px rgba(55, 65, 81, 0.2); transform: scale(1) translateZ(0); opacity: 1;">
          <img src="img/cruzarhsk4.webp" alt="Cruzar HSK4" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      </div>
      
      <div class="p-6 text-center space-y-4">
        <div class="bg-gray-900/20 border-2 border-gray-700/40 rounded-lg p-4 text-gray-200 space-y-1 text-left text-xl">
          <div><strong>Tienes:</strong> 7 mins y 3 vidas ‚ö°</div>
          <div>Solo caracteres HSK4 üìö</div>
          <div><strong>Error: </strong>Pierdes un car√°cter al azar</div>
          <div class="mt-3 pt-3 border-t border-gray-700/30"></div>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-700 bg-black/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-800 to-black text-white font-bold rounded-lg hover:from-black hover:to-gray-900 transition-all text-xl" onclick="this.closest('.fixed').remove(); startCruzarHSK4Challenge();">
          ¬°Cruzar HSK4!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

function showCruzarHSK3InfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-amber-900 to-slate-900 rounded-xl border-2 border-amber-700/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <style>
        @keyframes cruzarHSK3Heartbeat {
          0%, 100% { 
            box-shadow: 0 0 20px rgba(120, 53, 15, 0.7), 0 0 40px rgba(146, 64, 14, 0.5), 0 0 60px rgba(161, 98, 7, 0.3), inset 0 0 10px rgba(120, 53, 15, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 0 0 25px rgba(120, 53, 15, 0.9), 0 0 50px rgba(146, 64, 14, 0.7), 0 0 75px rgba(161, 98, 7, 0.5), inset 0 0 15px rgba(120, 53, 15, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .cruzarHSK3-heartbeat { animation: cruzarHSK3Heartbeat 2.5s ease-in-out infinite; }
      </style>
      
      <div class="p-4 border-b border-amber-700/30 bg-gradient-to-r from-amber-900/30 to-amber-800/30">
        <h3 class="text-2xl font-bold text-amber-400 text-center flex items-center justify-center gap-3">
          CRUZAR HSK3
        </h3>
      </div>
      
      <div class="px-6 pt-4 flex justify-center">
        <div class="w-40 h-64 bg-gradient-to-b from-amber-900 to-amber-700 rounded-lg shadow-lg cruzarHSK3-heartbeat flex items-center justify-center overflow-hidden" 
             style="border: 3px solid #78350f; box-shadow: 0 0 20px rgba(120, 53, 15, 0.7), 0 0 40px rgba(146, 64, 14, 0.5), 0 0 60px rgba(161, 98, 7, 0.3), inset 0 0 10px rgba(120, 53, 15, 0.2); transform: scale(1) translateZ(0); opacity: 1;">
          <img src="img/cruzarhsk3.webp" alt="Cruzar HSK3" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
      </div>
      
      <div class="p-6 text-center space-y-4">
        <div class="bg-amber-900/20 border-2 border-amber-700/40 rounded-lg p-4 text-amber-200 space-y-1 text-left text-xl">
          <div><strong>Tienes:</strong> 6 mins y 3 vidas ‚ö°</div>
          <div>Solo caracteres HSK3 üìö</div>
          <div><strong>Error: </strong>Pierdes un car√°cter al azar</div>
          <div class="mt-3 pt-3 border-t border-amber-700/30"></div>
        </div>
      </div>
      
      <div class="p-4 border-t border-amber-700 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-700 to-amber-800 text-white font-bold rounded-lg hover:from-amber-800 hover:to-amber-900 transition-all text-xl" onclick="this.closest('.fixed').remove(); startCruzarHSK3Challenge();">
          ¬°Cruzar HSK3!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
}

// --- Modal informativo para Desaf√≠o 12 Bestias ---
function showBestias12InfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-amber-900 to-slate-900 rounded-xl border-2 border-amber-600/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Estilos CSS para la animaci√≥n de latido -->
      <style>
        @keyframes bestias12Heartbeat {
          0%, 100% { 
            box-shadow: 
              0 0 20px rgba(217, 179, 140, 0.7),
              0 0 40px rgba(184, 134, 88, 0.5),
              0 0 60px rgba(139, 115, 85, 0.3),
              inset 0 0 10px rgba(217, 179, 140, 0.2);
            transform: scale(1) translateZ(0);
          }
          50% { 
            box-shadow: 
              0 0 25px rgba(217, 179, 140, 0.9),
              0 0 50px rgba(184, 134, 88, 0.7),
              0 0 75px rgba(139, 115, 85, 0.5),
              inset 0 0 15px rgba(217, 179, 140, 0.4);
            transform: scale(1.02) translateZ(0);
          }
        }
        .bestias12-heartbeat {
          animation: bestias12Heartbeat 2.5s ease-in-out infinite;
        }
      </style>
      
      <!-- Header -->
      <div class="p-4 border-b border-amber-600/30 bg-gradient-to-r from-amber-900/30 to-yellow-900/30">
        <h3 class="text-2xl font-bold text-amber-400 text-center flex items-center justify-center gap-3">
          üê≤ DESAF√çO 12 BESTIAS üê≤
        </h3>
      </div>
      
      <!-- Imagen de portada -->
      <div class="px-6 pt-4 flex justify-center">
        <img src="img/bestias12modal.webp" alt="12 Bestias" class="w-40 h-64 object-cover rounded-lg shadow-lg bestias12-heartbeat" 
             style="border: 3px solid #D9B38C; 
                    box-shadow: 
                      0 0 20px rgba(217, 179, 140, 0.7),
                      0 0 40px rgba(184, 134, 88, 0.5),
                      0 0 60px rgba(139, 115, 85, 0.3),
                      inset 0 0 10px rgba(217, 179, 140, 0.2);
                    transform: scale(1) translateZ(0);
                    opacity: 1;"
             onerror="this.style.display='none'">
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        
        <div class="border-2 border-amber-600/40 rounded-lg p-4 text-amber-200 space-y-1 text-left text-xl" style="background-color: transparent;">
          <div><strong>Tienes:</strong> 5 mins y 3 vidas ‚ö°</div>
          <div><strong>Error:</strong> pierde un caracter al azar</div>
          <div><strong>Caracteres del Hor√≥scopo</strong></div>
          <div class="mt-3 pt-3 border-t border-amber-600/30">
          </div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-amber-600 bg-slate-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Tengo Miedo
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-amber-600 to-yellow-700 text-white font-bold rounded-lg hover:from-amber-700 hover:to-yellow-800 transition-all text-xl" onclick="this.closest('.fixed').remove(); startBestias12Challenge();">
          ¬°Empezar!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modal informativo para Desaf√≠o Cl√°sicos ---
function showDesafioClassicoInfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-purple-900 to-indigo-900 rounded-xl border-2 border-purple-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-purple-500/30 bg-gradient-to-r from-purple-900/30 to-indigo-900/30">
        <h3 class="text-2xl font-bold text-purple-300 text-center flex items-center justify-center gap-3">
          ‚öîÔ∏è DESAF√çO CL√ÅSICO ‚öîÔ∏è
        </h3>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="text-purple-200 text-2xl">
          <strong>Sube de Nivel tu Colecci√≥n</strong>
        </div>
        
        <div class="bg-purple-900/20 border-2 border-purple-500/40 rounded-lg p-4 text-purple-200 space-y-2 text-left text-xl">
          <div>‚Ä¢ 10 tarjetas al azar de tu colecci√≥n</div>
          <div>‚Ä¢ <span style="color: #4ade80;">Acierta:</span> sube de nivel el caracter</div>
          <div>‚Ä¢ <span style="color: #ef4444;">Error:</span> pierde el caracter y todo su nivel</div>
          <div>‚Ä¢ <span style="color: #22d3ee;">Tienes:</span> 90 segundos y 2 vidas</div>
          <div>‚Ä¢ <span>Termina el desaf√≠o:</span> suma una <span style="color: #fb923c;">racha</span> por d√≠a</div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-purple-600 bg-purple-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Cancelar
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-xl" onclick="this.closest('.fixed').remove(); startDesafioClasico2WithSystem('challenge');">
          ‚öîÔ∏è ¬°Comenzar Desaf√≠o!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modal informativo para Desaf√≠o Nivel 0 y 1 ---
function showDesafioNivel01InfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-purple-900 to-indigo-900 rounded-xl border-2 border-purple-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-purple-500/30 bg-gradient-to-r from-purple-900/30 to-indigo-900/30">
        <h3 class="text-2xl font-bold text-purple-300 text-center flex items-center justify-center gap-3">
          DESAF√çO NIVEL 0 Y 1
        </h3>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="text-purple-200 text-xl">
          <strong>Mejora tus Cartas Nuevas</strong>
        </div>
        
        <div class="bg-purple-900/20 border-2 border-purple-500/40 rounded-lg p-4 text-purple-200 space-y-2 text-left text-xl">
          <div>‚Ä¢ 10 tarjetas al azar de tu colecci√≥n con nivel 0 y 1</div>
          <div>‚Ä¢ <span style="color: #4ade80;">Acierta:</span> sube de nivel el caracter</div>
          <div>‚Ä¢ <span style="color: #ef4444;">Error:</span> pierde el caracter y todo su nivel</div>
          <div>‚Ä¢ <span style="color: #22d3ee;">Tienes:</span> 90 segundos y 2 vidas</div>
          <div>‚Ä¢ <span>Termina el desaf√≠o:</span> suma una <span style="color: #fb923c;">racha</span> por d√≠a</div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-purple-600 bg-purple-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Cancelar
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-xl" onclick="this.closest('.fixed').remove(); startDesafioClasico2WithSystem('menos');">
          üü£ ¬°Comenzar Desaf√≠o!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

// --- Modal informativo para Desaf√≠o Nivel 2+ ---
function showDesafioNivel2PlusInfoModal() {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4';
  modal.innerHTML = `
    <div class="max-w-lg w-full bg-gradient-to-b from-purple-900 to-indigo-900 rounded-xl border-2 border-purple-500/50 shadow-2xl" style="font-family: 'Jersey 10', monospace;">
      <!-- Header -->
      <div class="p-4 border-b border-purple-500/30 bg-gradient-to-r from-purple-900/30 to-indigo-900/30">
        <h3 class="text-2xl font-bold text-purple-300 text-center flex items-center justify-center gap-3">
          DESAF√çO NIVEL 2+
        </h3>
      </div>
      
      <!-- Content -->
      <div class="p-6 text-center space-y-4">
        <div class="text-purple-200 text-xl">
          <strong>Mejora tus Cartas Fuertes</strong>
        </div>
        
        <div class="bg-purple-900/20 border-2 border-purple-500/40 rounded-lg p-4 text-purple-200 space-y-2 text-left text-xl">
          <div>‚Ä¢ 10 tarjetas al azar de tu colecci√≥n de nivel 2 para arriba</div>
          <div>‚Ä¢ <span style="color: #4ade80;">Acierta:</span> sube de nivel el caracter</div>
          <div>‚Ä¢ <span style="color: #ef4444;">Error:</span> pierde el caracter y todo su nivel</div>
          <div>‚Ä¢ <span style="color: #22d3ee;">Tienes:</span> 90 segundos y 2 vidas</div>
          <div>‚Ä¢ <span>Termina el desaf√≠o:</span> suma una <span style="color: #fb923c;">racha</span> por d√≠a</div>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="p-4 border-t border-purple-600 bg-purple-800/50 flex gap-3">
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 text-white font-bold rounded-lg hover:from-gray-700 hover:to-gray-800 transition-all text-xl" onclick="this.closest('.fixed').remove()">
          Cancelar
        </button>
        <button class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all text-xl" onclick="this.closest('.fixed').remove(); startDesafioClasico2WithSystem('mas');">
          üî• ¬°Comenzar Desaf√≠o!
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Cerrar al hacer clic fuera
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function renderUltimateChallengeCard(card) {
  console.log('=== DEBUG ULTIMATE CHALLENGE ===');
  console.log('üèÜ Renderizando carta Ultimate Challenge:', card);
  console.log('üì± DEBUG - Dispositivo m√≥vil:', isMobile());
  console.log('üì± DEBUG - User agent:', navigator.userAgent);
  console.log('üìä √çndices: cardIndex=' + ultimateChallengeCardIndex + ', animalIndex=' + ultimateChallengeAnimalIndex);
  console.log('üÉã SessionQueue length:', sessionQueue.length);
  
  if (!card) {
    console.error('‚ö†Ô∏è ERROR: No hay carta para renderizar');
    return;
  }
  
  // Actualizar animal actual basado en el √≠ndice
  const currentAnimalData = ultimateChallengeOrder[ultimateChallengeAnimalIndex];
  ultimateChallengeCurrentAnimal = currentAnimalData?.animal || 'Desconocido';
  console.log('üêç Animal actual:', ultimateChallengeCurrentAnimal);
  
  // Actualizar display del modo actual (Ultimate Challenge)
  console.log('üìä Llamando updateUltimateChallengeCounter() desde renderUltimateChallengeCard()');
  updateUltimateChallengeCounter();
  
  // Determinar si mostrar hanzi o pinyin como opciones (aleatorio)
  const showHanziOptions = Math.random() < 0.5;
  console.log(`üé≤ Opciones: ${showHanziOptions ? 'HANZI' : 'PINYIN'}`);
  console.log('üá®üá≥ Pregunta (debe ser espa√±ol):', card.meaning);
  
  // CONFIGURAR MODO: Siempre pregunta en espa√±ol (meaning) con opciones hanzi/pinyin
  if (showHanziOptions) {
    setMode('quizMeaning'); // Pregunta meaning (espa√±ol), opciones ser√°n hanzi
    console.log('üîÑ Modo: quizMeaning con opciones HANZI');
  } else {
    setMode('quizMeaning'); // Pregunta meaning (espa√±ol), opciones ser√°n pinyin  
    console.log('üîÑ Modo: quizMeaning con opciones PINYIN');
  }
  
  // IMPORTANTE: Forzar que la pregunta sea en espa√±ol
  currentCard = {
    ...card,
    forceSpanishQuestion: true,
    ultimateChallengeMode: showHanziOptions ? 'hanzi' : 'pinyin'
  };
  
  console.log('üìù Carta procesada:', currentCard);
  console.log('==============================');
  
  // NO usar renderCard() - llamar directamente setupQuizChoices para evitar conflictos
  // renderCard();
  
  // Configurar directamente
  backEl.textContent = '';
  flashRow.classList.add('hidden');
  
  // Obtener referencia a quizRow
  const quizRow = document.getElementById('quizRow');
  if (!quizRow) {
    console.error('‚ùå ERROR: quizRow no encontrado en DOM');
    return;
  }
  
  quizRow.classList.remove('hidden');
  
  // M√ìVIL: Verificar si existen casillas, crearlas si es necesario
  console.log('üîç DEBUG renderUltimateChallengeCard - isMobile():', isMobile());
  console.log('üîç DEBUG quizRow existe:', !!quizRow);
  
  if (isMobile()) {
    const existingButtons = quizRow.querySelectorAll('.quizOpt');
    console.log('üîç DEBUG casillas existentes:', existingButtons.length);
    
    // Usar setTimeout para asegurar que el DOM est√© listo
    setTimeout(() => {
      if (existingButtons.length === 0) {
        console.log('üì± Ultimate Challenge - Creando casillas para m√≥vil (no existen)');
        createQuizButtonsAfterFlip();
      } else {
        console.log('üì± Ultimate Challenge - Casillas ya existen, configurando contenido');
        
        // Asegurar que las casillas sean visibles en Ultimate Challenge
        existingButtons.forEach(btn => {
          btn.style.opacity = '1';
          btn.style.pointerEvents = 'auto';
        });
        
        setupQuizChoices();
      }
    }, 50);
  } else {
    console.log('üíª Ultimate Challenge - Desktop, llamando setupQuizChoices directamente');
    setupQuizChoices();
  }
}

function handleUltimateChallengeAnswerOLD(isCorrect, buttonClicked) {
  console.log(`üéØ Ultimate Challenge respuesta OLD: ${isCorrect ? 'CORRECTA' : 'INCORRECTA'}`);
  
  // Verificar que buttonClicked existe
  if (!buttonClicked) {
    console.error('‚ùå buttonClicked es null o undefined');
    return;
  }
  
  // Feedback visual
  if (isCorrect) {
    buttonClicked.style.background = 'linear-gradient(145deg, #90EE90, #32CD32)';
    buttonClicked.style.borderColor = '#228B22';
    buttonClicked.style.color = '#006400';
  } else {
    buttonClicked.style.background = 'linear-gradient(145deg, #FFB6C1, #FF69B4)';
    buttonClicked.style.borderColor = '#DC143C';
    buttonClicked.style.color = '#8B0000';
  }
  
  // Desactivar todos los botones
  const allButtons = document.querySelectorAll('#optionsContainer button');
  allButtons.forEach(btn => {
    btn.disabled = true;
    btn.style.cursor = 'not-allowed';
  });
  
  // Procesar respuesta
  if (isCorrect) {
    score++;
    xpPoints++;
  }
  
  totalAnswered++;
  
  // Avanzar al siguiente
  setTimeout(() => {
    ultimateChallengeCardIndex++;
    
    // Verificar si cambiar de animal (cada 5 cartas)
    if (ultimateChallengeCardIndex % 5 === 0) {
      ultimateChallengeAnimalIndex++;
    }
    
    // Verificar si termin√≥ el desaf√≠o
    if (ultimateChallengeCardIndex >= ultimateChallengeCards.length) {
      finishUltimateChallenge();
    } else {
      nextCard();
    }
  }, 1500);
}

async function finishUltimateChallenge() {
  console.log('üèÅ Finalizando Ultimate Challenge');
  console.log('- sessionCorrect:', sessionCorrect);
  console.log('- sessionTotal:', sessionTotal);
  console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
  
  // Usar variables correctas de sesi√≥n
  const totalQuestions = 60;
  const correctAnswers = sessionCorrect;
  const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
  
  console.log(`üìä Resultado final: ${percentage}% (${correctAnswers}/${totalQuestions})`);
  
  // Resetear estado
  ultimateChallengeActive = false;
  ultimateChallengeCards = [];
  ultimateChallengeCurrentAnimal = '';
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeCardIndex = 0;
  ultimateChallengeHearts = 3;
  
  // Ocultar corazones y timer
  hideUltimateChallengeHearts();
  stopUltimateChallengeTimer();
  
  // Mostrar resultado
  if (percentage >= 85) {
    console.log('üéâ ¬°ULTIMATE CHALLENGE COMPLETADO!');
    
    // COMPLETAR ULTIMATE CHALLENGE Y CONVERTIRSE EN MAESTsRO DEL HOR√ìSCOPO
    try {
      await completeUltimateChallenge();
      console.log('üèÜ Ultimate Challenge registrado exitosamente');
    } catch (error) {
      console.error('‚ùå Error registrando Ultimate Challenge:', error);
    }
    
    // Mensaje de √©xito
    showUltimateChallengeSuccess(percentage, correctAnswers, totalQuestions);
  } else {
    // No alcanz√≥ el m√≠nimo
    showUltimateChallengeFailure(percentage, correctAnswers, totalQuestions);
  }
}

// Mostrar mensaje de √©xito Ultimate Challenge
function showUltimateChallengeSuccess(percentage, correct, total) {
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
  overlay.style.backdropFilter = 'blur(5px)';
  
  const messageBox = document.createElement('div');
  messageBox.className = 'bg-gradient-to-br from-yellow-600 to-orange-700 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-yellow-400';
  
  messageBox.innerHTML = `
    <div class="text-6xl mb-4">üèÜ</div>
    <h2 class="text-3xl font-bold mb-4 text-yellow-200">¬°ULTIMATE CHALLENGE COMPLETADO!</h2>
    <div class="text-lg mb-6 leading-relaxed">
      <p class="mb-4">üìä Resultado: <span class="font-bold text-2xl">${percentage}%</span></p>
      <p class="mb-4">‚úÖ Correctas: ${correct}/${total}</p>
      <p class="mb-4">ÔøΩ ¬°Eres un maestro del hor√≥scopo chino!</p>
      <div class="bg-yellow-700 px-4 py-3 rounded-xl text-lg font-bold border border-yellow-400">
        ÔøΩ ${ultimateChallengeCompletedCount === 1 ? 'Maestro del Hor√≥scopo desbloqueado' : `Ultimate Challenge completado ${ultimateChallengeCompletedCount} veces`}
      </div>
    </div>
    <button class="bg-yellow-600 hover:bg-yellow-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors w-full">
      ¬°Continuar!
    </button>
  `;
  
  const continueBtn = messageBox.querySelector('button');
  continueBtn.onclick = () => {
    overlay.remove(); 
    exitUltimateChallenge();
  };
  
  overlay.appendChild(messageBox);
  document.body.appendChild(overlay);
  
  // Confetti especial
  setTimeout(() => showConfetti(), 500);
}

// Mostrar mensaje de fallo Ultimate Challenge
function showUltimateChallengeFailure(percentage, correct, total) {
  const overlay = document.createElement('div');
  overlay.className = 'fixed inset-0 z-[99999] bg-black/75 flex items-center justify-center p-4';
  overlay.style.backdropFilter = 'blur(5px)';
  
  const messageBox = document.createElement('div');
  messageBox.className = 'bg-gradient-to-br from-red-700 to-red-900 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-500';
  
  messageBox.innerHTML = `
    <div class="text-6xl mb-4">üòî</div>
    <h2 class="text-3xl font-bold mb-4 text-red-200">Casi lo logras</h2>
    <div class="text-lg mb-6 leading-relaxed">
      <p class="mb-4">üìä Resultado: <span class="font-bold text-2xl">${percentage}%</span></p>
      <p class="mb-4">‚úÖ Correctas: ${correct}/${total}</p>
      <p class="mb-4">üéØ Necesitas 85% o m√°s</p>
      <p class="text-red-300">üí™ ¬°Int√©ntalo de nuevo!</p>
    </div>
    <button class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors w-full">
      Reintentar
    </button>
  `;
  
  const continueBtn = messageBox.querySelector('button');
  continueBtn.onclick = () => {
    overlay.remove();
    exitUltimateChallenge();
  };
  
  overlay.appendChild(messageBox);
  document.body.appendChild(overlay);
}

// --- DESAF√çO FINAL DEL HOR√ìSCOPO ---
// Mostrar modal informativo antes del Ultimate Challenge
function showUltimateChallengeInfo() {
  const modal = document.createElement('div');
  modal.id = 'ultimateChallengeInfoModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #9c88ff;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(156, 136, 255, 0.3);
      position: relative;
    ">

      
      <h2 style="
        color: #9c88ff;
        font-family: 'Jersey 10', monospace;
        font-size: 28px;
        margin: 5px 0;
        text-shadow: 2px 2px 0px #4c1d95;
      ">‚öîÔ∏è DESAF√çO HOR√ìSCOPO ‚öîÔ∏è</h2>
      
      <!-- Imagen de portada con glow dorado -->
      <div style="display: flex; justify-content: center; margin: 15px 0;">
        <img src="img/desafiofinal.webp" alt="Desaf√≠o Final" 
             style="width: 192px; 
                    height: 320px; 
                    object-fit: cover; 
                    border-radius: 8px;
                    border: 3px solid #FFF8DC; 
                    box-shadow: 
                      0 0 20px rgba(255, 248, 220, 0.7),
                      0 0 40px rgba(255, 235, 150, 0.5),
                      0 0 60px rgba(255, 215, 0, 0.3),
                      inset 0 0 10px rgba(255, 248, 220, 0.2);
                    /* Animaci√≥n removida para mejor rendimiento */
                    transform: scale(1) translateZ(0);
                    opacity: 1;" 
             onerror="this.style.display='none'">
      </div>
      
      <!-- Estilos CSS para la animaci√≥n del modal de instrucciones -->
      <style>
        /* @keyframes instructionsGoldenGlow - REMOVIDO PARA MEJOR RENDIMIENTO */
      </style>
      
      <h3 style="
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 28px;
        margin: 0px 0;
        text-shadow: 1px 1px 0px #000000;
      ">MAESTRO DEL HOR√ìSCOPO</h3>
      
      <div style="
        background: rgba(156, 136, 255, 0.1);
        border: 2px solid #9c88ff;
        border-radius: 6px;
        padding: 10px 20px;
        margin: 5px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.3;
        text-align: left;
      ">
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #FFD700;">‚è±Ô∏è Tiempo:</span> 500 segundos</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #87ceeb;">üí° 60 Preguntas:</span> 5 de cada animal</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ff6b6b;">‚ù§Ô∏è Vidas:</span> Solo 3 oportunidades</div>
        <div style="margin: 7px 0;">‚Ä¢ <span style="color: #ffa500;">‚ö° Penalizaci√≥n:</span> PIERDES 3 caracteres de tu Colecci√≥n al AZAR</div>
      </div>
      
      <div style="
        display: flex;
        gap: 5px;
        justify-content: center;
        margin-top: 15px;
      ">
        <button onclick="actualStartUltimateChallenge()" style="
          background: linear-gradient(135deg, #9c88ff, #7c3aed);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-family: 'Jersey 10', monospace;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(156, 136, 255, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚öîÔ∏è¬°EMPEZAR!
        </button>
        
        <button onclick="closeUltimateChallengeInfo()" style="
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-family: 'Jersey 10', monospace;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚ùå Tengo Miedo
        </button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  
  console.log("‚úÖ Modal del Ultimate Challenge mostrado exitosamente");
}

// Cerrar modal de informaci√≥n del Ultimate Challenge
function closeUltimateChallengeInfo() {
  const modal = document.getElementById('ultimateChallengeInfoModal');
  if (modal) {
    modal.remove();
  }
}

// Mostrar mensaje de que el hor√≥scopo est√° bloqueado
function showHoroscopeLockedMessage() {
  // ‚úÖ FUNCI√ìN COMPLETAMENTE DESINTEGRADA - NO HAY REQUISITOS
  console.log('‚úÖ Hor√≥scopo siempre desbloqueado - modal eliminado');
  return;
}

// Cerrar modal de hor√≥scopo bloqueado - FUNCI√ìN DESINTEGRADA
function closeHoroscopeLockedMessage() {
  // ‚úÖ NO HACE NADA - Modal eliminado completamente
}

// Modal para "Los Hor√≥scopo" bloqueado (requiere Cruzar el Cielo)
function showLosHoroscopoLockedMessage() {
  // ‚úÖ FUNCI√ìN DESINTEGRADA - NO HACE NADA, NO HAY REQUISITOS
  console.log('‚úÖ Los Hor√≥scopo siempre desbloqueado - modal eliminado');
  return;

  // Modal eliminado - no hay requisitos
}

// Cerrar modal de "Los Hor√≥scopo" bloqueado - FUNCI√ìN DESINTEGRADA
function closeLosHoroscopoLockedMessage() {
  // ‚úÖ NO HACE NADA - Modal eliminado
}

// === MODALES DE NIVELES BLOQUEADOS ===

// Mostrar mensaje de Nivel 2 bloqueado
function showLevel2LockedMessage() {
  const modal = document.createElement('div');
  modal.id = 'level2LockedModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  // Verificar el progreso actual del usuario
  const n1Completed = desafioN1Completed;
  const marCompleted = cruzarMarCompleted;
  
  // Generar HTML din√°mico basado en progreso
  const n1Status = n1Completed 
    ? '<span style="color: #4ade80;">‚úÖ Completado</span>' 
    : '<span style="color: #ef4444;">‚ùå Pendiente</span>';
  
  const marStatus = marCompleted
    ? '<span style="color: #4ade80;">‚úÖ Completado</span>'
    : '<span style="color: #ef4444;">‚ùå Pendiente</span>';

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
      position: relative;
    ">
      <div style="font-size: 60px; margin-bottom: 10px;">üîí</div>
      
      <h2 style="
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 10px 0;
        text-shadow: 2px 2px 0px #8b0000;
      ">üìï NIVEL 2 BLOQUEADO</h2>
      
      <div style="
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid #ff6b6b;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.6;
        text-align: left;
      ">
        <div style="margin-bottom: 15px;">
          <strong style="color: #ff6b6b;">üìã PROGRESO DE DESBLOQUEO:</strong>
        </div>
        <div style="margin: 12px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #FFD700;">1Ô∏è‚É£ Desaf√≠o N1</span>
            ${n1Status}
          </div>
        </div>
        <div style="margin: 12px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #06b6d4;">üåä Cruzar el Mar</span>
            ${marStatus}
          </div>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,107,107,0.3); color: #a0aec0; font-size: 16px;">
          ${n1Completed && !marCompleted 
            ? 'üí° <strong>Siguiente paso:</strong> ¬°Completa Cruzar el Mar para desbloquear Nivel 2!'
            : !n1Completed
            ? 'üí° <strong>Siguiente paso:</strong> Completa Desaf√≠o N1 para desbloquear Cruzar el Mar'
            : 'üéâ <strong>¬°Ya casi!</strong> Solo falta un poco m√°s...'}
        </div>
      </div>
      
      <button onclick="closeLevel2LockedMessage()" style="
        background: linear-gradient(135deg, #ff6b6b, #e55a5a);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        margin-top: 10px;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        ENTENDIDO
      </button>
    </div>
  `;

  document.body.appendChild(modal);
}

// Cerrar modal de Nivel 2 bloqueado
function closeLevel2LockedMessage() {
  const modal = document.getElementById('level2LockedModal');
  if (modal) {
    modal.remove();
  }
}

// Mostrar mensaje de Nivel 3 bloqueado
function showLevel3LockedMessage() {
  const modal = document.createElement('div');
  modal.id = 'level3LockedModal';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 99999;
    animation: fadeIn 0.3s ease-out;
  `;

  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border: 3px solid #ff6b6b;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
      position: relative;
    ">
      <div style="font-size: 60px; margin-bottom: 10px;">üîí</div>
      
      <h2 style="
        color: #ff6b6b;
        font-family: 'Jersey 10', monospace;
        font-size: 24px;
        margin: 10px 0;
        text-shadow: 2px 2px 0px #8b0000;
      ">üìó NIVEL 3 BLOQUEADO</h2>
      
      <div style="
        background: rgba(255, 107, 107, 0.1);
        border: 2px solid #ff6b6b;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        color: #ffffff;
        font-family: 'Jersey 10', monospace;
        font-size: 18px;
        line-height: 1.6;
        text-align: left;
      ">
        <div style="margin-bottom: 15px;">
          <strong style="color: #ff6b6b;">üìã REQUISITOS:</strong>
        </div>
        <div style="margin: 8px 0;">
          <strong style="color: #FFD700;">1Ô∏è‚É£</strong> Completar <strong style="color: #fbbf24;">Desaf√≠o N2</strong>
        </div>
        <div style="margin: 8px 0;">
          <strong style="color: #FFD700;">2Ô∏è‚É£</strong> Completar <strong style="color: #fb923c;">Cruzar el Cielo</strong>
        </div>
      </div>
      
      <button onclick="closeLevel3LockedMessage()" style="
        background: linear-gradient(135deg, #ff6b6b, #e55a5a);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-family: 'Jersey 10', monospace;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        margin-top: 10px;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        ENTENDIDO
      </button>
    </div>
  `;

  document.body.appendChild(modal);
}

// Cerrar modal de Nivel 3 bloqueado
function closeLevel3LockedMessage() {
  const modal = document.getElementById('level3LockedModal');
  if (modal) {
    modal.remove();
  }
}

// Mostrar mensaje de que el hor√≥scopo est√° bloqueado - DESINTEGRADO
// (Esta es una funci√≥n duplicada que ha sido eliminada)

// Nueva funci√≥n que muestra el modal informativo
function startUltimateChallenge() {
  showUltimateChallengeInfo();
}

async function actualStartUltimateChallenge() {
  console.log('üèÜ Iniciando Desaf√≠o Final del Hor√≥scopo');
  
  // Limpiar colores especiales de tarjetas al iniciar
  clearAllChallengeThemes();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Cerrar modal del Ultimate Challenge
  closeUltimateChallengeInfo();
  
  // ‚úÖ SIN REQUISITOS - SIEMPRE DISPONIBLE (verificaci√≥n de 12 animales removida)
  
  // Preparar las 60 cartas (5 de cada categor√≠a en orden fijo)
  ultimateChallengeCards = [];
  
  for (const item of ultimateChallengeOrder) {
    const categoryCards = cards.filter(c => c.unit === item.categoria);
    
    if (categoryCards.length < 5) {
      console.warn(`‚ö†Ô∏è Categor√≠a ${item.categoria} tiene menos de 5 cartas (${categoryCards.length})`);
    }
    
    // Seleccionar 5 cartas al azar de esta categor√≠a
    const shuffled = categoryCards.sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, Math.min(5, categoryCards.length));
    
    // Agregar metadata del animal actual
    selected.forEach(card => {
      ultimateChallengeCards.push({
        ...card,
        currentAnimal: item.animal,
        currentCategory: item.categoria
      });
    });
  }
  
  console.log(`üéØ Desaf√≠o Final preparado: ${ultimateChallengeCards.length} cartas`);
  
  // Configurar variables de estado
  ultimateChallengeActive = true;
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeCardIndex = 0;
  ultimateChallengeCurrentAnimal = ultimateChallengeOrder[0].animal;
  
  // Configurar estado del desaf√≠o final
  ultimateChallengeActive = true;
  currentMission = 'ultimateChallenge';
  ultimateChallengeCardIndex = 0;
  ultimateChallengeAnimalIndex = 0;
  ultimateChallengeHearts = 3; // Reiniciar vidas a 3
  todayReviewed = 0;
  sessionTotal = ultimateChallengeCards.length;
  sessionCorrect = 0;
  
  // IMPORTANTE: Ocultar botones de quiz para Ultimate Challenge
  updateQuizButtonsVisibility('ultimateChallenge');
  
  // DEBUG: Estado inicial
  console.log('üîç DEBUG Estado inicial Ultimate Challenge:');
  console.log('- ultimateChallengeActive:', ultimateChallengeActive);
  console.log('- ultimateChallengeCardIndex:', ultimateChallengeCardIndex);
  console.log('- ultimateChallengeAnimalIndex:', ultimateChallengeAnimalIndex);
  console.log('- currentMission:', currentMission);
  console.log('- Element statMission exists:', !!document.getElementById('statMission'));
  
  // IMPORTANTE: Configurar sessionQueue para que el sistema de quiz funcione
  sessionQueue = [...ultimateChallengeCards]; // Copia las cartas del Ultimate Challenge
  console.log(`üéØ SessionQueue configurado con ${sessionQueue.length} cartas para Ultimate Challenge`);
  
  // Aplicar tema visual de desaf√≠o (como en desaf√≠os hor√≥scopo)
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  
  // Precargar video de fondo y reproducir m√∫sica de desaf√≠o
  await createChallengeVideoWithPreload('ultimateChallenge', () => {
    // Iniciar timer solo despu√©s de que el video est√© listo
    showUltimateChallengeHearts();
    startUltimateChallengeTimer();
    
    // Empezar con la primera carta
    nextCard();
    updateStats();
  });
  
  // playDesafioMusic('ultimateChallenge'); // ‚ú® MOVIDO AL COUNTDOWN
  
  // El modo se configurar√° autom√°ticamente en renderUltimateChallengeCard()
}

// --- Funciones para el sistema de vidas del Ultimate Challenge ---
function showUltimateChallengeHearts() {
  // Crear o actualizar el display de corazones
  let heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (!heartsContainer) {
    heartsContainer = document.createElement('div');
    heartsContainer.id = 'ultimateHeartsContainer';
    heartsContainer.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 20px;
      border: 2px solid #FFD700;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    `;
    document.body.appendChild(heartsContainer);
    console.log('‚úÖ DEBUG: Contenedor de vidas agregado al DOM');
  }
  
  updateUltimateChallengeHearts();
}

function updateUltimateChallengeHearts() {
  const heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (!heartsContainer) return;
  
  let heartsHTML = '<div style="color: #FFD700; font-size: 14px; font-family: \'Jersey 10\', monospace; font-weight: bold; text-align: center; margin-bottom: 5px; text-shadow: 1px 1px 0px #b8860b; letter-spacing: 1px;">VIDAS</div>';
  heartsHTML += '<div style="display: flex; gap: 3px; justify-content: center;">';
  
  for (let i = 0; i < 3; i++) {
    if (i < ultimateChallengeHearts) {
      // Coraz√≥n pixel art lleno - rosa m√°s suave
      heartsHTML += '<span style="color: #ff69b4; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #d1477a;">‚ô•</span>';
    } else {
      // Coraz√≥n pixel art vac√≠o
      heartsHTML += '<span style="color: #444; font-size: 18px; font-family: \'Jersey 10\', monospace; text-shadow: 1px 1px 0px #222;">‚ô°</span>';
    }
  }
  
  heartsHTML += '</div>';
  heartsContainer.innerHTML = heartsHTML;
}

function hideUltimateChallengeHearts() {
  const heartsContainer = document.getElementById('ultimateHeartsContainer');
  if (heartsContainer) {
    heartsContainer.remove();
  }
}

// === FUNCIONES DEL TIMER DEL ULTIMATE CHALLENGE ===

// Mostrar timer del Ultimate Challenge
function showUltimateChallengeTimer() {
  // Remover timer anterior si existe
  hideUltimateChallengeTimer();
  
  const timerDisplay = document.createElement('div');
  timerDisplay.id = 'ultimateChallengeTimer';
  timerDisplay.style.position = 'fixed';
  timerDisplay.style.top = '20px';
  timerDisplay.style.left = '20px';
  timerDisplay.style.zIndex = '99998';
  timerDisplay.style.background = 'rgba(0, 0, 0, 0.8)';
  timerDisplay.style.color = '#FFD700';
  timerDisplay.style.padding = '12px 16px';
  timerDisplay.style.borderRadius = '12px';
  timerDisplay.style.fontSize = '18px';
  timerDisplay.style.fontWeight = 'bold';
  timerDisplay.style.border = '2px solid #FFD700';
  timerDisplay.style.boxShadow = '0 4px 12px rgba(255, 69, 0, 0.4)';
  timerDisplay.style.fontFamily = '\'Jersey 10\', monospace';
  timerDisplay.style.textShadow = '1px 1px 0px #b8860b';
  timerDisplay.style.letterSpacing = '1px';
  timerDisplay.style.width = '120px';
  timerDisplay.style.textAlign = 'center';
  timerDisplay.style.minWidth = '120px';
  timerDisplay.style.maxWidth = '120px';
  
  updateUltimateChallengeTimer();
  document.body.appendChild(timerDisplay);
  console.log('‚è∞ Timer del Ultimate Challenge mostrado');
}

// Actualizar display del timer
function updateUltimateChallengeTimer() {
  const timerDisplay = document.getElementById('ultimateChallengeTimer');
  if (!timerDisplay) return;
  
  const minutes = Math.floor(ultimateChallengeTimer / 60);
  const seconds = ultimateChallengeTimer % 60;
  const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  // Usar contenido con ancho fijo
  let icon = '‚è±';
  let bgStyle = 'rgba(0, 0, 0, 0.8)';
  let animation = '';
  
  if (ultimateChallengeTimer <= 60) {
    icon = 'üö®';
    bgStyle = 'linear-gradient(135deg, #DC143C, #B22222)';
    animation = 'animation: pulse 1s infinite;';
  } else if (ultimateChallengeTimer <= 120) {
    icon = '‚ö†';
    bgStyle = 'linear-gradient(135deg, #FF6347, #FF4500)';
  }
  
  timerDisplay.style.background = bgStyle;
  timerDisplay.style.animation = ultimateChallengeTimer <= 60 ? 'pulse 1s infinite' : '';
  timerDisplay.innerHTML = `<span style="color: #FFD700; text-shadow: 1px 1px 0px #b8860b; font-family: 'Jersey 10', monospace; ${animation}">${icon} ${timeString}</span>`;
}

// Ocultar timer del Ultimate Challenge
function hideUltimateChallengeTimer() {
  const timerDisplay = document.getElementById('ultimateChallengeTimer');
  if (timerDisplay) {
    timerDisplay.remove();
    console.log('‚è∞ Timer del Ultimate Challenge ocultado');
  }
}

// Iniciar countdown del timer
function startUltimateChallengeTimer() {
  // Limpiar timer anterior si existe
  if (ultimateChallengeTimerInterval) {
    clearInterval(ultimateChallengeTimerInterval);
  }
  
  ultimateChallengeTimer = 500; // Reiniciar a 500 segundos
  showUltimateChallengeTimer();
  
  ultimateChallengeTimerInterval = setInterval(() => {
    ultimateChallengeTimer--;
    updateUltimateChallengeTimer();
    
    // Si se acaba el tiempo, el jugador pierde
    if (ultimateChallengeTimer <= 0) {
      clearInterval(ultimateChallengeTimerInterval);
      hideUltimateChallengeTimer();
      hideUltimateChallengeHearts();
      showUltimateChallengeTimeUp();
    }
  }, 1000);
  
  console.log('‚è∞ Timer del Ultimate Challenge iniciado (500 segundos)');
}

// Detener timer del Ultimate Challenge
function stopUltimateChallengeTimer() {
  if (ultimateChallengeTimerInterval) {
    clearInterval(ultimateChallengeTimerInterval);
    ultimateChallengeTimerInterval = null;
    
    // üîç DESACTIVAR MONITOREO DE RENDIMIENTO
    performanceMonitor.stopMonitoring();
    console.log('‚è∞ Timer del Ultimate Challenge detenido');
  }
  hideUltimateChallengeTimer();
}

// === SISTEMA DE NOTIFICACIONES POST-DESAF√çO ===

// Capturar estado inicial del desaf√≠o (EXCLUIR badges del hor√≥scopo)
function capturePreChallengeState() {
  challengeStartState = cards.filter(c => 
    c.known && 
    !c.isHoroscopeAnimal && 
    c.unit !== 'horoscopo'
  ).map(card => ({
    id: card.id,
    hanzi: card.hanzi,
    pinyin: card.pinyin,
    meaning: card.meaning,
    challengeStreak: card.challengeStreak || 0,
    known: card.known
  }));
  console.log('üì∑ Estado pre-desaf√≠o capturado:', challengeStartState.length, 'cartas conocidas (sin badges hor√≥scopo)');
}

// Capturar estado final y mostrar notificaci√≥n (EXCLUIR badges del hor√≥scopo)
function capturePostChallengeState() {
  challengeEndState = cards.filter(c => 
    c.known && 
    !c.isHoroscopeAnimal && 
    c.unit !== 'horoscopo'
  ).map(card => ({
    id: card.id,
    hanzi: card.hanzi,
    pinyin: card.pinyin,
    meaning: card.meaning,
    challengeStreak: card.challengeStreak || 0,
    known: card.known
  }));
  
  const changes = analyzeChallengeChanges();
  
  // Modal especial para Desaf√≠o N3
  if (currentMission === 'desafioN3') {
    showDesafioN3CompleteModal(changes);
  } else if (changes.levelsUp.length > 0 || changes.lost.length > 0) {
    showChallengeChangesNotification(changes);
  }
}

// Analizar cambios entre estado inicial y final
function analyzeChallengeChanges() {
  const startMap = new Map();
  challengeStartState.forEach(card => {
    startMap.set(card.id, card);
  });
  
  const endMap = new Map();
  challengeEndState.forEach(card => {
    endMap.set(card.id, card);
  });
  
  const changes = {
    levelsUp: [],
    lost: []
  };
  
  // Detectar subidas de nivel (EXCLUIR animales del hor√≥scopo)
  challengeEndState.forEach(endCard => {
    const startCard = startMap.get(endCard.id);
    if (startCard && endCard.challengeStreak > startCard.challengeStreak) {
      // Buscar la tarjeta completa - mejorar b√∫squeda para IDs undefined
      let fullCard;
      if (endCard.id && endCard.id !== 'undefined') {
        // B√∫squeda normal por ID
        fullCard = cards.find(card => card.id === endCard.id);
      } else {
        // Para badges del hor√≥scopo sin ID v√°lido, buscar por hanzi Y unit
        fullCard = cards.find(card => 
          card.hanzi === endCard.hanzi && 
          (card.unit === 'horoscopo' || card.isHoroscopeAnimal === true)
        );
      }
      
      console.log(`üîç DEBUG Changes Level Up: ${endCard.hanzi} (ID: ${endCard.id})`);
      console.log(`   - Streak inicial: ${startCard.challengeStreak}, Streak final: ${endCard.challengeStreak}`);
      console.log(`   - Tarjeta encontrada:`, fullCard ? {
        hanzi: fullCard.hanzi, 
        unit: fullCard.unit,
        isHoroscopeAnimal: fullCard.isHoroscopeAnimal,
        meaning: fullCard.meaning?.slice(0, 30) + '...'
      } : 'NO ENCONTRADA');
      
      // Solo permitir level up si:
      // 1. La tarjeta existe
      // 2. NO es animal del hor√≥scopo 
      // 3. NO tiene unit 'horoscopo' (badges del hor√≥scopo)
      if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
        const levelsGained = endCard.challengeStreak - startCard.challengeStreak;
        console.log(`‚úÖ Changes Level Up confirmado para: ${endCard.hanzi} (${fullCard.unit}) - Gan√≥ ${levelsGained} niveles`);
        changes.levelsUp.push({
          ...endCard,
          levelsGained: levelsGained,
          oldLevel: startCard.challengeStreak,
          newLevel: endCard.challengeStreak
        });
      } else {
        console.log(`üö´ Changes Excluido: ${endCard.hanzi} - Motivo:`, 
          !fullCard ? 'No encontrada' :
          fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
          fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
      }
    }
  });
  
  // Detectar cartas perdidas (que estaban en start pero no en end) - EXCLUIR animales del hor√≥scopo
  challengeStartState.forEach(startCard => {
    if (!endMap.has(startCard.id)) {
      // Verificar si es animal del hor√≥scopo antes de agregar como perdida - mejorar b√∫squeda para IDs undefined
      let fullCard;
      if (startCard.id && startCard.id !== 'undefined') {
        fullCard = cards.find(card => card.id === startCard.id);
      } else {
        fullCard = cards.find(card => 
          card.hanzi === startCard.hanzi && 
          (card.unit === 'horoscopo' || card.isHoroscopeAnimal === true)
        );
      }
      
      console.log(`üîç DEBUG Changes Lost: ${startCard.hanzi} (ID: ${startCard.id})`);
      
      // Solo agregar como perdida si NO es animal del hor√≥scopo
      if (fullCard && !fullCard.isHoroscopeAnimal && fullCard.unit !== 'horoscopo') {
        console.log(`üíî Changes Lost confirmado para: ${startCard.hanzi} (${fullCard.unit})`);
        changes.lost.push(startCard);
      } else {
        console.log(`üö´ Changes Lost excluido: ${startCard.hanzi} - Motivo:`, 
          !fullCard ? 'No encontrada' :
          fullCard.isHoroscopeAnimal ? 'Es animal hor√≥scopo' : 
          fullCard.unit === 'horoscopo' ? 'Es badge hor√≥scopo' : 'Raz√≥n desconocida');
      }
    }
  });
  
  return changes;
}

// Mostrar notificaci√≥n de cambios
// Modal especial estilo pixel art para Desaf√≠o N3
function showDesafioN3CompleteModal(changes) {
  const modal = document.createElement('div');
  modal.className = 'desafio-n3-complete-overlay';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    font-family: 'Jersey 10', monospace;
  `;
  
  const percent = sessionTotal > 0 ? Math.round((sessionCorrect / sessionTotal) * 100) : 0;
  const isApproved = percent >= 85;
  
  let content = `
    <div style="
      background: linear-gradient(145deg, #2d3748, #1a202c);
      border: 4px solid ${isApproved ? '#48bb78' : '#f56565'};
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      text-align: center;
      color: white;
      box-shadow: 
        0 0 30px ${isApproved ? 'rgba(72, 187, 120, 0.5)' : 'rgba(245, 101, 101, 0.5)'},
        inset 0 2px 4px rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    ">
      
      <!-- Decoraci√≥n pixel art -->
      <div style="
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        height: 8px;
        background: repeating-linear-gradient(
          90deg,
          ${isApproved ? '#48bb78' : '#f56565'} 0px,
          ${isApproved ? '#48bb78' : '#f56565'} 4px,
          transparent 4px,
          transparent 8px
        );
      "></div>
      
      <!-- T√≠tulo principal -->
      <div style="
        font-size: 3rem;
        margin-bottom: 1rem;
        text-shadow: 3px 3px 0px #000000;
        color: ${isApproved ? '#48bb78' : '#f56565'};
      ">${isApproved ? 'üéØ' : 'üíî'}</div>
      
      <h2 style="
        font-size: 1.8rem;
        margin-bottom: 1.5rem;
        text-shadow: 2px 2px 0px #000000;
        color: #f7fafc;
      ">${isApproved ? '¬°DESAF√çO N3 COMPLETADO!' : 'DESAF√çO N3 FALLIDO'}</h2>
      
      <!-- Estad√≠sticas -->
      <div style="
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      ">
        <div style="font-size: 2rem; color: ${isApproved ? '#48bb78' : '#f56565'}; margin-bottom: 0.5rem;">
          ${sessionCorrect}/${sessionTotal} correctas
        </div>
        <div style="font-size: 1.5rem; color: #a0aec0;">
          ${percent}% de aciertos
        </div>
        ${isApproved ? '<div style="font-size: 1rem; color: #48bb78; margin-top: 0.5rem;">¬°Logro desbloqueado! üèÜ</div>' : '<div style="font-size: 1rem; color: #f56565; margin-top: 0.5rem;">Necesitas 85% para aprobar</div>'}
      </div>
  `;
  
  // Mostrar cambios si los hay
  if (changes.levelsUp.length > 0) {
    content += `
      <div style="
        background: rgba(72, 187, 120, 0.1);
        border: 2px solid #48bb78;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: left;
      ">
        <h3 style="color: #48bb78; margin-bottom: 0.5rem; font-size: 1.2rem;">üéâ Mejoras conseguidas:</h3>
        <div style="max-height: 120px; overflow-y: auto;">
    `;
    
    changes.levelsUp.slice(0, 6).forEach(card => {
      content += `
        <div style="
          background: rgba(0, 0, 0, 0.2);
          padding: 0.5rem;
          margin-bottom: 0.3rem;
          border-radius: 4px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        ">
          <span style="color: white; font-size: 0.9rem;">
            ${card.hanzi} (${card.pinyin})
          </span>
          <span style="color: #48bb78; font-weight: bold;">
            +${card.levelsGained} üìà
          </span>
        </div>
      `;
    });
    
    if (changes.levelsUp.length > 6) {
      content += `<div style="color: #a0aec0; text-align: center; font-size: 0.8rem;">+${changes.levelsUp.length - 6} m√°s...</div>`;
    }
    
    content += `</div></div>`;
  }
  
  // Bot√≥n de cerrar
  content += `
      <button onclick="this.parentElement.parentElement.remove()" style="
        background: linear-gradient(145deg, #4299e1, #3182ce);
        border: 3px solid #2d3748;
        border-radius: 8px;
        color: white;
        font-family: 'Jersey 10', monospace;
        font-size: 1.2rem;
        padding: 0.8rem 2rem;
        cursor: pointer;
        box-shadow: 
          0 4px 8px rgba(0, 0, 0, 0.3),
          inset 0 2px 4px rgba(255, 255, 255, 0.2);
        text-shadow: 1px 1px 0px #000000;
        transition: transform 0.1s;
      " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform='scale(1)'" onmouseleave="this.style.transform='scale(1)'">
        ¬°ENTENDIDO!
      </button>
      
      <!-- Decoraci√≥n inferior -->
      <div style="
        position: absolute;
        bottom: -2px;
        left: -2px;
        right: -2px;
        height: 8px;
        background: repeating-linear-gradient(
          90deg,
          ${isApproved ? '#48bb78' : '#f56565'} 0px,
          ${isApproved ? '#48bb78' : '#f56565'} 4px,
          transparent 4px,
          transparent 8px
        );
      "></div>
    </div>
  `;
  
  modal.innerHTML = content;
  document.body.appendChild(modal);
  
  // Efecto de entrada con animaci√≥n
  modal.style.opacity = '0';
  modal.style.transform = 'scale(0.8)';
  setTimeout(() => {
    modal.style.transition = 'all 0.3s ease-out';
    modal.style.opacity = '1';
    modal.style.transform = 'scale(1)';
  }, 10);
}

function showChallengeChangesNotification(changes) {
  // Asegurar estilos Pixel/Jersey 10 disponibles para el modal de resultados
  ensureResultsPixelStyles();
  const modal = document.createElement('div');
  modal.className = 'pixel-overlay pixel-results fixed inset-0 z-[99999] flex items-center justify-center p-4';
  // Fallback inline for non-Tailwind envs
  modal.style.position = 'fixed';
  modal.style.inset = '0';
  modal.style.zIndex = '99999';
  modal.style.display = 'flex';
  modal.style.alignItems = 'center';
  modal.style.justifyContent = 'center';
  modal.style.padding = '1rem';
  
  let content = `
    <div class="pixel-panel jersey-font-niveles p-6 sm:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto" style="padding:24px; width:min(100%, 768px); max-height:90vh; overflow-y:auto;">
      <div class="text-center mb-2" style="font-size: 32px;">üìä</div>
      <h2 class="pixel-title jersey-font-niveles" style="font-size: 34px; font-weight: 800; text-align:center; margin-bottom: 12px;">Resultados del Desaf√≠o</h2>
      
      <!-- Bot√≥n superior para ir directo a repasar -->
      <button class="closeChangesBtn pixel-button alt jersey-font-niveles" style="width: auto; min-width: 160px; margin: 0 auto 20px auto; display:block;">
        ¬°Ir a Revisar!
      </button>
  `;
  
  // Mostrar subidas de nivel
  if (changes.levelsUp.length > 0) {
    content += `
      <div style="margin-bottom: 16px;">
        <h3 class="jersey-font-niveles" style="font-size: 18px; font-weight: 800; color: #86efac; text-shadow: 1px 1px 0 #000; margin-bottom: 10px;">üéâ Mejoras de tu Colecci√≥n:</h3>
        <div class="pixel-grid">
    `;
    
    changes.levelsUp.forEach(card => {
      content += `
        <div class="pixel-item green card-animate" style="opacity: 0; transform: translateY(10px);">
          <div class="item-line">
            <span class="keep-hanzi">${card.hanzi}</span>
            <span class="jersey-font-niveles"> (</span>
            <span class="keep-pinyin">${card.pinyin}</span>
            <span class="jersey-font-niveles">)</span>
          </div>
          <div class="item-meaning" title="${card.meaning}">${card.meaning}</div>
          <div class="item-delta up jersey-font-niveles">
            ${card.oldLevel} ‚Üí ${card.newLevel} (+${card.levelsGained})
          </div>
        </div>
      `;
    });
    
    content += `</div></div>`;
  }
  
  // Mostrar cartas perdidas
  if (changes.lost.length > 0) {
    content += `
      <div style="margin-bottom: 16px;">
        <h3 class="jersey-font-niveles" style="font-size: 18px; font-weight: 800; color: #fca5a5; text-shadow: 1px 1px 0 #000; margin-bottom: 10px;">üòî Has perdido a:</h3>
        <div class="pixel-grid">
    `;
    
    changes.lost.forEach(card => {
      content += `
        <div class="pixel-item red card-animate" style="opacity: 0; transform: translateY(10px);">
          <div class="item-line">
            <span class="keep-hanzi">${card.hanzi}</span>
            <span class="jersey-font-niveles"> (</span>
            <span class="keep-pinyin">${card.pinyin}</span>
            <span class="jersey-font-niveles">)</span>
          </div>
          <div class="item-meaning" title="${card.meaning}">${card.meaning}</div>
          <div class="item-delta down jersey-font-niveles">
            Era nivel ${card.challengeStreak}
          </div>
        </div>
      `;
    });
    
    content += `</div></div>`;
  }
  
  content += `
      <div style="height:10px;"></div>
      <button class="closeChangesBtn pixel-button alt jersey-font-niveles" style="width: auto; min-width: 160px; margin: 0 auto; display:block;">
        ¬°Ir a Revisar!
      </button>
    </div>
  `;
  
  modal.innerHTML = content;
  
  // Evento para cerrar y llevar a revise1 (ambos botones)
  modal.querySelectorAll('.closeChangesBtn').forEach(btn => {
    btn.onclick = () => {
      modal.remove();
      // Iniciar modo revise1
      startMission('revise1');
    };
  });
  
  // Tambi√©n cerrar al hacer clic fuera (solo cerrar, no ir a revise1)
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  document.body.appendChild(modal);
  
  // üéµ Reproducir sonido satisfactorio
  createChallengeResultsSound();
  
  // ‚ú® Aplicar fade in animado al modal
  modal.style.opacity = '0';
  modal.style.transform = 'scale(0.9)';
  modal.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
  
  // Trigger del fade in despu√©s de un frame
  requestAnimationFrame(() => {
    modal.style.opacity = '1';
    modal.style.transform = 'scale(1)';
  });
  
  // üé¨ ANIMAR CARTAS SECUENCIALMENTE (izquierda a derecha, fila por fila)
  setTimeout(() => {
    const allCards = modal.querySelectorAll('.card-animate');
    allCards.forEach((card, index) => {
      setTimeout(() => {
        card.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 200); // 200ms de delay entre cada carta
    });
  }, 400); // Esperar a que termine la animaci√≥n del modal
  
  console.log('üìä Notificaci√≥n de cambios mostrada:', {
    levelsUp: changes.levelsUp.length,
    lost: changes.lost.length
  });
}

// Inyector de estilos Pixel/Jersey 10 para el modal de Resultados del Desaf√≠o
function ensureResultsPixelStyles() {
  try {
    // Asegurar link de fuente Jersey 10 (ya suele existir, pero por si acaso)
    if (!document.querySelector('link[href*="Jersey+10"]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://fonts.googleapis.com/css2?family=Jersey+10:wght@400&display=swap';
      document.head.appendChild(link);
    }
    if (document.getElementById('resultsPixelStyles')) return;
    const style = document.createElement('style');
    style.id = 'resultsPixelStyles';
    style.textContent = `
      .jersey-font-niveles { font-family: 'Jersey 10', monospace; }
      .pixel-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
      .pixel-panel {
        background: linear-gradient(135deg, #1f1147, #0b0f2a);
        color: #fff;
        border: 4px solid #7c3aed;
        border-radius: 18px;
        box-shadow: 0 0 0 2px #000 inset, 0 6px 0 0 #0008, 0 12px 24px rgba(124,58,237,0.35);
        image-rendering: pixelated;
      }
      .pixel-title { color: #a78bfa; text-shadow: 2px 2px 0 #000, 0 0 10px rgba(167,139,250,0.6); letter-spacing: 1px; }
      .pixel-button {
        display: inline-block; padding: 12px 18px; background: linear-gradient(180deg, #60a5fa, #3b82f6);
        color:#fff; border:2px solid #000; border-bottom-width:6px; border-radius:12px; font-weight:700;
        box-shadow: 0 4px 0 rgba(0,0,0,0.35);
        transition: transform .12s ease, box-shadow .12s ease, filter .2s ease, border-bottom-width .12s ease;
        text-shadow: 1px 1px 0 #000;
      }
      .pixel-button:hover { filter: brightness(1.05); transform: translateY(-1px); box-shadow: 0 6px 0 rgba(0,0,0,0.35);} 
      .pixel-button:active { transform: translateY(2px); border-bottom-width:3px; box-shadow: 0 2px 0 rgba(0,0,0,0.35);} 
      .pixel-button.alt { background: linear-gradient(180deg, #60a5fa, #2563eb); }
      /* Grid y tarjetas */
      .pixel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
      .pixel-item { border: 2px solid #000; border-radius: 12px; padding: 10px; box-shadow: inset 0 0 0 2px rgba(255,255,255,0.07), 0 3px 0 rgba(0,0,0,0.4); background: rgba(0,0,0,0.25); }
      .pixel-item.green { border-color: #059669; box-shadow: inset 0 0 0 2px rgba(16,185,129,0.25), 0 3px 0 rgba(0,0,0,0.4); background: rgba(6,95,70,0.35); }
      .pixel-item.red { border-color: #b91c1c; box-shadow: inset 0 0 0 2px rgba(239,68,68,0.25), 0 3px 0 rgba(0,0,0,0.4); background: rgba(76,5,5,0.35); }
      /* Animaci√≥n secuencial de cartas */
      .card-animate {
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .item-line { font-size: 14px; font-weight: 800; color: #fff; text-shadow: 1px 1px 0 #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .item-meaning { font-size: 12px; color: #d1d5db; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
      .item-delta { font-size: 12px; margin-top: 6px; font-weight: 800; }
      .item-delta.up { color: #86efac; }
      .item-delta.down { color: #fca5a5; }
      /* Mantener fuentes originales para Hanzi y Pinyin */
      .keep-hanzi { font-family: var(--hanzi-font, 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', 'Heiti SC', 'Hiragino Sans GB', 'Arial Unicode MS', system-ui, sans-serif) !important; }
      .keep-pinyin { font-family: var(--pinyin-font, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif) !important; }
    `;
    document.head.appendChild(style);
  } catch (e) { /* noop */ }
}

// Modal de tiempo agotado
function showUltimateChallengeTimeUp() {
  console.log('‚è∞ TIEMPO AGOTADO - Ultimate Challenge');
  
  const modal = document.createElement('div');
  modal.className = 'ultimate-timeup-overlay';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  `;
  
  modal.innerHTML = `
    <div class="bg-gradient-to-br from-red-900 to-red-700 text-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-2 border-red-500">
      <div class="text-6xl mb-4">‚è∞</div>
      <h2 class="text-3xl font-bold mb-4 text-red-200">¬°Tiempo Agotado!</h2>
      <div class="text-lg mb-6 leading-relaxed">
        <p class="mb-4">Se acabaron los 8 minutos y 20 segundos</p>
        <p class="mb-4">El Ultimate Challenge ha terminado</p>
        <p class="mb-4 text-red-300">üíÄ Necesitas m√°s velocidad para ser el maestro</p>
      </div>
      <div class="flex gap-3">
        <button id="retryUltimateChallenge" class="flex-1 bg-orange-600 hover:bg-orange-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors">
          üîÑ Reintentar
        </button>
        <button id="exitUltimateChallenge" class="flex-1 bg-gray-600 hover:bg-gray-500 px-6 py-3 rounded-2xl font-bold text-lg transition-colors">
          üö™ Salir
        </button>
      </div>
    </div>
  `;
  
  // Eventos de botones
  modal.querySelector('#retryUltimateChallenge').onclick = () => {
    modal.remove();
    actualStartUltimateChallenge(); // Reiniciar el desaf√≠o directamente
  };
  
  modal.querySelector('#exitUltimateChallenge').onclick = () => {
    modal.remove();
    exitUltimateChallenge();
  };
  
  document.body.appendChild(modal);
}

function showUltimateChallengeGameOver() {
  // Ocultar corazones y timer
  hideUltimateChallengeHearts();
  stopUltimateChallengeTimer();
  
  // Crear modal de Game Over
  const modal = document.createElement('div');
  modal.className = 'ultimate-gameover-overlay';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(145deg, #8B0000, #DC143C);
      border-radius: 20px;
      padding: 30px;
      max-width: 90vw;
      width: 100%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      border: 3px solid #FF4500;
    ">
      <div style="margin-bottom: 20px;">
        <h2 style="
          font-size: clamp(24px, 6vw, 32px);
          margin: 0 0 15px 0;
          color: #FFD700;
          text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        ">üíÄ GAME OVER üíÄ</h2>
      </div>
      
      <div style="font-size: clamp(60px, 15vw, 80px); margin: 20px 0;">üíî</div>
      
      <p style="
        font-size: clamp(18px, 4.5vw, 22px);
        color: #FFD700;
        font-weight: bold;
        margin: 15px 0;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      ">¬°Has perdido todas tus vidas!</p>
      
      <p style="
        color: #FFF;
        font-size: clamp(16px, 4vw, 18px);
        margin: 15px 0;
        line-height: 1.4;
      ">El Ultimate Challenge es implacable.<br>Pierdes caracteres con cada error.</p>
      
      <p style="
        color: #FFD700;
        font-size: clamp(14px, 3.5vw, 16px);
        margin: 20px 0;
        font-weight: bold;
      ">üí° ¬°Puedes intentarlo de nuevo con 3 vidas renovadas!</p>
      
      <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button onclick="exitUltimateChallenge()" style="
          padding: 15px 25px;
          border: none;
          border-radius: 10px;
          background: linear-gradient(145deg, #666, #888);
          color: white;
          font-size: clamp(14px, 3.5vw, 16px);
          font-weight: bold;
          cursor: pointer;
          border: 2px solid #444;
        ">‚ùå Salir</button>
        
        <button onclick="restartUltimateChallenge()" style="
          padding: 15px 25px;
          border: none;
          border-radius: 10px;
          background: linear-gradient(145deg, #228B22, #32CD32);
          color: white;
          font-size: clamp(14px, 3.5vw, 16px);
          font-weight: bold;
          cursor: pointer;
          border: 2px solid #006400;
        ">üîÑ Reintentar</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function exitUltimateChallenge() {
  // Limpiar estado del Ultimate Challenge
  ultimateChallengeActive = false;
  ultimateChallengeCards = [];
  ultimateChallengeHearts = 3;
  currentMission = 'known';
  
  // ========= DESACTIVAR SISTEMA DE ASISTENCIA =========
  disableAssistance();
  
  // üéÆ MOSTRAR UI ELEMENTOS AL SALIR DEL DESAF√çO
  showUIElementsForNormalMode();
  
  // Actualizar visibilidad de botones de quiz al salir
  updateQuizButtonsVisibility('known');
  
  // Limpiar temas visuales
  clearAllChallengeThemes();
  stopDesafioMusic();
  
  // Ocultar corazones
  hideUltimateChallengeHearts();
  
  // Cerrar modal
  const modal = document.querySelector('.ultimate-gameover-overlay');
  if (modal) modal.remove();
  
  // Mostrar tabla conocidas
  overlayField = 'hanzi';
  showKnownTableWithAnimations();
  
  console.log('‚ùå Ultimate Challenge terminado - Usuario sali√≥');
}

function restartUltimateChallenge() {
  // Cerrar modal
  const modal = document.querySelector('.ultimate-gameover-overlay');
  if (modal) modal.remove();
  
  // Limpiar colores especiales de tarjetas antes de reiniciar
  clearAllChallengeThemes();
  
  // Reiniciar Ultimate Challenge directamente (sin modal de informaci√≥n)
  console.log('üîÑ Reiniciando Ultimate Challenge');
  actualStartUltimateChallenge();
}

function getUltimateChallengeOptions(correctCard) {
  // Pool completo de palabras del hor√≥scopo para opciones incorrectas
  const horoscopeCategories = ['colores', 'fruta', 'verduras', 'comidas', 'animales', 'deportes', 'hobbies', 'ropa', 'casa', 'cuerpo', 'profesiones', 'emociones'];
  const horoscopePool = cards.filter(c => horoscopeCategories.some(cat => c.unit.split('|').includes(cat)));
  
  // Decidir aleatoriamente si mostrar hanzi o pinyin como opciones
  const showHanzi = Math.random() < 0.5;
  
  console.log(`üé≤ Ultimate Challenge: Mostrando ${showHanzi ? 'HANZI' : 'PINYIN'} como opciones`);
  console.log(`üèÜ Ultimate Challenge: Aplicando sistema inteligente para ${correctCard.hanzi} (${correctCard.pinyin})`);
  
  // Determinar n√∫mero de opciones (Ultimate Challenge siempre usa 4)
  const numOptions = 4;
  const numDistractors = numOptions - 1;
  
  // üéØ APLICAR SISTEMA INTELIGENTE DE OPCIONES
  const smartOptions = generateSmartOptions(correctCard, horoscopePool, true, numDistractors);
  
  // Obtener opciones incorrectas usando el sistema inteligente
  const incorrectOptions = smartOptions
    .slice(0, numDistractors)
    .map(opt => showHanzi ? opt.hanzi : opt.pinyin);
  
  // Opci√≥n correcta
  const correctOption = showHanzi ? correctCard.hanzi : correctCard.pinyin;
  
  // Combinar y mezclar
  const allOptions = [correctOption, ...incorrectOptions].sort(() => 0.5 - Math.random());
  
  console.log(`üéØ Ultimate Challenge - Opciones inteligentes generadas:`, allOptions);
  
  return {
    options: allOptions,
    correctAnswer: correctOption,
    questionType: showHanzi ? 'hanzi' : 'pinyin'
  };
}

// --- Funci√≥n para iniciar desaf√≠os del hor√≥scopo (TODAS las palabras de esa categor√≠a) ---
async function startDesafioHoroscopo(categoria) {
  console.log('üêæ DEBUG: startDesafioHoroscopo iniciado para categor√≠a:', categoria);
  
  // üîç ACTIVAR MONITOREO DE RENDIMIENTO
  performanceMonitor.startMonitoring();
  
  // üéÆ OCULTAR UI ELEMENTOS PARA DESAF√çO
  hideUIElementsForChallenges();
  
  // Cerrar modal si est√° abierto
  closeHoroscopeModal();
  
  // Filtrar TODAS las palabras de la categor√≠a espec√≠fica (conocidas o no) - EXCLUIR badges del hor√≥scopo
  const pool = cards.filter(c => c.unit.split('|').includes(categoria) && !c.isHoroscopeAnimal);
  
  // Debug: Verificar duplicados
  const duplicateCheck = new Map();
  pool.forEach(card => {
    const key = card.hanzi;
    if (duplicateCheck.has(key)) {
      console.warn(`üö® DUPLICADO detectado: ${key}`, {
        original: duplicateCheck.get(key),
        duplicate: {hanzi: card.hanzi, unit: card.unit, isHoroscopeAnimal: card.isHoroscopeAnimal, id: card.id}
      });
    } else {
      duplicateCheck.set(key, {hanzi: card.hanzi, unit: card.unit, isHoroscopeAnimal: card.isHoroscopeAnimal, id: card.id});
    }
  });
  
  // USAR TODAS LAS PALABRAS DE LA CATEGOR√çA (no solo 10)
  sessionQueue = shuffle(pool);
  
  // Configurar como desaf√≠o especial del hor√≥scopo
  currentMission = 'desafio' + categoria.charAt(0).toUpperCase() + categoria.slice(1);
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  
  // Capturar estado inicial para el desaf√≠o de hor√≥scopo
  console.log('üì∑ Capturando estado pre-desaf√≠o hor√≥scopo:', categoria);
  capturePreChallengeState();
  
  // üî• ACTIVAR SOLO SISTEMA DE TIMER N PARA HOR√ìSCOPO (SIN VIDAS)
  console.log('‚ö° Activando solo timer N para desaf√≠o hor√≥scopo (sin vidas)');
  desafioNActive = true;
  desafioNTimeLeft = 120; // 2 minutos como los desaf√≠os N
  
  // OCULTAR BOTONES DE QUIZ EN DESAF√çOS DEL HOR√ìSCOPO
  updateQuizButtonsVisibility(currentMission);
  
  // ACTUALIZAR "MODO ACTUAL" - mostrar animal y tem√°tica
  const statMission = document.getElementById('statMission');
  console.log('üêæ DEBUG: Intentando actualizar statMission para hor√≥scopo categor√≠a:', categoria);
  console.log('üêæ DEBUG: Element statMission encontrado:', !!statMission);
  if (statMission) {
    const animalData = horoscopeAnimals[categoria];
    console.log('üêæ DEBUG: Animal data:', animalData);
    const categoryNames = {
      'colores': 'Colores',
      'fruta': 'Frutas', 
      'verduras': 'Verduras',
      'comidas': 'Comidas',
      'animales': 'Animales',
      'deportes': 'Deportes',
      'hobbies': 'Hobbies',
      'ropa': 'Ropa',
      'casa': 'Casa',
      'cuerpo': 'Cuerpo',
      'profesiones': 'Profesiones',
      'emociones': 'Emociones'
    };
    
    console.log('üêæ DEBUG: Category name:', categoryNames[categoria]);
    if (animalData && categoryNames[categoria]) {
      const displayText = `${animalData.chinese} ${animalData.name} - ${categoryNames[categoria]}`;
      console.log('üêæ DEBUG: Texto anterior:', statMission.textContent);
      console.log('üêæ DEBUG: Texto nuevo:', displayText);
      statMission.textContent = displayText;
      statMission.style.color = '#f2e5b1';
      statMission.style.fontWeight = 'bold';
      statMission.style.fontSize = '14px';
      console.log(`üêæ Modo hor√≥scopo actualizado exitosamente: ${displayText}`);
    } else {
      console.error('‚ùå ERROR: No se encontraron datos del animal o nombre de categor√≠a');
      console.error('‚ùå DEBUG: animalData:', animalData, 'categoryNames[categoria]:', categoryNames[categoria]);
    }
  } else {
    console.error('‚ùå ERROR: No se encontr√≥ el elemento statMission para hor√≥scopo');
  }
  
  console.log(`üéØ Desaf√≠o ${categoria}: ${sessionTotal} palabras totales`);
  
  // El modo aleatorio se aplicar√° autom√°ticamente para cada tarjeta en nextCard()
  
  // Aplicar tema visuales de desaf√≠o del hor√≥scopo (monochromes harmony)
  bodyEl.classList.add('horoscope-bg');
  statBox.classList.add('challenge-stat');
  
  // Precargar video de fondo para desaf√≠o del hor√≥scopo
  let videoType = 'desafioHoroscopo'; // Por defecto (fondohoroscopo.mp4)
  
  // Mapeo de cada categor√≠a a su video espec√≠fico
  const videoMapping = {
    'colores': 'desafioColores',      // Rata - fondorata.mp4
    'fruta': 'desafioFruta',          // Gallo - fondogallo.mp4
    'verduras': 'desafioVerduras',    // Conejo - fondoconejo.mp4
    'comidas': 'desafioComidas',      // Cerdo - fondocerdo.mp4
    'animales': 'desafioAnimales',    // Perro - fondoperro.mp4
    'deportes': 'desafioDeportes',    // Caballo - fondocaballo.mp4
    'hobbies': 'desafioHobbies',      // Buey - fondovaca.mp4
    'ropa': 'desafioRopa',            // Cabra - fondocabra.mp4
    'casa': 'desafioCasa',            // Serpiente - fondoserpiente.mp4
    'cuerpo': 'desafioCuerpo',        // Mono - fondomono.mp4
    'profesiones': 'desafioProfesiones', // Tigre - fondotigre.mp4
    'emociones': 'desafioEmociones'   // Drag√≥n - fondodragon.mp4
  };
  
  if (videoMapping[categoria]) {
    videoType = videoMapping[categoria];
  }
  await createChallengeVideoWithPreload(videoType, async () => {
    // Iniciar sistema de asistencia (Lili ayuda)
    initAssistanceForChallenge();
    
    // Iniciar timer solo despu√©ss de que el video est√© listo
    startDesafioNTimer();
    
    // Iniciar m√∫sica espec√≠fica por categor√≠a
    await playDesafioMusic(`desafioHoroscopo-${categoria}`);
    
    // Iniciar el juego
    nextCard();
    updateStats();
  });
  
  // Ocultar la tabla de conocidas durante el desaf√≠o
  const knownTableSection = document.querySelector('section.mt-16');
  if(knownTableSection) knownTableSection.style.display = 'none';
  const knownOverlay = document.getElementById('knownOverlay');
  if(knownOverlay) knownOverlay.remove();
  
  // AUTO-SCROLL AL √ÅREA DE JUEGO
  setTimeout(() => {
    const xpElement = document.getElementById('xpBarWrap');
    if (xpElement) {
      xpElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      // Offset adicional para Android - asegurar que la barra quede arriba
      setTimeout(() => {
        const rect = xpElement.getBoundingClientRect();
        const offset = rect.top - 10; // 10px de margen superior
        if (offset !== 0) {
          window.scrollBy({ top: offset, behavior: 'smooth' });
        }
      }, 400);
    }
  }, 100);
  
  console.log(`üéØ Desaf√≠o del Hor√≥scopo iniciado: ${categoria} (${sessionTotal} palabras)`);
}
// ========= Fin de cambios ========= */


  /* ========= AUTO-BLUR PARA ELIMINAR FOCUS PERSISTENTE EN M√ìVIL ========= */
  // Quitar focus de cualquier bot√≥n cuando se toca en cualquier parte de la pantalla
  document.addEventListener('touchend', (e) => {
    // Si no se toc√≥ un bot√≥n, quitar focus de todos los botones
    if (!e.target.tagName || e.target.tagName.toLowerCase() !== 'button') {
      const allButtons = document.querySelectorAll('button');
      allButtons.forEach(btn => {
        if (document.activeElement === btn) {
          btn.blur();
        }
      });
    }
  }, { passive: true });

  /* ========= Temporizador para racha ========= */
  setInterval(updateStreakBox, 60_000);

  /* ========= Inicio ========= */
  // Inicializar controles cuando el DOM est√© listo
  initializeControls();
  loadAll();
  loadXP();
  renderXPBar();
  startMission('unit2');

  // Mostrar notificaci√≥n de desaf√≠o bloqueado estilo pixel art
  function showChallengeBlockedNotification(categoria, knownCount, requiredCount = 10) {
    // Remover notificaci√≥n anterior si existe
    const existingNotification = document.querySelector('.challenge-blocked-notification');
    if (existingNotification) {
      existingNotification.remove();
    }
    
    // Crear nueva notificaci√≥n
    const notification = document.createElement('div');
    notification.className = 'challenge-blocked-notification';
    
    // Obtener emoji del animal seg√∫n categor√≠a
    const categoryEmojis = {
      'colores': 'üé®',
      'fruta': 'üçé',
      'verduras': 'ü•ï',
      'comidas': 'üçú',
      'animales': 'üê∂',
      'deportes': '‚öΩ',
      'hobbies': 'üé≤',
      'ropa': 'üëï',
      'casa': 'üè†',
      'cuerpo': 'üë§',
      'profesiones': 'üë®‚Äçüíº',
      'emociones': 'üòä'
    };
    
    const emoji = categoryEmojis[categoria] || 'üê≤';
    const categoryName = categoria.charAt(0).toUpperCase() + categoria.slice(1);
    
    notification.innerHTML = `
      <div class="blocked-header">
        üîí DESAF√çO BLOQUEADO üîí
      </div>
      
      <div style="font-size: 40px; margin: 10px 0;">${emoji}</div>
      
      <div class="blocked-content">
        <div style="font-size: 20px; margin-bottom: 5px;">
          Necesitas conocer al menos <strong>${requiredCount} caracteres</strong> de <strong>${categoryName}</strong>
        </div>
      </div>
      
      <div class="blocked-stats">
        üìä Actualmente conoces: ${knownCount}/${requiredCount}
      </div>
      
      <div class="blocked-tip">
        <div style="font-size: 18px;">
        üí° Ve a las unidades del hor√≥scopo para coleccionar m√°s caracteres primero
      </div>
      
      <button class="blocked-button" onclick="closeChallengeBlockedNotification()">
        üîô ENTENDIDO
      </button>
    `;
    
    // Agregar overlay para fondo oscuro
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 99998;
    `;
    overlay.onclick = () => closeChallengeBlockedNotification();
    
    // Agregar al DOM
    document.body.appendChild(overlay);
    document.body.appendChild(notification);
    
    // Mostrar con animaci√≥n
    setTimeout(() => {
      notification.classList.add('show');
    }, 10);
  }

  // Cerrar notificaci√≥n de desaf√≠o bloqueado
  function closeChallengeBlockedNotification() {
    const notification = document.querySelector('.challenge-blocked-notification');
    const overlay = notification?.previousElementSibling;
    
    if (notification) {
      notification.style.opacity = '0';
      notification.style.transform = 'translate(-50%, -50%) scale(0.8)';
      
      setTimeout(() => {
        if (notification.parentNode) notification.parentNode.removeChild(notification);
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      }, 300);
    }
  }

  // ========== SISTEMA DE C√ìDIGO PARA DESBLOQUEAR HSK3/HSK4 ==========
  
  // Mostrar modal de c√≥digo para desbloquear HSK
  function showUnlockCodeModal() {
    // Si ya est√° desbloqueado, mostrar mensaje
    if (hskUnlocked) {
      alert('‚úÖ ¬°Ya has desbloqueado HSK3 y HSK4!');
      return;
    }
    
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: 'Jersey 10', monospace;
    `;
    
    modal.innerHTML = `
      <div style="
        background: linear-gradient(135deg, #7c3aed, #5b21b6);
        color: white;
        border: 3px solid #a78bfa;
        border-radius: 20px;
        padding: 35px 30px;
        text-align: center;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(167, 139, 250, 0.4);
      ">
        <h2 style="
          color: #ddd6fe;
          font-size: 32px;
          margin-bottom: 15px;
          text-shadow: 0 0 12px #a78bfa;
        ">üîë C√ìDIGO DE DESBLOQUEO</h2>
        
        <p style="
          color: #e9d5ff;
          font-size: 18px;
          margin-bottom: 25px;
          line-height: 1.4;
        ">Ingresa el c√≥digo para desbloquear:<br><strong>HSK3, HSK4, Cruzar HSK3 y Cruzar HSK4</strong></p>
        
        <input type="text" id="unlockCodeInput" placeholder="Escribe el c√≥digo aqu√≠" style="
          width: 100%;
          padding: 15px;
          font-size: 18px;
          border: 2px solid #a78bfa;
          border-radius: 10px;
          background: rgba(255, 255, 255, 0.1);
          color: white;
          font-family: 'Jersey 10', monospace;
          text-align: center;
          margin-bottom: 20px;
        ">
        
        <div id="unlockCodeError" style="
          color: #fca5a5;
          font-size: 16px;
          margin-bottom: 15px;
          min-height: 20px;
        "></div>
        
        <div style="display: flex; gap: 10px;">
          <button onclick="validateUnlockCode()" style="
            flex: 1;
            background: linear-gradient(135deg, #a78bfa, #7c3aed);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Jersey 10', monospace;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
          ">‚úÖ VALIDAR</button>
          
          <button onclick="closeUnlockCodeModal()" style="
            flex: 1;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Jersey 10', monospace;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
          ">‚ùå CANCELAR</button>
        </div>
      </div>
    `;
    
    modal.id = 'unlockCodeModal';
    document.body.appendChild(modal);
    
    // Enfocar el input
    setTimeout(() => {
      document.getElementById('unlockCodeInput')?.focus();
    }, 100);
    
    // Permitir validar con Enter
    document.getElementById('unlockCodeInput')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') validateUnlockCode();
    });
  }
  
  // Cerrar modal de c√≥digo
  function closeUnlockCodeModal() {
    const modal = document.getElementById('unlockCodeModal');
    if (modal && modal.parentNode) {
      modal.parentNode.removeChild(modal);
    }
  }
  
  // Validar c√≥digo ingresado
  function validateUnlockCode() {
    const input = document.getElementById('unlockCodeInput');
    const errorDiv = document.getElementById('unlockCodeError');
    const code = input?.value.trim().toLowerCase();
    
    const correctCode = 'amoeljuegodemanu';
    
    if (code === correctCode) {
      // ¬°C√≥digo correcto!
      hskUnlocked = true;
      console.log('üîë C√ìDIGO CORRECTO - hskUnlocked ahora es:', hskUnlocked);
      saveUserState();
      
      errorDiv.innerHTML = '<span style="color: #86efac;">‚úÖ ¬°C√ìDIGO CORRECTO!</span>';
      
      setTimeout(() => {
        closeUnlockCodeModal();
        showHSKUnlockedCelebration();
        updateHSKButtonsVisibility();
      }, 1000);
    } else {
      // C√≥digo incorrecto
      errorDiv.textContent = '‚ùå C√≥digo incorrecto. Intenta de nuevo.';
      input.value = '';
      input.focus();
    }
  }
  
  // Mostrar celebraci√≥n al desbloquear HSK
  function showHSKUnlockedCelebration() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: 'Jersey 10', monospace;
    `;
    
    modal.innerHTML = `
      <div style="
        background: linear-gradient(135deg, #78350f, #451a03);
        color: white;
        border: 3px solid #fbbf24;
        border-radius: 20px;
        padding: 40px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(251, 191, 36, 0.4);
        animation: victoryGlow 2s ease-in-out infinite alternate;
      ">
        <h2 style="
          color: #fbbf24;
          font-size: 36px;
          margin-bottom: 20px;
          text-shadow: 0 0 15px #fbbf24;
        ">üéâ ¬°DESBLOQUEADO! üéâ</h2>
        
        <p style="
          color: #fef3c7;
          font-size: 22px;
          margin-bottom: 30px;
          line-height: 1.5;
        ">
          Has desbloqueado:<br><br>
          <strong>‚ú® HSK3 (Quiz Mode)</strong><br>
          <strong>‚ú® HSK4 (Quiz Mode)</strong><br>
          <strong>‚öîÔ∏è Cruzar HSK3 (6000 HP)</strong><br>
          <strong>‚öîÔ∏è Cruzar HSK4 (7000 HP)</strong>
        </p>
        
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: linear-gradient(135deg, #fbbf24, #f59e0b);
          color: #451a03;
          border: none;
          padding: 15px 40px;
          border-radius: 10px;
          font-family: 'Jersey 10', monospace;
          font-size: 20px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        ">üéÆ ¬°EMPEZAR!</button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }
  
  // Actualizar visibilidad de botones HSK seg√∫n estado de desbloqueo
  function updateHSKButtonsVisibility() {
    const hsk3Btn = document.getElementById('btnHSK3');
    const hsk4Btn = document.getElementById('btnHSK4');
    const cruzarHSK3Btn = document.getElementById('btnCruzarHSK3');
    const cruzarHSK4Btn = document.getElementById('btnCruzarHSK4');
    
    // Elementos de progreso para HSK3
    const hsk3ProgressBar = document.getElementById('HSK3ProgressBar');
    const hsk3ProgressText = document.getElementById('HSK3ProgressText');
    const hsk3ProgressContainer = hsk3ProgressBar ? hsk3ProgressBar.closest('.flex') : null;
    
    // Elementos de progreso para HSK4
    const hsk4ProgressBar = document.getElementById('HSK4ProgressBar');
    const hsk4ProgressText = document.getElementById('HSK4ProgressText');
    const hsk4ProgressContainer = hsk4ProgressBar ? hsk4ProgressBar.closest('.flex') : null;
    
    // ‚úÖ SIN REQUISITOS - Siempre desbloqueados
    if (hsk3Btn) {
      hsk3Btn.disabled = false;
      hsk3Btn.style.opacity = '1';
      hsk3Btn.style.cursor = 'pointer';
      hsk3Btn.style.filter = 'none';
      const lockIcon = hsk3Btn.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();
      
      // Mostrar barra de progreso y texto
      if (hsk3ProgressContainer) hsk3ProgressContainer.style.display = '';
    }
    
    if (hsk4Btn) {
      hsk4Btn.disabled = false;
      hsk4Btn.style.opacity = '1';
      hsk4Btn.style.cursor = 'pointer';
      hsk4Btn.style.filter = 'none';
      const lockIcon = hsk4Btn.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();
      
      // Mostrar barra de progreso y texto
      if (hsk4ProgressContainer) hsk4ProgressContainer.style.display = '';
    }
    
    if (cruzarHSK3Btn) {
      cruzarHSK3Btn.disabled = false;
      cruzarHSK3Btn.style.opacity = '1';
      cruzarHSK3Btn.style.cursor = 'pointer';
      cruzarHSK3Btn.style.filter = 'none';
      const lockIcon = cruzarHSK3Btn.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();
    }
    
    if (cruzarHSK4Btn) {
      cruzarHSK4Btn.disabled = false;
      cruzarHSK4Btn.style.opacity = '1';
      cruzarHSK4Btn.style.cursor = 'pointer';
      cruzarHSK4Btn.style.filter = 'none';
      const lockIcon = cruzarHSK4Btn.querySelector('.lock-icon');
      if (lockIcon) lockIcon.remove();
    }
  }
  
  // Mostrar modal de contenido bloqueado para HSK
  function showHSKLockedModal() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: 'Jersey 10', monospace;
    `;
    
    modal.innerHTML = `
      <div style="
        background: linear-gradient(135deg, #374151, #1f2937);
        color: white;
        border: 3px solid #9ca3af;
        border-radius: 20px;
        padding: 35px 30px;
        text-align: center;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(156, 163, 175, 0.4);
      ">
        <h2 style="
          color: #9ca3af;
          font-size: 32px;
          margin-bottom: 15px;
        ">üîí CONTENIDO BLOQUEADO</h2>
        
        <p style="
          color: #d1d5db;
          font-size: 20px;
          margin-bottom: 25px;
          line-height: 1.4;
        ">Las unidades HSK3 y HSK4 como tambi√©n Cruzar HSK3 y Cruzar HSK4 pertenecen al contenido Premium del juego. Si sientes que el juego est√° mejorando tu nivel y quieres apoyar su desarrollo, puedes comprar este contenido para apoyar el proyecto. üíñ</p>
        
        <p style="
          color: #fbbf24;
          font-size: 18px;
          margin-bottom: 25px;
        ">Para adquirir este contenido, ponerse en contacto con nosotros.</p>
        
        <button onclick="this.parentElement.parentElement.remove()" style="
          background: linear-gradient(135deg, #6b7280, #4b5563);
          color: white;
          border: none;
          padding: 15px 40px;
          border-radius: 10px;
          font-family: 'Jersey 10', monospace;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
        ">üîô ENTENDIDO</button>
      </div>
    `;
    
    document.body.appendChild(modal);
  }


  // Inicializar estilos de botones de filtro al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    updateCategoryFilterButtonStyles();
  });

  </script>
</div> <!-- Cierre de gameArea -->
</body>
</html>