<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flashcards MacaLaoshi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <style>
    /* ---------- Base / flipping ---------- */
    .flip { transform: rotateY(180deg); }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotateY180 { transform: rotateY(180deg); }
    .perspective { perspective: 1000px; }
    .hidden { display: none; }

    /* ---------- Animaciones de feedback ---------- */
    @keyframes pop {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
      30%  { transform: scale(1.09);box-shadow: 0 0 45px rgba(16,185,129,.55); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-6px); }
      80%     { transform: translateX(6px); }
    }
    .popAnim   { animation: pop   420ms ease-out; }
    .shakeAnim { animation: shake 420ms ease; }

    @keyframes pulseGlow {
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
      50%  { box-shadow: 0 0 24px 8px var(--glow); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }
    .pulseBadge { animation: pulseGlow 700ms ease-out; }
    .pulseGreen { --glow: rgba(16,185,129,.85); } /* known */
    .pulseAmber { --glow: rgba(245,158,11,.85); } /* revise1 */
    .pulseTeal  { --glow: rgba(20,184,166,.85); } /* revise2 */

    /* ---------- Estado de opciones en QUIZ ---------- */
    .optCorrect {
      background-color: #059669 !important;
      color: #fff !important;
      box-shadow: 0 0 26px rgba(16,185,129,.75) !important;
      transform: scale(1.02);
    }
    .optWrong {
      background-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(220,38,38,.7) !important;
    }

    /* ---------- Tema â€œDesafÃ­oâ€ ---------- */
    .challenge-bg   { background-color: #4c1d95 !important; } /* morado profundo */
    .challenge-stat { background-color: #6d28d9 !important; } /* morado vivo */

    /* ---------- Overlay Tabla Conocidas ---------- */
    .overlay {
      position: fixed; inset: 0; z-index: 40; display: flex; align-items: center; justify-content: center;
      background: rgba(2,6,23,.75);
    }
    .overlayCard { width: min(1100px, 95vw); height: min(90vh, 900px); }
    /* Scroll for known table grid */
/* Scroll for known table grid - responsivo a la ventana */
    #knownGrid {
      display: grid;
      /* grid-template-columns se ajustarÃ¡ dinÃ¡micamente por JS para ser fijo */
      gap: 12px;
      pointer-events: auto !important;
      z-index: 1 !important;
    }

    .squareCell{
      aspect-ratio:1/1;
      display:flex; align-items:center; justify-content:center;
      position: relative;
      overflow:hidden; white-space:nowrap; padding:10px;
      text-align:center; user-select:none;
    }
    .streak-badge{
      position:absolute; right:6px; bottom:6px;
      padding:2px 6px; border-radius:10px; font-size:12px; font-weight:700;
      color:#0B1020; background:#3B82F6;
      box-shadow:0 0 10px rgba(0,0,0,.25);
    }


    /* --- Fondo dinÃ¡mico tipo conic/radial  */
    .challenge-bg {
      margin: 0;
      background-color: #5d2d91;
      background-image:
        radial-gradient(transparent 1.2em, #4c1d95 0.6em), /* antes 0.6em / 0.3em â†’ ahora x2 */
        conic-gradient(at 2em 2em, transparent 270deg, #4203 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4204 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4205 270deg),
        conic-gradient(at 2em 2em, transparent 270deg, #4206 270deg);
      background-size: 2em 2em, 8em 8em, 8em 8em, 8em 8em, 8em 8em; /* antes 1em/4em â†’ ahora x2 */
      animation: bpx 12s infinite linear, bpy 12s -3.75s infinite linear;
    }

    /* Horizontal */
    @keyframes bpx {
      0%, 7.5%, 100% { background-position-x: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-x: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-x: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-x: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-x: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-x: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-x: 0, -6em, 0, 6em, 12em; }
    }

    /* Vertical */
    @keyframes bpy {
      0%, 7.5%, 100% { background-position-y: 0, 0, 2em, 4em, 6em; }
      12.5%, 20%     { background-position-y: 0, 2em, 0, 6em, 4em; }
      25%, 32.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      37.5%, 45%     { background-position-y: 0, 2em, -8em, 14em, 4em; }
      50%, 57.5%     { background-position-y: 0, -4em, -10em, 16em, 10em; }
      62.5%, 70%     { background-position-y: 0, -6em, -8em, 14em, 12em; }
      75%, 82.5%     { background-position-y: 0, -2em, -4em, 10em, 8em; }
      87.5%, 95%     { background-position-y: 0, -6em, 0, 6em, 12em; }
    }

    /* --- AnimaciÃ³n para tarjeta incorrecta --- */
.cardWrong {
  box-shadow: 0 0 0 9999px rgba(220,38,38,0.3) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}
.cardWrongFade {
  box-shadow: 0 0 0 0 rgba(220,38,38,0) inset !important;
  transition: box-shadow 0.7s cubic-bezier(.4,0,.2,1);
}

/* --- Fade out para casillas correctas e incorrectas --- */
.optCorrectFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #05966933 !important;
  box-shadow: 0 0 0 rgba(16,185,129,0) !important;
}
.optWrongFade {
  transition: background-color 1.2s cubic-bezier(.4,0,.2,1), box-shadow 1.2s cubic-bezier(.4,0,.2,1);
  background-color: #dc262633 !important;
  box-shadow: 0 0 0 rgba(220,38,38,0) !important;
}

/* TransiciÃ³n flip hacia arriba entre tarjetas */
.card-flip-up-out {
  transform: rotateX(90deg);
  opacity: 0;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}
.card-flip-up-in {
  transform: rotateX(-90deg);
  opacity: 0;
}
.card-flip-up-in.card-flip-animate {
  transform: rotateX(0deg);
  opacity: 1;
  transition: transform 0.38s cubic-bezier(.4,0,.2,1), opacity 0.38s cubic-bezier(.4,0,.2,1);
}

/* Flip vertical transiciÃ³n entre tarjetas (cambio de contenido en el medio) */
.card-flip-vert {
  transition: transform 0.44s cubic-bezier(.4,0,.2,1);
  transform-style: preserve-3d;
}
.card-flip-vert.flipping {
  transform: rotateX(90deg);
}
.card-flip-vert.flipped {
  transform: rotateX(0deg);
}

  
    /* AnimaciÃ³n de glow dorado intensificado para tarjetas premium */
    @keyframes goldGlow {
      0%   { box-shadow: 0 0 32px 8px #ffd70099, 0 0 0 3px #fffbe6; }
      50%  { box-shadow: 0 0 64px 16px #f6dc4dcc, 0 0 0 5px #fae078; }
      100% { box-shadow: 0 0 32px 8px #ffd70099, 0 0 0 3px #fffbe6; }
    }
    .premium-gold {
      background: linear-gradient(155deg, #e7d173 0%, #d4be5e 25%, #dec557 50%, #d4be5e 75%, #e7d173 100%) !important;
      border: 2px solid #f3d54f !important;
      box-shadow: 0 0 32px 8px #000000eb, 0 0 0 4px #fffbe6;
      animation: goldGlow 2.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    /* Tarjeta mÃ­tica violeta para desafÃ­o */
    @keyframes mythicGlow {
      0%   { box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe; }
      50%  { box-shadow: 0 0 64px 16px #a78bface, 0 0 0 6px #c4b5fd; }
      100% { box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe; }
    }
    .mythic-violet {
      background: linear-gradient(145deg, #a99af5 0%, #7356cc 100%) !important;
      border: 2px solid #a78bfa !important;
      box-shadow: 0 0 32px 8px #a78bfa99, 0 0 0 4px #ede9fe;
      animation: mythicGlow 1.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }

    /* Tarjeta legendaria roja para desafÃ­o */
    @keyframes legendaryGlow {
      0%   { box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2; }
      50%  { box-shadow: 0 0 64px 16px #f87171cc, 0 0 0 6px #fca5a5; }
      100% { box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2; }
    }
    .legendary-red {
      background: linear-gradient(135deg, #f57f7f 0%, #fb4646 100%) !important;
      border: 4px solid #f87171 !important;
      box-shadow: 0 0 32px 8px #f8717199, 0 0 0 4px #fee2e2;
      animation: legendaryGlow 1.6s ease-in-out infinite;
      transition: background 0.3s, border 0.3s, box-shadow 0.3s;
    }
    </style>
    
</head>
<body id="body" class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <!-- Barra de experiencia (XP) -->
    <div id="xpBarWrap" class="mb-4">
      <div class="flex items-center justify-between mb-1">
  <span id="xpLabel" class="font-bold text-sm">æ°´å¹³ <span id="xpLevel">1</span></span>
  <span id="xpToNext" class="text-xs"> </span>
  <button id="btnResetXP" class="ml-2 px-2 py-1 rounded border text-xs" style="border-width:1.5px;">Reiniciar æ°´å¹³</button>
      </div>
      <div class="w-full h-4 bg-sky-900 rounded-full overflow-hidden">
        <div id="xpBar" class="h-4 bg-sky-400 transition-all duration-500" style="width:0%"></div>
      </div>

    </div>

    <!-- ---------- Encabezado ---------- -->
    <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Flashcards MacaLaoshi</h1>
      <div class="flex flex-wrap gap-2">
        <div class="relative">
          <button id="btnNivel1" class="px-4 py-2 rounded-2xl bg-indigo-700 hover:bg-indigo-600 font-semibold">Nivel 1 â–¼</button>
          <div id="nivel1Box" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnUnit2" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 2</button>
            <button id="btnUnit3" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 3</button>
            <button id="btnUnit4" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 4</button>
            <button id="btnUnit5" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 5</button>
            <button id="btnUnit6" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 6</button>
            <button id="btnUnit7" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 7</button>
            <button id="btnUnit8" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 8</button>
            <button id="btnUnit9" class="px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500">Unidad 9</button>
            <button id="btnTodoN1" class="px-4 py-2 rounded-2xl bg-indigo-500 hover:bg-indigo-400 font-bold">Todo N1</button>
            <button id="btnDesafioN1" class="px-4 py-2 rounded-2xl bg-fuchsia-700 hover:bg-fuchsia-600 font-bold">DesafÃ­o N1</button>
          </div>
        </div>
      </div>
    </header>
  <script>
  // --- Login automÃ¡tico (COMENTADO - versiÃ³n local) ---
  /*
  function showLoginForm() {
    const loginDiv = document.createElement('div');
    loginDiv.style.position = 'fixed';
    loginDiv.style.top = '0';
    loginDiv.style.left = '0';
    loginDiv.style.width = '100vw';
    loginDiv.style.height = '100vh';
    loginDiv.style.background = 'rgba(0,0,0,0.7)';
    loginDiv.style.zIndex = '9999';
    loginDiv.style.display = 'flex';
    loginDiv.style.alignItems = 'center';
    loginDiv.style.justifyContent = 'center';
    loginDiv.innerHTML = `
      <form id="loginForm" style="background:#222;padding:32px 24px;border-radius:16px;box-shadow:0 0 32px #000;display:flex;flex-direction:column;gap:16px;min-width:280px;">
        <h2 style="color:#fff;font-size:1.3em;margin-bottom:8px;">Iniciar sesiÃ³n</h2>
        <input id="loginUser" type="text" placeholder="Usuario" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
        <input id="loginPass" type="text" placeholder="ContraseÃ±a" style="padding:8px;border-radius:8px;border:1px solid #444;background:#fff;color:#111;font-size:1em;" required />
        <button type="submit" style="padding:10px 0;border-radius:8px;background:#2563eb;color:#fff;font-weight:bold;">Entrar</button>
        <div id="loginError" style="color:#f87171;font-size:0.95em;"></div>
      </form>
    `;
    document.body.appendChild(loginDiv);
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPass').value;
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = '';
      try {
        const res = await fetch('http://localhost:4000/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        if(res.ok){
          const data = await res.json();
          jwtToken = data.token;
          window.username = data.username || username;
          localStorage.setItem('jwtToken', jwtToken);
          localStorage.setItem('username', window.username);
          loginDiv.remove();
          await loadAll();
          await renderLeaderboard();
        } else {
          errorDiv.textContent = 'Usuario o contraseÃ±a incorrectos.';
        }
      } catch(err){
        errorDiv.textContent = 'Error de conexiÃ³n.';
      }
    };
  }
  */

  window.addEventListener('DOMContentLoaded', async () => {
    // Auto-start sin login (versiÃ³n local)
    console.log('ğŸš€ Iniciando v7 versiÃ³n local - sin login');
    jwtToken = 'local-token-v7';
    window.username = 'Usuario';
    await loadAll();
    await renderLeaderboard();
    // Mostrar el botÃ³n y box de Nivel 2 si estÃ¡ desbloqueado
    if(nivel2Unlocked) {
      showNivel2Button();
      // Forzar display del box si existe
      const nivel2Wrap = document.getElementById('nivel2Wrap');
        if(nivel2Wrap) nivel2Wrap.style.display = '';
        const btnNivel2 = document.getElementById('btnNivel2');
        if(btnNivel2) btnNivel2.style.display = '';
      }
  });
  </script>
        <div class="relative" id="nivel2Wrap" style="display:none;">
          <button id="btnNivel2" class="px-4 py-2 rounded-2xl bg-red-700 hover:bg-red-600 font-semibold">Nivel 2 â–¼</button>
          <div id="nivel2Box" class="absolute left-0 mt-2 bg-slate-900 border border-slate-700 rounded-2xl shadow-lg p-3 flex flex-col gap-2 z-30 hidden min-w-[180px]">
            <button id="btnUnit2N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 1</button>
            <button id="btnUnit3N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 2</button>
            <button id="btnUnit4N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 3</button>
            <button id="btnUnit5N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 4</button>
            <button id="btnUnit6N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 5</button>
            <button id="btnUnit7N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 6</button>
            <button id="btnUnit8N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 7</button>
            <button id="btnUnit9N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 8</button>
            <button id="btnUnit10N2" class="px-4 py-2 rounded-2xl bg-red-600 hover:bg-red-500">Unidad 9</button>
            <button id="btnTodoN2" class="px-4 py-2 rounded-2xl bg-red-500 hover:bg-red-400 font-bold">Todo N2</button>
          </div>
        </div>

        <button id="btnKnown" class="px-4 py-2 rounded-2xl bg-emerald-700/80 hover:bg-emerald-700">
          Conocidas <span id="countKnown" class="opacity-80">0</span>
        </button>
        <button id="btnRevise1" class="px-4 py-2 rounded-2xl bg-amber-600/80 hover:bg-amber-600">
          A repasar <span id="countRev1" class="opacity-80">0</span>
        </button>
        <button id="btnRevise2" class="px-4 py-2 rounded-2xl bg-teal-600/80 hover:bg-teal-600">
          Para confirmar <span id="countRev2" class="opacity-80">0</span>
        </button>

        <button id="btnChallenge" class="px-4 py-2 rounded-2xl bg-fuchsia-700/80 hover:bg-fuchsia-700">DesafÃ­o</button>

        <button id="btnQuizPinyin" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500">Quiz Pinyin</button>
        <button id="btnQuizMeaning" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500">Quiz Significado</button>
        <!-- Nuevo botÃ³n Quiz Hanzi -->
        <button id="btnQuizHanzi" class="px-4 py-2 rounded-2xl bg-purple-600 hover:bg-purple-500 ml-2">Quiz Hanzi</button>

        <button id="btnKnownTable" class="px-4 py-2 rounded-2xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Tabla Conocidas</button>

  <button id="btnReset" class="px-4 py-2 rounded-2xl bg-rose-600 hover:bg-rose-500">Reiniciar progreso</button>
  <button id="btnSiSeTraba" class="px-4 py-2 rounded-2xl bg-gray-700 hover:bg-gray-600">si se traba</button>
  <button id="btnLogout" class="px-4 py-2 rounded-2xl bg-red-700 hover:bg-red-600 text-white font-bold ml-2">Cerrar sesiÃ³n</button>
      </div>
    </header>

    <!-- ---------- Estado ---------- -->
    <section class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
      <div class="bg-slate-900/95 rounded-xl p-3">
        <div class="text-slate-400">Faltan</div>
        <div id="statInSession" class="text-xl font-semibold">0</div>
      </div>
      <div class="bg-slate-900/95 rounded-xl p-3">
        <div class="text-slate-400">Revisadas</div>
        <div id="statToday" class="text-xl font-semibold">0</div>
      </div>
      <div id="statBox" class="bg-slate-900/95 rounded-xl p-3">
        <div class="text-slate-400">Modo Actual</div>
        <div id="statMission" class="text-xl font-semibold">â€”</div>
      </div>
      <div class="bg-slate-900/95 rounded-xl p-3 cursor-pointer" id="streakBox">
        <div class="text-slate-400 flex items-center gap-1">
          Rachas <span style="font-size:1.3em;vertical-align:middle;">ğŸ”¥</span> <span id="streakCount" class="font-bold text-orange-400">0</span>
        </div>
  <div id="streakStatus" class="text-sm font-semibold text-orange-300">â€”</div>
      </div>
    </section>

    <!-- ---------- Tarjeta ---------- -->
    <main class="mt-6">
      <div id="cardWrap" class="relative h-72 sm:h-80 select-none perspective">
        <div id="card" class="absolute inset-0 rounded-3xl bg-slate-900/95 ring-1 ring-white/10 shadow-xl flex items-center justify-center text-center preserve-3d transition-transform duration-300 will-change-transform">
          <div id="cardFront" class="absolute inset-0 flex items-center justify-center backface-hidden text-6xl font-bold"></div>
          <div id="cardBack" class="absolute inset-0 flex flex-col items-center justify-center rotateY180 backface-hidden text-2xl leading-relaxed whitespace-pre-line"></div>
        </div>
      </div>

      <!-- Controles modo FLASH -->
      <div id="flashRow" class="mt-4 grid grid-cols-3 gap-2">
        <button id="btnDontKnow" class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700">â† No la sÃ©</button>
        <button id="btnFlip"     class="py-3 rounded-2xl bg-slate-800 hover:bg-slate-700">Voltear</button>
        <button id="btnKnow"     class="py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500">La sabÃ­a â†’</button>
      </div>

      <!-- Controles modo QUIZ (opciones dinÃ¡micas) -->
      <div id="quizRow" class="mt-4 grid grid-cols-2 gap-2 hidden"></div>

      <p class="mt-3 text-slate-400 text-xs sm:text-sm">
        Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la sÃ©, Espacio = Voltear, Derecha = La sabÃ­a.
      </p>
    </main>
  </div>

  <!-- ========= Overlay: Tabla Conocidas ========= -->
  <section class="mt-16 mx-2 sm:mx-8">
    <h2 class="text-lg font-semibold mb-2">Tabla de conocidas</h2>
    <div class="flex items-center gap-2 flex-wrap mb-2">
      <span id="knownCount" class="text-slate-400 text-sm">0</span>
      <div class="flex items-center gap-2">
        <button id="btnShowHanzi" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">æ±‰å­—</button>
        <button id="btnShowPinyin" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Pinyin</button>
        <button id="btnShowMeaning" class="px-3 py-1.5 rounded-xl bg-slate-800 hover:bg-slate-700 ring-1 ring-white/10">Significado</button>
      </div>
      <div class="flex items-center gap-1 ml-4">
        <span class="text-slate-400 text-xs">Filtrar:</span>
        <button id="btnCatAll" class="px-2 py-1 rounded bg-slate-700 text-xs font-bold">Todos</button>
        <button id="btnCatS" class="px-2 py-1 rounded bg-green-700 text-xs font-bold">S</button>
        <button id="btnCatA" class="px-2 py-1 rounded bg-orange-600 text-xs font-bold">A</button>
        <button id="btnCatV" class="px-2 py-1 rounded bg-red-700 text-xs font-bold">V</button>
        <button id="btnCatP" class="px-2 py-1 rounded bg-yellow-600 text-xs font-bold">P</button>
        <button id="btnCatE" class="px-2 py-1 rounded bg-blue-700 text-xs font-bold">E</button>
      </div>
    </div>
    <div id="knownGrid" class="mx-2 sm:mx-8 mb-16"></div>
    <!-- Leaderboard debajo de conocidas -->
    <div class="mt-8">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-lg font-bold">ğŸ† Leaderboard</span>
        <button id="btnReloadLeaderboard" class="px-2 py-1 rounded bg-yellow-500 hover:bg-yellow-400 text-black font-bold" title="Actualizar leaderboard">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#FFD700" stroke="#b45309" stroke-width="1.5" d="M12 2l2.39 6.94h7.29l-5.89 4.28 2.39 6.94L12 15.88l-5.18 3.78 2.39-6.94-5.89-4.28h7.29z"/></svg>
        </button>
        <button id="btnStarLeaderboard" class="px-2 py-1 rounded bg-yellow-400 hover:bg-yellow-300 text-black font-bold ml-1" title="Actualizar leaderboard">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"><path fill="#FFD700" stroke="#b45309" stroke-width="1.5" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
        </button>
      </div>
      <div id="leaderboardTable" class="overflow-x-auto"></div>
    </div>
  </section>

  <script>
  /* ========= Estado y setup ========= */
  // --- Leaderboard logic ---
  // Datos ficticios del leaderboard (18 usuarios hardcodeados)
  function getFakeLeaderboardData() {
    return [
      { username: 'Messi', country: 'Argentina', group: 'N1', xp: 230, knownCharsCount: 200, streak: 30, level: 5 },
      { username: 'Ronaldo', country: 'Portugal', group: 'N1', xp: 220, knownCharsCount: 180, streak: 28, level: 5 },
      { username: 'MacaLaoshi', country: 'China', group: 'N1', xp: 210, knownCharsCount: 170, streak: 25, level: 4 },
      { username: 'MrBeast', country: 'Estados Unidos', group: 'N1', xp: 200, knownCharsCount: 160, streak: 22, level: 4 },
      { username: 'JackieChan', country: 'China', group: 'N2', xp: 190, knownCharsCount: 150, streak: 20, level: 4 },
      { username: 'Yaoming', country: 'China', group: 'N2', xp: 180, knownCharsCount: 140, streak: 18, level: 4 },
      { username: 'Agustinaaprende', country: 'Argentina', group: 'N2', xp: 170, knownCharsCount: 130, streak: 15, level: 3 },
      { username: 'LeonardoDV', country: 'Estados Unidos', group: 'N2', xp: 160, knownCharsCount: 120, streak: 14, level: 3 },
      { username: 'Usuario', country: 'Argentina', group: 'N2', xp: 120, knownCharsCount: 80, streak: 10, level: 3 },
      { username: 'Gero', country: 'Colombia', group: 'N2', xp: 110, knownCharsCount: 70, streak: 8, level: 2 },
      { username: 'Antoniobanderas', country: 'EspaÃ±a', group: 'N3', xp: 100, knownCharsCount: 60, streak: 7, level: 2 },
      { username: 'GuillermoBull', country: 'Chile', group: 'N3', xp: 90, knownCharsCount: 50, streak: 6, level: 2 },
      { username: 'Jermaioni', country: 'MÃ©xico', group: 'N3', xp: 80, knownCharsCount: 45, streak: 5, level: 2 },
      { username: 'Tomyjerry', country: 'PanamÃ¡', group: 'N3', xp: 70, knownCharsCount: 40, streak: 4, level: 2 },
      { username: 'Joshi', country: 'MÃ©xico', group: 'N3', xp: 60, knownCharsCount: 30, streak: 3, level: 1 },
      { username: 'Marioelbross', country: 'EspaÃ±a', group: 'N3', xp: 50, knownCharsCount: 25, streak: 2, level: 1 },
      { username: 'Mikewasaoski', country: 'Estados Unidos', group: 'N3', xp: 30, knownCharsCount: 15, streak: 1, level: 1 },
      { username: 'Peterpedro', country: 'PanamÃ¡', group: 'N3', xp: 20, knownCharsCount: 10, streak: 1, level: 1 }
    ];
  }

  async function fetchLeaderboard() {
    // Retornar datos ficticios
    let data = getFakeLeaderboardData();
    
    // Calcular score y ranking
    data = data.map(u => {
      const score = calcScore(u);
      return { ...u, totalScore: score };
    });
    
    // Ordenar por score
    data.sort((a, b) => b.totalScore - a.totalScore);
    
    // Asignar posiciones
    data.forEach((u, i) => {
      u.rank = i + 1;
    });
    
    console.log('ğŸ† Leaderboard ficticio generado:', data.length, 'usuarios');
    return data.slice(0, 10); // Top 10
  }

  function calcScore(user) {
    // FÃ“RMULA: (conocidas + XP) * (1 + 0.01*racha) * (1 + 0.05*nivel)
    const xp = user.xp || 0;
    const known = user.knownCharsCount || 0;
    const streak = user.streak || 0;
    const level = user.level || 1;
    
    const baseScore = known + xp;
    const streakMultiplier = 1 + (0.01 * streak);
    const levelMultiplier = 1 + (0.05 * level);
    
    const finalScore = Math.round(baseScore * streakMultiplier * levelMultiplier);
    return finalScore;
  }

  async function renderLeaderboard() {
    const leaderboard = await fetchLeaderboard();
    if(!leaderboard || leaderboard.length === 0) {
  document.getElementById('leaderboardTable').innerHTML = `<div class="text-center text-slate-400 py-4">No recibÃ­ nada<br><span class='text-xs break-all text-yellow-400'>JWT: ${jwtToken}</span></div>`;
      return;
    }
    // Obtener usuario actual
    const currentUser = window.username || (window.jwtTokenUser || null);
    let myUser = leaderboard.find(u => u.username === currentUser);
    if(!myUser && typeof xpPoints !== 'undefined') {
      myUser = {
        username: currentUser,
        xp: xpPoints,
        knownChars: cards,
        streak: streak
      };
    }
    // No reordenar ni recortar el array, mostrar todos los usuarios recibidos y su rank real
    let html = `<table class="min-w-[340px] w-full text-sm bg-slate-900 rounded-xl overflow-hidden">
      <thead><tr class="bg-slate-800 text-yellow-400">
        <th class="py-2 px-2">#</th>
        <th class="py-2 px-2">Usuario</th>
        <th class="py-2 px-2">Nivel</th>
        <th class="py-2 px-2">XP</th>
        <th class="py-2 px-2">Conocidas</th>
        <th class="py-2 px-2">Racha</th>
        <th class="py-2 px-2">Puntaje</th>
      </tr></thead><tbody>`;
    leaderboard.forEach((u)=>{
      const score = calcScore(u);
      const known = Array.isArray(u.knownChars) ? u.knownChars.filter(c=>c.known).length : (u.knownCharsCount || 0);
      const lvl = u.level || (typeof getCurrentLevel==='function' ? getCurrentLevel(u.xp||0) : '-');
      html += `<tr${u.username===currentUser?' class="bg-yellow-100 text-black font-bold"':''}>
        <td class="py-1 px-2 text-center">${u.rank}</td>
        <td class="py-1 px-2">${u.username}</td>
        <td class="py-1 px-2 text-center">${lvl}</td>
        <td class="py-1 px-2 text-center">${u.xp||0}</td>
        <td class="py-1 px-2 text-center">${known}</td>
        <td class="py-1 px-2 text-center">${u.streak||0}</td>
        <td class="py-1 px-2 text-center font-bold">${u.totalScore || score}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('leaderboardTable').innerHTML = html;
  }

   document.getElementById('btnReloadLeaderboard').onclick = renderLeaderboard;
   document.getElementById('btnStarLeaderboard').onclick = renderLeaderboard;
 
   // --- Logout button handler ---
   window.addEventListener('DOMContentLoaded', function() {
     var btnLogout = document.getElementById('btnLogout');
     if (btnLogout) {
       btnLogout.onclick = function() {
         localStorage.removeItem('jwtToken');
         jwtToken = null;
         location.reload();
       };
     }
   });
  window.addEventListener('DOMContentLoaded', renderLeaderboard);
  // Backend sync system
  let xpPoints = 0;
  // ...existing code...
  let unlockedUnits = [];
  let nivel2Unlocked = false;
  let streak = 0;
  let lastChallengeAt = null;
  let jwtToken = null;
  // Recuperar token de localStorage si existe
  if(localStorage.getItem('jwtToken')) {
    jwtToken = localStorage.getItem('jwtToken');
    if(localStorage.getItem('username')) {
      window.username = localStorage.getItem('username');
    }
  }

  // Cargar estado del usuario desde backend
  async function loadUserState(token) {
    jwtToken = token || 'local-token-v7';
    
    // Cargar desde localStorage
    const saved = localStorage.getItem('v7_flashcards_data');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        xpPoints = data.xp || 0;
        cards = data.knownChars || [];
        unlockedUnits = data.unlockedUnits || [];
        nivel2Unlocked = !!data.nivel2Unlocked;
        streak = data.streak || 0;
        lastChallengeAt = data.lastChallengeAt || null;
        console.log('âœ… Estado cargado desde localStorage (v7)');
        return;
      } catch (e) {
        console.error('Error parseando localStorage:', e);
      }
    }
    
    // Si no hay datos, inicializar
    xpPoints = 0;
    cards = [];
    unlockedUnits = [];
    nivel2Unlocked = false;
    streak = 0;
    lastChallengeAt = null;
    console.log('ğŸ†• Estado inicializado (v7)');
  }

  // Guardar estado del usuario en localStorage
  async function saveUserState() {
    const data = {
      xp: xpPoints,
      knownChars: cards,
      unlockedUnits,
      nivel2Unlocked,
      streak,
      lastChallengeAt
    };
    localStorage.setItem('v7_flashcards_data', JSON.stringify(data));
    console.log('ğŸ’¾ Estado guardado en localStorage (v7)');
  }

  // Reemplazar funciones locales
  function saveXP() { saveUserState(); }
  function loadXP() { /* XP se carga con loadUserState */ }
  function xpForLevel(level) {
    // Level 1: 10, Level 2: 50, Level 3: 100, Level 4: 200, Level 5: 300, etc.
    if(level === 1) return 10;
    if(level === 2) return 50;
    if(level === 3) return 100;
    return (level - 1) * 100;
  }
  function getCurrentLevel(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    return lvl;
  }
  function getLevelProgress(xp) {
    let lvl = 1;
    let xpNeeded = xpForLevel(lvl);
    let total = 0;
    while (xp >= total + xpNeeded) {
      total += xpNeeded;
      lvl++;
      xpNeeded = xpForLevel(lvl);
    }
    // xpNeeded: lo que requiere este nivel
    // total: xp acumulado hasta el nivel anterior
    return {
      lvl,
      prev: total,
      next: total + xpNeeded,
      progress: xp - total,
      needed: (total + xpNeeded) - xp,
      percent: Math.max(0, Math.min(100, ((xp - total) / xpNeeded) * 100))
    };
  }
  // Colores por nivel
  const xpColors = [
    // Celeste claro â†’ verde claro â†’ naranja
    {bar:'#7dd3fc', text:'#7dd3fc', bg:'#bae6fd', glow:'#e0f2fe'}, // 1 celeste claro
    {bar:'#38bdf8', text:'#38bdf8', bg:'#a5f3fc', glow:'#bae6fd'}, // 2 celeste
    {bar:'#5eead4', text:'#5eead4', bg:'#a7f3d0', glow:'#d1fae5'}, // 3 verde agua
    {bar:'#34d399', text:'#34d399', bg:'#bbf7d0', glow:'#d1fae5'}, // 4 verde claro
    {bar:'#fbbf24', text:'#fbbf24', bg:'#fef9c3', glow:'#fde68a'}, // 5 amarillo-naranja
    {bar:'#fb923c', text:'#fb923c', bg:'#fed7aa', glow:'#fdba74'}, // 6 naranja claro
    {bar:'#f97316', text:'#f97316', bg:'#fdba74', glow:'#fb923c'}, // 7 naranja
    {bar:'#ea580c', text:'#ea580c', bg:'#fb923c', glow:'#f97316'}, // 8 naranja intenso
  ];
  let lastLevel = null;
  function renderXPBar(levelUpAnim=false) {
    const { lvl, needed, percent } = getLevelProgress(xpPoints);
    document.getElementById('xpLevel').textContent = lvl;
    document.getElementById('xpBar').style.width = percent+"%";
    document.getElementById('xpToNext').textContent = `Faltan ${needed} aciertos para el prÃ³ximo æ°´å¹³`;
    // Colores por nivel
    const color = xpColors[(lvl-1)%xpColors.length];
    const xpBar = document.getElementById('xpBar');
    const xpBarWrap = document.getElementById('xpBarWrap');
    const xpLevel = document.getElementById('xpLevel');
    const xpToNext = document.getElementById('xpToNext');
    xpBar.style.background = color.bar;
    xpBarWrap.querySelector('.w-full').style.background = color.bg;
    xpLevel.style.color = color.text;
    xpToNext.style.color = color.text;
    const xpLabel = document.getElementById('xpLabel');
    if(xpLabel) xpLabel.style.color = color.text;
    const btnResetXP = document.getElementById('btnResetXP');
    if(btnResetXP) {
      btnResetXP.style.background = '#1e293b'; // azul oscuro
      btnResetXP.style.color = '#fff';
      btnResetXP.style.borderColor = '#1e293b';
    }
    // Set CSS vars for glow
    xpBar.style.setProperty('--xp-bar', color.bar);
    xpBar.style.setProperty('--xp-glow', color.glow);
    xpBarWrap.style.setProperty('--xp-glow', color.glow);
    // AnimaciÃ³n de brillo al subir de nivel y sonido de triunfo
    if(levelUpAnim) {
      xpBar.classList.add('xp-glow-anim');
      xpBarWrap.classList.add('xp-glow-anim-bg');
      soundLevelUpTrumpet();
      setTimeout(()=>{
        xpBar.classList.remove('xp-glow-anim');
        xpBarWrap.classList.remove('xp-glow-anim-bg');
      }, 1200);
    }
    lastLevel = lvl;
  }
  // CSS para animaciÃ³n de brillo
  const xpGlowStyle = document.createElement('style');
  xpGlowStyle.textContent = `
    .xp-glow-anim {
      box-shadow: 0 0 24px 8px var(--xp-glow, #fff), 0 0 0 2px var(--xp-bar, #fff);
      animation: xpGlow 1.1s cubic-bezier(.4,2,.6,1);
    }
    .xp-glow-anim-bg {
      animation: xpGlowBG 1.1s cubic-bezier(.4,2,.6,1);
    }
    @keyframes xpGlow {
      0% { box-shadow: 0 0 0 0 var(--xp-glow, #fff); }
      40% { box-shadow: 0 0 32px 16px var(--xp-glow, #fff); }
      100% { box-shadow: 0 0 0 0 var(--xp-glow, #fff); }
    }
    @keyframes xpGlowBG {
      0% { filter: brightness(1.1); }
      40% { filter: brightness(1.7) drop-shadow(0 0 16px var(--xp-glow, #fff)); }
      100% { filter: brightness(1.1); }
    }
  `;
  document.head.appendChild(xpGlowStyle);
  const STORAGE_KEY = 'srs_unidades_v7_es';

  // Eliminada declaraciÃ³n duplicada de cards
  let sessionQueue = [];
  let currentCard = null;
  let flipped = false;
  let todayReviewed = 0;
  let currentMission = ''; // 'unit2'..'unit9'|'known'|'revise1'|'revise2'|'challenge'
  let sessionTotal = 0;
  let sessionCorrect = 0;
  // 'flash' | 'quizPinyin' | 'quizMeaning'
  let mode = 'flash';

  /* ========= DOM ========= */
  const bodyEl  = document.getElementById('body');
  const cardEl  = document.getElementById('card');
  const frontEl = document.getElementById('cardFront');
  const backEl  = document.getElementById('cardBack');

  const statInSession = document.getElementById('statInSession');
  const statToday     = document.getElementById('statToday');
  const statMission   = document.getElementById('statMission');
  const statBox       = document.getElementById('statBox');
  const streakBox = document.getElementById('streakBox');
  const streakCount = document.getElementById('streakCount');
  const streakStatus = document.getElementById('streakStatus');

  const flashRow = document.getElementById('flashRow');
  const quizRow  = document.getElementById('quizRow');

  const btnKnownBox   = document.getElementById('btnKnown');
  const btnRevise1Box = document.getElementById('btnRevise1');
  const btnRevise2Box = document.getElementById('btnRevise2');

  /* Overlay conocidos */
  const knownOverlay  = document.getElementById('knownOverlay');
  const knownGrid     = document.getElementById('knownGrid');
  const knownCount    = document.getElementById('knownCount');

  /* ========= Utils ========= */
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function hoursSince(ts){ if(!ts) return null; const diffMs = Date.now() - ts; return Math.floor(diffMs / 3600000); }
  function saveAll(){ saveUserState(); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function dedupeByHanzi(rows){
    const seen = new Set(); const out = [];
    for(const r of rows){ const key = r[0]; if(seen.has(key)) continue; seen.add(key); out.push(r); }
    return out;
  }

  /* ========= Audio (WebAudio) ========= */

  /* ========= MÃºsica de fondo para modo desafÃ­o ========= */
  let desafioMusic = null;
  function playDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
    }
    desafioMusic = new Audio('music/track1.mp3');
    desafioMusic.loop = true;
    desafioMusic.volume = 0.33;
    desafioMusic.play();
  }
  function stopDesafioMusic() {
    if (desafioMusic) {
      desafioMusic.pause();
      desafioMusic.currentTime = 0;
      desafioMusic = null;
    }
  }
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  async function ensureAudio(){ try { if(audioCtx.state !== 'running') await audioCtx.resume(); } catch(e){} }
  function beep(freq=440, duration=0.12, type='sine', gain=0.05){
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    o.stop(audioCtx.currentTime + duration);
  }
  function soundCorrect(){
  // Sonido tipo "coin" de dos notas
  beep(1397, 0.11, 'triangle', 0.16); // F6
  setTimeout(() => beep(2093, 0.13, 'triangle', 0.13), 80); // C7 pop
  }

  // Sonido de celebraciÃ³n para x/x correctas
  function soundCelebration(){
  // Nuevo sonido glorioso: acorde mayor, arpegio rÃ¡pido y nota brillante
  beep(523, 0.14, 'triangle', 0.19); // C5
  setTimeout(() => beep(659, 0.13, 'triangle', 0.17), 60); // E5
  setTimeout(() => beep(784, 0.13, 'triangle', 0.15), 120); // G5
  setTimeout(() => beep(1046, 0.11, 'triangle', 0.13), 180); // C6
  setTimeout(() => beep(1568, 0.09, 'triangle', 0.11), 240); // G6
  setTimeout(() => beep(2093, 0.18, 'triangle', 0.13), 320); // C7
    
  }
  function soundWrong(){
    // Efecto digital tipo "fart" corto
    // Secuencia descendente y distorsionada
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
  o.type = 'sawtooth';
  o.frequency.setValueAtTime(110, ctx.currentTime);
  o.frequency.linearRampToValueAtTime(55, ctx.currentTime + 0.18);
  g.gain.setValueAtTime(0.108, ctx.currentTime); // -40%
  g.gain.linearRampToValueAtTime(0.006, ctx.currentTime + 0.18); // -40%
    o.connect(g); g.connect(ctx.destination);
    o.start();
    o.stop(ctx.currentTime + 0.19);
    // "pop" final
  setTimeout(() => beep(70, 0.07, 'triangle', 0.038), 170); // -40%
  }

  /* ========= Datasets (ES) ========= */
  // Unidad 2
  function unit2Sample(){
    return [
      ['ä¸€','yÄ«','uno','unit2','S'],
      ['äºŒ','Ã¨r','dos','unit2','S'],
      ['ä¸‰','sÄn','tres','unit2','S'],
      ['å››','sÃ¬','cuatro','unit2','S'],
      ['äº”','wÇ”','cinco','unit2','S'],
      ['å…­','liÃ¹','seis','unit2','S'],
      ['ä¸ƒ','qÄ«','siete','unit2','S'],
      ['å…«','bÄ','ocho','unit2','S'],
      ['ä¹','jiÇ”','nueve','unit2','S'],
      ['å','shÃ­','diez','unit2','S'],
      ['è°¢è°¢','xiÃ¨xie','gracias','unit2','E'],
      ['ä¸å®¢æ°”','bÃº kÃ¨qi','de nada','unit2','E'],
      ['å¯¹ä¸èµ·','duÃ¬buqÇ','perdÃ³n / lo siento','unit2','E'],
      ['æ²¡å…³ç³»','mÃ©iguÄnxi','no pasa nada','unit2','E'],
      ['å¤§å®¶å¥½','dÃ jiÄ hÇo','hola a todos','unit2','E'],
    ];
  }
  // Unidad 3
  function unit3Sample(){
    return [
      ['ä½ ','nÇ','tÃº','unit3','P'],
      ['æˆ‘','wÇ’','yo','unit3','P'],
      ['æ˜¯','shÃ¬','ser','unit3','V'],
      ['å¾ˆ','hÄ›n','muy','unit3','E'],
      ['é«˜å…´','gÄoxÃ¬ng','contento / feliz','unit3','A'],
      ['è®¤è¯†','rÃ¨nshi','conocer','unit3','V'],
      ['å‘¢','ne','partÃ­cula de seguimiento','unit3','E'],
      ['å—','ma','partÃ­cula interrogativa','unit3','E'],
      ['ä¹Ÿ','yÄ›','tambiÃ©n','unit3','E'],
      ['æ‚¨','nÃ­n','usted (formal)','unit3','P'],
      ['å–œæ¬¢','xÇhuan','gustar','unit3','V'],
      ['å­¦','xuÃ©','aprender / estudiar','unit3','V'],
      ['æ±‰è¯­','hÃ nyÇ”','chino (idioma)','unit3','S'],
      ['å­¦ç”Ÿ','xuÃ©sheng','estudiante','unit3','S'],
      ['è€å¸ˆ','lÇoshÄ«','profesor','unit3','S'],
      ['å†è§','zÃ ijiÃ n','adiÃ³s','unit3','E'],
    ];
  }
  // Unidad 4
  function unit4Sample(){
    return [
      ['å«','jiÃ o','llamarse / llamar','unit4','V'],
      ['ä»€ä¹ˆ','shÃ©nme','quÃ©','unit4','E'],
      ['åå­—','mÃ­ngzi','nombre','unit4','S'],
      ['å¤šå¤§','duÅdÃ ','quÃ© edad / cuÃ¡n grande','unit4','E'],
      ['å²','suÃ¬','aÃ±os (de edad)','unit4','S'],
      ['äºº','rÃ©n','persona / gente','unit4','S'],
      ['ä¸­å›½','ZhÅngguÃ³','China','unit4','S'],
      ['ä¸','bÃ¹','no (negaciÃ³n)','unit4','E'],
      ['å“ª','nÇ','cuÃ¡l (de) / quÃ© lugar','unit4','E'],
    ];
  }
  // Unidad 5
  function unit5Sample(){
    return [
      ['æƒ³','xiÇng','querer / pensar','unit5','V'],
      ['åƒ','chÄ«','comer','unit5','V'],
      ['åš','zuÃ²','hacer','unit5','V'],
      ['é¥­','fÃ n','comida','unit5','S'],
      ['å–','hÄ“','beber','unit5','V'],
      ['èŒ¶','chÃ¡','tÃ©','unit5','S'],
      ['æ°´','shuÇ','agua','unit5','S'],
      ['å’–å•¡','kÄfÄ“i','cafÃ© (bebida)','unit5','S'],
      ['è¯´','shuÅ','hablar / decir','unit5','V'],
      ['å”±','chÃ ng','cantar','unit5','V'],
      ['æ­Œ','gÄ“','canciÃ³n','unit5','S'],
      ['çœ‹','kÃ n','ver / mirar','unit5','V'],
      ['ä¹¦','shÅ«','libro','unit5','S'],
      ['ç”µå½±','diÃ nyÇng','pelÃ­cula','unit5','S'],
      ['ç”µè§†å‰§','diÃ nshÃ¬jÃ¹','serie de TV','unit5','S'],
      ['å¬','tÄ«ng','escuchar','unit5','V'],
      ['éŸ³ä¹','yÄ«nyuÃ¨','mÃºsica','unit5','S'],
    ];
  }
  // Unidad 6
  function unit6Sample(){
    return [
      ['ä»–','tÄ','Ã©l','unit6','P'],
      ['å¥¹','tÄ','ella','unit6','P'],
      ['ä»¬','men','sufijo plural','unit6','E'],
      ['è°','shÃ©i','quiÃ©n','unit6','E'],
      ['çš„','de','partÃ­cula posesiva','unit6','E'],
      ['æœ‹å‹','pÃ©ngyou','amigo / amiga','unit6','S'],
      ['ç”·','nÃ¡n','hombre / masculino','unit6','S'],
      ['å¥³','nÇš','mujer / femenino','unit6','S'],
      ['çˆ¸çˆ¸','bÃ ba','papÃ¡','unit6','S'],
      ['å¦ˆå¦ˆ','mÄma','mamÃ¡','unit6','S'],
      ['å“¥å“¥','gÄ“ge','hermano mayor','unit6','S'],
      ['å¼Ÿå¼Ÿ','dÃ¬di','hermano menor','unit6','S'],
      ['å§å§','jiÄ›jie','hermana mayor','unit6','S'],
      ['å¦¹å¦¹','mÃ¨imei','hermana menor','unit6','S'],
      ['å„¿å­','Ã©rzi','hijo (varÃ³n)','unit6','S'],
      ['å¥³å„¿','nÇšâ€™Ã©r','hija','unit6','S'],
      ['å¸…','shuÃ i','guapo','unit6','A'],
      ['æ¼‚äº®','piÃ oliang','bonita / guapa','unit6','A'],
      ['èªæ˜','cÅngming','inteligente','unit6','A'],
      ['è€å…¬','lÇogÅng','esposo','unit6','S'],
      ['è€å©†','lÇopo','esposa','unit6','S'],
    ];
  }
  // Unidad 7
  function unit7Sample(){
    return [
      ['ç‰¹åˆ«','tÃ¨biÃ©','especialmente / muy','unit7','E'],
      ['éå¸¸','fÄ“ichÃ¡ng','muy / muchÃ­simo','unit7','E'],
      ['è§‰å¾—','juÃ©de','creer / opinar / sentir que','unit7','V'],
      ['æ€ä¹ˆæ ·','zÄ›nmeyÃ ng','quÃ© tal','unit7','E'],
      ['å¥½çœ‹','hÇokÃ n','bonito (de ver)','unit7','A'],
      ['å¥½åƒ','hÇochÄ«','rico (de comer)','unit7','A'],
      ['å¥½å¬','hÇotÄ«ng','agradable de oÃ­r','unit7','A'],
      ['æœ‰æ„æ€','yÇ’uyÃ¬si','interesante','unit7','A'],
      ['è¿™','zhÃ¨','este / esta','unit7','P'],
      ['é‚£','nÃ ','ese / esa / aquel','unit7','P'],
      ['ä¸ª','gÃ¨','clasificador general','unit7','E'],
      ['æœ¬','bÄ›n','clasificador de libros','unit7','E'],
      ['é¦–','shÇ’u','clasificador de canciones','unit7','E'],
      ['æ¯','bÄ“i','clasificador: vaso / taza','unit7','E'],
    ];
  }
  // Unidad 8
  function unit8Sample(){
    return [
      ['ä¸ºä»€ä¹ˆ','wÃ¨ishÃ©nme','por quÃ©','unit8','E'],
      ['å› ä¸º','yÄ«nwÃ¨i','porque','unit8','E'],
      ['æ¼”å‘˜','yÇnyuÃ¡n','actor / actriz','unit8','S'],
      ['æ­Œæ‰‹','gÄ“shÇ’u','cantante','unit8','S'],
      ['ç½‘çº¢','wÇnghÃ³ng','influencer','unit8','S'],
      ['å¯çˆ±','kÄ›â€™Ã i','tierno / adorable','unit8','A'],
      ['æœ‰å','yÇ’umÃ­ng','famoso','unit8','A'],
      ['æµªæ¼«','lÃ ngmÃ n','romÃ¡ntico','unit8','A'],
      ['æ„ŸåŠ¨äºº','gÇndÃ²ng rÃ©n','conmovedor','unit8','A'],
      ['æ£’','bÃ ng','genial','unit8','A'],
      ['é…·','kÃ¹','cool','unit8','A'],
      ['æœ‰','yÇ’u','haber / tener','unit8','V'],
      ['å’Œ','hÃ©','y (conjunciÃ³n)','unit8','E'],
      ['æ²¡','mÃ©i','no hay / no tener','unit8','E'],
    ];
  }
  // Unidad 9
  function unit9Sample(){
    return [
      ['åœ¨','zÃ i','estar / en','unit9','V'],
      ['å®¶','jiÄ','casa / hogar','unit9','S'],
      ['å­¦æ ¡','xuÃ©xiÃ o','escuela','unit9','S'],
      ['ç”µå½±é™¢','diÃ nyÇngyuÃ n','cine','unit9','S'],
      ['å•†åº—','shÄngdiÃ n','tienda','unit9','S'],
      ['å’–å•¡åº—','kÄfÄ“i diÃ n','cafeterÃ­a','unit9','S'],
      ['é¥­åº—','fÃ ndiÃ n','restaurante / hotel','unit9','S'],
      ['è¶…å¸‚','chÄoshÃ¬','supermercado','unit9','S'],
      ['å…¬å›­','gÅngyuÃ¡n','parque','unit9','S'],
      ['å·¥ä½œ','gÅngzuÃ²','trabajar / trabajo','unit9','V'],
      ['ä¹°','mÇi','comprar','unit9','V'],
      ['ä¸œè¥¿','dÅngxi','cosas / objetos','unit9','S'],
      ['è¿™å„¿','zhÃ¨r','aquÃ­','unit9','P'],
      ['é‚£å„¿','nÃ r','allÃ­','unit9','P'],
      ['å“ªå„¿','nÇr','dÃ³nde','unit9','E'],
      ['æ‰‹æœº','shÇ’ujÄ«','telÃ©fono mÃ³vil','unit9','S'],
      ['ç”µè„‘','diÃ nnÇo','computadora','unit9','S'],
    ];
  }

  // Nivel 2
  function unit2N2Sample(){
    return [
      ['æ—©ä¸Š','zÇoshang','maÃ±ana','unit2N2','S'],['ä¸‹åˆ','xiÃ wÇ”','tarde','unit2N2','S'],['æ™šä¸Š','wÇnshang','noche','unit2N2','S'],['ä¸­åˆ','zhÅngwÇ”','mediodÃ­a','unit2N2','S'],['ä»Šå¤©','jÄ«ntiÄn','hoy','unit2N2','S'],['æ˜å¤©','mÃ­ngtiÄn','maÃ±ana (dÃ­a siguiente)','unit2N2','S'],['ç°åœ¨','xiÃ nzÃ i','ahora','unit2N2','S'],['ä¸€ä¼šå„¿','yÃ­huÃ¬r','un rato','unit2N2','S'],['å‡ ç‚¹','jÇdiÇn','quÃ© hora','unit2N2','E'],['åŠ','bÃ n','media','unit2N2','S'],['åˆ†','fÄ“n','minuto','unit2N2','S'],['ç¡è§‰','shuÃ¬jiÃ o','dormir','unit2N2','V'],['ä»€ä¹ˆæ—¶å€™','shÃ©nme shÃ­hou','cuÃ¡ndo','unit2N2','E']
    ];
  }
  function unit3N2Sample(){
    return [
      ['å¤šå°‘','duÅshao','cuÃ¡nto','unit3N2','E'],['é’±','qiÃ¡n','dinero','unit3N2','S'],['æƒ³è¦','xiÇngyÃ o','querer','unit3N2','V'],['è¯·é—®','qÇngwÃ¨n','disculpe','unit3N2','P'],['å—é’±','kuÃ iqiÃ¡n','yuan','unit3N2','S'],['å…ƒ','yuÃ¡n','yuan','unit3N2','S'],['ç™¾','bÇi','cien','unit3N2','S'],['è´µ','guÃ¬','caro','unit3N2','A'],['ä¾¿å®œ','piÃ¡nyi','barato','unit3N2','A'],['ç‰›å¥¶','niÃºnÇi','leche','unit3N2','S'],['å¥¶èŒ¶','nÇichÃ¡','tÃ© con leche','unit3N2','S'],['è¯·å®¢','qÇngkÃ¨','invitar','unit3N2','V'],['è§','jiÃ n','ver','unit3N2','V'],['å¼€å§‹','kÄishÇ','empezar','unit3N2','V'],['å»','qÃ¹','ir','unit3N2','V'],['å›å®¶','huÃ­jiÄ','volver a casa','unit3N2','V'],['å§','ba','partÃ­cula sugerencia','unit3N2','P'],['ç»¿èŒ¶','lÇœchÃ¡','tÃ© verde','unit3N2','S'],['çº¢èŒ¶','hÃ³ngchÃ¡','tÃ© rojo','unit3N2','S']
    ];
  }
  function unit4N2Sample(){
    return [
      ['æ¯”','bÇ','comparar','unit4N2','V'],['æ¯”è¾ƒ','bÇjiÃ o','comparar','unit4N2','V'],['ä¸‰æ˜æ²»','sÄnmÃ­ngzhÃ¬','sÃ¡ndwich','unit4N2','S'],['è›‹ç³•','dÃ ngÄo','pastel','unit4N2','S'],['é¢åŒ…','miÃ nbÄo','pan','unit4N2','S'],['ç‚¹å¿ƒ','diÇnxÄ«n','snack','unit4N2','S'],['ä¸€æ ·','yÃ­yÃ ng','igual','unit4N2','A'],['é«˜','gÄo','alto','unit4N2','A'],['çŸ®','Çi','bajo','unit4N2','A'],['å¤§','dÃ ','grande','unit4N2','A'],['å°','xiÇo','pequeÃ±o','unit4N2','A']
    ];
  }
  function unit5N2Sample(){
    return [
      ['å¹´','niÃ¡n','aÃ±o','unit5N2','S'],['æœˆ','yuÃ¨','mes','unit5N2','S'],['å·','hÃ o','nÃºmero','unit5N2','S'],['æ—¥','rÃ¬','dÃ­a','unit5N2','S'],['æ˜ŸæœŸå¤©','xÄ«ngqÄ«tiÄn','domingo','unit5N2','S'],['æ˜ŸæœŸå…­','xÄ«ngqÄ«liÃ¹','sÃ¡bado','unit5N2','S'],['å‘¨æœ«','zhÅumÃ²','fin de semana','unit5N2','S'],['æ˜ŸæœŸ','xÄ«ngqÄ«','semana','unit5N2','S'],['æ˜ŸæœŸå‡ ','xÄ«ngqÄ«jÇ','quÃ© dÃ­a de la semana','unit5N2','E'],['å‡ æœˆ','jÇyuÃ¨','quÃ© mes','unit5N2','E'],['å‡ å·','jÇhÃ o','quÃ© nÃºmero','unit5N2','E'],['ä»Šå¹´','jÄ«nniÃ¡n','este aÃ±o','unit5N2','S'],['æ˜å¹´','mÃ­ngniÃ¡n','el aÃ±o que viene','unit5N2','S'],['ä¸‹ä¸ª','xiÃ ge','el siguiente','unit5N2','P'],['ç”Ÿæ—¥','shÄ“ngrÃ¬','cumpleaÃ±os','unit5N2','S'],['å¿«ä¹','kuÃ ilÃ¨','feliz','unit5N2','A'],['ç©º','kÃ²ng','libre','unit5N2','A'],['ç¥ä½ ','zhÃ¹ nÇ','te deseo','unit5N2','V']
    ];
  }
  function unit6N2Sample(){
    return [
      ['è·Ÿ','gÄ“n','con','unit6N2','P'],['ä¸€èµ·','yÃ¬qÇ','juntos','unit6N2','P'],['è®¡åˆ’','jÃ¬huÃ ','plan','unit6N2','S'],['æœ‰ç©º','yÇ’ukÃ²ng','tener tiempo libre','unit6N2','A'],['æ¥','lÃ¡i','venir','unit6N2','V'],['æ²¡æœ‰ç©º','mÃ©iyÇ’u kÃ²ng','no tener tiempo','unit6N2','A']
    ];
  }
  function unit7N2Sample(){
    return [
      ['å¾®ä¿¡','wÄ“ixÃ¬n','WeChat','unit7N2','S'],['ä¿¡æ¯','xÃ¬nxÄ«','mensaje','unit7N2','S'],['å‘','fÄ','enviar','unit7N2','V'],['å·ç ','hÃ omÇ','nÃºmero','unit7N2','S'],['ç”µè¯','diÃ nhuÃ ','telÃ©fono','unit7N2','S'],['æ‰‹æœº','shÇ’ujÄ«','mÃ³vil','unit7N2','S'],['ä¿¡æ¯','xÃ¬nxÄ«','mensaje','unit7N2','S'],['æ‰“ç”µè¯','dÇ diÃ nhuÃ ','llamar por telÃ©fono','unit7N2','V'],['ç»™','gÄ›i','dar','unit7N2','V'],['æ‰‹æœºå·ç ','shÇ’ujÄ« hÃ omÇ','nÃºmero de mÃ³vil','unit7N2','S'],['å½“','dÄng','ser','unit7N2','V'],['å¯ä»¥','kÄ›yÇ','poder','unit7N2','V'],['é›¶','lÃ­ng','cero','unit7N2','S'],['å¹º','yÄo','uno (en nÃºmeros)','unit7N2','S']
    ];
  }
  function unit8N2Sample(){
    return [
      ['éƒ½','dÅu','todos','unit8N2','P'],['çŸ¥é“','zhÄ«dÃ o','saber','unit8N2','V'],['ä¼š','huÃ¬','saber (habilidad)','unit8N2','V'],['ä¸€ç‚¹å„¿','yÃ¬diÇnr','un poco','unit8N2','S'],['ä¸€äº›','yÃ¬xiÄ“','algunos','unit8N2','S'],['å¼€è½¦','kÄichÄ“','conducir','unit8N2','V'],['ç”¨','yÃ²ng','usar','unit8N2','V'],['ç”µè„‘','diÃ nnÇo','computadora','unit8N2','S'],['å•¤é…’','pÃ­jiÇ”','cerveza','unit8N2','S'],['çº¢é…’','hÃ³ngjiÇ”','vino tinto','unit8N2','S'],['ç™½é…’','bÃ¡ijiÇ”','licor blanco','unit8N2','S'],['é¥¿','Ã¨','hambriento','unit8N2','A'],['æ¸´','kÄ›','sediento','unit8N2','A'],['ç´¯','lÃ¨i','cansado','unit8N2','A'],['æ€•','pÃ ','tener miedo','unit8N2','A'],['ç”Ÿæ°”','shÄ“ngqÃ¬','enojado','unit8N2','A']
    ];
  }
  function unit9N2Sample(){
    return [
      ['æ¡Œå­','zhuÅzi','mesa','unit9N2','S'],['ä¸Šé¢','shÃ ngmiÃ n','encima','unit9N2','P'],['ä¸‹é¢','xiÃ miÃ n','debajo','unit9N2','P'],['æ¤…å­','yÇzi','silla','unit9N2','S'],['å‰é¢','qiÃ¡nmiÃ n','delante','unit9N2','P'],['åé¢','hÃ²umiÃ n','detrÃ¡s','unit9N2','P'],['ä¹¦åŒ…','shÅ«bÄo','mochila','unit9N2','S'],['é‡Œé¢','lÇmiÃ n','dentro','unit9N2','P'],['å¤–é¢','wÃ imiÃ n','fuera','unit9N2','P'],['å¯¹é¢','duÃ¬miÃ n','enfrente','unit9N2','P'],['å·¦è¾¹','zuÇ’biÄn','izquierda','unit9N2','P'],['å³è¾¹','yÃ²ubiÄn','derecha','unit9N2','P'],['æ—è¾¹','pÃ¡ngbiÄn','al lado','unit9N2','P'],['ç›’å­','hÃ©zi','caja','unit9N2','S']
    ];
  }
  function unit10N2Sample(){
    return [
      ['å¤©æ°”','tiÄnqÃ¬','clima','unit10N2','S'],['å†·','lÄ›ng','frÃ­o','unit10N2','A'],['çƒ­','rÃ¨','calor','unit10N2','A'],['æ˜¨å¤©','zuÃ³tiÄn','ayer','unit10N2','S'],['ä¸å†·ä¸çƒ­','bÃ¹ lÄ›ng bÃ¹ rÃ¨','ni frÃ­o ni calor','unit10N2','A'],['å¤ªäº†','tÃ i le','demasiado','unit10N2','A'],['åŒ—äº¬','BÄ›ijÄ«ng','Beijing','unit10N2','S'],['ä¸Šæµ·','ShÃ nghÇi','Shanghai','unit10N2','S'],['å¹¿å·','GuÇngzhÅu','Guangzhou','unit10N2','S'],['é¦™æ¸¯','XiÄnggÇng','Hong Kong','unit10N2','S'],['è½¦','chÄ“','auto','unit10N2','S'],['å…¬å…±æ±½è½¦','gÅnggÃ²ng qÃ¬chÄ“','autobÃºs','unit10N2','S'],['åœ°é“','dÃ¬tiÄ›','metro','unit10N2','S'],['ç«è½¦','huÇ’chÄ“','tren','unit10N2','S'],['å‡ºç§Ÿè½¦','chÅ«zÅ«chÄ“','taxi','unit10N2','S'],['æ»´æ»´','DÄ«dÄ«','Didi (app)','unit10N2','S'],['é£æœº','fÄ“ijÄ«','aviÃ³n','unit10N2','S'],['èˆ¹','chuÃ¡n','barco','unit10N2','S'],['å','zuÃ²','sentarse / viajar en','unit10N2','V'],['éª‘','qÃ­','montar','unit10N2','V'],['è‡ªè¡Œè½¦','zÃ¬xÃ­ngchÄ“','bicicleta','unit10N2','S'],['æ‘©æ‰˜è½¦','mÃ³tuÅchÄ“','moto','unit10N2','S']
    ];
  }


  /* ========= Carga ========= */
  async function loadAll(){
    await loadUserState(jwtToken);
    // SIEMPRE inicializar todas las cartas desde las funciones para asegurar que todas las unidades estÃ©n disponibles
    const rows = dedupeByHanzi([
      ...unit2Sample(), ...unit3Sample(), ...unit4Sample(), ...unit5Sample(),
      ...unit6Sample(), ...unit7Sample(), ...unit8Sample(), ...unit9Sample(),
      ...unit2N2Sample(), ...unit3N2Sample(), ...unit4N2Sample(), ...unit5N2Sample(),
      ...unit6N2Sample(), ...unit7N2Sample(), ...unit8N2Sample(), ...unit9N2Sample(), ...unit10N2Sample()
    ]);
    
    // Si no hay cartas guardadas, crear nuevas
    if(!cards || cards.length === 0) {
      cards = rows.map(row => ({
        id: uid(),
        hanzi: row[0],
        pinyin: row[1],
        meaning: row[2],
        unit: row[3],
        cat: row[4],
        dkAddedAt: 0, revise1: false, revise2: false, known: false,
        challengeStreak: 0, challengeBest: 0, lastChallengeAt: 0,
        level: row[3].includes('N2') ? 2 : 1
      }));
      await saveUserState();
    } else {
      // Si hay cartas guardadas, actualizar/agregar las que falten y asegurar que el campo 'unit' exista
      const existingHanzi = new Set(cards.map(c => c.hanzi));
      const missingCards = rows.filter(row => !existingHanzi.has(row[0]));
      
      // Agregar cartas faltantes
      if(missingCards.length > 0) {
        const newCards = missingCards.map(row => ({
          id: uid(),
          hanzi: row[0],
          pinyin: row[1],
          meaning: row[2],
          unit: row[3],
          cat: row[4],
          dkAddedAt: 0, revise1: false, revise2: false, known: false,
          challengeStreak: 0, challengeBest: 0, lastChallengeAt: 0,
          level: row[3].includes('N2') ? 2 : 1
        }));
        cards = [...cards, ...newCards];
      }
      
      // Asegurar que todas las cartas tengan el campo 'unit'
      cards.forEach(card => {
        if(!card.unit) {
          const matchingRow = rows.find(row => row[0] === card.hanzi);
          if(matchingRow) {
            card.unit = matchingRow[3];
            card.level = matchingRow[3].includes('N2') ? 2 : 1;
          }
        }
      });
      
      await saveUserState();
    }
  // Renderizar barra de XP y stats con el valor correcto al cargar
  renderXPBar();
  updateStats();
    // Mostrar SIEMPRE el box y botÃ³n de Nivel 2 si nivel2Unlocked es true
    setTimeout(() => {
      const nivel2Wrap = document.getElementById('nivel2Wrap');
      const btnNivel2 = document.getElementById('btnNivel2');
      const nivel2Box = document.getElementById('nivel2Box');
      if(nivel2Unlocked){
        if(nivel2Wrap) nivel2Wrap.style.display = '';
        if(btnNivel2) btnNivel2.style.display = '';
        if(nivel2Box) nivel2Box.style.display = '';
      } else {
        if(nivel2Wrap) nivel2Wrap.style.display = 'none';
        if(btnNivel2) btnNivel2.style.display = 'none';
        if(nivel2Box) nivel2Box.style.display = 'none';
      }
    }, 200);
  }

  /* ========= LÃ³gica ========= */
  function buildQueue(type){
      if(type==='todoN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit)));
      if(type==='desafioN1') return shuffle(cards.filter(c=>[
        'unit2','unit3','unit4','unit5','unit6','unit7','unit8','unit9'
      ].includes(c.unit))).slice(0,20);
      if(type==='unit2') return cards.filter(c=>c.unit==='unit2');
      if(type==='unit3') return cards.filter(c=>c.unit==='unit3');
      if(type==='unit4') return cards.filter(c=>c.unit==='unit4');
      if(type==='unit5') return cards.filter(c=>c.unit==='unit5');
      if(type==='unit6') return cards.filter(c=>c.unit==='unit6');
      if(type==='unit7') return cards.filter(c=>c.unit==='unit7');
      if(type==='unit8') return cards.filter(c=>c.unit==='unit8');
      if(type==='unit9') return cards.filter(c=>c.unit==='unit9');
      // Nivel 2
      if(type==='todoN2') return shuffle(cards.filter(c=>[
        'unit2N2','unit3N2','unit4N2','unit5N2','unit6N2','unit7N2','unit8N2','unit9N2','unit10N2'
      ].includes(c.unit)));
      if(type==='unit2N2') return cards.filter(c=>c.unit==='unit2N2');
      if(type==='unit3N2') return cards.filter(c=>c.unit==='unit3N2');
      if(type==='unit4N2') return cards.filter(c=>c.unit==='unit4N2');
      if(type==='unit5N2') return cards.filter(c=>c.unit==='unit5N2');
      if(type==='unit6N2') return cards.filter(c=>c.unit==='unit6N2');
      if(type==='unit7N2') return cards.filter(c=>c.unit==='unit7N2');
      if(type==='unit8N2') return cards.filter(c=>c.unit==='unit8N2');
      if(type==='unit9N2') return cards.filter(c=>c.unit==='unit9N2');
      if(type==='unit10N2') return cards.filter(c=>c.unit==='unit10N2');
      if(type==='known') return shuffle(cards.filter(c=>c.known));
      if(type==='revise1') return shuffle(cards.filter(c=>c.revise1));
      if(type==='revise2') return shuffle(cards.filter(c=>c.revise2));
      if(type==='challenge') return shuffle(cards.filter(c=>c.known)).slice(0,10);
      return [];
    }
  document.getElementById('btnDesafioN1').onclick = () => {
    const nivel1Box = document.getElementById('nivel1Box');
    if(nivel1Box) nivel1Box.classList.add('hidden');
    startMission('desafioN1');
  };
  document.getElementById('btnTodoN1').onclick = () => startMission('todoN1');

  function startMission(type){
    currentMission = type;
    sessionQueue = buildQueue(type).slice();
    todayReviewed = 0;
    sessionTotal = sessionQueue.length;
    sessionCorrect = 0;

    // MÃºsica de fondo solo en modo desafÃ­o
    if(type==='challenge' || type==='desafioN1'){
      playDesafioMusic();
      setMode(type==='challenge' ? 'quizMeaning' : (Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin'));
      bodyEl.classList.add('challenge-bg');
      statBox.classList.add('challenge-stat');
      if(type==='desafioN1') startDesafioTimer();
      // Ocultar la tabla de conocidas y cerrar overlay si estÃ¡ abierto
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = 'none';
      const knownOverlay = document.getElementById('knownOverlay');
      if(knownOverlay) knownOverlay.remove();
    } else {
      stopDesafioMusic();
      setMode('flash');
      bodyEl.classList.remove('challenge-bg');
      statBox.classList.remove('challenge-stat');
      // Mostrar la tabla de conocidas
      const knownTableSection = document.querySelector('section.mt-16');
      if(knownTableSection) knownTableSection.style.display = '';
    }

    nextCard();
    updateStats();
  }

// --- Contador regresivo para desafÃ­o ---
let desafioTimer = null;
let desafioTimeLeft = 300; // 5 minutos en segundos
function startDesafioTimer(){
  clearDesafioTimer();
  desafioTimeLeft = 120;
  updateDesafioTimerUI();
  // Mostrar temporizador solo en modo desafioN1
  const statMission = document.getElementById('statMission');
  if(currentMission !== 'desafioN1') {
    removeDesafioTimerUI();
    return;
  }
  desafioTimer = setInterval(()=>{
    if(currentMission !== 'desafioN1') {
      clearDesafioTimer();
      return;
    }
    desafioTimeLeft--;
    updateDesafioTimerUI();
    if(desafioTimeLeft<=0){
      clearDesafioTimer();
      showDesafioPerdido();
      bloquearDesafio();
    }
  },1000);
}
function clearDesafioTimer(){
  if(desafioTimer){ clearInterval(desafioTimer); desafioTimer=null; }
  removeDesafioTimerUI();
}
function updateDesafioTimerUI(){
  // Solo mostrar si estÃ¡ en modo desafioN1
  if(currentMission !== 'desafioN1') {
    removeDesafioTimerUI();
    return;
  }
  const statMission = document.getElementById('statMission');
  if(statMission){
    const min = Math.floor(desafioTimeLeft/60).toString().padStart(2,'0');
    const sec = (desafioTimeLeft%60).toString().padStart(2,'0');
    statMission.textContent = `Tiempo: ${min}:${sec}`;
  }
}
function removeDesafioTimerUI(){
  const timerEl = document.getElementById('desafioTimer');
  if(timerEl) timerEl.remove();
}
function showDesafioPerdido(){
  let msg = document.getElementById('desafioPerdidoMsg');
  if(!msg){
    msg = document.createElement('div');
    msg.id = 'desafioPerdidoMsg';
    msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-rose-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
    msg.textContent = 'Te has quedado sin tiempo, perdiste el desafÃ­o';
  msg.onclick = () => { location.reload(); };
    document.body.appendChild(msg);
  }
  msg.style.opacity = '1';
}
function bloquearDesafio(){
  // Bloquear controles de desafÃ­o
  document.getElementById('cardWrap').style.pointerEvents = 'none';
  document.getElementById('flashRow').style.pointerEvents = 'none';
  // El usuario debe elegir otro modo para continuar
}

  function ensureReviseFlags(card){
    if(!card.dkAddedAt){ card.dkAddedAt = now(); }
    card.revise1 = true; card.revise2 = true; card.known = false;
  }

  /* ===== Feedback visual/sonoro y resaltado de cajas ===== */
  function pulseBox(el, colorClass){
    if(!el) return;
    el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal');
    void el.offsetWidth; // reflow para reiniciar animaciÃ³n
    el.classList.add('pulseBadge', colorClass);
    setTimeout(()=>{ el.classList.remove('pulseBadge','pulseGreen','pulseAmber','pulseTeal'); }, 750);
  }
  async function feedbackCorrect(){
    await ensureAudio();
    cardEl.classList.remove('shakeAnim'); void cardEl.offsetWidth;
    cardEl.classList.add('popAnim');
    soundCorrect();
    pulseBox(btnKnownBox, 'pulseGreen');
  }
  async function feedbackWrong(){
    await ensureAudio();
    cardEl.classList.remove('popAnim'); void cardEl.offsetWidth;
    soundWrong();
    pulseBox(btnRevise1Box, 'pulseAmber');
    pulseBox(btnRevise2Box, 'pulseTeal');
  }

  // Llama feedback y pasa a siguiente tras una breve pausa
  function respond(knew){
    if(knew) feedbackCorrect();
    else {
      // Todo el feedback visual y de estado a la vez
      feedbackWrong(); // sonido y glow
      cardEl.classList.add('cardWrong','shakeAnim'); // shake y fondo rojo
      // Si es incorrecto, agregar flags de repaso/confirmar inmediatamente
      if(currentCard) ensureReviseFlags(currentCard);
      setTimeout(()=>{
        cardEl.classList.add('cardWrongFade');
        // Fade out a las opciones tras 1s
        const quizBtns = Array.from(quizRow.children);
        quizBtns.forEach(b=>{
          if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
          if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
        });
      }, 1000);
      setTimeout(()=>{
        cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
        answer(false);
      }, 2000);
      return;
    }
    setTimeout(()=>{ answer(knew); }, 420);
  }

  function answer(knew){
      if(!currentCard) return;
      const c = currentCard;

      if(currentMission==='challenge'){
        // actualizar racha y Ãºltima hora
        c.lastChallengeAt = now();
        if(knew){
          // Si la tarjeta es mÃ­tica violeta, sumar 5 niveles
          if(cardEl.classList.contains('mythic-violet')){
            c.challengeStreak += 5;
          } else if(cardEl.classList.contains('premium-gold')){
            c.challengeStreak += 2;
          } else {
            c.challengeStreak++;
          }
          c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
        } else {
          // Si la tarjeta es legendaria roja, eliminar este caracter y otro al azar de conocidas
          if(cardEl.classList.contains('legendary-red')){
            c.known = false;
            c.challengeStreak = 0;
            // Buscar otro caracter al azar de las conocidas (excluyendo el actual)
            const knownChars = cards.filter(card => card.known && card.id !== c.id);
            if(knownChars.length > 0){
              const idx = Math.floor(Math.random() * knownChars.length);
              knownChars[idx].known = false;
              knownChars[idx].challengeStreak = 0;
            }
          }
          c.challengeStreak = 0;
          ensureReviseFlags(c); // sale de conocidas -> repaso/confirmar
        }
      } else if(currentMission==='desafioN1'){
        // Solo afecta si ya estÃ¡ en conocidas
        if(c.known) {
          if(knew){
            // Si la tarjeta es mÃ­tica violeta, sumar 5 niveles
            if(cardEl.classList.contains('mythic-violet')){
              c.challengeStreak += 5;
            } else if(cardEl.classList.contains('premium-gold')){
              c.challengeStreak += 2;
            } else {
              c.challengeStreak++;
            }
            c.challengeBest = Math.max(c.challengeBest, c.challengeStreak);
          } else {
            c.challengeStreak = 0;
            c.known = false;
            ensureReviseFlags(c);
          }
        }
        // Si no estÃ¡ en conocidas, no suma ni modifica nada
      } else if(currentMission.startsWith('unit') || currentMission==='todoN1'){
        if(knew){ c.known = true; }
        else    { ensureReviseFlags(c); }
      } else if(currentMission==='known'){
        if(knew){ c.known = true; }
        else {
          // Solo agrega a revise1 y revise2, pero NO elimina de conocidas ni reinicia challengeStreak
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
          c.known = true; // Asegura que nunca se elimine de conocidas
          // NO modificar challengeStreak
        }
      } else if(currentMission==='revise1'){
        if(knew){ c.revise1 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1/revise2
          if(!c.revise1) c.revise1 = true;
          if(!c.revise2) c.revise2 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      } else if(currentMission==='revise2'){
        if(knew){ c.revise2 = false; c.known = true; }
        else {
          // No eliminar de conocidas ni reiniciar racha, solo marcar revise1 y revise2
          if(!c.revise2) c.revise2 = true;
          if(!c.revise1) c.revise1 = true;
          if(!c.dkAddedAt) c.dkAddedAt = now();
          // NO modificar c.known ni challengeStreak
        }
      }

      if(knew) {
        sessionCorrect++;
        // Sumar XP si es modo quiz
        if(mode === 'quizPinyin' || mode === 'quizMeaning' || mode === 'quizHanzi') {
          const prevLevel = getCurrentLevel(xpPoints);
          xpPoints++;
          saveXP();
          const newLevel = getCurrentLevel(xpPoints);
          renderXPBar(newLevel > prevLevel);
        }
      }
      todayReviewed++;
      saveAll();
      nextCard();
    }

  function nextCard(){
    // Esperar medio segundo antes de iniciar la animaciÃ³n de flip
    setTimeout(() => {
      cardEl.classList.add('card-flip-vert', 'flipping');
      setTimeout(() => {
        // En el punto medio del flip, cambiar el contenido
        flipped = false; cardEl.classList.remove('flip');
        currentCard = sessionQueue.shift() || null;
        // Si estamos en challenge o desafioN1, elegir aleatoriamente entre quizMeaning, quizPinyin o quizHanzi
        if((currentMission==='challenge' || currentMission==='desafioN1') && currentCard) {
          const quizModes = ['quizMeaning', 'quizPinyin', 'quizHanzi'];
          setMode(quizModes[Math.floor(Math.random() * quizModes.length)]);
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        } else if(['quizPinyin','quizMeaning','quizHanzi'].includes(mode) && currentCard) {
          setTimeout(()=>{
            const btns = Array.from(document.querySelectorAll('#quizRow button'));
            btns.forEach(b=>b.disabled=false);
          }, 10);
        }
        // Premium gold (20%), mythic violet (10%) y legendary red (5%) en modo desafÃ­o
        if ((currentMission==='challenge'||currentMission==='desafioN1') && currentCard) {
          const rand = Math.random();
          if (rand < 0.1) {
            cardEl.classList.add('legendary-red');
            cardEl.classList.remove('mythic-violet');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.2) {
            cardEl.classList.add('mythic-violet');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
          } else if (rand < 0.50) {
            cardEl.classList.add('premium-gold');
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('mythic-violet');
          } else {
            cardEl.classList.remove('legendary-red');
            cardEl.classList.remove('premium-gold');
            cardEl.classList.remove('mythic-violet');
          }
        } else {
          cardEl.classList.remove('legendary-red');
          cardEl.classList.remove('premium-gold');
          cardEl.classList.remove('mythic-violet');
        }
        renderCard();
        updateStats();
        // limpiar animaciones para la prÃ³xima
        cardEl.classList.remove('popAnim','shakeAnim');
        // Completar el flip
        cardEl.classList.remove('flipping');
        cardEl.classList.add('flipped');
        setTimeout(() => {
          cardEl.classList.remove('card-flip-vert', 'flipped');
        }, 440);
      }, 220); // punto medio del flip
    }, 500); // delay antes de iniciar la animaciÃ³n
}

  function renderCard(){
    if(!currentCard){
      const n = sessionTotal, x = sessionCorrect;
      const percent = n > 0 ? Math.round((x / n) * 100) : 0;
      backEl.textContent = '';
      frontEl.innerHTML = `<div class="text-3xl font-semibold">${x} / ${n} correctas</div>`;
      // Prevent flipping on results card
      cardEl.classList.remove('flip');
      cardEl.onclick = null;
      document.getElementById('btnFlip').disabled = true;
      // Sonido y confetti de celebraciÃ³n si >= 85%
      if (percent >= 85) {
        showConfetti();
        soundCelebration();
        // Mostrar GIF adorable aleatorio
        const gifs = [
          'img/cat1.gif',
          'img/cat4.gif',
          'img/cat5.gif'
        ];
        const chosen = gifs[Math.floor(Math.random() * gifs.length)];
        showCelebrationGif(chosen);
        // Racha manejada localmente (sin backend)
      }
// FunciÃ³n actualizarRacha COMENTADA - versiÃ³n local
/*
async function actualizarRacha(percent) {
  if (!jwtToken) return;
  try {
    const res = await fetch('http://localhost:4000/api/challenge', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': jwtToken
      },
      body: JSON.stringify({ percent })
    });
    const data = await res.json();
    if (data.success) {
      streak = data.streak;
      lastChallengeAt = new Date(data.lastChallengeAt).getTime();
      updateStreakBox();
      animarStreakFire();
    } else {
      // Si ya hizo el desafÃ­o hoy, solo actualiza la UI
      if (typeof data.streak === 'number') {
        streak = data.streak;
        updateStreakBox();
      }
    }
  } catch(e){ console.error(e); }
}
*/
// AnimaciÃ³n de fuego en el box de racha
function animarStreakFire() {
  const box = document.getElementById('streakBox');
  if (!box) return;
  box.classList.add('streak-fire-anim');
  // Solo animaciÃ³n visual, sin emoji
  soundFireEffect();
  setTimeout(() => {
    box.classList.remove('streak-fire-anim');
  }, 1500);
}

// Sonido especial de fuego
function soundFireEffect() {
  // Sonido glorioso tipo coro: acorde mayor y fade
  beep(523, 0.22, 'triangle', 0.13); // C5
  beep(659, 0.22, 'triangle', 0.11); // E5
  beep(784, 0.22, 'triangle', 0.10); // G5
  setTimeout(() => beep(1046, 0.18, 'triangle', 0.09), 120); // C6
  setTimeout(() => beep(1568, 0.13, 'triangle', 0.08), 220); // G6
}

/* AnimaciÃ³n CSS para el box de racha */
const streakFireStyle = document.createElement('style');
streakFireStyle.textContent = `
  .streak-fire-anim {
    box-shadow: 0 0 32px 8px #f87171, 0 0 0 4px #f59e42;
    background: linear-gradient(90deg, #f59e42 0%, #f87171 100%);
    transition: box-shadow 0.3s, background 0.3s;
  }
`;
document.head.appendChild(streakFireStyle);

// Muestra un GIF adorable en el centro de la pantalla por 2 segundos
function showCelebrationGif(src) {
  let gif = document.getElementById('celebrationGif');
  if (!gif) {
    gif = document.createElement('img');
    gif.id = 'celebrationGif';
    gif.src = src;
    gif.style.position = 'fixed';
    // UbicaciÃ³n: centrado horizontal, cerca del borde inferior de la tarjeta
    // Calcula la posiciÃ³n del card
    const card = document.getElementById('card');
    if (card) {
      const rect = card.getBoundingClientRect();
      gif.style.left = (rect.left + rect.width/2) + 'px';
      gif.style.top = (rect.bottom) + 'px'; // 20px arriba del borde inferior de la tarjeta
      gif.style.transform = 'translate(-50%, 0)';
    } else {
      gif.style.left = '50%';
      gif.style.top = '80%';
      gif.style.transform = 'translate(-50%, 0)';
    }
    gif.style.zIndex = '99999';
  // TamaÃ±o por defecto
  let gifWidth = 270;
  // Ajuste especial para cat1, cat4 y cat5
  if (src.includes('cat1')) gifWidth = Math.round(270 * 1.3); // 30% mÃ¡s grande
  if (src.includes('cat4')) gifWidth = Math.round(270 * 0.75); // 35% mÃ¡s pequeÃ±o
  if (src.includes('cat5')) gifWidth = Math.round(270 * 0.5);  // 50% mÃ¡s pequeÃ±o
  gif.style.width = gifWidth + 'px';
    gif.style.height = 'auto';
    gif.style.opacity = '1';
    gif.style.transition = 'opacity 0.7s';
    document.body.appendChild(gif);
  } else {
    gif.src = src;
    gif.style.opacity = '1';
    gif.style.display = '';
  }
  setTimeout(() => {
    gif.style.opacity = '0';
    setTimeout(() => { if (gif) gif.style.display = 'none'; }, 700);
  }, 2000);
}
      // --- LÃ³gica para mostrar botÃ³n Nivel 2 e insignia ---
      if(currentMission==='desafioN1'){
        clearDesafioTimer();
        if(sessionTotal === 20){
          if(desafioTimeLeft>0 && percent>=90){
            showNivel2Button();
            showNivel1Badge();
          } else if(desafioTimeLeft>0 && percent < 90){
            // Mensaje de no aprobado
            let msg = document.getElementById('desafioNoAprobadoMsg');
            if(!msg){
              msg = document.createElement('div');
              msg.id = 'desafioNoAprobadoMsg';
              msg.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-amber-700 text-white px-8 py-6 rounded-2xl shadow-2xl text-2xl font-bold z-[99999] cursor-pointer';
              msg.textContent = 'No has aprobado (necesitas 90% correctas)';
              msg.onclick = () => { location.reload(); };
              document.body.appendChild(msg);
            }
            msg.style.opacity = '1';
          }
        }
      }
      // Ocultar la tabla de conocidas en modo desafÃ­o
      const knownTableSection = document.querySelector('section.mt-16');
      if(currentMission==='challenge' || currentMission==='desafioN1') {
        if(knownTableSection) knownTableSection.style.display = 'none';
      } else {
        if(knownTableSection) knownTableSection.style.display = '';
      }
  return;
}
// --- Mostrar botÃ³n Nivel 2 ---
function showNivel2Button(){
  nivel2Unlocked = true;
  saveUserState();
  // Mostrar el botÃ³n y el dropdown de Nivel 2
  const btnNivel2 = document.getElementById('btnNivel2');
  const nivel2Wrap = document.getElementById('nivel2Wrap');
  if(btnNivel2) btnNivel2.style.display = '';
  if(nivel2Wrap) nivel2Wrap.style.display = '';
  // Si el botÃ³n no existe (por recarga), crÃ©alo junto a btnNivel1 (a la derecha)
  if(!btnNivel2){
    const btnNivel1 = document.getElementById('btnNivel1');
    if(btnNivel1){
      // Mover el contenedor completo de nivel2Wrap al lado de btnNivel1
      btnNivel1.parentNode.insertBefore(nivel2Wrap, btnNivel1.nextSibling);
      nivel2Wrap.style.display = '';
    }
  }
}

// Mostrar el botÃ³n Nivel 2 si estÃ¡ desbloqueado al cargar la pÃ¡gina
window.addEventListener('DOMContentLoaded', async () => {
    // BotÃ³n cerrar sesiÃ³n al lado de "si se traba"
    const btnTraba = document.getElementById('btnTraba');
    if(btnTraba && !document.getElementById('btnLogout')) {
      const btnLogout = document.createElement('button');
      btnLogout.id = 'btnLogout';
      btnLogout.textContent = 'Cerrar sesiÃ³n';
      btnLogout.className = 'ml-2 px-4 py-2 rounded-xl bg-red-700 hover:bg-red-600 text-white font-bold';
      btnLogout.onclick = () => {
        localStorage.removeItem('jwtToken');
        location.reload();
      };
      btnTraba.parentNode.insertBefore(btnLogout, btnTraba.nextSibling);
    }
  await loadAll();
  if(nivel2Unlocked) {
    showNivel2Button();
  }
});
// --- Mostrar insignia de Nivel 1 aprobado ---
function showNivel1Badge(){
  // Eliminado: insignia estrella
}
    // Frente: siempre hanzi, con botÃ³n de parlante si no es desafÃ­o
    frontEl.innerHTML = '';
    // Contenedor relativo para posicionar el parlante
    const frontWrap = document.createElement('div');
    frontWrap.style.position = 'relative';
    frontWrap.style.width = '100%';
    frontWrap.style.height = '100%';
    // Hanzi centrado
    const hanziSpan = document.createElement('span');
    hanziSpan.textContent = currentCard.hanzi;
    hanziSpan.style.display = 'inline-block';
    hanziSpan.style.position = 'absolute';
    hanziSpan.style.top = '50%';
    hanziSpan.style.left = '50%';
    hanziSpan.style.transform = 'translate(-50%, -50%)';
    frontWrap.appendChild(hanziSpan);
    // BotÃ³n parlante (solo si no es desafÃ­o)
    if(currentMission !== 'challenge') {
      const speakBtn = document.createElement('button');
      speakBtn.title = 'Escuchar pronunciaciÃ³n';
      speakBtn.style.position = 'absolute';
      speakBtn.style.top = '10px';
      speakBtn.style.right = '10px';
      speakBtn.style.background = 'rgba(30,41,59,0.85)';
      speakBtn.style.border = 'none';
      speakBtn.style.cursor = 'pointer';
      speakBtn.style.borderRadius = '50%';
      speakBtn.style.padding = '4px';
      speakBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.10)';
      speakBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5L6 9H2v6h4l5 4V5zm7.07 2.93a10 10 0 010 14.14m2.83-2.83a6 6 0 000-8.48"/></svg>';
      speakBtn.onclick = (e) => {
        e.stopPropagation();
        speakHanzi(currentCard.hanzi);
      };
      frontWrap.appendChild(speakBtn);
    }
    frontEl.appendChild(frontWrap);

    // Enable flipping for normal cards

    cardEl.onclick = () => {
      if(currentCard && mode==='flash'){
        flipped = !flipped;
        flipped ? cardEl.classList.add('flip') : cardEl.classList.remove('flip');
      }
    };
    document.getElementById('btnFlip').disabled = false;
// Pronuncia el Hanzi usando SpeechSynthesis, priorizando voz femenina y calidad
function speakHanzi(text) {
  if (!window.speechSynthesis) return;
  const voices = window.speechSynthesis.getVoices();
  // Buscar voz en chino, priorizando femenina y calidad
  let zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.gender === 'female');
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.name && /female|woman|å¥³/i.test(v.name));
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh') && v.voiceURI && /female|woman|å¥³/i.test(v.voiceURI));
  if (!zhVoice) zhVoice = voices.find(v => v.lang && v.lang.startsWith('zh'));
  const utter = new window.SpeechSynthesisUtterance(text);
  if (zhVoice) utter.voice = zhVoice;
  utter.lang = zhVoice ? zhVoice.lang : 'zh-CN';
  utter.rate = 0.97;
  utter.pitch = 1.15;
  utter.volume = 1;
  window.speechSynthesis.speak(utter);
}

    if(mode === 'flash'){
          
          
          

          
          
           backEl.innerHTML = `<div class="mb-2">${currentCard.pinyin}</div><div>${currentCard.meaning}</div>`;
      flashRow.classList.remove('hidden');
      quizRow.classList.add('hidden');
    } else {
      backEl.textContent = '';
      flashRow.classList.add('hidden');
      quizRow.classList.remove('hidden');
      setupQuizChoices();
    }
  }

  // Confetti effect for celebration - versiÃ³n solo verde
  function showConfetti() {
    let confettiCanvas = document.getElementById('confettiCanvas');
    if (!confettiCanvas) {
      confettiCanvas = document.createElement('canvas');
      confettiCanvas.id = 'confettiCanvas';
      confettiCanvas.style.position = 'fixed';
      confettiCanvas.style.left = '0';
      confettiCanvas.style.top = '0';
      confettiCanvas.style.width = '100vw';
      confettiCanvas.style.height = '100vh';
      confettiCanvas.style.pointerEvents = 'none'; // Asegura que nunca bloquee clics
      confettiCanvas.style.zIndex = '9999';
      document.body.appendChild(confettiCanvas);
    }
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
    confettiCanvas.style.pointerEvents = 'none'; // Refuerza pointer-events

    const ctx = confettiCanvas.getContext('2d');
    const colors = ['#22c55e','#16a34a','#10b981','#34d399','#86efac','#166534'];
    const pieces = 140;
    const confetti = [];

    // Get card position for explosion origin
    const cardRect = cardEl.getBoundingClientRect();
    const originX = cardRect.left + cardRect.width/2;
    const originY = cardRect.bottom - 10; // just below the card

    for (let i = 0; i < pieces; i++) {
      const angle = Math.PI/2 + (Math.random()-0.5)*Math.PI/1.2; // mostly upward
      const speed = Math.random()*7+6;
      confetti.push({
        x: originX,
        y: originY,
        r: Math.random() * 8 + 4,
        c: colors[Math.floor(Math.random() * colors.length)],
        vx: Math.cos(angle)*speed,
        vy: -Math.abs(Math.sin(angle)*speed*1.5), // 50% mÃ¡s alto
        alpha: 1,
        gravity: 0.25 + Math.random()*0.15,
        fade: 0.012 + Math.random()*0.008
      });
    }

    let frames = 0;
    function draw() {
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      for (const p of confetti) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
        ctx.fillStyle = p.c;
        ctx.globalAlpha = p.alpha;
        ctx.fill();
        ctx.restore();

        // Movimiento: primero suben, luego caen y se desvanecen
        p.x += p.vx;
        p.y += p.vy;
        p.vy += p.gravity;
        if (frames > 30) p.alpha -= p.fade; // fade out after some frames
        if (p.alpha < 0) p.alpha = 0;
      }
      frames++;
      if (frames < 90) {
        requestAnimationFrame(draw);
      } else {
        // Eliminar canvas y asegurar pointer-events none
        confettiCanvas.style.pointerEvents = 'none';
        if (confettiCanvas.parentNode) confettiCanvas.parentNode.removeChild(confettiCanvas);
      }
    }
    draw();
}


  /* ========= QUIZ ========= */
  function setupQuizChoices(){
    // Asegurar 4 botones
    if(quizRow.children.length !== 4){
      quizRow.innerHTML = '';
      for(let i=0;i<4;i++){
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
        quizRow.appendChild(btn);
      }
    }
    const quizBtns = Array.from(quizRow.children);

    // Generar opciones desde el pool actual de la misiÃ³n (o todas si vacÃ­o)
    const pool = buildQueue(currentMission);
    const source = pool.length ? pool : cards;

    const field   = (mode==='quizPinyin') ? 'pinyin' : 'meaning';
    const correct = currentCard[field];

    const values = new Set([correct]);
    const distractors = [];
    const candidates = shuffle(source.filter(c => c.id !== currentCard.id));
    for(const c of candidates){
      const v = c[field];
      if(!values.has(v)){ values.add(v); distractors.push(v); }
      if(distractors.length===3) break;
    }
    while(distractors.length<3){ distractors.push('â€”'); } // fallback

    const options = shuffle([correct, ...distractors]);

    function setDisabledAll(flag){ quizBtns.forEach(b=>b.disabled=flag); }

    quizBtns.forEach((btn, idx) => {
      btn.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade');
      btn.textContent = options[idx];
      btn.onclick = () => {
        const isCorrect = options[idx] === correct;
        setDisabledAll(true);
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          quizBtns.forEach((b, i) => {
            if(options[i] === correct) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            quizBtns.forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
          }, 1000);
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            answer(false);
          }, 2000);
        }
      };
    });
  }
  // --- Quiz Hanzi ---
const btnQuizMeaning = document.getElementById('btnQuizMeaning');
if(btnQuizMeaning) {
  let btnQuizHanzi = document.getElementById('btnQuizHanzi');
  if(!btnQuizHanzi) {
    btnQuizHanzi = document.createElement('button');
    btnQuizHanzi.id = 'btnQuizHanzi';
    btnQuizHanzi.className = 'px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-500 ml-2';
    btnQuizHanzi.textContent = 'Quiz Hanzi';
    btnQuizMeaning.parentNode.insertBefore(btnQuizHanzi, btnQuizMeaning.nextSibling);
  }
  btnQuizHanzi.onclick = () => setMode('quizHanzi');
}

// --- LÃ³gica para modo quizHanzi ---
const oldSetupQuizChoices = window.setupQuizChoices;
window.setupQuizChoices = function() {
  if(mode === 'quizHanzi' && currentCard) {
    // Mostrar pinyin o significado aleatorio en la tarjeta
    const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
    frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
    backEl.innerHTML = '';

    // Opciones: 1 correcta + 3 aleatorias
    let hanziOptions = [currentCard.hanzi];
    let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
    while(hanziOptions.length < 4 && pool.length > 0) {
      const idx = Math.floor(Math.random() * pool.length);
      hanziOptions.push(pool[idx].hanzi);
      pool.splice(idx,1);
    }
    hanziOptions = shuffle(hanziOptions);

    quizRow.innerHTML = '';
    // Helper para deshabilitar todos los botones hanzi
    function setDisabledAll(flag) {
      Array.from(quizRow.children).forEach(b => b.disabled = flag);
    }
    hanziOptions.forEach(hz => {
      const btn = document.createElement('button');
      btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
      btn.textContent = hz;
      btn.disabled = false;
      btn.onclick = function() {
        setDisabledAll(true);
        const isCorrect = hz === currentCard.hanzi;
        if(isCorrect){
          btn.classList.add('optCorrect');
          respond(true);
          setTimeout(()=>setDisabledAll(false), 450);
        } else {
          btn.classList.add('optWrong');
          // Marcar la opciÃ³n correcta
          Array.from(quizRow.children).forEach((b, i) => {
            if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
          });
          cardEl.classList.add('cardWrong','shakeAnim');
          soundWrong();
          pulseBox(btnRevise1Box, 'pulseAmber');
          pulseBox(btnRevise2Box, 'pulseTeal');
          if(currentCard) ensureReviseFlags(currentCard);
          setTimeout(()=>{
            cardEl.classList.add('cardWrongFade');
            Array.from(quizRow.children).forEach(b=>{
              if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
              if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
            });
          }, 1000);
          setTimeout(()=>{
            cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
            Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
            setDisabledAll(false);
            answer(false);
          }, 2000);
        }
      };
      quizRow.appendChild(btn);
    });
    quizRow.classList.remove('hidden');
    flashRow.classList.add('hidden');
    return;
  } else {
    // Restaurar fuente original para quizRow y sus hijos
    quizRow.classList.remove('text-3xl','font-bold');
    Array.from(quizRow.children).forEach(btn => {
      btn.classList.remove('text-3xl','font-bold');
    });
    // Restaurar tarjeta frontal
    if(currentCard && (mode === 'quizPinyin' || mode === 'quizMeaning')) {
      frontEl.innerHTML = `<span class='text-5xl font-bold'>${currentCard.hanzi}</span>`;
    }
  }
  if(typeof oldSetupQuizChoices === 'function') oldSetupQuizChoices();
}

// --- DesafÃ­os ---
function setupChallengeCard() {
  if(currentMission === 'challenge' || currentMission === 'desafioN1') {
    // Elegir aleatoriamente el tipo de pregunta
    // 50%: muestra hanzi y opciones pinyin/meaning
    // 50%: muestra pinyin o meaning y opciones hanzi (quiz hanzi style)
    const hanziQuiz = Math.random() < 0.5;
    if(hanziQuiz) {
      // Quiz hanzi: muestra pinyin o significado, opciones hanzi
      const showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
      backEl.innerHTML = '';
      // Opciones hanzi
      let hanziOptions = [currentCard.hanzi];
      let pool = cards.filter(c => c.hanzi !== currentCard.hanzi);
      while(hanziOptions.length < 4 && pool.length > 0) {
        const idx = Math.floor(Math.random() * pool.length);
        hanziOptions.push(pool[idx].hanzi);
        pool.splice(idx,1);
      }
      hanziOptions = shuffle(hanziOptions);
      quizRow.innerHTML = '';
      hanziOptions.forEach(hz => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = hz;
        btn.disabled = false;
        btn.onclick = function() {
          Array.from(quizRow.children).forEach(b => b.disabled = true);
          const isCorrect = hz === currentCard.hanzi;
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            Array.from(quizRow.children).forEach((b, i) => {
              if(hanziOptions[i] === currentCard.hanzi) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              Array.from(quizRow.children).forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              Array.from(quizRow.children).forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              Array.from(quizRow.children).forEach(b=>b.disabled=false);
              answer(false);
            }, 2000);
          }
        };
        quizRow.appendChild(btn);
      });
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    } else {
      // Modo clÃ¡sico: muestra hanzi y opciones pinyin/meaning
      const types = ['pinyin','meaning'];
      const optionsType = types[Math.floor(Math.random()*types.length)];
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard.hanzi}</div>`;
      backEl.innerHTML = '';
      let correct = currentCard[optionsType];
      let options = [correct];
      let pool = cards.filter(c => c[optionsType] !== correct);
      while(options.length < 4 && pool.length > 0) {
        const idx = Math.floor(Math.random() * pool.length);
        options.push(pool[idx][optionsType]);
        pool.splice(idx,1);
      }
      options = shuffle(options);
      quizRow.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 mx-1';
        btn.textContent = opt;
        quizRow.appendChild(btn);
      });
      const challengeBtns = Array.from(quizRow.children);
      function setDisabledAll(flag){ challengeBtns.forEach(b=>b.disabled=flag); }
      challengeBtns.forEach((btn, idx) => {
        btn.onclick = () => {
          const isCorrect = btn.textContent === currentCard[optionsType];
          setDisabledAll(true);
          if(isCorrect){
            btn.classList.add('optCorrect');
            respond(true);
            setTimeout(()=>setDisabledAll(false), 450);
          } else {
            btn.classList.add('optWrong');
            challengeBtns.forEach((b, i) => {
              if(b.textContent === currentCard[optionsType]) b.classList.add('optCorrect');
            });
            cardEl.classList.add('cardWrong','shakeAnim');
            soundWrong();
            pulseBox(btnRevise1Box, 'pulseAmber');
            pulseBox(btnRevise2Box, 'pulseTeal');
            if(currentCard) ensureReviseFlags(currentCard);
            setTimeout(()=>{
              cardEl.classList.add('cardWrongFade');
              challengeBtns.forEach(b=>{
                if(b.classList.contains('optCorrect')) b.classList.add('optCorrectFade');
                if(b.classList.contains('optWrong')) b.classList.add('optWrongFade');
              });
            }, 1000);
            setTimeout(()=>{
              cardEl.classList.remove('cardWrong','cardWrongFade','shakeAnim');
              challengeBtns.forEach(b=>b.classList.remove('optCorrect','optWrong','optCorrectFade','optWrongFade'));
              // Avanzar a la siguiente tarjeta
              nextCard();
            }, 2000);
          }
        };
      });
      quizRow.classList.remove('hidden');
      flashRow.classList.add('hidden');
      return true;
    }
  }
  return false;
}
  /* ========= Modo/UI ========= */
  function setMode(newMode){
    // En DesafÃ­o, no permitimos modo Flash
    if(currentMission==='challenge' && newMode==='flash'){
      mode = 'quizMeaning';
    } else {
      mode = newMode;
    }
    if(mode!=='flash'){ flipped=false; cardEl.classList.remove('flip'); }
    if(currentCard) renderCard();
    updateStats();
  }

  // --- LÃ³gica de racha diaria por dÃ­a GMT-6 ---
  function getLocalDate(ts) {
    const date = new Date(ts);
    date.setHours(date.getHours() - 6);
    return date.toISOString().slice(0, 10);
  }
  function getRachaStatus(lastChallengeAt) {
    const now = Date.now();
    const today = getLocalDate(now);
    const lastDay = getLocalDate(lastChallengeAt);
    if (today === lastDay) {
      // Ya hizo el desafÃ­o hoy
      // Calcula horas hasta el prÃ³ximo dÃ­a
      const nextDay = new Date(now);
      nextDay.setUTCHours(6,0,0,0); // 00:00 GMT-6 del prÃ³ximo dÃ­a
      if (now >= nextDay.getTime()) nextDay.setDate(nextDay.getDate() + 1);
      const horasRestantes = Math.ceil((nextDay.getTime() - now) / 3600000);
      return { status: 'yaHizo', horasRestantes };
    } else {
      // No hizo el desafÃ­o hoy
      // Calcula horas hasta fin del dÃ­a
      const endDay = new Date(now);
      endDay.setUTCHours(29,59,59,999); // 23:59 GMT-6 (29 = 23+6)
      const horasRestantes = Math.ceil((endDay.getTime() - now) / 3600000);
      return { status: 'puedeHacer', horasRestantes };
    }
  }
  function updateStreakBox() {
    if (!streakBox || !streakCount || !streakStatus) return;
    streakCount.textContent = streak || 0;
    // Tomar el Ãºltimo desafÃ­o exitoso
    const lastTs = lastChallengeAt || 0;
    const racha = getRachaStatus(lastTs);
    let horas = racha.horasRestantes;
    streakStatus.style.color = '#fff';
    if (racha.status === 'yaHizo') {
      streakStatus.textContent = `Faltan ${horas} hs para poder sumar racha.`;
    } else {
      streakStatus.textContent = `Tienes ${horas} hs para no perder la racha.`;
    }
    // Si quedan menos de 5 horas, fondo naranja de aviso
    if (racha.status === 'puedeHacer' && horas <= 5) {
      streakBox.style.background = '#f54242'; // naranja
      streakStatus.style.color = '#fff';
    } else {
      streakBox.style.background = '';
    }
  }
  // Mostrar mensaje al tocar el box
  if (streakBox) {
    streakBox.onclick = function() {
      // Mostrar imagen "fuerte.png" centrada en pantalla
      let overlay = document.getElementById('rachaFuerteOverlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'rachaFuerteOverlay';
          overlay.className = 'fade-overlay';
          overlay.style.position = 'fixed';
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.background = 'rgba(0,0,0,0.7)';
          overlay.style.zIndex = '99999';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.cursor = 'pointer';
          overlay.style.opacity = '0';
          overlay.style.transition = 'opacity 0.5s';
          // Imagen centrada
          const img = document.createElement('img');
          img.src = 'img/fuerte.png';
          img.alt = 'Fuerte';
          img.style.maxWidth = '80vw';
          img.style.maxHeight = '80vh';
          img.style.borderRadius = '24px';
          img.style.boxShadow = '0 0 32px #0008';
          overlay.appendChild(img);
          document.body.appendChild(overlay);
          // Fade in
          setTimeout(() => { overlay.style.opacity = '1'; }, 10);
          // Cerrar al hacer click en cualquier parte con fade out
          overlay.onclick = function() {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.remove(); }, 500);
          };
        }
    };
  }

  function updateStats(){
    statInSession.textContent = sessionQueue.length + (currentCard ? 1 : 0);
    statToday.textContent = todayReviewed;
    statMission.textContent = (
      currentMission==='unit2' ? 'Unidad 2' :
      currentMission==='unit3' ? 'Unidad 3' :
      currentMission==='unit4' ? 'Unidad 4' :
      currentMission==='unit5' ? 'Unidad 5' :
      currentMission==='unit6' ? 'Unidad 6' :
      currentMission==='unit7' ? 'Unidad 7' :
      currentMission==='unit8' ? 'Unidad 8' :
      currentMission==='unit9' ? 'Unidad 9' :
      currentMission==='unit2N2' ? 'Unidad 1 (N2)' :
      currentMission==='unit3N2' ? 'Unidad 2 (N2)' :
      currentMission==='unit4N2' ? 'Unidad 3 (N2)' :
      currentMission==='unit5N2' ? 'Unidad 4 (N2)' :
      currentMission==='unit6N2' ? 'Unidad 5 (N2)' :
      currentMission==='unit7N2' ? 'Unidad 6 (N2)' :
      currentMission==='unit8N2' ? 'Unidad 7 (N2)' :
      currentMission==='unit9N2' ? 'Unidad 8 (N2)' :
      currentMission==='unit10N2'? 'Unidad 9 (N2)' :
      currentMission==='todoN2' ? 'Todo N2' :
      currentMission==='known' ? 'Conocidas' :
      currentMission==='revise1' ? 'A repasar' :
      currentMission==='revise2' ? 'Para confirmar' :
      currentMission==='challenge' ? 'DesafÃ­o' : 'â€”'
    );
    // Cambiar color de statBox segÃºn el modo actual
    const modeToBtn = {
      'unit2': 'btnUnit2',
      'unit3': 'btnUnit3',
      'unit4': 'btnUnit4',
      'unit5': 'btnUnit5',
      'unit6': 'btnUnit6',
      'unit7': 'btnUnit7',
      'unit8': 'btnUnit8',
      'unit9': 'btnUnit9',
      'unit2N2': 'btnUnit2N2',
      'unit3N2': 'btnUnit3N2',
      'unit4N2': 'btnUnit4N2',
      'unit5N2': 'btnUnit5N2',
      'unit6N2': 'btnUnit6N2',
      'unit7N2': 'btnUnit7N2',
      'unit8N2': 'btnUnit8N2',
      'unit9N2': 'btnUnit9N2',
      'unit10N2': 'btnUnit10N2',
      'todoN2': 'btnTodoN2',
      'known': 'btnKnown',
      'revise1': 'btnRevise1',
      'revise2': 'btnRevise2',
      'challenge': 'btnChallenge'
    };
    let btnId = modeToBtn[currentMission];
    let btn = btnId ? document.getElementById(btnId) : null;
    if(btn) {
      statBox.style.background = window.getComputedStyle(btn).backgroundColor;
      statBox.style.color = window.getComputedStyle(btn).color;
      statBox.style.borderColor = window.getComputedStyle(btn).borderColor || 'transparent';
    } else {
      statBox.style.background = '';
      statBox.style.color = '';
      statBox.style.borderColor = '';
    }
    // contadores
    const countKnown = cards.filter(c=>c.known).length;
    const countRev1  = cards.filter(c=>c.revise1).length;
    const countRev2  = cards.filter(c=>c.revise2).length;
    const elKnown = document.getElementById('countKnown'); if(elKnown) elKnown.textContent = countKnown;
    const elR1    = document.getElementById('countRev1');  if(elR1)   elR1.textContent   = countRev1 === 0 ? 'âœ”ï¸' : countRev1;
    const elR2    = document.getElementById('countRev2');  if(elR2)   elR2.textContent   = countRev2 === 0 ? 'âœ”ï¸' : countRev2;

  updateStreakBox();
  }

  /* ========= Tabla Conocidas ========= */
  let overlayField = 'hanzi'; // 'hanzi' | 'pinyin' | 'meaning'
let knownGridColCount = null; // nÃºmero de columnas fijo para la tabla de conocidas
let knownCatFilter = 'ALL'; // 'ALL'|'S'|'A'|'V'|'P'|'E'

// Estado previo de conocidas para animaciones
let prevKnownState = [];
  // Overlay removed: no-op

  // InterpolaciÃ³n azul -> naranja para la racha
  const COLOR_A = { r: 59, g: 130, b: 246 };   // #3B82F6
  const COLOR_B = { r: 255, g: 134, b: 35  };  // #FF8623
  function lerp(a,b,t){ return a + (b-a)*t; }
  function mixColor(t){
    const r = Math.round(lerp(COLOR_A.r, COLOR_B.r, t));
    const g = Math.round(lerp(COLOR_A.g, COLOR_B.g, t));
    const b = Math.round(lerp(COLOR_A.b, COLOR_B.b, t));
    return `rgb(${r}, ${g}, ${b})`;
  }

  // Ajuste de texto para celdas (binaria para que quepa en ancho/alto)
  function fitCellText(el, minPx=10, maxPx=64){
    const parent = el.parentElement;
    if(!parent) return;
    const pad = 18; // margen de seguridad
    let low = minPx, high = maxPx, best = minPx;
    while(low <= high){
      const mid = Math.floor((low + high)/2);
      el.style.fontSize = mid + 'px';
      // Medimos (fudges con padding)
      const OK = (el.scrollWidth <= parent.clientWidth - pad) && (el.scrollHeight <= parent.clientHeight - pad);
      if(OK){ best = mid; low = mid + 1; } else { high = mid - 1; }
    }
    el.style.fontSize = best + 'px';
  }

  function sizeClassForHanzi(len){
    return len >= 4 ? 'font-bold' : 'font-bold';
  }

  // Render con animaciones de level up y perdidos
  function renderKnownGridWithAnimations(levelUpIds, lostChars) {
    let known = cards.filter(c=>c.known);
    if(knownCatFilter !== 'ALL') {
      known = known.filter(c => (c.cat||'E').toUpperCase() === knownCatFilter);
    }
    knownCount.textContent = `${known.length} palabras`;

    // Fijar nÃºmero de columnas solo la primera vez (al abrir o actualizar la tabla con filtro 'ALL')
    if (knownGridColCount === null || knownCatFilter === 'ALL') {
      const total = cards.filter(c=>c.known).length;
      knownGridColCount = Math.max(4, Math.min(8, Math.ceil(total/2)));
    }
    knownGrid.style.gridTemplateColumns = `repeat(${knownGridColCount}, minmax(80px, 1fr))`;

    // ordenar por challengeStreak desc
    known.sort((a,b)=> (b.challengeStreak||0) - (a.challengeStreak||0));
    const maxStreak = Math.max(0, ...known.map(c => c.challengeStreak||0));

    // --- Renderizar perdidos arriba ---
    knownGrid.innerHTML = '';
    const lostRow = document.createElement('div');
    lostRow.style.display = 'contents';
    lostRow.id = 'lostRow';
    lostChars.forEach(c => {
      const cell = document.createElement('div');
      cell.className = `squareCell rounded-xl bg-rose-800/80 ring-2 ring-rose-400/60 px-2 lost-cell`;
      cell.style.position = 'relative';
      cell.style.opacity = '1';
      cell.style.transition = 'opacity 0.7s cubic-bezier(.4,0,.2,1), transform 0.7s cubic-bezier(.4,0,.2,1)';
      cell.style.transform = 'translateY(0)';
      // contenido principal
      const content = document.createElement('div');
      content.textContent = c.hanzi;
      content.className = 'leading-tight font-bold';
      cell.appendChild(content);
      // badge de racha
      const badge = document.createElement('div');
      badge.className = 'streak-badge';
      badge.style.background = '#dc2626';
      badge.textContent = c.streak;
      cell.appendChild(badge);
      // badge de categorÃ­a
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.textContent = cat;
      catBadge.style.position = 'absolute';
      catBadge.style.left = '7px';
      catBadge.style.bottom = '7px';
      catBadge.style.fontWeight = 'bold';
      catBadge.style.fontSize = '0.77em';
      catBadge.style.color = '#fff';
      catBadge.style.background = 'transparent';
      catBadge.style.pointerEvents = 'none';
      cell.appendChild(catBadge); 
      lostRow.appendChild(cell);
      requestAnimationFrame(()=> fitCellText(content, 10, 64));
    });
    knownGrid.appendChild(lostRow);

    // --- Renderizar conocidos normales ---
    known.forEach(c => {
      const value = overlayField==='hanzi' ? c.hanzi : overlayField==='pinyin' ? c.pinyin : c.meaning;
  const cell = document.createElement('div');
  cell.className = `squareCell rounded-xl bg-slate-800/70 ring-1 ring-white/10 px-2`;
  cell.style.position = 'relative';
  cell.style.pointerEvents = 'auto';
  cell.style.zIndex = '1';
      // contenido principal
      const content = document.createElement('div');
      content.textContent = value;
      content.className = overlayField==='hanzi'
        ? 'leading-tight ' + sizeClassForHanzi((value||'').length)
        : 'leading-tight';
      cell.appendChild(content);
      // badge de racha
      const st = c.challengeStreak || 0;
      const t = maxStreak ? st / maxStreak : 0;
      const badge = document.createElement('div');
      badge.className = 'streak-badge';
      badge.style.background = mixColor(t);
      badge.textContent = st;
      // AnimaciÃ³n de level up
      if(levelUpIds && levelUpIds.includes(c.id)) {
        badge.classList.add('levelup-anim');
        // NÃºmero subiendo animado
        let prev = 0;
        if(window.prevKnownState) {
          const prevC = window.prevKnownState.find(x=>x.id===c.id);
          if(prevC) prev = prevC.streak;
        }
        if(prev < st) {
          let n = prev;
          const anim = setInterval(()=>{
            n++;
            badge.textContent = n;
            if(n>=st) clearInterval(anim);
          }, 120);
        }
      }
      cell.appendChild(badge);
      // badge de categorÃ­a
      const cat = (c.cat||'E').toUpperCase();
      const catBadge = document.createElement('div');
      catBadge.textContent = cat;
      catBadge.style.position = 'absolute';
      catBadge.style.left = '7px';
      catBadge.style.bottom = '7px';
      catBadge.style.fontWeight = 'bold';
      catBadge.style.fontSize = '0.77em';
      catBadge.style.color = '#fff';
      catBadge.style.background = 'transparent';
      catBadge.style.pointerEvents = 'none';
      cell.appendChild(catBadge);
      knownGrid.appendChild(cell);
      requestAnimationFrame(()=> fitCellText(content, 10, 64));
    });

    // --- Animar salida de perdidos, luego level up, luego reacomodar ---
    if(lostChars.length) {
      setTimeout(()=>{
        // Sonido de salida de perdidos
        soundLostKnowns();
        lostRow.childNodes.forEach(cell=>{
          cell.style.opacity = '0';
          cell.style.transform = 'translateY(-40px)';
        });
        setTimeout(()=>{
          lostRow.remove();
          // Animar level up despuÃ©s de perdidos
          animateLevelUps(levelUpIds, ()=>{
            // Al terminar animaciÃ³n, re-renderizar la tabla normal
            setTimeout(()=>renderKnownGrid(), 100);
          });
        }, 700);
      }, 1200);
    } else {
      // Si no hay perdidos, animar level up inmediatamente y luego reacomodar
      setTimeout(()=>animateLevelUps(levelUpIds, ()=>{
        setTimeout(()=>renderKnownGrid(), 100);
      }), 400);
    }

    // --- AnimaciÃ³n visual llamativa para level up (brillo verde en celda entera) ---
    function animateLevelUps(levelUpIds, onDone) {
      if(!levelUpIds || !levelUpIds.length) { if(onDone) onDone(); return; }
      const cells = knownGrid.querySelectorAll('.squareCell');
  const animDuration = 3900;
      let anyLevelUp = false;
      cells.forEach(cell => {
        const badge = cell.querySelector('.streak-badge');
        if(!badge) return;
        const hanzi = cell.querySelector('div').textContent;
        const c = cards.find(x => x.hanzi === hanzi && x.known);
        if(c && levelUpIds.includes(c.id)) {
          anyLevelUp = true;
          // --- POP de la celda ---
          cell.animate([
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: cell.style.background || '' },
            { transform: 'scale(1.13)', boxShadow: '0 0 40px 16px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1.05)', boxShadow: '0 0 24px 8px #22c55e', background: '#22c55e33' },
            { transform: 'scale(1)', boxShadow: '0 0 0 0 #22c55e', background: '#22c55e33' }
          ], {
            duration: animDuration*0.6,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          // --- Badge de racha crece y vuelve ---
          // Cambiar badge a amarillo con glow durante la animaciÃ³n
          const originalBg = badge.style.background;
          const originalBoxShadow = badge.style.boxShadow;
          badge.style.background = '#fbbf24';
          badge.style.boxShadow = '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24';
          badge.animate([
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1.35)', filter: 'brightness(1.7)', boxShadow: '0 0 40px 16px #fde68a, 0 0 0 4px #fbbf24', background: '#fbbf24' },
            { transform: 'scale(1)', filter: 'brightness(1.1)', boxShadow: '0 0 24px 8px #fde68a, 0 0 0 2px #fbbf24', background: '#fbbf24' }
          ], {
            duration: animDuration*0.4,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          setTimeout(()=>{
            badge.style.background = originalBg || '#3B82F6';
            badge.style.boxShadow = originalBoxShadow || '0 0 10px rgba(0,0,0,.25)';
          }, animDuration*0.8);
          // --- Level up icon (^^) sobre el badge ---
          let lvlIcon = badge.parentElement.querySelector('.levelup-icon');
          if(!lvlIcon) {
            lvlIcon = document.createElement('div');
            lvlIcon.className = 'levelup-icon';
            lvlIcon.innerHTML = '<span style="font-size:20px;font-weight:bold;color:#fbbf24;text-shadow:0 0 8px #fde68a,0 2px 2px #0007;">^^</span>';
            lvlIcon.style.position = 'absolute';
            lvlIcon.style.right = '10px';
            lvlIcon.style.bottom = '38px';
            lvlIcon.style.pointerEvents = 'none';
            lvlIcon.style.opacity = '0';
            badge.parentElement.appendChild(lvlIcon);
          }
          // Dura el doble de tiempo visible
          const lvlIconDuration = animDuration;
          lvlIcon.animate([
            { opacity: 0, transform: 'translateY(10px) scale(0.7)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.15)' },
            { opacity: 1, transform: 'translateY(-2px) scale(1.1)' },
            { opacity: 0, transform: 'translateY(-10px) scale(0.7)' }
          ], {
            duration: lvlIconDuration,
            easing: 'cubic-bezier(.4,2,.6,1)'
          });
          lvlIcon.style.opacity = '1';
          setTimeout(() => { lvlIcon.style.opacity = '0'; }, lvlIconDuration);
          // --- Fondo verde que desvanece ---
          cell.style.transition = `background 1.1s`;
          cell.style.background = '#22c55e33';
          setTimeout(()=>{
            cell.style.background = 'rgba(34,197,94,0)';
          }, animDuration*0.6);
          setTimeout(()=>{
            cell.style.background = '';
          }, animDuration+1100);
        }
      });
      // Sonido de gloria si hubo level up
      if(anyLevelUp) soundGlory();
      // Llamar onDone despuÃ©s de la animaciÃ³n + 1s de espera
  setTimeout(()=>{ if(onDone) setTimeout(onDone, 1000); }, animDuration);
    }

    // Sonido para salida de perdidos
    function soundLostKnowns() {
      // Sonido digital descendente, tipo "whoosh triste"
      beep(220,0.18,'triangle',0.11);
      setTimeout(()=>beep(130,0.16,'triangle',0.09),90);
      setTimeout(()=>beep(80,0.13,'sine',0.07),180);
    }
    // Sonido de gloria para level up
    function soundGlory() {
      // Acorde mayor brillante
      beep(523,0.22,'triangle',0.13); // C5
      beep(659,0.22,'triangle',0.11); // E5
      beep(784,0.22,'triangle',0.10); // G5
      setTimeout(() => beep(1046, 0.18, 'triangle', 0.10), 180); // C6
      setTimeout(() => beep(1318, 0.13, 'triangle', 0.08), 320); // E6
    }
  }

  /* ========= Controles ========= */
  document.getElementById('btnUnit2').onclick = () => startMission('unit2');
  document.getElementById('btnUnit3').onclick = () => startMission('unit3');
  document.getElementById('btnUnit4').onclick = () => startMission('unit4');
  document.getElementById('btnUnit5').onclick = () => startMission('unit5');
  document.getElementById('btnUnit6').onclick = () => startMission('unit6');
  document.getElementById('btnUnit7').onclick = () => startMission('unit7');
  document.getElementById('btnUnit8').onclick = () => startMission('unit8');
  document.getElementById('btnUnit9').onclick = () => startMission('unit9');

  document.getElementById('btnKnown').onclick   = () => startMission('known');
  // Filtros de categorÃ­a para la tabla de conocidos
  document.getElementById('btnCatAll').onclick = () => { knownCatFilter = 'ALL'; knownGridColCount = null; showKnownTableWithAnimations(); };
  document.getElementById('btnCatS').onclick   = () => { knownCatFilter = 'S'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatA').onclick   = () => { knownCatFilter = 'A'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatV').onclick   = () => { knownCatFilter = 'V'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatP').onclick   = () => { knownCatFilter = 'P'; showKnownTableWithAnimations(); };
  document.getElementById('btnCatE').onclick   = () => { knownCatFilter = 'E'; showKnownTableWithAnimations(); };
  document.getElementById('btnRevise1').onclick = () => startMission('revise1');
  document.getElementById('btnRevise2').onclick = () => startMission('revise2');

  document.getElementById('btnChallenge').onclick   = () => startMission('challenge');
  document.getElementById('btnQuizPinyin').onclick  = () => setMode('quizPinyin');
  document.getElementById('btnQuizMeaning').onclick = () => setMode('quizMeaning');

  document.getElementById('btnKnownTable').onclick = () => {
    if (currentMission === 'challenge') {
      showChallengeWarning();
      // Salir de desafÃ­o y mostrar conocidas
      startMission('known');
      setTimeout(() => {
        overlayField = 'hanzi';
        showKnownTableWithAnimations();
        window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
      }, 120);
    } else {
      overlayField = 'hanzi';
      showKnownTableWithAnimations();
      window.scrollTo({ top: document.getElementById('knownGrid').offsetTop - 60, behavior: 'smooth' });
    }
  };

  // FunciÃ³n para detectar level up y perdidos y disparar animaciones
  function showKnownTableWithAnimations() {
    // Estado actual
    const currentKnown = cards.filter(c => c.known).map(c => ({ hanzi: c.hanzi, streak: c.challengeStreak, id: c.id, pinyin: c.pinyin, meaning: c.meaning, cat: c.cat }));
    // Detectar level up
    const prevMap = Object.fromEntries(prevKnownState.map(c => [c.id, c]));
    const levelUpIds = [];
    for (const c of currentKnown) {
      if (prevMap[c.id] && c.streak > prevMap[c.id].streak) {
        levelUpIds.push(c.id);
      }
    }
    // Detectar perdidos
    const currentIds = new Set(currentKnown.map(c => c.id));
    const lostChars = prevKnownState.filter(c => !currentIds.has(c.id));
    // Guardar para animaciones siguientes
    window._levelUpIds = levelUpIds;
    window._lostChars = lostChars;
    // Renderizar tabla con animaciones (siguiente paso)
    renderKnownGridWithAnimations(levelUpIds, lostChars);
    // Guardar nuevo estado previo para la prÃ³xima vez
    prevKnownState = currentKnown.map(c => ({ ...c }));
  }
  document.getElementById('btnShowHanzi').onclick   = ()=>{ overlayField='hanzi'; showKnownTableWithAnimations(); };
  document.getElementById('btnShowPinyin').onclick  = ()=>{ overlayField='pinyin'; showKnownTableWithAnimations(); };
  document.getElementById('btnShowMeaning').onclick = ()=>{ overlayField='meaning'; showKnownTableWithAnimations(); };

  document.getElementById('btnKnow').onclick     = () => respond(true);
  document.getElementById('btnDontKnow').onclick = () => respond(false);
  document.getElementById('btnFlip').onclick     = () => {
    if(mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); }
  };
  cardEl.onclick = () => {
    if(currentCard && mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); }
  };


  document.getElementById('btnReset').onclick = async () => {
    if(!confirm('Â¿Reiniciar TODO? Se borrarÃ¡ el progreso y se cargarÃ¡n las Unidades 2â€“9.')) return;
    cards = [];
    nivel2Unlocked = false;
    await saveUserState();
    await loadAll();
    startMission('unit2');
  };

  // BotÃ³n "si se traba" para refrescar la pÃ¡gina
  document.getElementById('btnSiSeTraba').onclick = () => {
    location.reload();
  };

  // --- Nivel 1 desplegable ---
const btnNivel1 = document.getElementById('btnNivel1');
const nivel1Box = document.getElementById('nivel1Box');
if(btnNivel1 && nivel1Box) {
  btnNivel1.onclick = (e) => {
    e.stopPropagation();
    nivel1Box.classList.toggle('hidden');
  };
  document.addEventListener('click', (e) => {
    if (!nivel1Box.classList.contains('hidden')) {
      if (!nivel1Box.contains(e.target) && e.target !== btnNivel1) {
        nivel1Box.classList.add('hidden');
      }
    }
  });
}

// --- Nivel 2 desplegable ---
const nivel2Wrap = document.getElementById('nivel2Wrap');
const btnNivel2 = document.getElementById('btnNivel2');
const nivel2Box = document.getElementById('nivel2Box');
if(nivel2Unlocked) {
  if(nivel2Wrap) nivel2Wrap.style.display = '';
  if(btnNivel2) btnNivel2.style.display = '';
  if(nivel2Box) nivel2Box.style.display = '';
}
if(btnNivel2 && nivel2Box) {
  btnNivel2.onclick = (e) => {
    e.stopPropagation();
    nivel2Box.classList.toggle('hidden');
  };
  document.addEventListener('click', (e) => {
    if (!nivel2Box.classList.contains('hidden')) {
      if (!nivel2Box.contains(e.target) && e.target !== btnNivel2) {
        nivel2Box.classList.add('hidden');
      }
    }
  });
}
['btnUnit2N2','btnUnit3N2','btnUnit4N2','btnUnit5N2','btnUnit6N2','btnUnit7N2','btnUnit8N2','btnUnit9N2','btnUnit10N2'].forEach((id,i) => {
  const btn = document.getElementById(id);
  if(btn) {
    btn.addEventListener('click', () => {
      if(nivel2Box) nivel2Box.classList.add('hidden');
      startMission('unit'+(i+2)+'N2');
    });
  }
});
const btnTodoN2 = document.getElementById('btnTodoN2');
if(btnTodoN2) btnTodoN2.onclick = () => {
  if(nivel2Box) nivel2Box.classList.add('hidden');
  startMission('todoN2');
};

// --- Cerrar box de Nivel 1 al elegir unidad ---
['btnUnit2','btnUnit3','btnUnit4','btnUnit5','btnUnit6','btnUnit7','btnUnit8','btnUnit9'].forEach(id => {
  const btn = document.getElementById(id);
  if(btn) {
    btn.addEventListener('click', () => {
      const nivel1Box = document.getElementById('nivel1Box');
      if(nivel1Box) nivel1Box.classList.add('hidden');
    });
  }
});

// --- Mensaje temporal para modo desafÃ­o ---
function showChallengeWarning() {
  let msg = document.getElementById('challengeWarningMsg');
  if (!msg) {
    msg = document.createElement('div');
    msg.id = 'challengeWarningMsg';
    msg.className = 'fixed top-6 left-1/2 -translate-x-1/2 bg-rose-700 text-white px-6 py-3 rounded-2xl shadow-lg text-base font-semibold z-[9999] opacity-0 transition-opacity duration-500';
    msg.textContent = 'Desafio terminado. No se puede ver la tabla cuando estÃ¡s en modo desafÃ­o';
    document.body.appendChild(msg);
  }
  msg.style.opacity = '1';
  setTimeout(() => { msg.style.opacity = '0'; }, 1800);
}

// --- Desplegable para botÃ³n DesafÃ­o con flecha y animaciÃ³n, alineado al box ---
const btnChallenge = document.getElementById('btnChallenge');
if(btnChallenge) {
  // AÃ±adir flecha al botÃ³n
  btnChallenge.innerHTML = '<span>DesafÃ­o</span> <svg id="challengeArrow" class="inline ml-1 transition-transform duration-300" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>';
  // Crear menÃº desplegable si no existe
  let challengeMenu = document.getElementById('challengeMenu');
  if(!challengeMenu) {
    challengeMenu = document.createElement('div');
    challengeMenu.id = 'challengeMenu';
    challengeMenu.className = 'absolute left-1/2 -translate-x-1/2 mt-2 bg-slate-800 rounded-xl shadow-lg ring-1 ring-white/10 z-50 flex flex-col min-w-[180px] opacity-0 scale-y-95 transition-all duration-300 origin-top';
    challengeMenu.style.display = 'none';
    challengeMenu.innerHTML = `
      <button id="btnDesafioMenos" class="px-4 py-2 text-left hover:bg-slate-700 rounded-t-xl">DesafÃ­o - (nivel 0 y 1)</button>
      <button id="btnDesafioMas" class="px-4 py-2 text-left hover:bg-slate-700">DesafÃ­o + (nivel 2+)</button>
      <button id="btnDesafioNormal" class="px-4 py-2 text-left hover:bg-slate-700 rounded-b-xl">DesafÃ­o clÃ¡sico</button>
    `;
    btnChallenge.parentNode.style.position = 'relative';
    btnChallenge.parentNode.appendChild(challengeMenu);
  }
  btnChallenge.onclick = (e) => {
    e.stopPropagation();
    const arrow = document.getElementById('challengeArrow');
    if(challengeMenu.style.display === 'none') {
      challengeMenu.style.display = '';
      setTimeout(()=>{
        challengeMenu.style.opacity = '1';
        challengeMenu.style.scale = '1';
        challengeMenu.style.transform = 'scaleY(1)';
        if(arrow) arrow.style.transform = 'rotate(180deg)';
      },10);
    } else {
      challengeMenu.style.opacity = '0';
      challengeMenu.style.scale = '0.95';
      challengeMenu.style.transform = 'scaleY(0.95)';
      if(arrow) arrow.style.transform = 'rotate(0deg)';
      setTimeout(()=>{ challengeMenu.style.display = 'none'; },280);
    }
  };
  document.addEventListener('click', (e) => {
    if(challengeMenu.style.display !== 'none' && !challengeMenu.contains(e.target) && e.target !== btnChallenge) {
      challengeMenu.style.opacity = '0';
      challengeMenu.style.scale = '0.95';
      challengeMenu.style.transform = 'scaleY(0.95)';
      const arrow = document.getElementById('challengeArrow');
      if(arrow) arrow.style.transform = 'rotate(0deg)';
      setTimeout(()=>{ challengeMenu.style.display = 'none'; },280);
    }
  });
  // --- LÃ³gica para cada opciÃ³n ---
  document.getElementById('btnDesafioMenos').onclick = () => {
    challengeMenu.style.opacity = '0';
    challengeMenu.style.scale = '0.95';
    challengeMenu.style.transform = 'scaleY(0.95)';
    setTimeout(()=>{ challengeMenu.style.display = 'none'; },280);
    startChallengeCustom('menos');
  };
  document.getElementById('btnDesafioMas').onclick = () => {
    challengeMenu.style.opacity = '0';
    challengeMenu.style.scale = '0.95';
    challengeMenu.style.transform = 'scaleY(0.95)';
    setTimeout(()=>{ challengeMenu.style.display = 'none'; },280);
    startChallengeCustom('mas');
  };
  document.getElementById('btnDesafioNormal').onclick = () => {
    challengeMenu.style.opacity = '0';
    challengeMenu.style.scale = '0.95';
    challengeMenu.style.transform = 'scaleY(0.95)';
    setTimeout(()=>{ challengeMenu.style.display = 'none'; },280);
    startMission('challenge');
  };
}

// --- FunciÃ³n para iniciar desafÃ­os personalizados ---
function startChallengeCustom(tipo) {
  let pool;
  if(tipo === 'menos') {
    pool = shuffle(cards.filter(c => c.known && (c.challengeStreak === 0 || c.challengeStreak === 1)));
  } else if(tipo === 'mas') {
    pool = shuffle(cards.filter(c => c.known && c.challengeStreak >= 2));
  } else {
    pool = shuffle(cards.filter(c => c.known));
  }
  sessionQueue = pool.slice(0,10); // 10 tarjetas por desafÃ­o personalizado
  currentMission = 'challenge';
  todayReviewed = 0;
  sessionTotal = sessionQueue.length;
  sessionCorrect = 0;
  setMode(Math.random() < 0.5 ? 'quizMeaning' : 'quizPinyin');
  bodyEl.classList.add('challenge-bg');
  statBox.classList.add('challenge-stat');
  nextCard();
  updateStats();
}
// ========= Fin de cambios ========= */


  /* ========= Temporizador para racha ========= */
  setInterval(updateStreakBox, 60_000);

  /* ========= Inicio ========= */
  loadAll();
  loadXP();
  renderXPBar();
  // Asignar evento al botÃ³n de reinicio de level
  setTimeout(() => {
    const btn = document.getElementById('btnResetXP');
    if(btn) {
      btn.onclick = () => {
        if(confirm('Â¿Seguro que quieres reiniciar tu Nivel a 0?')) {
          xpPoints = 0;
          saveXP();
          renderXPBar();
        }
      };
    }
  }, 0);
  startMission('unit2');
  </script>
</body>
</html>
