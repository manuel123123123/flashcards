<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tarjetas de chino · Unidades</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a" />
  <style>
    .flip { transform: rotateY(180deg); }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotateY180 { transform: rotateY(180deg); }
    .perspective { perspective: 1000px; }
    .hidden { display: none; }

    /* ---------- Flip Animation ---------- */
    .card-flip-vert {
      transition: transform 0.44s cubic-bezier(0.4, 0, 0.2, 1);
      transform-style: preserve-3d;
    }
    .card-flip-vert.flipping {
      transform: rotateX(90deg);
    }
    .card-flip-vert.flipped {
      transform: rotateX(0deg);
    }
    .cardWrong {
      background: linear-gradient(135deg, #1e1b4b 0%, #7f1d1d 100%) !important;
    }
    @keyframes cardWrongFade {
      0% { background: linear-gradient(135deg, #1e1b4b 0%, #7f1d1d 100%); }
      100% { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
    }
    .cardWrongFade {
      animation: cardWrongFade 0.6s ease-out forwards;
    }
    @keyframes optCorrectFade {
      0% { background-color: #059669; transform: scale(1.05); }
      100% { background-color: #6366f1; transform: scale(1); }
    }
    .optCorrectFade {
      animation: optCorrectFade 0.4s ease-out forwards;
    }
    @keyframes optWrongFade {
      0% { background-color: #dc2626; transform: scale(0.95); }
      100% { background-color: #1e293b; transform: scale(1); }
    }
    .optWrongFade {
      animation: optWrongFade 0.4s ease-out forwards;
    }
    
    /* Animaciones de feedback */
    @keyframes pop {
      0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
      30%  { transform: scale(1.09);box-shadow: 0 0 45px rgba(16,185,129,.55); }
      100% { transform: scale(1);   box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%     { transform: translateX(-8px); }
      40%     { transform: translateX(8px); }
      60%     { transform: translateX(-6px); }
      80%     { transform: translateX(6px); }
    }
    .popAnim   { animation: pop   420ms ease-out; }
    .shakeAnim { animation: shake 420ms ease; }
    
    .optCorrect {
      background-color: #059669 !important;
      color: #fff !important;
      box-shadow: 0 0 26px rgba(16,185,129,.75) !important;
      transform: scale(1.02);
    }
    .optWrong {
      background-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 0 20px rgba(220,38,38,.7) !important;
    }

    /* Counter Button Glow Animation */
    @keyframes buttonGlowPop {
      0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
      50% { transform: scale(1.05); box-shadow: 0 0 20px currentColor; }
      100% { transform: scale(1); box-shadow: 0 0 0 rgba(0,0,0,0); }
    }
    .button-glow-animation {
      animation: buttonGlowPop 0.5s ease-out;
    }
  </style>
</head>
<body class="min-h-screen bg-white text-slate-900">
  <div class="max-w-3xl mx-auto p-4 sm:p-6">

    <!-- Encabezado -->
    <header class="flex flex-col gap-3 items-center">
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-center">Las Mejores Flashcards</h1>
      <div class="w-full max-w-2xl flex gap-2">
        <button id="btnKnown" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-emerald-500 hover:bg-emerald-400 text-white">Conocidas <span id="countKnown" class="opacity-80">0</span></button>
        <button id="btnRevise1" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-orange-500 hover:bg-orange-400 text-white">A repasar <span id="countRev1" class="opacity-80">0</span></button>
        <button id="btnRevise2" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-orange-500 hover:bg-orange-400 text-white">Para confirmar <span id="countRev2" class="opacity-80">0</span></button>
      </div>
      <div class="w-full max-w-2xl flex gap-2">
        <button id="btnUnit1" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-indigo-500 hover:bg-indigo-400 text-white">Unidad 1</button>
        <button id="btnUnit2" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-indigo-500 hover:bg-indigo-400 text-white">Unidad 2</button>
        <button id="btnUnit3" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-indigo-500 hover:bg-indigo-400 text-white">Unidad 3</button>
      </div>
      <div class="w-full max-w-2xl flex gap-2">
        <button id="btnQuizPinyin" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-purple-500 hover:bg-purple-400 text-white">Quiz Pinyin</button>
        <button id="btnQuizMeaning" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-purple-500 hover:bg-purple-400 text-white">Quiz Significado</button>
        <button id="btnQuizHanzi" class="flex-1 px-4 py-2 rounded-2xl font-bold bg-purple-500 hover:bg-purple-400 text-white">Quiz Hanzi</button>
      </div>
    </header>

    <!-- Estado -->
    <section class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
      <div class="bg-slate-100 rounded-xl p-3">
        <div class="text-slate-600">En sesión</div>
        <div id="statInSession" class="text-xl font-semibold text-slate-900">0</div>
      </div>
      <div class="bg-slate-100 rounded-xl p-3">
        <div class="text-slate-600">Revisadas hoy</div>
        <div id="statToday" class="text-xl font-semibold text-slate-900">0</div>
      </div>
      <div class="bg-slate-100 rounded-xl p-3">
        <div class="text-slate-600">Actual</div>
        <div id="statMission" class="text-xl font-semibold text-slate-900">—</div>
      </div>
    </section>

    <!-- Tarjeta -->
    <main class="mt-6">
      <div id="cardWrap" class="relative h-72 sm:h-80 select-none perspective">
        <div id="card" class="absolute inset-0 rounded-3xl bg-slate-50 ring-1 ring-slate-200 shadow-xl flex items-center justify-center text-center preserve-3d transition-transform duration-300 will-change-transform">
          <div id="cardFront" class="absolute inset-0 flex items-center justify-center backface-hidden text-5xl font-bold text-slate-900"></div>
          <div id="cardBack" class="absolute inset-0 flex flex-col items-center justify-center rotateY180 backface-hidden text-2xl leading-relaxed whitespace-pre-line text-slate-900"></div>
        </div>
      </div>

      <!-- Controles modo FLASH -->
      <div id="flashRow" class="mt-4 grid grid-cols-3 gap-2">
        <button id="btnDontKnow" class="col-span-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-900 text-sm sm:text-base">← No la sé</button>
        <button id="btnFlip" class="col-span-1 py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-900 text-sm sm:text-base">Voltear (Espacio)</button>
        <button id="btnKnow" class="col-span-1 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white text-sm sm:text-base">La sabía →</button>
      </div>

      <!-- Controles modo QUIZ -->
      <div id="quizRow" class="mt-4 grid grid-cols-2 gap-2 hidden">
        <!-- se crean 4 botones dinámicamente -->
      </div>

      <p class="mt-3 text-slate-600 text-xs sm:text-sm">Consejos: clic/tap para voltear la tarjeta. Teclado: Izquierda = No la sé, Espacio = Voltear, Derecha = La sabía. En móvil: desliza a izquierda/derecha.</p>
    </main>
  </div>

  <script>
  // Forzamos dataset en español
  const STORAGE_KEY = 'srs_unidades_v1_es';

  let cards = [];
  let sessionQueue = [];
  let currentCard = null;
  let flipped = false;
  let todayReviewed = 0;
  let currentMission = ''; // 'unit1' | 'unit2' | 'unit3' | 'known' | 'revise1' | 'revise2'
  let sessionTotal = 0;
  let sessionCorrect = 0;

  // modo: 'flash' | 'quizPinyin' | 'quizMeaning'
  let mode = 'flash';

  // Elementos
  const cardEl = document.getElementById('card');
  const frontEl = document.getElementById('cardFront');
  const backEl = document.getElementById('cardBack');
  const statInSession = document.getElementById('statInSession');
  const statToday = document.getElementById('statToday');
  const statMission = document.getElementById('statMission');

  const flashRow = document.getElementById('flashRow');
  const quizRow = document.getElementById('quizRow');

  // Utils
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cards)); }

  // Datos en español
  function unit1Sample(){
    return [
      ['爱','ài','amor','unit1'], ['学','xué','aprender','unit1'], ['你好','nǐ hǎo','hola','unit1'],
      ['书','shū','libro','unit1'], ['朋友','péngyou','amigo','unit1'], ['学校','xuéxiào','escuela','unit1'],
      ['老师','lǎoshī','profesor','unit1'], ['学生','xuéshēng','estudiante','unit1'], ['家','jiā','hogar','unit1'],
      ['饭','fàn','comida','unit1'],
    ];
  }
  function unit2Sample(){
    return [
      ['水','shuǐ','agua','unit2'], ['茶','chá','té','unit2'], ['谢谢','xièxie','gracias','unit2'], ['再见','zàijiàn','adiós','unit2'],
      ['中国','Zhōngguó','China','unit2'], ['北京','Běijīng','Pekín','unit2'], ['上海','Shànghǎi','Shanghái','unit2'],
      ['今天','jīntiān','hoy','unit2'], ['明天','míngtiān','mañana','unit2'], ['昨天','zuótiān','ayer','unit2'],
    ];
  }
  function unit3Sample(){
    return [
      ['电脑','diànnǎo','computadora','unit3'], ['手机','shǒujī','teléfono móvil','unit3'], ['桌子','zhuōzi','mesa','unit3'],
      ['椅子','yǐzi','silla','unit3'], ['猫','māo','gato','unit3'], ['狗','gǒu','perro','unit3'], ['苹果','píngguǒ','manzana','unit3'],
      ['香蕉','xiāngjiāo','banana','unit3'], ['火车','huǒchē','tren','unit3'], ['飞机','fēijī','avión','unit3'],
      ['天气','tiānqì','clima','unit3'], ['太阳','tàiyáng','sol','unit3'], ['月亮','yuèliang','luna','unit3'],
      ['星星','xīngxing','estrella','unit3'], ['音乐','yīnyuè','música','unit3'],
    ];
  }
  function buildObjects(rows){
    return rows.map(([hanzi,pinyin,meaning,unit])=>({
      id: uid(), hanzi, pinyin, meaning, unit,
      dkAddedAt: 0, revise1: false, revise2: false, known: false
    }));
  }

  function loadAll(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      cards = JSON.parse(raw);
      // Migraciones por si faltan campos o unidad 3
      let changed = false;
      for(const c of cards){ if(typeof c.known==='undefined'){ c.known=false; changed=true; } }
      const hasUnit3 = cards.some(c=>c.unit==='unit3');
      if(!hasUnit3){ cards = cards.concat(buildObjects(unit3Sample())); changed=true; }
      if(changed) saveAll();
    } else {
      cards = buildObjects([ ...unit1Sample(), ...unit2Sample(), ...unit3Sample() ]);
      saveAll();
    }
  }

  function buildQueue(type){
    if(type==='unit1') return cards.filter(c=>c.unit==='unit1');
    if(type==='unit2') return cards.filter(c=>c.unit==='unit2');
    if(type==='unit3') return cards.filter(c=>c.unit==='unit3');
    if(type==='known') return cards.filter(c=>c.known);
    if(type==='revise1') return cards.filter(c=>c.revise1);
    if(type==='revise2') return cards.filter(c=>c.revise2);
    return [];
  }

  function startMission(type){
    currentMission = type;
    sessionQueue = buildQueue(type).slice();
    todayReviewed = 0;
    sessionTotal = sessionQueue.length;
    sessionCorrect = 0;
    // Al comenzar una misión, volvemos a modo flash por defecto
    setMode('flash');
    nextCard();
    updateStats();
  }

  function ensureReviseFlags(card){
    if(!card.dkAddedAt){ card.dkAddedAt = now(); }
    card.revise1 = true; card.revise2 = true; card.known = false;
  }

  function answer(knew){
    if(!currentCard) return;
    const c = currentCard;

    if(currentMission.startsWith('unit') || currentMission==='known'){
      if(knew){ c.known = true; }
      else    { ensureReviseFlags(c); }
    } else if(currentMission==='revise1'){
      if(knew){ c.revise1 = false; c.known = true; }
      else    { ensureReviseFlags(c); }
    } else if(currentMission==='revise2'){
      if(knew){ c.revise2 = false; c.known = true; }
      else    { ensureReviseFlags(c); c.revise1 = true; }
    }

    if(knew) sessionCorrect++;
    todayReviewed++;
    saveAll();
    nextCard();
  }

  function nextCard(){
    flipped=false; cardEl.classList.remove('flip');
    
    // Flip animation with delay
    const cardWrap = document.getElementById('cardWrap');
    cardWrap.classList.add('card-flip-vert');
    setTimeout(() => {
      cardWrap.classList.add('flipping');
      setTimeout(() => {
        // Change content at midpoint
        currentCard = sessionQueue.shift()||null;
        renderCard();
        updateStats();
        cardWrap.classList.remove('flipping');
        cardWrap.classList.add('flipped');
        setTimeout(() => {
          cardWrap.classList.remove('flipped', 'card-flip-vert');
        }, 440);
      }, 220);
    }, 500);
  }

  function renderCard(){
    if(!currentCard){
      const n = sessionTotal, x = sessionCorrect;
      backEl.textContent='';
      frontEl.innerHTML = `<div class="text-3xl font-semibold">${x} / ${n} aciertos</div>`;
      return;
    }

    // Siempre mostramos el hanzi en el frente
    frontEl.textContent = currentCard.hanzi;

    if(mode === 'flash'){
      backEl.innerHTML = `<div class="mb-2">${currentCard.pinyin}</div><div>${currentCard.meaning}</div>`;
      flashRow.classList.remove('hidden');
      quizRow.classList.add('hidden');
    } else {
      // QUIZ: mostramos 4 opciones
      backEl.textContent = ''; // no mostramos pinyin/meaning en el dorso en modo quiz
      flashRow.classList.add('hidden');
      quizRow.classList.remove('hidden');
      setupQuizChoices();
    }
  }

  // --- QUIZ ---
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function setupQuizChoices(){
    // Creamos/aseguramos 4 botones dentro de quizRow
    if(quizRow.children.length !== 4){
      quizRow.innerHTML = '';
      for(let i=0;i<4;i++){
        const btn = document.createElement('button');
        btn.className = 'quizOpt py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 text-sm sm:text-base';
        btn.style.fontSize = '24px';
        quizRow.appendChild(btn);
      }
    }
    const quizBtns = Array.from(quizRow.children);

    const pool = buildQueue(currentMission);
    // Si la misión está vacía (p.ej. Conocidas sin tarjetas), usar todas las tarjetas como respaldo
    const source = pool.length ? pool : cards;

    let field, showField;
    if(mode === 'quizPinyin'){
      field = 'pinyin';
      showField = 'hanzi';
    } else if(mode === 'quizMeaning'){
      field = 'meaning';
      showField = 'hanzi';
    } else if(mode === 'quizHanzi'){
      field = 'hanzi';
      // Mostrar pinyin o significado aleatorio
      showField = Math.random() < 0.5 ? 'pinyin' : 'meaning';
      frontEl.innerHTML = `<div class='text-5xl font-bold flex items-center justify-center h-full'>${currentCard[showField]}</div>`;
    }

    const correct = currentCard[field];

    // Armamos distractores únicos
    const values = new Set([correct]);
    const distractors = [];
    const candidates = shuffle(source.filter(c => c.id !== currentCard.id));
    for(const c of candidates){
      const v = c[field];
      if(!values.has(v)){ values.add(v); distractors.push(v); }
      if(distractors.length===3) break;
    }
    while(distractors.length<3){ distractors.push('—'); } // relleno si faltan

    // Mezclamos opciones
    const options = shuffle([correct, ...distractors]);

    quizBtns.forEach((btn, idx) => {
      btn.textContent = options[idx];
      btn.className = 'quizOpt py-3 rounded-2xl bg-slate-200 hover:bg-slate-300 text-slate-900 text-sm sm:text-base';
      btn.onclick = () => {
        const isCorrect = options[idx] === correct;
        // Disable all buttons
        quizBtns.forEach(b => b.disabled = true);
        
        if(isCorrect){
          btn.classList.add('optCorrect');
          cardEl.classList.add('popAnim');
          setTimeout(()=> {
            btn.classList.remove('optCorrect');
            cardEl.classList.remove('popAnim');
            quizBtns.forEach(b => b.disabled = false);
            answer(true);
          }, 1000);
        } else {
          btn.classList.add('optWrong');
          // Show correct answer
          quizBtns.forEach((b, i) => {
            if(options[i] === correct) {
              b.classList.add('optCorrect');
            }
          });
          cardEl.classList.add('shakeAnim');
          setTimeout(()=> {
            btn.classList.remove('optWrong');
            quizBtns.forEach(b => b.classList.remove('optCorrect'));
            cardEl.classList.remove('shakeAnim');
            quizBtns.forEach(b => b.disabled = false);
            answer(false);
          }, 1500);
        }
      };
    });
  }

  function handleQuizChoice(isCorrect){
    answer(!!isCorrect);
  }

  // --- Modo / UI ---
  function setMode(newMode){
    mode = newMode;
    // En modo flash permitimos voltear; en quiz no
    if(mode==='flash'){
      // nada extra
    } else {
      // aseguramos tarjeta sin voltear
      flipped=false; cardEl.classList.remove('flip');
    }
    if(currentCard) renderCard();
    updateStats();
  }

  function updateStats(){
    statInSession.textContent = sessionQueue.length + (currentCard ? 1 : 0);
    statToday.textContent = todayReviewed;
    statMission.textContent = (
      currentMission==='unit1' ? 'Unidad 1' :
      currentMission==='unit2' ? 'Unidad 2' :
      currentMission==='unit3' ? 'Unidad 3' :
      currentMission==='known' ? 'Conocidas' :
      currentMission==='revise1' ? 'A repasar' :
      currentMission==='revise2' ? 'Para confirmar' : '—'
    );
    // contadores
    const countKnown = cards.filter(c=>c.known).length;
    const countRev1  = cards.filter(c=>c.revise1).length;
    const countRev2  = cards.filter(c=>c.revise2).length;
    const elKnown = document.getElementById('countKnown');
    if(elKnown) elKnown.textContent = countKnown;
    const elR1 = document.getElementById('countRev1');
    if(elR1) elR1.textContent = countRev1;
    const elR2 = document.getElementById('countRev2');
    if(elR2) elR2.textContent = countRev2;

    // Detectar incrementos y animar botones
    if(typeof updateStats.prevCountKnown !== 'undefined' && countKnown > updateStats.prevCountKnown) {
      triggerButtonGlow('btnKnown');
    }
    if(typeof updateStats.prevCountRev1 !== 'undefined' && countRev1 > updateStats.prevCountRev1) {
      triggerButtonGlow('btnRevise1');
    }
    if(typeof updateStats.prevCountRev2 !== 'undefined' && countRev2 > updateStats.prevCountRev2) {
      triggerButtonGlow('btnRevise2');
    }
    // Guardar valores actuales
    updateStats.prevCountKnown = countKnown;
    updateStats.prevCountRev1 = countRev1;
    updateStats.prevCountRev2 = countRev2;
  }

  function triggerButtonGlow(buttonId) {
    const btn = document.getElementById(buttonId);
    if(!btn) return;
    btn.classList.remove('button-glow-animation');
    void btn.offsetWidth; // Force reflow
    btn.classList.add('button-glow-animation');
    setTimeout(() => btn.classList.remove('button-glow-animation'), 600);
  }

  // Controles
  document.getElementById('btnUnit1').onclick = () => startMission('unit1');
  document.getElementById('btnUnit2').onclick = () => startMission('unit2');
  document.getElementById('btnUnit3').onclick = () => startMission('unit3');
  document.getElementById('btnKnown').onclick = () => startMission('known');
  document.getElementById('btnRevise1').onclick = () => startMission('revise1');
  document.getElementById('btnRevise2').onclick = () => startMission('revise2');

  document.getElementById('btnQuizPinyin').onclick = () => setMode('quizPinyin');
  document.getElementById('btnQuizMeaning').onclick = () => setMode('quizMeaning');
  document.getElementById('btnQuizHanzi').onclick = () => setMode('quizHanzi');

  document.getElementById('btnKnow').onclick = () => answer(true);
  document.getElementById('btnDontKnow').onclick = () => answer(false);
  document.getElementById('btnFlip').onclick = () => { if(mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); } };
  cardEl.onclick = () => { if(currentCard && mode==='flash'){ flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); } };
  window.onkeydown = (e) => {
    if(mode==='flash'){
      if(e.code==='ArrowLeft'){ e.preventDefault(); answer(false); }
      else if(e.code==='ArrowRight'){ e.preventDefault(); answer(true); }
      else if(e.code==='Space'){ e.preventDefault(); flipped=!flipped; flipped?cardEl.classList.add('flip'):cardEl.classList.remove('flip'); }
    }
  };

  // Inicio
  loadAll();
  // empieza en Unidad 1 por comodidad
  startMission('unit1');
  </script>
</body>
</html>
